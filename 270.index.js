(self.webpackChunkrock_raiders_web=self.webpackChunkrock_raiders_web||[]).push([[270],{270:(t,e,n)=>{"use strict";function r(){return new Worker(n.p+"index.worker.js")}n.r(e),n.d(e,{ADDITIONAL_RAIDER_PER_SUPPORT:()=>gn,CHECK_SPANW_RAIDER_TIMER:()=>pn,HEIGHT_MULTIPLER:()=>vn,JOB_ACTION_RANGE:()=>hn,JOB_SCHEDULE_INTERVAL:()=>un,MAX_RAIDER_BASE:()=>dn,NATIVE_FRAMERATE:()=>In,PANEL_ANIMATION_MULTIPLIER:()=>yn,RAIDER_SPEED:()=>fn,SPRITE_RESOLUTION_HEIGHT:()=>wn,SPRITE_RESOLUTION_WIDTH:()=>mn,TILESIZE:()=>bn});var i=n(212),o=function(t,e){this.wad0FileUrl=t,this.wad1FileUrl=e};function s(t,e){if(t<1||e<1)return console.error("Can't create context with size "+t+" x "+e),function(t,e){const n=s(64,64);for(let t=0;t<64;t+=16)for(let e=0;e<64;e+=16)n.fillStyle=e/16%2==t/16%2?"rgb(0,255,255)":"rgb(255,0,255)",n.fillRect(e,t,16,16);return n}();const n=document.createElement("canvas");n.setAttribute("width",t),n.setAttribute("height",e);const r=n.getContext("2d");return r.width=t,r.height=e,r}function a(t,e){const n=new ImageData(t,e);for(let r=0;r<e;r+=16)for(let e=0;e<t;e+=16){const t=e/16%2==r/16%2;for(let i=e;i<e+16;i++)for(let e=r;e<r+16;e++)l(n,i,e,t?0:255,t?255:0,255)}return n}function l(t,e,n,r,i,o,s=255){const a=4*(n*t.width+e);t.data[a]=r,t.data[a+1]=i,t.data[a+2]=o,t.data[a+3]=s}function c(t,e,n){const r=4*(n*t.width+e);return{r:t.data[r],g:t.data[r+1],b:t.data[r+2],a:t.data[r+3]}}function u(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return e.forEach((function(e){t=(t=Object.keys(t).filter((function(t){return t.toLowerCase()===e.toLowerCase()})).map((function(e){return t[e]})))?t[0]:t})),t}function h(t){if(!t)return t;var e=t.toString().replace(/\\/g,"/");e.startsWith("/")&&(e=e.substring(1));var n=e.lastIndexOf("/");return e.substring(n+1)}function p(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return e.forEach((function(e){t=(t=Object.keys(t).filter((function(t){return t.toLowerCase()===e.toLowerCase()})).map((function(e){return t[e]})))?t[0]:t})),t}function f(t){return(new TextDecoder).decode(t).replace(/\0/g,"")}function d(t){return f(t).replace(/\\/g,"/")}function g(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}function y(t){return g(0,t)}function v(){return 2*g(0,1)-1}var m=function(){this.carryNullName="",this.mediumPoly={},this.highPoly={},this.fPPoly={},this.activities={}},w=1448366670;function b(t,e){var n=new i.Pa4;return n.x=t.getFloat32(e),n.y=t.getFloat32(e+4),n.z=t.getFloat32(e+8),n}var I,E,T=function(){function t(t,e){void 0===e&&(e=!1),this.path="",this.verbose=!1,this.materials=[],this.geometry=new i.u9r,this.vertices=null,this.indices=null,this.uvs=null,this.verbose=e,this.path=t,this.verbose&&console.log("LWO path: "+this.path)}return t.prototype.parsePoints=function(t,e,n){if(n%12==0){var r=n/4/3;this.vertices=new Float32Array(3*r),this.uvs=new Float32Array(2*r);for(var i=0;i<r;i++){var o=3*i,s=4*o;this.vertices[o]=t.getFloat32(e+s),this.vertices[o+1]=t.getFloat32(e+s+4),this.vertices[o+2]=t.getFloat32(e+s+8)}}else console.error("LWOLoader.parse: F12 does not evenly divide into chunk size ("+n+"). Possible corruption.")},t.prototype.parseSurfaceNames=function(t,e,n){for(var r=(new TextDecoder).decode(new Uint8Array(t,e,n)).split("\0").filter((function(t){return""!==t})),o=0;o<r.length;o++){var s=new i.xoR;s.name=r[o],this.materials.push(s)}this.verbose&&console.log("LWO contains "+this.materials.length+" materials with following names: "+r)},t.prototype.parsePolygons=function(t,e,n){for(var r=0,i=0;i<n;){var o=t.getInt16(e+i),s=t.getInt16(e+i+2+2*o);this.geometry.addGroup(r,3*(o-2),s-1),r+=3*(o-2),i+=4+2*o}i=0;var a=0;for(this.indices=new Uint16Array(r);i<n;){o=t.getInt16(e+i),i+=2;for(var l=new Int16Array(o),c=0;c<=o;c++)l[c]=t.getInt16(e+i+2*c);for(c=0;c<o-2;c++)this.COUNTER_CLOCKWISE?(this.indices[a++]=l[0],this.indices[a++]=l[c+2],this.indices[a++]=l[c+1]):(this.indices[a++]=l[0],this.indices[a++]=l[c+1],this.indices[a++]=l[c+2]);i+=2+2*o}},t.prototype.parseSurface=function(t,e,n,r){for(var o=0;0!==t.getUint8(n+o);)o++;var s=f(new Uint8Array(e,n,o));this.verbose&&console.log("Parsing surface: "+s);for(var a=-1,l=null,c=0,u=new i.Pa4(0,0,0),p=new i.Pa4(0,0,0),g=0;g<this.materials.length;g++)this.materials[g].name===s&&(a=g,l=this.materials[g]);if(l){for(var y=function(){var r=n+o;if(0===t.getUint8(r))o++;else{var s=t.getInt32(r),a=t.getInt16(r+4);switch(v.verbose&&console.log("Parsing subchunk "+(new TextDecoder).decode(new Uint8Array(e,r,4))+" at "+r+"; length "+a),s){case 1129270354:var f=[t.getUint8(r+6+0)/255,t.getUint8(r+6+1)/255,t.getUint8(r+6+2)/255,t.getUint8(r+6+3)/255];l.color=(new i.Ilk).fromArray(f),v.verbose&&console.log("Material color (COLR): "+f.join(" "));break;case 1179402567:var g=t.getUint16(r+6);v.verbose&&console.log("Flags (FLAG): "+g.toString(2));break;case 1280658761:var y=t.getInt16(r+6)/255;v.verbose&&console.log("Luminosity (LUMI): "+y);break;case 1145652806:var m=t.getInt16(r+6)/255;v.verbose&&console.log("Diffuse (DIFF): "+m);break;case 1397769539:var I=t.getInt16(r+6)/255;v.verbose&&console.log("Specular (SPEC): "+I);break;case 1380271692:var E=0;E=1447449164===E?t.getFloat32(r+6):t.getInt16(r+6)/255,l.reflectivity=E,v.verbose&&console.log("Reflectivity (REFL): "+l.reflectivity);break;case 1414676814:case w:var T;T=s===w?t.getFloat32(r+6):t.getInt16(r+6)/255,l.opacity=1-T,v.verbose&&console.log("Opacity (TRAN/VTRN): "+l.opacity),T>0&&(l.transparent=!0);break;case 1447843149:var P=t.getFloat32(r+6);v.verbose&&console.log("Luminosity (VLUM): "+P);break;case 1447315782:var R=t.getFloat32(r+6);v.verbose&&console.log("Diffuse (VDIF): "+R);break;case 1448300611:var O=t.getFloat32(r+6);v.verbose&&console.log("Specular (VSPC): "+O);break;case 1413893191:c=t.getUint16(r+6),v.verbose&&console.log("Flags (TFLG): "+c.toString(2));break;case 1414744410:u=b(t,r+6),v.verbose&&console.log("Texture size (TSIZ): "+u.toArray().join(" "));break;case 1413698642:p=b(t,r+6),v.verbose&&console.log("Texture center (TCTR): "+p.toArray().join(" "));break;case 1129596248:case 1146373464:case 1398031704:case 1381254488:case 1414808920:case 1112819032:var S=d(new Uint8Array(e,r+6,a));v.verbose&&console.log("Texture typename: "+S);break;case 1413696594:var _=[t.getUint8(r+6+0)/255,t.getUint8(r+6+1)/255,t.getUint8(r+6+2)/255,t.getUint8(r+6+3)/255];v.verbose&&console.log("Texture color (TCLR): "+_.join(" "));break;case 1414090055:var x=d(new Uint8Array(e,r+6,a));if(v.verbose&&console.log("Texture filepath (TIMG): "+x),"(none)"===x)break;var C=!1;x.endsWith(" (sequence)")&&(C=!0,x=x.substring(0,x.length-" (sequence)".length));var M=h(x),A=v.path+M;if(C){var N=A.match(/(\D+)0+(\d+)\..+/),B=N[1],k=Number(N[2]),D=L.filterEntryNames(B);D.length<1&&(D=L.filterEntryNames("world/shared/"+h(B)));var j=D.length-1,F=k;setInterval((function(){l.map=L.getTexture(D[F-k]),++F>j&&(F=k)}),200),l.transparent=!0}l.map=L.getTexture(A),l.alphaTest=l.transparent?0:.5,l.color=null;break;default:v.verbose&&console.warn("Found unrecognised SURF subchunk type "+(new TextDecoder).decode(new Uint8Array(e,r,4))+" at "+r+"; length "+a)}o+=6+a}},v=this;o<r;)y();!function(t,e,n,r,i,o,s,a){if(7&a)for(var l=0,c=t.groups;l<c.length;l++){var u=c[l];if(u.materialIndex===i)for(var h=u.start;h<u.start+u.count;h++){var p=3*r[h],f=e[p]-s.x,d=e[p+1]-s.y,g=e[p+2]-s.z,y=2*r[h],v=0,m=0;1&a?(v=g/o.z+.5,m=d/o.y+.5):2&a?(v=f/o.x+.5,m=g/o.z+.5):4&a&&(v=f/o.x+.5,m=d/o.y+.5),n[y]=v,n[y+1]=m}}}(this.geometry,this.vertices,this.uvs,this.indices,a,u,p,c)}else console.error("LWOLoader.parse: Surface in SURF chunk does not exist in SRFS")},t.prototype.parse=function(t){var e=new DataView(t);if(1179603533===e.getUint32(0)){var n=e.getUint32(4);if(n+8!==e.byteLength&&console.warn("LWOLoader.parse: Discrepancy between size in header ("+(n+8)+" bytes) and actual size ("+e.byteLength+" bytes)."),1280790338===e.getUint32(8)){for(var r=12;r<e.byteLength;)if(0===e.getUint8(r))r++;else{var o=e.getInt32(r),s=e.getInt32(r+4);switch(r+=8,o){case 1347310675:this.parsePoints(e,r,s);break;case 1397900883:this.parseSurfaceNames(t,r,s);break;case 1347374163:this.parsePolygons(e,r,s);break;case 1398100550:this.parseSurface(e,t,r,s);break;default:console.warn("Found unrecognised chunk type "+f(new Uint8Array(t,r-8,4))+" at "+r)}r+=s}return this.geometry.setAttribute("position",new i.TlE(this.vertices,3)),this.geometry.setAttribute("uv",new i.TlE(this.uvs,2)),this.geometry.setIndex(new i.TlE(this.indices,1)),this.geometry.computeVertexNormals(),new i.Kj0(this.geometry,this.materials)}var a=f(new Uint8Array(t,8,4));console.error("LWOLoader.parse: Invalid magic ID ("+a+") in LWO header.")}else console.error("LWOLoader.parse: Cannot find header.")},t}(),P=function(){this.looping=!1,this.transcoef=1,this.firstFrame=null,this.lastFrame=null,this.framesPerSecond=null,this.bodies=[]},R=i.M8C.degToRad,O=function(){function t(){this.name="",this.filename="",this.relPos=[],this.relRot=[],this.relScale=[],this.opacity=[],this.parentObjInd=null,this.model=null}return t.prototype.radVec=function(t,e,n){return new i.USm(R(e),R(t),R(n),"YXZ")},t.prototype.setFrameAndFollowing=function(t,e,n){this.relPos[t]=new i.Pa4(n[0],n[1],n[2]),this.relRot[t]=this.radVec(n[3],n[4],n[5]),this.relScale[t]=new i.Pa4(n[6],n[7],n[8]);for(var r=t;r<=e;r++)this.relPos[r]=this.relPos[t],this.relRot[r]=this.relRot[t],this.relScale[r]=this.relScale[t]},t.prototype.setOpacityAndFollowing=function(t,e,n){for(var r=t;r<=e;r++)this.opacity[r]=n},t}(),S=function(){function t(t,e){void 0===e&&(e=!1),this.path="",this.verbose=!1,this.animationClip=new P,this.lines=[],this.lineIndex=0,this.path=t,this.verbose=e,this.verbose&&console.log("Using verbose mode")}return t.prototype.parse=function(t){if(this.lines=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((function(t){return t.trim()})),"LWSC"!==this.lines[0])throw"Invalid start of file! Expected 'LWSC' in first line";var e=parseInt(this.lines[1],10);for(1!==e&&console.warn("Number of models has unexpected value: "+e),this.lineIndex=2;this.lineIndex<this.lines.length;this.lineIndex++){var n=this.lines[this.lineIndex];if(n){var r=n.split(" ")[0];"FirstFrame"===r?this.parseFrameBlock():"AddNullObject"===r||"LoadObject"===r?(this.parseObjectBlock(),this.verbose&&console.log(this.animationClip.bodies[this.animationClip.bodies.length-1])):n.startsWith("PreviewFirstFrame ")||n.startsWith("PreviewLastFrame ")||n.startsWith("PreviewFrameStep ")}}return this.verbose&&console.log(this.animationClip),this.animationClip},t.prototype.parseLine=function(t){return t.split(" ").filter((function(t){return""!==t}))},t.prototype.parseFrameBlock=function(){for(;this.lineIndex<this.lines.length;this.lineIndex++){var t=this.lines[this.lineIndex];if(!t)return;var e=this.parseLine(t),n=e[0],r=e[1];if("FirstFrame"===n)this.animationClip.firstFrame=parseInt(r);else if("LastFrame"===n)this.animationClip.lastFrame=parseInt(r);else if("FrameStep"===n){var i=parseInt(r);1!==i&&console.error("Animation frameStep has unexpected value: "+i)}else"FramesPerSecond"===n?this.animationClip.framesPerSecond=parseInt(r):"PreviewFirstFrame"===n||"PreviewLastFrame"===n||"PreviewFrameStep"===n||console.warn("Unexpected key in frame block")}console.error("Parsing block reached content end")},t.prototype.parseObjectBlock=function(){var t=new O;for(this.animationClip.bodies.push(t);this.lineIndex<this.lines.length;this.lineIndex++){var e=this.lines[this.lineIndex];if(!e)return;var n=this.parseLine(e),r=n[0],o=n[1];if("AddNullObject"===r||"LoadObject"===r)if("LoadObject"===r){var s=h(o);t.name=s.slice(0,s.length-".lwo".length),t.filename=this.path+s;var a=L.getResource(t.filename);t.model=new T(this.path).parse(a)}else{if("AddNullObject"!==r)throw"Unexpected line: "+e;t.name=o,t.model=new i.ZAu}else if("ObjectMotion"===r){var l=this.lines[++this.lineIndex],c=parseInt(l);l=this.lines[++this.lineIndex];var u=parseInt(l);this.lineIndex++;for(var p=0;p<u;p++){var f=this.lines[this.lineIndex+2*p];if(f.startsWith("EndBehavior"))break;var d=f.split(" ").map(Number);d.length!==c&&console.warn("Number of infos ("+d.length+") does not match if specified count ("+c+")"),f=this.lines[this.lineIndex+2*p+1];var g=parseInt(f.split(" ")[0]);t.setFrameAndFollowing(g,this.animationClip.lastFrame,d)}this.lineIndex+=2*u}else if("ParentObject"===r)t.parentObjInd=Number(o)-1,this.verbose&&console.log("parent obj ind is: "+t.parentObjInd);else if("ShowObject "===r||"LockedChannels"===r);else if("ShadowOptions"===r);else if("ObjDissolve"===r)if("(envelope)"==o){var y=this.lines[++this.lineIndex],v=parseInt(y);1!==v&&console.error("Number of information channels for opacity is not 1, but: "+v),y=this.lines[++this.lineIndex];var m=parseInt(y);for(this.lineIndex++,p=0;p<m;p++){var w=this.lines[this.lineIndex+2*p];if(w.startsWith("EndBehavior"))break;var b=1-Number(w);w=this.lines[this.lineIndex+2*p+1];var I=Number(w.split(" ")[0]);t.setOpacityAndFollowing(I,this.animationClip.lastFrame,b)}this.lineIndex+=2*m}else b=1-Number(o),t.setOpacityAndFollowing(0,this.animationClip.lastFrame,b)}return console.error("Parsing block reached content end"),t},t}(),_=function(){function t(){}return t.loadModels=function(t,e){var n=function(t){if(!t)return t;var e=t.toString().replace(/\\/g,"/");e.startsWith("/")&&(e=e.substring(1));var n=e.lastIndexOf("/");return(e=e.substring(0,n+1)).startsWith("/")&&(e=e.substring(1)),e}(t),r=new m;r.carryNullName=u(e,"CarryNullName");var i=u(e,"highpoly");i&&(r.highPoly={},Object.keys(i).forEach((function(t){var e=i[t]+".lwo",o=t.startsWith("!")?t.slice(1):t,s=L.getResource(n+e);r.highPoly[o]=new T(n).parse(s)})));var o=u(e,"Activities");return o&&Object.keys(o).forEach((function(t){try{var i=u(o,t),s=u(e,i),a=u(s,"FILE"),l=!0===u(s,"LWSFILE"),c=u(s,"TRANSCOEF"),h=!0===u(s,"LOOPING");if(l){var p=L.getResource(n+a+".lws");s.animation=new S(n).parse(p),s.animation.looping=h,s.animation.transcoef=c?Number(c):1,r.activities[i]=s}else console.error("Found activity which is not an LWS file")}catch(n){console.error(n),console.log(e),console.log(o),console.log(t)}})),r},t}(),x=function(){function t(t,e,n){void 0===e&&(e=10),void 0===n&&(n=19),this.letters=[];var r=[" ","!",'"',"#","$","%","⌵","`","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","'","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","Ä","Å","Á","À","Â","Ã","Ą","ä","å","á","à","â","ã","ą","Ë","E̊","É","È","É","Ę","ë","e̊","é","è","e̊","ę̊","","","","","","","","","Ö","","","","","ö","","","","","Ü","","","","ü","","","","","","","","","","","","","","","","","","","","","","","","ß","","","","Ñ","","ñ",""],i=t.width/e;function o(t){for(var e=0;e<t.height/n;e++){var r=4*e*t.width;if(255!==t.data[r]&&255!==t.data[r+2]){for(var o=0;o<i;o++){var s=4*o;if(255===t.data[s]||255===t.data[s+2])return o}return i}}return 0}this.charHeight=t.height/n;for(var s=0;s<r.length;s++){var l=this.extractData(t,s%10*i,Math.floor(s/10)*this.charHeight,i,this.charHeight),c=o(l);l=c>0?this.extractData(l,0,0,c,this.charHeight):a(i,this.charHeight),this.letters[r[s]]=l}}return t.prototype.extractData=function(t,e,n,r,i){for(var o=c(t,e,n),s=new ImageData(r,i),a=0;a<r;a++)for(var u=0;u<i;u++){var h=c(t,e+a,n+u);h.r===o.r&&h.g===o.g&&h.b===o.b&&(h.a=0),l(s,a,u,h.r,h.g,h.b,h.a)}return s},t.prototype.createTextImage=function(t){if(null==t||t.length<1)return s(1,1).canvas;t=t.replace(/_/g," ");for(var e=0,n=0;n<t.length;n++){var r=t.charAt(n),i=this.letters[r];i?e+=i.width:console.error("Letter '"+r+"' not found in charset! Ignoring it")}var o=new ImageData(e,this.charHeight),a=0;for(n=0;n<t.length;n++){var u=this.letters[t.charAt(n)];if(u){for(var h=a;h<a+u.width;h++)for(var p=0;p<u.height;p++){var f=c(u,h-a,p);l(o,h,p,f.r,f.g,f.b,f.a)}a+=u.width}}var d=s(o.width,o.height);return d.putImageData(o,0,0),d.canvas},t}(),C=function(t,e){for(var n=0,r=e.length,i=t.length;n<r;n++,i++)t[i]=e[n];return t},L=function(){function t(){}return t.startLoadingFromCache=function(){return this.startLoading(null)},t.startLoadingFromUrl=function(t,e){return this.startLoading(new o(t,e))},t.startLoading=function(t){var e=this;this.worker.onmessage=function(t){var n=t.data;n.hasOwnProperty("msg")?e.onMessage(n.msg):n.hasOwnProperty("cfg")?(e.configuration=n.cfg,e.onInitialLoad(n.totalResources)):n.hasOwnProperty("cacheMissed")?e.onCacheMissed():n.hasOwnProperty("assetIndex")?(e.resourceByName[n.assetName.toLowerCase()]=n.assetObj,e.onAssetLoaded(n.assetIndex)):n.hasOwnProperty("done")&&(console.log("Loading of about "+n.totalResources+" assets complete! Total load time: "+n.loadingTimeSeconds+" seconds."),e.onLoadDone())},this.worker.postMessage(t)},t.cfg=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return u.apply(void 0,C([t.configuration],e))},t.filterEntryNames=function(t){var e=t.toLowerCase();return Object.keys(this.resourceByName).filter((function(t){return t.startsWith(e)}))},t.getResource=function(t){var e=t?t.toString().toLowerCase():null;return e&&this.resourceByName.hasOwnProperty(e)?this.resourceByName[e]:null},t.getImageData=function(e){if(!e||0===e.length)throw"imageName must not be undefined, null or empty - was "+e;var n=e.toLowerCase();return this.getResource(n)||(console.error("Image '"+e+"' unknown! Using placeholder image instead"),t.resourceByName[n]=a(64,64)),t.resourceByName[n]},t.getImage=function(t){var e=this.getImageData(t),n=s(e.width,e.height);return n.putImageData(e,0,0),n.canvas},t.getTexture=function(e){if(!e||0===e.length)throw"textureName must not be undefined, null or empty - was "+e;var n=e.toLowerCase(),r="world/shared/"+h(n),o=this.getResource(n)||this.getResource(r);o||(console.error("Texture '"+e+"' ("+n+", "+r+") unknown! Using placeholder texture instead"),t.resourceByName[n]=o=a(64,64));var s=new i.xEZ(o,i.xEZ.DEFAULT_MAPPING,i.rpg,i.rpg);return s.needsUpdate=!0,s},t.getMap=function(t){return t?this.getResource(t):null},t.getAnimationEntityType=function(t){var e=this.getResource(t);if(!e)throw"Could not get animation entity type for: "+t;return _.loadModels(t,e)},t.getBitmapFont=function(t){return new x(this.getResource(t))},t.worker=new r,t.configuration={},t.resourceByName={},t.onMessage=function(t){console.log(t)},t.onCacheMissed=function(){console.log("Worker missed cache")},t.onInitialLoad=function(){console.log("Initial loading done.")},t.onAssetLoaded=function(){},t.onLoadDone=function(){},t}(),M=(I=function(t,e){return(I=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}I(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),A=function(){function t(t,e){void 0===t&&(t=!1),void 0===e&&(e=!0),this.canvas=document.createElement("canvas"),t||(this.canvas.style.background="#f0f"),e&&(this.context=this.canvas.getContext("2d",{alpha:t})),this.hide()}return t.prototype.setZIndex=function(t){this.canvas.style.zIndex=String(t)},t.compareZ=function(t,e){var n,r,i,o,s=(null===(r=null===(n=null==t?void 0:t.canvas)||void 0===n?void 0:n.style)||void 0===r?void 0:r.zIndex)||0,a=(null===(o=null===(i=null==e?void 0:e.canvas)||void 0===i?void 0:i.style)||void 0===o?void 0:o.zIndex)||0;return s===a?0:s>a?-1:1},t.prototype.resize=function(t,e){this.canvas.width=t,this.canvas.height=e,this.redraw()},t.prototype.redraw=function(){this.isActive()&&this.onRedraw&&this.onRedraw(this.context)},t.prototype.show=function(){this.canvas.style.visibility="visible",this.redraw()},t.prototype.hide=function(){this.canvas.style.visibility="hidden"},t.prototype.isActive=function(){return"visible"===this.canvas.style.visibility},t.prototype.toCanvasCoords=function(t,e){var n=this.canvas.getBoundingClientRect();return[t-n.left,e-n.top]},t.prototype.handlePointerEvent=function(t,e){return!1},t.prototype.handleKeyEvent=function(t,e){return!1},t.prototype.handleWheelEvent=function(t,e){return!1},t}(),N=function(t){function e(){var e=t.call(this,!0)||this;return e.fixedWidth=mn,e.fixedHeight=wn,e}return M(e,t),e.prototype.toScaledCoords=function(t,e){var n=this.toCanvasCoords(t,e),r=n[0],i=n[1];return[r/this.scaleX(),i/this.scaleY()]},e.prototype.resize=function(e,n){t.prototype.resize.call(this,e,n),this.context.scale(this.scaleX(),this.scaleY())},e.prototype.scaleX=function(){return this.canvas.width/this.fixedWidth},e.prototype.scaleY=function(){return this.canvas.height/this.fixedHeight},e}(A),B=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.cursorName="Aclosed",e}return M(e,t),e.prototype.show=function(){t.prototype.show.call(this),this.createCursor()},e.prototype.hide=function(){t.prototype.hide.call(this),this.canvas.style.cursor=null},e.prototype.createCursor=function(){this.curUrl&&URL.revokeObjectURL(this.curUrl);var t=L.getImage("Interface/Pointers/"+this.cursorName+".bmp");this.curUrl=t.toDataURL(),this.canvas.style.cursor="url("+this.curUrl+"), auto"},e.prototype.resize=function(e,n){t.prototype.resize.call(this,e,n),this.isActive()&&this.createCursor()},e}(N);!function(t){t[t.MAIN=0]="MAIN",t[t.MIDDLE=1]="MIDDLE",t[t.SECONDARY=2]="SECONDARY"}(E||(E={}));var k,D=function(t){t.gameCanvasContainer.addEventListener("contextmenu",(function(e){t.isInRect(e)&&e.preventDefault()})),["pointermove","pointerdown","pointerup"].forEach((function(e){t.gameCanvasContainer.addEventListener(e,(function(n){if(t.isInRect(n)){n.preventDefault();var r=new PointerEvent(n.type,{bubbles:!1,clientX:n.clientX,clientY:n.clientY,pointerType:n.pointerType,button:n.button,ctrlKey:n.ctrlKey,metaKey:n.metaKey,shiftKey:n.shiftKey});t.layers.filter((function(t){return t.isActive()})).sort((function(t,e){return A.compareZ(t,e)})).some((function(t){return t.handlePointerEvent(e,r)}))}}))})),["keydown","keyup"].forEach((function(e){t.gameCanvasContainer.addEventListener(e,(function(n){t.layers.filter((function(t){return t.isActive()})).sort((function(t,e){return A.compareZ(t,e)})).some((function(t){return t.handleKeyEvent(e,n)}))}))})),t.gameCanvasContainer.addEventListener("wheel",(function(e){if(t.isInRect(e)){var n=new WheelEvent(e.type,{bubbles:!1,clientX:e.clientX,clientY:e.clientY,deltaX:e.deltaX,deltaY:e.deltaY,deltaZ:e.deltaZ,button:e.button,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey});t.layers.filter((function(t){return t.isActive()})).sort((function(t,e){return A.compareZ(t,e)})).some((function(t){return t.handleWheelEvent("wheel",n)}))}}))},j=function(){function t(){var t=this;if(this.layers=[],this.width=800,this.height=600,this.ratio=800/600,this.gameCanvasContainer=document.getElementById("game-canvas-container"),this.eventMgr=new D(this),!this.gameCanvasContainer)throw"Fatal error: game canvas container not found!";window.addEventListener("resize",(function(){return t.onWindowResize()})),this.cursorLayer=this.addLayer(new B,1e3),this.onWindowResize()}return t.prototype.addLayer=function(t,e){return void 0===e&&(e=0),t.resize(this.width,this.height),t.setZIndex(e),this.layers.push(t),this.gameCanvasContainer.appendChild(t.canvas),t},t.prototype.redraw=function(){this.layers.filter((function(t){return t.isActive()})).forEach((function(t){return t.redraw()}))},t.prototype.show=function(){this.layers.forEach((function(t){return t.show()})),this.redraw()},t.prototype.hide=function(){this.layers.forEach((function(t){return t.hide()}))},t.prototype.onWindowResize=function(){var t=this.gameCanvasContainer.offsetWidth,e=this.gameCanvasContainer.offsetHeight,n=Math.round(t/this.ratio);n>e?this.resize(Math.round(e*this.ratio),e):this.resize(t,n)},t.prototype.resize=function(t,e){this.width=t,this.height=e,this.layers.forEach((function(n){return n.resize(t,e)})),this.redraw()},t.prototype.isInRect=function(t){if(this.layers.length<1)return!1;var e=this.layers[0];if(!e.isActive()&&!e.canvas)return!1;var n=e.canvas.getBoundingClientRect(),r=t.clientX,i=t.clientY;return r>=n.left&&r<n.right&&i>=n.top&&i<n.bottom},t}(),F=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),U=function(t){function e(){var e=t.call(this)||this;return e.assetIndex=0,e.totalResources=0,e.layer=e.addLayer(new A),e.layer.onRedraw=function(t){t.fillStyle="black",t.fillRect(0,0,e.width,e.height),t.font="48px Arial",t.fillStyle="white",t.fillText("Loading Rock Raiders",5,e.height-80),t.font="30px Arial",t.fillStyle="white",t.fillText("Loading...",20,e.height-30)},e}return F(e,t),e.prototype.show=function(){var t=this;this.layers.filter((function(e){return e!==t.cursorLayer})).forEach((function(t){return t.show()})),this.redraw()},e.prototype.setLoadingMessage=function(t){var e=this;this.layer.onRedraw=function(n){n.fillStyle="black",n.fillRect(0,e.height-60,e.width,60),n.font="30px Arial",n.fillStyle="white",n.fillText(t,20,e.height-30)},this.redraw()},e.prototype.enableGraphicMode=function(t){var e=this;this.totalResources=t;var n=L.getImage(L.cfg("Main","LoadScreen")),r=L.getImage(L.cfg("Main","ProgressBar"));this.layer.onRedraw=function(t){var i=e.width/n.width,o=353*e.assetIndex/e.totalResources*i;t.drawImage(n,0,0,e.width,e.height),t.drawImage(r,142*i,450*i,o,9*i)},this.cursorLayer.show(),this.redraw()},e.prototype.setLoadingState=function(t){this.assetIndex!==t&&(this.assetIndex=t,this.redraw())},e}(j),W=function(){function t(){this.x=0,this.y=0,this.width=0,this.height=0,this.zIndex=100,this.scrollAffected=!1,this.needsRedraw=!1,this.hover=!1,this.pressed=!1,this.actionName="",this.targetIndex=0}return t.compareZ=function(t,e){return t.zIndex===e.zIndex?0:t.zIndex>e.zIndex?-1:1},t.prototype.checkHover=function(t,e){var n=t>=this.x&&t<this.x+this.width&&e>=this.y&&e<this.y+this.height;return this.hover!==n&&(this.hover=n,this.needsRedraw=!0,this.onHoverChange()),this.hover||(this.pressed=!1),this.hover},t.prototype.onHoverChange=function(){},t.prototype.checkSetPressed=function(){this.hover&&(this.pressed||(this.needsRedraw=!0),this.pressed=!0)},t.prototype.setReleased=function(){this.pressed&&(this.needsRedraw=!0),this.pressed=!1},t.prototype.draw=function(t){this.needsRedraw=!1},t}(),G=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),H=function(t){function e(e,n){var r=t.call(this)||this;return r.labelImgLo=null,r.labelImgHi=null,r.labelImgLo=e.loFont.createTextImage(n.label),r.labelImgHi=e.hiFont.createTextImage(n.label),r.width=Math.max(r.labelImgLo.width,r.labelImgHi.width),r.height=Math.max(r.labelImgLo.height,r.labelImgHi.height),r.x=e.cfg.autoCenter?(e.fixedWidth-r.width)/2:e.cfg.position[0]+n.x,r.y=e.cfg.position[1]+n.y,r.actionName=n.actionName,"Next"===r.actionName&&(r.targetIndex=Number(n.target.substring("menu".length))-1),r}return G(e,t),e.prototype.draw=function(e){t.prototype.draw.call(this,e);var n=this.hover&&!this.pressed?this.labelImgHi:this.labelImgLo;e.drawImage(n,this.x,this.y)},e}(W),K=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),V=function(t){function e(e,n){var r=t.call(this)||this;return r.imgNormal=null,r.imgHover=null,r.imgPressed=null,r.tooltip="",r.imgNormal=L.getImage(n.imgNormal),r.imgHover=L.getImage(n.imgHover),r.imgPressed=L.getImage(n.imgPressed),r.tooltip=(n.tooltip||"").replace(/_/g," "),r.width=Math.max(r.imgNormal.width,r.imgHover.width,r.imgPressed.width),r.height=Math.max(r.imgNormal.height,r.imgHover.height,r.imgPressed.height),r.x=e.cfg.autoCenter?(e.fixedWidth-r.width)/2:e.cfg.position[0]+n.x,r.y=e.cfg.position[1]+n.y,r.actionName=n.actionName,"Next"===r.actionName&&(r.targetIndex=Number(n.target.substring("menu".length))-1),r}return K(e,t),e.prototype.draw=function(e){t.prototype.draw.call(this,e);var n=this.imgNormal;this.hover&&(n=this.imgHover),this.pressed&&(n=this.imgPressed),e.drawImage(n,this.x,this.y)},e}(W),z=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Y=function(t){function e(e,n){var r=t.call(this)||this;return r.items=[],r.scrollY=0,r.screen=e,r.cfg=n,r.fullName=n.fullName.replace(/_/g," "),r.title=n.title.replace(/_/g," "),r.menuFont=n.menuFont?L.getBitmapFont(n.menuFont):null,r.loFont=n.loFont?L.getBitmapFont(n.loFont):null,r.hiFont=n.hiFont?L.getBitmapFont(n.hiFont):null,r.menuImage=n.menuImage?L.getImage(n.menuImage):null,r.titleImage=r.loFont.createTextImage(r.fullName),n.items.forEach((function(t){t.label?r.items.push(new H(r,t)):r.items.push(new V(r,t))})),r.items.sort((function(t,e){return W.compareZ(t,e)})),r.onRedraw=function(t){t.drawImage(r.menuImage,0,-r.scrollY),n.displayTitle&&t.drawImage(r.titleImage,(r.fixedWidth-r.titleImage.width)/2,r.cfg.position[1]),r.items.forEach((function(e,n){return r.items[r.items.length-1-n].draw(t)}))},r}return z(e,t),e.prototype.handlePointerEvent=function(t,e){var n=this;if("pointermove"===t){var r=this.toScaledCoords(e.clientX,e.clientY),i=r[0],o=r[1],s=!1;this.items.forEach((function(t){if(s)t.hover&&(t.needsRedraw=!0),t.hover=!1,t.setReleased();else{var e=o+(t.scrollAffected?n.scrollY:0);s=t.checkHover(i,e)}}))}else"pointerdown"===t?e.button===E.MAIN&&this.items.forEach((function(t){return t.checkSetPressed()})):"pointerup"===t&&e.button===E.MAIN&&this.items.forEach((function(t){t.pressed&&(t.setReleased(),"next"===t.actionName.toLowerCase()?n.screen.showMainMenu(t.targetIndex):"selectlevel"===t.actionName.toLowerCase()?n.screen.selectLevel(t.levelKey):t.actionName&&console.warn("not implemented: "+t.actionName+" - "+t.targetIndex))}));return this.needsRedraw()&&this.redraw(),!1},e.prototype.handleWheelEvent=function(t,e){return!!this.cfg.canScroll&&(this.scrollY=Math.min(Math.max(this.scrollY+e.deltaY,0),this.menuImage.height-this.fixedHeight),this.redraw(),!0)},e.prototype.needsRedraw=function(){return this.items.some((function(t){return t.needsRedraw}))},e}(N),J=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),X=function(t){function e(e,n,r){var i=t.call(this)||this;i.imgActive=null,i.imgInactive=null,i.imgCross=null,i.unlocked=!1,i.levelKey="",i.layer=e,i.actionName="selectlevel",i.levelKey=n,i.x=r.frontEndX,i.y=r.frontEndY,i.zIndex=10,i.scrollAffected=!0;var o=r.menuBMP,s=o[0],a=o[1],l=o[2];return i.imgActive=L.getImage(s),i.imgInactive=L.getImage(a),i.imgCross=L.getImage(l),i.width=Math.max(i.imgActive.width,i.imgInactive.width,i.imgCross.width),i.height=Math.max(i.imgActive.height,i.imgInactive.height,i.imgCross.height),i.unlocked=r.frontEndOpen,i.unlocked=!0,i}return J(e,t),e.prototype.draw=function(e){t.prototype.draw.call(this,e);var n=this.imgCross;this.unlocked&&(n=this.hover?this.imgActive:this.imgInactive),e.drawImage(n,this.x,this.y-this.layer.scrollY)},e}(W),q=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Z=function(t){function e(e,n){var r=t.call(this)||this;return r.zIndex=50,r.context=s(e.width,e.height),r.context.putImageData(e,0,0),r.x=n.x,r.y=n.y,r.width=n.w,r.height=n.h,r}return q(e,t),e.prototype.checkHover=function(t,e){var n=t>=this.x&&t<this.x+this.width&&e>=this.y&&e<this.y+this.height&&this.context.getImageData(t,e,1,1).data[3]>0;return this.hover!==n&&(this.needsRedraw=!0),this.hover=n,this.hover},e.prototype.draw=function(e){t.prototype.draw.call(this,e),e.drawImage(this.context.canvas,this.x,this.y,this.width,this.height)},e}(W),$=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Q=function(t){function e(e,n){var r=t.call(this)||this;return r.imgFirstLine=null,r.imgSecondLine=null,r.font=e,r.x=n.x,r.y=n.y,r.width=n.w,r.height=n.h,r}return $(e,t),e.prototype.setFirstLine=function(t){this.imgFirstLine=t?this.font.createTextImage(t):null},e.prototype.setSecondLine=function(t){this.imgSecondLine=t?this.font.createTextImage(t):null},e.prototype.draw=function(e){t.prototype.draw.call(this,e);var n=this.x+this.width/2,r=this.y+this.height/2;this.imgFirstLine&&e.drawImage(this.imgFirstLine,n-this.imgFirstLine.width/2,r-this.imgFirstLine.height),this.imgSecondLine&&e.drawImage(this.imgSecondLine,n-this.imgSecondLine.width/2,r)},e}(W),tt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),et=function(t){function e(e,n,r){var i=t.call(this,e,n)||this,o=L.getResource("Levels"),s=new nt;i.items.push(new Z(s.panelImgData,s.panelPos));var a=new Q(L.getBitmapFont("Interface/Fonts/Font5_Hi.bmp"),s.window);return a.setFirstLine(r?s.level:s.tutorial),i.items.push(a),Object.keys(o.levelsByName).forEach((function(t){var e=o.levelsByName[t],n=new X(i,t,e);n.onHoverChange=function(){return a.setSecondLine(n.hover?e.fullName:"")},i.items.push(n)})),i.items.sort((function(t,e){return W.compareZ(t,e)})),i}return tt(e,t),e.prototype.show=function(){this.scrollY=0,t.prototype.show.call(this)},e}(Y),nt=function(){this.window={x:0,y:0,w:0,h:0},this.panelPos={x:0,y:0,w:0,h:0},this.level="",this.tutorial="";var t=L.cfg("Menu","LevelText"),e=p(t,"Window");this.window={x:e[0],y:e[1],w:e[2],h:e[3]};var n=p(t,"Panel");this.panelImgData=L.getImageData(n[0]),this.panelPos={x:n[1],y:n[2],w:n[3],h:n[4]},this.level=p(t,"Level").join(",").replace(/_/g," "),this.tutorial=p(t,"Tutorial").join(",").replace(/_/g," ")},rt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),it=function(t){function e(){var e=t.call(this)||this;return e.onLevelSelected=null,e.menus=[],L.getResource("MainMenuFull").menus.forEach((function(t){var n;n="Levels"===t.title?new et(e,t,!0):"Tutorials"===t.title?new et(e,t,!1):new Y(e,t),e.menus.push(n),e.addLayer(n)})),e}return rt(e,t),e.prototype.showMainMenu=function(t){void 0===t&&(t=0),this.hide(),this.menus[t].show(),this.cursorLayer.show()},e.prototype.showLevelSelection=function(){this.showMainMenu(1)},e.prototype.selectLevel=function(t){this.hide(),this.onLevelSelected(t)},e}(j),ot=n(466),st=function(){function t(){this.stats=new ot,this.stats.setMode(0),this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement),this.hide()}return t.prototype.show=function(){this.stats.domElement.style.visibility="visible"},t.prototype.hide=function(){this.stats.domElement.style.visibility="hidden"},t.prototype.renderStart=function(){this.stats.begin()},t.prototype.renderDone=function(){this.stats.end()},t}(),at=n(886),lt=function(){function t(t,e,n,r){void 0===e&&(e=0),void 0===n&&(n=0),void 0===r&&(r=!1),this.dropPosAngleDeg=0,this.dropPosDist=0,this.selfPowered=!1,this.name=t,this.aeFile=t+"/"+t.slice(t.lastIndexOf("/")+1)+".ae",this.dropPosAngleDeg=e,this.dropPosDist=n,this.selfPowered=r}return t.getByName=function(t){switch(t.slice(t.lastIndexOf("/")+1).toLowerCase()){case"toolstation":return this.TOOLSTATION;case"teleports":return this.TELEPORT_PAD;case"upgrade":return this.UPGRADE;case"powerstation":return this.POWER_STATION;case"support":return this.SUPPORT;case"refinery":return this.REFINERY;case"geo-dome":return this.GEODOME;default:throw"Unknown building type: "+t}},t.TOOLSTATION=new t("Buildings/Toolstation",130,10,!0),t.TELEPORT_PAD=new t("Buildings/Teleports"),t.POWER_STATION=new t("Buildings/Powerstation"),t.SUPPORT=new t("Buildings/Support"),t.UPGRADE=new t("Buildings/Upgrade"),t.REFINERY=new t("Buildings/Refinery"),t.GEODOME=new t("Buildings/Geo-dome"),t}();!function(t){t[t.SURFACE=0]="SURFACE",t[t.PILOT=1]="PILOT",t[t.BUILDING=2]="BUILDING",t[t.VEHICLE=3]="VEHICLE",t[t.GROUP=4]="GROUP"}(k||(k={}));var ct,ut=function(){function t(){this.group=new i.ZAu,this.sequenceIntervals=[]}return t.prototype.getPosition=function(){return(new i.Pa4).copy(this.group.position)},t.prototype.getRotation=function(){return(new i.USm).copy(this.group.rotation)},t.prototype.onDiscover=function(){this.group.visible=!0},t}(),ht=function(){function t(){}return t.publishEvent=function(t){if(!this.blockedEvents.includes(t.eventKey)){t.isLocal||console.log("Event published: "+t.eventKey),this.blockedEvents.push(t.eventKey),(this.eventListener[t.eventKey]||[]).forEach((function(e){return e(t)}));var e=this.blockedEvents.indexOf(t.eventKey);e>-1&&this.blockedEvents.splice(e,1)}},t.registerEventListener=function(t,e){this.eventListener[t]=this.eventListener[t]||[],this.eventListener[t].push(e)},t.eventListener={},t.blockedEvents=[],t}(),pt=function(t){this.eventKey=t},ft=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),dt=function(t){function e(e){var n=t.call(this,e)||this;return n.isLocal=!1,n}return ft(e,t),e}(pt),gt=function(t){function e(e,n){var r=t.call(this,e)||this;return r.job=n,r}return ft(e,t),e}(dt),yt=function(t){function e(n){return t.call(this,e.eventKey,n)||this}return ft(e,t),e.eventKey="job.create",e}(gt),vt=function(t){function e(n){return t.call(this,e.eventKey,n)||this}return ft(e,t),e.eventKey="job.delete",e}(gt),mt=function(t){function e(n){var r=t.call(this,e.eventKey)||this;return r.numRequested=0,r.numRequested=n,r}return ft(e,t),e.eventKey="raider.request",e}(dt),wt=function(t){function e(n){var r=t.call(this,e.eventKey)||this;return r.collectType=n,r}return ft(e,t),e.eventKey="item.collected",e}(dt),bt=function(t){function e(n){var r=t.call(this,e.eventKey)||this;return r.surface=n,r}return ft(e,t),e.eventKey="spawn.dynamite",e}(dt),It=function(t){function e(n,r){var i=t.call(this,e.eventKey)||this;return i.collectable=n,i.spawnPosition=r,i}return ft(e,t),e.eventKey="spawn.material",e}(dt),Et=function(t){function e(n,r){var i=t.call(this,e.eventKey)||this;return i.type=n,i.entity=r,i}return ft(e,t),e.eventKey="added.entity",e}(dt),Tt=function(t){function e(n,r){var i=t.call(this,e.eventKey)||this;return i.type=n,i.entity=r,i}return ft(e,t),e.eventKey="remove.entity",e}(dt);!function(t){t[t.RAIDER=0]="RAIDER",t[t.VEHICLE=1]="VEHICLE",t[t.BUILDING=2]="BUILDING"}(ct||(ct={}));var Pt,Rt,Ot=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();!function(t){t[t.SURFACE=0]="SURFACE",t[t.CARRY=1]="CARRY",t[t.MOVE=2]="MOVE"}(Pt||(Pt={})),function(t){t[t.OPEN=0]="OPEN",t[t.COMPLETE=1]="COMPLETE",t[t.CANCELED=2]="CANCELED"}(Rt||(Rt={}));var St,_t,xt=function(){function t(t){this.fulfiller=[],this.type=t,this.jobstate=Rt.OPEN}return t.prototype.assign=function(t){var e=this.fulfiller.indexOf(t);t&&-1===e&&this.fulfiller.push(t)},t.prototype.unassign=function(t){var e=this.fulfiller.indexOf(t);e>-1&&this.fulfiller.splice(e,1)},t.prototype.cancel=function(){this.jobstate=Rt.CANCELED;var t=this.fulfiller;this.fulfiller=[],t.forEach((function(t){return t.stopJob()}))},t.prototype.isQualified=function(t){return!0},t.prototype.onJobComplete=function(){this.jobstate=Rt.COMPLETE},t}(),Ct=function(t){function e(e){var n=t.call(this,Pt.CARRY)||this;return n.item=e,n}return Ot(e,t),e.prototype.getPosition=function(){return this.item.getPosition()},e.prototype.isInArea=function(t,e){var n=this.getPosition();return n.sub(new i.Pa4(t,n.y,e)).length()<hn},e.prototype.isQualified=function(t){return null===t.carries&&!!this.item.getTargetPos()},e.prototype.onJobComplete=function(){if(t.prototype.onJobComplete.call(this),this.item.getTargetType()===lt.TOOLSTATION)switch(this.item.getCollectableType()){case St.CRYSTAL:Zt.numCrystal++,ht.publishEvent(new wt(this.item.getCollectableType()));break;case St.ORE:Zt.numOre++,ht.publishEvent(new wt(this.item.getCollectableType()))}else this.item.getTargetType()===_t.BUILDING_SITE?this.item.targetSite.addItem(this.item):console.error("target type not yet implemented: "+this.item.getTargetType())},e}(xt),Lt=function(t){function e(e){var n=t.call(this,Pt.MOVE)||this;return n.target=e,n}return Ot(e,t),e.prototype.getPosition=function(){return(new i.Pa4).copy(this.target)},e.prototype.isInArea=function(t,e){return this.getPosition().sub(new i.Pa4(t,this.target.y,e)).lengthSq()<fn*fn},e}(xt),Mt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),At=function(t){function e(e){var n=t.call(this)||this;return n.targetPos=null,n.collectableType=e,n}return Mt(e,t),e.prototype.getTargetPos=function(){if(this.targetPos)this.targetSite?this.targetSite.complete&&this.resetTarget():this.targetBuilding;else{var t=Zt.getClosestSiteThatRequires(this.getPosition(),this.getCollectableType());if(t)this.targetSite=t,this.targetPos=t.getPosition(),this.targetType=_t.BUILDING_SITE,t.assign(this);else{var e=Zt.getClosestBuildingByType.apply(Zt,function(t,e){for(var n=0,r=e.length,i=t.length;n<r;n++,i++)t[i]=e[n];return t}([this.getPosition()],this.getTargetBuildingTypes()));e&&(this.targetBuilding=e,this.targetPos=e.getDropPosition(),this.targetType=e.type)}}return this.targetPos},e.prototype.getTargetType=function(){return this.targetType},e.prototype.resetTarget=function(){this.targetSite&&this.targetSite.unAssign(this),this.targetSite=null,this.targetBuilding=null,this.targetPos=null,this.targetType=null},e.prototype.onDiscover=function(){t.prototype.onDiscover.call(this);var e=Zt.collectablesUndiscovered.indexOf(this);-1!==e&&Zt.collectablesUndiscovered.splice(e,1),Zt.collectables.push(this),ht.publishEvent(new yt(new Ct(this)))},e.prototype.getCollectableType=function(){return this.collectableType},e}(ut);!function(t){t[t.DYNAMITE=0]="DYNAMITE",t[t.CRYSTAL=1]="CRYSTAL",t[t.ORE=2]="ORE",t[t.BRICK=3]="BRICK",t[t.BARRIER=4]="BARRIER"}(St||(St={})),function(t){t[t.SURFACE=0]="SURFACE",t[t.BUILDING_SITE=1]="BUILDING_SITE"}(_t||(_t={}));var Nt,Bt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),kt=function(t){function e(e){var n=t.call(this,e)||this;return n.isLocal=!0,n}return Bt(e,t),e}(pt),Dt=function(t){function e(n){var r=t.call(this,e.eventKey)||this;return r.surface=n,r}return Bt(e,t),e.eventKey="surface.selected",e}(kt),jt=function(t){function e(n){var r=t.call(this,e.eventKey)||this;return r.building=n,r}return Bt(e,t),e.eventKey="building.selected",e}(kt),Ft=function(t){function e(n){var r=t.call(this,e.eventKey)||this;return r.raider=n,r}return Bt(e,t),e.eventKey="raider.select",e}(kt),Ut=function(t){function e(n){var r=t.call(this,e.eventKey)||this;return r.vehicle=n,r}return Bt(e,t),e.eventKey="vehicle.select",e}(kt),Wt=function(t){function e(){return t.call(this,e.eventKey)||this}return Bt(e,t),e.eventKey="entity.deselect",e}(kt),Gt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ht=function(t){function e(e){var n=t.call(this)||this;return n.entityType=null,n.poly=[],n.animation=null,n.animationTimeout=null,n.selectionFrame=null,n.pickSphere=null,n.pickSphereRadius=10,n.selectionFrameSize=10,n.carryJoint=null,n.entityType=e,n}return Gt(e,t),e.prototype.setActivity=function(t,e,n){var r,i=this;void 0===e&&(e=null),void 0===n&&(n=1),this.animationTimeout&&(clearTimeout(this.animationTimeout),this.animationTimeout=null);var o=p(this.entityType.activities,t);if(!o)return console.error("Activity '"+t+"' unknown"),void console.log(this.entityType.activities);if(o.animation){this.animation=o.animation,(r=this.group).remove.apply(r,this.poly),this.poly=[];var s=this.carryJoint&&this.carryJoint.children||[];this.carryJoint=null,this.animation.bodies.forEach((function(t){var e,n=p(i.entityType.highPoly,t.name);n||(n=p(i.entityType.mediumPoly,t.name)),n||(n=t.model);var r=n.clone(!0);i.poly.push(r),i.entityType.carryNullName&&t.name&&i.entityType.carryNullName.toLowerCase()===t.name.toLowerCase()&&(i.carryJoint=r,s.length>0&&(e=i.carryJoint).add.apply(e,s))})),this.animation.bodies.forEach((function(t,e){var n=i.poly[e],r=t.parentObjInd;null!=r?i.poly[r].add(n):i.group.add(n)})),this.animate(0,e,n)}else console.warn("Activity "+t+" has no animation defined yet")},e.prototype.animate=function(t,e,n){var r=this;if(this.poly.length!==this.animation.bodies.length)throw"Cannot animate poly. Length differs from bodies length";if(this.animation.bodies.forEach((function(e,n){var i=r.poly[n];if(i.position.copy(e.relPos[t]),i.rotation.copy(e.relRot[t]),i.scale.copy(e.relScale[t]),i.hasOwnProperty("material")){var o=i.material,s=e.opacity[t];o&&void 0!==s&&(Array.isArray(o)?o:[o]).forEach((function(t){t.opacity=s,t.transparent=!0,t.alphaTest=0}))}})),this.animationTimeout=null,!(t+1>this.animation.lastFrame)||this.animation.looping&&(!e||n>1)){var i=t+1;i>this.animation.lastFrame&&(i=this.animation.firstFrame,n--);var o=this;this.animationTimeout=setTimeout((function(){return o.animate(i,e,n)}),1e3/this.animation.framesPerSecond*this.animation.transcoef)}else e&&e()},e.prototype.createPickSphere=function(){if(!this.pickSphere){var t=new i.Pa4;(new i.ZzF).setFromObject(this.group).getCenter(t),t.sub(this.group.position);var e=new i.xo$(this.pickSphereRadius,this.pickSphereRadius,this.pickSphereRadius),n=new i.vBJ({color:16776960,visible:!1});this.pickSphere=new i.Kj0(e,n),this.pickSphere.userData={selectable:this},this.pickSphere.position.copy(t),this.group.add(this.pickSphere);var r=document.createElement("canvas").getContext("2d"),o=128;r.canvas.width=o,r.canvas.height=o,r.fillStyle="#0f0";var s=50/this.selectionFrameSize,a=o/3;r.fillRect(0,0,a,s),r.fillRect(0,0,s,a),r.fillRect(o-a,0,a,s),r.fillRect(o-s,0,s,a),r.fillRect(o-s,o-a,s,a),r.fillRect(o-a,o-s,a,s),r.fillRect(0,o-s,a,s),r.fillRect(0,o-a,s,a);var l=new i.ROQ(r.canvas),c=new i.xeV({map:l,depthTest:!1});this.selectionFrame=new i.jyi(c),this.selectionFrame.position.copy(t),this.selectionFrame.scale.set(this.selectionFrameSize,this.selectionFrameSize,this.selectionFrameSize),this.selectionFrame.visible=!1,this.group.add(this.selectionFrame)}},e}(ut),Kt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Vt=function(t){function e(){return t.call(this,L.getAnimationEntityType("MiscAnims/Dynamite/Dynamite.ae"))||this}return Kt(e,t),e.prototype.getTargetPos=function(){return this.targetSurface&&this.targetSurface.isExplodable()?this.targetSurface.getDigPositions()[0]:Zt.getClosestBuildingByType(this.getPosition(),lt.TOOLSTATION).getDropPosition()},e.prototype.getCollectableType=function(){return St.DYNAMITE},e.prototype.ignite=function(){var t=this;this.worldMgr.sceneManager.scene.add(this.group);var e=this.targetSurface.getCenterWorld();e.y=this.group.position.y,this.group.lookAt(e),this.setActivity("TickDown",(function(){t.worldMgr.sceneManager.scene.remove(t.group),t.targetSurface.collapse()}))},e}(Ht),zt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Yt=function(t){function e(){var e=t.call(this,St.CRYSTAL)||this,n=L.getResource("MiscAnims/Crystal/vlp_greencrystal.lwo"),r=new T("MiscAnims/Crystal/").parse(n);r.material.forEach((function(t){t.color=new i.Ilk(0,0,0),t.emissive=new i.Ilk(0,255,0),t.depthWrite=!1,t.opacity=.5,t.transparent=!0})),r.scale.set(1.75,1.75,1.75),e.group.add(r);var o=L.getResource("World/Shared/Crystal.lwo"),s=new T("World/Shared/").parse(o);return s.material.forEach((function(t){t.emissive=new i.Ilk(0,8,0),t.color=new i.Ilk(0,0,0),t.transparent=!0,t.opacity=.4})),e.group.add(s),e.sequenceIntervals.forEach((function(t){return clearInterval(t)})),e}return zt(e,t),e.prototype.getTargetBuildingTypes=function(){return[lt.POWER_STATION,lt.TOOLSTATION]},e.prototype.onDiscover=function(){t.prototype.onDiscover.call(this),console.log("An energy crystal has been discovered")},e}(At),Jt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Xt=function(t){function e(){var e=t.call(this,St.ORE)||this,n=L.getResource("MiscAnims/Ore/Ore1st.lwo"),r=new T("MiscAnims/Ore/").parse(n);return e.group.add(r),e}return Jt(e,t),e.prototype.getTargetBuildingTypes=function(){return[lt.REFINERY,lt.TOOLSTATION]},e.prototype.onDiscover=function(){t.prototype.onDiscover.call(this),console.log("Ore has been discovered")},e}(At);!function(t){t[t.RUNNING=0]="RUNNING",t[t.COMPLETE=1]="COMPLETE",t[t.FAILED=2]="FAILED",t[t.CANCELED=3]="CANCELED"}(Nt||(Nt={}));var qt,Zt=function(){function t(){}return t.reset=function(){this.resultState=Nt.RUNNING,this.levelFullName="",this.numCrystal=0,this.numOre=0,this.numBrick=0,this.usedCrystals=0,this.neededCrystals=0,this.airlevel=1,this.selectedEntities=[],this.selectionType=null,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.requestedRaiders=0,this.vehicles=[],this.vehiclesUndiscovered=[],this.collectables=[],this.collectablesUndiscovered=[],this.buildingSites=[],this.totalCrystals=0,this.totalOres=0,this.totalDiggables=0,this.remainingDiggables=0,this.totalCaverns=0,this.remainingCaverns=0,this.levelStartTime=0,this.levelStopTime=0},t.getBuildingsByType=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=[],r=function(e){n.push.apply(n,i.buildings.filter((function(n){return n.type===t[e]})))},i=this,o=0;o<t.length;o++)r(o);return n},t.getClosestBuildingByType=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var o=t.getBuildingsByType.apply(t,n),s=null,a=null;return o.forEach((function(t){var n=t.getDropPosition(),r=(new i.Pa4).copy(e).sub(n).lengthSq();(null===s||r<a)&&(s=t,a=r)})),s},t.getClosestSiteThatRequires=function(t,e){var n=null,r=null;return this.buildingSites.forEach((function(o){var s=o.getPosition(),a=(new i.Pa4).copy(t).sub(s).lengthSq();(null===n||a<r)&&o.needs(e)&&(n=o,r=a)})),n},t.selectEntities=function(t){var e;this.selectedEntities.filter((function(e){return-1===t.indexOf(e)})).forEach((function(t){return t.deselect()})),this.selectedEntities=this.selectedEntities.filter((function(e){return-1!==t.indexOf(e)})),(e=this.selectedEntities).push.apply(e,t.filter((function(t){return t.select()})));var n=this.selectedEntities.length;n>1?this.selectionType=k.GROUP:1===n?this.selectionType=this.selectedEntities[0].getSelectionType():null!==this.selectionType&&(this.selectionType=null,ht.publishEvent(new Wt))},t.getMaxRaiders=function(){return dn+this.getBuildingsByType(lt.SUPPORT).length*gn},t.discoverSurface=function(t){var e=t.x*bn,n=t.y*bn,r=e+bn,i=n+bn;this.discoverEntities(this.raidersUndiscovered,e,r,n,i),this.discoverEntities(this.buildingsUndiscovered,e,r,n,i),this.discoverEntities(this.vehiclesUndiscovered,e,r,n,i),this.discoverEntities(this.collectablesUndiscovered,e,r,n,i)},t.discoverEntities=function(t,e,n,r,i){var o=[];t.forEach((function(t){var s=t.getPosition();s.x>=e&&s.x<n&&s.z>=r&&s.z<i&&(t.onDiscover(),o.push(t))})),o.forEach((function(e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}))},t.dropMaterial=function(e,n){var r=[];if(e===St.DYNAMITE)for(var i=0;i<n;i++)r.push(new Vt);else if(e===St.CRYSTAL)for(;t.numCrystal>0&&r.length<n;)t.numCrystal--,r.push(new Yt);else if(e===St.ORE)for(;t.numOre>0&&r.length<n;)t.numOre--,r.push(new Xt);else console.error("Material drop not yet implemented: "+e);return r},t.resultState=Nt.RUNNING,t.levelFullName="",t.numCrystal=0,t.numOre=0,t.numBrick=0,t.usedCrystals=0,t.neededCrystals=0,t.airlevel=1,t.selectedEntities=[],t.selectionType=null,t.buildings=[],t.buildingsUndiscovered=[],t.raiders=[],t.raidersUndiscovered=[],t.requestedRaiders=0,t.vehicles=[],t.vehiclesUndiscovered=[],t.collectables=[],t.collectablesUndiscovered=[],t.buildingSites=[],t.totalCrystals=0,t.totalOres=0,t.totalDiggables=0,t.remainingDiggables=0,t.totalCaverns=0,t.remainingCaverns=0,t.levelStartTime=0,t.levelStopTime=0,t}(),$t=function(){function t(t){this.maxFps=30,this.debugHelper=new st,this.renderer=new i.CP7({antialias:!0,canvas:t}),this.renderer.setClearColor(0),this.scene=new i.xsS,this.amb=new i.Mig(8421504),this.scene.add(this.amb),this.cursorTorchlight=new i.cek(16777215,1,7,2),this.scene.add(this.cursorTorchlight),this.camera=new i.cPb(30,t.width/t.height,.1,5e3),this.controls=new at.o(this.camera,this.renderer.domElement),this.controls.mouseButtons={LEFT:null,MIDDLE:i.RsA.ROTATE,RIGHT:i.RsA.PAN}}return t.prototype.selectEntitiesByRay=function(t,e){var n=new i.iMs;n.setFromCamera({x:t,y:e},this.camera);var r=n.intersectObjects(Zt.raiders.map((function(t){return t.pickSphere})));r.length<1&&(r=n.intersectObjects(Zt.vehicles.map((function(t){return t.pickSphere})))),r.length<1&&(r=n.intersectObjects(Zt.buildings.map((function(t){return t.pickSphere})))),r.length<1&&(r=n.intersectObjects(this.terrain.floorGroup.children));var o=[];if(r.length>0){var s=r[0].object.userData;if(s&&s.hasOwnProperty("selectable")){var a=s.selectable;a&&o.push(a)}}Zt.selectEntities(o)},t.prototype.selectEntitiesInFrustum=function(t,e,n,r){var o=new i.Pa4(t,e,.5),s=new i.Pa4(n,r,.5);o.x===s.x&&(s.x+=Number.EPSILON),o.y===s.y&&(s.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld();var a=new i.Pa4;a.copy(o),a.x=Math.min(o.x,s.x),a.y=Math.max(o.y,s.y),s.x=Math.max(o.x,s.x),s.y=Math.min(o.y,s.y);var l=new i.Pa4,c=new i.Pa4,u=new i.Pa4,h=new i.Pa4,p=new i.Pa4;l.setFromMatrixPosition(this.camera.matrixWorld),c.copy(a),u.set(s.x,a.y,0),h.copy(s),p.set(a.x,s.y,0),c.unproject(this.camera),u.unproject(this.camera),h.unproject(this.camera),p.unproject(this.camera);var f=new i.Pa4,d=new i.Pa4,g=new i.Pa4;f.copy(c).sub(l),d.copy(u).sub(l),g.copy(h).sub(l),f.normalize(),d.normalize(),g.normalize();var y=Number.MAX_VALUE;f.multiplyScalar(y),d.multiplyScalar(y),g.multiplyScalar(y),f.add(l),d.add(l),g.add(l);var v=new i.iWj,m=v.planes;m[0].setFromCoplanarPoints(l,c,u),m[1].setFromCoplanarPoints(l,u,h),m[2].setFromCoplanarPoints(h,p,l),m[3].setFromCoplanarPoints(p,c,l),m[4].setFromCoplanarPoints(u,h,p),m[5].setFromCoplanarPoints(g,d,f),m[5].normal.multiplyScalar(-1);var w=Zt.raiders.filter((function(t){return v.containsPoint(t.getSelectionCenter())}));w.push.apply(w,Zt.vehicles.filter((function(t){return v.containsPoint(t.getSelectionCenter())}))),w.length<1&&(w=Zt.buildings.filter((function(t){return v.containsPoint(t.getSelectionCenter())}))),Zt.selectEntities(w)},t.prototype.startRendering=function(){var t=this;this.debugHelper.show(),this.renderInterval=setInterval((function(){t.animRequest=requestAnimationFrame((function(){t.debugHelper.renderStart(),t.renderer.render(t.scene,t.camera),t.debugHelper.renderDone()}))}),1e3/this.maxFps)},t.prototype.stopRendering=function(){this.debugHelper.hide(),this.renderInterval&&(clearInterval(this.renderInterval),this.renderInterval=null),this.animRequest&&(cancelAnimationFrame(this.animRequest),this.animRequest=null)},t}(),Qt=function(){function t(t){void 0===t&&(t={}),this.shaping=!1,this.matIndex="00",this.floor=!1,this.selectable=!1,this.drillable=!1,this.explodable=!1,this.reinforcable=!1,Object.assign(this,t)}return t.getByNum=function(e){switch(e){case 0:return t.POWER_PATH_BUILDING;case 1:return t.SOLID_ROCK;case 2:return t.HARD_ROCK;case 3:return t.LOOSE_ROCK;case 4:case 5:return t.DIRT;case 6:return t.LAVA;case 8:return t.ORE_SEAM;case 9:return t.WATER;case 10:return t.CRYSTAL_SEAM;case 11:return t.RECHARGE_SEAM;case 30:case 40:return t.SLUG_HOLE;case 100:return t.RUBBLE4;case 101:return t.RUBBLE3;case 102:return t.RUBBLE2;case 103:return t.RUBBLE1;default:return console.error("Unexpected surface type num: "+e),t.SOLID_ROCK}},t.GROUND=new t({name:"ground",floor:!0,selectable:!0}),t.SOLID_ROCK=new t({name:"solid rock",shaping:!0,matIndex:"5"}),t.HARD_ROCK=new t({name:"hard rock",shaping:!0,matIndex:"4",selectable:!0,explodable:!0,reinforcable:!0}),t.LOOSE_ROCK=new t({name:"loose rock",shaping:!0,matIndex:"3",selectable:!0,drillable:!0,explodable:!0,reinforcable:!0}),t.DIRT=new t({name:"dirt",shaping:!0,matIndex:"1",selectable:!0,drillable:!0,explodable:!0,reinforcable:!0}),t.SLUG_HOLE=new t({name:"slug hole",floor:!0,matIndex:"30"}),t.LAVA=new t({name:"lava",floor:!0,matIndex:"46"}),t.ORE_SEAM=new t({name:"ore seam",matIndex:"40",selectable:!0,drillable:!0,explodable:!0,reinforcable:!0}),t.WATER=new t({name:"water",floor:!0,matIndex:"45"}),t.CRYSTAL_SEAM=new t({name:"energy crystal seam",matIndex:"20",selectable:!0,drillable:!0,explodable:!0,reinforcable:!0}),t.RECHARGE_SEAM=new t({name:"recharge seam",matIndex:"67"}),t.POWER_PATH=new t({name:"power path all",floor:!0,matIndex:"60",selectable:!0}),t.POWER_PATH_SITE=new t({name:"power path site",floor:!0,matIndex:"61",selectable:!0}),t.POWER_PATH_BUILDING=new t({name:"power path",floor:!0,matIndex:"76"}),t.RUBBLE1=new t({name:"rubble 1",floor:!0,matIndex:"13",selectable:!0}),t.RUBBLE2=new t({name:"rubble 2",floor:!0,matIndex:"12",selectable:!0}),t.RUBBLE3=new t({name:"rubble 3",floor:!0,matIndex:"11",selectable:!0}),t.RUBBLE4=new t({name:"rubble 4",floor:!0,matIndex:"10",selectable:!0}),t}(),te=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ee=function(){function t(t,e,n){this.color=t,this.requiredTools=e,this.requiredSkills=n}return t.DRILL=new t(10526880,["drill"],[]),t.REINFORCE=new t(6332512,["hammer"],[]),t.BLOW=new t(10510432,[],["demolition"]),t.CLEAR_RUBBLE=new t(16777215,["shovel"],[]),t}(),ne=function(t){function e(e,n){var r=t.call(this,Pt.SURFACE)||this;return r.surface=n,r.workType=e,r}return te(e,t),e.prototype.isQualified=function(t){return t.hasTools(this.workType.requiredTools)&&t.hasSkills(this.workType.requiredSkills)},e.prototype.getPosition=function(){if(this.workType===ee.CLEAR_RUBBLE)return this.surface.getCenterWorld();var t=this.surface.getDigPositions()[0];return t.y=this.surface.terrain.worldMgr.getTerrainHeight(t.x,t.z),t},e.prototype.isInArea=function(t,e){if(this.workType===ee.CLEAR_RUBBLE)return t>=this.surface.x*bn+5&&t<this.surface.x*bn+bn+5&&e>=this.surface.y*bn+5&&e<this.surface.y*bn+bn+5;var n=this.getPosition();return n.sub(new i.Pa4(t,n.y,e)).length()<hn},e.prototype.onJobComplete=function(){switch(t.prototype.onJobComplete.call(this),this.workType){case ee.DRILL:this.surface.collapse();break;case ee.REINFORCE:this.surface.reinforce();break;case ee.CLEAR_RUBBLE:this.surface.reduceRubble()}},e}(xt),re=function(t){function e(e,n){var r=t.call(this,ee.BLOW,e)||this;return r.dynamite=n,r}return te(e,t),e.prototype.getPosition=function(){return this.dynamite.getPosition()},e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this),this.dynamite.ignite()},e}(ne),ie=function(t){function e(e,n){var r=t.call(this,ee.CLEAR_RUBBLE,e)||this;return r.placedItems=n,r}return te(e,t),e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this),this.placedItems.forEach((function(t){return t.worldMgr.sceneManager.scene.remove(t.group)})),this.surface.surfaceType=Qt.POWER_PATH,this.surface.updateTexture()},e}(ne),oe=function(){function t(t,e,n,r,i){var o=this;this.containedOres=0,this.containedCrystals=0,this.heightOffset=null,this.discovered=!1,this.selected=!1,this.reinforced=!1,this.jobs=[],this.surfaceRotation=0,this.seamLevel=0,this.fallinTimeout=null,this.fallinGrp=null,this.animationTimeout=null,this.wallType=null,this.geometry=null,this.mesh=null,this.needsMeshUpdate=!1,this.terrain=t,this.surfaceType=e,e!==Qt.CRYSTAL_SEAM&&e!==Qt.ORE_SEAM||(this.seamLevel=4),this.x=n,this.y=r,this.heightOffset=i,ht.registerEventListener(yt.eventKey,(function(t){if(t.job.type===Pt.SURFACE){var e=t.job;e.surface===o&&o.jobs.push(e)}}))}return t.prototype.hasJobType=function(t){return this.jobs.filter((function(e){return e.workType===t})).length>0},t.prototype.discoverNeighbors=function(){this.discovered||Zt.discoverSurface(this),this.discovered=!0,this.needsMeshUpdate=!0;var t=!1;if(this.surfaceType.floor)for(var e=this.x-1;e<=this.x+1;e++)for(var n=this.y-1;n<=this.y+1;n++)if(e!==this.x||n!==this.y){var r=this.terrain.getSurfaceOrNull(e,n);r&&!r.discovered&&(t=r.discoverNeighbors()||r.surfaceType.floor,r.needsMeshUpdate=!0)}return t},t.prototype.collapse=function(){var t=this;this.cancelJobs(),this.fallinTimeout&&clearTimeout(this.fallinTimeout),this.surfaceType=Qt.RUBBLE4,this.containedOres+=4,this.needsMeshUpdate=!0,this.discoverNeighbors()&&console.log("A new cave has been discovered");for(var e=this.x-1;e<=this.x+1;e++)for(var n=this.y-1;n<=this.y+1;n++)if(e!==this.x||n!==this.y){var r=this.terrain.getSurface(e,n);r.needsMeshUpdate=!0,r.isSupported()||r.collapse()}this.terrain.updateSurfaceMeshes(),this.terrain.floorGroup.updateWorldMatrix(!0,!0);for(var i=0;i<this.containedCrystals;i++){e=this.x*bn+bn/2+v()*y(bn/4);var o=this.y*bn+bn/2+v()*y(bn/4);this.terrain.worldMgr.addCollectable(new Yt,e,o)}this.dropContainedOre(this.containedOres-4),Zt.buildings.forEach((function(e){return e.group.position.y=t.terrain.worldMgr.getTerrainHeight(e.group.position.x,e.group.position.z)}))},t.prototype.dropContainedOre=function(t){for(var e=0;e<t&&this.containedOres>0;e++){this.containedOres--;var n=this.x*bn+bn/2+v()*y(bn/4),r=this.y*bn+bn/2+v()*y(bn/4);this.terrain.worldMgr.addCollectable(new Xt,n,r)}},t.prototype.cancelJobs=function(){var t=this.jobs;this.jobs=[],t.forEach((function(t){return ht.publishEvent(new vt(t))})),this.updateJobColor()},t.prototype.reduceRubble=function(){this.surfaceType===Qt.RUBBLE4?this.surfaceType=Qt.RUBBLE3:this.surfaceType===Qt.RUBBLE3?this.surfaceType=Qt.RUBBLE2:this.surfaceType===Qt.RUBBLE2?this.surfaceType=Qt.RUBBLE1:this.surfaceType===Qt.RUBBLE1&&(this.surfaceType=Qt.GROUND),this.dropContainedOre(1),this.updateTexture()},t.prototype.isSupported=function(){if(this.surfaceType.floor)return!0;var t=this.terrain.getSurface(this.x-1,this.y),e=this.terrain.getSurface(this.x-1,this.y-1),n=this.terrain.getSurface(this.x,this.y-1),r=this.terrain.getSurface(this.x+1,this.y-1),i=this.terrain.getSurface(this.x+1,this.y),o=this.terrain.getSurface(this.x+1,this.y+1),s=this.terrain.getSurface(this.x,this.y+1),a=this.terrain.getSurface(this.x-1,this.y+1);function l(t,e,n){return!(t.discovered&&e.discovered&&n.discovered&&(t.surfaceType.floor||e.surfaceType.floor||n.surfaceType.floor))}return l(t,e,n)||l(n,r,i)||l(i,o,s)||l(s,a,t)},t.prototype.updateMesh=function(t){if(void 0===t&&(t=!0),t||this.needsMeshUpdate){this.needsMeshUpdate=!1;var e=new i.Pa4(this.x,0,this.y),n=new i.Pa4(this.x+1,0,this.y),r=new i.Pa4(this.x,0,this.y+1),o=new i.Pa4(this.x+1,0,this.y+1),s=this.terrain.getSurface(this.x-1,this.y),a=this.terrain.getSurface(this.x-1,this.y-1),l=this.terrain.getSurface(this.x,this.y-1),c=this.terrain.getSurface(this.x+1,this.y-1),u=this.terrain.getSurface(this.x+1,this.y),h=this.terrain.getSurface(this.x+1,this.y+1),p=this.terrain.getSurface(this.x,this.y+1),f=this.terrain.getSurface(this.x-1,this.y+1);this.discovered?this.surfaceType.floor||(g(s,a,l)&&(e.y=1),g(l,c,u)&&(n.y=1),g(u,h,p)&&(o.y=1),g(p,f,s)&&(r.y=1)):(e.y=1,n.y=1,o.y=1,r.y=1);var d=e.y+n.y+o.y+r.y;d===qt.WALL&&e.y===o.y&&(d=qt.WEIRD_CREVICE),this.wallType!==d&&(this.wallType=d,this.updateGeometry(e,o,n,r,a,l,s,c,u,h,p,f),this.wallType!==qt.WALL&&this.cancelReinforceJobs()),this.updateTexture(),this.updateJobColor()}function g(t,e,n){return!(t.discovered&&e.discovered&&n.discovered&&(t.surfaceType.floor||e.surfaceType.floor||n.surfaceType.floor))}},t.prototype.cancelReinforceJobs=function(){this.jobs.filter((function(t){return t.workType===ee.REINFORCE})).forEach((function(t){return ht.publishEvent(new vt(t))})),this.jobs=this.jobs.filter((function(t){return t.workType!==ee.REINFORCE})),this.updateJobColor()},t.prototype.updateTexture=function(){var t=this.terrain.textureSet.texturebasename;this.discovered?this.surfaceType===Qt.POWER_PATH?t+=this.updatePowerPathTexture():this.surfaceType.shaping?this.wallType===qt.WEIRD_CREVICE?t+="77":(this.wallType===qt.CORNER?t+="5":this.wallType===qt.INVERTED_CORNER?t+="3":this.reinforced?t+="2":t+="0",t+=this.surfaceType.matIndex):t+=this.surfaceType.matIndex.toString():t+="70",t+=".bmp";var e=L.getTexture(t);e.flipY=!1,e.center.set(.5,.5),e.rotation=this.surfaceRotation,this.accessMaterials().forEach((function(t){return t.map=e}))},t.prototype.updatePowerPathTexture=function(){this.surfaceRotation=0;var t=this.terrain.getSurface(this.x-1,this.y).isPath(),e=this.terrain.getSurface(this.x,this.y-1).isPath(),n=this.terrain.getSurface(this.x+1,this.y).isPath(),r=this.terrain.getSurface(this.x,this.y+1).isPath(),i=(t?1:0)+(e?1:0)+(n?1:0)+(r?1:0);return 0===i||1===i?(t&&(this.surfaceRotation=Math.PI/2),e&&(this.surfaceRotation=Math.PI),n&&(this.surfaceRotation=-Math.PI/2),"65"):2===i?t===n?(this.surfaceRotation=t?Math.PI/2:0,"62"):(t&&r&&(this.surfaceRotation=Math.PI/2),t&&e&&(this.surfaceRotation=Math.PI),e&&n&&(this.surfaceRotation=-Math.PI/2),"63"):3===i?(e||(this.surfaceRotation=Math.PI/2),n||(this.surfaceRotation=Math.PI),r||(this.surfaceRotation=-Math.PI/2),"64"):"60"},t.prototype.accessMaterials=function(){return this.mesh&&this.mesh.material?Array.isArray(this.mesh.material)?this.mesh.material:[this.mesh.material]:[]},t.prototype.updateGeometry=function(t,e,n,r,o,s,a,l,c,u,h,p){var f=0;!t.y||e.y||this.wallType!==qt.INVERTED_CORNER&&(this.wallType===qt.WALL||this.wallType===qt.WEIRD_CREVICE)!==Boolean(n.y)||(f=0),!n.y||r.y||this.wallType!==qt.INVERTED_CORNER&&(this.wallType===qt.WALL||this.wallType===qt.WEIRD_CREVICE)!==Boolean(e.y)||(f=3),!e.y||t.y||this.wallType!==qt.INVERTED_CORNER&&(this.wallType===qt.WALL||this.wallType===qt.WEIRD_CREVICE)!==Boolean(r.y)||(f=2),!r.y||n.y||this.wallType!==qt.INVERTED_CORNER&&(this.wallType===qt.WALL||this.wallType===qt.WEIRD_CREVICE)!==Boolean(t.y)||(f=1),this.wallType!==qt.WALL&&this.wallType!==qt.WEIRD_CREVICE||(t.y&&e.y&&(f=0),n.y&&r.y&&(f=3)),this.mesh&&this.terrain.floorGroup.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.geometry=new i.ZXM,this.geometry.vertices.push(t,n,e,r);var d=[new i.FM8(0,0),new i.FM8(1,0),new i.FM8(1,1),new i.FM8(0,1)];function g(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=0,r=0;return t.map((function(t){return t.heightOffset})).filter(Boolean).forEach((function(t){n+=t,r++})),n/r}n.y===r.y&&(this.wallType!==qt.WALL&&this.wallType!==qt.WEIRD_CREVICE||n.y&&r.y)?(this.geometry.faceVertexUvs[0].push([d[(0+f)%4],d[(3+f)%4],d[(2+f)%4]]),this.geometry.faceVertexUvs[0].push([d[(0+f)%4],d[(2+f)%4],d[(1+f)%4]]),this.geometry.faces.push(new i.G_f(0,3,2),new i.G_f(0,2,1))):(this.geometry.faceVertexUvs[0].push([d[(1+f)%4],d[(3+f)%4],d[(2+f)%4]]),this.geometry.faceVertexUvs[0].push([d[(1+f)%4],d[(0+f)%4],d[(3+f)%4]]),this.geometry.faces.push(new i.G_f(1,3,2),new i.G_f(1,0,3))),t.y+=g(o,s,this,a)*vn,n.y+=g(s,l,c,this)*vn,e.y+=g(this,c,u,h)*vn,r.y+=g(a,this,h,p)*vn,this.geometry.computeFaceNormals(),this.geometry.computeVertexNormals(),this.mesh=new i.Kj0(this.geometry,new i.xoR({shininess:0})),this.mesh.userData={selectable:this},this.terrain.floorGroup.add(this.mesh),this.terrain.floorGroup.updateWorldMatrix(!0,!0)},t.prototype.getSelectionType=function(){return k.SURFACE},t.prototype.select=function(){return this.surfaceType.selectable&&this.wallType!==qt.INVERTED_CORNER&&this.wallType!==qt.WEIRD_CREVICE&&!this.selected?(this.selected=!0,this.accessMaterials().forEach((function(t){return t.color.setHex(6316192)})),ht.publishEvent(new Dt(this)),this):null},t.prototype.deselect=function(){this.selected&&(this.selected=!1,this.updateJobColor())},t.prototype.getSelectionCenter=function(){return null},t.prototype.updateJobColor=function(){var t=16777215;this.jobs.forEach((function(e){return t=e.workType.color})),this.accessMaterials().forEach((function(e){return e.color.setHex(t)}))},t.prototype.hasRubble=function(){return this.surfaceType===Qt.RUBBLE1||this.surfaceType===Qt.RUBBLE2||this.surfaceType===Qt.RUBBLE3||this.surfaceType===Qt.RUBBLE4},t.prototype.isPath=function(){return this.surfaceType===Qt.POWER_PATH||this.surfaceType===Qt.POWER_PATH_BUILDING},t.prototype.isWalkable=function(){return this.surfaceType.floor&&this.surfaceType!==Qt.LAVA&&this.surfaceType!==Qt.WATER},t.prototype.isDrillable=function(){return this.surfaceType.drillable&&(this.wallType===qt.WALL||this.wallType===qt.CORNER)},t.prototype.isReinforcable=function(){return this.surfaceType.reinforcable&&this.wallType===qt.WALL&&!this.reinforced},t.prototype.isExplodable=function(){return this.surfaceType.explodable&&(this.wallType===qt.WALL||this.wallType===qt.CORNER)},t.prototype.isDigable=function(){return this.isDrillable()||this.isExplodable()},t.prototype.getDigPositions=function(){var t=[];return this.terrain.getSurface(this.x-1,this.y).surfaceType.floor&&t.push(new i.Pa4(this.x*bn,0,this.y*bn+bn/2)),this.terrain.getSurface(this.x,this.y-1).surfaceType.floor&&t.push(new i.Pa4(this.x*bn+bn/2,0,this.y*bn)),this.terrain.getSurface(this.x+1,this.y).surfaceType.floor&&t.push(new i.Pa4(this.x*bn+bn,0,this.y*bn+bn/2)),this.terrain.getSurface(this.x,this.y+1).surfaceType.floor&&t.push(new i.Pa4(this.x*bn+bn/2,0,this.y*bn+bn)),t},t.prototype.reinforce=function(){this.reinforced=!0,this.cancelReinforceJobs(),this.fallinTimeout&&clearTimeout(this.fallinTimeout),this.updateTexture()},t.prototype.getCenterWorld=function(){var t=new i.Pa4(this.x*bn+bn/2,0,this.y*bn+bn/2);return t.y=this.terrain.worldMgr.getTerrainHeight(t.x,t.z),t},t.prototype.setFallinLevel=function(t){var e,n;t<1||(this.surfaceType.floor?(e=this.terrain.findFallInOrigin(this.x,this.y),n=[this.x,this.y]):(e=[this.x,this.y],n=this.terrain.findFallInTarget(this.x,this.y)),e&&n&&this.terrain.getSurface(e[0],e[1]).scheduleFallin(n[0],n[1]))},t.prototype.scheduleFallin=function(t,e){var n=this;this.fallinTimeout=setTimeout((function(){n.createFallin(t,e),n.scheduleFallin(t,e)}),1e3*(60+y(120)))},t.prototype.createFallin=function(t,e){var n=this;console.log("there was a fallin");var r=L.getResource("MiscAnims/RockFall/Rock3Sides.lws"),o=new S("MiscAnims/RockFall/").parse(r);this.fallinGrp=new i.ZAu,this.fallinGrp.position.copy(this.terrain.getSurface(t,e).getCenterWorld());var s=this.x-t,a=e-this.y;this.fallinGrp.rotateOnAxis(new i.Pa4(0,1,0),Math.atan2(a,s)+Math.PI/2),this.terrain.worldMgr.sceneManager.scene.add(this.fallinGrp);var l=[];o.bodies.forEach((function(t){var e=t.model.clone(!0);l.push(e)})),o.bodies.forEach((function(t,e){var r=l[e],i=t.parentObjInd;null!=i?l[i].add(r):n.fallinGrp.add(r)})),this.animate(l,o,0);var c=this.terrain.getSurface(t,e);c.surfaceType=Qt.RUBBLE4,c.updateTexture()},t.prototype.animate=function(t,e,n){if(t.length!==e.bodies.length)throw"Cannot animate poly. Length differs from bodies length";if(e.bodies.forEach((function(e,r){var i=t[r];if(i.position.copy(e.relPos[n]),i.rotation.copy(e.relRot[n]),i.scale.copy(e.relScale[n]),i.hasOwnProperty("material")){var o=i.material,s=e.opacity[n];o&&void 0!==s&&(Array.isArray(o)?o:[o]).forEach((function(t){t.opacity=s,t.transparent=!0,t.alphaTest=0}))}})),this.animationTimeout=null,n+1>e.lastFrame&&!e.looping)this.terrain.worldMgr.sceneManager.scene.remove(this.fallinGrp),this.fallinGrp=null;else{var r=n+1;r>e.lastFrame&&(r=e.firstFrame);var i=this;this.animationTimeout=setTimeout((function(){return i.animate(t,e,r)}),1e3/e.framesPerSecond*e.transcoef)}},t}();!function(t){t[t.CORNER=1]="CORNER",t[t.WALL=2]="WALL",t[t.INVERTED_CORNER=3]="INVERTED_CORNER",t[t.WEIRD_CREVICE=20]="WEIRD_CREVICE"}(qt||(qt={}));var se,ae,le=function(){function t(t){var e=this;this.textureSet={},this.width=0,this.height=0,this.surfaces=[],this.floorGroup=new i.ZAu,this.roofGroup=new i.ZAu,this.worldMgr=t,this.floorGroup.scale.set(bn,bn,bn),this.roofGroup.visible=!1,ht.registerEventListener(Et.eventKey,(function(t){t.type===ct.BUILDING&&t.entity.surfaces.forEach((function(t){for(var n=-1;n<=1;n++)for(var r=-1;r<=1;r++)e.getSurface(t.x+n,t.y+r).updateTexture()}))}))}return t.prototype.getSurfaceFromWorld=function(t){return this.getSurface(t.x/bn,t.z/bn)},t.prototype.getSurface=function(t,e){return t=Math.floor(t),e=Math.floor(e),this.getSurfaceOrNull(t,e)||new oe(this,Qt.SOLID_ROCK,t,e,0)},t.prototype.getSurfaceOrNull=function(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height?this.surfaces[t][e]:null},t.prototype.updateSurfaceMeshes=function(t){void 0===t&&(t=!1),this.surfaces.forEach((function(e){return e.forEach((function(e){return e.updateMesh(t)}))})),this.floorGroup.updateWorldMatrix(!0,!0)},t.prototype.findFallInOrigin=function(t,e){var n=this.getSurface(t-1,e);if(n.isReinforcable())return[n.x,n.y];var r=this.getSurface(t,e-1);if(r.isReinforcable())return[r.x,r.y];var i=this.getSurface(t+1,e);if(i.isReinforcable())return[i.x,i.y];var o=this.getSurface(t,e+1);if(o.isReinforcable())return[o.x,o.y];var s=this.getSurface(t-1,e);if(s.isDigable())return[s.x,s.y];var a=this.getSurface(t,e-1);if(a.isDigable())return[a.x,a.y];var l=this.getSurface(t+1,e);if(l.isDigable())return[l.x,l.y];var c=this.getSurface(t,e+1);return c.isDigable()?[c.x,c.y]:null},t.prototype.findFallInTarget=function(t,e){var n=this.getSurface(t-1,e);if(n.isWalkable())return[n.x,n.y];var r=this.getSurface(t,e-1);if(r.isWalkable())return[r.x,r.y];var i=this.getSurface(t+1,e);if(i.isWalkable())return[i.x,i.y];var o=this.getSurface(t,e+1);return o.isWalkable()?[o.x,o.y]:null},t}(),ce=function(){function t(){}return t.loadTerrain=function(t,e){var n=Number(p(t,"BlockSize"));n!==bn&&console.error("Unexpected tile size in level configuration: "+n);var r=new le(e),i=t.TextureSet[1];r.textureSet=L.cfg("Textures",i);var o=L.getMap(p(t,"TerrainMap"));r.width=o.width,r.height=o.height;for(var s=L.getMap(p(t,"PathMap")),a=L.getMap(p(t,"SurfaceMap")).level,l=L.getMap(p(t,"PreDugMap")).level,c=L.getMap(p(t,"CryOreMap")).level,u=L.getMap(p(t,"FallinMap")),h=L.getMap(p(t,"ErodeMap")),f=0;f<o.level.length;f++)for(var d=0;d<o.level[f].length;d++){r.surfaces[d]=r.surfaces[d]||[];var g=o.level[f][d],y=Qt.getByNum(g),v=l[f][d];v===ae.CAVERN_EXPOSED?y===Qt.GROUND||y===Qt.DIRT?y=Qt.GROUND:y!==Qt.WATER&&y!==Qt.LAVA&&console.warn("Unexpected cavern surface type: "+y.name):v===ae.SLUG_HOLE_EXPOSED||v===ae.SLUG_HOLE_HIDDEN?y=Qt.SLUG_HOLE:v!==ae.WALL&&v!==ae.CAVERN_HIDDEN&&console.warn("Unexpected predug level: "+v);var m=s&&y.floor?s.level[f][d]:se.NONE;m===se.RUBBLE?y=Qt.RUBBLE4:m===se.POWER_PATH?y=Qt.POWER_PATH:m!==se.NONE&&console.warn("Unexpected path map level: "+m);var w=new oe(r,y,d,f,a[f][d]),b=c[f][d];b%2==1?w.containedCrystals=(b+1)/2:w.containedOres=b/2,r.surfaces[d].push(w)}if(r.surfaces.forEach((function(t){return t.forEach((function(t){if(l[t.y][t.x]===ae.CAVERN_EXPOSED||l[t.y][t.x]===ae.SLUG_HOLE_EXPOSED)for(var e=t.x-1;e<=t.x+1;e++)for(var n=t.y-1;n<=t.y+1;n++)r.getSurfaceOrNull(e,n).discovered=!0}))})),r.surfaces.forEach((function(t){return t.forEach((function(t){var e=r.getSurfaceOrNull(t.x,t.y);l[t.y][t.x]!==ae.CAVERN_HIDDEN||e.discovered||(e.surfaceType=Qt.GROUND)}))})),r.surfaces.forEach((function(t){return t.forEach((function(t){t.isSupported()||t.collapse()}))})),r.updateSurfaceMeshes(!0),u)for(var I=0;I<r.width;I++)for(var E=0;E<r.height;E++)r.getSurface(I,E).setFallinLevel(u.level[E][I]);return h&&console.warn("Lucky you! Lava erosion not yet implemented"),r},t}();!function(t){t[t.NONE=0]="NONE",t[t.RUBBLE=1]="RUBBLE",t[t.POWER_PATH=2]="POWER_PATH"}(se||(se={})),function(t){t[t.WALL=0]="WALL",t[t.CAVERN_EXPOSED=1]="CAVERN_EXPOSED",t[t.CAVERN_HIDDEN=2]="CAVERN_HIDDEN",t[t.SLUG_HOLE_EXPOSED=3]="SLUG_HOLE_EXPOSED",t[t.SLUG_HOLE_HIDDEN=4]="SLUG_HOLE_HIDDEN"}(ae||(ae={}));var ue,he=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),pe=function(t){function e(e,n){var r=t.call(this,e)||this;return r.speed=n,r}return he(e,t),e.prototype.getPosition=function(){return(new i.Pa4).copy(this.group.position)},e.prototype.getSpeed=function(){return this.speed},e.prototype.moveToTarget=function(t){t.y=this.worldMgr.getTerrainHeight(t.x,t.z),this.isOnRubble()?this.changeActivity(ue.MOVING_RUBBLE):this.changeActivity(ue.MOVING);var e=(new i.Pa4).copy(t).sub(this.getPosition());e.length()>this.getSpeed()&&e.setLength(this.getSpeed()),this.group.position.add(e),this.group.position.y=this.worldMgr.getTerrainHeight(this.group.position.x,this.group.position.z),this.group.lookAt(new i.Pa4(t.x,this.group.position.y,t.z))},e.prototype.isOnRubble=function(){return!1},e.prototype.changeActivity=function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=1)},e}(Ht),fe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),de=i.M8C.degToRad,ge=function(t){function e(e,n,r){var i=t.call(this,L.getAnimationEntityType(n),r)||this;return i.workInterval=null,i.job=null,i.activity=null,i.jobSubPos=null,i.tools=[],i.skills=[],i.carries=null,i.carryTarget=null,i.selectionType=e,i.group.userData={selectable:i},i.workInterval=setInterval(i.work.bind(i),1e3/In),i}return fe(e,t),e.prototype.work=function(){var t=this;if(this.job&&!this.selected)if(this.job.type===Pt.SURFACE){var e=this.job,n=e.workType;if(n===ee.DRILL)this.job.isInArea(this.group.position.x,this.group.position.z)?this.changeActivity(ue.DRILLING,(function(){if(e.surface.seamLevel>0){e.surface.seamLevel--;var n=(new i.Pa4).copy(t.getPosition()).sub(e.surface.getCenterWorld()).multiplyScalar(.3+y(3)/10).applyAxisAngle(new i.Pa4(0,1,0),de(-10+y(20))).add(t.getPosition());e.surface.surfaceType===Qt.CRYSTAL_SEAM?t.worldMgr.addCollectable(new Yt,n.x,n.z):e.surface.surfaceType===Qt.ORE_SEAM&&t.worldMgr.addCollectable(new Xt,n.x,n.z),t.changeActivity(ue.STANDING)}else t.job.onJobComplete(),t.stopJob()})):this.moveToTarget(this.job.getPosition());else if(n===ee.CLEAR_RUBBLE)if(this.job.isInArea(this.group.position.x,this.group.position.z)){if(!this.jobSubPos){var r=this.job.getPosition();this.jobSubPos=new i.Pa4(r.x+v()*y(10),0,r.z+v()*y(10)),this.jobSubPos.y=this.worldMgr.getTerrainHeight(this.jobSubPos.x,this.jobSubPos.z)}(new i.Pa4).copy(this.jobSubPos).sub(this.getPosition()).length()>this.getSpeed()?this.moveToTarget(this.jobSubPos):this.changeActivity(ue.SHOVELING,(function(){t.job.onJobComplete(),e.surface.hasRubble()?t.jobSubPos=null:t.stopJob()}))}else this.moveToTarget(this.job.getPosition());else if(n===ee.REINFORCE)this.job.isInArea(this.group.position.x,this.group.position.z)?this.changeActivity(ue.REINFORCE,(function(){t.job.onJobComplete(),t.stopJob()}),3):this.moveToTarget(this.job.getPosition());else if(n===ee.BLOW){var o=this.job;this.carries!==o.dynamite?(this.dropItem(),this.job.isInArea(this.group.position.x,this.group.position.z)?this.changeActivity(ue.PICKING,(function(){t.pickupItem(o.dynamite)})):this.moveToTarget(this.job.getPosition())):this.carryTarget?this.getPosition().sub(this.carryTarget).length()>hn?this.moveToTarget(this.carryTarget):this.changeActivity(ue.DROPPING,(function(){t.dropItem(),t.job.onJobComplete(),t.stopJob()})):this.carryTarget=o.surface.getDigPositions()[0]}}else if(this.job.type===Pt.CARRY){var s=this.job;this.carries!==s.item?(this.dropItem(),this.job.isInArea(this.group.position.x,this.group.position.z)?this.changeActivity(ue.PICKING,(function(){t.pickupItem(s.item)})):this.moveToTarget(this.job.getPosition())):this.carryTarget?this.getPosition().sub(this.carryTarget).length()>hn?this.moveToTarget(this.carryTarget):this.changeActivity(ue.DROPPING,(function(){t.dropItem(),t.job.onJobComplete(),t.stopJob()})):this.carryTarget=this.carries.getTargetPos()}else this.job.type===Pt.MOVE&&(this.job.isInArea(this.group.position.x,this.group.position.z)?this.changeActivity(ue.STANDING,(function(){t.job.onJobComplete(),t.stopJob()})):this.moveToTarget(this.job.getPosition()))},e.prototype.dropItem=function(){this.carries&&(this.carryJoint&&this.carryJoint.remove(this.carries.group),this.carries.group.position.copy(this.group.position),this.carries=null,this.carryTarget=null)},e.prototype.pickupItem=function(t){this.carries=t,this.carryJoint&&this.carryJoint.add(this.carries.group),this.carries.group.position.set(0,0,0)},e.prototype.setJob=function(t){this.job!==t&&this.stopJob(),t.type===Pt.SURFACE&&this.dropItem(),this.job=t,this.job&&this.job.assign(this)},e.prototype.stopJob=function(){this.job&&(this.job.unassign(this),this.jobSubPos=null,this.carryTarget=null,this.job=null,this.changeActivity(ue.STANDING))},e.prototype.hasTools=function(t){for(var e=0;e<t.length;e++)if(-1===this.tools.indexOf(t[e]))return!1;return!0},e.prototype.hasSkills=function(t){for(var e=0;e<t.length;e++)if(-1===this.skills.indexOf(t[e]))return!1;return!0},e.prototype.getSelectionType=function(){return this.selectionType},e.prototype.deselect=function(){this.selectionFrame.visible=!1,this.selected=!1},e.prototype.select=function(){return this.selectionFrame.visible=!0,this.selected?null:(this.selected=!0,this.onSelect(),this)},e.prototype.onSelect=function(){},e}(pe);!function(t){t[t.STANDING=0]="STANDING",t[t.MOVING=1]="MOVING",t[t.MOVING_RUBBLE=2]="MOVING_RUBBLE",t[t.DRILLING=3]="DRILLING",t[t.SHOVELING=4]="SHOVELING",t[t.PICKING=5]="PICKING",t[t.DROPPING=6]="DROPPING",t[t.REINFORCE=7]="REINFORCE"}(ue||(ue={}));var ye=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ve=function(t){function e(){var e=t.call(this,k.PILOT,"mini-figures/pilot/pilot.ae",fn)||this;return e.tools=["drill","shovel","hammer"],e.skills=["demolition"],e.pickSphereRadius=10,e.selectionFrameSize=10,e}return ye(e,t),e.prototype.isOnRubble=function(){return this.worldMgr.sceneManager.terrain.getSurfaceFromWorld(this.group.position).hasRubble()},e.prototype.getSpeed=function(){var e=t.prototype.getSpeed.call(this);return this.animation&&!isNaN(this.animation.transcoef)&&(e*=this.animation.transcoef),this.isOnPath()&&(e*=2),e},e.prototype.isOnPath=function(){return this.worldMgr.sceneManager.terrain.getSurfaceFromWorld(this.group.position).isPath()},e.prototype.changeActivity=function(t,e,n){if(void 0===e&&(e=null),void 0===n&&(n=1),e&&e.bind(this),this.activity!==t){switch(this.activity=t,this.activity){case ue.STANDING:this.carries?this.setActivity("StandCarry",e,n):this.setActivity("Stand",e,n);break;case ue.MOVING:this.carries?this.setActivity("Carry",e,n):this.setActivity("Run",e,n);break;case ue.MOVING_RUBBLE:this.carries?this.setActivity("Carryrubble",e,n):this.setActivity("Routerubble",e,n);break;case ue.DRILLING:this.setActivity("Drill",e,n);break;case ue.SHOVELING:this.setActivity("ClearRubble",e,n);break;case ue.PICKING:this.setActivity("Pickup",e,n);break;case ue.DROPPING:this.setActivity("Place",e,n);break;case ue.REINFORCE:this.setActivity("Reinforce",e,n)}this.animation.looping=!0}},e.prototype.onDiscover=function(){t.prototype.onDiscover.call(this);var e=Zt.raidersUndiscovered.indexOf(this);-1!==e&&Zt.raidersUndiscovered.splice(e,1),Zt.raiders.push(this),ht.publishEvent(new Et(ct.RAIDER,this))},e.prototype.onSelect=function(){this.changeActivity(ue.STANDING),ht.publishEvent(new Ft(this))},e.prototype.getSelectionCenter=function(){return this.pickSphere?(new i.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null},e}(ge),me=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),we=i.M8C.degToRad,be=function(t){function e(e){var n=t.call(this,L.getAnimationEntityType(e.aeFile))||this;return n.powerSwitch=!0,n.powerLink=!1,n.spawning=!1,n.surfaces=[],n.type=e,n.group.userData={selectable:n},n.pickSphereRadius=30,n.selectionFrameSize=15,n}return me(e,t),e.prototype.getSelectionType=function(){return k.BUILDING},e.prototype.select=function(){return this.selectionFrame.visible=!0,this.selected?null:(this.selected=!0,ht.publishEvent(new jt(this)),this)},e.prototype.deselect=function(){this.selectionFrame.visible=!1,this.selected=!1},e.prototype.getSelectionCenter=function(){return this.pickSphere?(new i.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null},e.prototype.getDropPosition=function(){var t=this.getPosition().add(new i.Pa4(0,0,this.type.dropPosDist).applyEuler(this.getRotation()).applyAxisAngle(new i.Pa4(0,1,0),we(this.type.dropPosAngleDeg)));return t.y=this.worldMgr.getTerrainHeight(t.x,t.z),t},e.prototype.isPowered=function(){return this.powerSwitch&&(this.type.selfPowered||this.powerLink)},e.prototype.onDiscover=function(){t.prototype.onDiscover.call(this);var e=Zt.buildingsUndiscovered.indexOf(this);-1!==e&&Zt.buildingsUndiscovered.splice(e,1),Zt.buildings.push(this),ht.publishEvent(new Et(ct.BUILDING,this))},e}(Ht),Ie=i.M8C.degToRad,Ee=function(){function t(){}return t.loadObjectList=function(t,e){Object.values(e).forEach((function(e){var n=e.type?e.type.toLowerCase():e.type,r=(e.xPos-1)*bn,o=(e.yPos-1)*bn,s=t.getTerrainHeight(r,o),a=L.cfg("BuildingTypes",e.type),l=Ie(e.heading);if(n==="TVCamera".toLowerCase()){var c=new i.Pa4(r,s,o-bn/2),u=new i.Pa4(5*bn,0,0).applyAxisAngle(new i.Pa4(0,1,0),l-Math.PI/16).add(c);t.sceneManager.camera.position.copy(u),t.sceneManager.camera.position.y=4.5*bn,t.sceneManager.controls.target.copy(c),t.sceneManager.controls.update(),t.setTorchPosition(c)}else if(n==="Pilot".toLowerCase()){var h=new ve;h.worldMgr=t,h.setActivity("Stand"),h.createPickSphere(),h.group.position.set(r,s,o),h.group.rotateOnAxis(new i.Pa4(0,1,0),l-Math.PI/2),h.group.visible=t.sceneManager.terrain.getSurfaceFromWorld(h.group.position).discovered,h.group.visible?(Zt.raiders.push(h),ht.publishEvent(new Et(ct.RAIDER,h))):Zt.raidersUndiscovered.push(h),t.sceneManager.scene.add(h.group)}else if(a){var p=lt.getByName(a),f=new be(p);f.worldMgr=t,f.setActivity("Stand"),f.createPickSphere(),f.group.position.set(r,s,o),f.group.rotateOnAxis(new i.Pa4(0,1,0),-l-Math.PI),f.group.visible=t.sceneManager.terrain.getSurfaceFromWorld(f.group.position).discovered,f.group.visible?(Zt.buildings.push(f),ht.publishEvent(new Et(ct.BUILDING,f))):Zt.buildingsUndiscovered.push(f),t.sceneManager.scene.add(f.group);var d=t.sceneManager.terrain.getSurfaceFromWorld(f.group.position);d.surfaceType=Qt.POWER_PATH_BUILDING,d.updateTexture(),f.surfaces.push(d);var g=new i.Pa4(0,0,bn).applyAxisAngle(new i.Pa4(0,1,0),-l-Math.PI);g.add(f.group.position);var y=t.sceneManager.terrain.getSurfaceFromWorld(g);y.surfaceType=Qt.POWER_PATH_BUILDING,y.updateTexture(),f.surfaces.push(y)}else n==="PowerCrystal".toLowerCase()?t.addCollectable(new Yt,r,o):console.warn("Object type "+e.type+" not yet implemented")})),Zt.buildings.forEach((function(e){return e.surfaces.forEach((function(e){for(var n=-1;n<=1;n++)for(var r=-1;r<=1;r++)t.sceneManager.terrain.getSurface(e.x+n,e.y+r).updateTexture()}))}))},t}(),Te=function(){function t(t){void 0===t&&(t=!1),this.debug=!1,this.onLevelComplete=null,this.registers=new Array(8).fill(0),this.timers=new Array(4).fill(0),this.scriptLines=[],this.statements=[],this.macrosByName={},this.labelsByName={},this.halted=!1,this.programCounter=0,this.messages=[],this.messagePermit=null,this.debug=t}return t.prototype.checkRegister=function(t){var e=parseInt(t);if(isNaN(e)||e<0||e>this.registers.length)throw new Error("Invalid register ("+t+") provided");return e},t.prototype.checkRegisterValue=function(t){var e=parseInt(t);if(isNaN(e))throw new Error("Invalid register value ("+t+") provided");return e},t.prototype.getR=function(t){return t=this.checkRegister(t),this.registers[t]},t.prototype.setR=function(t,e){t=this.checkRegister(t),e=this.checkRegisterValue(e),this.registers[t]=e},t.prototype.addR=function(t,e){t=this.checkRegister(t),e=this.checkRegisterValue(e),this.registers[t]+=e},t.prototype.setTimer=function(t,e){var n=parseInt(e);if(isNaN(n))throw new Error("Can't set timer to NaN value: "+e);this.timers[t]=(new Date).getTime()+n},t.prototype.getTimer=function(t){return(new Date).getTime()-this.timers[t]},t.prototype.setLevelCompleted=function(){this.halted=!0,Zt.resultState=Nt.COMPLETE,this.onLevelComplete()},t.prototype.setLevelFail=function(){this.halted=!0,Zt.resultState=Nt.FAILED,this.onLevelComplete()},t.prototype.setTutorialFlags=function(t){},t.prototype.setMessagePermit=function(t){this.messagePermit=!t},t.prototype.setBuildingsUpgradeLevel=function(t,e){console.error("Buildings upgrade level not yet implemented")},t.prototype.setToolStoreLevel=function(t){this.setBuildingsUpgradeLevel(lt.TOOLSTATION,t)},t.prototype.setTeleportPadLevel=function(t){this.setBuildingsUpgradeLevel(lt.TELEPORT_PAD,t)},t.prototype.setPowerStationLevel=function(t){this.setBuildingsUpgradeLevel(lt.POWER_STATION,t)},t.prototype.setBarracksLevel=function(t){this.setBuildingsUpgradeLevel(lt.SUPPORT,t)},t.prototype.getToolStoresBuilt=function(){return Zt.getBuildingsByType(lt.TOOLSTATION).length},t.prototype.getMinifiguresOnLevel=function(){return Zt.raiders.length},t.prototype.getCrystalsCurrentlyStored=function(){return Zt.numCrystal},t.prototype.getObjectiveSwitch=function(){return 0},t.prototype.setMessageTimerValues=function(t,e,n){},t.prototype.getMessageTimer=function(){return 0},t.prototype.cameraUnlock=function(){},t.prototype.setMessage=function(t,e){if(this.messagePermit){var n=this.messages[t];console.log(n.txt)}},t.prototype.setCameraGotoTutorial=function(t){},t.prototype.getTutorialBlockIsGround=function(t){return 0},t.prototype.getTutorialBlockIsPath=function(t){return 0},t.prototype.getOxygenLevel=function(){return 100},t.prototype.getObjectiveShowing=function(){return!1},t.prototype.addPoweredCrystals=function(){},t.prototype.disallowAll=function(){},t.prototype.getPoweredPowerStationsBuilt=function(){return Zt.getBuildingsByType(lt.POWER_STATION).filter((function(t){return t.isPowered()})).length},t.prototype.getPoweredBarracksBuilt=function(){return Zt.getBuildingsByType(lt.SUPPORT).filter((function(t){return t.isPowered()})).length},t.prototype.getRecordObjectAtTutorial=function(){},t.prototype.getHiddenObjectsFound=function(){return 0},t.prototype.callMethod=function(t,e){if("Stop"===t)throw"Stop";if("TRUE"===t)return!0;if("FALSE"===t)return!1;var n=t.match(/^SetR([0-7])$/);if(n)return this.setR(n[1],e[0]);var r=t.match(/^AddR([0-7])$/);if(r)return this.addR(r[1],e[0]);var i=t.match(/^GetR([0-7])$/);if(i)return this.getR(i[1]);var o=t.match(/^SetTimer([0-3])$/);if(o)return this.setTimer(o[1],e[0]);var s=t.match(/^GetTimer([0-3])$/);if(s)return this.getTimer(s[1]);var a=t.toLowerCase();for(var l in this)if(l.toLowerCase()===a)return this[l].apply(this,e);throw new Error("Undefined method: "+t)},t.prototype.conditional=function(t,e){var n=this.executeStatement(t);this.debug&&console.log("Condition evaluated to "+n),n&&this.executeStatement(e)},t.prototype.executeStatement=function(t){var e=this;if(t.invoke){var n="conditional"!==t.invoke?t.args.map((function(t){return e.executeStatement(t)})):t.args,r=this.callMethod(t.invoke,n);return void 0!==r&&this.debug&&console.log("Method returned: "+r),r}if(t.comparator){var i=this.executeStatement(t.left),o=this.executeStatement(t.right);if("="===t.comparator)return i===o;if("!="===t.comparator)return i!==o;if("<"===t.comparator)return i<o;if(">"===t.comparator)return i>o;throw console.log(t),new Error("Unknown comparator: "+t.comparator)}if(!isNaN(t))return t;if(!t.jump)throw console.log(t),new Error("Unknown expression in line "+this.programCounter+": "+t);if(this.programCounter=this.labelsByName[t.jump],void 0===this.programCounter)throw new Error("Label '"+t.jump+"' is unknown!");this.debug&&console.log("Jumping to label '"+t.jump+"' in line "+this.programCounter)},t.prototype.execute=function(t){if(void 0===t&&(t=!1),this.debug=t,!this.halted)try{for(this.debug&&(console.log("Executing following script\n"+this.scriptLines.join("\n")),console.log("Registers: "+this.registers)),this.programCounter=0;this.programCounter<this.statements.length;this.programCounter++){var e=this.statements[this.programCounter];this.debug&&(console.log(this.programCounter+": "+this.scriptLines[this.programCounter]),console.log(e)),e.label||this.executeStatement(e)}}catch(t){if("Stop"===t)return;console.error(t),console.error("FATAL ERROR! Script execution failed! You can NOT win anymore!"),this.halted=!0}},t}(),Pe=function(){function t(){}return t.parse=function(e){for(var n=new Te,r=e.split("\n").map((function(t){return t.split("//")[0].trim().split(";")[0].trim().replace(/_/g,"").replace(/\bTRUE \? /,"").replace(/[{}]/g,"")})),i=0;i<r.length;i++)if(!((f=r[i]).length<1))if(f.startsWith("#include ")){var o=f.replace(/^#include /,"").trim().slice(1,-1);if("nerpdef.h"===o)continue;var s=t.parse(L.getResource("Levels/"+o));if(!s||!s.scriptLines||s.scriptLines.length<1)throw"Can't include unknown nerp script: "+f;n.scriptLines=n.scriptLines.concat(s.scriptLines),n.macrosByName=Object.assign({},n.macrosByName,s.macrosByName)}else if(f.startsWith("#define ")){for(var a=f.replace(/^#define /,"").split(" "),l=[a.splice(1).join(" ").replace(/\\$/,"").trim()],c=f,u=!1;c.endsWith("\\")&&i<r.length-1;){var h=(c=r[++i].trim()).replace(/\\$/,"").trim();h.length>0&&(u?(u=!1,l[l.length-1]+=h):l.push(h)),c.match(/:\\$/)&&(u=!0)}var p=a[0].split("(");n.macrosByName[p[0]]={args:p[1].replace(/\)$/,"").split(","),lines:l}}else n.scriptLines=n.scriptLines.concat(this.replaceMacros(n.macrosByName,f));for(i=0;i<n.scriptLines.length;i++){var f=n.scriptLines[i];n.statements[i]=f.replace(/\(\)/g,"").split(" ? ");var d=f.match(/(\S+):/);if(2===n.statements[i].length)n.statements[i]={invoke:"conditional",args:[this.preProcess(n.statements[i][0]),this.preProcess(n.statements[i][1])]};else if(d){var g=d[1].toLowerCase();n.labelsByName[g]=i,n.statements[i]={label:g}}else{if(1!==n.statements[i].length)throw"Can't deal with line: "+f;n.statements[i]=this.preProcess(n.statements[i][0])}}return n},t.replaceMacros=function(t,e){var n=this,r=e.split("("),i=t[r[0]];if(i){var o=r.splice(1).join("(").slice(0,-1).split(",");if(o.length!==i.args.length)throw"Invalid number of args provided for macro in line "+e;var s=[];return i.lines.forEach((function(e){for(var r=0;r<o.length;r++)e=e.replace(new RegExp("\\b"+i.args[r]+"\\b"),o[r]);s.push.apply(s,n.replaceMacros(t,e))})),s}return[e]},t.preProcess=function(t){var e=this;t=t.trim().replace(/^_/,"");var n=parseInt(t);if(!isNaN(n))return n;var r=t.split(/ (=) | (!=) | (>) | (<) /).filter((function(t){return void 0!==t})),i=t.match(/^(.+)\((.+)\)$/),o=t.split(" "),s=t.match(/([^:]+):$/),a=t.match(/^:([^:]+)$/);if(3===r.length)return{left:this.preProcess(r[0]),comparator:r[1],right:this.preProcess(r[2])};if(i){var l=i[2].split(",").map((function(t){return e.preProcess(t)}));return{invoke:i[1],args:l}}if(o.length>1)return l=2===o.length?[this.preProcess(o[1])]:o.splice(1).map((function(t){return e.preProcess(t)})),{invoke:o[0],args:l};if(s)return{label:s[1]};if(a)return{jump:a[1].toLowerCase()};if(t.match(/[ =?><!]/))throw"Invalid expression given, parsing must have failed before somewhere";return{invoke:t,args:[]}},t}(),Re=i.M8C.degToRad,Oe=function(){function t(t){var e=this;this.spawnRaiderInterval=null,this.nerpRunner=null,this.nerpInterval=null,this.sceneManager=new $t(t),this.sceneManager.cursorTorchlight.distance*=bn,ht.registerEventListener(Wt.eventKey,(function(){return Zt.selectEntities([])})),ht.registerEventListener(mt.eventKey,(function(t){Zt.requestedRaiders=t.numRequested,Zt.requestedRaiders>0&&!e.spawnRaiderInterval&&(e.spawnRaiderInterval=setInterval(e.checkSpawnRaiders.bind(e),pn))})),ht.registerEventListener(bt.eventKey,(function(t){var n=Zt.getClosestBuildingByType(t.surface.getDigPositions()[0],lt.TOOLSTATION);if(!n)throw"Could not find toolstation to spawn dynamite";var r=n.getDropPosition(),i=new Vt;i.targetSurface=t.surface,i.worldMgr=e,i.setActivity("Normal"),i.group.position.copy(r),e.sceneManager.scene.add(i.group),ht.publishEvent(new yt(new re(t.surface,i)))})),ht.registerEventListener(It.eventKey,(function(t){e.addCollectable(t.collectable,t.spawnPosition.x,t.spawnPosition.z)}))}return t.prototype.setup=function(t,e){var n,r=L.cfg("Levels",t);if(!r)throw'Could not find level configuration for "'+t+'"';Zt.levelFullName=p(r,"FullName").replace(/_/g," "),console.log("Starting level "+t+" - "+Zt.levelFullName),this.sceneManager.terrain=ce.loadTerrain(r,this),this.sceneManager.scene.add(this.sceneManager.terrain.floorGroup);var i=L.getResource(p(r,"OListFile"));Ee.loadObjectList(this,i);var o=p(r,"NERPFile"),s=L.getResource(o);this.nerpRunner=Pe.parse(s);var a=p(r,"NERPMessageFile"),l=L.getResource(a);(n=this.nerpRunner.messages).push.apply(n,l),this.nerpRunner.onLevelComplete=function(){return e.onLevelEnd()},Zt.totalDiggables=this.sceneManager.terrain.surfaces.filter((function(t){return t.forEach((function(t){return t.isDigable()}))})).length,Zt.totalCrystals=0,this.sceneManager.terrain.surfaces.forEach((function(t){return t.forEach((function(t){return Zt.totalCrystals+=t.containedCrystals}))})),Zt.totalOres=0,this.sceneManager.terrain.surfaces.forEach((function(t){return t.forEach((function(t){return Zt.totalOres+=t.containedOres}))}))},t.prototype.start=function(){var t=this;this.nerpInterval=setInterval((function(){t.nerpRunner.execute()}),2e3),this.sceneManager.startRendering(),Zt.levelStartTime=Date.now()},t.prototype.stop=function(){Zt.levelStopTime=Date.now(),this.sceneManager.stopRendering(),this.nerpInterval&&clearInterval(this.nerpInterval),this.nerpInterval=null,this.spawnRaiderInterval&&clearInterval(this.spawnRaiderInterval),this.spawnRaiderInterval=null,Zt.remainingDiggables=this.sceneManager.terrain.surfaces.filter((function(t){return t.forEach((function(t){return t.isDigable()}))})).length},t.prototype.resize=function(t,e){this.sceneManager&&this.sceneManager.renderer.setSize(t,e)},t.prototype.getTerrainIntersectionPoint=function(t,e){if(!this.sceneManager.terrain)return null;var n=new i.iMs;n.setFromCamera({x:t,y:e},this.sceneManager.camera);var r=n.intersectObjects(this.sceneManager.terrain.floorGroup.children);return r.length>0?r[0].point:null},t.prototype.setTorchPosition=function(t){this.sceneManager.cursorTorchlight.position.copy(t),this.sceneManager.cursorTorchlight.position.y=this.getTerrainHeight(t.x,t.z)+2*bn},t.prototype.getTerrainHeight=function(t,e){var n=new i.iMs(new i.Pa4(Number(t),3*bn,Number(e)),new i.Pa4(0,-1,0)).intersectObject(this.sceneManager.terrain.floorGroup,!0);return n.length>0?n[0].point.y:(console.warn("could not determine terrain height for "+t+"/"+e),0)},t.prototype.addCollectable=function(t,e,n){var r=this.getTerrainHeight(e,n);t.worldMgr=this,t.group.position.set(e,r,n),t.group.visible=this.sceneManager.terrain.getSurfaceFromWorld(t.group.position).discovered,this.sceneManager.scene.add(t.group),t.group.visible?(Zt.collectables.push(t),ht.publishEvent(new yt(new Ct(t)))):Zt.collectablesUndiscovered.push(t)},t.prototype.checkSpawnRaiders=function(){var t=this;if(Zt.requestedRaiders<1)return this.spawnRaiderInterval&&clearInterval(this.spawnRaiderInterval),void(this.spawnRaiderInterval=null);if(!(Zt.raiders.length>=Zt.getMaxRaiders()))for(var e=Zt.getBuildingsByType(lt.TOOLSTATION,lt.TELEPORT_PAD).filter((function(t){return t.isPowered()&&!t.spawning})),n=function(n){Zt.requestedRaiders--;var o=e[n];o.spawning=!0;var s=new ve;s.worldMgr=r,s.setActivity("TeleportIn",(function(){o.spawning=!1,s.setActivity("Stand"),s.createPickSphere();var e=o.getPosition().add(new i.Pa4(0,0,3*bn/4+y(bn/2)).applyEuler(o.getRotation()).applyAxisAngle(new i.Pa4(0,1,0),Re(-10+y(20))));e.y=t.getTerrainHeight(e.x,e.z),s.setJob(new Lt(e)),Zt.raiders.push(s),ht.publishEvent(new Et(ct.RAIDER,s))})),s.group.position.copy(o.group.position).add(new i.Pa4(0,0,bn/2).applyEuler(o.group.rotation)),s.group.rotation.copy(o.group.rotation),r.sceneManager.scene.add(s.group)},r=this,o=0;o<e.length&&Zt.requestedRaiders>0;o++)n(o)},t}(),Se=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),_e=function(t){function e(){var e=t.call(this,!0)||this;return e.selectStart=null,e}return Se(e,t),e.prototype.setWorldManager=function(t){this.worldManager=t},e.prototype.handlePointerEvent=function(t,e){var n=this.toCanvasCoords(e.clientX,e.clientY),r=n[0],i=n[1];if("pointerdown"===t){if(e.button===E.MAIN)return this.startSelection(r,i)}else{if("pointermove"===t)return this.changeSelection(r,i);if("pointerup"===t&&e.button===E.MAIN)return this.selectEntities(r,i)}return!1},e.prototype.startSelection=function(t,e){return this.selectStart={x:t,y:e},!0},e.prototype.changeSelection=function(t,e){return!!this.selectStart&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="rgba(128, 192, 192, 0.5)",this.context.lineWidth=2,this.context.strokeRect(this.selectStart.x,this.selectStart.y,t-this.selectStart.x,e-this.selectStart.y),!0)},e.prototype.selectEntities=function(t,e){if(!this.selectStart)return!1;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var n=this.selectStart.x/this.canvas.width*2-1,r=-this.selectStart.y/this.canvas.height*2+1,i=t/this.canvas.width*2-1,o=-e/this.canvas.height*2+1;if(Math.abs(t-this.selectStart.x)<5&&Math.abs(e-this.selectStart.y)<5){var s=(this.selectStart.x+t)/this.canvas.width-1,a=-(this.selectStart.y+e)/this.canvas.height+1;this.worldManager.sceneManager.selectEntitiesByRay(s,a)}else this.worldManager.sceneManager.selectEntitiesInFrustum(n,r,i,o);return this.selectStart=null,!0},e}(A),xe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ce=function(t){function e(){return t.call(this,!1,!1)||this}return xe(e,t),e.prototype.setWorldManager=function(t){this.worldMgr=t},e.prototype.handlePointerEvent=function(t,e){if("pointermove"===t){var n=this.getTerrainPositionFromEvent(e);n&&this.worldMgr.setTorchPosition(n)}else if("pointerup"===t&&e.button===E.SECONDARY&&(Zt.selectionType===k.PILOT||Zt.selectionType===k.GROUP)){var r=this.getTerrainPositionFromEvent(e);if(r){var i=this.worldMgr.sceneManager.terrain.getSurfaceFromWorld(r);i&&(i.isDrillable()?this.createSurfaceJob(ee.DRILL,i):i.hasRubble()?this.createSurfaceJob(ee.CLEAR_RUBBLE,i):i.isWalkable()&&(Zt.selectedEntities.forEach((function(t){return t.setJob(new Lt(r))})),Zt.selectedEntities.length>0&&ht.publishEvent(new Wt)))}}return this.canvas.dispatchEvent(e),!0},e.prototype.handleKeyEvent=function(t,e){return"keyup"===t&&Zt.selectionType===k.SURFACE&&(Zt.selectedEntities.forEach((function(t){if("c"===e.key)t.surfaceType.floor||t.collapse();else if("f"===e.key){var n=t.terrain.findFallInTarget(t.x,t.y);t.surfaceType.floor||t.createFallin(n[0],n[1])}})),ht.publishEvent(new Wt),!0)},e.prototype.createSurfaceJob=function(t,e){var n=new ne(t,e);Zt.selectedEntities.forEach((function(t){n.isQualified(t)&&t.setJob(n)})),ht.publishEvent(new yt(n)),e.updateJobColor(),Zt.selectedEntities.length>0&&ht.publishEvent(new Wt)},e.prototype.getTerrainPositionFromEvent=function(t){var e=this.toCanvasCoords(t.clientX,t.clientY),n=e[0],r=e[1],i=n/this.canvas.width*2-1,o=-r/this.canvas.height*2+1;return this.worldMgr.getTerrainIntersectionPoint(i,o)},e.prototype.handleWheelEvent=function(t,e){return this.canvas.dispatchEvent(e),!0},e}(A),Le=function(){function t(t){void 0===t&&(t=null),this.parent=null,this.x=0,this.y=0,this.relX=0,this.relY=0,this.width=0,this.height=0,this.children=[],this.hidden=!1,this.disabled=!1,this.hover=!1,this.pressed=!1,this.parent=t}return t.prototype.addChild=function(t){return t.parent=this,this.children.push(t),t.updatePosition(),t},t.prototype.onRedraw=function(t){this.hidden||this.children.forEach((function(e){return e.onRedraw(t)}))},t.prototype.onClick=function(){},t.prototype.isInactive=function(){for(var t=this.parent;t;t=t.parent)if(t.isInactive())return!0;return this.hidden||this.disabled},t.prototype.hide=function(){this.hidden=!0,this.children.forEach((function(t){return t.hide()}))},t.prototype.show=function(){this.hidden=!1,this.children.forEach((function(t){return t.show()}))},t.prototype.updatePosition=function(){this.x=this.parent?this.parent.x+this.relX:this.relX,this.y=this.parent?this.parent.y+this.relY:this.relY,this.children.forEach((function(t){return t.updatePosition()}))},t.prototype.isInRect=function(t,e){return t>=this.x&&e>=this.y&&t<this.x+this.width&&e<this.y+this.height},t.prototype.checkHover=function(t,e){if(this.isInactive())return!1;var n=this.isInRect(t,e),r=this.hover!==n;return this.hover=n,this.pressed=this.pressed&&this.hover,this.children.forEach((function(n){return r=n.checkHover(t,e)||r})),r},t.prototype.checkClick=function(t,e){if(this.isInactive())return!1;var n=this.isInRect(t,e),r=this.pressed!==n;return this.pressed=n,this.children.forEach((function(n){return r=n.checkClick(t,e)||r})),r},t.prototype.checkRelease=function(t,e){if(this.isInactive())return!1;this.isInRect(t,e)&&this.pressed&&this.onClick();var n=!1;return this.children.forEach((function(r){return n=r.checkRelease(t,e)||n})),n=this.release()||n},t.prototype.release=function(){var t=this.pressed||this.hover;return this.pressed=!1,this.hover=!1,this.children.forEach((function(e){return t=e.release()||t})),t},t.prototype.notifyRedraw=function(){this.parent&&this.parent.notifyRedraw()},t}(),Me=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ae=function(t){function e(e,n){void 0===n&&(n=null);var r,i,o,s=t.call(this,e)||this;return n&&(s.buttonType=n[0],r=n[1],i=n[2],o=n[3],s.relX=n[4],s.relY=n[5],s.width=n[6],s.height=n[7],s.tooltip=n[8]),r&&(s.imgNormal=L.getImage(r)),i&&(s.imgHover=L.getImage(i)),o&&(s.imgPressed=L.getImage(o)),s.updatePosition(),s}return Me(e,t),e.prototype.onClick=function(){console.log("button pressed: "+this.buttonType)},e.prototype.onRedraw=function(e){if(!this.hidden){var n=this.imgNormal;this.disabled||this.pressed?n=this.imgPressed:this.hover&&(n=this.imgHover),n?e.drawImage(n,this.x,this.y):this.label&&(e.textAlign="center",e.font="bold 10px Arial",e.fillStyle="#fff",e.fillText(this.label,this.x+this.width/2,this.y+this.height-2)),t.prototype.onRedraw.call(this,e)}},e}(Le),Ne=function(t){function e(e){var n,r,i,o=t.call(this,e,null)||this;return o.buttonType="InterfaceBackButton",n=L.cfg(o.buttonType),o.width=n[0],o.height=n[1],r=n[2],i=n[3],o.tooltip=n[4],o.imgHover=L.getImage(r),o.imgPressed=L.getImage(i),o.relX=4,o.relY=14,o}return Me(e,t),e}(Ae),Be=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ke=function(t){function e(e,n,r){var i;void 0===e&&(e=null),void 0===n&&(n={}),void 0===r&&(r={});var o,s=t.call(this)||this;(s.xIn=0,s.yIn=0,s.xOut=0,s.yOut=0,s.buttons={},s.animationTimeout=null,s.movedIn=!1,s.name=e,n&&e)&&(o=(i=p(n,e))[0],s.xOut=i[1],s.yOut=i[2],s.xIn=i[3],s.yIn=i[4],s.img=L.getImage(o),s.relX=s.xIn,s.relY=s.yIn);if(r&&e){var a=p(r,e);a&&("Panel_Encyclopedia"===e?s.addButton(new Ae(s,a)):a.forEach((function(t){return s.addButton(new Ae(s,t))})))}return s}return Be(e,t),e.prototype.addButton=function(t){return this.buttons[t.buttonType]=t,this.addChild(t),t},e.prototype.isInactive=function(){return this.animationTimeout||t.prototype.isInactive.call(this)},e.prototype.updateAnimation=function(t,e,n,r){var i=t-this.relX,o=e-this.relY;if(Math.abs(i)<=n&&Math.abs(o)<=n)this.relX=t,this.relY=e,this.animationTimeout=null,r&&r();else{this.relX+=Math.round(Math.sign(i)*Math.sqrt(Math.abs(i))*n),this.relY+=Math.round(Math.sign(o)*Math.sqrt(Math.abs(o))*n);var s=this;this.animationTimeout=setTimeout((function(){return s.updateAnimation(t,e,n,r)}),1e3/In)}this.updatePosition(),this.notifyRedraw()},e.prototype.setMovedIn=function(t,e){void 0===e&&(e=null),this.movedIn!==t?this.toggleState(e):e&&e()},e.prototype.toggleState=function(t){void 0===t&&(t=null),this.animationTimeout&&(clearTimeout(this.animationTimeout),this.animationTimeout=null),this.movedIn?(this.movedIn=!1,this.updateAnimation(this.xOut,this.yOut,yn,t)):(this.movedIn=!0,this.updateAnimation(this.xIn,this.yIn,yn,t))},e.prototype.onRedraw=function(e){this.hidden||(this.img&&e.drawImage(this.img,this.x,this.y),t.prototype.onRedraw.call(this,e))},e}(Le),De=function(t){function e(e,n,r){var i=t.call(this,e,n,r)||this;return i.btnPriorities=p(i.buttons,"PanelButton_TopPanel_Priorities"),i}return Be(e,t),e}(ke),je=function(t){function e(e,n,r){var i=t.call(this,e,n,r)||this;return i.btnGoto=p(i.buttons,"PanelButton_InfoDock_Goto"),i.btnGoto.disabled=!0,i.btnClose=p(i.buttons,"PanelButton_InfoDock_Close"),i.btnClose.disabled=!0,i}return Be(e,t),e}(ke),Fe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ue=function(t){function e(e,n,r){var i=t.call(this,e,n,r)||this;return i.fill=i.addChild(new ke("Panel_RadarFill",n,r)),i.fill.relX=i.relX-i.fill.relX,i.fill.relY=i.relY-i.fill.relY,i.overlay=i.addChild(new ke("Panel_RadarOverlay",n,r)),i.btnToggle=p(i.buttons,"PanelButton_Radar_Toggle"),i.btnToggle.onClick=function(){return i.toggleState()},i.btnMap=p(i.buttons,"PanelButton_Radar_MapView"),i.btnMap.onClick=function(){},i.btnTagged=p(i.buttons,"PanelButton_Radar_TaggedObjectView"),i.btnTagged.onClick=function(){},i}return Fe(e,t),e}(ke),We=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ge=function(t){function e(e,n,r){var i=t.call(this,e,n,r)||this;return i.relX=i.xOut=i.xIn=42,i.relY=i.yOut=i.yIn=409,i.imgAir=L.getImage("Interface/Airmeter/msgpanel_air_juice.bmp"),i}return We(e,t),e.prototype.onRedraw=function(e){if(t.prototype.onRedraw.call(this,e),Zt.airlevel>0){var n=Math.round(236*Zt.airlevel);e.drawImage(this.imgAir,this.x+85,this.y+6,n,8)}},e}(ke),He=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ke=function(t){function e(e,n,r){var i=t.call(this,e,n,r)||this;return i.btnOre=p(i.buttons,"PanelButton_CrystalSideBar_Ore"),i.btnOre.label=Zt.numOre.toString(),i.btnCrystal=p(i.buttons,"PanelButton_CrystalSideBar_Crystals"),i.btnCrystal.label=Zt.numCrystal.toString(),i.imgNoCrystal=L.getImage("Interface/RightPanel/NoSmallCrystal.bmp"),i.imgSmallCrystal=L.getImage("Interface/RightPanel/SmallCrystal.bmp"),i.imgUsedCrystal=L.getImage("Interface/RightPanel/UsedCrystal.bmp"),i.imgOre=L.getImage("Interface/RightPanel/CrystalSideBar_Ore.bmp"),ht.registerEventListener(wt.eventKey,(function(t){i.updateQuantities(t.collectType)})),ht.registerEventListener(It.eventKey,(function(t){i.updateQuantities(t.collectable.getCollectableType())})),i}return He(e,t),e.prototype.updateQuantities=function(t){t!==St.CRYSTAL&&t!==St.ORE&&t!==St.BRICK||(this.btnOre.label=Zt.numOre.toString(),this.btnCrystal.label=Zt.numCrystal.toString(),this.notifyRedraw())},e.prototype.onRedraw=function(e){t.prototype.onRedraw.call(this,e);for(var n=this.x+this.img.width-8,r=this.y+this.img.height-34,i=0;(Zt.neededCrystals<1||i<Math.max(Zt.neededCrystals,Zt.numCrystal))&&r>=Math.max(this.imgNoCrystal.height,this.imgSmallCrystal.height,this.imgUsedCrystal.height);i++){var o=this.imgNoCrystal;Zt.usedCrystals>i?o=this.imgUsedCrystal:Zt.numCrystal>i&&(o=this.imgSmallCrystal),r-=o.height,e.drawImage(o,n-o.width/2,r)}n=this.x+this.img.width-21,r=this.y+this.img.height-42;for(var s=0;s<Zt.numOre&&r>=this.imgOre.height;++s)r-=this.imgOre.height,e.drawImage(this.imgOre,n-this.imgOre.width/2,r)},e}(ke),Ve=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ze=function(t){function e(e,n,r){var i=t.call(this)||this;i.panel=e,i.itemKey=r,i.relX=e.img.width-59,i.relY=9,i.width=40,i.height=40;var o,s,a,l=L.cfg(n,r);return l&&(o=l[0],s=l[1],a=l[2],i.tooltip=l[3],i.tooltipDisabled=l[4],i.hotkey=l[5]),o&&(i.imgNormal=L.getImage(o)),s&&(i.imgDisabled=L.getImage(s)),a&&(i.imgPressed=L.getImage(a)),i.disabled=!0,i}return Ve(e,t),e.prototype.onClick=function(){console.log("menu item pressed: "+this.itemKey)},e.prototype.onRedraw=function(e){if(!this.hidden){var n=this.imgNormal;this.disabled?n=this.imgDisabled:this.pressed&&(n=this.imgPressed),n&&e.drawImage(n,this.x,this.y),!this.disabled&&this.hover&&(e.strokeStyle="#0f0",e.lineWidth=2,e.strokeRect(this.x-e.lineWidth/2,this.y-e.lineWidth/2,this.width+e.lineWidth-1,this.height+e.lineWidth-1)),t.prototype.onRedraw.call(this,e)}},e}(Le),Ye=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Je=function(t){function e(){var e=t.call(this)||this;return e.subPanels=[],e.xOut=735,e.relX=e.xIn=624,e.relY=e.yIn=e.yOut=9,e}return Ye(e,t),e.prototype.addSubPanel=function(t){var e=this.addChild(new Xe(t,this.mainPanel));return this.subPanels.push(e),e},e.prototype.selectSubPanel=function(t){this.subPanels.forEach((function(t){return t.setMovedIn(!1)})),t.setMovedIn(!0)},e}(ke),Xe=function(t){function e(e,n){void 0===n&&(n=null);var r=t.call(this)||this;if(r.countMenuItems=0,r.backBtn=null,n){r.backBtn=r.addButton(new Ne(r));var i=r;r.backBtn.onClick=function(){return i.toggleState((function(){return n.toggleState()}))}}var o=L.cfg("InterfaceSurroundImages",e.toString()),s=o[0],a=(o[1],o[2],o[3],o[4],o[5]);return o[6],o[7],r.img=n?L.getImage(s):L.getImage(a),r.xIn=-r.img.width,r}return Ye(e,t),e.prototype.addMenuItem=function(t,e){var n=this.addChild(new ze(this,t,e));return n.relY+=n.height*this.countMenuItems,this.countMenuItems++,n},e}(ke),qe=function(){function t(t){void 0===t&&(t=!1),this.surfaces=[],this.neededByType={},this.assignedByType={},this.onSiteByType={},this.complete=!1,this.isPowerPath=t}return t.prototype.getPosition=function(){return this.surfaces[0].getCenterWorld()},t.prototype.needs=function(t){return(this.neededByType[t]||0)>(this.assignedByType[t]||[]).length},t.prototype.assign=function(t){var e=t.getCollectableType();this.assignedByType[e]=this.assignedByType[e]||[],this.assignedByType[e].push(t)},t.prototype.unAssign=function(t){var e=t.getCollectableType();this.assignedByType[e]=(this.assignedByType[e]||[]).filter((function(e){return e!==t}))},t.prototype.addItem=function(t){var e=t.getCollectableType(),n=this.neededByType[e]||0;this.onSiteByType[e]=this.onSiteByType[e]||[],this.onSiteByType[e].length<n?(t.group.position.copy(t.getTargetPos()),t.worldMgr.sceneManager.scene.add(t.group),this.onSiteByType[e].push(t),this.checkComplete()):(t.resetTarget(),t.worldMgr.addCollectable(t,t.getTargetPos().x,t.getTargetPos().z))},t.prototype.checkComplete=function(){var t=this;if(!this.complete){var e=!0;if(Object.keys(this.neededByType).some((function(n){var r=t.neededByType[n]||0;if((t.onSiteByType[n]||[]).length<r)return e=!1,!0})),e){this.complete=e,Zt.buildingSites=Zt.buildingSites.filter((function(e){return e!==t}));var n=[];Object.keys(this.onSiteByType).forEach((function(e){return n.push.apply(n,t.onSiteByType[e])})),this.isPowerPath?ht.publishEvent(new yt(new ie(this.surfaces[0],n))):console.log("Building site is complete")}}},t}(),Ze=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),$e=function(t){function e(){var e=t.call(this)||this;e.mainPanel=e.addSubPanel(4),ht.registerEventListener(Wt.eventKey,(function(){return e.selectSubPanel(e.mainPanel)}));var n=e.addSubPanel(10),r=e.addSubPanel(6),i=e.addSubPanel(5),o=e.addSubPanel(4),s=e.addSubPanel(3),a=e.addSubPanel(2),l=e.addSubPanel(4),c=e.addSubPanel(10),u=e.addSubPanel(7),h=e.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_TeleportMan");h.disabled=Zt.getBuildingsByType(lt.TOOLSTATION,lt.TELEPORT_PAD).length<1,ht.registerEventListener(Et.eventKey,(function(t){t.type!==ct.BUILDING&&t.type!==ct.RAIDER||(h.disabled=Zt.getBuildingsByType(lt.TOOLSTATION,lt.TELEPORT_PAD).length<1||Zt.raiders.length>=Zt.getMaxRaiders(),e.notifyRedraw())})),ht.registerEventListener(Tt.eventKey,(function(t){t.type!==ct.BUILDING&&t.type!==ct.RAIDER||(h.disabled=Zt.getBuildingsByType(lt.TOOLSTATION,lt.TELEPORT_PAD).length<1||Zt.raiders.length>=Zt.getMaxRaiders(),e.notifyRedraw())})),h.onClick=function(){return ht.publishEvent(new mt(Zt.requestedRaiders+1))};var p=e.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildBuilding");p.disabled=!1,p.onClick=function(){return e.mainPanel.toggleState((function(){return n.toggleState()}))},n.addMenuItem("InterfaceBuildImages","Toolstation"),n.addMenuItem("InterfaceBuildImages","TeleportPad"),n.addMenuItem("InterfaceBuildImages","Docks"),n.addMenuItem("InterfaceBuildImages","Powerstation"),n.addMenuItem("InterfaceBuildImages","Barracks"),n.addMenuItem("InterfaceBuildImages","Upgrade"),n.addMenuItem("InterfaceBuildImages","Geo-dome"),n.addMenuItem("InterfaceBuildImages","OreRefinery"),n.addMenuItem("InterfaceBuildImages","Gunstation"),n.addMenuItem("InterfaceBuildImages","TeleportBIG");var f=e.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildSmallVehicle");f.disabled=!1,f.onClick=function(){return e.mainPanel.toggleState((function(){return r.toggleState()}))},r.addMenuItem("InterfaceBuildImages","Hoverboard"),r.addMenuItem("InterfaceBuildImages","SmallDigger"),r.addMenuItem("InterfaceBuildImages","SmallTruck"),r.addMenuItem("InterfaceBuildImages","SmallCat"),r.addMenuItem("InterfaceBuildImages","SmallMLP"),r.addMenuItem("InterfaceBuildImages","SmallHeli");var d=e.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildLargeVehicle");d.disabled=!1,d.onClick=function(){return e.mainPanel.toggleState((function(){return i.toggleState()}))},i.addMenuItem("InterfaceBuildImages","BullDozer"),i.addMenuItem("InterfaceBuildImages","WalkerDigger"),i.addMenuItem("InterfaceBuildImages","LargeMLP"),i.addMenuItem("InterfaceBuildImages","LargeDigger"),i.addMenuItem("InterfaceBuildImages","LargeCat"),e.mainPanel.setMovedIn(!0);var g=o.addMenuItem("InterfaceImages","Interface_MenuItem_Dig");g.onClick=function(){var t=Zt.selectedEntities[0];t.hasJobType(ee.DRILL)||ht.publishEvent(new yt(new ne(ee.DRILL,t))),ht.publishEvent(new Wt)};var y=o.addMenuItem("InterfaceImages","Interface_MenuItem_Reinforce");y.onClick=function(){var t=Zt.selectedEntities[0];t.hasJobType(ee.REINFORCE)||ht.publishEvent(new yt(new ne(ee.REINFORCE,t))),ht.publishEvent(new Wt)};var v=o.addMenuItem("InterfaceImages","Interface_MenuItem_Dynamite");v.onClick=function(){var t=Zt.selectedEntities[0];t.hasJobType(ee.BLOW)||ht.publishEvent(new bt(t)),ht.publishEvent(new Wt)};var m=o.addMenuItem("InterfaceImages","Interface_MenuItem_DeselectDig");m.disabled=!1,m.onClick=function(){Zt.selectedEntities[0].cancelJobs(),ht.publishEvent(new Wt)},o.backBtn.onClick=function(){return ht.publishEvent(new Wt)},s.backBtn.onClick=function(){return ht.publishEvent(new Wt)};var w=s.addMenuItem("InterfaceImages","Interface_MenuItem_LayPath");w.onClick=function(){var t=Zt.selectedEntities[0];t.surfaceType=Qt.POWER_PATH_SITE,t.updateTexture();var e=Zt.getClosestBuildingByType(t.getCenterWorld(),lt.TOOLSTATION);e&&Zt.dropMaterial(St.ORE,2).forEach((function(t){ht.publishEvent(new It(t,e.getDropPosition()))}));var n=new qe(!0);n.surfaces.push(t),n.neededByType[St.ORE]=2,Zt.buildingSites.push(n),ht.publishEvent(new Wt)},s.addMenuItem("InterfaceImages","Interface_MenuItem_RemovePath"),s.addMenuItem("InterfaceImages","Interface_MenuItem_PlaceFence"),a.backBtn.onClick=function(){return ht.publishEvent(new Wt)};var b=a.addMenuItem("InterfaceImages","Interface_MenuItem_ClearRubble");return b.onClick=function(){var t=Zt.selectedEntities[0];ht.publishEvent(new yt(new ne(ee.CLEAR_RUBBLE,t))),ht.publishEvent(new Wt)},a.addMenuItem("InterfaceImages","Interface_MenuItem_PlaceFence"),ht.registerEventListener(Dt.eventKey,(function(t){var n=t.surface;n.surfaceType.floor?n.hasRubble()?(b.disabled=!t.surface.hasRubble(),e.selectSubPanel(a)):(w.disabled=t.surface.hasRubble(),e.selectSubPanel(s)):(e.selectSubPanel(o),g.disabled=!n.isDrillable(),y.disabled=!n.isReinforcable(),v.disabled=!n.isExplodable(),e.notifyRedraw())})),ht.registerEventListener(jt.eventKey,(function(){return e.selectSubPanel(l)})),ht.registerEventListener(Wt.eventKey,(function(){return e.selectSubPanel(e.mainPanel)})),l.backBtn.onClick=function(){return ht.publishEvent(new Wt)},l.addMenuItem("InterfaceImages","Interface_MenuItem_Repair"),l.addMenuItem("InterfaceImages","Interface_MenuItem_PowerOff"),l.addMenuItem("InterfaceImages","Interface_MenuItem_UpgradeBuilding"),l.addMenuItem("InterfaceImages","Interface_MenuItem_DeleteBuilding"),ht.registerEventListener(Ft.eventKey,(function(){return e.selectSubPanel(c)})),c.backBtn.onClick=function(){return ht.publishEvent(new Wt)},c.addMenuItem("InterfaceImages","Interface_MenuItem_GoFeed"),c.addMenuItem("InterfaceImages","Interface_MenuItem_UnLoadMinifigure"),c.addMenuItem("InterfaceImages","Interface_MenuItem_MinifigurePickUp"),c.addMenuItem("InterfaceImages","Interface_MenuItem_GetTool"),c.addMenuItem("InterfaceImages","Interface_MenuItem_DropBirdScarer"),c.addMenuItem("InterfaceImages","Interface_MenuItem_UpgradeMan"),c.addMenuItem("InterfaceImages","Interface_MenuItem_TrainSkill"),c.addMenuItem("InterfaceImages","Interface_MenuItem_GotoFirstPerson"),c.addMenuItem("InterfaceImages","Interface_MenuItem_GotoSecondPerson"),c.addMenuItem("InterfaceImages","Interface_MenuItem_DeleteMan"),ht.registerEventListener(Ut.eventKey,(function(){return e.selectSubPanel(u)})),u.backBtn.onClick=function(){return ht.publishEvent(new Wt)},e}return Ze(e,t),e}(Je),Qe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),tn=function(t){function e(){var e=t.call(this)||this;e.rootElement=new Le;var n=L.cfg("Panels640x480"),r=L.cfg("Buttons640x480"),i=e;return e.rootElement.notifyRedraw=function(){return i.redraw()},e.panelEncyclopedia=e.addPanel(new ke("Panel_Encyclopedia",n,r)),e.panelInfoDock=e.addPanel(new je("Panel_InfoDock",n,r)),e.panelCameraControl=e.addPanel(new ke("Panel_CameraControl",n,r)),e.panelPriorityList=e.addPanel(new ke("Panel_PriorityList",n,r)),e.panelInformation=e.addPanel(new ke("Panel_Information",n,r)),e.panelTopPanel=e.addPanel(new De("Panel_TopPanel",n,r)),e.panelIcons=e.addPanel(new $e),e.panelCrystalSideBar=e.addPanel(new Ke("Panel_CrystalSideBar",n,r)),e.panelMessagesSide=e.addPanel(new ke("Panel_MessagesSide",n,r)),e.panelMessages=e.addPanel(new Ge("Panel_Messages",n,r)),e.panelRadar=e.addPanel(new Ue("Panel_Radar",n,r)),e.panelTopPanel.btnPriorities.onClick=function(){e.panelTopPanel.btnPriorities.pressed},e.onRedraw=function(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),e.rootElement.onRedraw(t)},e}return Qe(e,t),e.prototype.addPanel=function(t){return this.rootElement.addChild(t),t},e.prototype.handlePointerEvent=function(t,e){var n=this.toCanvasCoords(e.clientX,e.clientY),r=n[0],i=n[1],o=this.toScaledCoords(e.clientX,e.clientY),s=o[0],a=o[1],l=this.context&&this.context.getImageData(r,i,1,1).data[3]>0,c=!1;return l?(e.preventDefault(),"pointermove"===t?c=this.rootElement.checkHover(s,a)||c:"pointerdown"===t?c=this.rootElement.checkClick(s,a)||c:"pointerup"===t&&(c=this.rootElement.checkRelease(s,a)||c)):"pointermove"===t&&(c=this.rootElement.release()||c),c&&this.redraw(),l},e.prototype.handleWheelEvent=function(t,e){var n=this.toCanvasCoords(e.clientX,e.clientY),r=n[0],i=n[1];return!this.context||this.context.getImageData(r,i,1,1).data[3]>0},e}(N),en=function(){function t(t){var e=this;this.jobs=[],this.interval=null,this.worldMgr=t,ht.registerEventListener(yt.eventKey,(function(t){e.jobs.push(t.job)})),ht.registerEventListener(vt.eventKey,(function(t){t.job.cancel()}))}return t.prototype.start=function(){stop(),this.interval=setInterval(this.scheduleJobs.bind(this),un)},t.prototype.stop=function(){this.interval&&clearInterval(this.interval),this.interval=null,Zt.raiders.forEach((function(t){t.workInterval&&clearInterval(t.workInterval),t.workInterval=null})),Zt.raidersUndiscovered.forEach((function(t){t.workInterval&&clearInterval(t.workInterval),t.workInterval=null})),Zt.vehicles.forEach((function(t){t.workInterval&&clearInterval(t.workInterval),t.workInterval=null})),Zt.vehiclesUndiscovered.forEach((function(t){t.workInterval&&clearInterval(t.workInterval),t.workInterval=null}))},t.prototype.scheduleJobs=function(){this.jobs=this.jobs.filter((function(t){return t.jobstate===Rt.OPEN})),this.jobs.filter((function(t){return t.fulfiller.length<1})).forEach((function(t){var e=null,n=null;Zt.raiders.forEach((function(r){if(!r.job&&t.isQualified(r)){var o=(new i.Pa4).copy(t.getPosition()).sub(r.getPosition()).lengthSq();(null===n||o<n)&&(e=r,n=o)}})),e&&e.setJob(t)}))},t}(),nn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),rn=function(t){function e(){var e=t.call(this)||this;return e.gameLayer=e.addLayer(new Ce,0),e.selectionLayer=e.addLayer(new _e,10),e.guiLayer=e.addLayer(new tn,20),e.worldManager=new Oe(e.gameLayer.canvas),e.gameLayer.setWorldManager(e.worldManager),e.selectionLayer.setWorldManager(e.worldManager),e.jobSupervisor=new en(e.worldManager),e}return nn(e,t),e.prototype.startLevel=function(t){this.worldManager.setup(t,this),this.gameLayer.show(),this.show()},e.prototype.show=function(){t.prototype.show.call(this),this.worldManager.start(),this.jobSupervisor.start()},e.prototype.hide=function(){this.worldManager.stop(),this.jobSupervisor.stop(),t.prototype.hide.call(this)},e.prototype.resize=function(e,n){t.prototype.resize.call(this,e,n),this.worldManager&&this.worldManager.resize(e,n)},e}(j),on=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),sn=function(t){function e(e){var n,r,i,o,s=t.call(this)||this;return s.disabled=!1,s.visible=!0,n=e[0],r=e[1],i=e[2],o=e[3],s.x=e[4],s.y=e[5],s.imgNormal=L.getImage(n),s.imgHover=L.getImage(r),s.imgPressed=L.getImage(i),s.imgDisabled=L.getImage(o),s.width=s.imgNormal.width,s.height=s.imgNormal.height,s}return on(e,t),e.prototype.draw=function(e){if(t.prototype.draw.call(this,e),this.visible){var n=this.imgNormal;this.disabled?n=this.imgDisabled:this.pressed?n=this.imgPressed:this.hover&&(n=this.imgHover),e.drawImage(n,this.x,this.y)}},e}(W),an=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ln=function(t){function e(){var e=t.call(this)||this;e.cfg=null,e.resultIndex=0,e.resultLastIndex=0,e.images=[],e.boxes=[],e.fonts={},e.texts=[],e.uncoverTimeout=null,e.cfg=L.getResource("Reward"),e.titleFont=L.getBitmapFont(e.cfg.titleFont);var n=L.getImage(e.cfg.wallpaper);return e.addLayer(new N).onRedraw=function(t){return t.drawImage(n,0,0)},e.cfg.images.forEach((function(t){e.images.push({img:L.getImage(t.filePath),x:t.x,y:t.y})})),e.cfg.boxImages.forEach((function(t){e.boxes.push({img:L.getImage(t.filePath),x:t.x,y:t.y})})),Object.keys(e.cfg.fonts).forEach((function(t,n){var r=L.getBitmapFont(e.cfg.fonts[t]);e.fonts[t.toLowerCase()]=r;var i=e.cfg.texts[n],o=n<9?r:L.getBitmapFont(e.cfg.backFont);e.texts.push(o.createTextImage(i.text))})),e.resultsLayer=e.addLayer(new N),e.resultsLayer.handlePointerEvent=function(t){return"pointerup"===t&&(e.uncoverTimeout&&clearTimeout(e.uncoverTimeout),e.uncoverTimeout=null,e.resultIndex=e.resultLastIndex,e.btnSave.visible=!0,e.btnAdvance.visible=!0,e.redraw(),!0)},e.descriptionTextLayer=e.addLayer(new N,20),e.btnLayer=e.addLayer(new N,50),e.btnSave=new sn(e.cfg.saveButton),e.btnSave.disabled=!0,e.btnAdvance=new sn(e.cfg.advanceButton),e.btnLayer.handlePointerEvent=function(t,n){if("pointermove"===t){var r=e.btnLayer.toScaledCoords(n.clientX,n.clientY),i=r[0],o=r[1];e.btnSave.checkHover(i,o),e.btnAdvance.checkHover(i,o)}else"pointerdown"===t?n.button===E.MAIN&&(e.btnSave.checkSetPressed(),e.btnAdvance.checkSetPressed()):"pointerup"===t&&n.button===E.MAIN&&(e.btnSave.pressed?e.btnSave.setReleased():e.btnAdvance.pressed&&(e.btnAdvance.setReleased(),e.hide(),e.onAdvance()));return(e.btnSave.needsRedraw||e.btnAdvance.needsRedraw)&&e.redraw(),!1},e.btnLayer.onRedraw=function(t){e.btnSave.draw(t),e.btnAdvance.draw(t)},e}return an(e,t),e.prototype.show=function(){var e=this;this.resultIndex=0,this.btnSave.visible=!1,this.btnAdvance.visible=!1,this.uncoverResult();var n=this.titleFont.createTextImage(Zt.levelFullName),r=this.cfg.quitText;this.resultLastIndex=this.images.length-2,Zt.resultState===Nt.COMPLETE?(r=this.cfg.completeText,this.resultLastIndex=this.images.length-1):Zt.resultState===Nt.FAILED&&(r=this.cfg.failedText);var i=[];i.push(this.fonts.crystals.createTextImage(this.percentString(Zt.numCrystal,Zt.neededCrystals))),i.push(this.fonts.ore.createTextImage(this.percentString(Zt.numOre,Zt.totalOres))),i.push(this.fonts.diggable.createTextImage(this.percentString(Zt.remainingDiggables,Zt.totalDiggables,!0))),i.push(this.fonts.constructions.createTextImage(Zt.buildings.length.toString())),i.push(this.fonts.caverns.createTextImage(this.percentString(Zt.remainingCaverns,Zt.totalCaverns,!0))),i.push(this.fonts.figures.createTextImage(this.percentString(Zt.raiders.length,Zt.getMaxRaiders()))),i.push(this.fonts.rockmonsters.createTextImage(this.percentString(0))),i.push(this.fonts.oxygen.createTextImage(this.percentString(Zt.airlevel))),i.push(this.fonts.timer.createTextImage(this.timeString(Zt.levelStopTime-Zt.levelStartTime))),i.push(this.fonts.score.createTextImage(this.percentString(.99)));var o=this.titleFont.createTextImage(r);this.resultsLayer.onRedraw=function(t){for(var r=0;r<=e.resultIndex;r++){var s=e.images[r];s&&t.drawImage(s.img,s.x,s.y)}for(r=0;r<=e.resultIndex;r++){var a=e.boxes[r];a&&t.drawImage(a.img,a.x,a.y)}for(r=0;r<=e.resultIndex;r++){var l=e.cfg.texts[r],c=i[r];c&&t.drawImage(c,l.x-c.width/2,l.y)}t.drawImage(n,e.resultsLayer.fixedWidth/2-n.width/2,e.cfg.vertSpacing-n.height/2),t.drawImage(o,e.resultsLayer.fixedWidth/2-o.width/2,e.cfg.vertSpacing+n.height/2)},this.descriptionTextLayer.onRedraw=function(t){var n=e.texts[e.resultIndex];t.clearRect(0,e.cfg.textPos[1],e.descriptionTextLayer.fixedWidth,e.descriptionTextLayer.fixedHeight-e.cfg.textPos[1]);var r=e.resultIndex!==e.images.length?e.cfg.textPos[0]:305,i=e.resultIndex!==e.images.length?e.cfg.textPos[1]:195;t.drawImage(n,r-n.width/2,i)},t.prototype.show.call(this)},e.prototype.percentString=function(t,e,n){void 0===e&&(e=1),void 0===n&&(n=!1),0===e&&(e=1);var r=Math.round(100*Math.max(Math.min(t/e,1),0));return n&&(r=100-r),r.toString()+"%"},e.prototype.padLeft=function(t,e,n){for(void 0===e&&(e="0"),void 0===n&&(n=2);t.length<n;)t=e+t;return t},e.prototype.timeString=function(t){var e=Math.round(t/1e3),n=this.padLeft((e%60).toString()),r=Math.floor(e/60),i=this.padLeft((r%60).toString());return this.padLeft(Math.floor(r/60).toString())+":"+i+":"+n},e.prototype.uncoverResult=function(){var t=this;this.uncoverTimeout=setTimeout((function(){t.uncoverTimeout=null,t.resultIndex++,t.resultIndex<t.resultLastIndex?t.uncoverResult():(t.btnSave.visible=!0,t.btnAdvance.visible=!0),t.redraw()}),1e3*this.cfg.timer)},e}(j),cn=n(169),un=1e3,hn=5,pn=1e3,fn=2,dn=12,gn=10,yn=3,vn=.05,mn=640,wn=480,bn=40,In=30,En=new U,Tn=new cn.u_(document.getElementById("wadfiles_select_modal"),{backdrop:"static",keyboard:!1}),Pn=document.getElementById("button-start-file");Pn.addEventListener("click",(function(){Pn.disabled=!0;var t=URL.createObjectURL(document.getElementById("wad0-file").files[0]),e=URL.createObjectURL(document.getElementById("wad1-file").files[0]);L.startLoadingFromUrl(t,e)}));var Rn=document.getElementById("button-start-url");Rn.addEventListener("click",(function(){Rn.disabled=!0;var t=document.getElementById("wad0-url").value,e=document.getElementById("wad1-url").value;L.startLoadingFromUrl(t,e)})),L.onMessage=function(t){En.setLoadingMessage(t)},L.onCacheMissed=function(){Tn.show()},L.onInitialLoad=function(t){Tn.hide(),En.enableGraphicMode(t)},L.onAssetLoaded=function(t){En.setLoadingState(t)},L.onLoadDone=function(){var t=new it,e=new rn,n=new ln;t.onLevelSelected=function(t){e.startLevel(t)},e.onLevelEnd=function(){e.hide(),n.show()},n.onAdvance=function(){Zt.reset(),t.showLevelSelection()},En.hide(),t.showMainMenu()},En.show(),L.startLoadingFromCache()}}]);
//# sourceMappingURL=270.index.js.map