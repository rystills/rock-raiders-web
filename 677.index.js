(self.webpackChunkrock_raiders_web=self.webpackChunkrock_raiders_web||[]).push([[677,990,694,759],{662:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var i=s(15),r=s.n(i),n=s(645),a=s.n(n)()(r());a.push([e.id,".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n","",{version:3,sources:["webpack://./site/clearcache/clearCacheButton.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,kBAAkB;IAClB,OAAO;IACP,MAAM;AACV",sourcesContent:[".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n"],sourceRoot:""}]);const o=a},27:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var i=s(15),r=s.n(i),n=s(645),a=s.n(n)()(r());a.push([e.id,".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n","",{version:3,sources:["webpack://./site/github/github.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,aAAa;IACb,kBAAkB;IAClB,MAAM;IACN,QAAQ;IACR,oCAAoC;IACpC,WAAW;AACf;;AAEA;IACI,WAAW;IACX,qBAAqB;IACrB,YAAY;AAChB;;AAEA;IACI,WAAW;IACX,0BAA0B;AAC9B;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iBAAiB;IACjB,sBAAsB;AAC1B",sourcesContent:[".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n"],sourceRoot:""}]);const o=a},372:(e,t,s)=>{"use strict";s.r(t),s.d(t,{ClearCacheButton:()=>o});var i=s(848),r=s(379),n=s.n(r),a=s(662);n()(a.Z,{insert:"head",singleton:!1}),a.Z.locals;class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("clear-cache-box");const t=this.rootElement.appendChild(document.createElement("button"));t.classList.add("btn","btn-info"),t.innerText="Clear cached wad files and restart",t.onclick=()=>{indexedDB.deleteDatabase(i.UV),location.reload()}}hide(){this.rootElement.style.visibility="hidden"}}},990:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GithubBox:()=>o});var i=s(379),r=s.n(i),n=s(27);r()(n.Z,{insert:"head",singleton:!1}),n.Z.locals;var a=s(351);class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("github-box");const t=this.rootElement.appendChild(document.createElement("a"));t.href="https://github.com/scarabol/rock-raiders-web";const s=t.appendChild(document.createElement("img"));s.src=a,s.classList.add("github-logo"),s.alt="Fork on GitHub",t.appendChild(document.createElement("span")).textContent=s.alt}hide(){this.rootElement.style.visibility="hidden"}}},694:(e,t,s)=>{"use strict";s.r(t),s.d(t,{WadFileSelectionModal:()=>r});var i=s(169);class r{constructor(e){this.onStart=null;const t=document.getElementById(e).appendChild(document.createElement("div"));t.classList.add("modal"),t.tabIndex=-1,t.setAttribute("role","dialog"),t.setAttribute("aria-hidden","true");const s=t.appendChild(document.createElement("div"));s.classList.add("modal-dialog"),t.setAttribute("role","document");const n=s.appendChild(document.createElement("div"));n.classList.add("modal-content");const a=n.appendChild(document.createElement("div"));a.classList.add("modal-header");const o=a.appendChild(document.createElement("h5"));o.classList.add("modal-title"),o.innerText="Load .wad files",o.id="wadfileSelectModalLabel",t.setAttribute("aria-labelledby",o.id);const l=n.appendChild(document.createElement("div"));l.classList.add("modal-body"),l.appendChild(document.createElement("p")).innerText="Assets not included! In order to play the game, please select the game files.";const h=l.appendChild(document.createElement("nav")).appendChild(document.createElement("div"));h.id="nav-tab",h.classList.add("nav","nav-tabs"),h.setAttribute("role","tablist");const c=r.appendNavButton(h,!0,"nav-file-tab","nav-file","Local files (recommended)"),u=r.appendNavButton(h,!1,"nav-url-tab","nav-url","Online from URL"),d=l.appendChild(document.createElement("div"));d.classList.add("tab-content"),this.appendNavFileTab(d,c.id),this.appendNavUrlTab(d,u.id),this.modal=new i.u_(t,{backdrop:"static",keyboard:!1})}static appendNavButton(e,t,s,i,r){const n=e.appendChild(document.createElement("button"));return n.classList.add("nav-link"),t&&n.classList.add("active"),n.id=s,n.setAttribute("data-bs-toggle","tab"),n.setAttribute("data-bs-target","#"+i),n.type="button",n.setAttribute("role","tab"),n.setAttribute("aria-controls",i),n.setAttribute("aria-selected",String(t)),n.innerText=r,n}appendNavFileTab(e,t){const s=r.appendNavTab(e,!0,"nav-file",t),i=r.appendWadFileGroup(s,"wad0-file","LegoRR0.wad"),n=r.appendWadFileGroup(s,"wad1-file","LegoRR1.wad"),a=s.appendChild(document.createElement("button"));a.type="submit",a.classList.add("btn","btn-primary","float-end"),a.id="button-start-file",a.innerText="Start Game",a.addEventListener("click",(()=>{a.disabled=!0;const e=URL.createObjectURL(i.files[0]),t=URL.createObjectURL(n.files[0]);this.onStart(e,t)}))}static appendWadFileGroup(e,t,s){const i=e.appendChild(document.createElement("div"));i.classList.add("my-3");const r=i.appendChild(document.createElement("label"));r.setAttribute("for",t),r.classList.add("form-label"),r.innerHTML='Select <span class="fw-bold">'+s+"</span> here:";const n=i.appendChild(document.createElement("input"));return n.type="file",n.classList.add("form-control"),n.id=t,n.required=!0,n}appendNavUrlTab(e,t){const s=r.appendNavTab(e,!1,"nav-url",t),i=s.appendChild(document.createElement("div"));i.classList.add("my-3"),i.innerText="Direct links with correct Allow-Origin-CORS-Headers required here.";const n=r.appendWadUrlGroup(s,"wad0-url","LegoRR0.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),a=r.appendWadUrlGroup(s,"wad1-url","LegoRR1.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),o=s.appendChild(document.createElement("button"));o.type="submit",o.classList.add("btn","btn-primary","float-end"),o.id="button-start-url",o.innerText="Start Game",o.addEventListener("click",(()=>{o.disabled=!0,this.onStart(n.value,a.value)}))}static appendNavTab(e,t,s,i){const r=e.appendChild(document.createElement("div"));return r.classList.add("tab-pane","fade"),t&&r.classList.add("show","active"),r.id=s,r.setAttribute("role","tabpanel"),r.setAttribute("aria-labelledby",i),r}static appendWadUrlGroup(e,t,s,i){const r=e.appendChild(document.createElement("div"));r.classList.add("my-3");const n=r.appendChild(document.createElement("label"));n.setAttribute("for",t),n.classList.add("form-label"),n.innerHTML='Enter url for <span class="fw-bold">'+s+"</span> here:";const a=r.appendChild(document.createElement("input"));return a.type="url",a.classList.add("form-control"),a.id=t,a.required=!0,a.value=i,a}show(){this.modal.show()}hide(){this.modal.hide()}}},538:(e,t,s)=>{"use strict";function i(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const s=t.lastIndexOf("/");return t=t.substring(0,s+1),t.startsWith("/")&&(t=t.substring(1)),t}function r(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const s=t.lastIndexOf("/");return t.substring(s+1)}function n(e,...t){return t.forEach((t=>{e=(e=Object.keys(e).filter((e=>e.toLowerCase()===t.toLowerCase())).map((t=>e[t])))?e[0]:e})),e}function a(e){return(new TextDecoder).decode(e).replace(/\0/g,"")}function o(e){return a(e).replace(/\\/g,"/")}function l(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function h(e){return l(0,e)}function c(){return 2*l(0,1)-1}function u(e){return e&&clearTimeout(e),null}function d(e){return e&&clearInterval(e),null}s.d(t,{DW:()=>i,vt:()=>r,hh:()=>n,v5:()=>a,jG:()=>o,$u:()=>l,sZ:()=>h,kz:()=>c,L4:()=>u,nJ:()=>d}),Array.prototype.remove=function(e){const t=this.indexOf(e);-1!==t&&this.splice(t,1)},Array.prototype.last=function(){return this.length>0?this[this.length-1]:void 0},Array.prototype.count=function(e){let t=0;return this.forEach((s=>e(s)&&t++)),t},Array.prototype.partition=function(e){const t=[],s=[];return this.forEach((i=>e(i)?t.push(i):s.push(i))),[t,s]},Map.prototype.getOrUpdate=function(e,t){let s=this.get(e);return void 0===s&&(s=t(),this.set(e,s)),s},String.prototype.equalsIgnoreCase=function(e){return this.toLowerCase()===(null==e?void 0:e.toLowerCase())}},677:(e,t,s)=>{"use strict";s.r(t);var i,r,n=s(372),a=s(990),o=s(694),l=s(538),h=s(815);!function(e){e[e.PILOT=0]="PILOT",e[e.TOOLSTATION=1]="TOOLSTATION",e[e.TELEPORT_PAD=2]="TELEPORT_PAD",e[e.DOCKS=3]="DOCKS",e[e.POWER_STATION=4]="POWER_STATION",e[e.BARRACKS=5]="BARRACKS",e[e.UPGRADE=6]="UPGRADE",e[e.GEODOME=7]="GEODOME",e[e.ORE_REFINERY=8]="ORE_REFINERY",e[e.GUNSTATION=9]="GUNSTATION",e[e.TELEPORT_BIG=10]="TELEPORT_BIG",e[e.BAT=11]="BAT",e[e.SMALL_SPIDER=12]="SMALL_SPIDER",e[e.DYNAMITE=13]="DYNAMITE",e[e.ELECTRIC_FENCE=14]="ELECTRIC_FENCE",e[e.CRYSTAL=15]="CRYSTAL",e[e.ORE=16]="ORE",e[e.BRICK=17]="BRICK",e[e.BARRIER=18]="BARRIER"}(i||(i={})),function(e){e[e.RAIDER=0]="RAIDER",e[e.BUILDING=1]="BUILDING",e[e.MONSTER=2]="MONSTER",e[e.MATERIAL=3]="MATERIAL"}(r||(r={}));var c,u=s(505);class d{constructor(e={}){this.shaping=!1,this.matIndex="00",this.floor=!1,this.selectable=!1,this.drillable=!1,this.drillableHard=!1,this.explodable=!1,this.reinforcable=!1,this.cursor=u.C.Pointer_Standard,this.cursorFulfiller=u.C.Pointer_Standard,this.statsDrillName=null,this.canCarryFence=!1,Object.assign(this,e)}static getByNum(e){switch(e){case 0:return d.POWER_PATH_BUILDING;case 1:return d.SOLID_ROCK;case 2:return d.HARD_ROCK;case 3:return d.LOOSE_ROCK;case 4:case 5:return d.DIRT;case 6:return d.LAVA;case 8:return d.ORE_SEAM;case 9:return d.WATER;case 10:return d.CRYSTAL_SEAM;case 11:return d.RECHARGE_SEAM;case 30:case 40:return d.SLUG_HOLE;case 100:return d.RUBBLE4;case 101:return d.RUBBLE3;case 102:return d.RUBBLE2;case 103:return d.RUBBLE1;default:return console.error("Unexpected surface type num: "+e),d.SOLID_ROCK}}}d.GROUND=new d({name:"ground",floor:!0,selectable:!0,canCarryFence:!0}),d.SOLID_ROCK=new d({name:"solid rock",shaping:!0,matIndex:"5",cursor:u.C.Pointer_SurfaceType_Immovable}),d.HARD_ROCK=new d({name:"hard rock",shaping:!0,matIndex:"4",selectable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:u.C.Pointer_SurfaceType_Hard,statsDrillName:"HardDrillTime"}),d.LOOSE_ROCK=new d({name:"loose rock",shaping:!0,matIndex:"3",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:u.C.Pointer_SurfaceType_Medium,statsDrillName:"LooseDrillTime"}),d.DIRT=new d({name:"dirt",shaping:!0,matIndex:"2",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:u.C.Pointer_SurfaceType_Loose,statsDrillName:"SoilDrillTime"}),d.SLUG_HOLE=new d({name:"slug hole",floor:!0,matIndex:"30"}),d.LAVA=new d({name:"lava",floor:!0,matIndex:"46"}),d.ORE_SEAM=new d({name:"ore seam",matIndex:"40",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:u.C.Pointer_SurfaceType_OreSeam,statsDrillName:"SeamDrillTime"}),d.WATER=new d({name:"water",floor:!0,matIndex:"45"}),d.CRYSTAL_SEAM=new d({name:"energy crystal seam",matIndex:"20",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:u.C.Pointer_SurfaceType_CrystalSeam,statsDrillName:"SeamDrillTime"}),d.RECHARGE_SEAM=new d({name:"recharge seam",matIndex:"67",cursor:u.C.Pointer_SurfaceType_RechargeSeam}),d.POWER_PATH=new d({name:"power path all",floor:!0,matIndex:"60",selectable:!0,canCarryFence:!0}),d.POWER_PATH_BUILDING_SITE=new d({name:"power path building site",floor:!0,matIndex:"61",selectable:!0,canCarryFence:!0}),d.POWER_PATH_BUILDING=new d({name:"power path building",floor:!0,matIndex:"76"}),d.POWER_PATH_CONSTRUCTION=new d({name:"power path construction",floor:!0,matIndex:"76",selectable:!0}),d.RUBBLE1=new d({name:"rubble 1",floor:!0,matIndex:"13",selectable:!0,canCarryFence:!0,cursorFulfiller:u.C.Pointer_Clear}),d.RUBBLE2=new d({name:"rubble 2",floor:!0,matIndex:"12",selectable:!0,canCarryFence:!0,cursorFulfiller:u.C.Pointer_Clear}),d.RUBBLE3=new d({name:"rubble 3",floor:!0,matIndex:"11",selectable:!0,canCarryFence:!0,cursorFulfiller:u.C.Pointer_Clear}),d.RUBBLE4=new d({name:"rubble 4",floor:!0,matIndex:"10",selectable:!0,canCarryFence:!0,cursorFulfiller:u.C.Pointer_Clear}),function(e){e[e.DRILL=0]="DRILL",e[e.HAMMER=1]="HAMMER",e[e.SHOVEL=2]="SHOVEL",e[e.SPANNER=3]="SPANNER",e[e.FREEZERGUN=4]="FREEZERGUN",e[e.LASER=5]="LASER",e[e.PUSHERGUN=6]="PUSHERGUN",e[e.BIRDSCARER=7]="BIRDSCARER"}(c||(c={}));const g=[c.DRILL,c.HAMMER,c.SHOVEL,c.SPANNER,c.FREEZERGUN,c.LASER,c.PUSHERGUN,c.BIRDSCARER];var p;!function(e){e[e.DRIVER=0]="DRIVER",e[e.ENGINEER=1]="ENGINEER",e[e.GEOLOGIST=2]="GEOLOGIST",e[e.PILOT=3]="PILOT",e[e.SAILOR=4]="SAILOR",e[e.DEMOLITION=5]="DEMOLITION"}(p||(p={}));const m=[p.DRIVER,p.ENGINEER,p.GEOLOGIST,p.PILOT,p.SAILOR,p.DEMOLITION],y=[];y[p.DRIVER]=i.BARRACKS,y[p.DRIVER]=i.BARRACKS,y[p.ENGINEER]=i.UPGRADE,y[p.GEOLOGIST]=i.GEODOME,y[p.PILOT]=i.TELEPORT_PAD,y[p.SAILOR]=i.DOCKS,y[p.DEMOLITION]=i.TOOLSTATION;const f=[];var v;f[p.DRIVER]="TrainDriver",f[p.ENGINEER]="TrainRepair",f[p.GEOLOGIST]="TrainScanner",f[p.PILOT]="TrainPilot",f[p.SAILOR]="TrainSailor",f[p.DEMOLITION]="TrainDynamite",function(e){e[e.NOTHING=0]="NOTHING",e[e.SURFACE=1]="SURFACE",e[e.RAIDER=2]="RAIDER",e[e.BUILDING=3]="BUILDING",e[e.VEHICLE=4]="VEHICLE",e[e.GROUP=5]="GROUP"}(v||(v={}));var b=s(320),w=s(722);class E extends w.Z{constructor(e){super(e),this.isLocal=!0}}class S extends E{constructor(e=v.NOTHING,t=null,s=null,r=null){super(b.Z.SELECTION_CHANGED),this.canDoTraining=new Map,this.everyHasTool=new Map,this.selectionType=e,this.isGround=(null==t?void 0:t.surfaceType)===d.GROUND,this.isPowerPath=(null==t?void 0:t.surfaceType)===d.POWER_PATH,this.isFloor=null==t?void 0:t.surfaceType.floor,this.isSite=(null==t?void 0:t.surfaceType)===d.POWER_PATH_CONSTRUCTION||(null==t?void 0:t.surfaceType)===d.POWER_PATH_BUILDING_SITE,this.hasRubble=null==t?void 0:t.hasRubble(),this.isDrillable=null==t?void 0:t.isDrillable(),this.isDrillableHard=null==t?void 0:t.isDrillableHard(),this.isReinforcable=null==t?void 0:t.isReinforcable(),this.canPlaceFence=(null==t?void 0:t.canPlaceFence())&&P.buildings.some((e=>e.entityType===i.POWER_STATION&&e.isUsable())),this.someCarries=!!(null==r?void 0:r.some((e=>!!e.carries))),this.everyHasMaxLevel=!!(null==r?void 0:r.every((e=>e.level>=e.stats.Levels))),m.forEach((e=>this.canDoTraining.set(e,P.getTrainingSites(e).length>0&&(null==r?void 0:r.some((t=>!t.hasTraining(e))))))),g.forEach((e=>this.everyHasTool.set(e,!!(null==r?void 0:r.every((t=>t.hasTool(e))))))),this.buildingCanUpgrade=null==s?void 0:s.canUpgrade(),this.buildingCanSwitchPower=!(null==s?void 0:s.stats.SelfPowered)&&!(null==s?void 0:s.stats.PowerBuilding)}}class T extends E{constructor(e){super(b.Z.AIR_LEVEL_CHANGED),this.airLevel=e}}class R extends E{constructor(e){super(b.Z.SETUP_PRIORITY_LIST),this.priorityList=e}}class A extends E{constructor(){super(b.Z.BUILDINGS_CHANGED),this.usableBuildingsByTypeAndLevel=new Map,P.buildings.forEach((e=>{if(e.isUsable()){const t=this.usableBuildingsByTypeAndLevel.getOrUpdate(e.entityType,(()=>new Map));t.set(e.level,t.getOrUpdate(e.level,(()=>0))+1)}}))}static countUsable(e,t,s=0){let i=0;return e.usableBuildingsByTypeAndLevel.getOrUpdate(t,(()=>new Map)).forEach(((e,t)=>{t>=s&&(i+=e)})),i}}class L extends E{constructor(e=null){super(b.Z.RAIDERS_CHANGED),this.numRaiders=P.raiders.length,this.training=e}}var M,C=s(848);!function(e){e[e.RUNNING=0]="RUNNING",e[e.COMPLETE=1]="COMPLETE",e[e.FAILED=2]="FAILED"}(M||(M={}));class P{static reset(){this.resultState=M.RUNNING,this.numCrystal=0,this.numOre=0,this.numBrick=0,this.usedCrystals=0,this.neededCrystals=0,this.airLevel=1,this.selectedEntities=[],this.selectionType=null,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.requestedRaiders=0,this.materials=[],this.materialsUndiscovered=[],this.buildingSites=[],this.spiders=[],this.spidersBySurface=new Map,this.bats=[],this.totalCrystals=0,this.totalOres=0,this.totalDiggables=0,this.remainingDiggables=0,this.totalCaverns=0,this.discoveredCaverns=0,this.levelStartTime=0,this.levelStopTime=0,this.oxygenRate=0,this.buildModeSelection=null}static getBuildingsByType(...e){return this.buildings.filter((t=>t.isUsable()&&e.some((e=>t.entityType===e))))}static getClosestBuildingByType(e,...t){const s=P.getBuildingsByType(...t);let i=null,r=null;return s.forEach((t=>{const s=t.getDropPosition(),n=e.distanceToSquared(s);(null===i||n<r)&&(i=t,r=n)})),i}static getTrainingSites(e){return this.buildings.filter((t=>t.entityType===y[e]&&t.isUsable()&&t.stats[f[e]][t.level]))}static selectEntities(e){this.selectedEntities=this.selectedEntities.filter((t=>{const s=-1!==e.indexOf(t);return s||t.deselect(),s})),e.forEach((e=>{e.select()&&this.selectedEntities.push(e)}));const t=this.selectedEntities.length;t>1?this.selectionType=v.GROUP:1===t?this.selectionType=this.selectedEntities[0].getSelectionType():null!==this.selectionType&&(this.selectionType=v.NOTHING),h.N.publishEvent(new S(this.selectionType,this.selectedSurface,this.selectedBuilding,this.selectedRaiders))}static getMaxRaiders(){return C.d+P.buildings.count((e=>e.isUsable()&&e.entityType===i.BARRACKS))*C.oq}static discoverSurface(e){const t=e.x*C.pM,s=e.y*C.pM,i=t+C.pM,r=s+C.pM;this.discoverEntities(this.raidersUndiscovered,t,i,s,r),this.discoverEntities(this.buildingsUndiscovered,t,i,s,r),this.discoverEntities(this.materialsUndiscovered,t,i,s,r)}static discoverEntities(e,t,s,i,r){const n=[];e.forEach((e=>{const a=e.getPosition();a.x>=t&&a.x<s&&a.z>=i&&a.z<r&&(e.onDiscover(),n.push(e))})),n.forEach((t=>e.remove(t)))}static get gameTimeSeconds(){return Math.round((P.levelStopTime-P.levelStartTime)/1e3)}static get selectedSurface(){return this.selectionType===v.SURFACE&&this.selectedEntities.length>0?this.selectedEntities[0]:null}static get selectedBuilding(){return this.selectionType===v.BUILDING&&this.selectedEntities.length>0?this.selectedEntities[0]:null}static get selectedRaiders(){return(this.selectionType===v.RAIDER||this.selectionType===v.GROUP)&&this.selectedEntities.length>0?this.selectedEntities:[]}static get totalOre(){return this.numOre+5*this.numBrick}static getNearbySpiders(e){const t=e.sceneMgr.terrain,s=t.getSurfaceFromWorld(e.getPosition()),i=[];for(let e=s.x;e<=s.x+1;e++)for(let r=s.y;r<=s.y+1;r++){const s=t.getSurface(e,r);i.push(...P.spidersBySurface.get(s)||[])}return i}}P.resultState=M.RUNNING,P.numCrystal=0,P.numOre=0,P.numBrick=0,P.usedCrystals=0,P.neededCrystals=0,P.airLevel=1,P.selectedEntities=[],P.selectionType=null,P.buildings=[],P.buildingsUndiscovered=[],P.raiders=[],P.raidersUndiscovered=[],P.requestedRaiders=0,P.materials=[],P.materialsUndiscovered=[],P.buildingSites=[],P.spiders=[],P.spidersBySurface=new Map,P.bats=[],P.totalCrystals=0,P.totalOres=0,P.totalDiggables=0,P.remainingDiggables=0,P.totalCaverns=0,P.discoveredCaverns=0,P.levelStartTime=0,P.levelStopTime=0,P.oxygenRate=0,P.buildModeSelection=null;var I=s(212),x=s(344);class O{constructor(){this.carryNullName="",this.depositNullName="",this.toolNullName="",this.mediumPoly={},this.highPoly={},this.fPPoly={},this.activities=new Map}}var N=s(886);const D=s(466);class k{constructor(){this.stats=new D,this.stats.setMode(0),this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement),this.hide()}show(){this.stats.domElement.style.visibility="visible"}hide(){this.stats.domElement.style.visibility="hidden"}renderStart(){this.stats.begin()}renderDone(){this.stats.end()}}class F extends E{}class B extends F{constructor(){super(b.Z.COMMAND_CANCEL_BUILD_MODE)}}class _{constructor(e,t){this.location=e,this.heading=e.clone().sub(t).angle(),e.y===t.y?this.heading-=Math.PI/2:this.heading+=Math.PI/2}}class U extends w.Z{constructor(e){super(e),this.isLocal=!1}}class W extends U{constructor(e,t){super(e),this.guiForward=!1,this.job=t}}class G extends W{constructor(e){super(b.Z.JOB_CREATE,e)}}class H extends W{constructor(e){super(b.Z.JOB_DELETE,e)}}class J extends U{constructor(e){super(b.Z.REQUESTED_RAIDERS_CHANGED),this.numRequestedRaiders=e}}class V extends U{constructor(){super(b.Z.MATERIAL_AMOUNT_CHANGED),this.numCrystal=P.numCrystal,this.usedCrystal=P.usedCrystals,this.neededCrystal=P.neededCrystals,this.totalOre=P.totalOre}}class j extends U{constructor(){super(b.Z.CAVERN_DISCOVERED)}}class Z extends U{constructor(){super(b.Z.ORE_FOUND)}}class Y{constructor(e){this.activityKey=e}}class q extends Y{}q.Stand=new q("Activity_Stand");class K extends q{}K.Short=new q("Short"),K.Expand=new q("Expand"),K.Long=new q("Long"),K.Teleport=new q("Teleport");class z extends q{}z.Route=new z("Activity_Route"),z.RunPanic=new z("Activity_RunPanic"),z.Drill=new z("Activity_Drill"),z.Walk=new z("!Activity_Walk"),z.Reinforce=new z("Activity_Reinforce"),z.Reverse=new z("!Activity_Reverse"),z.TurnLeft=new z("!Activity_TurnLeft"),z.TurnRight=new z("!Activity_TurnRight"),z.CantDo=new z("!Activity_CantDo"),z.Collect=new z("Activity_Collect"),z.Clear=new z("Activity_Clear"),z.Carry=new z("Activity_Carry"),z.CarryTurnLeft=new z("!Activity_CarryTurnLeft"),z.CarryTurnRight=new z("!Activity_CarryTurnRight"),z.CarryStand=new z("Activity_CarryStand"),z.Dynamite=new z("Activity_Dynamite"),z.Place=new z("Activity_Place"),z.Deposit=new z("!Activity_Deposit"),z.TeleportIn=new z("Activity_TeleportIn"),z.Repair=new z("Activity_Repair"),z.rest=new z("Activity_rest"),z.routeRubble=new z("!Activity_routeRubble"),z.CarryRubble=new z("!Activity_CarryRubble"),z.Eat=new z("Activity_Eat"),z.FireLaser=new z("Activity_FireLaser"),z.GetUp=new z("!Activity_GetUp"),z.ThrownByRockMonster=new z("Activity_ThrownByRockMonster"),z.Slip=new z("Activity_Slip"),z.Train=new z("Activity_Train"),z.Recharge=new z("!Activity_Recharge"),z.Waiting1=new z("Activity_Waiting1"),z.Waiting2=new z("Activity_Waiting2"),z.Waiting3=new z("Activity_Waiting3"),z.Waiting4=new z("Activity_Waiting4"),z.Hoverboard=new z("Activity_Hoverboard"),z.Standhoverboard=new z("Activity_Standhoverboard"),z.HitLefthoverboard=new z("!Activity_HitLefthoverboard"),z.HitRighthoverboard=new z("!Activity_HitRighthoverboard"),z.HitFronthoverboard=new z("!Activity_HitFronthoverboard"),z.HitBackhoverboard=new z("!Activity_HitBackhoverboard"),z.SMALLTRUCK=new z("Activity_SMALLTRUCK"),z.StandSMALLTRUCK=new z("Activity_StandSMALLTRUCK"),z.HitLeftSMALLTRUCK=new z("!Activity_HitLeftSMALLTRUCK"),z.HitRightSMALLTRUCK=new z("!Activity_HitRightSMALLTRUCK"),z.HitFrontSMALLTRUCK=new z("!Activity_HitFrontSMALLTRUCK"),z.HitBackSMALLTRUCK=new z("!Activity_HitBackSMALLTRUCK"),z.SMALLheli=new z("Activity_SMALLheli"),z.StandSMALLheli=new z("Activity_StandSMALLheli"),z.HitLeftSMALLheli=new z("!Activity_HitLeftSMALLheli"),z.HitRightSMALLheli=new z("!Activity_HitRightSMALLheli"),z.HitFrontSMALLheli=new z("!Activity_HitFrontSMALLheli"),z.HitBackSMALLheli=new z("!Activity_HitBackSMALLheli"),z.SMALLCAT=new z("Activity_SMALLCAT"),z.StandSMALLCAT=new z("Activity_StandSMALLCAT"),z.HitLeftSMALLCAT=new z("!Activity_HitLeftSMALLCAT"),z.HitRightSMALLCAT=new z("!Activity_HitRightSMALLCAT"),z.HitFrontSMALLCAT=new z("!Activity_HitFrontSMALLCAT"),z.HitBackSMALLCAT=new z("!Activity_HitBackSMALLCAT"),z.SMALLMLP=new z("Activity_SMALLMLP"),z.StandSMALLMLP=new z("Activity_StandSMALLMLP"),z.HitLeftSMALLMLP=new z("!Activity_HitLeftSMALLMLP"),z.HitRightSMALLMLP=new z("!Activity_HitRightSMALLMLP"),z.HitFrontSMALLMLP=new z("!Activity_HitFrontSMALLMLP"),z.HitBackSMALLMLP=new z("!Activity_HitBackSMALLMLP"),z.LARGECAT=new z("Activity_LARGECAT"),z.StandLARGECAT=new z("Activity_StandLARGECAT"),z.HitLeftLARGECAT=new z("!Activity_HitLeftLARGECAT"),z.HitRightLARGECAT=new z("!Activity_HitRightLARGECAT"),z.HitFrontLARGECAT=new z("!Activity_HitFrontLARGECAT"),z.HitBackLARGECAT=new z("!Activity_HitBackLARGECAT"),z.SMALLDIGGER=new z("Activity_SMALLDIGGER"),z.StandSMALLDIGGER=new z("Activity_StandSMALLDIGGER");class X{constructor(e){this.targetLocation=e}canGatherItem(){return!1}gatherItem(e){e.addToScene(null,null)}getDropAction(){return z.Place}}var $,Q,ee;!function(e){e[e.INCOMPLETE=0]="INCOMPLETE",e[e.COMPLETE=1]="COMPLETE",e[e.CANCELED=2]="CANCELED"}($||($={}));class te{constructor(e){this.fulfiller=[],this.type=e,this.jobState=$.INCOMPLETE}assign(e){const t=this.fulfiller.indexOf(e);e&&-1===t&&this.fulfiller.push(e)}unassign(e){this.fulfiller.remove(e)}cancel(){this.jobState=$.CANCELED;const e=this.fulfiller;this.fulfiller=[],e.forEach((e=>e.stopJob()))}getRequiredTool(){return null}getRequiredTraining(){return null}isReadyToComplete(){return!0}onJobComplete(){this.jobState=$.COMPLETE}setActualWorkplace(e){}getCarryItem(){return null}getWorkActivity(){return null}getWorkDuration(e){return null}}class se extends te{}!function(e){e[e.DRILL=0]="DRILL",e[e.REINFORCE=1]="REINFORCE",e[e.CLEAR_RUBBLE=2]="CLEAR_RUBBLE",e[e.CARRY=3]="CARRY",e[e.MOVE=4]="MOVE",e[e.TRAIN=5]="TRAIN",e[e.GET_TOOL=6]="GET_TOOL",e[e.EAT=7]="EAT",e[e.COMPLETE_POWER_PATH=8]="COMPLETE_POWER_PATH"}(Q||(Q={})),function(e){e[e.aiPriorityTrain=0]="aiPriorityTrain",e[e.aiPriorityGetIn=1]="aiPriorityGetIn",e[e.aiPriorityCrystal=2]="aiPriorityCrystal",e[e.aiPriorityOre=3]="aiPriorityOre",e[e.aiPriorityRepair=4]="aiPriorityRepair",e[e.aiPriorityClearing=5]="aiPriorityClearing",e[e.aiPriorityDestruction=6]="aiPriorityDestruction",e[e.aiPriorityConstruction=7]="aiPriorityConstruction",e[e.aiPriorityReinforce=8]="aiPriorityReinforce",e[e.aiPriorityRecharge=9]="aiPriorityRecharge"}(ee||(ee={}));class ie extends se{constructor(e,t){super(Q.COMPLETE_POWER_PATH),this.surface=e,this.placedItems=t,this.workplaces=[new X(e.getRandomPosition())]}onJobComplete(){super.onJobComplete(),this.placedItems.forEach((e=>e.removeFromScene())),this.surface.setSurfaceTypeAndUpdateNeighbors(d.POWER_PATH)}getRequiredTool(){return c.SHOVEL}getPriorityIdentifier(){return ee.aiPriorityConstruction}getWorkplaces(){return this.workplaces}getWorkActivity(){return z.Clear}}class re{constructor(e,t,s,i,r){var n,a;this.primarySurface=null,this.secondarySurface=null,this.primaryPathSurface=null,this.surfaces=[],this.heading=0,this.neededByType=new Map,this.assignedByType=new Map,this.onSiteByType=new Map,this.complete=!1,this.canceled=!1,this.primarySurface=e,this.primarySurface.setSite(this),this.surfaces.push(this.primarySurface),this.secondarySurface=t,null===(n=this.secondarySurface)||void 0===n||n.setSite(this),this.surfaces.push(this.secondarySurface),this.primaryPathSurface=s,null===(a=this.primaryPathSurface)||void 0===a||a.setSurfaceTypeAndUpdateNeighbors(d.POWER_PATH_BUILDING),this.surfaces.push(this.primaryPathSurface),null==i||i.setSurfaceTypeAndUpdateNeighbors(d.POWER_PATH_BUILDING),this.surfaces.push(i),this.building=r}getRandomDropPosition(){return this.primarySurface.getRandomPosition()}needs(e){return this.neededByType.getOrUpdate(e,(()=>0))>this.assignedByType.getOrUpdate(e,(()=>[])).length}assign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).push(e)}unAssign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).remove(e)}addItem(e){const t=this.neededByType.getOrUpdate(e.entityType,(()=>0));this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).length<t?(e.onAddToSite(),this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).push(e),this.checkComplete()):e.resetTarget()}checkComplete(){if(!this.complete&&!this.canceled&&(this.complete=!0,this.neededByType.forEach(((e,t)=>{this.complete=this.complete&&this.onSiteByType.getOrUpdate(t,(()=>[])).length>=e})),this.complete))if(P.buildingSites.remove(this),this.building){this.onSiteByType.getOrUpdate(i.BARRIER,(()=>[])).forEach((e=>{e.changeActivity(K.Teleport,(()=>e.removeFromScene()))})),this.onSiteByType.getOrUpdate(i.CRYSTAL,(()=>[])).forEach((e=>{e.removeFromScene()})),this.onSiteByType.getOrUpdate(i.ORE,(()=>[])).forEach((e=>{e.removeFromScene()}));const e=this.primarySurface.getCenterWorld2D();this.building.placeDown(e,-this.heading+Math.PI/2,!1)}else{const e=[];this.onSiteByType.forEach((t=>e.push(...t))),h.N.publishEvent(new G(new ie(this.primarySurface,e)))}}getDropAction(){return z.Place}cancelSite(){P.buildingSites.remove(this),this.canceled=!0,this.surfaces.forEach((e=>null==e?void 0:e.setSite(null))),this.onSiteByType.forEach((e=>e.forEach((e=>{e.worldMgr.placeMaterial(e,e.getPosition2D())})))),this.onSiteByType.clear(),this.assignedByType.forEach((e=>e.forEach((e=>{e.resetTarget()})))),h.N.publishEvent(new S)}getWalkOutSurface(){var e;return this.primaryPathSurface||this.primarySurface.neighbors.find((e=>!e.site&&e.isWalkable()))||(null===(e=this.secondarySurface)||void 0===e?void 0:e.neighbors.find((e=>!e.site&&e.isWalkable())))}}var ne,ae=s(586);!function(e){e[e.CORNER=1]="CORNER",e[e.WALL=2]="WALL",e[e.INVERTED_CORNER=3]="INVERTED_CORNER",e[e.WEIRD_CREVICE=20]="WEIRD_CREVICE"}(ne||(ne={}));class oe{static create(e,t,s,i,r,n,a,o,l){let h=0;!t.y||s.y||e!==ne.INVERTED_CORNER&&(e===ne.WALL||e===ne.WEIRD_CREVICE)!==Boolean(i.y)||(h=0),!i.y||r.y||e!==ne.INVERTED_CORNER&&(e===ne.WALL||e===ne.WEIRD_CREVICE)!==Boolean(s.y)||(h=3),!s.y||t.y||e!==ne.INVERTED_CORNER&&(e===ne.WALL||e===ne.WEIRD_CREVICE)!==Boolean(r.y)||(h=2),!r.y||i.y||e!==ne.INVERTED_CORNER&&(e===ne.WALL||e===ne.WEIRD_CREVICE)!==Boolean(t.y)||(h=1),e!==ne.WALL&&e!==ne.WEIRD_CREVICE||(t.y&&s.y&&(h=0),i.y&&r.y&&(h=3));const c=[new I.FM8(0,1),new I.FM8(1,1),new I.FM8(1,0),new I.FM8(0,0)],u=[],d=[];function g(e,t,s){u.push(e,t,s);const i=(new I.Pa4).subVectors(s,t);i.cross((new I.Pa4).subVectors(e,t)),i.normalize(),d.push(i,i,i)}const p=[];i.y===r.y&&(e!==ne.WALL&&e!==ne.WEIRD_CREVICE||i.y&&r.y)?(p.push(0,3,2),p.push(0,2,1),t.y=n,i.y=a,s.y=o,r.y=l,g(t,r,s),g(t,s,i)):(p.push(1,3,2),p.push(1,0,3),t.y=n,i.y=a,s.y=o,r.y=l,g(i,r,s),g(i,t,r));const m=p.map((e=>c[(e+h)%4])),y=new I.u9r;return y.setAttribute("position",new ae.Tl(new Float32Array(18),3).copyVector3sArray(u)),y.setAttribute("normal",new ae.Tl(new Float32Array(18),3).copyVector3sArray(d)),y.setAttribute("uv",new ae.Tl(new Float32Array(12),2).copyVector2sArray(m)),y}}class le extends I.Kj0{constructor(e,t){super(le.geometry,new I.xoR({shininess:0,transparent:!0,opacity:.4,color:t})),this.sceneMgr=e,this.standardColor=t,this.visible=!1}updateState(e,t,s){this.visible=!!e,e&&this.position.set(e.x,0,e.y).multiplyScalar(C.pM).applyAxisAngle(new I.Pa4(0,1,0),-t+Math.PI/2).add(s)}markAsValid(e){const t=e?this.standardColor:5242880;this.material.color.setHex(t)}get surface(){return this.visible?this.sceneMgr.terrain.getSurfaceFromWorld(this.position):null}}le.geometry=oe.create(ne.WALL,new I.Pa4(0,0,0),new I.Pa4(C.pM,0,C.pM),new I.Pa4(C.pM,0,0),new I.Pa4(0,0,C.pM),1,1,1,1);class he{constructor(e){this.group=new I.ZAu,this.markers=[],this.buildingMarkerPrimary=null,this.buildingMarkerSecondary=null,this.powerPathMarkerPrimary=null,this.powerPathMarkerSecondary=null,this.waterPathMarker=null,this.heading=0,this.sdx=0,this.sdz=0,this.lastCheck=!1,this.sceneMgr=e,this.buildingMarkerPrimary=new le(this.sceneMgr,he.buildingMarkerColor),this.buildingMarkerSecondary=new le(this.sceneMgr,he.buildingMarkerColor),this.powerPathMarkerPrimary=new le(this.sceneMgr,he.pathMarkerColor),this.powerPathMarkerSecondary=new le(this.sceneMgr,he.pathMarkerColor),this.waterPathMarker=new le(this.sceneMgr,he.waterMarkerColor),this.addMarker(this.buildingMarkerPrimary),this.addMarker(this.buildingMarkerSecondary),this.addMarker(this.powerPathMarkerPrimary),this.addMarker(this.powerPathMarkerSecondary),this.addMarker(this.waterPathMarker)}addMarker(e){this.group.add(e),this.markers.push(e)}update(e){if(e&&P.buildModeSelection){const t=this.updateAllMarker(e);this.markers.forEach((e=>e.markAsValid(t)))}else this.hideAllMarker()}updateAllMarker(e=null){this.buildingMarkerPrimary.visible=!0,this.buildingMarkerPrimary.position.copy(this.sceneMgr.getFloorPosition(new I.FM8(Math.floor(e.x/C.pM)*C.pM,Math.floor(e.y/C.pM)*C.pM)));const t=e.x-this.buildingMarkerPrimary.position.x-C.pM/2,s=e.y-this.buildingMarkerPrimary.position.z-C.pM/2,i=Math.abs(t)>Math.abs(s)?Math.sign(t):0,r=Math.abs(s)>Math.abs(t)?Math.sign(s):0;if(this.sdx===i&&this.sdz===r)return this.lastCheck;this.sdx=i,this.sdz=r,this.heading=Math.atan2(r,i),this.buildingMarkerSecondary.updateState(P.buildModeSelection.secondaryBuildingPart,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerPrimary.updateState(P.buildModeSelection.primaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerSecondary.updateState(P.buildModeSelection.secondaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.waterPathMarker.updateState(P.buildModeSelection.waterPathSurface,this.heading,this.buildingMarkerPrimary.position);const n=[this.buildingMarkerPrimary,this.buildingMarkerSecondary,this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].filter((e=>e.visible)).map((e=>this.sceneMgr.terrain.getSurfaceFromWorld(e.position))).every((e=>e.surfaceType===d.GROUND));return this.lastCheck=n&&([this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].some((e=>e.visible&&e.surface.neighbors.some((e=>e.surfaceType===d.POWER_PATH))))||!P.buildModeSelection.primaryPowerPath&&this.buildingMarkerPrimary.surface.neighbors.some((e=>e.surfaceType===d.POWER_PATH||this.buildingMarkerSecondary.visible&&this.buildingMarkerSecondary.surface.neighbors.some((e=>e.surfaceType===d.POWER_PATH)))))&&(!this.waterPathMarker.visible||this.waterPathMarker.surface.surfaceType===d.WATER),this.lastCheck}hideAllMarker(){this.markers.forEach((e=>e.visible=!1)),this.lastCheck=!1}createBuildingSite(){const e=this.getBarrierLocations(),t=P.buildModeSelection.stats,s=(null==t?void 0:t.CostCrystal)||0,r=(null==t?void 0:t.CostOre)||0,n=this.buildingMarkerPrimary.surface,a=new re(n,this.buildingMarkerSecondary.surface,this.powerPathMarkerPrimary.surface,this.powerPathMarkerSecondary.surface,P.buildModeSelection);a.heading=this.heading,a.neededByType.set(i.BARRIER,e.length),a.neededByType.set(i.CRYSTAL,s),a.neededByType.set(i.ORE,r),P.buildingSites.push(a);const o=P.getClosestBuildingByType(n.getCenterWorld(),i.TOOLSTATION);o&&(o.spawnBarriers(e,a),o.spawnMaterials(i.CRYSTAL,s),o.spawnMaterials(i.ORE,r)),h.N.publishEvent(new S),h.N.publishEvent(new B)}getBarrierLocations(){const e=[],t=this.buildingMarkerPrimary.surface.getCenterWorld2D(),s=9*C.pM/20;if(this.buildingMarkerSecondary.visible){const i=this.buildingMarkerSecondary.surface.getCenterWorld2D(),r=Math.sign(i.x-t.x),n=Math.sign(i.y-t.y);0!==r?(e.push(new _(new I.FM8(t.x-r*s,t.y),t)),e.push(new _(new I.FM8(t.x,t.y-s),t)),e.push(new _(new I.FM8(t.x,t.y+s),t)),e.push(new _(new I.FM8(i.x+r*s,i.y),i)),e.push(new _(new I.FM8(i.x,i.y-s),i)),e.push(new _(new I.FM8(i.x,i.y+s),i))):(e.push(new _(new I.FM8(t.x,t.y-n*s),t)),e.push(new _(new I.FM8(t.x-s,t.y),t)),e.push(new _(new I.FM8(t.x+s,t.y),t)),e.push(new _(new I.FM8(i.x,i.y+n*s),i)),e.push(new _(new I.FM8(i.x-s,i.y),i)),e.push(new _(new I.FM8(i.x+s,i.y),i)))}else e.push(new _(new I.FM8(t.x-s,t.y),t)),e.push(new _(new I.FM8(t.x,t.y-s),t)),e.push(new _(new I.FM8(t.x+s,t.y),t)),e.push(new _(new I.FM8(t.x,t.y+s),t));return e}}function ce(e){let t=e;const s=[];for(;t.parent;)s.unshift(t),t=t.parent;return s}he.buildingMarkerColor=20480,he.pathMarkerColor=5263360,he.waterMarkerColor=80;const ue={search(e,t,s,i=null){e.cleanDirty();const r=(i=i||{}).heuristic||ue.heuristics.manhattan,n=i.closest||!1,a=new pe((function(e){return e.f}));let o=t;for(t.h=r(t,s),e.markDirty(t),a.push(t);a.size()>0;){const t=a.pop();if(t===s)return ce(t);t.closed=!0;const i=e.neighbors(t);let l=0;const h=i.length;for(;l<h;++l){const h=i[l];if(h.closed||h.isWall())continue;const c=t.g+h.getCost(t),u=h.visited;(!u||c<h.g)&&(h.visited=!0,h.parent=t,h.h=h.h||r(h,s),h.g=c,h.f=h.g+h.h,e.markDirty(h),n&&(h.h<o.h||h.h===o.h&&h.g<o.g)&&(o=h),u?a.rescoreElement(h):a.push(h))}}return n?ce(o):[]},heuristics:{manhattan:(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),diagonal(e,t){const s=Math.sqrt(2),i=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return 1*(i+r)+(s-2)*Math.min(i,r)}},cleanNode(e){e.f=0,e.g=0,e.h=0,e.visited=!1,e.closed=!1,e.parent=null}};class de{constructor(e,t=null){this.nodes=[],this.grid=[],this.dirtyNodes=[],t=t||{},this.diagonal=!!t.diagonal;for(let t=0;t<e.length;t++){this.grid[t]=[];let s=0;const i=e[t];for(;s<i.length;s++){const e=new ge(t,s,i[s]);this.grid[t][s]=e,this.nodes.push(e)}}this.init()}init(){this.dirtyNodes=[];for(let e=0;e<this.nodes.length;e++)ue.cleanNode(this.nodes[e])}cleanDirty(){for(let e=0;e<this.dirtyNodes.length;e++)ue.cleanNode(this.dirtyNodes[e]);this.dirtyNodes=[]}markDirty(e){this.dirtyNodes.push(e)}neighbors(e){const t=[],s=e.x,i=e.y,r=this.grid;return r[s-1]&&r[s-1][i]&&t.push(r[s-1][i]),r[s+1]&&r[s+1][i]&&t.push(r[s+1][i]),r[s]&&r[s][i-1]&&t.push(r[s][i-1]),r[s]&&r[s][i+1]&&t.push(r[s][i+1]),this.diagonal&&(r[s-1]&&r[s-1][i-1]&&t.push(r[s-1][i-1]),r[s+1]&&r[s+1][i-1]&&t.push(r[s+1][i-1]),r[s-1]&&r[s-1][i+1]&&t.push(r[s-1][i+1]),r[s+1]&&r[s+1][i+1]&&t.push(r[s+1][i+1])),t}toString(){const e=[],t=this.grid;for(let s=0;s<t.length;s++){const i=[],r=t[s];for(let e=0;e<r.length;e++)i.push(r[e].weight);e.push(i.join(" "))}return e.join("\n")}}class ge{constructor(e,t,s){this.x=e,this.y=t,this.weight=s}toString(){return"["+this.x+" "+this.y+"]"}getCost(e){return e&&e.x!=this.x&&e.y!=this.y?1.41421*this.weight:this.weight}isWall(){return 0===this.weight}}class pe{constructor(e){this.content=[],this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.sinkDown(this.content.length-1)}pop(){const e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e}remove(e){const t=this.content.indexOf(e),s=this.content.pop();t!==this.content.length-1&&(this.content[t]=s,this.scoreFunction(s)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))}size(){return this.content.length}rescoreElement(e){this.sinkDown(this.content.indexOf(e))}sinkDown(e){const t=this.content[e];for(;e>0;){const s=(e+1>>1)-1,i=this.content[s];if(!(this.scoreFunction(t)<this.scoreFunction(i)))break;this.content[s]=t,this.content[e]=i,e=s}}bubbleUp(e){const t=this.content.length,s=this.content[e],i=this.scoreFunction(s);for(;;){const r=e+1<<1,n=r-1;let a,o=null;if(n<t){const e=this.content[n];a=this.scoreFunction(e),a<i&&(o=n)}if(r<t){const e=this.content[r];this.scoreFunction(e)<(null===o?i:a)&&(o=r)}if(null===o)break;this.content[e]=this.content[o],this.content[o]=s,e=o}}}var me=s(309),ye=s(768);class fe extends U{constructor(e,t){super(e),this.location=t}}class ve extends fe{constructor(e){super(b.Z.LOCATION_CRYSTAL_FOUND,e)}}class be extends fe{constructor(e){super(b.Z.LOCATION_LANDSLIDE,e)}}class we extends fe{constructor(e){super(b.Z.LOCATION_RAIDER_DISCOVERED,e)}}class Ee{constructor(){this.looping=!1,this.transcoef=1,this.firstFrame=null,this.lastFrame=null,this.framesPerSecond=null,this.bodies=[]}}var Se=I.M8C.degToRad;class Te{constructor(){this.name="",this.filename="",this.pivot=new I.Pa4(0,0,0),this.relPos=[],this.relRot=[],this.relScale=[],this.opacity=[],this.parentObjInd=null,this.model=null}radVec(e,t,s){return new I.USm(Se(t),Se(e),Se(s),"YXZ")}setFrameAndFollowing(e,t,s){this.relPos[e]=new I.Pa4(s[0],s[1],s[2]),this.relRot[e]=this.radVec(s[3],s[4],s[5]),this.relScale[e]=new I.Pa4(s[6],s[7],s[8]);for(let s=e;s<=t;s++)this.relPos[s]=this.relPos[e],this.relRot[s]=this.relRot[e],this.relScale[s]=this.relScale[e]}setOpacityAndFollowing(e,t,s){for(let i=e;i<=t;i++)this.opacity[i]=s}}class Re{constructor(e,t){this.mesh=null,this.textureSequences=[],this.mesh=e,this.textureSequences=t}dispose(){var e;this.textureSequences.forEach((e=>(0,l.nJ)(e))),this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach((e=>e.dispose())):null===(e=this.mesh.material)||void 0===e||e.dispose()}}const Ae=1448366670;function Le(e,t){let s=new I.Pa4;return s.x=e.getFloat32(t),s.y=e.getFloat32(t+4),s.z=e.getFloat32(t+8),s}class Me{constructor(e,t=!1){this.path="",this.verbose=!1,this.materials=[],this.geometry=new I.u9r,this.vertices=null,this.indices=null,this.uvs=null,this.sequenceIntervals=[],this.path=e,this.verbose=t,this.verbose&&console.log("LWO path: "+this.path)}parsePoints(e,t,s){if(s%12!=0)return void console.error("LWOLoader.parse: F12 does not evenly divide into chunk size ("+s+"). Possible corruption.");let i=s/4/3;this.vertices=new Float32Array(3*i),this.uvs=new Float32Array(2*i);for(let s=0;s<i;s++){let i=3*s,r=4*i;this.vertices[i]=e.getFloat32(t+r),this.vertices[i+1]=e.getFloat32(t+r+4),this.vertices[i+2]=e.getFloat32(t+r+8)}}parseSurfaceNames(e,t,s){let i=(new TextDecoder).decode(new Uint8Array(e,t,s)).split("\0").filter((function(e){return""!==e}));for(let e=0;e<i.length;e++){const t=new I.xoR;t.name=i[e],t.side=I.ehD,t.alphaToCoverage=!0,this.materials.push(t)}this.verbose&&console.log("LWO contains "+this.materials.length+" materials with following names: "+i)}parsePolygons(e,t,s){let i=0,r=0;for(;r<s;){const s=e.getInt16(t+r),n=e.getInt16(t+r+2+2*s);this.geometry.addGroup(i,3*(s-2),n-1),i+=3*(s-2),r+=4+2*s}r=0;let n=0;for(this.indices=new Uint16Array(i);r<s;){let s=e.getInt16(t+r);r+=2;let i=new Int16Array(s);for(let n=0;n<=s;n++)i[n]=e.getInt16(t+r+2*n);for(let e=0;e<s-2;e++)this.COUNTER_CLOCKWISE?(this.indices[n++]=i[0],this.indices[n++]=i[e+2],this.indices[n++]=i[e+1]):(this.indices[n++]=i[0],this.indices[n++]=i[e+1],this.indices[n++]=i[e+2]);r+=2+2*s}}parseSurface(e,t,s,i){let r=0;for(;0!==e.getUint8(s+r);)r++;let n=(0,l.v5)(new Uint8Array(t,s,r));this.verbose&&console.log("Parsing surface: "+n);let a=-1,o=null,h=0,c=new I.Pa4(0,0,0),u=new I.Pa4(0,0,0);for(let e=0;e<this.materials.length;e++)this.materials[e].name===n&&(a=e,o=this.materials[e]);if(o){for(o.shininess=0;r<i;){const i=s+r;if(0===e.getUint8(i))r++;else{const s=e.getInt32(i),n=e.getInt16(i+4);switch(this.verbose&&console.log("Parsing subchunk "+(new TextDecoder).decode(new Uint8Array(t,i,4))+" at "+i+"; length "+n),s){case 1129270354:const r=[e.getUint8(i+6+0)/255,e.getUint8(i+6+1)/255,e.getUint8(i+6+2)/255];o.color=(new I.Ilk).fromArray(r),this.verbose&&console.log("Material color (COLR): "+r.join(" "));break;case 1179402567:const a=e.getUint16(i+6);this.verbose&&console.log("Flags (FLAG): "+a.toString(2)),this.verbose&&2&a&&console.warn("Flag is set but unhandled: outline"),this.verbose&&4&a&&console.warn("Flag is set but unhandled: smoothing"),this.verbose&&8&a&&console.warn("Flag is set but unhandled: colorHighlights"),this.verbose&&16&a&&console.warn("Flag is set but unhandled: colorFilter"),this.verbose&&32&a&&console.warn("Flag is set but unhandled: opaqueEdge"),this.verbose&&64&a&&console.warn("Flag is set but unhandled: transparentEdge"),this.verbose&&128&a&&console.warn("Flag is set but unhandled: sharpTerminator"),256&a&&(o.side=I.ehD),512&a&&(o.blending=I.WMw,o.depthWrite=!1),this.verbose&&1024&a&&console.warn("Flag is set but unhandled: shadowAlpha");break;case 1162102597:const d=e.getFloat32(i+6);this.verbose&&console.warn("Edge transparency threshold (0.0 to 1.0): "+d);break;case 1280658761:const g=e.getInt16(i+6)/256;this.verbose&&console.log("Luminosity (LUMI): "+g),o.emissiveIntensity=g;break;case 1145652806:const p=e.getInt16(i+6)/256;this.verbose&&console.log("Diffuse (DIFF): "+p),p||(o.color=null);break;case 1397769539:const m=e.getInt16(i+6)/256;this.verbose&&console.warn("Specular (SPEC): "+m);break;case 1380271692:let y=0;y=1447449164===y?e.getFloat32(i+6):e.getInt16(i+6)/256,o.reflectivity=y,this.verbose&&console.log("Reflectivity (REFL): "+o.reflectivity);break;case 1414676814:case Ae:let f=0;f=s===Ae?e.getFloat32(i+6):e.getInt16(i+6)/256,o.opacity=1-f,this.verbose&&console.log("Opacity (TRAN/VTRN): "+o.opacity),o.transparent=o.transparent||o.opacity<1;break;case 1447843149:const v=e.getFloat32(i+6);this.verbose&&console.log("Luminosity (VLUM): "+v),o.emissiveIntensity=v;break;case 1447315782:let b=e.getFloat32(i+6);this.verbose&&console.log("Diffuse (VDIF): "+b);break;case 1448300611:let w=e.getFloat32(i+6);this.verbose&&console.warn("Specular (VSPC): "+w);break;case 1413893191:h=e.getUint16(i+6),this.verbose&&console.log("Flags (TFLG): "+h.toString(2)),this.verbose&&1&h&&console.warn("Flag is set but unhandled: X Axis"),this.verbose&&2&h&&console.warn("Flag is set but unhandled: Y Axis"),this.verbose&&4&h&&console.warn("Flag is set but unhandled: Z Axis"),this.verbose&&8&h&&console.warn("Flag is set but unhandled: World Coords"),this.verbose&&16&h&&console.warn("Flag is set but unhandled: Negative Image"),this.verbose&&32&h&&console.warn("Flag is set but unhandled: Pixel Blending"),this.verbose&&64&h&&console.log("Flag is set: Antialiasing");break;case 1414744410:c=Le(e,i+6),this.verbose&&console.warn("Texture size (TSIZ): "+c.toArray().join(" "));break;case 1413698642:u=Le(e,i+6),this.verbose&&console.warn("Texture center (TCTR): "+u.toArray().join(" "));break;case 1129596248:case 1146373464:case 1398031704:case 1381254488:case 1414808920:case 1112819032:const E=(0,l.jG)(new Uint8Array(t,i+6,n));this.verbose&&console.log("Texture typename: "+E);break;case 1413696594:const S=e.getUint16(i+6)/256;this.verbose&&console.warn("Texture value (TVAL): "+S);break;case 1413696594:const T=[e.getUint8(i+6+0)/255,e.getUint8(i+6+1)/255,e.getUint8(i+6+2)/255,e.getUint8(i+6+3)/255];this.verbose&&console.log("Texture color (TCLR): "+T.join(" "));break;case 1414090055:let R=(0,l.jG)(new Uint8Array(t,i+6,n));if(this.verbose&&console.log("Texture filepath (TIMG): "+R),"(none)"===R)break;let A=!1;R.endsWith(" (sequence)")&&(A=!0,R=R.substring(0,R.length-" (sequence)".length));let L=(0,l.vt)(R);o.transparent=o.transparent||!!L.match(/^a\d+.+.bmp/i);const M=this.path+L;if(A){const e=M.match(/(.+\D)0+(\d+)\..+/),t=tt.filterTextureSequenceNames(e[1]).map((e=>tt.getTexture(e)));if(t){let e=0;o.color=null,this.sequenceIntervals.push(setInterval((()=>{o.map=t[e++],e>=t.length&&(e=0)}),1e3/C.a4))}}const P=M.toLowerCase();if("miscanims/barrier/a_side.bmp"===P||"miscanims/barrier/a_top.bmp"===P||"world/shared/teofoilreflections.jpg"===P||"buildings/barracks/wingbase3.bmp"===P)break;o.map=tt.getTexture(M),o.color=null;break;default:this.verbose&&console.warn("Found unrecognised SURF subchunk type "+(new TextDecoder).decode(new Uint8Array(t,i,4))+" at "+i+"; length "+n)}r+=6+n}}!function(e,t,s,i,r,n,a,o){if(7&o)for(let l of e.groups)if(l.materialIndex===r)for(let e=l.start;e<l.start+l.count;e++){let r=3*i[e],l=t[r]-a.x,h=t[r+1]-a.y,c=t[r+2]-a.z,u=2*i[e],d=0,g=0;1&o?(d=c/n.z+.5,g=h/n.y+.5):2&o?(d=l/n.x+.5,g=c/n.z+.5):4&o&&(d=l/n.x+.5,g=h/n.y+.5),s[u]=d,s[u+1]=g}}(this.geometry,this.vertices,this.uvs,this.indices,a,c,u,h)}else console.error("LWOLoader.parse: Surface in SURF chunk does not exist in SRFS")}parse(e){const t=new DataView(e);if(1179603533!==t.getUint32(0))return void console.error("LWOLoader.parse: Cannot find header.");const s=t.getUint32(4);if(s+8!==t.byteLength&&console.warn("LWOLoader.parse: Discrepancy between size in header ("+(s+8)+" bytes) and actual size ("+t.byteLength+" bytes)."),1280790338!==t.getUint32(8)){const t=(0,l.v5)(new Uint8Array(e,8,4));return void console.error("LWOLoader.parse: Invalid magic ID ("+t+") in LWO header.")}let i=12;for(;i<t.byteLength;)if(0===t.getUint8(i))i++;else{const s=t.getInt32(i),r=t.getInt32(i+4);switch(i+=8,s){case 1347310675:this.parsePoints(t,i,r);break;case 1397900883:this.parseSurfaceNames(e,i,r);break;case 1347374163:this.parsePolygons(t,i,r);break;case 1398100550:this.parseSurface(t,e,i,r);break;default:console.warn("Found unrecognised chunk type "+(0,l.v5)(new Uint8Array(e,i-8,4))+" at "+i)}i+=r}return this.geometry.setAttribute("position",new I.TlE(this.vertices,3)),this.geometry.setAttribute("uv",new I.TlE(this.uvs,2)),this.geometry.setIndex(new I.TlE(this.indices,1)),this.geometry.computeVertexNormals(),new Re(new I.Kj0(this.geometry,this.materials),this.sequenceIntervals)}}class Ce{constructor(e,t=!1){this.path="",this.verbose=!1,this.animationClip=new Ee,this.lines=[],this.lineIndex=0,this.path=e,this.verbose=t,this.verbose&&console.log("Using verbose mode")}parse(e){if(this.lines=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((e=>e.trim())),"LWSC"!==this.lines[0])throw"Invalid start of file! Expected 'LWSC' in first line";const t=parseInt(this.lines[1],10);for(1!==t&&console.warn("Unexpected scene file version: "+t),this.lineIndex=2;this.lineIndex<this.lines.length;this.lineIndex++){let e=this.lines[this.lineIndex];if(!e)continue;const t=e.split(" ")[0];"FirstFrame"===t?this.parseFrameBlock():"AddNullObject"===t||"LoadObject"===t?(this.parseObjectBlock(),this.verbose&&console.log(this.animationClip.bodies[this.animationClip.bodies.length-1])):e.startsWith("PreviewFirstFrame ")||e.startsWith("PreviewLastFrame ")||e.startsWith("PreviewFrameStep ")}return this.verbose&&console.log(this.animationClip),this.animationClip}parseLine(e){const t=e.split(" ").filter((e=>""!==e));return[t.shift(),t.join(" ")]}parseFrameBlock(){for(;this.lineIndex<this.lines.length;this.lineIndex++){const e=this.lines[this.lineIndex];if(!e)return;const[t,s]=this.parseLine(e);if("FirstFrame"===t)this.animationClip.firstFrame=parseInt(s);else if("LastFrame"===t)this.animationClip.lastFrame=parseInt(s);else if("FrameStep"===t){const e=parseInt(s);1!==e&&console.error("Animation frameStep has unexpected value: "+e)}else"FramesPerSecond"===t?this.animationClip.framesPerSecond=parseInt(s):"PreviewFirstFrame"===t||"PreviewLastFrame"===t||"PreviewFrameStep"===t||console.warn("Unexpected key in frame block")}console.error("Parsing block reached content end")}parseObjectBlock(){const e=new Te;for(this.animationClip.bodies.push(e);this.lineIndex<this.lines.length;this.lineIndex++){let t=this.lines[this.lineIndex];if(!t)return;const[s,i]=this.parseLine(t);if("AddNullObject"===s||"LoadObject"===s)if("LoadObject"===s){const t=(0,l.vt)(i);e.name=t.slice(0,t.length-".lwo".length),e.filename=this.path+t;const s=tt.getResource(e.filename);e.model=ze.registerMesh(new Me(this.path).parse(s))}else{if("AddNullObject"!==s)throw"Unexpected line: "+t;e.name=i,e.model=new I.ZAu}else if("ObjectMotion"===s){let t=this.lines[++this.lineIndex];const s=parseInt(t);t=this.lines[++this.lineIndex];const i=parseInt(t);this.lineIndex++;for(let t=0;t<i;t++){let i=this.lines[this.lineIndex+2*t];if(i.startsWith("EndBehavior"))break;const r=i.split(" ").map(Number);r.length!==s&&console.warn("Number of infos ("+r.length+") does not match if specified count ("+s+")"),i=this.lines[this.lineIndex+2*t+1];const n=parseInt(i.split(" ")[0]);e.setFrameAndFollowing(n,this.animationClip.lastFrame,r)}this.lineIndex+=2*i}else if("ParentObject"===s)e.parentObjInd=Number(i)-1,this.verbose&&console.log("parent obj ind is: "+e.parentObjInd);else if("ShowObject"===s||"LockedChannels"===s);else if("ShadowOptions"===s);else if("ObjDissolve"===s)if("(envelope)"==i){let t=this.lines[++this.lineIndex];const s=parseInt(t);1!==s&&console.error("Number of information channels for opacity is not 1, but: "+s),t=this.lines[++this.lineIndex];const i=parseInt(t);this.lineIndex++;for(let t=0;t<i;t++){let s=this.lines[this.lineIndex+2*t];if(s.startsWith("EndBehavior"))break;const i=1-Number(s);s=this.lines[this.lineIndex+2*t+1];const r=Number(s.split(" ")[0]);e.setOpacityAndFollowing(r,this.animationClip.lastFrame,i)}this.lineIndex+=2*i}else{const t=1-Number(i);e.setOpacityAndFollowing(0,this.animationClip.lastFrame,t)}else"PivotPoint"===s?e.pivot=(new I.Pa4).fromArray(i.split(" ").map((e=>Number(e)))):this.verbose&&console.warn("Unhandled line in object block: "+t+"; key: "+s+"; value: "+i)}return console.error("Parsing block reached content end"),e}}class Pe extends class{constructor(e,t,s,i){this.group=new I.ZAu,this.superType=null,this.entityType=null,this.level=0,this.floorOffset=0,this.worldMgr=e,this.sceneMgr=t,this.superType=s,this.entityType=i}get stats(){return null}getPosition(){return this.group.position.clone()}getPosition2D(){return new I.FM8(this.group.position.x,this.group.position.z)}getHeading(){return this.group.rotation.y}onDiscover(){this.group.visible=!0}addToScene(e,t){e&&(this.group.position.copy(this.sceneMgr.getFloorPosition(e)),this.group.position.y+=this.floorOffset),null!=t&&this.group.rotateOnAxis(new I.Pa4(0,1,0),t),this.group.visible=this.surfaces.some((e=>e.discovered)),this.sceneMgr.scene.add(this.group)}removeFromScene(){this.sceneMgr.scene.remove(this.group)}get surfaces(){return[this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position)]}}{constructor(e,t,s,i,r){super(e,t,s,i),this.animationEntityType=null,this.poly=[],this.animation=null,this.animationTimeout=null,this.selectionFrame=null,this.pickSphere=null,this.carryJoint=null,this.depositJoint=null,this.getToolJoint=null,this.activity=null,this.radiusSq=0,r&&(this.animationEntityType=tt.getAnimationEntityType(r))}beamUp(){h.N.publishEvent(new S),this.changeActivity(),Pe.moveUp(this,6*C.pM),this.playPositionalSample(me.d.SND_TeleUp)}static moveUp(e,t){t>0?(t--,e.group.position.y+=C.pM/C.OK/2,setTimeout((()=>Pe.moveUp(e,t)),1e3/C.OK)):e.removeFromScene()}changeActivity(e=this.getDefaultActivity(),t=null,s=null){if(this.activity===e||null===this.animationEntityType)return;this.activity=e;let i=e.activityKey.toLowerCase(),r=this.animationEntityType.activities.get(i);if(r||this.animationEntityType.activities.forEach(((e,t)=>{!r&&i.startsWith(t)&&(r=e)})),!(null==r?void 0:r.animation))return console.warn("Activity "+e.activityKey+" unknown or has no animation defined"),void console.log(this.animationEntityType.activities);t&&t.bind(this),this.animation=r.animation,this.animation.looping=!0,this.animationTimeout=(0,l.L4)(this.animationTimeout),this.group.remove(...this.poly),this.poly=[];const n=this.carryJoint&&this.carryJoint.children||[];this.carryJoint=null,this.animation.bodies.forEach((e=>{let t=(0,l.hh)(this.animationEntityType.highPoly,e.name);t||(t=(0,l.hh)(this.animationEntityType.mediumPoly,e.name)),t||(t=e.model);const s=t.clone(!0);this.poly.push(s),e.name&&(e.name.equalsIgnoreCase(this.animationEntityType.carryNullName)?(this.carryJoint=s,n.length>0&&this.carryJoint.add(...n)):e.name.equalsIgnoreCase(this.animationEntityType.depositNullName)?this.depositJoint=s:e.name.equalsIgnoreCase(this.animationEntityType.toolNullName)&&(this.getToolJoint=s))})),this.animation.bodies.forEach(((e,t)=>{const s=this.poly[t],i=e.parentObjInd;null!=i?this.poly[i].add(s):this.group.add(s)}));const a=new I.aLr;(new I.ZzF).setFromObject(this.group).getBoundingSphere(a),this.radiusSq=a.radius*a.radius,this.animate(0,t,s)}animate(e,t,s){if(this.poly.length!==this.animation.bodies.length)throw"Cannot animate poly. Length differs from bodies length";this.animation.bodies.forEach(((t,s)=>{const i=this.poly[s];if(i.position.copy(t.relPos[e]).sub(t.pivot),i.rotation.copy(t.relRot[e]),i.scale.copy(t.relScale[e]),i.hasOwnProperty("material")){const s=i.material,r=t.opacity[e];s&&void 0!==r&&(Array.isArray(s)?s:[s]).forEach((e=>{e.opacity=r,e.transparent=e.transparent||e.opacity<1}))}})),this.animationTimeout=(0,l.L4)(this.animationTimeout);let i=e+1;if(i<=this.animation.lastFrame||!t||null!==s&&s>0){i>this.animation.lastFrame&&(i=this.animation.firstFrame);const e=1e3/this.animation.framesPerSecond*this.animation.transcoef;null!==s&&(s-=e);const r=this,n=null!==s?Math.max(0,Math.min(s,e)):e;this.animationTimeout=setTimeout((()=>r.animate(i,t,s)),n)}else t&&t()}getDefaultActivity(){return q.Stand}createPickSphere(){if(this.pickSphere)return;const e=this.stats.PickSphere,t=e/2,s=new I.xo$(t,t,t),i=new I.vBJ({color:16776960,visible:!1});this.pickSphere=new I.Kj0(s,i),this.pickSphere.userData={selectable:this};const r=this.getPickSphereCenter();this.pickSphere.position.copy(r),this.group.add(this.pickSphere),this.createSelectionFrame(e,r)}getPickSphereCenter(){return this.getBoundingBoxCenter()}getBoundingBoxCenter(){const e=new I.Pa4;return(new I.ZzF).setFromObject(this.group).getCenter(e),e.sub(this.group.position),e.applyMatrix4((new I.yGw).makeScale(-1,1,1)),e}createSelectionFrame(e,t){const s=128,i=(0,x.kr)(s,s);i.fillStyle="#0f0";const r=Math.round(50/e),n=21.333333333333332;i.fillRect(0,0,n,r),i.fillRect(0,0,r,n),i.fillRect(106.66666666666667,0,n,r),i.fillRect(s-r,0,r,n),i.fillRect(s-r,106.66666666666667,r,n),i.fillRect(106.66666666666667,s-r,n,r),i.fillRect(0,s-r,n,r),i.fillRect(0,106.66666666666667,r,n);const a=new I.ROQ(i.canvas),o=new I.xeV({map:a,depthTest:!1});this.selectionFrame=new I.jyi(o),this.selectionFrame.position.copy(t);const l=e;this.selectionFrame.scale.set(l,l,l),this.selectionFrame.visible=!1,this.group.add(this.selectionFrame)}playPositionalSample(e,t=!1){const s=new I.VYz(this.sceneMgr.listener);return s.setRefDistance(2*C.pM),s.loop=t,this.group.add(s),ye.P.getSampleBuffer(e).then((e=>{s.setBuffer(e).play()})),s}playPositionalSfxName(e,t=!1){const s=new I.VYz(this.sceneMgr.listener);return s.setRefDistance(2*C.pM),s.loop=t,this.group.add(s),ye.P.getSound(e).then((e=>{s.setBuffer(e).play()})),s}removeFromScene(){super.removeFromScene(),this.animationTimeout=(0,l.L4)(this.animationTimeout)}}class Ie extends se{constructor(e){super(Q.CARRY),this.actualTarget=null,this.item=e}getWorkplaces(){return this.item.getCarryTargets()}getPriorityIdentifier(){return this.item.getPriorityIdentifier()}setActualWorkplace(e){var t;this.item.setTargetSite(null===(t=e)||void 0===t?void 0:t.site),this.actualTarget=e}getCarryItem(){return this.item}getWorkActivity(){return this.actualTarget.getDropAction()}isReadyToComplete(){return this.actualTarget.canGatherItem()}onJobComplete(){super.onJobComplete();const e=this.actualTarget.targetLocation;this.fulfiller.forEach((t=>{t.group.lookAt(new I.Pa4(e.x,t.group.position.y,e.y)),t.dropItem(),this.item.group.position.copy(this.item.sceneMgr.getFloorPosition(e))})),this.actualTarget.gatherItem(this.item)}}class xe extends q{}xe.Teleport=new xe("Activity_Teleport"),xe.Deposit=new xe("Activity_Deposit"),xe.Explode=new xe("Activity_Explode"),xe.Unpowered=new xe("Activity_Unpowered");class Oe extends X{constructor(e){super(e)}canGatherItem(){return!0}gatherItem(e){e.addToScene(null,null)}getDropAction(){return z.Place}isInvalid(){return!1}}class Ne extends Oe{constructor(e,t){super(e),this.site=t}gatherItem(e){this.site.addItem(e)}getDropAction(){return this.site.getDropAction()}isInvalid(){return this.site.complete||this.site.canceled}}class De extends Oe{constructor(e){super(e.getDropPosition2D()),this.building=e}canGatherItem(){return this.building.activity.activityKey===this.building.getDefaultActivity().activityKey}gatherItem(e){this.building.entityType===i.POWER_STATION||this.building.entityType===i.ORE_REFINERY?(this.building.carryJoint&&(this.building.carryJoint.add(e.group),e.group.position.set(0,0,0)),this.building.changeActivity(xe.Deposit,(()=>{this.building.changeActivity(),this.building.carryJoint&&this.building.carryJoint.remove(e.group),De.addItemToStorage(e)}))):(e.removeFromScene(),De.addItemToStorage(e))}static addItemToStorage(e){switch(e.entityType){case i.CRYSTAL:P.numCrystal++;break;case i.ORE:P.numOre++}h.N.publishEvent(new V)}getDropAction(){return this.building.getDropAction()}isInvalid(){return!this.building.isUsable()}}class ke extends Pe{constructor(e,t,s,n=null){super(e,t,r.MATERIAL,s,n),this.targetBuildingTypes=[],this.priorityIdentifier=null,this.targets=[],this.targetSite=null,this.positionPathTarget=null,this.targetBuildingTypes=[i.TOOLSTATION]}getCarryTargets(){return this.updateTargets()}resetTarget(){this.targets=[],this.targetSite=null,this.updateTargets()}updateTargets(){if(this.targets.length<1){const e=P.buildingSites.filter((e=>e.needs(this.entityType)));if(e.length>0)this.targets=e.map((e=>new Ne(e.getRandomDropPosition(),e)));else{const e=P.getBuildingsByType(...this.getTargetBuildingTypes());e.length>0&&(this.targets=e.map((e=>new De(e))))}}else this.targets.some((e=>e.isInvalid()))&&this.resetTarget();return this.targets}onDiscover(){super.onDiscover(),P.materialsUndiscovered.remove(this),P.materials.push(this),h.N.publishEvent(new G(this.createCarryJob()))}setTargetSite(e){var t,s;this.targetSite!==e&&(null===(t=this.targetSite)||void 0===t||t.unAssign(this),this.targetSite=e,null===(s=this.targetSite)||void 0===s||s.assign(this))}getPriorityIdentifier(){return this.priorityIdentifier}getTargetBuildingTypes(){return this.targetBuildingTypes}createCarryJob(){return new Ie(this)}onAddToSite(){this.addToScene(null,null)}getPositionPathTarget(){const e=this.getPosition2D();return this.positionPathTarget&&this.positionPathTarget[0].targetLocation.equals(e)||(this.positionPathTarget=[new X(e)]),this.positionPathTarget}}class Fe extends ke{constructor(e,t){super(e,t,i.CRYSTAL);const s=tt.getResource("MiscAnims/Crystal/vlp_greencrystal.lwo"),r=ze.registerMesh(new Me("MiscAnims/Crystal/").parse(s));r.material.forEach((e=>{e.blending=I.WMw,e.depthWrite=!1,e.opacity=.5,e.transparent=e.opacity<1})),r.scale.set(1.75,1.75,1.75),this.group.add(r);const n=tt.getResource("World/Shared/Crystal.lwo"),a=ze.registerMesh(new Me("World/Shared/").parse(n));a.material.forEach((e=>{e.emissive=new I.Ilk(0,8,0),e.color=new I.Ilk(0,0,0),e.opacity=.9,e.transparent=e.opacity<1})),this.group.add(a),this.targetBuildingTypes=[i.POWER_STATION,i.TOOLSTATION],this.priorityIdentifier=ee.aiPriorityCrystal}get stats(){return tt.stats.PowerCrystal}}class Be extends Y{}Be.Normal=new Be("Normal"),Be.TickDown=new Be("TickDown");class _e extends Ie{constructor(e){super(e),this.color=10510432}getRequiredTraining(){return p.DEMOLITION}onJobComplete(){super.onJobComplete(),this.item.ignite()}}class Ue extends ke{constructor(e,t,s){super(e,t,i.DYNAMITE,"MiscAnims/Dynamite/Dynamite.ae"),this.targetSurface=s,this.priorityIdentifier=ee.aiPriorityDestruction,this.changeActivity()}getCarryTargets(){return this.targetSurface&&this.targetSurface.isExplodable()?this.targetSurface.getDigPositions().map((e=>new Oe(e))):P.getBuildingsByType(i.TOOLSTATION).map((e=>e.getDropPosition2D())).map((e=>new Oe(e)))}ignite(){const e=this.targetSurface.getCenterWorld();e.y=this.group.position.y,this.group.lookAt(e),this.changeActivity(Be.TickDown,(()=>{this.removeFromScene(),this.targetSurface.collapse()}))}getDefaultActivity(){return Be.Normal}createCarryJob(){return new _e(this)}}class We extends ke{constructor(e,t){super(e,t,i.ORE);const s=tt.getResource("MiscAnims/Ore/Ore1st.lwo"),r=ze.registerMesh(new Me("MiscAnims/Ore/").parse(s));this.group.add(r),this.targetBuildingTypes=[i.ORE_REFINERY,i.TOOLSTATION],this.priorityIdentifier=ee.aiPriorityOre}get stats(){return tt.stats.Ore}}class Ge extends se{constructor(e){super(Q.CLEAR_RUBBLE),this.surface=e,this.lastRubblePositions=this.surface.rubblePositions.map((e=>new X(e)))}getRequiredTool(){return c.SHOVEL}getWorkplaces(){const e=this.surface.rubblePositions;return this.lastRubblePositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.lastRubblePositions.some((t=>e.equals(t.targetLocation)))))||(this.lastRubblePositions=e.map((e=>new X(e)))),this.lastRubblePositions}onJobComplete(){this.fulfiller.forEach((e=>e.changeActivity())),this.surface.reduceRubble(),this.surface.hasRubble()||super.onJobComplete()}getPriorityIdentifier(){return ee.aiPriorityClearing}getWorkActivity(){return z.Clear}}class He extends se{constructor(e){super(Q.DRILL),this.color=10526880,this.surface=e,this.digPositions=this.surface.getDigPositions().map((e=>new X(e)))}getRequiredTool(){return c.DRILL}getWorkplaces(){const e=this.surface.getDigPositions();return this.digPositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.digPositions.some((t=>e.equals(t.targetLocation)))))||(this.digPositions=e.map((e=>new X(e)))),this.digPositions}onJobComplete(){this.surface.onDrillComplete(this.fulfiller.last().getPosition2D())&&super.onJobComplete()}getPriorityIdentifier(){return ee.aiPriorityDestruction}getWorkActivity(){return z.Drill}getWorkDuration(e){const t=new Map;this.fulfiller.forEach((e=>{t.getOrUpdate(e.entityType,(()=>({drillTime:1e3*e.stats[this.surface.surfaceType.statsDrillName][e.level],count:0}))).count++}));const s=t.get(e.entityType),i=(null==s?void 0:s.drillTime)/((null==s?void 0:s.count)||1)||null;return i||console.warn("According to cfg this entity cannot drill this material"),i}}class Je extends se{constructor(e){super(Q.REINFORCE),this.color=6332512,this.surface=e,this.digPositions=this.surface.getDigPositions().map((e=>new X(e)))}getWorkplaces(){const e=this.surface.getDigPositions();return this.digPositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.digPositions.some((t=>e.equals(t.targetLocation)))))||(this.digPositions=e.map((e=>new X(e)))),this.digPositions}onJobComplete(){super.onJobComplete(),this.surface.reinforce()}getPriorityIdentifier(){return ee.aiPriorityReinforce}getWorkActivity(){return z.Reinforce}getWorkDuration(e){return 2700}}var Ve,je,Ze=I.M8C.degToRad;class Ye{constructor(e,t,s,i,r){this.containedOres=0,this.containedCrystals=0,this.heightOffset=null,this.discovered=!1,this.selected=!1,this.reinforced=!1,this.drillJob=null,this.reinforceJob=null,this.dynamiteJob=null,this.clearRubbleJob=null,this.surfaceRotation=0,this.seamLevel=0,this.fallinTimeout=null,this.fallinGrp=null,this.animationTimeout=null,this.wallType=null,this.mesh=null,this.needsMeshUpdate=!1,this.topLeftVertex=null,this.topRightVertex=null,this.bottomLeftVertex=null,this.bottomRightVertex=null,this.rubblePositions=[],this.building=null,this.site=null,this.fence=null,this.hasPower=!1,this.terrain=e,this.worldMgr=this.terrain.worldMgr,this.sceneMgr=this.terrain.sceneMgr,this.surfaceType=t,t!==d.CRYSTAL_SEAM&&t!==d.ORE_SEAM||(this.seamLevel=4),this.x=s,this.y=i,this.heightOffset=r,t!==d.RUBBLE4&&t!==d.RUBBLE3&&t!==d.RUBBLE2&&t!==d.RUBBLE1||(this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()])}discover(){if(this.setDiscovered(),this.needsMeshUpdate=!0,!this.surfaceType.floor)return!1;const e=[],t=[];for(let s=-1;s<=1;s++)for(let i=-1;i<=1;i++){if(0===s&&0===i)continue;const r=this.terrain.getSurface(this.x+s,this.y+i);0!==s&&0!==i||!r.surfaceType.floor?t.push(r):e.push(r)}let s=!1,i=0;for(;e.length>0;){i++;const r=e.shift();r.setDiscovered();for(let i=-1;i<=1;i++)for(let n=-1;n<=1;n++){if(0===i&&0===n)continue;const a=r.terrain.getSurface(r.x+i,r.y+n);0!==i&&0!==n||!a.surfaceType.floor||a.discovered?t.push(a):(e.push(a),s=!0)}}return t.forEach((e=>{e.setDiscovered(),e.isSupported()||e.collapse()})),console.log("surface discover handled "+i+" floors and "+t.length+" others"),s}setDiscovered(){this.discovered||P.discoverSurface(this),this.discovered=!0,this.needsMeshUpdate=!0}onDrillComplete(e){if(this.seamLevel>0){this.seamLevel--;const t=(new I.FM8).copy(e).sub(this.getCenterWorld2D()).multiplyScalar(.3+(0,l.sZ)(3)/10).rotateAround(new I.FM8(0,0),Ze(-10+(0,l.sZ)(20))).add(e);if(this.surfaceType===d.CRYSTAL_SEAM){const e=this.worldMgr.placeMaterial(new Fe(this.worldMgr,this.sceneMgr),t);h.N.publishEvent(new ve(e.getPosition()))}else this.surfaceType===d.ORE_SEAM&&(this.worldMgr.placeMaterial(new We(this.worldMgr,this.sceneMgr),t),h.N.publishEvent(new Z))}return!(this.seamLevel>0||(this.collapse(),0))}collapse(){this.cancelJobs(),this.fallinTimeout=(0,l.L4)(this.fallinTimeout),this.surfaceType=d.RUBBLE4,this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=4,this.needsMeshUpdate=!0,this.discover()&&h.N.publishEvent(new j),this.dropContainedOre(this.containedOres-4);for(let e=0;e<this.containedCrystals;e++){const e=this.worldMgr.placeMaterial(new Fe(this.worldMgr,this.sceneMgr),this.getRandomPosition());h.N.publishEvent(new ve(e.getPosition()))}for(let e=this.x-1;e<=this.x+1;e++)for(let t=this.y-1;t<=this.y+1;t++)if(e!==this.x||t!==this.y){const s=this.terrain.getSurface(e,t);s.needsMeshUpdate=!0,s.isSupported()||s.collapse()}this.terrain.updateSurfaceMeshes(),this.terrain.floorGroup.updateWorldMatrix(!0,!0),this.playPositionalSample(me.d.SFX_RockBreak)}dropContainedOre(e){for(let t=0;t<e&&this.containedOres>0;t++)this.containedOres--,this.worldMgr.placeMaterial(new We(this.worldMgr,this.sceneMgr),this.getRandomPosition()),h.N.publishEvent(new Z)}getRandomPosition(){return new I.FM8(this.x*C.pM+C.pM/2+(0,l.kz)()*(0,l.sZ)(C.pM/4),this.y*C.pM+C.pM/2+(0,l.kz)()*(0,l.sZ)(C.pM/4))}cancelJobs(){this.drillJob=Ye.safeRemoveJob(this.drillJob),this.reinforceJob=Ye.safeRemoveJob(this.reinforceJob),this.dynamiteJob=Ye.safeRemoveJob(this.dynamiteJob),this.clearRubbleJob=Ye.safeRemoveJob(this.clearRubbleJob),this.updateJobColor()}static safeRemoveJob(e){return e&&h.N.publishEvent(new H(e)),null}reduceRubble(){this.rubblePositions.shift(),this.surfaceType===d.RUBBLE4?this.surfaceType=d.RUBBLE3:this.surfaceType===d.RUBBLE3?this.surfaceType=d.RUBBLE2:this.surfaceType===d.RUBBLE2?this.surfaceType=d.RUBBLE1:this.surfaceType===d.RUBBLE1&&(this.surfaceType=d.GROUND),this.dropContainedOre(this.containedOres-this.rubblePositions.length),this.updateTexture(),this.selected&&h.N.publishEvent(new S(v.SURFACE,this))}isSupported(){if(this.surfaceType.floor)return!0;const e=this.terrain.getSurface(this.x-1,this.y),t=this.terrain.getSurface(this.x-1,this.y-1),s=this.terrain.getSurface(this.x,this.y-1),i=this.terrain.getSurface(this.x+1,this.y-1),r=this.terrain.getSurface(this.x+1,this.y),n=this.terrain.getSurface(this.x+1,this.y+1),a=this.terrain.getSurface(this.x,this.y+1),o=this.terrain.getSurface(this.x-1,this.y+1);function l(e,t,s){return!(e.discovered&&t.discovered&&s.discovered&&(e.surfaceType.floor||t.surfaceType.floor||s.surfaceType.floor))}return l(e,t,s)||l(s,i,r)||l(r,n,a)||l(a,o,e)}updateMesh(e=!0){if(!e&&!this.needsMeshUpdate)return;this.needsMeshUpdate=!1;const t=new I.Pa4(this.x,0,this.y),s=new I.Pa4(this.x+1,0,this.y),i=new I.Pa4(this.x,0,this.y+1),r=new I.Pa4(this.x+1,0,this.y+1),n=this.terrain.getSurface(this.x-1,this.y),a=this.terrain.getSurface(this.x-1,this.y-1),o=this.terrain.getSurface(this.x,this.y-1),l=this.terrain.getSurface(this.x+1,this.y-1),h=this.terrain.getSurface(this.x+1,this.y),c=this.terrain.getSurface(this.x+1,this.y+1),u=this.terrain.getSurface(this.x,this.y+1),d=this.terrain.getSurface(this.x-1,this.y+1);function g(e,t,s){return!(e.discovered&&t.discovered&&s.discovered&&(e.surfaceType.floor||t.surfaceType.floor||s.surfaceType.floor))}this.discovered?this.surfaceType.floor&&this.neighbors.some((e=>e.surfaceType.floor&&e.discovered))||(g(n,a,o)&&(t.y=1),g(o,l,h)&&(s.y=1),g(h,c,u)&&(r.y=1),g(u,d,n)&&(i.y=1)):(t.y=1,s.y=1,r.y=1,i.y=1);let p=t.y+s.y+r.y+i.y;if(p===ne.WALL&&t.y===r.y&&(p=ne.WEIRD_CREVICE),this.wallType!==p){function m(...e){return e.map((e=>e.heightOffset)).reduce(((e,t)=>(e||0)+(t||0)),0)/(e.length||1)}this.wallType=p,this.topLeftVertex=t.clone(),this.topRightVertex=s.clone(),this.bottomLeftVertex=i.clone(),this.bottomRightVertex=r.clone(),this.topLeftVertex.y+=m(a,o,this,n)*C.ED,this.topRightVertex.y+=m(o,l,h,this)*C.ED,this.bottomRightVertex.y+=m(this,h,c,u)*C.ED,this.bottomLeftVertex.y+=m(n,this,u,d)*C.ED,this.updateGeometry(t,r,s,i),this.wallType!==ne.WALL&&this.cancelReinforceJobs()}this.updateTexture(),this.updateJobColor(),this.updateGraphWalk()}updateGraphWalk(){const e=this.getGraphWalkWeight();for(let t=0;t<3;t++)for(let s=0;s<3;s++)this.terrain.graphWalk.grid[3*this.x+t][3*this.y+s].weight=e}cancelReinforceJobs(){this.reinforceJob=Ye.safeRemoveJob(this.reinforceJob),this.updateJobColor()}updateTexture(){let e=this.terrain.textureSet.texturebasename;this.discovered?this.surfaceType===d.POWER_PATH?e+=this.updatePowerPathTexture():!this.surfaceType.shaping&&this.neighbors.some((e=>e.discovered&&e.surfaceType.floor))?this.surfaceType===d.POWER_PATH_BUILDING&&this.hasPower?e+="66":e+=this.surfaceType.matIndex.toString():this.wallType===ne.WEIRD_CREVICE?e+="77":(this.wallType===ne.CORNER?e+="5":this.wallType===ne.INVERTED_CORNER?e+="3":this.reinforced?e+="2":e+="0",e+=this.surfaceType.shaping?this.surfaceType.matIndex:d.SOLID_ROCK.matIndex):e+="70",e+=".bmp",this.forEachMaterial((e=>{var t;return null===(t=e.map)||void 0===t?void 0:t.dispose()}));const t=tt.getTexture(e);t.center.set(.5,.5),t.rotation=this.surfaceRotation,this.forEachMaterial((e=>e.map=t))}updatePowerPathTexture(){this.surfaceRotation=0;const e=this.terrain.getSurface(this.x-1,this.y).isPath(),t=this.terrain.getSurface(this.x,this.y-1).isPath(),s=this.terrain.getSurface(this.x+1,this.y).isPath(),i=this.terrain.getSurface(this.x,this.y+1).isPath(),r=(e?1:0)+(t?1:0)+(s?1:0)+(i?1:0);return 0===r||1===r?(e&&(this.surfaceRotation=-Math.PI/2),t&&(this.surfaceRotation=Math.PI),s&&(this.surfaceRotation=Math.PI/2),this.hasPower?"75":"65"):2===r?e===s?(this.surfaceRotation=e?Math.PI/2:0,this.hasPower?"72":"62"):(e&&i&&(this.surfaceRotation=-Math.PI/2),e&&t&&(this.surfaceRotation=Math.PI),t&&s&&(this.surfaceRotation=Math.PI/2),this.hasPower?"73":"63"):3===r?(t||(this.surfaceRotation=-Math.PI/2),s||(this.surfaceRotation=Math.PI),i||(this.surfaceRotation=Math.PI/2),this.hasPower?"74":"64"):this.hasPower?"71":"60"}forEachMaterial(e){var t;(null===(t=this.mesh)||void 0===t?void 0:t.material)&&(Array.isArray(this.mesh.material)?this.mesh.material:[this.mesh.material]).forEach((t=>e(t)))}updateGeometry(e,t,s,i){var r,n;this.mesh&&this.terrain.floorGroup.remove(this.mesh),null===(n=null===(r=this.mesh)||void 0===r?void 0:r.geometry)||void 0===n||n.dispose();const a=oe.create(this.wallType,e,t,s,i,this.topLeftVertex.y,this.topRightVertex.y,this.bottomRightVertex.y,this.bottomLeftVertex.y);this.mesh=new I.Kj0(a,new I.xoR({shininess:0})),this.mesh.userData={selectable:this,surface:this},this.terrain.floorGroup.add(this.mesh),this.terrain.floorGroup.updateWorldMatrix(!0,!0)}getSelectionType(){return v.SURFACE}select(){return!(!this.surfaceType.selectable||this.wallType===ne.INVERTED_CORNER||this.wallType===ne.WEIRD_CREVICE||this.selected||!this.discovered||(this.selected=!0,this.forEachMaterial((e=>e.color.setHex(6316192))),this.surfaceType.floor&&ye.P.playSample(me.d.SFX_Floor),this.surfaceType.shaping&&ye.P.playSample(me.d.SFX_Wall),console.log("Surface selected at "+this.x+"/"+this.y),0))}deselect(){this.selected&&(this.selected=!1,this.updateJobColor())}getSelectionCenter(){return null}updateJobColor(){var e,t,s;const i=(null===(e=this.dynamiteJob)||void 0===e?void 0:e.color)||(null===(t=this.reinforceJob)||void 0===t?void 0:t.color)||(null===(s=this.drillJob)||void 0===s?void 0:s.color)||16777215;this.forEachMaterial((e=>e.color.setHex(i)))}hasRubble(){return this.rubblePositions.length>0}isPath(){return this.surfaceType===d.POWER_PATH||this.surfaceType===d.POWER_PATH_BUILDING}isWalkable(){var e;return this.surfaceType.floor&&this.discovered&&this.surfaceType!==d.LAVA&&this.surfaceType!==d.WATER&&!(null===(e=this.building)||void 0===e?void 0:e.blocksPathSurface)}isDrillable(){return this.surfaceType.drillable&&this.discovered&&(this.wallType===ne.WALL||this.wallType===ne.CORNER)}isDrillableHard(){return this.surfaceType.drillableHard&&this.discovered&&(this.wallType===ne.WALL||this.wallType===ne.CORNER)}isReinforcable(){return this.surfaceType.reinforcable&&this.discovered&&this.wallType===ne.WALL&&!this.reinforced}isExplodable(){return this.surfaceType.explodable&&this.discovered&&(this.wallType===ne.WALL||this.wallType===ne.CORNER)}isDigable(){return this.isDrillable()||this.isExplodable()}getDigPositions(){const e=[];return this.terrain.getSurface(this.x-1,this.y).isWalkable()&&e.push(new I.FM8(this.x*C.pM-1,this.y*C.pM+C.pM/2)),this.terrain.getSurface(this.x,this.y-1).isWalkable()&&e.push(new I.FM8(this.x*C.pM+C.pM/2,this.y*C.pM-1)),this.terrain.getSurface(this.x+1,this.y).isWalkable()&&e.push(new I.FM8(this.x*C.pM+C.pM+1,this.y*C.pM+C.pM/2)),this.terrain.getSurface(this.x,this.y+1).isWalkable()&&e.push(new I.FM8(this.x*C.pM+C.pM/2,this.y*C.pM+C.pM+1)),e}reinforce(){this.reinforced=!0,this.cancelReinforceJobs(),this.fallinTimeout=(0,l.L4)(this.fallinTimeout),this.updateTexture()}getCenterWorld2D(){return new I.FM8(this.x,this.y).addScalar(.5).multiplyScalar(C.pM)}getCenterWorld(){const e=this.getCenterWorld2D();return new I.Pa4(e.x,this.sceneMgr.getTerrainHeight(e.x,e.y),e.y)}setFallinLevel(e){if(e<1)return;let t,s;this.surfaceType.floor?(t=this.terrain.findFallInOrigin(this.x,this.y),s=[this.x,this.y]):(t=[this.x,this.y],s=this.terrain.findFallInTarget(this.x,this.y)),t&&s&&this.terrain.getSurface(t[0],t[1]).scheduleFallin(s[0],s[1])}scheduleFallin(e,t){this.fallinTimeout=setTimeout((()=>{this.createFallin(e,t),this.scheduleFallin(e,t)}),1e3*(30+(0,l.sZ)(60)))}createFallin(e,t){const s=this.terrain.getSurface(e,t).getCenterWorld();h.N.publishEvent(new be(s)),this.playPositionalSample(me.d.SFX_FallIn);const i=tt.getResource("MiscAnims/RockFall/Rock3Sides.lws"),r=new Ce("MiscAnims/RockFall/").parse(i);this.fallinGrp=new I.ZAu,this.fallinGrp.position.copy(s);const n=this.x-e,a=t-this.y;this.fallinGrp.rotateOnAxis(new I.Pa4(0,1,0),Math.atan2(a,n)+Math.PI/2),this.sceneMgr.scene.add(this.fallinGrp);const o=[];r.bodies.forEach((e=>{const t=e.model.clone(!0);o.push(t)})),r.bodies.forEach(((e,t)=>{const s=o[t],i=e.parentObjInd;null!=i?o[i].add(s):this.fallinGrp.add(s)})),this.animate(o,r,0),this.terrain.getSurface(e,t).makeRubble()}animate(e,t,s){if(e.length!==t.bodies.length)throw"Cannot animate poly. Length differs from bodies length";if(t.bodies.forEach(((t,i)=>{const r=e[i];if(r.position.copy(t.relPos[s]),r.rotation.copy(t.relRot[s]),r.scale.copy(t.relScale[s]),r.hasOwnProperty("material")){const e=r.material,i=t.opacity[s];e&&void 0!==i&&(Array.isArray(e)?e:[e]).forEach((e=>{e.opacity=i,e.transparent=e.transparent||e.opacity<1}))}})),this.animationTimeout=null,s+1>t.lastFrame&&!t.looping)this.sceneMgr.scene.remove(this.fallinGrp),this.fallinGrp=null;else{let i=s+1;i>t.lastFrame&&(i=t.firstFrame);const r=this;this.animationTimeout=setTimeout((()=>r.animate(e,t,i)),1e3/t.framesPerSecond*t.transcoef)}}dispose(){var e,t;this.fallinTimeout=(0,l.L4)(this.fallinTimeout),this.forEachMaterial((e=>e.dispose())),null===(t=null===(e=this.mesh)||void 0===e?void 0:e.geometry)||void 0===t||t.dispose()}getFloorHeight(e,t){const s=e/C.pM-this.x,i=t/C.pM-this.y,r=Ye.interpolate(this.topLeftVertex.y,this.topRightVertex.y,s),n=Ye.interpolate(this.bottomLeftVertex.y,this.bottomRightVertex.y,s);return Ye.interpolate(r,n,i)*C.pM}static interpolate(e,t,s){return e+s*(t-e)}get neighbors(){return[this.terrain.getSurface(this.x-1,this.y),this.terrain.getSurface(this.x,this.y-1),this.terrain.getSurface(this.x+1,this.y),this.terrain.getSurface(this.x,this.y+1)]}makeRubble(e=0){this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=e,this.setSurfaceTypeAndUpdateNeighbors(d.RUBBLE4)}setBuilding(e){this.building=e,this.updateGraphWalk(),this.setSurfaceTypeAndUpdateNeighbors(this.building?d.POWER_PATH_BUILDING:d.GROUND)}setSurfaceTypeAndUpdateNeighbors(e){this.surfaceType=e,this.updateTexture(),this.neighbors.forEach((e=>e.updateTexture()))}getGraphWalkWeight(){return this.isWalkable()?this.hasRubble()?4:1:0}setHasPower(e,t){this.hasPower!==e&&(this.hasPower=e,this.updateTexture(),t&&this.neighbors.forEach((s=>s.isPath()&&s.setHasPower(e,t))))}canPlaceFence(){return this.surfaceType.canCarryFence&&!this.building&&!this.fence&&[1,2].some((e=>!!(this.terrain.getSurface(this.x-e,this.y).building||this.terrain.getSurface(this.x,this.y-e).building||this.terrain.getSurface(this.x+e,this.y).building||this.terrain.getSurface(this.x,this.y+e).building||this.terrain.getSurface(this.x-e,this.y).fence||this.terrain.getSurface(this.x,this.y-e).fence||this.terrain.getSurface(this.x+e,this.y).fence||this.terrain.getSurface(this.x,this.y+e).fence)))}createDrillJob(){return this.drillJob||(this.drillJob=new He(this),this.updateJobColor(),h.N.publishEvent(new G(this.drillJob))),this.drillJob}createReinforceJob(){return this.reinforceJob||(this.reinforceJob=new Je(this),this.updateJobColor(),h.N.publishEvent(new G(this.reinforceJob))),this.reinforceJob}createDynamiteJob(){if(!this.dynamiteJob){const e=P.getClosestBuildingByType(this.getCenterWorld(),i.TOOLSTATION);if(!e)throw"Could not find toolstation to spawn dynamite";const t=new Ue(this.worldMgr,this.sceneMgr,this);t.addToScene(e.getDropPosition2D(),e.getHeading()),this.dynamiteJob=new _e(t),this.updateJobColor(),h.N.publishEvent(new G(this.dynamiteJob))}return this.dynamiteJob}createClearRubbleJob(){return this.clearRubbleJob||(this.clearRubbleJob=new Ge(this),this.updateJobColor(),h.N.publishEvent(new G(this.clearRubbleJob))),this.clearRubbleJob}setSite(e){this.site=e,this.setSurfaceTypeAndUpdateNeighbors(this.site?d.POWER_PATH_CONSTRUCTION:d.GROUND)}playPositionalSample(e){const t=new I.VYz(this.sceneMgr.listener);return t.setRefDistance(6*C.pM),this.mesh.add(t),ye.P.getSampleBuffer(e).then((e=>{t.setBuffer(e),t.play()})),t}}class qe{constructor(e,t){this.target=null,this.locations=[],this.lengthSq=0,this.target=e,this.locations=Array.isArray(t)?t:[t];for(let e=0;e<this.locations.length-1;e++){const t=this.locations[e],s=this.locations[e+1];this.lengthSq+=t.distanceToSquared(s)}}addLocation(e){return this.locations.push(e),this.locations.length>1&&(this.lengthSq+=this.locations[this.locations.length-2].distanceToSquared(e)),this}get targetPosition(){return this.locations[this.locations.length-1]||null}get firstLocation(){return this.locations[0]||null}}class Ke{constructor(e,t){this.textureSet={},this.width=0,this.height=0,this.surfaces=[],this.floorGroup=new I.ZAu,this.roofGroup=new I.ZAu,this.graphWalk=null,this.cachedPaths=new Map,this.worldMgr=e,this.sceneMgr=t,this.floorGroup.scale.setScalar(C.pM),this.roofGroup.scale.setScalar(C.pM),this.roofGroup.visible=!1,C.Sl&&this.floorGroup.add(new I.y8_)}getSurfaceFromWorld(e){return this.getSurfaceFromWorldXZ(e.x,e.z)}getSurfaceFromWorld2D(e){return this.getSurfaceFromWorldXZ(e.x,e.y)}getSurfaceFromWorldXZ(e,t){return this.getSurface(e/C.pM,t/C.pM)}getSurface(e,t){return e=Math.floor(e),t=Math.floor(t),this.getSurfaceOrNull(e,t)||new Ye(this,d.SOLID_ROCK,e,t,0)}getSurfaceOrNull(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height?this.surfaces[e][t]:null}updateSurfaceMeshes(e=!1){this.forEachSurface((t=>t.updateMesh(e))),this.floorGroup.updateWorldMatrix(!0,!0),this.resetGraphWalk()}resetGraphWalk(){this.graphWalk.init(),this.cachedPaths.clear(),console.log("Cached paths cleared")}findPath(e,t){const s=t.targetLocation,i=Math.floor(3*e.x/C.pM),r=Math.floor(3*e.y/C.pM),n=Math.floor(3*s.x/C.pM),a=Math.floor(3*s.y/C.pM);if(i===n&&r===a)return new qe(t,s);const o=i+"/"+r+" -> "+n+"/"+a,l=this.cachedPaths.get(o);return l?l.addLocation(s):this.searchPath(i,r,n,a,t,o)}searchPath(e,t,s,i,r,n){const a=this.graphWalk.grid[e][t],o=this.graphWalk.grid[s][i],l=ue.search(this.graphWalk,a,o).map((e=>Ke.gridNodeToWorldPos(e)));return l.length<1?null:(l.pop(),l.push(r.targetLocation),this.cachedPaths.set(n,new qe(r,l.slice(0,-1))),new qe(r,l))}static gridNodeToWorldPos(e){return new I.FM8(Math.random(),Math.random()).divideScalar(2).add(e).multiplyScalar(C.pM/3)}findFallInOrigin(e,t){const s=this.getSurface(e-1,t);if(s.isReinforcable())return[s.x,s.y];const i=this.getSurface(e,t-1);if(i.isReinforcable())return[i.x,i.y];const r=this.getSurface(e+1,t);if(r.isReinforcable())return[r.x,r.y];const n=this.getSurface(e,t+1);if(n.isReinforcable())return[n.x,n.y];const a=this.getSurface(e-1,t);if(a.isDigable())return[a.x,a.y];const o=this.getSurface(e,t-1);if(o.isDigable())return[o.x,o.y];const l=this.getSurface(e+1,t);if(l.isDigable())return[l.x,l.y];const h=this.getSurface(e,t+1);return h.isDigable()?[h.x,h.y]:null}findFallInTarget(e,t){const s=this.getSurface(e-1,t);if(s.isWalkable())return[s.x,s.y];const i=this.getSurface(e,t-1);if(i.isWalkable())return[i.x,i.y];const r=this.getSurface(e+1,t);if(r.isWalkable())return[r.x,r.y];const n=this.getSurface(e,t+1);return n.isWalkable()?[n.x,n.y]:null}dispose(){this.forEachSurface((e=>e.dispose()))}forEachSurface(e){var t;null===(t=this.surfaces)||void 0===t||t.forEach((t=>t.forEach((t=>e(t)))))}countDiggables(){let e=0;return this.forEachSurface((t=>e+=t.isDigable()?1:0)),e}countCrystals(){let e=0;return this.forEachSurface((t=>e+=t.containedCrystals)),e}countOres(){let e=0;return this.forEachSurface((t=>e+=t.containedOres)),e}}!function(e){e[e.NONE=0]="NONE",e[e.RUBBLE=1]="RUBBLE",e[e.POWER_PATH=2]="POWER_PATH"}(Ve||(Ve={})),function(e){e[e.WALL=0]="WALL",e[e.CAVERN_EXPOSED=1]="CAVERN_EXPOSED",e[e.CAVERN_HIDDEN=2]="CAVERN_HIDDEN",e[e.SLUG_HOLE_EXPOSED=3]="SLUG_HOLE_EXPOSED",e[e.SLUG_HOLE_HIDDEN=4]="SLUG_HOLE_HIDDEN"}(je||(je={}));class ze{constructor(e){this.maxFps=30,this.debugHelper=new k,this.renderer=new I.CP7({antialias:!0,canvas:e}),this.renderer.setClearColor(0),this.listener=new I.SJI,this.camera=new I.cPb(30,e.width/e.height,.1,5e3),this.camera.add(this.listener),this.controls=new N.o(this.camera,this.renderer.domElement),this.controls.mouseButtons={LEFT:null,MIDDLE:I.RsA.ROTATE,RIGHT:I.RsA.PAN},this.controls.listenToKeyEvents(this.renderer.domElement),this.controls.keyPanSpeed=20*this.controls.keyPanSpeed,this.buildMarker=new he(this),h.N.registerEventListener(b.Z.COMMAND_CANCEL_BUILD_MODE,(()=>{P.buildModeSelection=null,this.buildMarker.hideAllMarker()}))}selectEntitiesByRay(e,t){const s=new I.iMs;s.setFromCamera({x:e,y:t},this.camera);let i=s.intersectObjects(P.raiders.map((e=>e.pickSphere)));i.length<1&&(i=s.intersectObjects(P.buildings.map((e=>e.pickSphere)))),i.length<1&&this.terrain&&(i=s.intersectObjects(this.terrain.floorGroup.children));const r=[];if(i.length>0){const e=i[0].object.userData;if(e&&e.hasOwnProperty("selectable")){const t=e.selectable;t&&r.push(t)}}P.selectEntities(r)}selectEntitiesInFrustum(e,t,s,i){const r=new I.Pa4(e,t,.5),n=new I.Pa4(s,i,.5);r.x===n.x&&(n.x+=Number.EPSILON),r.y===n.y&&(n.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld();const a=new I.Pa4;a.copy(r),a.x=Math.min(r.x,n.x),a.y=Math.max(r.y,n.y),n.x=Math.max(r.x,n.x),n.y=Math.min(r.y,n.y);const o=new I.Pa4,l=new I.Pa4,h=new I.Pa4,c=new I.Pa4,u=new I.Pa4;o.setFromMatrixPosition(this.camera.matrixWorld),l.copy(a),h.set(n.x,a.y,0),c.copy(n),u.set(a.x,n.y,0),l.unproject(this.camera),h.unproject(this.camera),c.unproject(this.camera),u.unproject(this.camera);const d=new I.Pa4,g=new I.Pa4,p=new I.Pa4;d.copy(l).sub(o),g.copy(h).sub(o),p.copy(c).sub(o),d.normalize(),g.normalize(),p.normalize();const m=Number.MAX_VALUE;d.multiplyScalar(m),g.multiplyScalar(m),p.multiplyScalar(m),d.add(o),g.add(o),p.add(o);const y=new I.iWj,f=y.planes;f[0].setFromCoplanarPoints(o,l,h),f[1].setFromCoplanarPoints(o,h,c),f[2].setFromCoplanarPoints(c,u,o),f[3].setFromCoplanarPoints(u,l,o),f[4].setFromCoplanarPoints(h,c,u),f[5].setFromCoplanarPoints(p,g,d),f[5].normal.multiplyScalar(-1);let v=P.raiders.filter((e=>y.containsPoint(e.getSelectionCenter())));if(v.length<1){const e=P.buildings.find((e=>y.containsPoint(e.getSelectionCenter())));v=e?[e]:[]}P.selectEntities(v)}setupScene(e,t){this.scene=new I.xsS;const s=tt.cfg("Main","AmbientRGB")||[10,10,10],i=Math.min(255,Math.max(0,...s)),r=s.map((e=>e/(i||1))),n=new I.Ilk(r[0],r[1],r[2]);this.ambientLight=new I.Mig(n,.4),this.scene.add(this.ambientLight),this.cursorTorchlight=new I.cek(16777215,1.5,4,1),this.cursorTorchlight.distance*=C.pM,this.scene.add(this.cursorTorchlight),this.scene.add(this.buildMarker.group),this.terrain=class{static loadTerrain(e,t,s){var i,r,n,a,o,l,h;const c=e.blockSize;c!==C.pM&&console.error("Unexpected tile size in level configuration: "+c);const u=new Ke(t,s),g=e.textureSet[1];u.textureSet=tt.cfg("Textures",g);const p=tt.getResource(e.terrainMap);u.width=p.width,u.height=p.height;const m=null===(i=tt.getResource(e.pathMap))||void 0===i?void 0:i.level,y=null===(r=tt.getResource(e.surfaceMap))||void 0===r?void 0:r.level,f=null===(n=tt.getResource(e.predugMap))||void 0===n?void 0:n.level,v=null===(a=tt.getResource(e.cryOreMap))||void 0===a?void 0:a.level,b=null===(o=tt.getResource(e.fallinMap))||void 0===o?void 0:o.level,w=null===(l=tt.getResource(e.erodeMap))||void 0===l?void 0:l.level;null===(h=tt.getResource(e.blockPointersMap))||void 0===h||h.level;for(let e=0;e<p.level.length;e++)for(let t=0;t<p.level[e].length;t++){u.surfaces[t]=u.surfaces[t]||[];const s=p.level[e][t];let i=d.getByNum(s);const r=f[e][t];r===je.CAVERN_EXPOSED?i===d.GROUND||i===d.DIRT||i===d.POWER_PATH_BUILDING?i=d.GROUND:i!==d.WATER&&i!==d.LAVA&&console.warn("Unexpected cavern surface type: "+i.name):r===je.SLUG_HOLE_EXPOSED||r===je.SLUG_HOLE_HIDDEN?i=d.SLUG_HOLE:r!==je.WALL&&r!==je.CAVERN_HIDDEN&&console.warn("Unexpected predug level: "+r);const n=m&&i.floor?m[e][t]:Ve.NONE;n===Ve.RUBBLE?i=d.RUBBLE4:n===Ve.POWER_PATH?i=d.POWER_PATH:n!==Ve.NONE&&console.warn("Unexpected path map level: "+n);const a=new Ye(u,i,t,e,y[e][t]);if(v){const s=v[e][t];s%2==1?a.containedCrystals=(s+1)/2:a.containedOres=s/2}u.surfaces[t].push(a)}u.forEachSurface((e=>{if(f[e.y][e.x]===je.CAVERN_EXPOSED||f[e.y][e.x]===je.SLUG_HOLE_EXPOSED)for(let t=e.x-1;t<=e.x+1;t++)for(let s=e.y-1;s<=e.y+1;s++)u.getSurfaceOrNull(t,s).discovered=!0})),u.forEachSurface((e=>{const t=u.getSurfaceOrNull(e.x,e.y);f[e.y][e.x]!==je.CAVERN_HIDDEN||t.discovered||(t.surfaceType=d.GROUND)}));const E=[];for(let e=0;e<u.width;e++){const t=[];for(let s=0;s<u.height;s++){const i=u.getSurfaceOrNull(e,s).getGraphWalkWeight();t.push(i,i,i)}E.push(t,t,t)}if(u.graphWalk=new de(E,{diagonal:!0}),u.forEachSurface((e=>{e.isSupported()||e.collapse()})),u.updateSurfaceMeshes(!0),b)for(let e=0;e<u.width;e++)for(let t=0;t<u.height;t++)u.getSurface(e,t).setFallinLevel(b[t][e]);return w&&console.warn("Lucky you! Lava erosion not yet implemented"),u}}.loadTerrain(e,t,this),this.scene.add(this.terrain.floorGroup),P.totalDiggables=this.terrain.countDiggables(),P.totalCrystals=this.terrain.countCrystals(),P.totalOres=this.terrain.countOres()}startScene(){this.debugHelper.show(),this.renderInterval=setInterval((()=>{this.animRequest=requestAnimationFrame((()=>{this.debugHelper.renderStart(),this.renderer.render(this.scene,this.camera),this.debugHelper.renderDone()}))}),1e3/this.maxFps)}disposeScene(){var e,t;this.debugHelper.hide(),this.renderInterval=(0,l.nJ)(this.renderInterval),this.animRequest&&(cancelAnimationFrame(this.animRequest),this.animRequest=null),P.remainingDiggables=(null===(e=this.terrain)||void 0===e?void 0:e.countDiggables())||0,null===(t=this.terrain)||void 0===t||t.dispose(),this.terrain=null,ze.meshRegistry.forEach((e=>e.dispose())),ze.meshRegistry=[]}static registerMesh(e){return this.meshRegistry.push(e),e.mesh}resize(e,t){this.renderer.setSize(e,t)}getTerrainIntersectionPoint(e,t){if(!this.terrain)return null;const s=new I.iMs;s.setFromCamera({x:e,y:t},this.camera);const i=s.intersectObjects(this.terrain.floorGroup.children);return i.length>0?new I.FM8(i[0].point.x,i[0].point.z):null}setTorchPosition(e){this.cursorTorchlight.position.copy(this.getFloorPosition(e)),this.cursorTorchlight.position.y+=2*C.pM}getFloorPosition(e){const t=this.terrain.getSurfaceFromWorldXZ(e.x,e.y).getFloorHeight(e.x,e.y);return new I.Pa4(e.x,t,e.y)}getTerrainHeight(e,t){const s=new I.iMs(new I.Pa4(Number(e),3*C.pM,Number(t)),new I.Pa4(0,-1,0)).intersectObject(this.terrain.floorGroup,!0);return s.length>0?s[0].point.y:(console.warn("could not determine terrain height for "+e+"/"+t),0)}}ze.meshRegistry=[];var Xe=s(332);class $e{constructor(e,t){this.wad0FileUrl=e,this.wad1FileUrl=t}}var Qe,et=s(346);class tt extends Xe.E{static startLoadingFromCache(){return this.startLoading(null)}static startLoadingFromUrl(e,t){return this.startLoading(new $e(e,t))}static startLoading(e){this.worker.onmessage=e=>{var t;const s=e.data;s.type===et.n.ASSET?(s.assetNames.forEach((e=>this.resourceByName.set(e.toLowerCase(),s.assetObj))),null===(t=s.sfxKeys)||void 0===t||t.forEach((e=>this.sfxByKey.set(e,s.assetObj))),this.onAssetLoaded()):s.type===et.n.MSG?this.onMessage(s.text):s.type===et.n.CFG?(this.configuration=s.cfg,this.stats=s.stats,this.loadDefaultCursor(),this.onInitialLoad(s.totalResources)):s.type===et.n.CACHE_MISS?this.onCacheMissed():s.type===et.n.DONE&&(this.loadAllCursor(),console.log("Loading of about "+s.totalResources+" assets complete! Total load time: "+s.loadingTimeSeconds+" seconds."),this.onLoadDone())},this.worker.postMessage(e)}static filterTextureSequenceNames(e){const t=e.toLowerCase(),s=[];return this.resourceByName.forEach(((e,i)=>{i.startsWith(t)&&s.push(i)})),s.length>0?s:t.startsWith("world/shared/")?(console.warn("Texture sequence not found: "+e),null):this.filterTextureSequenceNames("world/shared/"+(0,l.vt)(e))}static getTexture(e){if(!e||0===e.length)throw"textureName must not be undefined, null or empty - was "+e;const t=e.toLowerCase(),s=this.resourceByName.getOrUpdate(t,(()=>{const s="world/shared/"+(0,l.vt)(t);return this.resourceByName.getOrUpdate(s,(()=>(console.warn("Texture '"+e+"' ("+t+", "+s+") unknown! Using placeholder texture instead"),(0,x.BT)(64,64))))})),i=new I.xEZ(s,I.xEZ.DEFAULT_MAPPING,I.rpg,I.rpg);return i.needsUpdate=!0,i}static getAnimationEntityType(e){let t=this.getResource(e);if(!t)throw"Could not get animation entity type for: "+e;return class{static loadModels(e,t){const s=(0,l.DW)(e),i=new O;i.carryNullName=(0,l.hh)(t,"CarryNullName"),i.depositNullName=(0,l.hh)(t,"DepositNullName"),i.toolNullName=(0,l.hh)(t,"ToolNullName");const r=(0,l.hh)(t,"highpoly");r&&(i.highPoly={},Object.keys(r).forEach((e=>{const t=r[e]+".lwo",n=e.startsWith("!")?e.slice(1):e,a=tt.getResource(s+t);i.highPoly[n]=ze.registerMesh(new Me(s).parse(a))})));const n=(0,l.hh)(t,"Activities");return n&&Object.keys(n).forEach((e=>{try{let r=(0,l.hh)(n,e);const a=(0,l.hh)(t,r),o=(0,l.hh)(a,"FILE"),h=!0===(0,l.hh)(a,"LWSFILE"),c=(0,l.hh)(a,"TRANSCOEF"),u=!0===(0,l.hh)(a,"LOOPING");if(h){const t=tt.getResource(s+o+".lws");a.animation=new Ce(s).parse(t),a.animation.looping=u,a.animation.transcoef=c?Number(c):1,i.activities.set(e.toLowerCase(),a)}else console.error("Found activity which is not an LWS file")}catch(s){console.error(s),console.log(t),console.log(n),console.log(e)}})),i}}.loadModels(e,t)}}tt.worker=new Worker(new URL(s.p+s.u(188),s.b)),tt.onMessage=e=>{console.log(e)},tt.onCacheMissed=()=>{console.log("Worker missed cache")},tt.onInitialLoad=()=>{console.log("Initial loading done.")},tt.onAssetLoaded=()=>{},tt.onLoadDone=()=>{};class st extends X{constructor(e){super(e.getPosition2D()),this.building=e}}class it extends ke{constructor(e,t,s,r){super(e,t,i.BARRIER,"MiscAnims/Barrier/Barrier.ae"),this.site=r,this.heading=s.heading,this.priorityIdentifier=ee.aiPriorityConstruction,this.changeActivity(),this.targets=[new Ne(s.location,this.site)]}updateTargets(){var e;if(null===(e=this.site)||void 0===e?void 0:e.canceled){this.site=null;const e=P.getClosestBuildingByType(this.getPosition(),i.TOOLSTATION);this.targets=[new De(e)]}return this.targets}getDefaultActivity(){return K.Short}onAddToSite(){super.onAddToSite(),this.group.rotation.y=this.heading,this.changeActivity(K.Expand,(()=>this.changeActivity(K.Long)))}}class rt extends Ie{onJobComplete(){super.onJobComplete(),this.item.targetSurface.canPlaceFence()&&(this.item.addToScene(null,null),this.item.targetSurface.fence=this.item)}}class nt extends ke{constructor(e,t,s){super(e,t,i.ELECTRIC_FENCE);const r=tt.getResource("Buildings/E-Fence/E-Fence4.lwo"),n=ze.registerMesh(new Me("Buildings/E-Fence/").parse(r));this.group.add(n),this.targetSurface=s,this.priorityIdentifier=ee.aiPriorityConstruction}updateTargets(){return this.targets.length<1?this.targetSurface.canPlaceFence()?this.targets=[new Oe(this.targetSurface.getCenterWorld2D())]:this.targets=P.getBuildingsByType(...this.getTargetBuildingTypes()).map((e=>new De(e))):this.targetSurface.canPlaceFence()||this.targets[0].building||(this.targets=P.getBuildingsByType(...this.getTargetBuildingTypes()).map((e=>new De(e)))),this.targets}createCarryJob(){return new rt(this)}}class at extends Pe{constructor(e,t,s,i){super(e,t,r.BUILDING,s,i),this.blocksPathSurface=!0,this.secondaryBuildingPart=null,this.primaryPowerPath=new I.FM8(0,1),this.secondaryPowerPath=null,this.waterPathSurface=null,this.powerSwitch=!0,this.spawning=!1,this.primarySurface=null,this.secondarySurface=null,this.primaryPathSurface=null,this.secondaryPathSurface=null,this.upgradeCostOre=0,this.upgradeCostBrick=0,this.crystalsInUse=0,this.inBeam=!1,this.pathTarget=null,this.group.applyMatrix4((new I.yGw).makeScale(-1,1,1)),this.group.userData={selectable:this},this.upgradeCostOre=tt.cfg("Main","BuildingUpgradeCostOre"),this.upgradeCostBrick=tt.cfg("Main","BuildingUpgradeCostStuds"),h.N.registerEventListener(b.Z.MATERIAL_AMOUNT_CHANGED,(()=>{this.powerSwitch&&this.turnOnPower()}))}getSelectionType(){return v.BUILDING}select(){return!this.selected&&!this.inBeam&&(this.selectionFrame.visible=!0,this.selected=!0,ye.P.playSample(me.d.SFX_Okay),!0)}deselect(){this.selectionFrame.visible=!1,this.selected=!1}getSelectionCenter(){return this.pickSphere?(new I.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null}getPickSphereCenter(){return new I.Pa4(0,this.stats.PickSphere/4,0)}getDropPosition2D(){if(this.getToolJoint){const e=new I.Pa4;return this.getToolJoint.getWorldPosition(e),new I.FM8(e.x,e.z)}if(this.depositJoint){const e=new I.Pa4;return this.depositJoint.getWorldPosition(e),new I.FM8(e.x,e.z)}return this.getPosition2D()}getDropPosition(){return this.sceneMgr.getFloorPosition(this.getDropPosition2D())}isUsable(){return!this.inBeam&&this.powerSwitch&&(this.isPowered()||this.stats.PowerBuilding)}isPowered(){return this.stats.SelfPowered||this.crystalsInUse>0}onDiscover(){super.onDiscover(),P.buildingsUndiscovered.remove(this),P.buildings.push(this),h.N.publishEvent(new A)}hasMaxLevel(){return this.level>=this.stats.Levels-1}upgrade(){this.canUpgrade()&&(P.numBrick>=this.upgradeCostBrick?P.numBrick-=this.upgradeCostBrick:P.numOre-=this.upgradeCostOre,h.N.publishEvent(new V),this.level++,h.N.publishEvent(new S),h.N.publishEvent(new A))}getDefaultActivity(){return this.isPowered()?q.Stand:xe.Unpowered}beamUp(){P.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.inBeam=!0;for(let e=0;e<this.stats.CostOre;e++)this.worldMgr.placeMaterial(new We(this.worldMgr,this.sceneMgr),this.primarySurface.getRandomPosition());for(let e=0;e<this.stats.CostCrystal;e++)this.worldMgr.placeMaterial(new Fe(this.worldMgr,this.sceneMgr),this.primarySurface.getRandomPosition());this.surfaces.forEach((e=>e.setBuilding(null))),this.pathTarget=null,super.beamUp(),h.N.publishEvent(new A)}removeFromScene(){super.removeFromScene(),P.buildings.remove(this)}canUpgrade(){return!this.hasMaxLevel()&&(P.numOre>=this.upgradeCostOre||P.numBrick>=this.upgradeCostBrick)}spawnMaterials(e,t){const s=[];if(e===i.CRYSTAL)for(;P.numCrystal>0&&s.length<t;)P.numCrystal--,s.push(new Fe(this.worldMgr,this.sceneMgr));else if(e===i.ORE)for(;P.numOre>0&&s.length<t;)P.numOre--,s.push(new We(this.worldMgr,this.sceneMgr));else console.error("Material drop not implemented for: "+e);s.length>0&&h.N.publishEvent(new V),s.forEach((e=>this.worldMgr.placeMaterial(e,this.getDropPosition2D())))}spawnBarriers(e,t){e.map((e=>new it(this.worldMgr,this.sceneMgr,e,t))).forEach((e=>this.worldMgr.placeMaterial(e,this.getDropPosition2D())))}spawnFence(e){this.worldMgr.placeMaterial(new nt(this.worldMgr,this.sceneMgr,e),this.getDropPosition2D())}turnOnPower(){this.crystalsInUse>0||P.usedCrystals>=P.numCrystal||this.entityType!==i.POWER_STATION&&!this.surfaces.some((e=>e.neighbors.some((e=>e.hasPower))))||(this.crystalsInUse=1,P.usedCrystals+=this.crystalsInUse,this.surfaces.forEach((e=>e.setHasPower(!0,!0))),this.changeActivity(),h.N.publishEvent(new A),this.engineSound=this.playPositionalSfxName(this.stats.EngineSound,!0))}turnOffPower(){var e;this.crystalsInUse<1||(P.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.surfaces.forEach((e=>e.setHasPower(!1,!1))),this.changeActivity(),h.N.publishEvent(new A),null===(e=this.engineSound)||void 0===e||e.stop(),this.engineSound=null)}get surfaces(){const e=[];return this.primarySurface&&e.push(this.primarySurface),this.secondarySurface&&e.push(this.secondarySurface),this.primaryPathSurface&&e.push(this.primaryPathSurface),this.secondaryPathSurface&&e.push(this.secondaryPathSurface),e}placeDown(e,t,s){if(this.primarySurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(e),this.primarySurface.setBuilding(this),this.secondaryBuildingPart){const s=new I.FM8(C.pM*this.secondaryBuildingPart.x,C.pM*this.secondaryBuildingPart.y).rotateAround(new I.FM8(0,0),-t).add(e);this.secondarySurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(s),this.secondarySurface.setBuilding(this)}if(this.primaryPowerPath){const s=new I.FM8(this.primaryPowerPath.x,this.primaryPowerPath.y).multiplyScalar(C.pM).rotateAround(new I.FM8(0,0),-t).add(e);this.primaryPathSurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(s),this.primaryPathSurface.setSurfaceTypeAndUpdateNeighbors(d.POWER_PATH_BUILDING)}this.addToScene(e,t),this.createPickSphere(),this.group.visible?P.buildings.push(this):P.buildingsUndiscovered.push(this),this.group.visible&&!s?(this.inBeam=!0,this.changeActivity(xe.Teleport,(()=>{this.inBeam=!1,this.onPlaceDown()}))):this.onPlaceDown(),this.sceneMgr.terrain.resetGraphWalk()}onPlaceDown(){this.changeActivity(),this.turnOnPower(),h.N.publishEvent(new A)}getDropAction(){return z.Place}getTrainingTargets(){return[new I.FM8(-1,0),new I.FM8(0,1),new I.FM8(1,0),new I.FM8(0,-1)].map((e=>new X(e.multiplyScalar(C.pM/2).add(this.primarySurface.getCenterWorld2D()))))}addToScene(e,t){super.addToScene(e,t),this.pathTarget=new st(this)}getPathTarget(){return this.pathTarget}}class ot extends at{constructor(e,t){super(e,t,i.BARRACKS,"Buildings/Barracks/Barracks.ae")}get stats(){return tt.stats.Barracks}}class lt extends at{constructor(e,t){super(e,t,i.DOCKS,"Buildings/Docks/Docks.ae"),this.primaryPowerPath=new I.FM8(0,-1),this.waterPathSurface=new I.FM8(0,1)}get stats(){return tt.stats.Docks}}class ht extends at{constructor(e,t){super(e,t,i.GEODOME,"Buildings/Geo-dome/Geo-dome.ae"),this.primaryPowerPath=null,this.secondaryBuildingPart=new I.FM8(0,1)}get stats(){return tt.stats.Geodome}}class ct extends at{constructor(e,t){super(e,t,i.GUNSTATION,"Buildings/gunstation/gunstation.ae"),this.primaryPowerPath=null}getDefaultActivity(){return xe.Stand}get stats(){return tt.stats.GunStation}}class ut extends at{constructor(e,t){super(e,t,i.ORE_REFINERY,"Buildings/OreRefinery/OreRefinery.ae"),this.primaryPowerPath=new I.FM8(0,2),this.secondaryBuildingPart=new I.FM8(0,1)}get stats(){return tt.stats.OreRefinery}getDropAction(){return z.Deposit}}class dt extends at{constructor(e,t){super(e,t,i.POWER_STATION,"Buildings/Powerstation/Powerstation.ae"),this.secondaryBuildingPart=new I.FM8(-1,0)}get stats(){return tt.stats.Powerstation}getDropAction(){return z.Deposit}}class gt extends at{constructor(e,t){super(e,t,i.TELEPORT_BIG,"Buildings/BIGTeleport/BIGTeleport.ae"),this.secondaryBuildingPart=new I.FM8(1,0),this.secondaryPowerPath=new I.FM8(1,1)}get stats(){return tt.stats.TeleportBIG}}class pt extends at{constructor(e,t){super(e,t,i.TELEPORT_PAD,"Buildings/Teleports/Teleports.ae")}get stats(){return tt.stats.TeleportPad}}class mt extends at{constructor(e,t){super(e,t,i.TOOLSTATION,"Buildings/Toolstation/Toolstation.ae"),this.blocksPathSurface=!1}get stats(){return tt.stats.Toolstation}}class yt extends at{constructor(e,t){super(e,t,i.UPGRADE,"Buildings/Upgrade/Upgrade.ae")}get stats(){return tt.stats.Upgrade}}class ft extends re{constructor(e){var t;super(e,null,null,null,null),e.surfaceType=d.POWER_PATH_BUILDING_SITE,e.updateTexture(),null===(t=P.getClosestBuildingByType(e.getCenterWorld(),i.TOOLSTATION))||void 0===t||t.spawnMaterials(i.ORE,2),this.neededByType.set(i.ORE,2),P.buildingSites.push(this),h.N.publishEvent(new S)}}class vt extends te{constructor(){super(Q.EAT)}getWorkplaces(){return this.fulfiller.map((e=>new X(e.getPosition2D())))}onJobComplete(){super.onJobComplete()}getWorkActivity(){return z.Eat}}class bt extends te{constructor(e,t){super(Q.GET_TOOL),this.tool=e,this.workplaces=t?[t.getPathTarget()]:P.getBuildingsByType(i.TOOLSTATION).map((e=>new st(e)))}getWorkplaces(){return this.workplaces.some((e=>!e.building.isUsable()))&&(this.workplaces=P.getBuildingsByType(i.TOOLSTATION).map((e=>new st(e)))),this.workplaces}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>e.addTool(this.tool)))}}class wt extends te{constructor(e,t){super(Q.TRAIN),this.training=e,this.building=t,this.workplaces=this.getWorkplaces()}getWorkplaces(){var e;return(null===(e=this.building)||void 0===e?void 0:e.isUsable())||(this.workplaces=[],P.getTrainingSites(this.training).map((e=>e.getTrainingTargets().forEach((e=>this.workplaces.push(e)))))),this.workplaces}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>{e.addTraining(this.training),h.N.publishEvent(new L(this.training))}))}getWorkActivity(){return z.Train}getWorkDuration(e){return 1e4}}class Et extends te{constructor(e){super(Q.TRAIN),this.building=e,this.workplaces=e.getTrainingTargets()}getWorkplaces(){return this.building.isUsable()?this.workplaces:[]}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>{e.level<e.stats.Levels&&e.level++}))}getWorkActivity(){return z.Train}getWorkDuration(e){return 3e4}}class St{constructor(e,t){h.N.registerEventListener(b.Z.COMMAND_PICK_TOOL,(e=>{P.selectedRaiders.forEach((t=>{t.hasTool(e.tool)||t.setJob(new bt(e.tool,null))})),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_CREATE_POWER_PATH,(()=>{new ft(P.selectedSurface)})),h.N.registerEventListener(b.Z.COMMAND_MAKE_RUBBLE,(()=>{var e;null===(e=P.selectedSurface)||void 0===e||e.makeRubble(2),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_PLACE_FENCE,(()=>{var e;const t=P.selectedSurface;t&&(null===(e=P.getClosestBuildingByType(t.getCenterWorld(),i.TOOLSTATION))||void 0===e||e.spawnFence(t)),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_CHANGE_RAIDER_SPAWN_REQUEST,(e=>{e.increase?P.requestedRaiders++:P.requestedRaiders--,h.N.publishEvent(new J(P.requestedRaiders))})),h.N.registerEventListener(b.Z.COMMAND_CREATE_DRILL_JOB,(()=>{var e;null===(e=P.selectedSurface)||void 0===e||e.createDrillJob(),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_CREATE_REINFORCE_JOB,(()=>{var e;null===(e=P.selectedSurface)||void 0===e||e.createReinforceJob(),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_CREATE_DYNAMITE_JOB,(()=>{var e;null===(e=P.selectedSurface)||void 0===e||e.createDynamiteJob(),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_CANCEL_SURFACE_JOBS,(()=>{var e;null===(e=P.selectedSurface)||void 0===e||e.cancelJobs(),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_CREATE_CLEAR_RUBBLE_JOB,(()=>{var e;null===(e=P.selectedSurface)||void 0===e||e.createClearRubbleJob(),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_UPGRADE_BUILDING,(()=>{var e;null===(e=P.selectedBuilding)||void 0===e||e.upgrade()})),h.N.registerEventListener(b.Z.COMMAND_BUILDING_BEAMUP,(()=>{var e;null===(e=P.selectedBuilding)||void 0===e||e.beamUp()})),h.N.registerEventListener(b.Z.COMMAND_CHANGE_BUILDING_POWER_STATE,(e=>{var t,s;e.state?null===(s=P.selectedBuilding)||void 0===s||s.turnOnPower():null===(t=P.selectedBuilding)||void 0===t||t.turnOffPower()})),h.N.registerEventListener(b.Z.COMMAND_RAIDER_EAT,(()=>{P.selectedRaiders.forEach((e=>!e.isDriving()&&e.setJob(new vt))),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_RAIDER_UPGRADE,(()=>{P.selectedRaiders.forEach((e=>{const t=P.getClosestBuildingByType(e.getPosition(),i.TOOLSTATION);t&&e.level<e.stats.Levels&&e.setJob(new Et(t))})),h.N.publishEvent(new S)})),h.N.registerEventListener(b.Z.COMMAND_RAIDER_BEAMUP,(()=>{P.selectedRaiders.forEach((e=>e.beamUp()))})),h.N.registerEventListener(b.Z.COMMAND_TRAIN_RAIDER,(e=>(P.selectedRaiders.forEach((t=>!t.hasTraining(e.training)&&t.setJob(new wt(e.training,null)))),h.N.publishEvent(new S),!0))),h.N.registerEventListener(b.Z.COMMAND_RAIDER_DROP,(()=>{var e;null===(e=P.selectedRaiders)||void 0===e||e.forEach((e=>e.dropItem()))})),h.N.registerEventListener(b.Z.COMMAND_SELECT_BUILD_MODE,(s=>{P.buildModeSelection=St.buildingFromType(s.entityType,e,t)})),h.N.registerEventListener(b.Z.COMMAND_CANCEL_BUILD_MODE,(()=>{P.buildModeSelection=null})),h.N.registerEventListener(b.Z.COMMAND_CANCEL_CONSTRUCTION,(()=>{var e;null===(e=P.selectedSurface.site)||void 0===e||e.cancelSite()}))}static buildingFromType(e,t,s){switch(e){case i.TOOLSTATION:return new mt(t,s);case i.TELEPORT_PAD:return new pt(t,s);case i.DOCKS:return new lt(t,s);case i.POWER_STATION:return new dt(t,s);case i.BARRACKS:return new ot(t,s);case i.UPGRADE:return new yt(t,s);case i.GEODOME:return new ht(t,s);case i.ORE_REFINERY:return new ut(t,s);case i.GUNSTATION:return new ct(t,s);case i.TELEPORT_BIG:return new gt(t,s);default:throw"Unexpected building type: "+i[e]}}}class Tt extends te{constructor(e){super(Q.MOVE),this.target=[new X(e)]}getWorkplaces(){return this.target}}class Rt{constructor(e){this.vec=null,this.targetReached=!1,this.vec=e}}!function(e){e[e.MOVED=0]="MOVED",e[e.TARGET_REACHED=1]="TARGET_REACHED",e[e.TARGET_UNREACHABLE=2]="TARGET_UNREACHABLE"}(Qe||(Qe={}));class At extends Pe{constructor(e,t,s,i,r){super(e,t,s,i,r),this.currentPath=null}getPosition(){return new I.Pa4(this.group.position.x,this.group.position.y,this.group.position.z)}getPosition2D(){return new I.FM8(this.group.position.x,this.group.position.z)}getSpeed(){var e;return(null===(e=this.animation)||void 0===e?void 0:e.transcoef)||1}moveToClosestTarget(e){if((null==e?void 0:e.length)||console.warn("No targets given"),!this.currentPath||!e.some((e=>e.targetLocation.equals(this.currentPath.target.targetLocation)))){const t=e.map((e=>this.findPathToTarget(e))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq));if(this.currentPath=t.length>0?t[0]:null,!this.currentPath)return Qe.TARGET_UNREACHABLE}const t=this.currentPath.firstLocation;this.group.lookAt(new I.Pa4(t.x,this.group.position.y,t.y));const s=this.determineStep();return s.targetReached?Qe.TARGET_REACHED:(this.group.position.add(s.vec),this.changeActivity(this.getRouteActivity()),Qe.MOVED)}findPathToTarget(e){return new qe(e,e.targetLocation)}determineStep(){const e=this.getEntityStep(this.currentPath.firstLocation),t=e.vec.lengthSq(),s=this.getSpeed();if(this.currentPath.locations.length>1){if(t<s*s)return this.currentPath.locations.shift(),this.determineStep()}else t<C.Ob*C.Ob&&(e.targetReached=!0);return e.vec.setLength(Math.min(s,C.Ob)),e}getEntityStep(e){const t=this.sceneMgr.getFloorPosition(e);return t.y+=this.floorOffset,new Rt(t.sub(this.group.position))}}class Lt extends At{constructor(e,t,s,i,r,n){super(e,t,s,i,r),this.workInterval=null,this.job=null,this.followUpJob=null,this.carries=null,this.selectionType=n,this.group.userData={selectable:this},this.workInterval=setInterval(this.work.bind(this),1e3/C.OK)}resetWorkInterval(){this.workInterval=(0,l.nJ)(this.workInterval)}dropItem(){if(!this.carries)return;const e=this.getPosition();this.carryJoint&&(this.carryJoint.remove(this.carries.group),this.carryJoint.getWorldPosition(e)),this.carries.addToScene(new I.FM8(e.x,e.z),null),this.carries=null}pickupItem(e){this.carries=e,this.carryJoint&&this.carryJoint.add(this.carries.group),this.carries.group.position.set(0,0,0)}setJob(e,t=null){this.job!==e&&this.stopJob(),this.job=e,this.job&&this.job.assign(this),this.followUpJob=t,this.followUpJob&&this.followUpJob.assign(this)}stopJob(){this.dropItem(),this.job&&(this.job.unassign(this),this.followUpJob&&this.followUpJob.unassign(this),this.job=null,this.followUpJob=null,this.changeActivity())}getSelectionType(){return this.selectionType}deselect(){this.selectionFrame.visible=!1,this.selected=!1}removeFromScene(){super.removeFromScene(),this.workInterval=(0,l.nJ)(this.workInterval)}}class Mt extends Lt{constructor(e,t){super(e,t,r.RAIDER,i.PILOT,"mini-figures/pilot/pilot.ae",v.RAIDER),this.tools=new Map,this.trainings=new Map,this.slipped=!1,this.tools.set(c.DRILL,!0)}get stats(){return tt.stats.Pilot}findPathToTarget(e){return this.sceneMgr.terrain.findPath(this.getPosition2D(),e)}onDiscover(){super.onDiscover(),P.raidersUndiscovered.remove(this),P.raiders.push(this),h.N.publishEvent(new L),h.N.publishEvent(new we(this.getPosition()))}select(){return this.selectionFrame.visible=!this.slipped,!this.selected&&!this.slipped&&(this.selected=!0,this.changeActivity(),!0)}getSelectionCenter(){return this.pickSphere?(new I.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null}isDriving(){return!1}getSpeed(){return super.getSpeed()*this.stats.RouteSpeed[this.level]*(this.isOnPath()?this.stats.PathCoef:1)}isOnPath(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position).isPath()}isOnRubble(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position).hasRubble()}getRouteActivity(){return this.isOnRubble()?this.carries?z.CarryRubble:z.routeRubble:this.carries?z.Carry:z.Route}moveToClosestTarget(e){var t;const s=super.moveToClosestTarget(e);return this.job.setActualWorkplace(null===(t=this.currentPath)||void 0===t?void 0:t.target),s===Qe.MOVED?P.getNearbySpiders(this).some((e=>{if(this.group.position.distanceToSquared(e.group.position)<this.radiusSq+e.radiusSq)return this.slip(),e.onDeath(),!0})):s===Qe.TARGET_UNREACHABLE&&(console.log("Entity could not move to job target, stopping job"),this.stopJob()),s}slip(){(0,l.$u)(0,100)<10&&this.stopJob(),this.dropItem(),this.slipped=!0,this.playPositionalSample(me.d.SND_Slipup),this.changeActivity(z.Slip,(()=>{this.slipped=!1}))}work(){if(this.job&&!this.selected&&!this.slipped)if(this.job.jobState!==$.INCOMPLETE)this.stopJob();else{const e=this.job.getCarryItem();if(e&&this.carries!==e)this.dropItem(),this.moveToClosestTarget(e.getPositionPathTarget())&&this.changeActivity(z.Collect,(()=>{this.pickupItem(e)}));else if(this.moveToClosestTarget(this.job.getWorkplaces())===Qe.TARGET_REACHED)if(this.job.isReadyToComplete()){const e=this.job.getWorkActivity()||this.getDefaultActivity();this.workAudio||e!==z.Drill||(this.workAudio=this.playPositionalSample(me.d.SFX_Drill,!0)),this.changeActivity(e,(()=>{var e;null===(e=this.workAudio)||void 0===e||e.stop(),this.workAudio=null,this.completeJob()}),this.job.getWorkDuration(this))}else this.changeActivity()}}completeJob(){var e,t;null===(e=this.job)||void 0===e||e.onJobComplete(),(null===(t=this.job)||void 0===t?void 0:t.jobState)!==$.INCOMPLETE&&(this.job&&this.job.unassign(this),this.job=this.followUpJob,this.followUpJob=null,this.changeActivity())}getDefaultActivity(){return this.carries?z.CarryStand:super.getDefaultActivity()}beamUp(){this.stopJob(),super.beamUp(),h.N.publishEvent(new L)}removeFromScene(){super.removeFromScene(),P.raiders.remove(this)}hasTool(e){return!e||this.tools.has(e)}hasTraining(e){return!e||this.trainings.has(e)}addTool(e){this.tools.set(e,!0)}addTraining(e){this.trainings.set(e,!0)}}class Ct extends q{}Ct.Route=new Ct("Activity_Route");class Pt extends At{constructor(e,t,s,i){super(e,t,r.MONSTER,s,i),this.target=[]}removeFromScene(){super.removeFromScene(),this.moveTimeout=(0,l.L4)(this.moveTimeout)}getRouteActivity(){return Ct.Route}}class It extends Pt{constructor(e,t){super(e,t,i.BAT,"Creatures/bat/bat.ae"),this.floorOffset=C.pM/2}get stats(){return tt.stats.Bat}startRandomMove(){It.onMove(this)}static onMove(e){(e.target.length<1||e.moveToClosestTarget(e.target)===Qe.TARGET_REACHED)&&(e.target=[e.findTarget()]),e.moveTimeout=setTimeout((()=>It.onMove(e)),1e3/C.OK)}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.getPosition()).getCenterWorld();for(let s=0;s<20;s++){const s=(0,l.$u)(t.x-(C.pM+C.pM/2),t.x+C.pM+C.pM/2),i=(0,l.$u)(t.z-C.pM/2,t.z+C.pM/2);if(e.getSurfaceFromWorldXZ(s,i).surfaceType.floor)return new X(new I.FM8(s,i))}return console.warn("Could not find a target"),null}onDeath(){this.removeFromScene(),P.bats.remove(this)}}class xt extends Pt{constructor(e,t){super(e,t,i.SMALL_SPIDER,"Creatures/SpiderSB/SpiderSB.ae"),this.floorOffset=1}get stats(){return tt.stats.SmallSpider}startMoving(){xt.onMove(this)}static onMove(e){e.surfaces.forEach((t=>P.spidersBySurface.getOrUpdate(t,(()=>[])).remove(e))),e.target.length>0&&e.moveToClosestTarget(e.target)===Qe.MOVED?(e.surfaces.forEach((t=>P.spidersBySurface.getOrUpdate(t,(()=>[])).push(e))),e.sceneMgr.terrain.getSurfaceFromWorld(e.getPosition()).surfaceType.floor?e.moveTimeout=setTimeout((()=>xt.onMove(e)),1e3/C.OK):e.onDeath()):(e.changeActivity(),e.moveTimeout=setTimeout((()=>{e.target=[e.findTarget()],xt.onMove(e)}),1e3+(0,l.sZ)(9e3)))}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.getPosition()).getCenterWorld();for(let s=0;s<20;s++){const s=(0,l.$u)(t.x-(C.pM+C.pM/2),t.x+C.pM+C.pM/2),i=(0,l.$u)(t.z-C.pM/2,t.z+C.pM/2),r=e.getSurfaceFromWorldXZ(s,i).surfaceType;if(r!==d.WATER&&r!==d.LAVA)return new X(new I.FM8(s,i))}return console.warn("Could not find a target"),null}onDeath(){this.removeFromScene(),P.spiders.remove(this),this.surfaces.forEach((e=>P.spidersBySurface.getOrUpdate(e,(()=>[])).remove(this)))}}var Ot,Nt,Dt,kt=I.M8C.degToRad;class Ft{constructor(e){this.jobs=[],this.assignInterval=null,this.checkRubbleInterval=null,this.worldMgr=e,h.N.registerEventListener(b.Z.JOB_CREATE,(e=>{this.jobs.push(e.job)})),h.N.registerEventListener(b.Z.JOB_DELETE,(e=>{e.job.cancel()}))}start(){stop(),this.assignInterval=setInterval(this.assignJobs.bind(this),C.$I),this.checkRubbleInterval=setInterval(this.checkUnclearedRubble.bind(this),C.Cw)}stop(){this.assignInterval=(0,l.nJ)(this.assignInterval),this.checkRubbleInterval=(0,l.nJ)(this.checkRubbleInterval),P.raiders.forEach((e=>e.resetWorkInterval())),P.raidersUndiscovered.forEach((e=>e.resetWorkInterval()))}assignJobs(){const e=[];this.jobs=this.jobs.filter((t=>{const s=t.jobState===$.INCOMPLETE;return s&&t.fulfiller.length<1&&this.worldMgr.priorityList.isEnabled(t.getPriorityIdentifier())&&e.push(t),s})),e.sort(((e,t)=>Math.sign(this.worldMgr.priorityList.getPriority(e)-this.worldMgr.priorityList.getPriority(t))));const t=P.raiders.filter((e=>!e.job));e.forEach((e=>{let s=null,r=null,n=null,a=null,o=null,l=null,h=null;const c=e.getRequiredTool();let u=null,d=null,g=null,p=null;const m=e.getRequiredTraining();t.forEach(((t,y)=>{const f=t.hasTool(c),v=t.hasTraining(m);if(f&&v){const i=e.getWorkplaces().map((e=>t.findPathToTarget(e))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(i){const e=i.lengthSq;(null===n||e<n)&&(s=t,r=y,n=e)}}else if(f){const e=P.getTrainingSites(m).map((e=>t.findPathToTarget(e.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const s=e.lengthSq;(null===g||s<g)&&(u=t,d=y,g=s,p=e.target.building)}}else{const e=P.getBuildingsByType(i.TOOLSTATION).map((e=>t.findPathToTarget(e.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const s=e.lengthSq;(null===l||s<l)&&(a=t,o=y,l=s,h=e.target.building)}}})),s?(s.setJob(e),t.splice(r,1)):a?(a.setJob(new bt(c,h),e),t.splice(o,1)):u&&(u.setJob(new wt(m,p),e),t.splice(d,1))})),t.forEach((e=>{const t=e.surfaces.map((e=>e.site)).filter((e=>!!e));t.length>0&&e.setJob(new Tt(t[0].getWalkOutSurface().getRandomPosition()))}))}checkUnclearedRubble(){this.worldMgr.priorityList.isEnabled(ee.aiPriorityClearing)&&P.raiders.forEach((e=>{if(e.job)return;const t=e.sceneMgr.terrain.getSurfaceFromWorld(e.getPosition());for(let s=0;s<10;s++)for(let r=t.x-s;r<=t.x+s;r++)for(let n=t.y-s;n<=t.y+s;n++){const t=e.sceneMgr.terrain.getSurfaceOrNull(r,n);if(!(null==t?void 0:t.hasRubble())||!(null==t?void 0:t.discovered))continue;const s=t.createClearRubbleJob();if(!s)continue;const a=s.getRequiredTool();if(e.hasTool(a))e.setJob(s);else{const t=P.getBuildingsByType(i.TOOLSTATION).map((t=>e.findPathToTarget(t.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];t&&e.setJob(new bt(a,t.target.building),s)}}}))}}class Bt{constructor(e=!1){this.debug=!1,this.onLevelEnd=null,this.nerpInterval=null,this.registers=new Array(8).fill(0),this.timers=new Array(4).fill(0),this.scriptLines=[],this.statements=[],this.macrosByName={},this.labelsByName={},this.halted=!1,this.programCounter=0,this.messages=[],this.messagePermit=null,this.debug=e}startExecution(){const e=this;this.nerpInterval=setInterval((()=>{e.execute()}),2e3)}pauseExecution(){this.nerpInterval=(0,l.nJ)(this.nerpInterval)}checkRegister(e){const t=parseInt(e);if(isNaN(t)||t<0||t>this.registers.length)throw new Error("Invalid register ("+e+") provided");return t}checkRegisterValue(e){const t=parseInt(e);if(isNaN(t))throw new Error("Invalid register value ("+e+") provided");return t}getR(e){return e=this.checkRegister(e),this.registers[e]}setR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]=t}addR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]+=t}setTimer(e,t){const s=parseInt(t);if(isNaN(s))throw new Error("Can't set timer to NaN value: "+t);this.timers[e]=(new Date).getTime()+s}getTimer(e){return(new Date).getTime()-this.timers[e]}setLevelCompleted(){console.log("Nerp runner marks level as complete"),this.halted=!0,P.resultState=M.COMPLETE,this.onLevelEnd()}setLevelFail(){console.log("NerpRunner marks level as failed; at line: "+this.scriptLines[this.programCounter]),this.halted=!0,P.resultState=M.FAILED,this.onLevelEnd()}setTutorialFlags(e){0!==e&&console.warn("NERP: setTutorialFlags not yet implemented",e)}setMessagePermit(e){this.messagePermit=!e}setBuildingsUpgradeLevel(e,t){P.buildings.forEach((s=>{s.entityType===e&&(s.level=t)}))}setToolStoreLevel(e){this.setBuildingsUpgradeLevel(i.TOOLSTATION,e)}setTeleportPadLevel(e){this.setBuildingsUpgradeLevel(i.TELEPORT_PAD,e)}setPowerStationLevel(e){this.setBuildingsUpgradeLevel(i.POWER_STATION,e)}setBarracksLevel(e){this.setBuildingsUpgradeLevel(i.BARRACKS,e)}getToolStoresBuilt(){return P.buildings.count((e=>e.entityType===i.TOOLSTATION))}getMinifiguresOnLevel(){return P.raiders.length}getCrystalsCurrentlyStored(){return P.numCrystal}getObjectiveSwitch(){return!1}setMessageTimerValues(e,t,s){}getMessageTimer(){return 0}cameraUnlock(){}setMessage(e,t){if(!this.messagePermit)return;if(0===e)return;const s=this.messages[e];console.log(s.txt)}setCameraGotoTutorial(e){}getTutorialBlockIsGround(e){return 0}getTutorialBlockIsPath(e){return 0}getUnitAtBlock(e){return 0}getOxygenLevel(){return 100*P.airLevel}getObjectiveShowing(){return!1}addPoweredCrystals(){}disallowAll(){}getPoweredPowerStationsBuilt(){return P.buildings.count((e=>e.isUsable()&&e.entityType===i.POWER_STATION))}getPoweredBarracksBuilt(){return P.buildings.count((e=>e.isUsable()&&e.entityType===i.BARRACKS))}getRecordObjectAtTutorial(){}getHiddenObjectsFound(){return 0}getLevel1PowerStationsBuilt(){return P.buildings.count((e=>e.entityType===i.POWER_STATION&&e.level>=1))}getRandom100(){return(0,l.sZ)(100)}getSlugsOnLevel(){return 0}generateSlug(){console.warn("Slugs not yet implemented")}callMethod(e,t){if("Stop"===e)throw"Stop";if("TRUE"===e)return!0;if("FALSE"===e)return!1;const s=e.match(/^SetR([0-7])$/);if(s)return this.setR(s[1],t[0]);const i=e.match(/^AddR([0-7])$/);if(i)return this.addR(i[1],t[0]);const r=e.match(/^GetR([0-7])$/);if(r)return this.getR(r[1]);const n=e.match(/^SetTimer([0-3])$/);if(n)return this.setTimer(n[1],t[0]);const a=e.match(/^GetTimer([0-3])$/);if(a)return this.getTimer(a[1]);const o=e.toLowerCase(),l=Object.getOwnPropertyNames(Bt.prototype).find((e=>e.toLowerCase()===o));if(l)return this[l].apply(this,t);throw new Error("Undefined method: "+e)}conditional(e,t){const s=this.executeStatement(e);this.debug&&console.log("Condition evaluated to "+s),s&&this.executeStatement(t)}executeStatement(e){if(e.invoke){const t="conditional"!==e.invoke?e.args.map((e=>this.executeStatement(e))):e.args,s=this.callMethod(e.invoke,t);return void 0!==s&&this.debug&&console.log("Method returned: "+s),s}if(e.comparator){const t=this.executeStatement(e.left),s=this.executeStatement(e.right);if("="===e.comparator)return t===s;if("!="===e.comparator)return t!==s;if("<"===e.comparator)return t<s;if(">"===e.comparator)return t>s;throw console.log(e),new Error("Unknown comparator: "+e.comparator)}if(!isNaN(e))return e;if(!e.jump)throw console.log(e),new Error("Unknown expression in line "+this.programCounter+": "+e);if(this.programCounter=this.labelsByName[e.jump],void 0===this.programCounter)throw new Error("Label '"+e.jump+"' is unknown!");this.debug&&console.log("Jumping to label '"+e.jump+"' in line "+this.programCounter)}execute(e=!1){if(this.debug=e,!this.halted)try{for(this.debug&&(console.log("Executing following script\n"+this.scriptLines.join("\n")),console.log("Registers: "+this.registers)),this.programCounter=0;this.programCounter<this.statements.length;this.programCounter++){const e=this.statements[this.programCounter];this.debug&&(console.log(this.programCounter+": "+this.scriptLines[this.programCounter]),console.log(e)),e.label||this.executeStatement(e)}}catch(e){if("Stop"===e)return;console.error(e),console.error("FATAL ERROR! Script execution failed! You can NOT win anymore!"),this.halted=!0}}}class _t{static parse(e){const t=new Bt,s=e.split("\n").map((e=>e.split("//")[0].trim().split(";")[0].trim().replace(/_/g,"").replace(/\bTRUE \? /,"").replace(/[{}]/g,"")));for(let e=0;e<s.length;e++){const i=s[e];if(!(i.length<1))if(i.startsWith("#include ")){const e=i.replace(/^#include /,"").trim().slice(1,-1);if("nerpdef.h"===e)continue;const s=_t.parse(tt.getResource("Levels/"+e));if(!s||!s.scriptLines||s.scriptLines.length<1)throw"Can't include unknown nerp script: "+i;t.scriptLines=t.scriptLines.concat(s.scriptLines),t.macrosByName=Object.assign({},t.macrosByName,s.macrosByName)}else if(i.startsWith("#define ")){const r=i.replace(/^#define /,"").split(" "),n=[r.splice(1).join(" ").replace(/\\$/,"").trim()];let a=i,o=!1;for(;a.endsWith("\\")&&e<s.length-1;){e++,a=s[e].trim();const t=a.replace(/\\$/,"").trim();t.length>0&&(o?(o=!1,n[n.length-1]+=t):n.push(t)),a.match(/:\\$/)&&(o=!0)}const l=r[0].split("(");t.macrosByName[l[0]]={args:l[1].replace(/\)$/,"").split(","),lines:n}}else t.scriptLines=t.scriptLines.concat(this.replaceMacros(t.macrosByName,i))}for(let e=0;e<t.scriptLines.length;e++){const s=t.scriptLines[e];t.statements[e]=s.replace(/\(\)/g,"").split(" ? ");const i=s.match(/(\S+):/);if(2===t.statements[e].length)t.statements[e]={invoke:"conditional",args:[this.preProcess(t.statements[e][0]),this.preProcess(t.statements[e][1])]};else if(i){const s=i[1].toLowerCase();t.labelsByName[s]=e,t.statements[e]={label:s}}else{if(1!==t.statements[e].length)throw"Can't deal with line: "+s;t.statements[e]=this.preProcess(t.statements[e][0])}}return t}static replaceMacros(e,t){const s=t.split("("),i=e[s[0]];if(i){const r=s.splice(1).join("(").slice(0,-1).split(",");if(r.length!==i.args.length)throw"Invalid number of args provided for macro in line "+t;const n=[];return i.lines.forEach((t=>{for(let e=0;e<r.length;e++)t=t.replace(new RegExp("\\b"+i.args[e]+"\\b"),r[e]);n.push(...this.replaceMacros(e,t))})),n}return[t]}static preProcess(e){e=e.trim().replace(/^_/,"");const t=parseInt(e);if(!isNaN(t))return t;const s=e.split(/ (=) | (!=) | (>) | (<) /).filter((e=>void 0!==e)),i=e.match(/^(.+)\((.+)\)$/),r=e.split(" "),n=e.match(/([^:]+):$/),a=e.match(/^:([^:]+)$/);if(3===s.length)return{left:this.preProcess(s[0]),comparator:s[1],right:this.preProcess(s[2])};if(i){const e=i[2].split(",").map((e=>this.preProcess(e)));return{invoke:i[1],args:e}}if(r.length>1){const e=2===r.length?[this.preProcess(r[1])]:r.splice(1).map((e=>this.preProcess(e)));return{invoke:r[0],args:e}}if(n)return{label:n[1]};if(a)return{jump:a[1].toLowerCase()};if(e.match(/[ =?><!]/))throw"Invalid expression given, parsing must have failed before somewhere";return{invoke:e,args:[]}}}class Ut{constructor(){this.levelDefault=[],this.current=[]}setList(e){this.levelDefault=e,this.reset()}toggle(e){this.current[e].enabled=!this.current[e].enabled}upOne(e){const t=this.current[e];this.current[e]=this.current[e+1],this.current[e+1]=t}reset(){this.current=this.levelDefault.map((e=>new Wt(e)))}pushToTop(e){const t=this.current[e];for(let t=e;t>0;t--)this.current[t]=this.current[t-1];this.current[0]=t}getPriority(e){let t=0;return this.current.some(((s,i)=>{if(s.key===e.getPriorityIdentifier())return t=i,!0})),t}isEnabled(e){var t;return(null===(t=this.current.find((t=>t.key===e)))||void 0===t?void 0:t.enabled)||!1}}class Wt{constructor(e){this.key=e.key,this.enabled=e.enabled}}class Gt{constructor(){this.nerpRunner=null,this.oxygenUpdateInterval=null,this.priorityList=new Ut,h.N.registerEventListener(b.Z.SELECTION_CHANGED,(e=>{e.selectionType===v.NOTHING&&P.selectEntities([])})),h.N.registerEventListener(b.Z.CAVERN_DISCOVERED,(()=>{P.discoveredCaverns++})),this.oxygenUpdateInterval=setInterval(this.updateOxygen.bind(this),C.SO)}setup(e,t){var s,i;P.totalCaverns=(null===(i=null===(s=e.reward)||void 0===s?void 0:s.quota)||void 0===i?void 0:i.caverns)||0,this.priorityList.setList(e.priorities),h.N.publishEvent(new R(this.priorityList.levelDefault)),P.oxygenRate=e.oxygenRate,this.nerpRunner=_t.parse(tt.getResource(e.nerpFile)),this.nerpRunner.messages.push(...tt.getResource(e.nerpMessageFile)),this.nerpRunner.onLevelEnd=t}start(){var e;null===(e=this.nerpRunner)||void 0===e||e.startExecution(),P.levelStartTime=Date.now()}stop(){var e;P.levelStopTime=Date.now(),null===(e=this.nerpRunner)||void 0===e||e.pauseExecution(),P.buildings.forEach((e=>e.removeFromScene())),P.buildingsUndiscovered.forEach((e=>e.removeFromScene())),P.raiders.forEach((e=>e.removeFromScene())),P.raidersUndiscovered.forEach((e=>e.removeFromScene())),P.materials.forEach((e=>e.removeFromScene())),P.materialsUndiscovered.forEach((e=>e.removeFromScene())),P.spiders.forEach((e=>e.removeFromScene())),P.bats.forEach((e=>e.removeFromScene()))}placeMaterial(e,t){return e.addToScene(t,0),e.group.visible?(P.materials.push(e),h.N.publishEvent(new G(e.createCarryJob()))):P.materialsUndiscovered.push(e),e}updateOxygen(){const e=(P.raiders.map((e=>e.stats.OxygenCoef)).reduce(((e,t)=>e+t),0)+P.buildings.map((e=>e.isUsable()?e.stats.OxygenCoef:0)).reduce(((e,t)=>e+t),0))*P.oxygenRate*.001*.04*C.SO*.001/10,t=Math.min(1,Math.max(0,P.airLevel+e));P.airLevel!==t&&(P.airLevel=t,h.N.publishEvent(new T(P.airLevel)))}}class Ht{constructor(e,t){this.active=!0,this.canvas=document.createElement("canvas"),e||(this.canvas.style.background="#f0f"),t&&(this.context=this.canvas.getContext("2d",{alpha:e})),this.hide()}reset(){}setZIndex(e){this.canvas.style.zIndex=String(e)}static compareZ(e,t){var s,i,r,n;let a=(null===(i=null===(s=null==e?void 0:e.canvas)||void 0===s?void 0:s.style)||void 0===i?void 0:i.zIndex)||0;const o=(null===(n=null===(r=null==t?void 0:t.canvas)||void 0===r?void 0:r.style)||void 0===n?void 0:n.zIndex)||0;return a===o?0:a>o?-1:1}resize(e,t){this.canvas.width=e,this.canvas.height=t}redraw(){const e=this.onRedraw;if(this.isActive()&&e){const t=this.context;requestAnimationFrame((()=>e(t)))}}show(){this.reset(),this.active=!0,this.canvas.style.visibility="visible",this.redraw()}hide(){this.active=!1,this.canvas.style.visibility="hidden"}isActive(){return this.active}toCanvasCoords(e,t){const s=this.canvas.getBoundingClientRect();return[e-s.left,t-s.top]}handlePointerEvent(e){return new Promise((e=>e(!1)))}handleKeyEvent(e){return new Promise((e=>e(!1)))}handleWheelEvent(e){return new Promise((e=>e(!1)))}}class Jt extends Ht{constructor(e=!0,t=!0){super(e,t),this.fixedWidth=C.Du,this.fixedHeight=C.DG,this.updateScale()}updateScale(){this.scaleX=this.canvas.width/this.fixedWidth,this.scaleY=this.canvas.height/this.fixedHeight}toScaledCoords(e,t){const[s,i]=this.toCanvasCoords(e,t);return[s/this.scaleX,i/this.scaleY].map((e=>Math.round(e)))}resize(e,t){super.resize(e,t),this.updateScale(),this.context.scale(this.scaleX,this.scaleY)}}!function(e){e[e.MAIN=0]="MAIN",e[e.MIDDLE=1]="MIDDLE",e[e.SECONDARY=2]="SECONDARY"}(Ot||(Ot={})),function(e){e[e.MOVE=0]="MOVE",e[e.DOWN=1]="DOWN",e[e.UP=2]="UP"}(Nt||(Nt={})),function(e){e[e.DOWN=0]="DOWN",e[e.UP=1]="UP"}(Dt||(Dt={}));class Vt{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.key=t.key,this.code=t.code}}class jt{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.clientX=t.clientX,this.clientY=t.clientY,this.pointerType=t.pointerType,this.button=t.button,this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.shiftKey=t.shiftKey}}class Zt{constructor(e){this.type=e.type,this.bubbles=!1,this.clientX=e.clientX,this.clientY=e.clientY,this.deltaX=e.deltaX,this.deltaY=e.deltaY,this.deltaZ=e.deltaZ,this.button=e.button,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey}}class Yt{constructor(e){e.gameCanvasContainer.addEventListener("contextmenu",(t=>{e.isInRect(t)&&t.preventDefault()})),new Map([["pointermove",Nt.MOVE],["pointerdown",Nt.DOWN],["pointerup",Nt.UP]]).forEach(((t,s)=>{e.gameCanvasContainer.addEventListener(s,(s=>{if(!e.isInRect(s))return;s.preventDefault();const i=new jt(t,s),r=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Ht.compareZ(e,t)));Yt.publishPointerEvent(r,i)}))})),new Map([["keydown",Dt.DOWN],["keyup",Dt.UP]]).forEach(((t,s)=>{e.gameCanvasContainer.addEventListener(s,(s=>{C.Sl||s.preventDefault();const i=new Vt(t,s),r=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Ht.compareZ(e,t)));Yt.publishKeyEvent(r,i)}))})),e.gameCanvasContainer.addEventListener("wheel",(t=>{if(!e.isInRect(t))return;const s=new Zt(t),i=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Ht.compareZ(e,t)));Yt.publishWheelEvent(i,s)}))}static publishPointerEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handlePointerEvent(t).then((s=>{s||this.publishPointerEvent(e,t)}))}static publishKeyEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handleKeyEvent(t).then((s=>{s||this.publishKeyEvent(e,t)}))}static publishWheelEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handleWheelEvent(t).then((s=>{s||this.publishWheelEvent(e,t)}))}}class qt extends Ht{constructor(e){super(!0,!1),this.currentCursor=null,this.timedCursor=null,this.cursorTimeout=null,this.activeCursor=null,e.registerEventListener(b.Z.CHANGE_CURSOR,(e=>{this.active&&this.changeCursor(e.cursor,e.timeout)}))}reset(){this.changeCursor(u.C.Pointer_Standard)}hide(){var e;super.hide(),this.canvas.style.cursor=null,this.currentCursor=null,this.timedCursor=null,this.cursorTimeout=(0,l.L4)(this.cursorTimeout),null===(e=this.activeCursor)||void 0===e||e.disableAnimation(),this.activeCursor=null}handlePointerEvent(e){if(e.eventEnum===Nt.MOVE&&this.sceneMgr){const[t,s]=this.toCanvasCoords(e.clientX,e.clientY),i=t/this.canvas.width*2-1,r=-s/this.canvas.height*2+1,n=new I.iMs;n.setFromCamera({x:i,y:r},this.sceneMgr.camera),this.changeCursor(this.determineCursor(n))}return super.handlePointerEvent(e)}determineCursor(e){if(P.buildModeSelection)return this.sceneMgr.buildMarker.lastCheck?u.C.Pointer_CanBuild:u.C.Pointer_CannotBuild;if(e.intersectObjects(P.raiders.map((e=>e.pickSphere))).length>0)return u.C.Pointer_Selected;{let t=e.intersectObjects(P.buildings.map((e=>e.pickSphere)));if(t.length>0)return u.C.Pointer_Selected;if(t=e.intersectObjects(this.sceneMgr.terrain.floorGroup.children),t.length>0){const e=t[0].object.userData;if(e&&e.hasOwnProperty("surface")){const t=e.surface;if(t)return P.selectionType===v.RAIDER||P.selectionType===v.VEHICLE||P.selectionType===v.GROUP?t.isDrillable()?u.C.Pointer_Drill:t.surfaceType.cursorFulfiller:t.surfaceType.cursor}}}return u.C.Pointer_Standard}changeCursor(e,t=null){if(t){this.cursorTimeout=(0,l.L4)(this.cursorTimeout),this.timedCursor!==e&&this.setCursor(e);const s=this;this.cursorTimeout=setTimeout((()=>{s.cursorTimeout=null,s.setCursor(s.currentCursor)}),t)}else if(this.currentCursor!==e){if(this.currentCursor=e,this.cursorTimeout)return;this.setCursor(e)}}setCursor(e){var t;null===(t=this.activeCursor)||void 0===t||t.disableAnimation(),this.activeCursor=tt.getCursor(e),this.activeCursor.enableAnimation(this.canvas.style)}}class Kt{constructor(){if(this.layers=[],this.width=C.Du,this.height=C.DG,this.ratio=C.Du/C.DG,this.gameCanvasContainer=document.getElementById("game-canvas-container"),this.gameCanvasContainer.focus(),this.eventMgr=new Yt(this),!this.gameCanvasContainer)throw"Fatal error: game canvas container not found!";window.addEventListener("resize",(()=>this.onWindowResize())),this.onWindowResize(),this.cursorLayer=this.addLayer(new qt(this),1e3)}addLayer(e,t=0){return e.resize(this.width,this.height),e.setZIndex(t),this.layers.push(e),this.gameCanvasContainer.appendChild(e.canvas),e}redraw(){this.layers.forEach((e=>e.redraw()))}show(){this.layers.forEach((e=>e.show())),this.redraw()}hide(){this.layers.forEach((e=>e.hide()))}onWindowResize(){const e=this.gameCanvasContainer.offsetWidth,t=this.gameCanvasContainer.offsetHeight,s=Math.round(e/this.ratio);s>t?this.resize(Math.round(t*this.ratio),t):this.resize(e,s)}resize(e,t){this.width=e,this.height=t,this.layers.forEach((s=>{const i=s.canvas;s.resize(e,t),i!==s.canvas&&(this.gameCanvasContainer.removeChild(i),this.gameCanvasContainer.appendChild(s.canvas))})),this.redraw()}isInRect(e){if(this.layers.length<1)return!1;const t=this.layers[0];if(!t.isActive()||!t.canvas)return!1;const s=t.canvas.getBoundingClientRect(),i=e.clientX,r=e.clientY;return i>=s.left&&i<s.right&&r>=s.top&&r<s.bottom}publishEvent(e){h.N.publishEvent(e)}registerEventListener(e,t){h.N.registerEventListener(e,t)}}class zt extends Ht{constructor(e){super(!1,!1),this.rightDown={x:0,y:0},this.parent=e}reset(){super.reset(),this.rightDown={x:0,y:0}}handlePointerEvent(e){const t=this.sceneMgr.buildMarker;if(e.eventEnum===Nt.MOVE){const s=this.getTerrainPositionFromEvent(e);s&&this.sceneMgr.setTorchPosition(s),t.update(s)}else if(e.eventEnum===Nt.UP){if(e.button===Ot.MAIN){if(P.buildModeSelection&&t.lastCheck)return t.createBuildingSite(),new Promise((e=>e(!0)))}else if(e.button===Ot.SECONDARY&&Math.abs(e.clientX-this.rightDown.x)+Math.abs(e.clientY-this.rightDown.y)<3)if(P.selectionType===v.RAIDER||P.selectionType===v.GROUP){const t=this.getTerrainPositionFromEvent(e);if(t){const e=this.sceneMgr.terrain.getSurfaceFromWorldXZ(t.x,t.y);e&&(e.isDrillable()?this.assignSurfaceJob(e.createDrillJob(),e,t):e.hasRubble()?this.assignSurfaceJob(e.createClearRubbleJob(),e,t):e.isWalkable()&&(P.selectedEntities.forEach((e=>e.setJob(new Tt(t)))),P.selectedEntities.length>0&&this.publishEvent(new S)))}}else P.buildModeSelection&&(P.buildModeSelection=null,t.hideAllMarker())}else e.eventEnum===Nt.DOWN&&e.button===Ot.SECONDARY&&(this.rightDown.x=e.clientX,this.rightDown.y=e.clientY);return this.canvas.dispatchEvent(new PointerEvent(e.type,e)),new Promise((e=>e(!0)))}handleKeyEvent(e){if(C.Sl&&e.eventEnum===Dt.UP&&P.selectionType===v.SURFACE){if("KeyC"===e.code)return P.selectedEntities.forEach((e=>{e.surfaceType.floor||e.collapse()})),this.publishEvent(new S),new Promise((e=>e(!0)));if("KeyF"===e.code)return P.selectedEntities.forEach((e=>{const t=e.terrain.findFallInTarget(e.x,e.y);e.surfaceType.floor||e.createFallin(t[0],t[1])})),this.publishEvent(new S),new Promise((e=>e(!0)))}return this.canvas.dispatchEvent(new KeyboardEvent(e.type,e)),new Promise((e=>e(!0)))}assignSurfaceJob(e,t,s){e&&(P.selectedEntities.forEach((i=>{i.hasTool(e.getRequiredTool())&&i.hasTraining(e.getRequiredTraining())?i.setJob(e):t.isWalkable()&&i.setJob(new Tt(s))})),P.selectedEntities.length>0&&this.publishEvent(new S))}getTerrainPositionFromEvent(e){const[t,s]=this.toCanvasCoords(e.clientX,e.clientY),i=t/this.canvas.width*2-1,r=-s/this.canvas.height*2+1;return this.sceneMgr.getTerrainIntersectionPoint(i,r)}handleWheelEvent(e){return this.canvas.dispatchEvent(new WheelEvent(e.type,e)),new Promise((e=>e(!0)))}publishEvent(e){var t;null===(t=this.parent)||void 0===t||t.publishEvent(e)}registerEventListener(e,t){this.parent.registerEventListener(e,t)}}var Xt=I.M8C.generateUUID;class $t extends Ht{constructor(e){super(!0,!1),this.resolveCallbackByEventId=new Map,this.worker=e,this.sendMessage({type:et.n.INIT,resourceByName:tt.resourceByName,cfg:tt.configuration,stats:tt.stats}),this.worker.onmessage=e=>{const t=e.data;if(t.type===et.n.RESPONSE_EVENT){const e=t;this.resolveCallbackByEventId.get(e.eventId)(e.eventConsumed),this.resolveCallbackByEventId.delete(e.eventId)}else if(t.type===et.n.GAME_EVENT){const e=t.gameEvent;e.eventKey===b.Z.PLAY_SOUND&&ye.P.playSample(e.sample),h.N.publishEvent(e)}else this.onMessage(t)||console.warn("Offscreen layer ignored message: "+et.n[t.type])},h.N.registerWorkerListener((e=>{if(e.guiForward)try{this.sendMessage({type:et.n.GAME_EVENT,gameEvent:e})}catch(t){console.warn("Could not send event to GUI worker: ",t,e)}}))}sendMessage(e,t){this.worker.postMessage(e,t)}reset(){this.sendMessage({type:et.n.RESET}),this.sendMessage({type:et.n.GAME_EVENT,gameEvent:new A}),this.sendMessage({type:et.n.GAME_EVENT,gameEvent:new L}),this.sendMessage({type:et.n.GAME_EVENT,gameEvent:new V})}resize(e,t){const s=Number(this.canvas.style.zIndex)||0;this.canvas=document.createElement("canvas"),this.active||(this.canvas.style.visibility="hidden"),super.resize(e,t),this.setZIndex(s);const i=this.canvas.transferControlToOffscreen();this.sendMessage({type:et.n.CANVAS,canvas:i},[i])}redraw(){this.isActive()&&this.sendMessage({type:et.n.REDRAW})}handlePointerEvent(e){return[e.canvasX,e.canvasY]=this.toCanvasCoords(e.clientX,e.clientY),this.sendEventMessage(et.n.EVENT_POINTER,e)}handleKeyEvent(e){return this.sendEventMessage(et.n.EVENT_KEY,e)}handleWheelEvent(e){return[e.canvasX,e.canvasY]=this.toCanvasCoords(e.clientX,e.clientY),this.sendEventMessage(et.n.EVENT_POINTER,e)}sendEventMessage(e,t){const s=Xt();return this.sendMessage({type:e,eventId:s,inputEvent:t}),new Promise((e=>this.resolveCallbackByEventId.set(s,e)))}}class Qt extends $t{constructor(){super(new Worker(new URL(s.p+s.u(294),s.b))),this.onOptionsShow=()=>console.log("Show options triggered")}onMessage(e){return e.type===et.n.SHOW_OPTIONS&&(this.onOptionsShow(),!0)}setSpaceToContinue(e){this.sendMessage({type:et.n.SPACE_TO_CONINUE,messageState:e})}}class es extends $t{constructor(){super(new Worker(new URL(s.p+s.u(372),s.b))),this.onSetSpaceToContinue=e=>console.log("set space to continue: "+e),this.onAbortGame=()=>console.log("abort the game"),this.onRestartGame=()=>console.log("pause the game")}onMessage(e){if(e.type===et.n.SPACE_TO_CONINUE)this.onSetSpaceToContinue(e.messageState);else if(e.type===et.n.GAME_ABORT)this.onAbortGame();else{if(e.type!==et.n.GAME_RESTART)return!1;this.onRestartGame()}return!0}setup(e,t){this.sendMessage({type:et.n.OVERLAY_SETUP,objectiveText:e,objectiveBackImgCfg:t})}showOptions(){this.sendMessage({type:et.n.SHOW_OPTIONS})}}class ts extends Ht{constructor(){super(!0,!0),this.selectStart=null}reset(){super.reset(),this.selectStart=null}handlePointerEvent(e){if(P.buildModeSelection)return new Promise((e=>e(!1)));const[t,s]=this.toCanvasCoords(e.clientX,e.clientY);if(e.eventEnum===Nt.DOWN){if(e.button===Ot.MAIN)return new Promise((e=>e(this.startSelection(t,s))))}else{if(e.eventEnum===Nt.MOVE)return new Promise((e=>e(this.changeSelection(t,s))));if(e.eventEnum===Nt.UP&&e.button===Ot.MAIN)return new Promise((e=>e(this.selectEntities(t,s))))}return new Promise((e=>e(!1)))}startSelection(e,t){return this.selectStart={x:e,y:t},!0}changeSelection(e,t){return!!this.selectStart&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="rgba(128, 192, 192, 0.5)",this.context.lineWidth=2,this.context.strokeRect(this.selectStart.x,this.selectStart.y,e-this.selectStart.x,t-this.selectStart.y),!0)}selectEntities(e,t){if(!this.selectStart)return!1;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);const s=this.selectStart.x/this.canvas.width*2-1,i=-this.selectStart.y/this.canvas.height*2+1,r=e/this.canvas.width*2-1,n=-t/this.canvas.height*2+1;if(Math.abs(e-this.selectStart.x)<5&&Math.abs(t-this.selectStart.y)<5){const s=(this.selectStart.x+e)/this.canvas.width-1,i=-(this.selectStart.y+t)/this.canvas.height+1;this.sceneMgr.selectEntitiesByRay(s,i)}else this.sceneMgr.selectEntitiesInFrustum(s,i,r,n);return this.selectStart=null,!0}}var ss=I.M8C.degToRad;class is extends Kt{constructor(){super(),this.onLevelEnd=()=>console.log("Level aborted"),this.spawnRaiderInterval=null,this.gameLayer=this.addLayer(new zt(this),0),this.selectionLayer=this.addLayer(new ts,10),this.guiLayer=this.addLayer(new Qt,20),this.overlayLayer=this.addLayer(new es,30),this.worldMgr=new Gt,this.gameLayer.worldMgr=this.worldMgr,this.sceneMgr=new ze(this.gameLayer.canvas),this.cursorLayer.sceneMgr=this.sceneMgr,this.gameLayer.sceneMgr=this.sceneMgr,this.selectionLayer.sceneMgr=this.sceneMgr,this.jobSupervisor=new Ft(this.worldMgr),this.guiMgr=new St(this.worldMgr,this.sceneMgr),this.guiLayer.onOptionsShow=()=>this.overlayLayer.showOptions(),this.overlayLayer.onSetSpaceToContinue=e=>this.guiLayer.setSpaceToContinue(e),this.overlayLayer.onAbortGame=()=>this.onLevelEnd(),this.overlayLayer.onRestartGame=()=>this.restartLevel(),this.registerEventListener(b.Z.REQUESTED_RAIDERS_CHANGED,(()=>{P.requestedRaiders>0&&!this.spawnRaiderInterval&&(this.spawnRaiderInterval=setInterval(this.checkSpawnRaiders.bind(this),C.IL))}))}startLevel(e,t){this.levelName=e,this.levelConf=t,this.setupAndStartLevel()}restartLevel(){this.hide(),P.reset(),this.setupAndStartLevel()}setupAndStartLevel(){console.log("Starting level "+this.levelName+" - "+this.levelConf.fullName),this.worldMgr.setup(this.levelConf,(()=>this.onLevelEnd())),this.sceneMgr.setupScene(this.levelConf,this.worldMgr);const e=(0,l.hh)(tt.getResource(this.levelConf.objectiveText),this.levelName);this.guiLayer.reset(),this.overlayLayer.setup(e.objective,this.levelConf.objectiveImage640x480);const t=tt.getResource(this.levelConf.oListFile);(class{static loadObjectList(e,t,s,i){Object.values(s).forEach((s=>{const r=s.type?s.type.toLowerCase():s.type,n=new I.FM8(s.xPos,s.yPos).addScalar(-1).multiplyScalar(C.pM),a=tt.cfg("BuildingTypes",s.type),o=kt(s.heading);if(r==="TVCamera".toLowerCase()){console.log("Camera heading: "+Math.round(s.heading%360)),console.log("Camera target: "+(s.xPos-1)+"/"+(s.yPos-1));const e=new I.FM8(6,0).rotateAround(new I.FM8(0,0),o+Math.PI/2),i=t.getFloorPosition(e.multiplyScalar(C.pM).add(n));i.y+=4*C.pM,t.camera.position.copy(i),t.controls.target.copy(t.getFloorPosition(n)),t.controls.update(),t.setTorchPosition(new I.FM8(n.x,n.y-C.pM/2))}else if(r==="Pilot".toLowerCase()){const s=new Mt(e,t);s.changeActivity(),s.createPickSphere(),s.addToScene(n,o-Math.PI/2),s.group.visible?(P.raiders.push(s),h.N.publishEvent(new L)):P.raidersUndiscovered.push(s)}else if(a)console.log(s.type+" heading: "+Math.round(s.heading%360)),this.createBuildingByName(a,e,t).placeDown(n,-o-Math.PI,i);else if(r==="PowerCrystal".toLowerCase())e.placeMaterial(new Fe(e,t),n);else if(r==="SmallSpider".toLowerCase()){const s=new xt(e,t);s.changeActivity(),s.addToScene(n,o),P.spiders.push(s),s.surfaces.forEach((e=>P.spidersBySurface.getOrUpdate(e,(()=>[])).push(s))),s.startMoving()}else if(r==="Bat".toLowerCase()){const s=new It(e,t);s.changeActivity(),s.addToScene(n,o),P.bats.push(s),s.startRandomMove()}else console.warn("Object type "+s.type+" not yet implemented")}))}static createBuildingByName(e,t,s){const i=e.slice(e.lastIndexOf("/")+1).toLowerCase();if("toolstation"===i)return new mt(t,s);if("teleports"===i)return new pt(t,s);if("docks"===i)return new lt(t,s);if("powerstation"===i)return new dt(t,s);if("barracks"===i)return new ot(t,s);if("upgrade"===i)return new yt(t,s);if("geo-dome"===i)return new ht(t,s);if("orerefinery"===i)return new ut(t,s);if("gunstation"===i)return new ct(t,s);if("teleportbig"===i)return new gt(t,s);throw"Unknown building type: "+i}}).loadObjectList(this.worldMgr,this.sceneMgr,t,this.levelConf.disableStartTeleport),this.show()}show(){super.show(),this.sceneMgr.startScene(),this.worldMgr.start(),this.jobSupervisor.start()}hide(){this.spawnRaiderInterval=(0,l.nJ)(this.spawnRaiderInterval),this.jobSupervisor.stop(),this.worldMgr.stop(),this.sceneMgr.disposeScene(),super.hide()}resize(e,t){var s;super.resize(e,t),null===(s=this.sceneMgr)||void 0===s||s.resize(e,t)}checkSpawnRaiders(){if(P.requestedRaiders<1)return void(this.spawnRaiderInterval=(0,l.nJ)(this.spawnRaiderInterval));if(P.raiders.length>=P.getMaxRaiders())return;const e=P.getBuildingsByType(i.TOOLSTATION,i.TELEPORT_PAD);for(let t=0;t<e.length&&P.requestedRaiders>0;t++){const s=e[t];if(s.spawning)continue;P.requestedRaiders--,this.publishEvent(new J(P.requestedRaiders)),s.spawning=!0;const i=new Mt(this.worldMgr,this.sceneMgr),r=s.getHeading();i.playPositionalSample(me.d.SND_teleport),i.changeActivity(z.TeleportIn,(()=>{s.spawning=!1,i.changeActivity(),i.createPickSphere();const e=s.getPosition2D().add(new I.FM8(0,3*C.pM/4+(0,l.sZ)(C.pM/2)).rotateAround(new I.FM8(0,0),r+ss(-10+(0,l.sZ)(20))));i.setJob(new Tt(e)),P.raiders.push(i),this.publishEvent(new L)})),i.addToScene(new I.FM8(0,C.pM/2).rotateAround(new I.FM8(0,0),s.getHeading()).add(s.getPosition2D()),r)}}}class rs{constructor(){this.x=0,this.y=0,this.width=0,this.height=0,this.zIndex=100,this.scrollAffected=!1,this.needsRedraw=!1,this.hover=!1,this.pressed=!1,this.actionName="",this.targetIndex=0}static compareZ(e,t){return e.zIndex===t.zIndex?0:e.zIndex>t.zIndex?-1:1}checkHover(e,t){const s=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height;return this.hover!==s&&(this.hover=s,this.needsRedraw=!0,this.onHoverChange()),this.hover||(this.pressed=!1),this.hover}onHoverChange(){}checkSetPressed(){this.hover&&(this.pressed||(this.needsRedraw=!0),this.pressed=!0)}setReleased(){this.pressed&&(this.needsRedraw=!0),this.pressed=!1}draw(e){this.needsRedraw=!1}}class ns extends rs{constructor(e,t){super(),this.imgNormal=null,this.imgHover=null,this.imgPressed=null,this.tooltip="",this.imgNormal=tt.getImage(t.imgNormal),this.imgHover=tt.getImage(t.imgHover),this.imgPressed=tt.getImage(t.imgPressed),this.tooltip=(t.tooltip||"").replace(/_/g," "),this.width=Math.max(this.imgNormal.width,this.imgHover.width,this.imgPressed.width),this.height=Math.max(this.imgNormal.height,this.imgHover.height,this.imgPressed.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);let t=this.imgNormal;this.hover&&(t=this.imgHover),this.pressed&&(t=this.imgPressed),e.drawImage(t,this.x,this.y)}}class as extends rs{constructor(e,t){super(),this.labelImgLo=null,this.labelImgHi=null,this.labelImgLo=e.loFont.createTextImage(t.label),this.labelImgHi=e.hiFont.createTextImage(t.label),this.width=Math.max(this.labelImgLo.width,this.labelImgHi.width),this.height=Math.max(this.labelImgLo.height,this.labelImgHi.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);const t=this.hover&&!this.pressed?this.labelImgHi:this.labelImgLo;e.drawImage(t,this.x,this.y)}}class os extends Jt{constructor(e,t){super(),this.items=[],this.scrollY=0,this.scrollSpeedY=0,this.scrollInterval=null,this.screen=e,this.cfg=t,this.loFont=t.loFont?tt.getBitmapFont(t.loFont):null,this.hiFont=t.hiFont?tt.getBitmapFont(t.hiFont):null,this.menuImage=t.menuImage?tt.getImage(t.menuImage):null,this.titleImage=this.loFont.createTextImage(t.fullName),t.itemsLabel.forEach((e=>{e.label?this.items.push(new as(this,e)):this.items.push(new ns(this,e))})),this.items.sort(((e,t)=>rs.compareZ(e,t))),this.onRedraw=e=>{e.drawImage(this.menuImage,0,-this.scrollY),t.displayTitle&&e.drawImage(this.titleImage,(this.fixedWidth-this.titleImage.width)/2,this.cfg.position[1]),this.items.forEach(((t,s)=>this.items[this.items.length-1-s].draw(e)))}}reset(){super.reset(),this.scrollY=0,this.scrollSpeedY=0}show(){super.show();const e=this;this.scrollInterval=setInterval((()=>{0!==e.scrollSpeedY&&e.setScrollY(e.scrollSpeedY)}),1e3/C.OK)}hide(){this.scrollInterval=(0,l.nJ)(this.scrollInterval),super.hide()}handlePointerEvent(e){if(e.eventEnum===Nt.MOVE){const[t,s]=this.toScaledCoords(e.clientX,e.clientY);let i=!1;if(this.items.forEach((e=>{if(i)e.hover&&(e.needsRedraw=!0),e.hover=!1,e.setReleased();else{const r=s+(e.scrollAffected?this.scrollY:0);i=e.checkHover(t,r)}})),this.cfg.canScroll){const e=100;s<e?this.setScrollSpeedY(-(e-s)):s>this.fixedHeight-e?this.setScrollSpeedY(s-(this.fixedHeight-e)):this.setScrollSpeedY(0)}}else e.eventEnum===Nt.DOWN?e.button===Ot.MAIN&&this.items.forEach((e=>e.checkSetPressed())):e.eventEnum===Nt.UP&&e.button===Ot.MAIN&&this.items.forEach((e=>{e.pressed&&(e.setReleased(),"next"===e.actionName.toLowerCase()?this.screen.showMainMenu(e.targetIndex):"selectlevel"===e.actionName.toLowerCase()?this.screen.selectLevel(e.levelKey):e.actionName&&console.warn("not implemented: "+e.actionName+" - "+e.targetIndex))}));return this.needsRedraw()&&this.redraw(),new Promise((e=>e(!1)))}setScrollSpeedY(e){this.scrollSpeedY=Math.sign(e)*Math.pow(Math.round(e/20),2)}handleWheelEvent(e){return this.cfg.canScroll?(this.setScrollY(e.deltaY),new Promise((e=>e(!0)))):new Promise((e=>e(!1)))}setScrollY(e){const t=this.scrollY;this.scrollY=Math.min(Math.max(this.scrollY+e,0),this.menuImage.height-this.fixedHeight),t!==this.scrollY&&this.redraw()}needsRedraw(){return this.items.some((e=>e.needsRedraw))}}class ls extends rs{constructor(e,t,s){super(),this.imgActive=null,this.imgInactive=null,this.imgCross=null,this.unlocked=!1,this.levelKey="",this.layer=e,this.actionName="selectlevel",this.levelKey=t,this.x=s.frontEndX,this.y=s.frontEndY,this.zIndex=10,this.scrollAffected=!0;const[i,r,n]=s.menuBMP;this.imgActive=tt.getImage(i),this.imgInactive=tt.getImage(r),this.imgCross=tt.getImage(n),this.width=Math.max(this.imgActive.width,this.imgInactive.width,this.imgCross.width),this.height=Math.max(this.imgActive.height,this.imgInactive.height,this.imgCross.height),this.unlocked=s.frontEndOpen,this.unlocked=!0}draw(e){super.draw(e);let t=this.imgCross;this.unlocked&&(t=this.hover?this.imgActive:this.imgInactive),e.drawImage(t,this.x,this.y-this.layer.scrollY)}}class hs extends rs{constructor(e,t){super(),this.zIndex=50,this.context=(0,x.kr)(e.width,e.height),this.context.putImageData(e,0,0),this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}checkHover(e,t){const s=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height&&this.context.getImageData(e,t,1,1).data[3]>0;return this.hover!==s&&(this.needsRedraw=!0),this.hover=s,this.hover}draw(e){super.draw(e),e.drawImage(this.context.canvas,this.x,this.y,this.width,this.height)}}class cs extends rs{constructor(e,t){super(),this.imgFirstLine=null,this.imgSecondLine=null,this.font=e,this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}setFirstLine(e){this.imgFirstLine=e?this.font.createTextImage(e):null}setSecondLine(e){this.imgSecondLine=e?this.font.createTextImage(e):null}draw(e){super.draw(e);const t=this.x+this.width/2,s=this.y+this.height/2;this.imgFirstLine&&e.drawImage(this.imgFirstLine,t-this.imgFirstLine.width/2,s-this.imgFirstLine.height),this.imgSecondLine&&e.drawImage(this.imgSecondLine,t-this.imgSecondLine.width/2,s)}}class us extends os{constructor(e,t,s){super(e,t);const i=tt.getResource("Levels"),r=new ds;this.items.push(new hs(r.panelImgData,r.panelPos));const n=new cs(tt.getDefaultFont(),r.window);n.setFirstLine(s?r.level:r.tutorial),this.items.push(n),Object.keys(i.levelsByName).forEach((e=>{const t=i.levelsByName[e],s=new ls(this,e,t);s.onHoverChange=()=>n.setSecondLine(s.hover?t.fullName:""),this.items.push(s)})),this.items.sort(((e,t)=>rs.compareZ(e,t)))}}class ds{constructor(){this.window={x:0,y:0,w:0,h:0},this.panelPos={x:0,y:0,w:0,h:0},this.level="",this.tutorial="";const e=tt.cfg("Menu","LevelText"),t=(0,l.hh)(e,"Window");this.window={x:t[0],y:t[1],w:t[2],h:t[3]};const s=(0,l.hh)(e,"Panel");this.panelImgData=tt.getImageData(s[0]),this.panelPos={x:s[1],y:s[2],w:s[3],h:s[4]},this.level=ds.parseLabel((0,l.hh)(e,"Level")),this.tutorial=ds.parseLabel((0,l.hh)(e,"Tutorial"))}static parseLabel(e){return e?Array.isArray(e)?e.join(",").replace(/_/g," "):e.replace(/_/g," "):""}}class gs extends Kt{constructor(){super(),this.onLevelSelected=null,this.menus=[],tt.getResource("MainMenuFull").menus.forEach((e=>{let t;t="Levels"===e.title?new us(this,e,!0):"Tutorials"===e.title?new us(this,e,!1):new os(this,e),this.menus.push(t),this.addLayer(t)}))}showMainMenu(e=0){this.menus.forEach(((t,s)=>s===e?t.show():t.hide())),this.cursorLayer.show()}showLevelSelection(){this.showMainMenu(1)}selectLevel(e){this.hide(),this.onLevelSelected(e)}}class ps extends rs{constructor(e){let t,s,i,r;super(),this.disabled=!1,this.visible=!0,[t,s,i,r,this.x,this.y]=e,this.imgNormal=tt.getImage(t),this.imgHover=tt.getImage(s),this.imgPressed=tt.getImage(i),this.imgDisabled=tt.getImage(r),this.width=this.imgNormal.width,this.height=this.imgNormal.height}draw(e){if(super.draw(e),!this.visible)return;let t=this.imgNormal;this.disabled?t=this.imgDisabled:this.pressed?t=this.imgPressed:this.hover&&(t=this.imgHover),e.drawImage(t,this.x,this.y)}}class ms extends Kt{constructor(){super(),this.cfg=null,this.resultIndex=0,this.resultLastIndex=0,this.images=[],this.boxes=[],this.fonts={},this.texts=[],this.uncoverTimeout=null,this.cfg=tt.getResource("Reward"),this.titleFont=tt.getBitmapFont(this.cfg.titleFont);const e=tt.getImage(this.cfg.wallpaper);this.addLayer(new Jt).onRedraw=t=>t.drawImage(e,0,0),this.cfg.images.forEach((e=>{this.images.push({img:tt.getImage(e.filePath),x:e.x,y:e.y})})),this.cfg.boxImages.forEach((e=>{this.boxes.push({img:tt.getImage(e.filePath),x:e.x,y:e.y})})),Object.keys(this.cfg.fonts).forEach(((e,t)=>{const s=tt.getBitmapFont(this.cfg.fonts[e]);this.fonts[e.toLowerCase()]=s;const i=this.cfg.texts[t],r=t<9?s:tt.getBitmapFont(this.cfg.backFont);this.texts.push(r.createTextImage(i.text))})),this.resultsLayer=this.addLayer(new Jt),this.resultsLayer.handlePointerEvent=e=>e.eventEnum===Nt.UP?(this.uncoverTimeout=(0,l.L4)(this.uncoverTimeout),this.uncoverTimeout=null,this.resultIndex=this.resultLastIndex,this.btnSave.visible=!0,this.btnAdvance.visible=!0,this.redraw(),new Promise((e=>e(!0)))):new Promise((e=>e(!1))),this.descriptionTextLayer=this.addLayer(new Jt,20),this.btnLayer=this.addLayer(new Jt,50),this.btnSave=new ps(this.cfg.saveButton),this.btnSave.disabled=!0,this.btnAdvance=new ps(this.cfg.advanceButton),this.btnLayer.handlePointerEvent=e=>{if(e.eventEnum===Nt.MOVE){const[t,s]=this.btnLayer.toScaledCoords(e.clientX,e.clientY);this.btnSave.checkHover(t,s),this.btnAdvance.checkHover(t,s)}else e.eventEnum===Nt.DOWN?e.button===Ot.MAIN&&(this.btnSave.checkSetPressed(),this.btnAdvance.checkSetPressed()):e.eventEnum===Nt.UP&&e.button===Ot.MAIN&&(this.btnSave.pressed?this.btnSave.setReleased():this.btnAdvance.pressed&&(this.btnAdvance.setReleased(),this.hide(),this.onAdvance()));return(this.btnSave.needsRedraw||this.btnAdvance.needsRedraw)&&this.redraw(),new Promise((e=>e(!1)))},this.btnLayer.onRedraw=e=>{this.btnSave.draw(e),this.btnAdvance.draw(e)}}show(){this.resultIndex=0,this.btnSave.visible=!1,this.btnAdvance.visible=!1,this.uncoverResult();let e=this.cfg.quitText;this.resultLastIndex=this.images.length-2,P.resultState===M.COMPLETE?(e=this.cfg.completeText,this.resultLastIndex=this.images.length-1):P.resultState===M.FAILED&&(e=this.cfg.failedText);const t=[];t.push(this.fonts.crystals.createTextImage(this.percentString(P.numCrystal,P.neededCrystals))),t.push(this.fonts.ore.createTextImage(this.percentString(P.numOre,P.totalOres))),t.push(this.fonts.diggable.createTextImage(this.percentString(P.remainingDiggables,P.totalDiggables,!0))),t.push(this.fonts.constructions.createTextImage(P.buildings.length.toString())),t.push(this.fonts.caverns.createTextImage(this.percentString(P.discoveredCaverns,P.totalCaverns))),t.push(this.fonts.figures.createTextImage(this.percentString(P.raiders.length,P.getMaxRaiders()))),t.push(this.fonts.rockmonsters.createTextImage(this.percentString(0))),t.push(this.fonts.oxygen.createTextImage(this.percentString(P.airLevel))),t.push(this.fonts.timer.createTextImage(this.timeString(P.gameTimeSeconds))),t.push(this.fonts.score.createTextImage(this.percentString(this.score)));const s=this.titleFont.createTextImage(e);this.resultsLayer.onRedraw=e=>{e.clearRect(0,0,this.resultsLayer.fixedWidth,this.resultsLayer.fixedHeight);for(let t=0;t<=this.resultIndex;t++){const s=this.images[t];s&&e.drawImage(s.img,s.x,s.y)}for(let t=0;t<=this.resultIndex;t++){const s=this.boxes[t];s&&e.drawImage(s.img,s.x,s.y)}for(let s=0;s<=this.resultIndex;s++){const i=this.cfg.texts[s],r=t[s];r&&e.drawImage(r,i.x-r.width/2,i.y)}e.drawImage(this.levelFullNameImg,this.resultsLayer.fixedWidth/2-this.levelFullNameImg.width/2,this.cfg.vertSpacing-this.levelFullNameImg.height/2),e.drawImage(s,this.resultsLayer.fixedWidth/2-s.width/2,this.cfg.vertSpacing+this.levelFullNameImg.height/2)},this.descriptionTextLayer.onRedraw=e=>{const t=this.texts[this.resultIndex];e.clearRect(0,this.cfg.textPos[1],this.descriptionTextLayer.fixedWidth,this.descriptionTextLayer.fixedHeight-this.cfg.textPos[1]);const s=this.resultIndex!==this.images.length-1?this.cfg.textPos[0]:305,i=this.resultIndex!==this.images.length-1?this.cfg.textPos[1]:195;e.drawImage(t,s-t.width/2,i)},super.show()}score(){if(!this.rewardConfig)return 0;let e=this.rewardConfig.quota,t=this.rewardConfig.importance;const s=P.numCrystal>=(e.crystals||1/0)?t.crystals:0,i=P.gameTimeSeconds<=(e.timer||0)?t.timer:0,r=e.caverns?Math.min(1,P.discoveredCaverns/e.caverns)*t.caverns:0,n=e.constructions?Math.min(1,P.buildings.length/e.constructions*t.constructions):0,a=P.airLevel*t.oxygen,o=P.raiders.length>=C.d?t.figures:0;return Math.max(0,Math.min(100,Math.round(s+i+r+n+a+o)/100))}percentString(e,t=1,s=!1){0===t&&(t=1);let i=Math.round(100*Math.max(Math.min(e/t,1),0));return s&&(i=100-i),i.toString()+"%"}padLeft(e,t="0",s=2){for(;e.length<s;)e=t+e;return e}timeString(e){const t=this.padLeft((e%60).toString()),s=Math.floor(e/60),i=this.padLeft((s%60).toString());return this.padLeft(Math.floor(s/60).toString())+":"+i+":"+t}uncoverResult(){this.uncoverTimeout=setTimeout((()=>{this.uncoverTimeout=null,this.resultIndex++,this.resultIndex<this.resultLastIndex?this.uncoverResult():(this.btnSave.visible=!0,this.btnAdvance.visible=!0),this.redraw()}),1e3*this.cfg.timer)}setup(e,t){this.levelFullNameImg=this.titleFont.createTextImage(e),this.rewardConfig=t}}C.Sl&&console.warn("DEV MODE ACTIVE");const ys=new class extends Kt{constructor(){super(),this.assetIndex=0,this.layer=this.addLayer(new Jt)}show(){this.layers.forEach((e=>{e!==this.cursorLayer&&e.show()})),this.setLoadingMessage("Loading...")}setLoadingMessage(e){this.layer.onRedraw=t=>{t.fillStyle="black",t.fillRect(0,0,this.layer.fixedWidth,this.layer.fixedHeight),t.font="24px Arial",t.fillStyle="white",t.fillText("Loading Rock Raiders",20,this.layer.fixedHeight-50),t.font="18px Arial",t.fillStyle="white",t.fillText(e,20,this.layer.fixedHeight-20)},this.redraw()}enableGraphicMode(e){const t=tt.getImage(tt.cfg("Main","LoadScreen")),s=tt.getImage(tt.cfg("Main","ProgressBar")),i=tt.getDefaultFont().createTextImage(tt.cfg("Main","LoadingText"));this.layer.onRedraw=r=>{r.drawImage(t,0,0);const n=353*(this.assetIndex<e?Math.round(this.assetIndex/e):1);r.drawImage(s,142,450,n,9),r.drawImage(i,Math.round(320-i.width/2),Math.round(456-i.height/2))},this.cursorLayer.show(),this.redraw()}increaseLoadingState(){this.assetIndex++,this.redraw()}},fs=new o.WadFileSelectionModal("game-container"),vs=new a.GithubBox("game-container"),bs=new n.ClearCacheButton("game-container");fs.onStart=(e,t)=>{tt.startLoadingFromUrl(e,t)},tt.onMessage=e=>{ys.setLoadingMessage(e)},tt.onCacheMissed=()=>{fs.show()},tt.onInitialLoad=e=>{fs.hide(),ys.enableGraphicMode(e)},tt.onAssetLoaded=()=>{ys.increaseLoadingState()},tt.onLoadDone=()=>{const e=new gs,t=new is,s=new ms;e.onLevelSelected=i=>{try{const e=tt.getResource("Levels").levelsByName[i];if(!e)throw'Could not find level configuration for "'+i+'"';s.setup(e.fullName,e.reward),t.startLevel(i,e)}catch(s){console.error("Could not load level: "+i,s),t.hide(),e.showLevelSelection()}},t.onLevelEnd=()=>{t.hide(),s.show()},s.onAdvance=()=>{P.reset(),e.showLevelSelection()},ys.hide(),vs.hide(),bs.hide();const i=new URLSearchParams(window.location.search),r=i.get("entry");C.Sl&&r?(P.numOre=Number(i.get("numOre"))||0,P.numCrystal=Number(i.get("numCrystal"))||0,"level"===r?e.showLevelSelection():"reward"===r?s.show():"random"===r?e.selectLevel("Level"+("00"+(0,l.$u)(1,25)).substr(-2)):r&&e.selectLevel(r)):e.showMainMenu()},ys.show(),tt.startLoadingFromCache()},848:(e,t,s)=>{"use strict";s.d(t,{Sl:()=>i,UV:()=>r,$I:()=>n,Cw:()=>a,Ob:()=>o,IL:()=>l,d:()=>h,oq:()=>c,SO:()=>u,ED:()=>d,a4:()=>g,Du:()=>p,DG:()=>m,pM:()=>y,OK:()=>f});const i=!1,r="RockRaidersWeb",n=1e3,a=5e3,o=7,l=1e3,h=12,c=10,u=5e3,d=.1,g=5,p=640,m=480,y=40,f=30},351:(e,t,s)=>{"use strict";e.exports=s.p+"266ca63177bca6f330a7.png"}}]);
//# sourceMappingURL=677.index.js.map