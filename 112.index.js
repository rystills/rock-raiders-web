(self.webpackChunkrock_raiders_web=self.webpackChunkrock_raiders_web||[]).push([[112,990,694,372],{662:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var i=s(15),r=s.n(i),n=s(645),a=s.n(n)()(r());a.push([e.id,".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n","",{version:3,sources:["webpack://./site/clearcache/clearCacheButton.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,kBAAkB;IAClB,OAAO;IACP,MAAM;AACV",sourcesContent:[".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n"],sourceRoot:""}]);const o=a},27:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var i=s(15),r=s.n(i),n=s(645),a=s.n(n)()(r());a.push([e.id,".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n","",{version:3,sources:["webpack://./site/github/github.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,aAAa;IACb,kBAAkB;IAClB,MAAM;IACN,QAAQ;IACR,oCAAoC;IACpC,WAAW;AACf;;AAEA;IACI,WAAW;IACX,qBAAqB;IACrB,YAAY;AAChB;;AAEA;IACI,WAAW;IACX,0BAA0B;AAC9B;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iBAAiB;IACjB,sBAAsB;AAC1B",sourcesContent:[".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n"],sourceRoot:""}]);const o=a},372:(e,t,s)=>{"use strict";s.r(t),s.d(t,{ClearCacheButton:()=>o});var i=s(848),r=s(379),n=s.n(r),a=s(662);n()(a.Z,{insert:"head",singleton:!1}),a.Z.locals;class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("clear-cache-box");const t=this.rootElement.appendChild(document.createElement("button"));t.classList.add("btn","btn-info"),t.innerText="Clear cached wad files and restart",t.onclick=()=>{indexedDB.deleteDatabase(i.UV),location.reload()}}hide(){this.rootElement.style.visibility="hidden"}}},990:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GithubBox:()=>o});var i=s(379),r=s.n(i),n=s(27);r()(n.Z,{insert:"head",singleton:!1}),n.Z.locals;var a=s(351);class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("github-box");const t=this.rootElement.appendChild(document.createElement("a"));t.href="https://github.com/scarabol/rock-raiders-web";const s=t.appendChild(document.createElement("img"));s.src=a,s.classList.add("github-logo"),s.alt="Fork on GitHub",t.appendChild(document.createElement("span")).textContent=s.alt}hide(){this.rootElement.style.visibility="hidden"}}},694:(e,t,s)=>{"use strict";s.r(t),s.d(t,{WadFileSelectionModal:()=>r});var i=s(169);class r{constructor(e){this.onStart=null;const t=document.getElementById(e).appendChild(document.createElement("div"));t.classList.add("modal"),t.tabIndex=-1,t.setAttribute("role","dialog"),t.setAttribute("aria-hidden","true");const s=t.appendChild(document.createElement("div"));s.classList.add("modal-dialog"),t.setAttribute("role","document");const n=s.appendChild(document.createElement("div"));n.classList.add("modal-content");const a=n.appendChild(document.createElement("div"));a.classList.add("modal-header");const o=a.appendChild(document.createElement("h5"));o.classList.add("modal-title"),o.innerText="Load .wad files",o.id="wadfileSelectModalLabel",t.setAttribute("aria-labelledby",o.id);const l=n.appendChild(document.createElement("div"));l.classList.add("modal-body"),l.appendChild(document.createElement("p")).innerText="Assets not included! In order to play the game, please select the game files.";const h=l.appendChild(document.createElement("nav")).appendChild(document.createElement("div"));h.id="nav-tab",h.classList.add("nav","nav-tabs"),h.setAttribute("role","tablist");const c=r.appendNavButton(h,!0,"nav-file-tab","nav-file","Local files (recommended)"),u=r.appendNavButton(h,!1,"nav-url-tab","nav-url","Online from URL"),d=l.appendChild(document.createElement("div"));d.classList.add("tab-content"),this.appendNavFileTab(d,c.id),this.appendNavUrlTab(d,u.id),this.modal=new i.u_(t,{backdrop:"static",keyboard:!1})}static appendNavButton(e,t,s,i,r){const n=e.appendChild(document.createElement("button"));return n.classList.add("nav-link"),t&&n.classList.add("active"),n.id=s,n.setAttribute("data-bs-toggle","tab"),n.setAttribute("data-bs-target","#"+i),n.type="button",n.setAttribute("role","tab"),n.setAttribute("aria-controls",i),n.setAttribute("aria-selected",String(t)),n.innerText=r,n}appendNavFileTab(e,t){const s=r.appendNavTab(e,!0,"nav-file",t),i=r.appendWadFileGroup(s,"wad0-file","LegoRR0.wad"),n=r.appendWadFileGroup(s,"wad1-file","LegoRR1.wad"),a=s.appendChild(document.createElement("button"));a.type="submit",a.classList.add("btn","btn-primary","float-end"),a.id="button-start-file",a.innerText="Start Game",a.addEventListener("click",(()=>{a.disabled=!0;const e=URL.createObjectURL(i.files[0]),t=URL.createObjectURL(n.files[0]);this.onStart(e,t)}))}static appendWadFileGroup(e,t,s){const i=e.appendChild(document.createElement("div"));i.classList.add("my-3");const r=i.appendChild(document.createElement("label"));r.setAttribute("for",t),r.classList.add("form-label"),r.innerHTML='Select <span class="fw-bold">'+s+"</span> here:";const n=i.appendChild(document.createElement("input"));return n.type="file",n.classList.add("form-control"),n.id=t,n.required=!0,n}appendNavUrlTab(e,t){const s=r.appendNavTab(e,!1,"nav-url",t),i=s.appendChild(document.createElement("div"));i.classList.add("my-3"),i.innerText="Direct links with correct Allow-Origin-CORS-Headers required here.";const n=r.appendWadUrlGroup(s,"wad0-url","LegoRR0.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),a=r.appendWadUrlGroup(s,"wad1-url","LegoRR1.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),o=s.appendChild(document.createElement("button"));o.type="submit",o.classList.add("btn","btn-primary","float-end"),o.id="button-start-url",o.innerText="Start Game",o.addEventListener("click",(()=>{o.disabled=!0,this.onStart(n.value,a.value)}))}static appendNavTab(e,t,s,i){const r=e.appendChild(document.createElement("div"));return r.classList.add("tab-pane","fade"),t&&r.classList.add("show","active"),r.id=s,r.setAttribute("role","tabpanel"),r.setAttribute("aria-labelledby",i),r}static appendWadUrlGroup(e,t,s,i){const r=e.appendChild(document.createElement("div"));r.classList.add("my-3");const n=r.appendChild(document.createElement("label"));n.setAttribute("for",t),n.classList.add("form-label"),n.innerHTML='Enter url for <span class="fw-bold">'+s+"</span> here:";const a=r.appendChild(document.createElement("input"));return a.type="url",a.classList.add("form-control"),a.id=t,a.required=!0,a.value=i,a}show(){this.modal.show()}hide(){this.modal.hide()}}},538:(e,t,s)=>{"use strict";function i(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const s=t.lastIndexOf("/");return t=t.substring(0,s+1),t.startsWith("/")&&(t=t.substring(1)),t}function r(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const s=t.lastIndexOf("/");return t.substring(s+1)}function n(e,...t){return t.forEach((t=>{e=(e=Object.keys(e).filter((e=>e.toLowerCase()===t.toLowerCase())).map((t=>e[t])))?e[0]:e})),e}function a(e){return(new TextDecoder).decode(e).replace(/\0/g,"")}function o(e){return a(e).replace(/\\/g,"/")}function l(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function h(e){return l(0,e)}function c(){return 2*l(0,1)-1}function u(e){return e&&clearTimeout(e),null}function d(e){return e&&clearInterval(e),null}s.d(t,{DW:()=>i,vt:()=>r,hh:()=>n,v5:()=>a,jG:()=>o,$u:()=>l,sZ:()=>h,kz:()=>c,L4:()=>u,nJ:()=>d}),Array.prototype.add=function(e){-1===this.indexOf(e)&&this.push(e)},Array.prototype.remove=function(e){const t=this.indexOf(e);-1!==t&&this.splice(t,1)},Array.prototype.removeLast=function(e){const t=this.indexOf(e);-1!==t&&this.splice(t,1)},Array.prototype.last=function(){return this.length>0?this[this.length-1]:void 0},Array.prototype.count=function(e){let t=0;return this.forEach((s=>e(s)&&t++)),t},Array.prototype.partition=function(e){const t=[],s=[];return this.forEach((i=>e(i)?t.push(i):s.push(i))),[t,s]},Array.prototype.random=function(){if(this.length)return this[h(this.length-1)]},Map.prototype.getOrUpdate=function(e,t){let s=this.get(e);return void 0===s&&(s=t(),this.set(e,s)),s},String.prototype.equalsIgnoreCase=function(e){return this.toLowerCase()===(null==e?void 0:e.toLowerCase())}},112:(e,t,s)=>{"use strict";s.r(t);var i=s(372),r=s(990),n=s(694),a=s(538);class o{static reset(){this.numCrystal=0,this.numOre=0,this.numBrick=0,this.usedCrystals=0,this.neededCrystals=0,this.airLevel=1,this.totalCrystals=0,this.totalOres=0,this.totalDiggables=0,this.remainingDiggables=0,this.totalCaverns=0,this.discoveredCaverns=0}}o.numCrystal=0,o.numOre=0,o.numBrick=0,o.usedCrystals=0,o.neededCrystals=0,o.airLevel=1,o.totalCrystals=0,o.totalOres=0,o.totalDiggables=0,o.remainingDiggables=0,o.totalCaverns=0,o.discoveredCaverns=0;var l=s(848),h=s(212),c=s(344),u=s(768);class d{constructor(){this.scale=1,this.carryNullName="",this.carryNullFrames=0,this.depositNullName="",this.toolNullName="",this.wheelMesh=null,this.wheelRadius=1,this.wheelNullName=null,this.drillNullName=null,this.driverNullName=null,this.cameraNullName=null,this.cameraNullFrames=null,this.mediumPolyBodies=new Map,this.highPolyBodies=new Map,this.fPPolyBodies=new Map,this.animations=new Map,this.upgradesByLevel=new Map}}class g{constructor(e,t,s){this.upgradeFilepath=e,this.upgradeNullName=t,this.upgradeNullIndex=s}}var p=s(861);function y(e,t){try{e.update(t)}catch(e){console.error(e)}}class m{constructor(){this.looping=!1,this.transcoef=1,this.firstFrame=null,this.lastFrame=null,this.framesPerSecond=null,this.bodies=[],this.polyList=[],this.carryJoint=null,this.depositJoint=null,this.getToolJoint=null,this.wheelJoints=[],this.drillJoint=null,this.driverJoint=null,this.nullJoints=new Map,this.polyModel=new h.ZAu,this.sfxAudioByFrame=new Map,this.timer=0,this.currentFrame=null,this.onAnimationDone=null,this.durationTimeMs=null}start(e,t){this.timer=0,this.currentFrame=this.firstFrame,this.onAnimationDone=e,this.durationTimeMs=t,this.updateBodiesAnimationFrame()}update(e){this.polyList.forEach((t=>y(t,e))),this.timer+=e;const t=1e3/this.framesPerSecond*(this.transcoef||1),s=Math.floor(this.timer/t);if(this.timer-=s*t,0===s)return;let i=this.currentFrame+s;if(i<=this.lastFrame||!this.onAnimationDone||null!==this.durationTimeMs&&this.durationTimeMs>0){if(i>this.lastFrame&&(i=this.firstFrame),this.currentFrame===i)return;this.currentFrame=i,null!==this.durationTimeMs&&(this.durationTimeMs-=e),this.updateBodiesAnimationFrame()}else this.onAnimationDone&&(this.stopAudio(),this.onAnimationDone())}updateBodiesAnimationFrame(){if(this.polyList.length!==this.bodies.length)throw"Cannot animate poly. Length differs from bodies length";this.bodies.forEach(((e,t)=>{const s=this.polyList[t];if(s.position.copy(e.relPos[this.currentFrame]).sub(e.pivot),s.rotation.copy(e.relRot[this.currentFrame]),s.scale.copy(e.relScale[this.currentFrame]),s.hasOwnProperty("material")){const t=s.material,i=e.opacity[this.currentFrame];t&&void 0!==i&&(Array.isArray(t)?t:[t]).forEach((e=>e.setOpacity(i)))}})),this.playAudio()}stop(){this.stopAudio()}playAudio(){this.sfxAudioByFrame.getOrUpdate(this.currentFrame,(()=>[])).forEach((e=>{e.isPlaying&&e.stop(),e.play()}))}stopAudio(){this.sfxAudioByFrame.forEach((e=>e.forEach((e=>e.isPlaying&&e.stop()))))}}var f=h.M8C.degToRad;class v{constructor(){this.lowerName="",this.filename="",this.pivot=new h.Pa4(0,0,0),this.relPos=[],this.relRot=[],this.relScale=[],this.opacity=[],this.parentObjInd=null,this.model=null,this.isNull=!1,this.sfxName=null,this.sfxFrames=[]}radVec(e,t,s){return new h.USm(f(t),f(e),f(s),"YXZ")}setFrameAndFollowing(e,t,s){this.relPos[e]=new h.Pa4(s[0],s[1],s[2]),this.relRot[e]=this.radVec(s[3],s[4],s[5]),this.relScale[e]=new h.Pa4(s[6],s[7],s[8]);for(let s=e;s<=t;s++)this.relPos[s]=this.relPos[e],this.relRot[s]=this.relRot[e],this.relScale[s]=this.relScale[e]}setOpacityAndFollowing(e,t,s){for(let i=e;i<=t;i++)this.opacity[i]=s}}var E=s(886);const w=s(466);class b{constructor(){this.stats=new w,this.stats.setMode(0),this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement),this.hide()}show(){this.stats.domElement.style.visibility="visible"}hide(){this.stats.domElement.style.visibility="hidden"}renderStart(){this.stats.begin()}renderDone(){this.stats.end()}}var M,S=s(320);class T{static publishEvent(e){this.blockedEvents.includes(e.eventKey)||(e.isLocal||console.log("Event published: "+S.Z[e.eventKey]),this.blockedEvents.push(e.eventKey),this.workerListener.forEach((t=>t(e))),this.getListener(e.eventKey).forEach((t=>t(e))),this.blockedEvents.remove(e.eventKey))}static registerEventListener(e,t){this.getListener(e).push(t)}static getListener(e){return this.eventListener.getOrUpdate(e,(()=>[]))}static registerWorkerListener(e){this.workerListener.push(e)}}T.eventListener=new Map,T.workerListener=[],T.blockedEvents=[],function(e){e[e.PILOT=0]="PILOT",e[e.TOOLSTATION=1]="TOOLSTATION",e[e.TELEPORT_PAD=2]="TELEPORT_PAD",e[e.DOCKS=3]="DOCKS",e[e.POWER_STATION=4]="POWER_STATION",e[e.BARRACKS=5]="BARRACKS",e[e.UPGRADE=6]="UPGRADE",e[e.GEODOME=7]="GEODOME",e[e.ORE_REFINERY=8]="ORE_REFINERY",e[e.GUNSTATION=9]="GUNSTATION",e[e.TELEPORT_BIG=10]="TELEPORT_BIG",e[e.BAT=11]="BAT",e[e.SMALL_SPIDER=12]="SMALL_SPIDER",e[e.ROCK_MONSTER=13]="ROCK_MONSTER",e[e.ICE_MONSTER=14]="ICE_MONSTER",e[e.LAVA_MONSTER=15]="LAVA_MONSTER",e[e.DYNAMITE=16]="DYNAMITE",e[e.ELECTRIC_FENCE=17]="ELECTRIC_FENCE",e[e.CRYSTAL=18]="CRYSTAL",e[e.ORE=19]="ORE",e[e.BRICK=20]="BRICK",e[e.BARRIER=21]="BARRIER",e[e.HOVERBOARD=22]="HOVERBOARD",e[e.SMALL_DIGGER=23]="SMALL_DIGGER",e[e.SMALL_TRUCK=24]="SMALL_TRUCK",e[e.SMALL_CAT=25]="SMALL_CAT",e[e.SMALL_MLP=26]="SMALL_MLP",e[e.SMALL_HELI=27]="SMALL_HELI",e[e.BULLDOZER=28]="BULLDOZER",e[e.WALKER_DIGGER=29]="WALKER_DIGGER",e[e.LARGE_MLP=30]="LARGE_MLP",e[e.LARGE_DIGGER=31]="LARGE_DIGGER",e[e.LARGE_CAT=32]="LARGE_CAT",e[e.TV_CAMERA=33]="TV_CAMERA"}(M||(M={}));var L,A=s(505);class R{constructor(e={}){this.shaping=!1,this.matIndex="00",this.floor=!1,this.selectable=!1,this.digable=!1,this.reinforcable=!1,this.cursor=A.C.Pointer_Standard,this.cursorFulfiller=A.C.Pointer_Standard,this.statsDrillName=null,this.canCarryFence=!1,this.connectsPath=!1,this.mapSurfaceColor="#00FFFF",Object.assign(this,e)}static getByNum(e){switch(e){case 0:return R.POWER_PATH_BUILDING;case 1:return R.SOLID_ROCK;case 2:return R.HARD_ROCK;case 3:return R.LOOSE_ROCK;case 4:case 5:return R.DIRT;case 6:return R.LAVA;case 8:return R.ORE_SEAM;case 9:return R.WATER;case 10:return R.CRYSTAL_SEAM;case 11:return R.RECHARGE_SEAM;case 30:case 40:return R.SLUG_HOLE;case 100:return R.RUBBLE4;case 101:return R.RUBBLE3;case 102:return R.RUBBLE2;case 103:return R.RUBBLE1;default:return console.error("Unexpected surface type num: "+e),R.SOLID_ROCK}}}R.GROUND=new R({name:"ground",floor:!0,selectable:!0,canCarryFence:!0,cursorFulfiller:A.C.Pointer_LegoManGo,mapSurfaceColor:"#280048"}),R.SOLID_ROCK=new R({name:"solid rock",shaping:!0,matIndex:"5",cursor:A.C.Pointer_SurfaceType_Immovable,mapSurfaceColor:"#500090"}),R.HARD_ROCK=new R({name:"hard rock",shaping:!0,matIndex:"4",selectable:!0,digable:!0,reinforcable:!0,cursor:A.C.Pointer_SurfaceType_Hard,statsDrillName:"HardDrillTime",mapSurfaceColor:"#7000B0"}),R.LOOSE_ROCK=new R({name:"loose rock",shaping:!0,matIndex:"3",selectable:!0,digable:!0,reinforcable:!0,cursor:A.C.Pointer_SurfaceType_Medium,statsDrillName:"LooseDrillTime",mapSurfaceColor:"#9000D0"}),R.DIRT=new R({name:"dirt",shaping:!0,matIndex:"2",selectable:!0,digable:!0,reinforcable:!0,cursor:A.C.Pointer_SurfaceType_Loose,statsDrillName:"SoilDrillTime",mapSurfaceColor:"#B000F0"}),R.SLUG_HOLE=new R({name:"slug hole",floor:!0,matIndex:"30",mapSurfaceColor:"#280048"}),R.LAVA=new R({name:"lava",floor:!0,matIndex:"46"}),R.ORE_SEAM=new R({name:"ore seam",matIndex:"40",selectable:!0,digable:!0,reinforcable:!0,cursor:A.C.Pointer_SurfaceType_OreSeam,statsDrillName:"SeamDrillTime"}),R.WATER=new R({name:"water",floor:!0,matIndex:"45",mapSurfaceColor:"#000080"}),R.CRYSTAL_SEAM=new R({name:"energy crystal seam",matIndex:"20",selectable:!0,digable:!0,reinforcable:!0,cursor:A.C.Pointer_SurfaceType_CrystalSeam,statsDrillName:"SeamDrillTime"}),R.RECHARGE_SEAM=new R({name:"recharge seam",matIndex:"67",cursor:A.C.Pointer_SurfaceType_RechargeSeam}),R.POWER_PATH=new R({name:"power path all",floor:!0,matIndex:"60",selectable:!0,canCarryFence:!0,connectsPath:!0,mapSurfaceColor:"#FFFF00"}),R.POWER_PATH_BUILDING_SITE=new R({name:"power path building site",floor:!0,matIndex:"61",selectable:!0,canCarryFence:!0}),R.POWER_PATH_BUILDING=new R({name:"power path building",floor:!0,matIndex:"76",connectsPath:!0,mapSurfaceColor:"#B8BBB8"}),R.POWER_PATH_CONSTRUCTION=new R({name:"power path construction",floor:!0,matIndex:"76",selectable:!0,connectsPath:!0,mapSurfaceColor:"#B8BBB8"}),R.RUBBLE1=new R({name:"rubble 1",floor:!0,matIndex:"13",selectable:!0,canCarryFence:!0,cursorFulfiller:A.C.Pointer_Clear,mapSurfaceColor:"#280048"}),R.RUBBLE2=new R({name:"rubble 2",floor:!0,matIndex:"12",selectable:!0,canCarryFence:!0,cursorFulfiller:A.C.Pointer_Clear,mapSurfaceColor:"#280048"}),R.RUBBLE3=new R({name:"rubble 3",floor:!0,matIndex:"11",selectable:!0,canCarryFence:!0,cursorFulfiller:A.C.Pointer_Clear,mapSurfaceColor:"#280048"}),R.RUBBLE4=new R({name:"rubble 4",floor:!0,matIndex:"10",selectable:!0,canCarryFence:!0,cursorFulfiller:A.C.Pointer_Clear,mapSurfaceColor:"#280048"}),function(e){e[e.NONE=0]="NONE",e[e.DRILL=1]="DRILL",e[e.HAMMER=2]="HAMMER",e[e.SHOVEL=3]="SHOVEL",e[e.SPANNER=4]="SPANNER",e[e.FREEZERGUN=5]="FREEZERGUN",e[e.LASER=6]="LASER",e[e.PUSHERGUN=7]="PUSHERGUN",e[e.BIRDSCARER=8]="BIRDSCARER"}(L||(L={}));const C=[L.DRILL,L.HAMMER,L.SHOVEL,L.SPANNER,L.FREEZERGUN,L.LASER,L.PUSHERGUN,L.BIRDSCARER];var P;!function(e){e[e.NONE=0]="NONE",e[e.DRIVER=1]="DRIVER",e[e.ENGINEER=2]="ENGINEER",e[e.GEOLOGIST=3]="GEOLOGIST",e[e.PILOT=4]="PILOT",e[e.SAILOR=5]="SAILOR",e[e.DEMOLITION=6]="DEMOLITION"}(P||(P={}));const I=[P.DRIVER,P.ENGINEER,P.GEOLOGIST,P.PILOT,P.SAILOR,P.DEMOLITION],x=[];x[P.DRIVER]=M.BARRACKS,x[P.DRIVER]=M.BARRACKS,x[P.ENGINEER]=M.UPGRADE,x[P.GEOLOGIST]=M.GEODOME,x[P.PILOT]=M.TELEPORT_PAD,x[P.SAILOR]=M.DOCKS,x[P.DEMOLITION]=M.TOOLSTATION;const O=[];O[P.DRIVER]="TrainDriver",O[P.ENGINEER]="TrainRepair",O[P.GEOLOGIST]="TrainScanner",O[P.PILOT]="TrainPilot",O[P.SAILOR]="TrainSailor",O[P.DEMOLITION]="TrainDynamite";class D{constructor(e){this.x=e.x,this.y=e.y,this.surfaceColor=e.surfaceType.mapSurfaceColor,this.borderColor=e.reinforced?"#FFFF00":null}}var N,_,F,B=s(722);class k extends B.Z{constructor(e){super(e),this.isLocal=!0}}!function(e){e[e.NONE=0]="NONE",e[e.RAIDER=1]="RAIDER",e[e.VEHICLE=2]="VEHICLE",e[e.BUILDING=3]="BUILDING",e[e.SURFACE=4]="SURFACE"}(N||(N={}));class U extends k{constructor(e){var t,s,i,r,n,a,o,l,h,c,u,d;super(S.Z.SELECTION_CHANGED),this.selectPanelType=N.NONE,this.canDoTraining=new Map,this.everyHasTool=new Map,e&&(this.selectPanelType=e.selection.getSelectPanelType(),this.isGround=(null===(t=e.selection.surface)||void 0===t?void 0:t.surfaceType)===R.GROUND,this.isPowerPath=(null===(s=e.selection.surface)||void 0===s?void 0:s.surfaceType)===R.POWER_PATH,this.isFloor=null===(i=e.selection.surface)||void 0===i?void 0:i.surfaceType.floor,this.isSite=(null===(r=e.selection.surface)||void 0===r?void 0:r.surfaceType)===R.POWER_PATH_CONSTRUCTION||(null===(n=e.selection.surface)||void 0===n?void 0:n.surfaceType)===R.POWER_PATH_BUILDING_SITE,this.hasRubble=null===(a=e.selection.surface)||void 0===a?void 0:a.hasRubble(),this.isDrillable=null===(o=e.selection.surface)||void 0===o?void 0:o.isDigable(),this.isReinforcable=null===(l=e.selection.surface)||void 0===l?void 0:l.isReinforcable(),this.canPlaceFence=(null===(h=e.selection.surface)||void 0===h?void 0:h.canPlaceFence())&&e&&e.buildings.some((e=>e.entityType===M.POWER_STATION&&e.isUsable())),this.someCarries=!!e.selection.raiders.some((e=>!!e.carries)),this.everyHasMaxLevel=!!e.selection.raiders.every((e=>e.level>=e.stats.Levels)),I.forEach((t=>this.canDoTraining.set(t,e&&e.getTrainingSites(t).length>0&&e.selection.raiders.some((e=>!e.hasTraining(t)))))),C.forEach((t=>this.everyHasTool.set(t,!!e.selection.raiders.every((e=>e.hasTool(t)))))),this.buildingCanUpgrade=null===(c=e.selection.building)||void 0===c?void 0:c.canUpgrade(),this.buildingCanSwitchPower=!(null===(u=e.selection.building)||void 0===u?void 0:u.stats.SelfPowered)&&!(null===(d=e.selection.building)||void 0===d?void 0:d.stats.PowerBuilding),this.vehicleHasCallManJob=e.selection.vehicles.every((e=>!!e.callManJob)),this.allVehicleEmpty=e.selection.vehicles.every((e=>!e.driver)))}}class W extends U{constructor(){super(null)}}class G extends k{constructor(e){super(S.Z.AIR_LEVEL_CHANGED),this.airLevel=e}}class H extends k{constructor(e){super(S.Z.SETUP_PRIORITY_LIST),this.priorityList=e}}class J extends k{constructor(e){super(S.Z.BUILDINGS_CHANGED),this.usableBuildingsByTypeAndLevel=new Map,e.buildings.forEach((e=>{if(e.isUsable()){const t=this.usableBuildingsByTypeAndLevel.getOrUpdate(e.entityType,(()=>new Map));t.set(e.level,t.getOrUpdate(e.level,(()=>0))+1)}}))}static countUsable(e,t,s=0){let i=0;return e.usableBuildingsByTypeAndLevel.getOrUpdate(t,(()=>new Map)).forEach(((e,t)=>{t>=s&&(i+=e)})),i}}class V extends k{constructor(e,t=null){super(S.Z.RAIDERS_CHANGED),this.numRaiders=e.raiders.length,this.training=t}}class q extends k{constructor(){super(S.Z.VEHICLES_CHANGED)}}class j extends k{constructor(e,t){super(S.Z.UPDATE_RADAR_TERRAIN),this.surfaces=[],e.forEachSurface((e=>{e.discovered&&this.surfaces.push(new D(e))})),this.tileX=Math.floor(t.x/l.pM),this.tileY=Math.floor(t.z/l.pM)}}class Z extends k{constructor(e){super(S.Z.UPDATE_RADAR_SURFACE),this.surfaceRect=new D(e)}}class K extends k{constructor(e){super(S.Z.UPDATE_PRIORITIES),this.priorityList=e}}class Y extends k{}class z extends Y{constructor(){super(S.Z.COMMAND_CANCEL_BUILD_MODE)}}class X{constructor(e,t){this.position=e,this.heading=e.clone().sub(t).angle(),e.y===t.y?this.heading-=Math.PI/2:this.heading+=Math.PI/2}}class $ extends B.Z{constructor(e){super(e),this.isLocal=!1}}class Q extends ${constructor(e,t){super(e),this.guiForward=!1,this.job=t}}class ee extends Q{constructor(e){super(S.Z.JOB_CREATE,e)}}class te extends Q{constructor(e){super(S.Z.JOB_DELETE,e)}}class se extends ${constructor(e){super(S.Z.REQUESTED_RAIDERS_CHANGED),this.numRequested=e}}class ie extends ${constructor(){super(S.Z.MATERIAL_AMOUNT_CHANGED),this.numCrystal=o.numCrystal,this.usedCrystal=o.usedCrystals,this.neededCrystal=o.neededCrystals,this.totalOre=o.numOre+5*o.numBrick}}class re extends ${constructor(){super(S.Z.CAVERN_DISCOVERED)}}class ne extends ${constructor(){super(S.Z.ORE_FOUND)}}class ae{constructor(e){this.activityKey=e}}class oe extends ae{}oe.Stand=new oe("Activity_Stand");class le extends oe{}le.Short=new oe("Short"),le.Expand=new oe("Expand"),le.Long=new oe("Long"),le.Teleport=new oe("Teleport");class he extends oe{}he.Route=new he("Activity_Route"),he.RunPanic=new he("Activity_RunPanic"),he.Drill=new he("Activity_Drill"),he.Walk=new he("Activity_Walk"),he.Reinforce=new he("Activity_Reinforce"),he.Reverse=new he("Activity_Reverse"),he.TurnLeft=new he("Activity_TurnLeft"),he.TurnRight=new he("Activity_TurnRight"),he.CantDo=new he("Activity_CantDo"),he.Collect=new he("Activity_Collect"),he.Clear=new he("Activity_Clear"),he.Carry=new he("Activity_Carry"),he.CarryTurnLeft=new he("Activity_CarryTurnLeft"),he.CarryTurnRight=new he("Activity_CarryTurnRight"),he.CarryStand=new he("Activity_CarryStand"),he.Dynamite=new he("Activity_Dynamite"),he.Place=new he("Activity_Place"),he.Deposit=new he("Activity_Deposit"),he.TeleportIn=new he("Activity_TeleportIn"),he.Repair=new he("Activity_Repair"),he.rest=new he("Activity_rest"),he.routeRubble=new he("Activity_routeRubble"),he.CarryRubble=new he("Activity_CarryRubble"),he.Eat=new he("Activity_Eat"),he.FireLaser=new he("Activity_FireLaser"),he.GetUp=new he("Activity_GetUp"),he.ThrownByRockMonster=new he("Activity_ThrownByRockMonster"),he.Slip=new he("Activity_Slip"),he.Train=new he("Activity_Train"),he.Recharge=new he("Activity_Recharge"),he.Waiting1=new he("Activity_Waiting1"),he.Waiting2=new he("Activity_Waiting2"),he.Waiting3=new he("Activity_Waiting3"),he.Waiting4=new he("Activity_Waiting4"),he.Hoverboard=new he("Activity_Hoverboard"),he.Standhoverboard=new he("Activity_Standhoverboard"),he.HitLefthoverboard=new he("Activity_HitLefthoverboard"),he.HitRighthoverboard=new he("Activity_HitRighthoverboard"),he.HitFronthoverboard=new he("Activity_HitFronthoverboard"),he.HitBackhoverboard=new he("Activity_HitBackhoverboard"),he.SMALLTRUCK=new he("Activity_SMALLTRUCK"),he.StandSMALLTRUCK=new he("Activity_StandSMALLTRUCK"),he.HitLeftSMALLTRUCK=new he("Activity_HitLeftSMALLTRUCK"),he.HitRightSMALLTRUCK=new he("Activity_HitRightSMALLTRUCK"),he.HitFrontSMALLTRUCK=new he("Activity_HitFrontSMALLTRUCK"),he.HitBackSMALLTRUCK=new he("Activity_HitBackSMALLTRUCK"),he.SMALLheli=new he("Activity_SMALLheli"),he.StandSMALLheli=new he("Activity_StandSMALLheli"),he.HitLeftSMALLheli=new he("Activity_HitLeftSMALLheli"),he.HitRightSMALLheli=new he("Activity_HitRightSMALLheli"),he.HitFrontSMALLheli=new he("Activity_HitFrontSMALLheli"),he.HitBackSMALLheli=new he("Activity_HitBackSMALLheli"),he.SMALLCAT=new he("Activity_SMALLCAT"),he.StandSMALLCAT=new he("Activity_StandSMALLCAT"),he.HitLeftSMALLCAT=new he("Activity_HitLeftSMALLCAT"),he.HitRightSMALLCAT=new he("Activity_HitRightSMALLCAT"),he.HitFrontSMALLCAT=new he("Activity_HitFrontSMALLCAT"),he.HitBackSMALLCAT=new he("Activity_HitBackSMALLCAT"),he.SMALLMLP=new he("Activity_SMALLMLP"),he.StandSMALLMLP=new he("Activity_StandSMALLMLP"),he.HitLeftSMALLMLP=new he("Activity_HitLeftSMALLMLP"),he.HitRightSMALLMLP=new he("Activity_HitRightSMALLMLP"),he.HitFrontSMALLMLP=new he("Activity_HitFrontSMALLMLP"),he.HitBackSMALLMLP=new he("Activity_HitBackSMALLMLP"),he.LARGECAT=new he("Activity_LARGECAT"),he.StandLARGECAT=new he("Activity_StandLARGECAT"),he.HitLeftLARGECAT=new he("Activity_HitLeftLARGECAT"),he.HitRightLARGECAT=new he("Activity_HitRightLARGECAT"),he.HitFrontLARGECAT=new he("Activity_HitFrontLARGECAT"),he.HitBackLARGECAT=new he("Activity_HitBackLARGECAT"),he.SMALLDIGGER=new he("Activity_SMALLDIGGER"),he.StandSMALLDIGGER=new he("Activity_StandSMALLDIGGER");class ce{constructor(e,t=0){this.targetLocation=e,this.radiusSq=t}getFocusPoint(){return this.targetLocation}canGatherItem(){return!1}gatherItem(e){e.sceneEntity.addToScene(null,null)}getDropAction(){return he.Place}isInvalid(){return!1}}!function(e){e[e.aiPriorityTrain=0]="aiPriorityTrain",e[e.aiPriorityGetIn=1]="aiPriorityGetIn",e[e.aiPriorityCrystal=2]="aiPriorityCrystal",e[e.aiPriorityOre=3]="aiPriorityOre",e[e.aiPriorityRepair=4]="aiPriorityRepair",e[e.aiPriorityClearing=5]="aiPriorityClearing",e[e.aiPriorityDestruction=6]="aiPriorityDestruction",e[e.aiPriorityConstruction=7]="aiPriorityConstruction",e[e.aiPriorityReinforce=8]="aiPriorityReinforce",e[e.aiPriorityRecharge=9]="aiPriorityRecharge"}(_||(_={})),function(e){e[e.INCOMPLETE=0]="INCOMPLETE",e[e.COMPLETE=1]="COMPLETE",e[e.CANCELED=2]="CANCELED"}(F||(F={}));class ue{constructor(){this.jobState=F.INCOMPLETE}getRequiredTool(){return L.NONE}getRequiredTraining(){return P.NONE}isReadyToComplete(){return!0}onJobComplete(){this.jobState=F.COMPLETE}setActualWorkplace(e){}getCarryItem(){return null}getWorkActivity(){return null}getWorkDuration(e){return null}}class de extends ue{constructor(){super(...arguments),this.fulfiller=[]}assign(e){const t=this.fulfiller.indexOf(e);e&&-1===t&&this.fulfiller.push(e)}unAssign(e){this.fulfiller.remove(e)}cancel(){this.jobState=F.CANCELED;const e=this.fulfiller;this.fulfiller=[],e.forEach((e=>e.stopJob()))}}class ge extends de{constructor(e,t){super(),this.surface=e,this.placedItems=t,this.workplaces=[new ce(e.getRandomPosition())]}onJobComplete(){super.onJobComplete(),this.placedItems.forEach((e=>e.sceneEntity.removeFromScene())),this.surface.setSurfaceType(R.POWER_PATH)}getRequiredTool(){return L.SHOVEL}getPriorityIdentifier(){return _.aiPriorityConstruction}getWorkplaces(){return this.workplaces}getWorkActivity(){return he.Clear}}class pe{constructor(e,t,s,i,r,n){this.primarySurface=null,this.secondarySurface=null,this.primaryPathSurface=null,this.surfaces=[],this.heading=0,this.neededByType=new Map,this.assignedByType=new Map,this.onSiteByType=new Map,this.complete=!1,this.canceled=!1,this.entityMgr=e,this.primarySurface=t,this.primarySurface.setSite(this),this.surfaces.push(this.primarySurface),this.secondarySurface=s,this.secondarySurface&&(this.secondarySurface.setSite(this),this.surfaces.push(this.secondarySurface)),this.primaryPathSurface=i,this.primaryPathSurface.setSurfaceType(R.POWER_PATH_BUILDING),this.surfaces.push(this.primaryPathSurface),r&&(r.setSurfaceType(R.POWER_PATH_BUILDING),this.surfaces.push(r)),this.building=n}getRandomDropPosition(){return this.primarySurface.getRandomPosition()}needs(e){return this.neededByType.getOrUpdate(e,(()=>0))>this.assignedByType.getOrUpdate(e,(()=>[])).length}assign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).push(e)}unAssign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).remove(e)}addItem(e){this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).push(e),this.checkComplete()}checkComplete(){if(!this.complete&&!this.canceled&&(this.complete=!0,this.neededByType.forEach(((e,t)=>{this.complete=this.complete&&this.onSiteByType.getOrUpdate(t,(()=>[])).length>=e})),this.complete))if(this.entityMgr.buildingSites.remove(this),this.building){this.onSiteByType.getOrUpdate(M.BARRIER,(()=>[])).forEach((e=>{e.sceneEntity.changeActivity(le.Teleport,(()=>e.sceneEntity.removeFromScene()))})),this.onSiteByType.getOrUpdate(M.CRYSTAL,(()=>[])).forEach((e=>{e.sceneEntity.removeFromScene()})),this.onSiteByType.getOrUpdate(M.ORE,(()=>[])).forEach((e=>{e.sceneEntity.removeFromScene()}));const e=this.primarySurface.getCenterWorld2D();this.building.placeDown(e,-this.heading+Math.PI/2,!1)}else{const e=[];this.onSiteByType.forEach((t=>e.push(...t))),T.publishEvent(new ee(new ge(this.primarySurface,e)))}}getDropAction(){return he.Place}cancelSite(){this.entityMgr.buildingSites.remove(this),this.canceled=!0,this.surfaces.forEach((e=>null==e?void 0:e.setSite(null))),this.onSiteByType.forEach((e=>e.forEach((e=>{this.entityMgr.placeMaterial(e,e.sceneEntity.position2D.clone())})))),this.onSiteByType.clear(),this.assignedByType.clear(),T.publishEvent(new W)}getWalkOutSurface(){var e;return this.primaryPathSurface||this.primarySurface.neighbors.find((e=>!e.site&&e.isWalkable()))||(null===(e=this.secondarySurface)||void 0===e?void 0:e.neighbors.find((e=>!e.site&&e.isWalkable())))}}var ye,me=s(586);!function(e){e[e.CORNER=1]="CORNER",e[e.WALL=2]="WALL",e[e.INVERTED_CORNER=3]="INVERTED_CORNER",e[e.WEIRD_CREVICE=20]="WEIRD_CREVICE"}(ye||(ye={}));class fe{static create(e,t,s,i,r,n,a,o,l){let c=0;!t.y||i.y||e!==ye.INVERTED_CORNER&&(e===ye.WALL||e===ye.WEIRD_CREVICE)!==Boolean(s.y)||(c=0),!s.y||r.y||e!==ye.INVERTED_CORNER&&(e===ye.WALL||e===ye.WEIRD_CREVICE)!==Boolean(i.y)||(c=3),!i.y||t.y||e!==ye.INVERTED_CORNER&&(e===ye.WALL||e===ye.WEIRD_CREVICE)!==Boolean(r.y)||(c=2),!r.y||s.y||e!==ye.INVERTED_CORNER&&(e===ye.WALL||e===ye.WEIRD_CREVICE)!==Boolean(t.y)||(c=1),e!==ye.WALL&&e!==ye.WEIRD_CREVICE||(t.y&&i.y&&(c=0),s.y&&r.y&&(c=3));const u=[new h.FM8(0,1),new h.FM8(1,1),new h.FM8(1,0),new h.FM8(0,0)],d=[],g=[];function p(e,t,s){d.push(e,t,s);const i=(new h.Pa4).subVectors(s,t);i.cross((new h.Pa4).subVectors(e,t)),i.normalize(),g.push(i,i,i)}const y=[];s.y===r.y&&(e!==ye.WALL&&e!==ye.WEIRD_CREVICE||s.y&&r.y)?(y.push(0,3,2),y.push(0,2,1),t.y=n,s.y=a,i.y=o,r.y=l,p(t,r,i),p(t,i,s)):(y.push(1,3,2),y.push(1,0,3),t.y=n,s.y=a,i.y=o,r.y=l,p(s,r,i),p(s,t,r));const m=y.map((e=>u[(e+c)%4])),f=new h.u9r;return f.setAttribute("position",new me.Tl(new Float32Array(18),3).copyVector3sArray(d)),f.setAttribute("normal",new me.Tl(new Float32Array(18),3).copyVector3sArray(g)),f.setAttribute("uv",new me.Tl(new Float32Array(12),2).copyVector2sArray(m)),f}}class ve extends h.Kj0{constructor(e,t){super(ve.geometry,new h.xoR({shininess:0,transparent:!0,opacity:.4,color:t})),this.sceneMgr=e,this.standardColor=t,this.visible=!1}updateState(e,t,s){this.visible=!!e,e&&this.position.set(e.x,0,e.y).multiplyScalar(l.pM).applyAxisAngle(new h.Pa4(0,1,0),-t+Math.PI/2).add(s)}markAsValid(e){const t=e?this.standardColor:5242880;this.material.color.setHex(t)}get surface(){return this.visible?this.sceneMgr.terrain.getSurfaceFromWorld(this.position):null}}ve.geometry=fe.create(ye.WALL,new h.Pa4(0,0,0),new h.Pa4(l.pM,0,0),new h.Pa4(l.pM,0,l.pM),new h.Pa4(0,0,l.pM),1,1,1,1);class Ee{constructor(e,t,s){this.group=new h.ZAu,this.markers=[],this.buildingMarkerPrimary=null,this.buildingMarkerSecondary=null,this.powerPathMarkerPrimary=null,this.powerPathMarkerSecondary=null,this.waterPathMarker=null,this.heading=0,this.sdx=0,this.sdz=0,this.lastCheck=!1,this.buildModeSelection=null,this.worldMgr=e,this.sceneMgr=t,this.entityMgr=s,this.buildingMarkerPrimary=new ve(this.sceneMgr,Ee.buildingMarkerColor),this.buildingMarkerSecondary=new ve(this.sceneMgr,Ee.buildingMarkerColor),this.powerPathMarkerPrimary=new ve(this.sceneMgr,Ee.pathMarkerColor),this.powerPathMarkerSecondary=new ve(this.sceneMgr,Ee.pathMarkerColor),this.waterPathMarker=new ve(this.sceneMgr,Ee.waterMarkerColor),this.addMarker(this.buildingMarkerPrimary),this.addMarker(this.buildingMarkerSecondary),this.addMarker(this.powerPathMarkerPrimary),this.addMarker(this.powerPathMarkerSecondary),this.addMarker(this.waterPathMarker)}addMarker(e){this.group.add(e),this.markers.push(e)}update(e){if(e&&this.buildModeSelection){const t=this.updateAllMarker(e);this.markers.forEach((e=>e.markAsValid(t)))}else this.hideAllMarker()}updateAllMarker(e=null){this.buildingMarkerPrimary.visible=!0,this.buildingMarkerPrimary.position.copy(this.sceneMgr.getFloorPosition(new h.FM8(Math.floor(e.x/l.pM)*l.pM,Math.floor(e.y/l.pM)*l.pM)));const t=e.x-this.buildingMarkerPrimary.position.x-l.pM/2,s=e.y-this.buildingMarkerPrimary.position.z-l.pM/2,i=Math.abs(t)>Math.abs(s)?Math.sign(t):0,r=Math.abs(s)>Math.abs(t)?Math.sign(s):0;if(this.sdx===i&&this.sdz===r)return this.lastCheck;this.sdx=i,this.sdz=r,this.heading=Math.atan2(r,i),this.buildingMarkerSecondary.updateState(this.buildModeSelection.secondaryBuildingPart,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerPrimary.updateState(this.buildModeSelection.primaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerSecondary.updateState(this.buildModeSelection.secondaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.waterPathMarker.updateState(this.buildModeSelection.waterPathSurface,this.heading,this.buildingMarkerPrimary.position);const n=[this.buildingMarkerPrimary,this.buildingMarkerSecondary,this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].filter((e=>e.visible)).map((e=>this.sceneMgr.terrain.getSurfaceFromWorld(e.position))).every((e=>e.surfaceType===R.GROUND));return this.lastCheck=n&&([this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].some((e=>e.visible&&e.surface.neighbors.some((e=>e.surfaceType===R.POWER_PATH))))||!this.buildModeSelection.primaryPowerPath&&this.buildingMarkerPrimary.surface.neighbors.some((e=>e.surfaceType===R.POWER_PATH||this.buildingMarkerSecondary.visible&&this.buildingMarkerSecondary.surface.neighbors.some((e=>e.surfaceType===R.POWER_PATH)))))&&(!this.waterPathMarker.visible||this.waterPathMarker.surface.surfaceType===R.WATER),this.lastCheck}hideAllMarker(){this.markers.forEach((e=>e.visible=!1)),this.lastCheck=!1}createBuildingSite(){if(!this.buildModeSelection||!this.lastCheck)return;const e=this.getBarrierLocations(),t=this.buildModeSelection.stats,s=(null==t?void 0:t.CostCrystal)||0,i=(null==t?void 0:t.CostOre)||0,r=this.buildingMarkerPrimary.surface,n=new pe(this.entityMgr,r,this.buildingMarkerSecondary.surface,this.powerPathMarkerPrimary.surface,this.powerPathMarkerSecondary.surface,this.buildModeSelection);n.heading=this.heading,n.neededByType.set(M.BARRIER,e.length),n.neededByType.set(M.CRYSTAL,s),n.neededByType.set(M.ORE,i),this.entityMgr.buildingSites.push(n);const a=this.entityMgr.getClosestBuildingByType(r.getCenterWorld(),M.TOOLSTATION);a&&(a.spawnBarriers(e,n),a.spawnMaterials(M.CRYSTAL,s),a.spawnMaterials(M.ORE,i)),T.publishEvent(new W),T.publishEvent(new z)}getBarrierLocations(){const e=[],t=this.buildingMarkerPrimary.surface.getCenterWorld2D(),s=9*l.pM/20;if(this.buildingMarkerSecondary.visible){const i=this.buildingMarkerSecondary.surface.getCenterWorld2D(),r=Math.sign(i.x-t.x),n=Math.sign(i.y-t.y);0!==r?(e.push(new X(new h.FM8(t.x-r*s,t.y),t)),e.push(new X(new h.FM8(t.x,t.y-s),t)),e.push(new X(new h.FM8(t.x,t.y+s),t)),e.push(new X(new h.FM8(i.x+r*s,i.y),i)),e.push(new X(new h.FM8(i.x,i.y-s),i)),e.push(new X(new h.FM8(i.x,i.y+s),i))):(e.push(new X(new h.FM8(t.x,t.y-n*s),t)),e.push(new X(new h.FM8(t.x-s,t.y),t)),e.push(new X(new h.FM8(t.x+s,t.y),t)),e.push(new X(new h.FM8(i.x,i.y+n*s),i)),e.push(new X(new h.FM8(i.x-s,i.y),i)),e.push(new X(new h.FM8(i.x+s,i.y),i)))}else e.push(new X(new h.FM8(t.x-s,t.y),t)),e.push(new X(new h.FM8(t.x,t.y-s),t)),e.push(new X(new h.FM8(t.x+s,t.y),t)),e.push(new X(new h.FM8(t.x,t.y+s),t));return e}}Ee.buildingMarkerColor=20480,Ee.pathMarkerColor=5263360,Ee.waterMarkerColor=80;class we extends ce{constructor(e){super(e.sceneEntity.position2D.clone()),this.building=e}isInvalid(){return!this.building.isUsable()}}class be extends ue{assign(e){if(this.raider!==e){if(this.raider)throw"Job already assigned";this.raider=e}}unAssign(e){this.raider===e&&(this.raider=null)}cancel(){var e;this.jobState=F.CANCELED,null===(e=this.raider)||void 0===e||e.stopJob()}}class Me extends be{constructor(e,t,s){super(),this.entityMgr=e,this.tool=t,this.workplaces=s?[s.getPathTarget()]:this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((e=>new we(e)))}getWorkplaces(){return this.workplaces.some((e=>!e.building.isUsable()))&&(this.workplaces=this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((e=>new we(e)))),this.workplaces}onJobComplete(){super.onJobComplete(),this.raider.addTool(this.tool)}}class Se extends be{constructor(e){super(),this.target=[new ce(e)]}getWorkplaces(){return this.target}}class Te{constructor(){this.surface=null,this.building=null,this.raiders=[],this.vehicles=[]}isEmpty(){return!this.surface&&!this.building&&this.raiders.length<1&&this.vehicles.length<1}set(e){var t,s,i,r;let n=!1;n=Te.syncSelection(this.raiders,e.raiders)||n,n=Te.syncSelection(this.vehicles,e.vehicles)||n,this.building!==e.building&&(null===(t=this.building)||void 0===t||t.deselect(),(null===(s=e.building)||void 0===s?void 0:s.isInSelection())?(this.building=e.building,this.building.select()&&(n=!0)):this.building=null),this.surface!==e.surface&&(null===(i=this.surface)||void 0===i||i.deselect(),(null===(r=e.surface)||void 0===r?void 0:r.isInSelection())?(this.surface=e.surface,this.surface.select()&&(n=!0)):this.surface=null),n&&u.P.playSample(p.d.SFX_Okay)}static syncSelection(e,t){let s=!1;return e.forEach((s=>{-1===t.indexOf(s)&&(e.remove(s),s.deselect())})),t.forEach((t=>{-1===e.indexOf(t)&&t.select()&&(e.push(t),s=!0)})),s}getSelectPanelType(){return this.raiders.length>0?N.RAIDER:this.vehicles.length>0?N.VEHICLE:this.building?N.BUILDING:this.surface?N.SURFACE:void 0}assignSurfaceJob(e){e&&(this.raiders.forEach((t=>{t.isPrepared(e)?t.setJob(e):t.setJob(new Me(t.entityMgr,e.getRequiredTool(),t.entityMgr.getClosestBuildingByType(t.sceneEntity.position.clone(),M.TOOLSTATION)),e)})),this.vehicles.forEach((t=>{t.isPrepared(e)&&t.setJob(e)})))}assignMoveJob(e){if(!e)return;const t=l.pM/3,s=e.divideScalar(t).floor().addScalar(.5).multiplyScalar(t);this.raiders.forEach((e=>e.setJob(new Se(s))));const i=l.pM,r=e.divideScalar(i).floor().addScalar(.5).multiplyScalar(i);this.vehicles.forEach((e=>e.setJob(new Se(r))))}deselectAll(){var e,t;this.raiders.forEach((e=>e.deselect())),this.raiders=[],this.vehicles.forEach((e=>e.deselect())),this.vehicles=[],null===(e=this.building)||void 0===e||e.deselect(),this.building=null,null===(t=this.surface)||void 0===t||t.deselect(),this.surface=null}}function Le(e){let t=e;const s=[];for(;t.parent;)s.unshift(t),t=t.parent;return s}const Ae={search(e,t,s,i=null){e.cleanDirty();const r=(i=i||{}).heuristic||Ae.heuristics.manhattan,n=i.closest||!1,a=new Pe((function(e){return e.f}));let o=t;for(t.h=r(t,s),e.markDirty(t),a.push(t);a.size()>0;){const t=a.pop();if(t===s)return Le(t);t.closed=!0;const i=e.neighbors(t);let l=0;const h=i.length;for(;l<h;++l){const h=i[l];if(h.closed||h.isWall())continue;const c=t.g+h.getCost(t),u=h.visited;(!u||c<h.g)&&(h.visited=!0,h.parent=t,h.h=h.h||r(h,s),h.g=c,h.f=h.g+h.h,e.markDirty(h),n&&(h.h<o.h||h.h===o.h&&h.g<o.g)&&(o=h),u?a.rescoreElement(h):a.push(h))}}return n?Le(o):[]},heuristics:{manhattan:(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),diagonal(e,t){const s=Math.sqrt(2),i=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return 1*(i+r)+(s-2)*Math.min(i,r)}},cleanNode(e){e.f=0,e.g=0,e.h=0,e.visited=!1,e.closed=!1,e.parent=null}};class Re{constructor(e,t=null){this.nodes=[],this.grid=[],this.dirtyNodes=[],t=t||{},this.diagonal=!!t.diagonal;for(let t=0;t<e.length;t++){this.grid[t]=[];let s=0;const i=e[t];for(;s<i.length;s++){const e=new Ce(t,s,i[s]);this.grid[t][s]=e,this.nodes.push(e)}}this.init()}init(){this.dirtyNodes=[];for(let e=0;e<this.nodes.length;e++)Ae.cleanNode(this.nodes[e])}cleanDirty(){for(let e=0;e<this.dirtyNodes.length;e++)Ae.cleanNode(this.dirtyNodes[e]);this.dirtyNodes=[]}markDirty(e){this.dirtyNodes.push(e)}neighbors(e){var t,s,i,r,n,a,o,l;const h=[],c=e.x,u=e.y,d=this.grid;return d[c-1]&&d[c-1][u]&&h.push(d[c-1][u]),d[c+1]&&d[c+1][u]&&h.push(d[c+1][u]),d[c]&&d[c][u-1]&&h.push(d[c][u-1]),d[c]&&d[c][u+1]&&h.push(d[c][u+1]),this.diagonal&&(d[c-1]&&d[c-1][u-1]&&d[c]&&(null===(t=d[c][u-1])||void 0===t?void 0:t.weight)&&d[c-1]&&(null===(s=d[c-1][u])||void 0===s?void 0:s.weight)&&h.push(d[c-1][u-1]),d[c+1]&&d[c+1][u-1]&&d[c]&&(null===(i=d[c][u-1])||void 0===i?void 0:i.weight)&&d[c+1]&&(null===(r=d[c+1][u])||void 0===r?void 0:r.weight)&&h.push(d[c+1][u-1]),d[c-1]&&d[c-1][u+1]&&d[c]&&(null===(n=d[c][u+1])||void 0===n?void 0:n.weight)&&d[c-1]&&(null===(a=d[c-1][u])||void 0===a?void 0:a.weight)&&h.push(d[c-1][u+1]),d[c+1]&&d[c+1][u+1]&&d[c]&&(null===(o=d[c][u+1])||void 0===o?void 0:o.weight)&&d[c+1]&&(null===(l=d[c+1][u])||void 0===l?void 0:l.weight)&&h.push(d[c+1][u+1])),h}toString(){const e=[],t=this.grid;for(let s=0;s<t.length;s++){const i=[],r=t[s];for(let e=0;e<r.length;e++)i.push(r[e].weight);e.push(i.join(" "))}return e.join("\n")}}class Ce{constructor(e,t,s){this.x=e,this.y=t,this.weight=s}toString(){return"["+this.x+" "+this.y+"]"}getCost(e){return e&&e.x!=this.x&&e.y!=this.y?1.41421*this.weight:this.weight}isWall(){return 0===this.weight}}class Pe{constructor(e){this.content=[],this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.sinkDown(this.content.length-1)}pop(){const e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e}remove(e){const t=this.content.indexOf(e),s=this.content.pop();t!==this.content.length-1&&(this.content[t]=s,this.scoreFunction(s)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))}size(){return this.content.length}rescoreElement(e){this.sinkDown(this.content.indexOf(e))}sinkDown(e){const t=this.content[e];for(;e>0;){const s=(e+1>>1)-1,i=this.content[s];if(!(this.scoreFunction(t)<this.scoreFunction(i)))break;this.content[s]=t,this.content[e]=i,e=s}}bubbleUp(e){const t=this.content.length,s=this.content[e],i=this.scoreFunction(s);for(;;){const r=e+1<<1,n=r-1;let a,o=null;if(n<t){const e=this.content[n];a=this.scoreFunction(e),a<i&&(o=n)}if(r<t){const e=this.content[r];this.scoreFunction(e)<(null===o?i:a)&&(o=r)}if(null===o)break;this.content[e]=this.content[o],this.content[o]=s,e=o}}}class Ie extends ${constructor(e,t){super(e),this.location=t}}class xe extends Ie{constructor(e){super(S.Z.LOCATION_CRYSTAL_FOUND,e)}}class Oe extends Ie{constructor(e){super(S.Z.LOCATION_LANDSLIDE,e)}}class De extends Ie{constructor(e){super(S.Z.LOCATION_RAIDER_DISCOVERED,e)}}class Ne extends ae{}Ne.Normal=new Ne("Normal"),Ne.TickDown=new Ne("TickDown");class _e extends de{constructor(e){super(),this.targets=[],this.actualTarget=null,this.item=e}getWorkplaces(){var e;return(this.targets.length<1||(null===(e=this.actualTarget)||void 0===e?void 0:e.isInvalid()))&&(this.targets=this.item.findCarryTargets()),this.targets}getPriorityIdentifier(){return this.item.getPriorityIdentifier()}setActualWorkplace(e){var t,s,i,r;this.actualTarget!==e&&(null===(s=null===(t=this.actualTarget)||void 0===t?void 0:t.site)||void 0===s||s.unAssign(this.item),this.actualTarget=e,null===(r=null===(i=this.actualTarget)||void 0===i?void 0:i.site)||void 0===r||r.assign(this.item))}getCarryItem(){return this.item}getWorkActivity(){return this.actualTarget.getDropAction()}isReadyToComplete(){return this.actualTarget.canGatherItem()}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>{e.sceneEntity.headTowards(this.actualTarget.targetLocation),e.dropItem(),this.item.sceneEntity.position.copy(this.item.sceneMgr.getFloorPosition(this.actualTarget.targetLocation))})),this.actualTarget.gatherItem(this.item)}}class Fe extends _e{constructor(e){super(e),this.color=10510432}getRequiredTraining(){return P.DEMOLITION}onJobComplete(){super.onJobComplete(),this.item.sceneEntity.headTowards(this.item.targetSurface.getCenterWorld2D()),this.item.sceneEntity.changeActivity(Ne.TickDown,(()=>{this.item.sceneEntity.removeFromScene(),this.item.targetSurface.collapse()}))}}class Be extends de{constructor(e){super(),this.surface=e,this.lastRubblePositions=this.surface.rubblePositions.map((e=>new ce(e)))}getRequiredTool(){return L.SHOVEL}getWorkplaces(){const e=this.surface.rubblePositions;return this.lastRubblePositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.lastRubblePositions.some((t=>e.equals(t.targetLocation)))))||(this.lastRubblePositions=e.map((e=>new ce(e)))),this.lastRubblePositions}onJobComplete(){this.surface.reduceRubble(),this.surface.hasRubble()||(this.surface.clearRubbleJob=null,super.onJobComplete())}getPriorityIdentifier(){return _.aiPriorityClearing}getWorkActivity(){return he.Clear}}class ke extends ce{constructor(e,t){super(e),this.surface=t}getFocusPoint(){return this.surface.getCenterWorld2D()}isInvalid(){return!this.surface.isDigable()}}class Ue extends de{constructor(e){super(),this.color=10526880,this.surface=e,this.digPositions=this.surface.getDigPositions().map((e=>new ke(e,this.surface)))}getRequiredTool(){return L.DRILL}getWorkplaces(){const e=this.surface.getDigPositions();return this.digPositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.digPositions.some((t=>e.equals(t.targetLocation)))))||(this.digPositions=e.map((e=>new ke(e,this.surface)))),this.digPositions}onJobComplete(){this.surface.onDrillComplete(this.fulfiller.last().sceneEntity.position2D.clone())&&super.onJobComplete()}getPriorityIdentifier(){return _.aiPriorityDestruction}getWorkActivity(){return he.Drill}getWorkDuration(e){const t=new Map;this.fulfiller.forEach((e=>{t.getOrUpdate(e.entityType,(()=>({drillTime:1e3*e.stats[this.surface.surfaceType.statsDrillName][e.level],count:0}))).count++}));const s=t.get(e.entityType),i=(null==s?void 0:s.drillTime)/((null==s?void 0:s.count)||1)||null;return i||console.warn("According to cfg this entity cannot drill this material"),i}}class We extends de{constructor(e){super(),this.color=6332512,this.surface=e,this.digPositions=this.surface.getDigPositions().map((e=>new ke(e,this.surface)))}getWorkplaces(){const e=this.surface.getDigPositions();return this.digPositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.digPositions.some((t=>e.equals(t.targetLocation)))))||(this.digPositions=e.map((e=>new ke(e,this.surface)))),this.digPositions}onJobComplete(){super.onJobComplete(),this.surface.reinforce()}getPriorityIdentifier(){return _.aiPriorityReinforce}getWorkActivity(){return he.Reinforce}getWorkDuration(e){return 2700}getRequiredTool(){return L.HAMMER}}class Ge{constructor(e){this.floorOffset=.1,this.group=new h.ZAu,this.pickSphere=null,this.selectionFrame=null,this.boundingSphere=new h.aLr,this.sceneMgr=e}set visible(e){this.group.visible=e}get visible(){return this.group.visible}get position(){return this.group.position}set position(e){this.group.position.copy(e)}get position2D(){return new h.FM8(this.group.position.x,this.group.position.z)}add(e){this.group.add(e)}remove(e){this.group.remove(e)}getRadiusSquare(){return(new h.ZzF).setFromObject(this.group).getBoundingSphere(this.boundingSphere),this.boundingSphere.radius*this.boundingSphere.radius}getHeading(){return this.group.rotation.y}setHeading(e){this.group.rotation.y=e}lookAt(e){this.group.lookAt(e)}flipXAxis(){this.group.applyMatrix4((new h.yGw).makeScale(-1,1,1))}createPickSphere(e,t,s=this.getBoundingSphereCenter().y-this.position.y){if(this.pickSphere)return;const i=e/2,r=new h.xo$(i,i,i),n=new h.vBJ({color:16776960,visible:!1});this.pickSphere=new h.Kj0(r,n),this.pickSphere.userData={selectable:t},this.pickSphere.position.y=s,this.add(this.pickSphere),this.createSelectionFrame(e,this.pickSphere.position)}getBoundingSphereCenter(){const e=new h.Pa4;return(new h.ZzF).setFromObject(this.group).getCenter(e),e}createSelectionFrame(e,t){const s=128,i=(0,c.kr)(s,s);i.fillStyle="#0f0";const r=Math.round(50/e),n=21.333333333333332;i.fillRect(0,0,n,r),i.fillRect(0,0,r,n),i.fillRect(106.66666666666667,0,n,r),i.fillRect(s-r,0,r,n),i.fillRect(s-r,106.66666666666667,r,n),i.fillRect(106.66666666666667,s-r,n,r),i.fillRect(0,s-r,n,r),i.fillRect(0,106.66666666666667,r,n);const a=new h.ROQ(i.canvas),o=new h.xeV({map:a,depthTest:!1});this.selectionFrame=new h.jyi(o),this.selectionFrame.position.copy(t);const l=3*e/4;this.selectionFrame.scale.set(l,l,l),this.selectionFrame.visible=!1,this.add(this.selectionFrame)}get surfaces(){return[this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position)]}playPositionalAudio(e,t){const s=new h.VYz(this.sceneMgr.listener);return s.setRefDistance(2*l.pM),s.loop=t,this.add(s),u.P.getSoundBuffer(e).then((e=>{s.setBuffer(e).play(),s.loop||(s.onEnded=()=>this.remove(s))})).catch((()=>{this.remove(s)})),s}addToScene(e,t){e&&(this.position.copy(this.sceneMgr.getFloorPosition(e)),this.position.y+=this.floorOffset),null!=t&&this.setHeading(t),this.visible=this.surfaces.some((e=>e.discovered)),this.sceneMgr.scene.add(this.group)}removeFromScene(){this.sceneMgr.scene.remove(this.group)}getDefaultActivity(){return oe.Stand}changeActivity(e=this.getDefaultActivity(),t=null,s=null){}headTowards(e){this.lookAt(new h.Pa4(e.x,this.group.position.y,e.y))}}class He extends Ge{constructor(e){super(e);const t=bt.getLwoModel("MiscAnims/Crystal/vlp_greencrystal.lwo");t.getMaterials().forEach((e=>{e.blending=h.WMw,e.depthWrite=!1,e.setOpacity(.5)})),t.scale.set(1.75,1.75,1.75),this.add(t);const s=bt.getLwoModel("World/Shared/Crystal.lwo");s.getMaterials().forEach((e=>{e.emissive=new h.Ilk(0,8,0),e.color=new h.Ilk(0,0,0),e.setOpacity(.9)})),this.add(s)}}class Je extends oe{}Je.Teleport=new Je("Activity_Teleport"),Je.Deposit=new Je("Activity_Deposit"),Je.Explode=new Je("Activity_Explode"),Je.Unpowered=new Je("Activity_Unpowered");class Ve extends ce{constructor(e,t=0){super(e,t)}canGatherItem(){return!0}gatherItem(e){e.sceneEntity.addToScene(null,null)}getDropAction(){return he.Place}}class qe extends Ve{constructor(e){super(e.getDropPosition2D()),this.building=e}getFocusPoint(){return this.building.sceneEntity.position2D}canGatherItem(){return this.building.sceneEntity.activity.activityKey===this.building.getDefaultActivity().activityKey}gatherItem(e){var t;this.building.entityType===M.POWER_STATION||this.building.entityType===M.ORE_REFINERY?((null===(t=this.building.sceneEntity.animation)||void 0===t?void 0:t.carryJoint)&&(this.building.sceneEntity.animation.carryJoint.add(e.sceneEntity.group),e.sceneEntity.position.set(0,0,0)),this.building.sceneEntity.changeActivity(Je.Deposit,(()=>{var t;this.building.sceneEntity.changeActivity(),(null===(t=this.building.sceneEntity.animation)||void 0===t?void 0:t.carryJoint)&&this.building.sceneEntity.animation.carryJoint.remove(e.sceneEntity.group),qe.addItemToStorage(e)}))):qe.addItemToStorage(e)}static addItemToStorage(e){switch(e.entityType){case M.CRYSTAL:o.numCrystal++;break;case M.ORE:o.numOre++}T.publishEvent(new ie),e.sceneEntity.removeFromScene()}getDropAction(){return this.building.getDropAction()}isInvalid(){return!this.building.isUsable()}}class je extends Ve{constructor(e,t,s=null){super(t,l.On),this.site=e,this.headingOnSite=s}gatherItem(e){e.sceneEntity.addToScene(this.targetLocation,this.headingOnSite),e.entityType===M.BARRIER&&e.sceneEntity.changeActivity(le.Expand,(()=>e.sceneEntity.changeActivity(le.Long))),this.site.addItem(e)}getDropAction(){return this.site.getDropAction()}isInvalid(){return this.site.complete||this.site.canceled}}class Ze{constructor(e,t,s){this.sceneEntity=null,this.positionAsPathTargets=[],this.sceneMgr=e,this.entityMgr=t,this.entityType=s}createCarryJob(){return new _e(this)}getPositionAsPathTargets(){const e=this.sceneEntity.position2D;return(this.positionAsPathTargets.length<1||!this.positionAsPathTargets[0].targetLocation.equals(e))&&(this.positionAsPathTargets=[new ce(e,l.On)]),this.positionAsPathTargets}removeFromScene(){this.sceneEntity.removeFromScene()}}class Ke extends Ze{constructor(e,t){super(e,t,M.CRYSTAL),this.sceneEntity=new He(e)}findCarryTargets(){const e=this.entityMgr.buildingSites.filter((e=>e.needs(this.entityType)));if(e.length>0)return e.map((e=>new je(e,e.getRandomDropPosition())));const t=this.entityMgr.getBuildingsByType(M.POWER_STATION);return t.length>0?t.map((e=>new qe(e))):this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((e=>new qe(e)))}get stats(){return bt.stats.PowerCrystal}getPriorityIdentifier(){return _.aiPriorityCrystal}}class Ye extends Ge{constructor(e,t){super(e),this.animationEntityType=null,this.animation=null,this.activity=null,this.animationEntityType=bt.getAnimationEntityType(t,this.sceneMgr.listener)}removeFromScene(){var e;super.removeFromScene(),null===(e=this.animation)||void 0===e||e.stop()}changeActivity(e=this.getDefaultActivity(),t=null,s=null){var i,r;if(this.activity===e||null===this.animationEntityType)return;this.activity=e;const n=e.activityKey.toLowerCase();let a=this.animationEntityType.animations.get(n);if(a||this.animationEntityType.animations.forEach(((e,t)=>{!a&&n.startsWith(t)&&(a=e)})),!a)return console.warn("Activity "+e.activityKey+" unknown or has no animation defined"),void console.log(this.animationEntityType.animations);this.animation&&(this.remove(this.animation.polyModel),this.animation.stop());const o=null===(r=null===(i=this.animation)||void 0===i?void 0:i.carryJoint)||void 0===r?void 0:r.children;o&&o.length>0&&a.carryJoint&&a.carryJoint.add(...o),this.animation=a,this.add(this.animation.polyModel),this.animation.start(t,s)}update(e){var t;null===(t=this.animation)||void 0===t||t.update(e)}}class ze extends Ye{constructor(e){super(e,"MiscAnims/Dynamite/Dynamite.ae"),this.changeActivity()}getDefaultActivity(){return Ne.Normal}}class Xe extends Ze{constructor(e,t,s){super(e,t,M.DYNAMITE),this.sceneEntity=new ze(e),this.targetSurface=s}findCarryTargets(){var e;return(null===(e=this.targetSurface)||void 0===e?void 0:e.isDigable())?this.targetSurface.getDigPositions().map((e=>new Ve(e))):this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((e=>e.getDropPosition2D())).map((e=>new Ve(e)))}createCarryJob(){return new Fe(this)}getPriorityIdentifier(){return _.aiPriorityDestruction}}class $e extends Ge{constructor(e){super(e),this.add(bt.getLwoModel("MiscAnims/Ore/Ore1st.lwo"))}}class Qe extends Ze{constructor(e,t){super(e,t,M.ORE),this.sceneEntity=new $e(e)}findCarryTargets(){const e=this.entityMgr.buildingSites.filter((e=>e.needs(this.entityType)));if(e.length>0)return e.map((e=>new je(e,e.getRandomDropPosition())));const t=this.entityMgr.getBuildingsByType(M.ORE_REFINERY);return t.length>0?t.map((e=>new qe(e))):this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((e=>new qe(e)))}get stats(){return bt.stats.Ore}getPriorityIdentifier(){return _.aiPriorityOre}}var et,tt,st=h.M8C.degToRad;class it{constructor(e,t,s,i,r){this.containedOres=0,this.containedCrystals=0,this.heightOffset=null,this.discovered=!1,this.selected=!1,this.reinforced=!1,this.drillJob=null,this.reinforceJob=null,this.dynamiteJob=null,this.clearRubbleJob=null,this.surfaceRotation=0,this.seamLevel=0,this.wallType=null,this.mesh=null,this.needsMeshUpdate=!1,this.topLeftVertex=null,this.topRightVertex=null,this.bottomRightVertex=null,this.bottomLeftVertex=null,this.topLeftHeightOffset=null,this.topRightHeightOffset=null,this.bottomRightHeightOffset=null,this.bottomLeftHeightOffset=null,this.rubblePositions=[],this.building=null,this.site=null,this.fence=null,this.hasPower=!1,this.terrain=e,this.sceneMgr=this.terrain.sceneMgr,this.entityMgr=this.terrain.entityMgr,this.surfaceType=t,t!==R.CRYSTAL_SEAM&&t!==R.ORE_SEAM||(this.seamLevel=4),this.x=s,this.y=i,this.heightOffset=r,t!==R.RUBBLE4&&t!==R.RUBBLE3&&t!==R.RUBBLE2&&t!==R.RUBBLE1||(this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()])}discover(){if(this.setDiscovered(),this.needsMeshUpdate=!0,!this.surfaceType.floor)return!1;const e=[],t=[];for(let s=-1;s<=1;s++)for(let i=-1;i<=1;i++){if(0===s&&0===i)continue;const r=this.terrain.getSurface(this.x+s,this.y+i);0!==s&&0!==i||!r.surfaceType.floor?t.push(r):e.push(r)}let s=!1,i=0;for(;e.length>0;){i++;const r=e.shift();r.setDiscovered();for(let i=-1;i<=1;i++)for(let n=-1;n<=1;n++){if(0===i&&0===n)continue;const a=r.terrain.getSurface(r.x+i,r.y+n);0!==i&&0!==n||!a.surfaceType.floor||a.discovered?t.push(a):(e.push(a),s=!0)}}return t.forEach((e=>{e.setDiscovered(),e.isSupported()||e.collapse()})),console.log("surface discover handled "+i+" floors and "+t.length+" others"),s}setDiscovered(){this.discovered||this.entityMgr.discoverSurface(this),this.discovered=!0,this.needsMeshUpdate=!0,T.publishEvent(new Z(this))}onDrillComplete(e){if(this.seamLevel>0){this.seamLevel--;const t=(new h.FM8).copy(e).sub(this.getCenterWorld2D()).multiplyScalar(.3+(0,a.sZ)(3)/10).rotateAround(new h.FM8(0,0),st(-10+(0,a.sZ)(20))).add(e);if(this.surfaceType===R.CRYSTAL_SEAM){const e=this.entityMgr.placeMaterial(new Ke(this.sceneMgr,this.entityMgr),t);T.publishEvent(new xe(e.sceneEntity.position.clone()))}else this.surfaceType===R.ORE_SEAM&&(this.entityMgr.placeMaterial(new Qe(this.sceneMgr,this.entityMgr),t),T.publishEvent(new ne))}return!(this.seamLevel>0||(this.collapse(),0))}collapse(){this.cancelJobs(),this.terrain.removeFallInOrigin(this),this.surfaceType=R.RUBBLE4,T.publishEvent(new Z(this)),this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=4,this.needsMeshUpdate=!0,this.discover()&&T.publishEvent(new re),this.dropContainedOre(this.containedOres-4);for(let e=0;e<this.containedCrystals;e++){const e=this.entityMgr.placeMaterial(new Ke(this.sceneMgr,this.entityMgr),this.getRandomPosition());T.publishEvent(new xe(e.sceneEntity.position.clone()))}for(let e=this.x-1;e<=this.x+1;e++)for(let t=this.y-1;t<=this.y+1;t++)if(e!==this.x||t!==this.y){const s=this.terrain.getSurface(e,t);s.needsMeshUpdate=!0,s.isSupported()||s.collapse()}this.terrain.updateSurfaceMeshes(),this.playPositionalSample(p.d.SFX_RockBreak)}dropContainedOre(e){for(let t=0;t<e&&this.containedOres>0;t++)this.containedOres--,this.entityMgr.placeMaterial(new Qe(this.sceneMgr,this.entityMgr),this.getRandomPosition()),T.publishEvent(new ne)}getRandomPosition(){return new h.FM8(this.x*l.pM+l.pM/2+(0,a.kz)()*(0,a.sZ)(l.pM/4),this.y*l.pM+l.pM/2+(0,a.kz)()*(0,a.sZ)(l.pM/4))}cancelJobs(){this.drillJob=it.safeRemoveJob(this.drillJob),this.reinforceJob=it.safeRemoveJob(this.reinforceJob),this.dynamiteJob=it.safeRemoveJob(this.dynamiteJob),this.clearRubbleJob=it.safeRemoveJob(this.clearRubbleJob),this.updateJobColor()}static safeRemoveJob(e){return e&&T.publishEvent(new te(e)),null}reduceRubble(){this.rubblePositions.shift(),this.surfaceType===R.RUBBLE4?this.surfaceType=R.RUBBLE3:this.surfaceType===R.RUBBLE3?this.surfaceType=R.RUBBLE2:this.surfaceType===R.RUBBLE2?this.surfaceType=R.RUBBLE1:this.surfaceType===R.RUBBLE1&&(this.surfaceType=R.GROUND),T.publishEvent(new Z(this)),this.dropContainedOre(this.containedOres-this.rubblePositions.length),this.updateTexture(),this.selected&&T.publishEvent(new U(this.entityMgr))}isSupported(){if(this.surfaceType.floor)return!0;const e=this.terrain.getSurface(this.x-1,this.y),t=this.terrain.getSurface(this.x-1,this.y-1),s=this.terrain.getSurface(this.x,this.y-1),i=this.terrain.getSurface(this.x+1,this.y-1),r=this.terrain.getSurface(this.x+1,this.y),n=this.terrain.getSurface(this.x+1,this.y+1),a=this.terrain.getSurface(this.x,this.y+1),o=this.terrain.getSurface(this.x-1,this.y+1);function l(e,t,s){return!(e.discovered&&t.discovered&&s.discovered&&(e.surfaceType.floor||t.surfaceType.floor||s.surfaceType.floor))}return l(e,t,s)||l(s,i,r)||l(r,n,a)||l(a,o,e)}updateMesh(e=!0){if(!e&&!this.needsMeshUpdate)return;this.needsMeshUpdate=!1;const t=this.terrain.getSurface(this.x-1,this.y),s=this.terrain.getSurface(this.x-1,this.y-1),i=this.terrain.getSurface(this.x,this.y-1),r=this.terrain.getSurface(this.x+1,this.y-1),n=this.terrain.getSurface(this.x+1,this.y),a=this.terrain.getSurface(this.x+1,this.y+1),o=this.terrain.getSurface(this.x,this.y+1),c=this.terrain.getSurface(this.x-1,this.y+1);function u(e,t,s,i){return!(e.discovered&&(e.surfaceType.floor&&e.neighbors.some((e=>e.surfaceType.floor&&e.discovered))||t.discovered&&s.discovered&&i.discovered&&(t.surfaceType.floor||s.surfaceType.floor||i.surfaceType.floor)))}const d=new h.Pa4(this.x,0,this.y),g=new h.Pa4(this.x+1,0,this.y),p=new h.Pa4(this.x,0,this.y+1),y=new h.Pa4(this.x+1,0,this.y+1);u(this,t,s,i)&&(d.y=1),u(this,i,r,n)&&(g.y=1),u(this,n,a,o)&&(y.y=1),u(this,o,c,t)&&(p.y=1);let m=d.y+g.y+y.y+p.y;if(m===ye.WALL&&d.y===y.y&&(m=ye.WEIRD_CREVICE),this.wallType!==m){function f(...e){return e.map((e=>e.heightOffset)).reduce(((e,t)=>(e||0)+(t||0)),0)/(e.length||1)}this.wallType=m,this.topLeftVertex=d.clone(),this.topRightVertex=g.clone(),this.bottomRightVertex=y.clone(),this.bottomLeftVertex=p.clone(),this.topLeftHeightOffset=f(s,i,this,t)*l.w$,this.topRightHeightOffset=f(i,r,n,this)*l.w$,this.bottomRightHeightOffset=f(this,n,a,o)*l.w$,this.bottomLeftHeightOffset=f(t,this,o,c)*l.w$,this.topLeftVertex.y+=this.topLeftHeightOffset,this.topRightVertex.y+=this.topRightHeightOffset,this.bottomRightVertex.y+=this.bottomRightHeightOffset,this.bottomLeftVertex.y+=this.bottomLeftHeightOffset,this.updateGeometry(d,g,y,p),this.wallType!==ye.WALL&&this.cancelReinforceJobs()}this.updateTexture(),this.updateJobColor(),this.updatePathfinding()}updatePathfinding(){const e=this.getPathfindingWalkWeight();for(let t=0;t<3;t++)for(let s=0;s<3;s++)this.terrain.graphWalk.grid[3*this.x+t][3*this.y+s].weight=e;this.terrain.graphDrive.grid[this.x][this.y].weight=this.getPathfindingDriveWeight(),this.terrain.graphFly.grid[this.x][this.y].weight=this.getPathFindingFlyWeight(),this.terrain.graphSwim.grid[this.x][this.y].weight=this.getPathFindingSwimWeight()}cancelReinforceJobs(){this.reinforceJob=it.safeRemoveJob(this.reinforceJob),this.updateJobColor()}updateTexture(){let e=this.terrain.textureSet.texturebasename;this.discovered?this.surfaceType===R.POWER_PATH?e+=this.updatePowerPathTexture():!this.surfaceType.shaping&&this.neighbors.some((e=>e.discovered&&e.surfaceType.floor))?this.surfaceType===R.POWER_PATH_BUILDING&&this.hasPower?e+="66":e+=this.surfaceType.matIndex.toString():this.wallType===ye.WEIRD_CREVICE?e+="77":(this.wallType===ye.CORNER?e+="5":this.wallType===ye.INVERTED_CORNER?e+="3":this.reinforced?e+="2":e+="0",e+=this.surfaceType.shaping?this.surfaceType.matIndex:R.SOLID_ROCK.matIndex):e+="70",e+=".bmp",this.forEachMaterial((e=>{var t;return null===(t=e.map)||void 0===t?void 0:t.dispose()}));const t=bt.getTexture(e);t.center.set(.5,.5),t.rotation=this.surfaceRotation,this.forEachMaterial((e=>e.map=t))}updatePowerPathTexture(){this.surfaceRotation=0;const e=this.terrain.getSurface(this.x-1,this.y).isPath(),t=this.terrain.getSurface(this.x,this.y-1).isPath(),s=this.terrain.getSurface(this.x+1,this.y).isPath(),i=this.terrain.getSurface(this.x,this.y+1).isPath(),r=(e?1:0)+(t?1:0)+(s?1:0)+(i?1:0);return 0===r||1===r?(e&&(this.surfaceRotation=-Math.PI/2),t&&(this.surfaceRotation=Math.PI),s&&(this.surfaceRotation=Math.PI/2),this.hasPower?"75":"65"):2===r?e===s?(this.surfaceRotation=e?Math.PI/2:0,this.hasPower?"72":"62"):(e&&i&&(this.surfaceRotation=-Math.PI/2),e&&t&&(this.surfaceRotation=Math.PI),t&&s&&(this.surfaceRotation=Math.PI/2),this.hasPower?"73":"63"):3===r?(t||(this.surfaceRotation=-Math.PI/2),s||(this.surfaceRotation=Math.PI),i||(this.surfaceRotation=Math.PI/2),this.hasPower?"74":"64"):this.hasPower?"71":"60"}forEachMaterial(e){var t;(null===(t=this.mesh)||void 0===t?void 0:t.material)&&(Array.isArray(this.mesh.material)?this.mesh.material:[this.mesh.material]).forEach((t=>e(t)))}updateGeometry(e,t,s,i){var r,n;this.mesh&&this.terrain.floorGroup.remove(this.mesh),null===(n=null===(r=this.mesh)||void 0===r?void 0:r.geometry)||void 0===n||n.dispose(),this.forEachMaterial((e=>e.dispose()));const a=fe.create(this.wallType,e,t,s,i,this.topLeftVertex.y,this.topRightVertex.y,this.bottomRightVertex.y,this.bottomLeftVertex.y);this.mesh=new h.Kj0(a,new h.xoR({shininess:0})),this.mesh.userData={selectable:this,surface:this},this.terrain.floorGroup.add(this.mesh)}isSelectable(){return this.surfaceType.selectable&&this.wallType!==ye.INVERTED_CORNER&&this.wallType!==ye.WEIRD_CREVICE&&!this.selected&&this.discovered}isInSelection(){return this.isSelectable()||this.selected}select(){return!!this.isSelectable()&&(this.selected=!0,this.forEachMaterial((e=>e.color.setHex(6316192))),this.surfaceType.floor&&u.P.playSample(p.d.SFX_Floor),this.surfaceType.shaping&&u.P.playSample(p.d.SFX_Wall),console.log("Surface selected at "+this.x+"/"+this.y),!0)}deselect(){this.selected&&(this.selected=!1,this.updateJobColor())}updateJobColor(){var e,t,s;const i=(null===(e=this.dynamiteJob)||void 0===e?void 0:e.color)||(null===(t=this.reinforceJob)||void 0===t?void 0:t.color)||(null===(s=this.drillJob)||void 0===s?void 0:s.color)||16777215;this.forEachMaterial((e=>e.color.setHex(i)))}hasRubble(){return this.rubblePositions.length>0}isPath(){return this.surfaceType===R.POWER_PATH||this.surfaceType===R.POWER_PATH_BUILDING}isWalkable(){var e;return this.surfaceType.floor&&this.discovered&&this.surfaceType!==R.LAVA&&this.surfaceType!==R.WATER&&!(null===(e=this.building)||void 0===e?void 0:e.blocksPathSurface)}isDigable(){return this.surfaceType.digable&&this.discovered&&(this.wallType===ye.WALL||this.wallType===ye.CORNER)}isReinforcable(){return this.surfaceType.reinforcable&&this.discovered&&this.wallType===ye.WALL&&!this.reinforced}getDigPositions(){const e=[];return this.terrain.getSurface(this.x-1,this.y).isWalkable()&&e.push(new h.FM8(this.x*l.pM-1,this.y*l.pM+l.pM/2)),this.terrain.getSurface(this.x,this.y-1).isWalkable()&&e.push(new h.FM8(this.x*l.pM+l.pM/2,this.y*l.pM-1)),this.terrain.getSurface(this.x+1,this.y).isWalkable()&&e.push(new h.FM8(this.x*l.pM+l.pM+1,this.y*l.pM+l.pM/2)),this.terrain.getSurface(this.x,this.y+1).isWalkable()&&e.push(new h.FM8(this.x*l.pM+l.pM/2,this.y*l.pM+l.pM+1)),e}reinforce(){this.reinforced=!0,this.cancelReinforceJobs(),this.terrain.removeFallInOrigin(this),this.updateTexture(),T.publishEvent(new Z(this))}getCenterWorld2D(){return new h.FM8(this.x,this.y).addScalar(.5).multiplyScalar(l.pM)}getCenterWorld(){var e,t;const s=this.getCenterWorld2D(),i=new h.iMs(new h.Pa4(s.x,3*l.pM,s.y),new h.Pa4(0,-1,0)).intersectObject(this.mesh,!0);i.length<1&&console.warn("could not determine terrain height for "+s.x+"/"+s.y);const r=(null===(t=null===(e=i[0])||void 0===e?void 0:e.point)||void 0===t?void 0:t.y)||0;return new h.Pa4(s.x,r,s.y)}dispose(){var e,t;this.forEachMaterial((e=>e.dispose())),null===(t=null===(e=this.mesh)||void 0===e?void 0:e.geometry)||void 0===t||t.dispose()}getFloorHeight(e,t){const s=e/l.pM-this.x,i=t/l.pM-this.y,r=it.interpolate(this.topLeftHeightOffset,this.topRightHeightOffset,s),n=it.interpolate(this.bottomLeftHeightOffset,this.bottomRightHeightOffset,s);return it.interpolate(r,n,i)*l.pM}static interpolate(e,t,s){return e+s*(t-e)}get neighbors(){return[this.terrain.getSurface(this.x-1,this.y),this.terrain.getSurface(this.x,this.y-1),this.terrain.getSurface(this.x+1,this.y),this.terrain.getSurface(this.x,this.y+1)]}makeRubble(e=0){this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=e,this.setSurfaceType(R.RUBBLE4)}setBuilding(e){this.building=e,this.updatePathfinding(),this.setSurfaceType(this.building?R.POWER_PATH_BUILDING:R.GROUND)}setSurfaceType(e){if(e===this.surfaceType)return;const t=this.surfaceType;this.surfaceType=e,this.updateTexture(),(t.connectsPath||this.surfaceType.connectsPath)&&this.neighbors.forEach((e=>e.updateTexture())),T.publishEvent(new Z(this))}getPathfindingWalkWeight(){return this.isWalkable()?this.hasRubble()?4:1:0}getPathfindingDriveWeight(){return this.isWalkable()?1:0}getPathFindingFlyWeight(){var e;return this.surfaceType.floor&&!(null===(e=this.building)||void 0===e?void 0:e.blocksPathSurface)?1:0}getPathFindingSwimWeight(){return this.surfaceType===R.WATER?1:0}setHasPower(e,t){this.hasPower!==e&&(this.hasPower=e,this.updateTexture(),t&&this.neighbors.forEach((s=>s.isPath()&&s.setHasPower(e,t))))}canPlaceFence(){return this.surfaceType.canCarryFence&&!this.building&&!this.fence&&[1,2].some((e=>!!(this.terrain.getSurface(this.x-e,this.y).building||this.terrain.getSurface(this.x,this.y-e).building||this.terrain.getSurface(this.x+e,this.y).building||this.terrain.getSurface(this.x,this.y+e).building||this.terrain.getSurface(this.x-e,this.y).fence||this.terrain.getSurface(this.x,this.y-e).fence||this.terrain.getSurface(this.x+e,this.y).fence||this.terrain.getSurface(this.x,this.y+e).fence)))}createDrillJob(){return this.isDigable()?(this.drillJob||(this.drillJob=new Ue(this),this.updateJobColor(),T.publishEvent(new ee(this.drillJob))),this.drillJob):null}createReinforceJob(){return this.isReinforcable()?(this.reinforceJob||(this.reinforceJob=new We(this),this.updateJobColor(),T.publishEvent(new ee(this.reinforceJob))),this.reinforceJob):null}createDynamiteJob(){if(!this.isDigable())return null;if(!this.dynamiteJob){const e=this.entityMgr.getClosestBuildingByType(this.getCenterWorld(),M.TOOLSTATION);if(!e)throw"Could not find toolstation to spawn dynamite";const t=new Xe(this.sceneMgr,this.entityMgr,this);t.sceneEntity.addToScene(e.getDropPosition2D(),e.sceneEntity.getHeading()),this.dynamiteJob=new Fe(t),this.updateJobColor(),T.publishEvent(new ee(this.dynamiteJob))}return this.dynamiteJob}createClearRubbleJob(){return this.hasRubble()?(this.clearRubbleJob||(this.clearRubbleJob=new Be(this),this.updateJobColor(),T.publishEvent(new ee(this.clearRubbleJob))),this.clearRubbleJob):null}setSite(e){this.site=e,this.setSurfaceType(this.site?R.POWER_PATH_CONSTRUCTION:R.GROUND)}playPositionalSample(e){const t=new h.VYz(this.sceneMgr.listener);return t.setRefDistance(6*l.pM),this.mesh.add(t),u.P.getSoundBuffer(p.d[e]).then((e=>{t.setBuffer(e),t.play()})),t}}class rt extends h.ZAu{constructor(e,t){super();const s=bt.getResource(e);this.animation=new ct((0,a.DW)(e),!1).parse(s),this.animation.bodies.forEach((e=>{const s=e.model.clone();if(this.animation.polyList.push(s),e.lowerName&&e.isNull&&this.animation.nullJoints.getOrUpdate(e.lowerName.toLowerCase(),(()=>[])).push(s),e.sfxName){const i=new h.VYz(t);i.setRefDistance(6*l.pM),i.loop=!1,s.add(i),u.P.getSoundBuffer(e.sfxName).then((e=>i.setBuffer(e))),e.sfxFrames.forEach((e=>this.animation.sfxAudioByFrame.getOrUpdate(e,(()=>[])).push(i)))}})),this.animation.bodies.forEach(((e,t)=>{const s=this.animation.polyList[t],i=e.parentObjInd;null!=i?this.animation.polyList[i].add(s):this.animation.polyModel.add(s)})),this.add(this.animation.polyModel)}startAnimation(e){this.animation.start(e,null)}update(e){this.animation.update(e)}}class nt{constructor(e,t,s){this.timer=0,this.terrain=e,this.source=t,this.target=s,this.restartTimeout()}update(e){this.timer+=e,this.timer<this.fallinTimeout||(this.terrain.createFallIn(this.source,this.target),this.timer-=this.fallinTimeout,this.restartTimeout())}restartTimeout(){this.fallinTimeout=1e3*(30+(0,a.sZ)(60))}}class at{constructor(e,t){this.target=null,this.locations=[],this.lengthSq=0,this.target=e,this.locations=Array.isArray(t)?t:[t];for(let e=0;e<this.locations.length-1;e++){const t=this.locations[e],s=this.locations[e+1];this.lengthSq+=t.distanceToSquared(s)}}get firstLocation(){return this.locations[0]||null}}class ot{constructor(e,t){this.textureSet={},this.width=0,this.height=0,this.surfaces=[],this.floorGroup=new h.ZAu,this.roofGroup=new h.ZAu,this.graphWalk=null,this.graphDrive=null,this.graphFly=null,this.graphSwim=null,this.cachedWalkPaths=new Map,this.cachedDrivePaths=new Map,this.cachedFlyPaths=new Map,this.cachedSwimPaths=new Map,this.fallIns=[],this.fallInGroups=[],this.sceneMgr=e,this.entityMgr=t,this.floorGroup.scale.setScalar(l.pM),this.roofGroup.scale.setScalar(l.pM),this.roofGroup.visible=!1,l.Sl&&this.floorGroup.add(new h.y8_)}getSurfaceFromWorld(e){return this.getSurfaceFromWorldXZ(e.x,e.z)}getSurfaceFromWorld2D(e){return this.getSurfaceFromWorldXZ(e.x,e.y)}getSurfaceFromWorldXZ(e,t){return this.getSurface(e/l.pM,t/l.pM)}getSurface(e,t){return e=Math.floor(e),t=Math.floor(t),this.getSurfaceOrNull(e,t)||new it(this,R.SOLID_ROCK,e,t,0)}getSurfaceOrNull(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height?this.surfaces[e][t]:null}updateSurfaceMeshes(e=!1){this.forEachSurface((t=>t.updateMesh(e))),this.floorGroup.updateWorldMatrix(!0,!0),this.resetGraphWalk()}resetGraphWalk(){this.graphWalk.init(),this.graphDrive.init(),this.graphFly.init(),this.graphSwim.init(),this.cachedWalkPaths.clear(),this.cachedDrivePaths.clear(),this.cachedFlyPaths.clear(),this.cachedSwimPaths.clear(),console.log("Cached paths cleared")}findWalkPath(e,t){return ot.findPath(e,t,this.cachedWalkPaths,this.graphWalk,l.pM/3,.25)}findDrivePath(e,t){return ot.findPath(e,t,this.cachedDrivePaths,this.graphDrive,l.pM,0)}findFlyPath(e,t){return ot.findPath(e,t,this.cachedFlyPaths,this.graphFly,l.pM,0)}findSwimPath(e,t){return ot.findPath(e,t,this.cachedSwimPaths,this.graphSwim,l.pM,0)}static findPath(e,t,s,i,r,n){const a=e.clone().divideScalar(r).floor(),o=t.targetLocation.clone().divideScalar(r).floor();if(a.x===o.x&&a.y===o.y)return new at(t,t.targetLocation);const l=a.x+"/"+a.y+" -> "+o.x+"/"+o.y,c=s.getOrUpdate(l,(()=>{const e=i.grid[a.x][a.y],t=i.grid[o.x][o.y],s=Ae.search(i,e,t).map((e=>new h.FM8(e.x+.5,e.y+.5).add((new h.FM8).random().multiplyScalar(n)).multiplyScalar(r)));return s.length<1?null:(s.pop(),s)}));return c?new at(t,[...c,t.targetLocation]):null}dispose(){this.forEachSurface((e=>e.dispose()))}forEachSurface(e){var t;null===(t=this.surfaces)||void 0===t||t.forEach((t=>t.forEach((t=>e(t)))))}countDiggables(){let e=0;return this.forEachSurface((t=>e+=t.isDigable()?1:0)),e}countCrystals(){let e=0;return this.forEachSurface((t=>e+=t.containedCrystals)),e}countOres(){let e=0;return this.forEachSurface((t=>e+=t.containedOres)),e}setFallinLevel(e,t,s){if(s<1)return;const i=this.getSurface(e,t);let r=null,n=null;i.surfaceType.floor?(r=this.findFallInOrigin(i),n=i):i.isReinforcable()&&(r=i,n=this.findFallInTarget(i)),r&&n&&this.fallIns.push(new nt(this,r,n))}findFallInOrigin(e){return e.neighbors.find((e=>e.isReinforcable()))||null}findFallInTarget(e){return e.neighbors.find((e=>e.isWalkable()))||null}createFallIn(e,t){const s=t.getCenterWorld();T.publishEvent(new Oe(s));const i=new rt("MiscAnims/RockFall/Rock3Sides.lws",this.sceneMgr.listener);this.fallInGroups.push(i),i.position.copy(s);const r=e.x-t.x,n=t.y-e.y;i.rotateOnAxis(new h.Pa4(0,1,0),Math.atan2(n,r)+Math.PI/2),this.sceneMgr.scene.add(i),i.startAnimation((()=>{this.sceneMgr.scene.remove(i),this.fallInGroups.remove(i)})),t.makeRubble()}removeFallInOrigin(e){this.fallIns=this.fallIns.filter((t=>t.source!==e))}update(e){this.fallIns.forEach((t=>y(t,e))),this.fallInGroups.forEach((t=>y(t,e)))}}!function(e){e[e.NONE=0]="NONE",e[e.RUBBLE=1]="RUBBLE",e[e.POWER_PATH=2]="POWER_PATH"}(et||(et={})),function(e){e[e.WALL=0]="WALL",e[e.CAVERN_EXPOSED=1]="CAVERN_EXPOSED",e[e.CAVERN_HIDDEN=2]="CAVERN_HIDDEN",e[e.SLUG_HOLE_EXPOSED=3]="SLUG_HOLE_EXPOSED",e[e.SLUG_HOLE_HIDDEN=4]="SLUG_HOLE_HIDDEN"}(tt||(tt={}));class lt{constructor(e){this.maxFps=30,this.debugHelper=new b,this.renderer=new h.CP7({antialias:!0,canvas:e}),this.renderer.setClearColor(0),this.listener=new h.SJI,this.camera=new h.cPb(30,e.width/e.height,.1,5e3),this.camera.add(this.listener),this.controls=new E.o(this.camera,this.renderer.domElement),this.controls.mouseButtons={LEFT:null,MIDDLE:h.RsA.ROTATE,RIGHT:h.RsA.PAN},this.controls.listenToKeyEvents(this.renderer.domElement),this.controls.keyPanSpeed=this.controls.keyPanSpeed*l.m8}getSelectionByRay(e,t){const s=new h.iMs;s.setFromCamera({x:e,y:t},this.camera);const i=new Te;return i.raiders.push(...lt.getSelection(s.intersectObjects(this.entityMgr.raiders.map((e=>e.sceneEntity.pickSphere))))),i.isEmpty()&&i.vehicles.push(...lt.getSelection(s.intersectObjects(this.entityMgr.vehicles.map((e=>e.sceneEntity.pickSphere))))),i.isEmpty()&&(i.building=lt.getSelection(s.intersectObjects(this.entityMgr.buildings.map((e=>e.sceneEntity.pickSphere))))[0]),i.isEmpty()&&this.terrain&&(i.surface=lt.getSelection(s.intersectObjects(this.terrain.floorGroup.children))[0]),i}static getSelection(e){if(e.length<1)return[];const t=[],s=e[0].object.userData;if(s&&s.hasOwnProperty("selectable")){const e=s.selectable;(null==e?void 0:e.isInSelection())&&t.push(e)}return t}getFirstByRay(e,t){const s=new h.iMs;s.setFromCamera({x:e,y:t},this.camera);const i=lt.getEntity(s.intersectObjects(this.entityMgr.vehicles.map((e=>e.sceneEntity.pickSphere))));if(i)return{vehicle:i};if(this.terrain){const e=lt.getEntity(s.intersectObjects(this.terrain.floorGroup.children));if(e)return{surface:e}}return null}static getEntity(e){var t,s,i;return(null===(i=null===(s=null===(t=e[0])||void 0===t?void 0:t.object)||void 0===s?void 0:s.userData)||void 0===i?void 0:i.selectable)||null}getEntitiesInFrustum(e,t,s,i){const r=new h.Pa4(e,t,.5),n=new h.Pa4(s,i,.5);r.x===n.x&&(n.x+=Number.EPSILON),r.y===n.y&&(n.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld();const a=new h.Pa4;a.copy(r),a.x=Math.min(r.x,n.x),a.y=Math.max(r.y,n.y),n.x=Math.max(r.x,n.x),n.y=Math.min(r.y,n.y);const o=new h.Pa4,l=new h.Pa4,c=new h.Pa4,u=new h.Pa4,d=new h.Pa4;o.setFromMatrixPosition(this.camera.matrixWorld),l.copy(a),c.set(n.x,a.y,0),u.copy(n),d.set(a.x,n.y,0),l.unproject(this.camera),c.unproject(this.camera),u.unproject(this.camera),d.unproject(this.camera);const g=new h.Pa4,p=new h.Pa4,y=new h.Pa4;g.copy(l).sub(o),p.copy(c).sub(o),y.copy(u).sub(o),g.normalize(),p.normalize(),y.normalize();const m=Number.MAX_VALUE;g.multiplyScalar(m),p.multiplyScalar(m),y.multiplyScalar(m),g.add(o),p.add(o),y.add(o);const f=new h.iWj,v=f.planes;v[0].setFromCoplanarPoints(o,l,c),v[1].setFromCoplanarPoints(o,c,u),v[2].setFromCoplanarPoints(u,d,o),v[3].setFromCoplanarPoints(d,l,o),v[4].setFromCoplanarPoints(c,u,d),v[5].setFromCoplanarPoints(y,p,g),v[5].normal.multiplyScalar(-1);const E=new Te;return E.raiders.push(...this.entityMgr.raiders.filter((e=>e.isInSelection()&&lt.isInFrustum(e.sceneEntity.pickSphere,f)))),E.vehicles.push(...this.entityMgr.vehicles.filter((e=>e.isInSelection()&&lt.isInFrustum(e.sceneEntity.pickSphere,f)))),E.isEmpty()&&(E.building=this.entityMgr.buildings.find((e=>lt.isInFrustum(e.sceneEntity.pickSphere,f)))),E}static isInFrustum(e,t){if(!e)return!1;const s=new h.Pa4;return e.getWorldPosition(s),t.containsPoint(s)}setupScene(e){this.scene=new h.xsS;const t=bt.cfg("Main","AmbientRGB")||[10,10,10],s=Math.min(255,Math.max(0,...t)),i=t.map((e=>e/(s||1))),r=new h.Ilk(i[0],i[1],i[2]);this.ambientLight=new h.Mig(r,.4),this.scene.add(this.ambientLight),this.cursorTorchlight=new h.cek(16777215,1.5,4,1),this.cursorTorchlight.distance*=l.pM,this.scene.add(this.cursorTorchlight),this.buildMarker=new Ee(this.worldMgr,this,this.entityMgr),this.scene.add(this.buildMarker.group),this.setBuildModeSelection(null),this.terrain=class{static loadTerrain(e,t,s){var i,r,n,a,o,h,c;const u=e.blockSize;u!==l.pM&&console.error("Unexpected tile size in level configuration: "+u);const d=new ot(t,s),g=e.textureSet[1];d.textureSet=bt.cfg("Textures",g);const p=bt.getResource(e.terrainMap);d.width=p.width,d.height=p.height;const y=null===(i=bt.getResource(e.pathMap))||void 0===i?void 0:i.level,m=null===(r=bt.getResource(e.surfaceMap))||void 0===r?void 0:r.level,f=null===(n=bt.getResource(e.predugMap))||void 0===n?void 0:n.level,v=null===(a=bt.getResource(e.cryOreMap))||void 0===a?void 0:a.level,E=null===(o=bt.getResource(e.fallinMap))||void 0===o?void 0:o.level,w=null===(h=bt.getResource(e.erodeMap))||void 0===h?void 0:h.level;null===(c=bt.getResource(e.blockPointersMap))||void 0===c||c.level;for(let e=0;e<p.level.length;e++)for(let t=0;t<p.level[e].length;t++){d.surfaces[t]=d.surfaces[t]||[];const s=p.level[e][t];let i=R.getByNum(s);const r=f[e][t];r===tt.CAVERN_EXPOSED?i===R.GROUND||i===R.DIRT||i===R.POWER_PATH_BUILDING?i=R.GROUND:i!==R.WATER&&i!==R.LAVA&&console.warn("Unexpected cavern surface type: "+i.name):r===tt.SLUG_HOLE_EXPOSED||r===tt.SLUG_HOLE_HIDDEN?i=R.SLUG_HOLE:r!==tt.WALL&&r!==tt.CAVERN_HIDDEN&&console.warn("Unexpected predug level: "+r);const n=y&&i.floor?y[e][t]:et.NONE;n===et.RUBBLE?i=R.RUBBLE4:n===et.POWER_PATH?i=R.POWER_PATH:n!==et.NONE&&console.warn("Unexpected path map level: "+n);const a=new it(d,i,t,e,m[e][t]);if(v){const s=v[e][t];s%2==1?a.containedCrystals=(s+1)/2:a.containedOres=s/2}d.surfaces[t].push(a)}d.forEachSurface((e=>{if(f[e.y][e.x]===tt.CAVERN_EXPOSED||f[e.y][e.x]===tt.SLUG_HOLE_EXPOSED)for(let t=e.x-1;t<=e.x+1;t++)for(let s=e.y-1;s<=e.y+1;s++)d.getSurfaceOrNull(t,s).discovered=!0})),d.forEachSurface((e=>{const t=d.getSurfaceOrNull(e.x,e.y);f[e.y][e.x]!==tt.CAVERN_HIDDEN||t.discovered||(t.surfaceType=R.GROUND)}));const b=[],M=[],S=[],T=[];for(let e=0;e<d.width;e++){const t=[],s=[],i=[],r=[];for(let n=0;n<d.height;n++){const a=d.getSurfaceOrNull(e,n),o=a.getPathfindingWalkWeight();t.push(o,o,o),s.push(a.getPathfindingDriveWeight()),i.push(a.getPathFindingFlyWeight()),r.push(a.getPathFindingSwimWeight())}b.push(t,t,t),M.push(s),S.push(i),T.push(r)}if(d.graphWalk=new Re(b,{diagonal:!0}),d.graphDrive=new Re(M,{diagonal:!0}),d.graphFly=new Re(S,{diagonal:!0}),d.graphSwim=new Re(T,{diagonal:!0}),d.forEachSurface((e=>{e.isSupported()||e.collapse()})),d.updateSurfaceMeshes(!0),E)for(let e=0;e<d.width;e++)for(let t=0;t<d.height;t++)d.setFallinLevel(e,t,E[t][e]);return w&&console.warn("Lucky you! Lava erosion not yet implemented"),d}}.loadTerrain(e,this,this.entityMgr),this.scene.add(this.terrain.floorGroup),o.totalDiggables=this.terrain.countDiggables(),o.totalCrystals=this.terrain.countCrystals(),o.totalOres=this.terrain.countOres()}startScene(){this.debugHelper.show(),this.renderInterval=setInterval((()=>{this.animRequest=requestAnimationFrame((()=>{this.debugHelper.renderStart(),this.renderer.render(this.scene,this.camera),this.debugHelper.renderDone()}))}),1e3/this.maxFps)}disposeScene(){var e,t;this.debugHelper.hide(),this.renderInterval=(0,a.nJ)(this.renderInterval),this.animRequest&&(cancelAnimationFrame(this.animRequest),this.animRequest=null),o.remainingDiggables=(null===(e=this.terrain)||void 0===e?void 0:e.countDiggables())||0,null===(t=this.terrain)||void 0===t||t.dispose(),this.terrain=null,lt.meshRegistry.forEach((e=>e.dispose())),lt.meshRegistry=[]}static registerMesh(e){return this.meshRegistry.push(e),e}resize(e,t){this.renderer.setSize(e,t)}getTerrainIntersectionPoint(e,t){if(!this.terrain)return null;const s=new h.iMs;s.setFromCamera({x:e,y:t},this.camera);const i=s.intersectObjects(this.terrain.floorGroup.children);return i.length>0?new h.FM8(i[0].point.x,i[0].point.z):null}setTorchPosition(e){this.cursorTorchlight.position.copy(this.getFloorPosition(e)),this.cursorTorchlight.position.y+=2*l.pM}getFloorPosition(e){const t=this.terrain.getSurfaceFromWorldXZ(e.x,e.y).getFloorHeight(e.x,e.y);return new h.Pa4(e.x,t,e.y)}hasBuildModeSelection(){var e;return!!(null===(e=this.buildMarker)||void 0===e?void 0:e.buildModeSelection)}setBuildModeSelection(e){var t;null===(t=this.buildMarker.buildModeSelection)||void 0===t||t.removeFromScene(),this.buildMarker.buildModeSelection=e,e||this.buildMarker.hideAllMarker()}}lt.meshRegistry=[];class ht extends h.Kj0{constructor(e,t){super(e,t),lt.registerMesh(this)}clone(){const e=super.clone(!0);return e.material=this.getMaterials().map((e=>e.clone())),e}dispose(){var e;null===(e=this.geometry)||void 0===e||e.dispose(),this.getMaterials().forEach((e=>e.dispose())),this.material=null}getMaterials(){const e=this.material;return e?Array.isArray(e)?e:[e]:[]}update(e){this.getMaterials().forEach((t=>"MeshPhongMaterial"===t.type&&t.update(e)))}}class ct{constructor(e,t=!1){this.path="",this.verbose=!1,this.animationClip=new m,this.lines=[],this.lineIndex=0,this.path=e,this.verbose=t,this.verbose&&console.log("Using verbose mode")}parse(e){if(!e)throw"Cannot parse LWS, no content given";if(this.lines=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((e=>e.trim())),"LWSC"!==this.lines[0])throw"Invalid start of file! Expected 'LWSC' in first line";const t=parseInt(this.lines[1],10);for(1!==t&&console.warn("Unexpected scene file version: "+t),this.lineIndex=2;this.lineIndex<this.lines.length;this.lineIndex++){let e=this.lines[this.lineIndex];if(!e)continue;const t=e.split(" ")[0];if("FirstFrame"===t)this.parseFrameBlock();else if("AddNullObject"===t||"LoadObject"===t){const e=this.parseObjectBlock();this.verbose&&console.log(e)}else e.startsWith("PreviewFirstFrame ")||e.startsWith("PreviewLastFrame ")||e.startsWith("PreviewFrameStep ")}return this.verbose&&console.log(this.animationClip),this.animationClip}parseLine(e){const t=e.split(" ").filter((e=>""!==e));return[t.shift(),t.join(" ")]}parseFrameBlock(){for(;this.lineIndex<this.lines.length;this.lineIndex++){const e=this.lines[this.lineIndex];if(!e)return;const[t,s]=this.parseLine(e);if("FirstFrame"===t)this.animationClip.firstFrame=parseInt(s);else if("LastFrame"===t)this.animationClip.lastFrame=parseInt(s);else if("FrameStep"===t){const e=parseInt(s);1!==e&&console.error("Animation frameStep has unexpected value: "+e)}else"FramesPerSecond"===t?this.animationClip.framesPerSecond=parseInt(s):"PreviewFirstFrame"===t||"PreviewLastFrame"===t||"PreviewFrameStep"===t||console.warn("Unexpected key in frame block")}console.error("Parsing block reached content end")}parseObjectBlock(){const e=new v;for(this.animationClip.bodies.push(e);this.lineIndex<this.lines.length;this.lineIndex++){let t=this.lines[this.lineIndex];if(!t)return e;const[s,i]=this.parseLine(t);if("AddNullObject"===s||"LoadObject"===s)if("LoadObject"===s){const t=(0,a.vt)(i);e.lowerName=t.slice(0,t.length-".lwo".length).toLowerCase(),e.filename=this.path+t,e.model=bt.getLwoModel(e.filename)}else{if("AddNullObject"!==s)throw"Unexpected line: "+t;{const t=i.split(",");e.lowerName=t[0].toLowerCase(),"sfx"===e.lowerName?(e.sfxName=t[1]||null,e.sfxFrames=t.slice(2).map((e=>Number(e)))):"snd"===e.lowerName&&t[1].equalsIgnoreCase("SFX_LANDSLIDE")&&(e.sfxName=p.d[p.d.SFX_FallIn],e.sfxFrames=t.slice(2).map((e=>Number(e)))),e.model=new ht,e.isNull=!0}}else if("ObjectMotion"===s){let t=this.lines[++this.lineIndex];const s=parseInt(t);t=this.lines[++this.lineIndex];const i=parseInt(t);this.lineIndex++;for(let t=0;t<i;t++){let i=this.lines[this.lineIndex+2*t];if(i.startsWith("EndBehavior"))break;const r=i.split(" ").map(Number);r.length!==s&&console.warn("Number of infos ("+r.length+") does not match if specified count ("+s+")"),i=this.lines[this.lineIndex+2*t+1];const n=parseInt(i.split(" ")[0]);e.setFrameAndFollowing(n,this.animationClip.lastFrame,r)}this.lineIndex+=2*i}else if("ParentObject"===s)e.parentObjInd=Number(i)-1,this.verbose&&console.log("parent obj ind is: "+e.parentObjInd);else if("ShowObject"===s||"LockedChannels"===s);else if("ShadowOptions"===s);else if("ObjDissolve"===s)if("(envelope)"==i){let t=this.lines[++this.lineIndex];const s=parseInt(t);1!==s&&console.error("Number of information channels for opacity is not 1, but: "+s),t=this.lines[++this.lineIndex];const i=parseInt(t);this.lineIndex++;for(let t=0;t<i;t++){let s=this.lines[this.lineIndex+2*t];if(s.startsWith("EndBehavior"))break;const i=1-Number(s);s=this.lines[this.lineIndex+2*t+1];const r=Number(s.split(" ")[0]);e.setOpacityAndFollowing(r,this.animationClip.lastFrame,i)}this.lineIndex+=2*i}else{const t=1-Number(i);e.setOpacityAndFollowing(0,this.animationClip.lastFrame,t)}else"PivotPoint"===s?e.pivot=(new h.Pa4).fromArray(i.split(" ").map((e=>Number(e)))):this.verbose&&console.warn("Unhandled line in object block: "+t+"; key: "+s+"; value: "+i)}return console.error("Parsing block reached content end"),e}}class ut{constructor(e,t,s,i=!1){this.entityType=new d,this.knownAnimations=[],this.aeFilename=e,this.path=(0,a.DW)(e),this.cfgRoot=t,this.audioListener=s,this.verbose=i}loadModels(){return Object.keys(this.cfgRoot).forEach((e=>{const t=this.cfgRoot[e];if(e.equalsIgnoreCase("Scale"))this.entityType.scale=Number(t);else if(e.equalsIgnoreCase("CarryNullName"))this.entityType.carryNullName=t;else if(e.equalsIgnoreCase("CarryNullFrames"))this.entityType.carryNullFrames=Number(t);else if(e.equalsIgnoreCase("Shape"))this.verbose&&console.warn("TODO Derive buildings shape from this value");else if(e.equalsIgnoreCase("DepositNullName"))this.entityType.depositNullName=t;else if(e.equalsIgnoreCase("ToolNullName"))this.entityType.toolNullName=t;else if(e.equalsIgnoreCase("WheelMesh")){if(!"NULL_OBJECT".equalsIgnoreCase(t)){const e=this.path+t+".lwo";this.entityType.wheelMesh=bt.getLwoModel(e),this.entityType.wheelMesh||console.error("Could not load wheel mesh from: "+e)}}else if(e.equalsIgnoreCase("WheelRadius"))this.entityType.wheelRadius=Number(t);else if(e.equalsIgnoreCase("WheelNullName"))this.entityType.wheelNullName=t;else if(e.equalsIgnoreCase("DrillNullName"))this.entityType.drillNullName=t;else if(e.equalsIgnoreCase("DriverNullName"))this.entityType.driverNullName=t;else if(e.equalsIgnoreCase("CameraNullName"))this.entityType.cameraNullName=t;else if(e.equalsIgnoreCase("CameraNullFrames"))this.entityType.cameraNullFrames=Number(t);else if(e.equalsIgnoreCase("CameraFlipDir"));else if(e.equalsIgnoreCase("HighPoly"))Object.keys(t).forEach((e=>{const s=e.startsWith("!")?e.slice(1):e,i=bt.getLwoModel(this.path+t[e]+".lwo");this.entityType.highPolyBodies.set(s.toLowerCase(),i)}));else if(e.equalsIgnoreCase("MediumPoly"));else if(e.equalsIgnoreCase("LowPoly"));else if(e.equalsIgnoreCase("FPPoly"));else if(e.equalsIgnoreCase("Activities"))this.parseAnimations(t);else if(e.equalsIgnoreCase("Upgrades"))this.parseUpgrades(t);else if(e.match(/level\d\d\d\d/i));else if(t.lwsfile&&!this.knownAnimations.includes(e))try{this.parseActivity(t,"activity_"+e)}catch(s){this.verbose&&console.warn("Could not parse unlisted activity: "+e,t,s)}else this.verbose&&console.warn("Unhandled animated entity key found: "+e,t)})),this.finalizeAnimations(),this.entityType}parseAnimations(e){Object.keys(e).forEach((t=>{try{let s=(0,a.hh)(e,t);this.knownAnimations.push(s.toLowerCase());const i=(0,a.hh)(this.cfgRoot,s);this.parseActivity(i,t.toLowerCase())}catch(s){console.error(s),console.log(this.cfgRoot),console.log(e),console.log(t)}}))}parseActivity(e,t){const s=(0,a.hh)(e,"FILE"),i=!0===(0,a.hh)(e,"LWSFILE"),r=(0,a.hh)(e,"TRANSCOEF"),n=!0===(0,a.hh)(e,"LOOPING");if(i){const e=bt.getResource(this.path+s+".lws"),i=new ct(this.path,this.verbose).parse(e);i.looping=n,i.transcoef=r?Number(r):1,t.startsWith("!")&&(t=t.substr(1)),this.entityType.animations.set(t,i)}else console.error("Found activity which is not an LWS file")}parseUpgrades(e){Object.keys(e).forEach((t=>{const s=t.match(/level(\d\d\d\d)/i);if(s){const i=e[t];this.entityType.upgradesByLevel.set(s[1],Object.keys(i).map((e=>{const t=bt.cfg("UpgradeTypes",e),s=i[e][0][0],r=Number(i[e][1][0])-1;return new g(t,s,r)})))}else console.warn("Unexpected upgrade level key: "+t)}))}finalizeAnimations(){this.entityType.animations.forEach((e=>{this.resolveAnimationBodies(e),this.entityType.wheelMesh&&e.wheelJoints.forEach((e=>{e.add(this.entityType.wheelMesh.clone(!0))})),this.applyDefaultUpgrades(e),e.polyModel.scale.setScalar(this.entityType.scale),e.bodies.forEach(((t,s)=>{const i=e.polyList[s],r=t.parentObjInd;null!=r?e.polyList[r].add(i):e.polyModel.add(i)}))}))}resolveAnimationBodies(e){e.bodies.forEach((t=>{var s;let i=this.entityType.highPolyBodies.get(t.lowerName);i||(i=this.entityType.mediumPolyBodies.get(t.lowerName)),i||(i=t.model);const r=i.clone();if(e.polyList.push(r),t.lowerName&&(t.lowerName.equalsIgnoreCase(this.entityType.carryNullName)?e.carryJoint=r:t.lowerName.equalsIgnoreCase(this.entityType.depositNullName)?e.depositJoint=r:t.lowerName.equalsIgnoreCase(this.entityType.toolNullName)?e.getToolJoint=r:t.lowerName.equalsIgnoreCase(this.entityType.wheelNullName)?e.wheelJoints.push(r):t.lowerName.equalsIgnoreCase(this.entityType.drillNullName)?e.drillJoint=r:t.lowerName.equalsIgnoreCase(this.entityType.driverNullName)?e.driverJoint=r:t.isNull&&e.nullJoints.getOrUpdate(t.lowerName.toLowerCase(),(()=>[])).push(r)),t.sfxName){const i=new h.VYz(this.audioListener);i.setRefDistance(6*l.pM),i.loop=!1,r.add(i),t.sfxName.equalsIgnoreCase("snd_music")||(null===(s=u.P.getSoundBuffer(t.sfxName))||void 0===s||s.then((e=>{i.setBuffer(e)})),t.sfxFrames.forEach((t=>e.sfxAudioByFrame.getOrUpdate(t,(()=>[])).push(i))))}}))}applyDefaultUpgrades(e){const t=this.entityType.upgradesByLevel.get("0000");t&&t.forEach((t=>{var s,i;const r=null===(s=e.nullJoints.get(t.upgradeNullName.toLowerCase()))||void 0===s?void 0:s[t.upgradeNullIndex];if(r){const e=bt.getLwoModel(t.upgradeFilepath+".lwo");e?r.add(e):null===(i=bt.getAnimationEntityType(t.upgradeFilepath+"/"+t.upgradeFilepath.split("/").last()+".ae",this.audioListener).animations.get("activity_stand"))||void 0===i||i.bodies.forEach((e=>r.add(e.model.clone())))}}))}}class dt extends h.xoR{constructor(e){super({side:h.ehD,alphaToCoverage:!0,shininess:0}),this.textures=[],this.timer=0,this.seqNum=0,this.name=e}clone(){const e=super.clone();return e.setTextures(this.textures),e}setTextures(e){this.textures=e,this.textures.length<1||(this.map=this.textures[0],this.color.set(16777215))}update(e){if(this.textures.length<1)return;this.timer+=e;const t=Math.floor(this.timer/l.lZ);this.timer-=t*l.lZ,this.seqNum=(this.seqNum+t)%this.textures.length,this.map=this.textures[this.seqNum]}setOpacity(e){this.opacity=e,this.transparent=this.transparent||this.opacity<1}}const gt=1448366670;function pt(e,t){let s=new h.Pa4;return s.x=e.getFloat32(t),s.y=e.getFloat32(t+4),s.z=e.getFloat32(t+8),s}class yt{constructor(e,t=null,s=!1){this.verbose=!1,this.materials=[],this.geometry=new h.u9r,this.vertices=null,this.indices=null,this.uvs=null,this.verbose=s,this.meshPath=e,this.entityPath=t}parsePoints(e,t,s){if(s%12!=0)return void console.error("LWOLoader.parse: F12 does not evenly divide into chunk size ("+s+"). Possible corruption.");let i=s/4/3;this.vertices=new Float32Array(3*i),this.uvs=new Float32Array(2*i);for(let s=0;s<i;s++){let i=3*s,r=4*i;this.vertices[i]=e.getFloat32(t+r),this.vertices[i+1]=e.getFloat32(t+r+4),this.vertices[i+2]=e.getFloat32(t+r+8)}}parseSurfaceNames(e,t,s){let i=(new TextDecoder).decode(new Uint8Array(e,t,s));this.materials=i.split("\0").filter((e=>!!e)).map((e=>new dt(e))),this.verbose&&console.log("LWO contains "+this.materials.length+" materials with following names: "+this.materials.map((e=>e.name)))}parsePolygons(e,t,s){let i=0,r=0;for(;r<s;){const s=e.getInt16(t+r),n=e.getInt16(t+r+2+2*s);this.geometry.addGroup(i,3*(s-2),n-1),i+=3*(s-2),r+=4+2*s}r=0;let n=0;for(this.indices=new Uint16Array(i);r<s;){let s=e.getInt16(t+r);r+=2;let i=new Int16Array(s);for(let n=0;n<=s;n++)i[n]=e.getInt16(t+r+2*n);for(let e=0;e<s-2;e++)this.COUNTER_CLOCKWISE?(this.indices[n++]=i[0],this.indices[n++]=i[e+2],this.indices[n++]=i[e+1]):(this.indices[n++]=i[0],this.indices[n++]=i[e+1],this.indices[n++]=i[e+2]);r+=2+2*s}}parseSurface(e,t,s,i){var r;let n=0;for(;0!==e.getUint8(s+n);)n++;let o=(0,a.v5)(new Uint8Array(t,s,n));this.verbose&&console.log("Start parsing surface: "+o);let l=-1,c=null;for(let e=0;e<this.materials.length;e++)this.materials[e].name===o&&(l=e,c=this.materials[e]);if(!c)return void console.error("LWOLoader.parse: Surface in SURF chunk does not exist in SRFS");let u=0,d=new h.Pa4(0,0,0),g=new h.Pa4(0,0,0);for(;n<i;){const i=s+n;if(0===e.getUint8(i))n++;else{const s=e.getInt32(i),o=e.getInt16(i+4);this.verbose&&console.log("Parsing sub-chunk "+(new TextDecoder).decode(new Uint8Array(t,i,4))+" at "+i+"; length "+o);const l=i+6;switch(s){case 1129270354:const n=[e.getUint8(l+0)/255,e.getUint8(l+1)/255,e.getUint8(l+2)/255];c.color=(new h.Ilk).fromArray(n),this.verbose&&console.log("Material color (COLR): "+n.join(" "));break;case 1179402567:const p=e.getUint16(l);this.verbose&&console.log("Flags (FLAG): "+p.toString(2)),this.verbose&&2&p&&console.warn("Flag is set but unhandled: outline"),this.verbose&&4&p&&console.warn("Flag is set but unhandled: smoothing"),this.verbose&&8&p&&console.warn("Flag is set but unhandled: colorHighlights"),this.verbose&&16&p&&console.warn("Flag is set but unhandled: colorFilter"),this.verbose&&32&p&&console.warn("Flag is set but unhandled: opaqueEdge"),this.verbose&&64&p&&console.warn("Flag is set but unhandled: transparentEdge"),this.verbose&&128&p&&console.warn("Flag is set but unhandled: sharpTerminator"),256&p&&(c.side=h.ehD),512&p&&(c.blending=h.WMw,c.depthWrite=!1),this.verbose&&1024&p&&console.warn("Flag is set but unhandled: shadowAlpha");break;case 1380535876:const y=e.getFloat32(l);c.refractionRatio=1/y;break;case 1162102597:const m=e.getFloat32(l);this.verbose&&console.warn("Edge transparency threshold (0.0 to 1.0): "+m);break;case 1397571918:const f=e.getFloat32(l);this.verbose&&console.warn("Implement maximum angle between two adjacent polygons that can be smooth shaded: "+f);break;case 1280658761:const v=e.getInt16(l)/256;this.verbose&&console.log("Luminosity (LUMI): "+v),c.emissiveIntensity=v;break;case 1145652806:const E=e.getInt16(l)/256;this.verbose&&console.log("Diffuse (DIFF): "+E),E||(c.color=null);break;case 1397769539:const w=e.getInt16(l)/256;this.verbose&&console.warn("Specular (SPEC): "+w);break;case 1380271692:let b=0;b=1447449164===b?e.getFloat32(l):e.getInt16(l)/256,c.reflectivity=b,this.verbose&&console.log("Reflectivity (REFL): "+c.reflectivity);break;case 1414676814:case gt:let M=0;M=s===gt?e.getFloat32(l):e.getInt16(l)/256,c.setOpacity(1-M),this.verbose&&console.log("Opacity (TRAN/VTRN): "+c.opacity);break;case 1447843149:const S=e.getFloat32(l);this.verbose&&console.log("Luminosity (VLUM): "+S),c.emissiveIntensity=S;break;case 1447315782:let T=e.getFloat32(l);this.verbose&&console.log("Diffuse (VDIF): "+T);break;case 1448300611:let L=e.getFloat32(l);this.verbose&&console.warn("Specular (VSPC): "+L);break;case 1129596248:case 1146373464:case 1398031704:case 1381254488:case 1414808920:case 1112819032:const A=(0,a.jG)(new Uint8Array(t,l,o));this.verbose&&console.warn("Unhandled texture typename: "+A);break;case 1413893191:u=e.getUint16(l),this.verbose&&console.log("Flags (TFLG): "+u.toString(2)),this.verbose&&1&u&&console.warn("Flag is set but unhandled: X Axis"),this.verbose&&2&u&&console.warn("Flag is set but unhandled: Y Axis"),this.verbose&&4&u&&console.warn("Flag is set but unhandled: Z Axis"),this.verbose&&8&u&&console.warn("Flag is set but unhandled: World Coords"),this.verbose&&16&u&&console.warn("Flag is set but unhandled: Negative Image"),this.verbose&&32&u&&console.warn("Flag is set but unhandled: Pixel Blending"),this.verbose&&64&u&&console.log("Flag is set: Antialiasing");break;case 1414744410:d=pt(e,l),this.verbose&&console.log("Texture size (TSIZ): "+d.toArray().join(" "));break;case 1413698642:g=pt(e,l),this.verbose&&console.warn("Unhandled texture center (TCTR): "+g.toArray().join(" "));break;case 1413696594:const R=[e.getUint8(l+0)/255,e.getUint8(l+1)/255,e.getUint8(l+2)/255,e.getUint8(l+3)/255];this.verbose&&console.log("Unhandled texture color (TCLR): "+R.join(" "));break;case 1414938956:const C=e.getUint16(l)/256;this.verbose&&console.warn("Unhandled texture value (TVAL): "+C);break;case 1414090055:const P=(0,a.jG)(new Uint8Array(t,l,o));this.verbose&&console.log("Texture filepath (TIMG): "+P);const I=null===(r=(0,a.vt)(P))||void 0===r?void 0:r.toLowerCase();if(!I||"(none)"===I)break;c.transparent=c.transparent||!!I.match(/a\d\d\d\D.*bmp/i);const x=I.endsWith("(sequence)"),O=I.substring(0,I.length-"(sequence)".length).trim();let D=[];if(x){const e=O.match(/(.+\D)0+(\d+)\..+/i);D=bt.getTexturesBySequenceName(this.meshPath+e[1])}else{const e=bt.getMeshTexture(I,this.meshPath,this.entityPath);D=e?[e]:[]}c.setTextures(D);break;case 1415008848:const N=this.parseWrappingMode(e.getUint16(l)),_=this.parseWrappingMode(e.getUint16(l+2));c.textures.forEach((e=>{e.wrapS=N,e.wrapT=_}));break;case 1413562707:break;default:this.verbose&&console.warn("Found unrecognised SURF sub-chunk type "+(new TextDecoder).decode(new Uint8Array(t,i,4))+" ("+s+") at "+i+"; length "+o)}n+=6+o}}!function(e,t,s,i,r,n,a,o){if(7&o)for(let l of e.groups)if(l.materialIndex===r)for(let e=l.start;e<l.start+l.count;e++){let r=3*i[e],l=t[r]-a.x,h=t[r+1]-a.y,c=t[r+2]-a.z,u=2*i[e],d=0,g=0;1&o?(d=c/n.z+.5,g=h/n.y+.5):2&o?(d=l/n.x+.5,g=c/n.z+.5):4&o&&(d=l/n.x+.5,g=h/n.y+.5),s[u]=d,s[u+1]=g}}(this.geometry,this.vertices,this.uvs,this.indices,l,d,g,u),this.verbose&&console.log("Done parsing surface: "+o)}parse(e){const t=new DataView(e);if(1179603533!==t.getUint32(0))return void console.error("LWOLoader.parse: Cannot find header.");const s=t.getUint32(4);if(s+8!==t.byteLength&&console.warn("LWOLoader.parse: Discrepancy between size in header ("+(s+8)+" bytes) and actual size ("+t.byteLength+" bytes)."),1280790338!==t.getUint32(8)){const t=(0,a.v5)(new Uint8Array(e,8,4));return void console.error("LWOLoader.parse: Invalid magic ID ("+t+") in LWO header.")}let i=12;for(;i<t.byteLength;)if(0===t.getUint8(i))i++;else{const s=t.getInt32(i),r=t.getInt32(i+4);switch(i+=8,s){case 1347310675:this.parsePoints(t,i,r);break;case 1397900883:this.parseSurfaceNames(e,i,r);break;case 1347374163:this.parsePolygons(t,i,r);break;case 1398100550:this.parseSurface(t,e,i,r);break;default:console.warn("Found unrecognised chunk type "+(0,a.v5)(new Uint8Array(e,i-8,4))+" at "+i)}i+=r}return this.geometry.setAttribute("position",new h.TlE(this.vertices,3)),this.geometry.setAttribute("uv",new h.TlE(this.uvs,2)),this.geometry.setIndex(new h.TlE(this.indices,1)),this.geometry.computeVertexNormals(),new ht(this.geometry,this.materials)}parseWrappingMode(e){return 0===e||1===e?h.uWy:2===e?h.rpg:3===e?h.OoA:(console.warn("Unexpected texture wrapping mode given: "+e),h.rpg)}}var mt=s(332);class ft{constructor(e,t){this.wad0FileUrl=e,this.wad1FileUrl=t}}var vt,Et,wt=s(346);class bt extends mt.E{static startLoadingFromCache(){return this.startLoading(null)}static startLoadingFromUrl(e,t){return this.startLoading(new ft(e,t))}static startLoading(e){this.worker.onmessage=e=>{var t;const s=e.data;s.type===wt.n.ASSET?(s.assetNames.forEach((e=>this.resourceByName.set(e.toLowerCase(),s.assetObj))),null===(t=s.sfxKeys)||void 0===t||t.forEach((e=>this.sfxByKey.set(e,s.assetObj))),this.onAssetLoaded()):s.type===wt.n.MSG?this.onMessage(s.text):s.type===wt.n.CFG?(this.configuration=s.cfg,this.stats=s.stats,this.loadDefaultCursor(),this.onInitialLoad(s.totalResources)):s.type===wt.n.CACHE_MISS?this.onCacheMissed():s.type===wt.n.DONE&&(this.loadAllCursor(),console.log("Loading of about "+s.totalResources+" assets complete! Total load time: "+s.loadingTimeSeconds+" seconds."),this.onLoadDone())},this.worker.postMessage(e)}static getTexturesBySequenceName(e){const t=null==e?void 0:e.toLowerCase(),s=[];return this.resourceByName.forEach(((e,i)=>{i.startsWith(t)&&s.push(i)})),s.length>0?s.map((e=>this.getTexture(e))):t.startsWith("world/shared/")?(console.warn("Texture sequence not found: "+t),[]):this.getTexturesBySequenceName("world/shared/"+(0,a.vt)(t))}static getMeshTexture(e,t,s){const i=null==e?void 0:e.toLowerCase(),r=(null==t?void 0:t.toLowerCase())+i,n=this.resourceByName.getOrUpdate(r,(()=>{const t=s?s.toLowerCase()+i:null;return s?this.resourceByName.getOrUpdate(t,(()=>this.getImgDataFromSharedPaths(i,e,r,t))):this.getImgDataFromSharedPaths(i,e,r,t)}));if(!n)return null;const a=new h.xEZ(n,h.xEZ.DEFAULT_MAPPING,h.rpg,h.rpg);return a.needsUpdate=!0,a}static getImgDataFromSharedPaths(e,t,s,i){const r="vehicles/sharedug/"+e;return this.resourceByName.getOrUpdate(r,(()=>{const r="world/shared/"+e;return this.resourceByName.getOrUpdate(r,(()=>"teofoilreflections.jpg"!==e&&"wingbase3.bmp"!==e&&"a_side.bmp"!==e&&"a_top.bmp"!==e?(console.warn("Texture '"+t+"' ("+s+", "+i+", "+r+") unknown! Using placeholder texture instead"),(0,c.BT)(64,64)):null))}))}static getTexture(e){if(!e)throw"textureFilepath must not be undefined, null or empty - was "+e;const t=this.resourceByName.get(e.toLowerCase());if(!t)return null;const s=new h.xEZ(t,h.xEZ.DEFAULT_MAPPING,h.rpg,h.rpg);return s.needsUpdate=!0,s}static getAnimationEntityType(e,t){let s=this.getResource(e);if(!s)throw"Could not get animation entity type for: "+e;return new ut(e,s,t).loadModels()}static getLwoModel(e,t=null){var s;return null===(s=this.lwoCache.getOrUpdate(e.toLowerCase(),(()=>{const s=bt.getResource(e);return s?new yt((0,a.DW)(e),t).parse(s):null})))||void 0===s?void 0:s.clone()}}bt.worker=new Worker(new URL(s.p+s.u(25),s.b)),bt.lwoCache=new Map,bt.onMessage=e=>{console.log(e)},bt.onCacheMissed=()=>{console.log("Worker missed cache")},bt.onInitialLoad=()=>{console.log("Initial loading done.")},bt.onAssetLoaded=()=>{},bt.onLoadDone=()=>{};class Mt{constructor(){this.selection=new Te,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.raidersInBeam=[],this.materials=[],this.materialsUndiscovered=[],this.buildingSites=[],this.spiders=[],this.bats=[],this.rockMonsters=[],this.vehicles=[],this.vehiclesUndiscovered=[],T.registerEventListener(S.Z.SELECTION_CHANGED,(e=>{e.selectPanelType===N.NONE&&this.selection.deselectAll()}))}reset(){this.selection=new Te,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.raidersInBeam=[],this.materials=[],this.materialsUndiscovered=[],this.buildingSites=[],this.spiders=[],this.bats=[],this.rockMonsters=[],this.vehicles=[],this.vehiclesUndiscovered=[]}start(){}update(e){this.raiders.forEach((t=>y(t,e))),this.raidersInBeam.forEach((t=>y(t,e))),this.buildings.forEach((t=>y(t,e))),this.raiders.forEach((t=>y(t,e))),this.spiders.forEach((t=>y(t,e))),this.bats.forEach((t=>y(t,e)))}stop(){this.buildings.forEach((e=>e.removeFromScene())),this.buildingsUndiscovered.forEach((e=>e.removeFromScene())),this.raiders.forEach((e=>e.removeFromScene())),this.raidersUndiscovered.forEach((e=>e.removeFromScene())),this.materials.forEach((e=>e.removeFromScene())),this.materialsUndiscovered.forEach((e=>e.removeFromScene())),this.spiders.forEach((e=>e.removeFromScene())),this.bats.forEach((e=>e.removeFromScene()))}getBuildingsByType(...e){return this.buildings.filter((t=>t.isUsable()&&e.some((e=>t.entityType===e))))}getClosestBuildingByType(e,...t){return Mt.getClosestBuilding(this.getBuildingsByType(...t),e)}getTrainingSites(e){return this.buildings.filter((t=>t.isTrainingSite(e)))}getClosestTrainingSite(e,t){return Mt.getClosestBuilding(this.getTrainingSites(t),e)}static getClosestBuilding(e,t){let s=null,i=null;return e.forEach((e=>{const r=e.sceneEntity.position.clone(),n=t.distanceToSquared(r);(null===s||n<i)&&(s=e,i=n)})),s}getMaxRaiders(){return l.d+this.buildings.count((e=>e.isUsable()&&e.entityType===M.BARRACKS))*l.oq}discoverSurface(e){const t=e.x*l.pM,s=e.y*l.pM,i=t+l.pM,r=s+l.pM,n=this.raidersUndiscovered.length;this.raidersUndiscovered=Mt.removeInRect(this.raidersUndiscovered,t,i,s,r,(e=>{e.entityMgr.raiders.push(e),T.publishEvent(new De(e.sceneEntity.position.clone()))})),n!==this.raidersUndiscovered.length&&T.publishEvent(new V(this)),this.buildingsUndiscovered=Mt.removeInRect(this.buildingsUndiscovered,t,i,s,r,(e=>{e.entityMgr.buildings.push(e),T.publishEvent(new J(e.entityMgr))})),this.materialsUndiscovered=Mt.removeInRect(this.materialsUndiscovered,t,i,s,r,(e=>{e.entityMgr.materials.push(e),T.publishEvent(new ee(e.createCarryJob()))}))}static removeInRect(e,t,s,i,r,n){return e.filter((e=>{const a=e.sceneEntity.position2D.clone();a.x>=t&&a.x<s&&a.y>=i&&a.y<r&&(e.sceneEntity.visible=!0,n(e))}))}placeMaterial(e,t){return e.sceneEntity.addToScene(t,0),e.sceneEntity.visible?(this.materials.push(e),T.publishEvent(new ee(e.createCarryJob()))):this.materialsUndiscovered.push(e),e}getOxygenSum(){return this.raiders.map((e=>e.stats.OxygenCoef)).reduce(((e,t)=>e+t),0)+this.buildings.map((e=>e.isUsable()?e.stats.OxygenCoef:0)).reduce(((e,t)=>e+t),0)}hasMaxRaiders(){return this.raiders.length>=this.getMaxRaiders()}findTeleportBuilding(e){return this.buildings.find((t=>t.canTeleportIn(e)))}}class St{constructor(e){this.entity=e,this.counter=6*l.pM,T.publishEvent(new W);const t=new rt("Mini-Figures/Pilot/VLP_TelepUp.lws",this.entity.sceneMgr.listener);t.position.copy(this.entity.sceneEntity.position.clone()),t.rotateOnAxis(new h.Pa4(0,1,0),this.entity.sceneEntity.getHeading()),this.entity.sceneMgr.scene.add(t),t.startAnimation((()=>{this.entity.removeFromScene(),this.entity.sceneMgr.scene.remove(t)}))}update(e){this.counter>0&&(this.counter--,this.entity.sceneEntity.position.y+=l.pM/l.OK/2*(e/l.l3))}}class Tt extends Ye{constructor(e){super(e,"MiscAnims/Barrier/Barrier.ae"),this.changeActivity()}getDefaultActivity(){return le.Short}}class Lt extends Ze{constructor(e,t,s,i){super(e,t,M.BARRIER),this.sceneEntity=new Tt(e),this.targets=[new je(i,s.position,s.heading)]}findCarryTargets(){return this.targets.every((e=>e.isInvalid()))?this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((e=>new qe(e))):this.targets}getPriorityIdentifier(){return _.aiPriorityConstruction}}class At extends Ge{constructor(e){super(e),this.add(bt.getLwoModel("Buildings/E-Fence/E-Fence4.lwo"))}}class Rt extends _e{onJobComplete(){super.onJobComplete(),this.item.sceneEntity.addToScene(null,null),this.item.targetSurface.fence=this.item}}class Ct extends Ze{constructor(e,t,s){super(e,t,M.ELECTRIC_FENCE),this.sceneEntity=new At(e),this.targetSurface=s,this.target=[new Ve(s.getCenterWorld2D())]}findCarryTargets(){return this.target.every((e=>e.isInvalid()))?this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((e=>new qe(e))):this.target}createCarryJob(){return new Rt(this)}getPriorityIdentifier(){return _.aiPriorityConstruction}}class Pt extends ce{constructor(e,t){super(e),this.building=t}getFocusPoint(){return this.building.primarySurface.getCenterWorld2D()}isInvalid(){return!this.building.isUsable()}}class It{constructor(e,t,s,i){this.blocksPathSurface=!0,this.secondaryBuildingPart=null,this.primaryPowerPath=new h.FM8(0,1),this.secondaryPowerPath=null,this.waterPathSurface=null,this.teleport=null,this.entityType=null,this.level=0,this.powerSwitch=!0,this.primarySurface=null,this.secondarySurface=null,this.primaryPathSurface=null,this.secondaryPathSurface=null,this.upgradeCostOre=0,this.upgradeCostBrick=0,this.crystalsInUse=0,this.inBeam=!1,this.beamUpAnimator=null,this.pathTarget=null,this.surfaces=[],this.sceneMgr=e,this.entityMgr=t,this.entityType=s,this.sceneEntity=new Ye(this.sceneMgr,i),this.sceneEntity.flipXAxis(),this.upgradeCostOre=bt.cfg("Main","BuildingUpgradeCostOre"),this.upgradeCostBrick=bt.cfg("Main","BuildingUpgradeCostStuds"),T.registerEventListener(S.Z.MATERIAL_AMOUNT_CHANGED,(()=>{this.updatePowerState()}))}isSelectable(){return!this.selected&&!this.inBeam}isInSelection(){return this.isSelectable()||this.selected}select(){return!!this.isSelectable()&&(this.sceneEntity.selectionFrame.visible=!0,this.selected=!0,!0)}deselect(){this.sceneEntity.selectionFrame.visible=!1,this.selected=!1}getDropPosition2D(){var e,t;if(null===(e=this.sceneEntity.animation)||void 0===e?void 0:e.getToolJoint){const e=new h.Pa4;return this.sceneEntity.animation.getToolJoint.getWorldPosition(e),new h.FM8(e.x,e.z)}if(null===(t=this.sceneEntity.animation)||void 0===t?void 0:t.depositJoint){const e=new h.Pa4;return this.sceneEntity.animation.depositJoint.getWorldPosition(e),new h.FM8(e.x,e.z)}return this.sceneEntity.position2D.clone()}isUsable(){return!this.inBeam&&this.powerSwitch&&(this.isPowered()||this.stats.PowerBuilding)&&this.sceneEntity.visible}isPowered(){return this.stats.SelfPowered||this.crystalsInUse>0}hasMaxLevel(){return this.level>=this.stats.Levels-1}upgrade(){this.canUpgrade()&&(o.numBrick>=this.upgradeCostBrick?o.numBrick-=this.upgradeCostBrick:o.numOre-=this.upgradeCostOre,T.publishEvent(new ie),this.level++,T.publishEvent(new W),T.publishEvent(new J(this.entityMgr)))}setLevel(e){this.level=e,T.publishEvent(new J(this.entityMgr))}getDefaultActivity(){return this.isPowered()?oe.Stand:Je.Unpowered}beamUp(){this.inBeam=!0,this.updatePowerState();for(let e=0;e<this.stats.CostOre;e++)this.entityMgr.placeMaterial(new Qe(this.sceneMgr,this.entityMgr),this.primarySurface.getRandomPosition());for(let e=0;e<this.stats.CostCrystal;e++)this.entityMgr.placeMaterial(new Ke(this.sceneMgr,this.entityMgr),this.primarySurface.getRandomPosition());this.surfaces.forEach((e=>e.setBuilding(null))),this.pathTarget=null,this.beamUpAnimator=new St(this),T.publishEvent(new J(this.entityMgr))}removeFromScene(){this.entityMgr.buildings.remove(this)}canUpgrade(){return!this.hasMaxLevel()&&(o.numOre>=this.upgradeCostOre||o.numBrick>=this.upgradeCostBrick)}spawnMaterials(e,t){const s=[];if(e===M.CRYSTAL)for(;o.numCrystal>0&&s.length<t;)o.numCrystal--,s.push(new Ke(this.sceneMgr,this.entityMgr));else if(e===M.ORE)for(;o.numOre>0&&s.length<t;)o.numOre--,s.push(new Qe(this.sceneMgr,this.entityMgr));else console.error("Material drop not implemented for: "+e);s.length>0&&T.publishEvent(new ie),s.forEach((e=>this.entityMgr.placeMaterial(e,this.getDropPosition2D())))}spawnBarriers(e,t){e.map((e=>new Lt(this.sceneMgr,this.entityMgr,e,t))).forEach((e=>this.entityMgr.placeMaterial(e,this.getDropPosition2D())))}spawnFence(e){this.entityMgr.placeMaterial(new Ct(this.sceneMgr,this.entityMgr,e),this.getDropPosition2D())}setPowerSwitch(e){this.powerSwitch=e,this.updatePowerState()}updatePowerState(){this.powerSwitch&&!this.inBeam?this.turnPowerOn():this.turnPowerOff(),this.teleport&&(this.teleport.powered=this.isPowered())}turnPowerOn(){this.crystalsInUse>0||this.stats.SelfPowered||o.usedCrystals>=o.numCrystal||this.entityType!==M.POWER_STATION&&!this.surfaces.some((e=>e.neighbors.some((e=>e.hasPower))))||(this.crystalsInUse=1,o.usedCrystals+=this.crystalsInUse,this.surfaces.forEach((e=>e.setHasPower(!0,!0))),this.sceneEntity.changeActivity(),T.publishEvent(new J(this.entityMgr)),this.stats.EngineSound&&(this.engineSound=this.sceneEntity.playPositionalAudio(this.stats.EngineSound,!0)))}turnPowerOff(){var e;this.crystalsInUse<1||(o.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.surfaces.forEach((e=>e.setHasPower(!1,!1))),this.sceneEntity.changeActivity(),T.publishEvent(new J(this.entityMgr)),null===(e=this.engineSound)||void 0===e||e.stop(),this.engineSound=null)}placeDown(e,t,s){if(this.primarySurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(e),this.primarySurface.setBuilding(this),this.surfaces.push(this.primarySurface),this.secondaryBuildingPart){const s=new h.FM8(l.pM*this.secondaryBuildingPart.x,l.pM*this.secondaryBuildingPart.y).rotateAround(new h.FM8(0,0),-t).add(e);this.secondarySurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(s),this.secondarySurface.setBuilding(this),this.surfaces.push(this.secondarySurface)}if(this.primaryPowerPath){const s=new h.FM8(this.primaryPowerPath.x,this.primaryPowerPath.y).multiplyScalar(l.pM).rotateAround(new h.FM8(0,0),-t).add(e);this.primaryPathSurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(s),this.primaryPathSurface.setSurfaceType(R.POWER_PATH_BUILDING),this.surfaces.push(this.primaryPathSurface)}if(this.secondaryPowerPath){const s=new h.FM8(this.secondaryPowerPath.x,this.secondaryPowerPath.y).multiplyScalar(l.pM).rotateAround(new h.FM8(0,0),-t).add(e);this.secondaryPathSurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(s),this.secondaryPathSurface.setSurfaceType(R.POWER_PATH_BUILDING),this.surfaces.push(this.secondaryPathSurface)}this.addToScene(e,t),this.sceneEntity.createPickSphere(this.stats.PickSphere,this,this.stats.PickSphere/4),this.sceneEntity.visible?this.entityMgr.buildings.push(this):this.entityMgr.buildingsUndiscovered.push(this),this.sceneEntity.visible&&!s?(this.inBeam=!0,this.sceneEntity.changeActivity(Je.Teleport,(()=>{this.inBeam=!1,this.onPlaceDown()}))):this.onPlaceDown(),this.sceneMgr.terrain.resetGraphWalk()}onPlaceDown(){this.sceneEntity.changeActivity(),this.updatePowerState(),T.publishEvent(new J(this.entityMgr))}getDropAction(){return he.Place}getTrainingTargets(){return[new h.FM8(-1,0),new h.FM8(0,1),new h.FM8(1,0),new h.FM8(0,-1)].map((e=>{const t=e.multiplyScalar(l.pM/2).add(this.primarySurface.getCenterWorld2D());return new Pt(t,this)}))}addToScene(e,t){this.sceneEntity.addToScene(e,t),this.pathTarget=new we(this)}getPathTarget(){return this.pathTarget}isTrainingSite(e){return this.entityType===x[e]&&this.isUsable()&&this.stats[O[e]][this.level]}canTeleportIn(e){var t;return null===(t=this.teleport)||void 0===t?void 0:t.canTeleportIn(e)}update(e){var t;this.sceneEntity.update(e),null===(t=this.beamUpAnimator)||void 0===t||t.update(e)}}class xt extends It{constructor(e,t){super(e,t,M.BARRACKS,"Buildings/Barracks/Barracks.ae")}get stats(){return bt.stats.Barracks}}class Ot extends It{constructor(e,t){super(e,t,M.DOCKS,"Buildings/Docks/Docks.ae"),this.primaryPowerPath=new h.FM8(0,-1),this.waterPathSurface=new h.FM8(0,1)}get stats(){return bt.stats.Docks}}class Dt extends It{constructor(e,t){super(e,t,M.GEODOME,"Buildings/Geo-dome/Geo-dome.ae"),this.primaryPowerPath=null,this.secondaryBuildingPart=new h.FM8(0,1)}get stats(){return bt.stats.Geodome}}class Nt extends It{constructor(e,t){super(e,t,M.GUNSTATION,"Buildings/gunstation/gunstation.ae"),this.primaryPowerPath=null}getDefaultActivity(){return Je.Stand}get stats(){return bt.stats.GunStation}}class _t extends It{constructor(e,t){super(e,t,M.ORE_REFINERY,"Buildings/OreRefinery/OreRefinery.ae"),this.primaryPowerPath=new h.FM8(0,2),this.secondaryBuildingPart=new h.FM8(0,1)}get stats(){return bt.stats.OreRefinery}getDropAction(){return he.Deposit}}class Ft extends It{constructor(e,t){super(e,t,M.POWER_STATION,"Buildings/Powerstation/Powerstation.ae"),this.secondaryBuildingPart=new h.FM8(-1,0)}get stats(){return bt.stats.Powerstation}getDropAction(){return he.Deposit}}class Bt{constructor(e){this.building=e}canTeleportIn(e){return this.powered&&!this.operating}teleportIn(e,t,s){this.operating=!0;const i=this.building.sceneEntity.getHeading();e.sceneEntity.addToScene(new h.FM8(0,l.pM/2).rotateAround(new h.FM8(0,0),-i).add(this.building.sceneEntity.position2D.clone()),i),e.sceneEntity.playPositionalAudio(p.d[p.d.SND_teleport],!1),e.sceneEntity.changeActivity(he.TeleportIn,(()=>{this.operating=!1,e.sceneEntity.changeActivity(),e.sceneEntity.createPickSphere(e.stats.PickSphere,e);const i=this.building.primaryPathSurface.getRandomPosition();e.setJob(new Se(i)),s.remove(e),t.push(e),T.publishEvent(new V(e.entityMgr))}))}}class kt extends Bt{canTeleportIn(e){return super.canTeleportIn(e)&&e===M.PILOT}}class Ut extends Bt{canTeleportIn(e){return super.canTeleportIn(e)&&Ut.isSmall(e)}static isSmall(e){return e===M.PILOT||e===M.HOVERBOARD||e===M.SMALL_TRUCK||e===M.SMALL_CAT||e===M.SMALL_DIGGER||e===M.SMALL_MLP||e===M.SMALL_HELI}}class Wt extends Bt{canTeleportIn(e){return super.canTeleportIn(e)&&Wt.isLarge(e)}static isLarge(e){return e===M.BULLDOZER||e===M.WALKER_DIGGER||e===M.LARGE_MLP||e===M.LARGE_DIGGER||e===M.LARGE_CAT}}class Gt extends It{constructor(e,t){super(e,t,M.TELEPORT_BIG,"Buildings/BIGTeleport/BIGTeleport.ae"),this.secondaryBuildingPart=new h.FM8(0,1),this.primaryPowerPath=new h.FM8(-1,0),this.secondaryPowerPath=new h.FM8(-1,1),this.teleport=new Wt(this)}get stats(){return bt.stats.TeleportBIG}}class Ht extends It{constructor(e,t){super(e,t,M.TELEPORT_PAD,"Buildings/Teleports/Teleports.ae"),this.teleport=new Ut(this)}get stats(){return bt.stats.TeleportPad}}class Jt extends It{constructor(e,t){super(e,t,M.TOOLSTATION,"Buildings/Toolstation/Toolstation.ae"),this.blocksPathSurface=!1,this.teleport=new kt(this)}get stats(){return bt.stats.Toolstation}}class Vt extends It{constructor(e,t){super(e,t,M.UPGRADE,null)}get stats(){return bt.stats.Upgrade}}class qt{static createBuildingFromType(e,t,s){switch(e){case M.TOOLSTATION:return new Jt(t,s);case M.TELEPORT_PAD:return new Ht(t,s);case M.DOCKS:return new Ot(t,s);case M.POWER_STATION:return new Ft(t,s);case M.BARRACKS:return new xt(t,s);case M.UPGRADE:return new Vt(t,s);case M.GEODOME:return new Dt(t,s);case M.ORE_REFINERY:return new _t(t,s);case M.GUNSTATION:return new Nt(t,s);case M.TELEPORT_BIG:return new Gt(t,s);default:throw"Unexpected building type: "+M[e]}}}class jt extends pe{constructor(e,t){var s;super(e,t,null,t,null,null),t.setSurfaceType(R.POWER_PATH_BUILDING_SITE),null===(s=e.getClosestBuildingByType(t.getCenterWorld(),M.TOOLSTATION))||void 0===s||s.spawnMaterials(M.ORE,2),this.neededByType.set(M.ORE,2),e.buildingSites.push(this),T.publishEvent(new W)}}class Zt extends be{constructor(){super(...arguments),this.target=[]}getWorkplaces(){return this.target.length<1&&(this.target=[new ce(this.raider.sceneEntity.position2D.clone())]),this.target}onJobComplete(){this.raider.hungerLevel=1,super.onJobComplete()}getWorkActivity(){return he.Eat}}class Kt extends be{constructor(e,t,s){super(),this.entityMgr=e,this.training=t,this.building=s,this.workplaces=this.getWorkplaces()}getWorkplaces(){var e;return(null===(e=this.building)||void 0===e?void 0:e.isUsable())||(this.workplaces=[],this.entityMgr.getTrainingSites(this.training).map((e=>e.getTrainingTargets().forEach((e=>this.workplaces.push(e)))))),this.workplaces}onJobComplete(){super.onJobComplete(),this.raider.addTraining(this.training),T.publishEvent(new V(this.entityMgr,this.training))}getWorkActivity(){return he.Train}getWorkDuration(e){return 1e4}}class Yt extends be{constructor(e){super(),this.building=e,this.workplaces=e.getTrainingTargets()}getWorkplaces(){return this.building.isUsable()?this.workplaces:[]}onJobComplete(){super.onJobComplete(),this.raider.level<this.raider.stats.Levels&&this.raider.level++}getWorkActivity(){return he.Train}getWorkDuration(e){return 3e4}}class zt extends de{constructor(e){super(),this.vehicle=e,this.vehicle.callManJob=this,this.workplaces=[new ce(this.vehicle.sceneEntity.position2D.clone())]}getWorkplaces(){return this.vehicle.inBeam?(this.jobState=F.INCOMPLETE,[]):this.vehicle.driver?(this.jobState=F.COMPLETE,[]):this.workplaces}onJobComplete(){this.vehicle.addDriver(this.fulfiller[0]),this.vehicle.callManJob=null,super.onJobComplete()}getRequiredTraining(){return this.vehicle.getRequiredTraining()}getPriorityIdentifier(){return _.aiPriorityGetIn}}class Xt extends oe{}Xt.Route=new oe("Activity_Route"),Xt.TeleportIn=new oe("Activity_TeleportIN");class $t extends Ye{pickupEntity(e){var t;this.carriedEntity!==e&&(this.dropEntity(),this.carriedEntity=e,((null===(t=this.animation)||void 0===t?void 0:t.carryJoint)||this).add(this.carriedEntity.group),this.carriedEntity.position.set(0,0,0))}dropEntity(){var e;if(!this.carriedEntity)return;const t=this.position.clone();(null===(e=this.animation)||void 0===e?void 0:e.carryJoint)&&(this.animation.carryJoint.remove(this.carriedEntity.group),this.animation.carryJoint.getWorldPosition(t)),this.carriedEntity.addToScene(new h.FM8(t.x,t.z),null),this.carriedEntity=null}getDefaultActivity(){return this.carriedEntity?he.CarryStand:super.getDefaultActivity()}}class Qt{constructor(e){this.vec=null,this.targetReached=!1,this.vec=e}}!function(e){e[e.MOVED=0]="MOVED",e[e.TARGET_REACHED=1]="TARGET_REACHED",e[e.TARGET_UNREACHABLE=2]="TARGET_UNREACHABLE"}(vt||(vt={}));class es{constructor(e,t,s){this.entityType=null,this.currentPath=null,this.sceneMgr=e,this.entityMgr=t,this.entityType=s}moveToClosestTarget(e,t){if(!e||e.length<1)return vt.TARGET_UNREACHABLE;if(!this.currentPath||!e.some((e=>e.targetLocation.equals(this.currentPath.target.targetLocation)))){const t=e.map((e=>this.findPathToTarget(e))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq));if(this.currentPath=t.length>0?t[0]:null,!this.currentPath)return vt.TARGET_UNREACHABLE}const s=this.determineStep(t);return s.targetReached?(this.sceneEntity.headTowards(this.currentPath.target.getFocusPoint()),vt.TARGET_REACHED):(this.sceneEntity.headTowards(this.currentPath.firstLocation),this.sceneEntity.position.add(s.vec),this.sceneEntity.changeActivity(this.getRouteActivity()),vt.MOVED)}findPathToTarget(e){return new at(e,e.targetLocation)}determineStep(e){const t=this.sceneMgr.getFloorPosition(this.currentPath.firstLocation);t.y+=this.sceneEntity.floorOffset;const s=new Qt(t.sub(this.sceneEntity.position)),i=s.vec.lengthSq(),r=this.getSpeed()*e/l.l3,n=r*r;if(this.currentPath.locations.length>1){if(i<=n)return this.currentPath.locations.shift(),this.determineStep(e)}else i<=n+this.currentPath.target.radiusSq&&(s.targetReached=!0);return s.vec.clampLength(0,r),s}getSpeed(){var e;return(null===(e=this.sceneEntity.animation)||void 0===e?void 0:e.transcoef)||1}}class ts extends es{constructor(e,t,s){super(e,t,s),this.level=0,this.job=null,this.followUpJob=null,this.carries=null,this.inBeam=!1,this.beamUpAnimator=null}pickupItem(e){this.carries=e,this.sceneEntity.pickupEntity(e.sceneEntity)}dropItem(){this.carries&&(this.sceneEntity.dropEntity(),this.carries=null)}setJob(e,t=null){this.job!==e&&this.stopJob(),this.job=e,this.job&&this.job.assign(this),this.followUpJob=t,this.followUpJob&&this.followUpJob.assign(this)}stopJob(){var e;null===(e=this.workAudio)||void 0===e||e.stop(),this.workAudio=null,this.dropItem(),this.job&&(this.job.unAssign(this),this.followUpJob&&this.followUpJob.unAssign(this),this.job=null,this.followUpJob=null,this.sceneEntity.changeActivity())}deselect(){this.sceneEntity.selectionFrame.visible=!1,this.selected=!1}isSelectable(){return!this.selected&&!this.inBeam}isInSelection(){return this.isSelectable()||this.selected}select(){return!!this.isSelectable()&&(this.sceneEntity.selectionFrame.visible=!0,this.selected=!0,this.sceneEntity.changeActivity(),!0)}removeFromScene(){this.sceneEntity.removeFromScene()}beamUp(){this.stopJob(),this.inBeam=!0,this.beamUpAnimator=new St(this)}moveToClosestTarget(e,t){var s;const i=super.moveToClosestTarget(e,t);return this.job.setActualWorkplace(null===(s=this.currentPath)||void 0===s?void 0:s.target),i===vt.TARGET_UNREACHABLE&&(console.log("Entity could not move to job target, stopping job"),this.stopJob()),i}update(e){var t;this.work(e),this.sceneEntity.update(e),null===(t=this.beamUpAnimator)||void 0===t||t.update(e)}work(e){if(this.job&&!this.selected&&!this.inBeam)if(this.job.jobState!==F.INCOMPLETE)this.stopJob();else{const t=this.job.getCarryItem();if(t&&this.carries!==t)this.dropItem(),this.moveToClosestTarget(t.getPositionAsPathTargets(),e)&&this.sceneEntity.changeActivity(he.Collect,(()=>{this.pickupItem(t)}));else if(this.moveToClosestTarget(this.job.getWorkplaces(),e)===vt.TARGET_REACHED)if(this.job.isReadyToComplete()){const e=this.job.getWorkActivity()||this.sceneEntity.getDefaultActivity();this.workAudio||e!==he.Drill||(this.workAudio=this.sceneEntity.playPositionalAudio(p.d[p.d.SFX_Drill],!0)),this.sceneEntity.changeActivity(e,(()=>{this.completeJob()}),this.job.getWorkDuration(this))}else this.sceneEntity.changeActivity()}}completeJob(){var e,t,s;null===(e=this.workAudio)||void 0===e||e.stop(),this.workAudio=null,null===(t=this.job)||void 0===t||t.onJobComplete(),this.sceneEntity.changeActivity(),(null===(s=this.job)||void 0===s?void 0:s.jobState)!==F.INCOMPLETE&&(this.job&&this.job.unAssign(this),this.job=this.followUpJob,this.followUpJob=null)}canDrill(e){var t;return((null===(t=this.stats[e.surfaceType.statsDrillName])||void 0===t?void 0:t[this.level])||0)>0}}class ss extends ts{constructor(e,t,s,i){super(e,t,s),this.driver=null,this.callManJob=null,this.sceneEntity=new $t(e,i),this.sceneEntity.flipXAxis()}findPathToTarget(e){return this.sceneMgr.terrain.findDrivePath(this.sceneEntity.position2D.clone(),e)}beamUp(){this.dropDriver(),super.beamUp();const e=this.sceneEntity.surfaces[0];for(let t=0;t<this.stats.CostOre;t++)this.entityMgr.placeMaterial(new Qe(this.sceneMgr,this.entityMgr),e.getRandomPosition());for(let t=0;t<this.stats.CostCrystal;t++)this.entityMgr.placeMaterial(new Ke(this.sceneMgr,this.entityMgr),e.getRandomPosition());T.publishEvent(new q)}setJob(e,t=null){this.driver&&super.setJob(e,t)}addDriver(e){this.driver=e,this.driver.vehicle=this,this.driver.sceneEntity.position.set(0,0,0),this.driver.sceneEntity.setHeading(0),this.driver.sceneEntity.changeActivity(this.getDriverActivity()),(this.sceneEntity.animation.driverJoint||this.sceneEntity.group).add(this.driver.sceneEntity.group),this.stats.EngineSound&&!this.engineSound&&(this.engineSound=this.sceneEntity.playPositionalAudio(this.stats.EngineSound,!0)),this.selected&&T.publishEvent(new U(this.entityMgr))}dropDriver(){var e;this.stopJob(),this.driver&&((this.sceneEntity.animation.driverJoint||this.sceneEntity.group).remove(this.driver.sceneEntity.group),this.driver.vehicle=null,this.driver.sceneEntity.position.copy(this.sceneEntity.position),this.driver.sceneEntity.setHeading(this.sceneEntity.getHeading()),this.driver.sceneMgr.scene.add(this.driver.sceneEntity.group),this.driver.sceneEntity.changeActivity(),this.driver=null,null===(e=this.engineSound)||void 0===e||e.stop(),this.engineSound=null,this.selected&&T.publishEvent(new U(this.entityMgr)))}getRequiredTraining(){return P.DRIVER}getDriverActivity(){return he.Stand}getRouteActivity(){return oe.Stand}isPrepared(e){return!1}}class is extends ss{constructor(e,t){super(e,t,M.BULLDOZER,"Vehicles/Bulldozer/Bulldozer.ae")}get stats(){return bt.stats.Bulldozer}}class rs extends ss{constructor(e,t){super(e,t,M.HOVERBOARD,"Vehicles/Hoverboard/Hoverboard.ae")}get stats(){return bt.stats.Hoverboard}getDriverActivity(){return he.Hoverboard}}class ns extends ss{constructor(e,t){super(e,t,M.LARGE_CAT,"Vehicles/LargeCat/LargeCat.ae")}get stats(){return bt.stats.LargeCat}getRequiredTraining(){return P.SAILOR}findPathToTarget(e){return this.sceneMgr.terrain.findSwimPath(this.sceneEntity.position2D.clone(),e)}}class as extends ss{constructor(e,t){super(e,t,M.LARGE_DIGGER,"Vehicles/LargeDigger/LargeDigger.ae")}get stats(){return bt.stats.LargeDigger}}class os extends ss{constructor(e,t){super(e,t,M.LARGE_MLP,"Vehicles/LMLP/LMLP.ae")}get stats(){return bt.stats.LargeMLP}}class ls extends ss{constructor(e,t){super(e,t,M.SMALL_CAT,"Vehicles/SmallCat/SmallCat.ae")}get stats(){return bt.stats.SmallCat}getRequiredTraining(){return P.SAILOR}findPathToTarget(e){return this.sceneMgr.terrain.findSwimPath(this.sceneEntity.position2D.clone(),e)}}class hs extends ss{constructor(e,t){super(e,t,M.SMALL_DIGGER,"Vehicles/SmallDigger/SmallDigger.ae")}get stats(){return bt.stats.SmallDigger}}class cs extends ss{constructor(e,t){super(e,t,M.SMALL_HELI,"Vehicles/SmallHeli/SmallHeli.ae")}get stats(){return bt.stats.SmallHeli}getRequiredTraining(){return P.PILOT}getDriverActivity(){return he.SMALLheli}findPathToTarget(e){return this.sceneMgr.terrain.findFlyPath(this.sceneEntity.position2D.clone(),e)}}class us extends ss{constructor(e,t){super(e,t,M.SMALL_MLP,"Vehicles/SMLP/SMLP.ae")}get stats(){return bt.stats.Smallmlp}}class ds extends ss{constructor(e,t){super(e,t,M.SMALL_TRUCK,"Vehicles/SmallTruck/SmallTruck.ae")}get stats(){return bt.stats.SmallTruck}getDriverActivity(){return he.SMALLTRUCK}}class gs extends ss{constructor(e,t){super(e,t,M.WALKER_DIGGER,"Vehicles/WalkerBody/WalkerBody.ae"),this.walkerLegs=bt.getAnimationEntityType("Vehicles/WalkerLegs/WalkerLegs.ae",e.listener)}get stats(){return bt.stats.WalkerDigger}changeActivity(e=this.getDefaultActivity(),t=null,s=null){this.sceneEntity.changeActivity(e,t,s)}getDefaultActivity(){return Xt.Route}}class ps{constructor(e,t,s,i){this.buildingCycleIndex=0,T.registerEventListener(S.Z.COMMAND_PICK_TOOL,(e=>{s.selection.raiders.forEach((t=>{t.hasTool(e.tool)||t.setJob(new Me(s,e.tool,null))})),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_CREATE_POWER_PATH,(()=>{new jt(s,s.selection.surface)})),T.registerEventListener(S.Z.COMMAND_MAKE_RUBBLE,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.makeRubble(2),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_PLACE_FENCE,(()=>{var e;const t=s.selection.surface;t&&(null===(e=s.getClosestBuildingByType(t.getCenterWorld(),M.TOOLSTATION))||void 0===e||e.spawnFence(t)),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_CHANGE_RAIDER_SPAWN_REQUEST,(t=>{t.increase?e.requestedRaiders++:e.requestedRaiders--,T.publishEvent(new se(e.requestedRaiders))})),T.registerEventListener(S.Z.COMMAND_CREATE_DRILL_JOB,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.createDrillJob(),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_CREATE_REINFORCE_JOB,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.createReinforceJob(),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_CREATE_DYNAMITE_JOB,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.createDynamiteJob(),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_CANCEL_SURFACE_JOBS,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.cancelJobs(),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_CREATE_CLEAR_RUBBLE_JOB,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.createClearRubbleJob(),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_UPGRADE_BUILDING,(()=>{var e;null===(e=s.selection.building)||void 0===e||e.upgrade()})),T.registerEventListener(S.Z.COMMAND_BUILDING_BEAMUP,(()=>{var e;null===(e=s.selection.building)||void 0===e||e.beamUp()})),T.registerEventListener(S.Z.COMMAND_CHANGE_BUILDING_POWER_STATE,(e=>{var t;null===(t=s.selection.building)||void 0===t||t.setPowerSwitch(e.state)})),T.registerEventListener(S.Z.COMMAND_RAIDER_EAT,(()=>{s.selection.raiders.forEach((e=>!e.isDriving()&&e.setJob(new Zt))),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_RAIDER_UPGRADE,(()=>{s.selection.raiders.forEach((e=>{const t=s.getClosestBuildingByType(e.sceneEntity.position.clone(),M.TOOLSTATION);t&&e.level<e.stats.Levels&&e.setJob(new Yt(t))})),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_RAIDER_BEAMUP,(()=>{s.selection.raiders.forEach((e=>e.beamUp()))})),T.registerEventListener(S.Z.COMMAND_TRAIN_RAIDER,(e=>(s.selection.raiders.forEach((t=>!t.hasTraining(e.training)&&t.setJob(new Kt(s,e.training,null)))),T.publishEvent(new W),!0))),T.registerEventListener(S.Z.COMMAND_RAIDER_DROP,(()=>{s.selection.raiders.forEach((e=>e.dropItem()))})),T.registerEventListener(S.Z.COMMAND_SELECT_BUILD_MODE,(e=>{t.setBuildModeSelection(qt.createBuildingFromType(e.entityType,t,s))})),T.registerEventListener(S.Z.COMMAND_CANCEL_BUILD_MODE,(()=>{t.setBuildModeSelection(null)})),T.registerEventListener(S.Z.COMMAND_CANCEL_CONSTRUCTION,(()=>{var e;null===(e=s.selection.surface.site)||void 0===e||e.cancelSite()})),T.registerEventListener(S.Z.COMMAND_REQUEST_VEHICLE_SPAWN,(e=>{console.log("Vehicle spawn requested for: "+M[e.vehicle]);const i=s.getBuildingsByType(M.TELEPORT_PAD).filter((e=>!e.teleport.operating));if(i.length>0){const r=i.random(),n=class{static createVehicleFromType(e,t,s){switch(e){case M.HOVERBOARD:return new rs(t,s);case M.SMALL_DIGGER:return new hs(t,s);case M.SMALL_TRUCK:return new ds(t,s);case M.SMALL_CAT:return new ls(t,s);case M.SMALL_MLP:return new us(t,s);case M.SMALL_HELI:return new cs(t,s);case M.BULLDOZER:return new is(t,s);case M.WALKER_DIGGER:return new gs(t,s);case M.LARGE_MLP:return new os(t,s);case M.LARGE_DIGGER:return new as(t,s);case M.LARGE_CAT:return new ns(t,s);default:throw"Unexpected vehicle type: "+M[e]}}}.createVehicleFromType(e.vehicle,t,s);n.sceneEntity.addToScene(r.primaryPathSurface.getCenterWorld2D(),r.sceneEntity.getHeading()),n.sceneEntity.changeActivity(Xt.TeleportIn,(()=>{n.sceneEntity.changeActivity(),n.sceneEntity.createPickSphere(n.stats.PickSphere,n),s.vehicles.push(n)}))}T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_VEHICLE_GET_MAN,(()=>{s.selection.vehicles.forEach((e=>{e.callManJob||e.driver||T.publishEvent(new ee(new zt(e)))})),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_VEHICLE_BEAMUP,(()=>{s.selection.vehicles.forEach((e=>e.beamUp())),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_VEHICLE_DRIVER_GET_OUT,(()=>{s.selection.vehicles.forEach((e=>e.dropDriver())),T.publishEvent(new W)})),T.registerEventListener(S.Z.COMMAND_CHANGE_PRIORITY_LIST,(e=>{T.publishEvent(new K(e.priorityList))})),T.registerEventListener(S.Z.COMMAND_CAMERA_CONTROL,(e=>{if(e.zoom){const t=new WheelEvent("wheel",{deltaY:5*e.zoom});i.dispatchEvent(t),i.ownerDocument.dispatchEvent(t)}if(e.cycleBuilding){this.buildingCycleIndex=(this.buildingCycleIndex+1)%s.buildings.length;const e=s.buildings[this.buildingCycleIndex].primarySurface.getCenterWorld(),i=t.camera.position.clone().sub(t.controls.target);t.camera.position.copy(e.clone().add(i)),t.controls.target.copy(e),t.controls.update()}e.rotationIndex>=0&&console.log("TODO implement rotate camera: "+["left","up","right","down"][e.rotationIndex])}))}}!function(e){e[e.QUIT=0]="QUIT",e[e.COMPLETE=1]="COMPLETE",e[e.FAILED=2]="FAILED"}(Et||(Et={}));class ys{constructor(e,t,s){this.state=e,this.numBuildings=t.buildings.length,this.numRaiders=t.raiders.length,this.numMaxRaiders=t.getMaxRaiders(),this.gameTimeSeconds=Math.round(s.elapsedGameTimeMs/1e3)}}class ms extends oe{}ms.Route=new ms("Activity_Route");class fs extends ms{}fs.TurnLeft=new fs("Activity_TurnLeft"),fs.TurnRight=new fs("Activity_TurnRight"),fs.Emerge=new fs("Activity_Emerge"),fs.Enter=new fs("Activity_Enter"),fs.Gather=new fs("Activity_Gather"),fs.Carry=new fs("Activity_Carry"),fs.Throw=new fs("Activity_Throw"),fs.CarryTurnLeft=new fs("Activity_CarryTurnLeft"),fs.CarryTurnRight=new fs("Activity_CarryTurnRight"),fs.CarryStand=new fs("Activity_CarryStand"),fs.Repair=new fs("Activity_Repair"),fs.Crumble=new fs("Activity_Crumble"),fs.Stamp=new fs("Activity_Stamp"),fs.Rest=new fs("Activity_Rest"),fs.ThrowMan=new fs("Activity_ThrowMan"),fs.Eat=new fs("Activity_Eat"),fs.HitHard=new fs("Activity_HitHard"),fs.Unpowered=new fs("Activity_Unpowered"),fs.WakeUp=new fs("Activity_WakeUp");class vs extends es{constructor(e,t,s,i){super(e,t,s),this.target=[],this.sceneEntity=new Ye(e,i)}removeFromScene(){this.sceneEntity.removeFromScene()}getRouteActivity(){return ms.Route}}class Es extends vs{constructor(e,t){super(e,t,M.BAT,"Creatures/bat/bat.ae"),this.sceneEntity.floorOffset=l.pM/2}get stats(){return bt.stats.Bat}update(e){this.sceneEntity.update(e),(this.target.length<1||this.moveToClosestTarget(this.target,e)===vt.TARGET_REACHED)&&(this.target=[this.findTarget()])}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.sceneEntity.position.clone()).getCenterWorld();for(let s=0;s<20;s++){const s=(0,a.$u)(t.x-(l.pM+l.pM/2),t.x+l.pM+l.pM/2),i=(0,a.$u)(t.z-l.pM/2,t.z+l.pM/2);if(e.getSurfaceFromWorldXZ(s,i).surfaceType.floor)return new ce(new h.FM8(s,i))}return console.warn("Could not find a target"),null}onDeath(){this.removeFromScene(),this.entityMgr.bats.remove(this)}}class ws extends vs{constructor(e,t){super(e,t,M.ICE_MONSTER,"Creatures/IceMonster/IceMonster.ae")}}class bs extends vs{constructor(e,t){super(e,t,M.LAVA_MONSTER,"Creatures/LavaMonster/LavaMonster.ae")}}class Ms extends vs{constructor(e,t){super(e,t,M.ROCK_MONSTER,"Creatures/RMonster/RMonster.ae")}}class Ss extends vs{constructor(e,t){super(e,t,M.SMALL_SPIDER,"Creatures/SpiderSB/SpiderSB.ae"),this.idleTimer=0,this.sceneEntity.floorOffset=1}get stats(){return bt.stats.SmallSpider}update(e){this.sceneEntity.update(e),this.idleTimer-=e,this.idleTimer>0||(this.target.length>0&&this.moveToClosestTarget(this.target,e)===vt.MOVED?this.sceneMgr.terrain.getSurfaceFromWorld(this.sceneEntity.position).surfaceType.floor||this.onDeath():(this.sceneEntity.changeActivity(),this.target=[this.findTarget()],this.idleTimer=1e3+(0,a.sZ)(9e3)))}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.sceneEntity.position.clone()).getCenterWorld();for(let s=0;s<20;s++){const s=(0,a.$u)(t.x-(l.pM+l.pM/2),t.x+l.pM+l.pM/2),i=(0,a.$u)(t.z-l.pM/2,t.z+l.pM/2),r=e.getSurfaceFromWorldXZ(s,i).surfaceType;if(r!==R.WATER&&r!==R.LAVA)return new ce(new h.FM8(s,i))}return console.warn("Could not find a target"),null}onDeath(){this.removeFromScene(),this.entityMgr.spiders.remove(this)}}class Ts extends ts{constructor(e,t){super(e,t,M.PILOT),this.tools=new Map,this.trainings=new Map,this.slipped=!1,this.hungerLevel=1,this.vehicle=null,this.tools.set(L.DRILL,!0),this.sceneEntity=new $t(e,"mini-figures/pilot/pilot.ae")}get stats(){return bt.stats.Pilot}findPathToTarget(e){return this.sceneMgr.terrain.findWalkPath(this.sceneEntity.position2D.clone(),e)}isSelectable(){return super.isSelectable()&&!this.slipped&&!this.vehicle}isDriving(){return!!this.vehicle}getSpeed(){return super.getSpeed()*this.stats.RouteSpeed[this.level]*(this.isOnPath()?this.stats.PathCoef:1)}isOnPath(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.sceneEntity.position).isPath()}isOnRubble(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.sceneEntity.position).hasRubble()}getRouteActivity(){return this.isOnRubble()?this.carries?he.CarryRubble:he.routeRubble:this.carries?he.Carry:he.Route}moveToClosestTarget(e,t){const s=super.moveToClosestTarget(e,t);return s===vt.MOVED&&this.entityMgr.spiders.some((e=>{if(this.sceneEntity.position.distanceToSquared(e.sceneEntity.position)<l.pR)return this.slip(),e.onDeath(),!0})),s}slip(){(0,a.$u)(0,100)<10&&this.stopJob(),this.dropItem(),this.slipped=!0,this.sceneEntity.changeActivity(he.Slip,(()=>{this.slipped=!1}))}work(e){this.slipped||super.work(e)}beamUp(){super.beamUp(),T.publishEvent(new V(this.entityMgr))}removeFromScene(){super.removeFromScene(),this.entityMgr.raiders.remove(this)}hasTool(e){return!e||this.tools.has(e)}hasTraining(e){return!e||this.trainings.has(e)}addTool(e){this.tools.set(e,!0)}addTraining(e){this.trainings.set(e,!0)}isPrepared(e){return this.hasTool(e.getRequiredTool())&&this.hasTraining(e.getRequiredTraining())}canDrill(e){return super.canDrill(e)&&this.hasTool(L.DRILL)}}var Ls,As,Rs,Cs=h.M8C.degToRad;class Ps{constructor(e,t){this.jobs=[],this.priorityIndexList=[],this.priorityList=[],this.assignJobsTimer=0,this.checkClearRubbleTimer=0,this.sceneMgr=e,this.entityMgr=t,T.registerEventListener(S.Z.JOB_CREATE,(e=>{this.jobs.push(e.job)})),T.registerEventListener(S.Z.JOB_DELETE,(e=>{e.job.cancel()})),T.registerEventListener(S.Z.UPDATE_PRIORITIES,(e=>{this.priorityList=[...e.priorityList],this.priorityIndexList=this.priorityList.map((e=>e.key))}))}update(e){this.assignJobs(e),this.checkUnclearedRubble(e)}assignJobs(e){if(this.assignJobsTimer+=e,this.assignJobsTimer<l.$I)return;this.assignJobsTimer%=l.$I;const t=[];this.jobs=this.jobs.filter((e=>{const s=e.jobState===F.INCOMPLETE;return s&&e.fulfiller.length<1&&this.isEnabled(e.getPriorityIdentifier())&&t.push(e),s})),t.sort(((e,t)=>Math.sign(this.getPriority(e)-this.getPriority(t))));const s=this.entityMgr.raiders.filter((e=>!e.job&&!e.inBeam));t.forEach((e=>{let t=null,i=null,r=null,n=null,a=null,o=null,l=null;const h=e.getRequiredTool();let c=null,u=null,d=null,g=null;const p=e.getRequiredTraining();s.forEach(((s,y)=>{const m=s.hasTool(h),f=s.hasTraining(p);if(m&&f){const n=e.getWorkplaces().map((e=>s.findPathToTarget(e))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(n){const e=n.lengthSq;(null===r||e<r)&&(t=s,i=y,r=e)}}else if(m){const e=this.entityMgr.getTrainingSites(p).map((e=>s.findPathToTarget(e.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const t=e.lengthSq;(null===d||t<d)&&(c=s,u=y,d=t,g=e.target.building)}}else{const e=this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((e=>s.findPathToTarget(e.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const t=e.lengthSq;(null===o||t<o)&&(n=s,a=y,o=t,l=e.target.building)}}})),t?(t.setJob(e),s.splice(i,1)):n?(n.setJob(new Me(this.entityMgr,h,l),e),s.splice(a,1)):c&&(c.setJob(new Kt(this.entityMgr,p,g),e),s.splice(u,1))})),s.forEach((e=>{const t=e.sceneEntity.surfaces.map((e=>e.site)).filter((e=>!!e));t.length>0&&e.setJob(new Se(t[0].getWalkOutSurface().getRandomPosition()))}))}checkUnclearedRubble(e){this.checkClearRubbleTimer+=e,this.checkClearRubbleTimer<l.p$||(this.checkClearRubbleTimer%=l.p$,this.isEnabled(_.aiPriorityClearing)&&this.entityMgr.raiders.forEach((e=>{if(e.job)return;const t=e.sceneEntity.surfaces[0];for(let s=0;s<10;s++)for(let i=t.x-s;i<=t.x+s;i++)for(let r=t.y-s;r<=t.y+s;r++){const t=this.sceneMgr.terrain.getSurfaceOrNull(i,r);if(!(null==t?void 0:t.hasRubble())||!(null==t?void 0:t.discovered))continue;const s=t.createClearRubbleJob();if(!s||s.fulfiller.length>0)continue;const n=s.getRequiredTool();if(e.hasTool(n))return void e.setJob(s);{const t=this.entityMgr.getBuildingsByType(M.TOOLSTATION).map((t=>e.findPathToTarget(t.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(t)return void e.setJob(new Me(this.entityMgr,n,t.target.building),s)}}})))}getPriority(e){return this.priorityIndexList.indexOf(e.getPriorityIdentifier())}isEnabled(e){var t;return!!(null===(t=this.priorityList.find((t=>t.key===e)))||void 0===t?void 0:t.enabled)}}class Is{constructor(e,t=!1){this.debug=!1,this.onLevelEnd=null,this.timer=0,this.registers=new Array(8).fill(0),this.timers=new Array(4).fill(0),this.scriptLines=[],this.statements=[],this.macrosByName={},this.labelsByName={},this.halted=!1,this.programCounter=0,this.messages=[],this.messagePermit=null,this.entityMgr=e,this.debug=t}update(e){for(this.timer+=e;this.timer>=2e3;this.timer-=2e3)this.execute()}checkRegister(e){const t=parseInt(e);if(isNaN(t)||t<0||t>this.registers.length)throw new Error("Invalid register ("+e+") provided");return t}checkRegisterValue(e){const t=parseInt(e);if(isNaN(t))throw new Error("Invalid register value ("+e+") provided");return t}getR(e){return e=this.checkRegister(e),this.registers[e]}setR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]=t}addR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]+=t}setTimer(e,t){const s=parseInt(t);if(isNaN(s))throw new Error("Can't set timer to NaN value: "+t);this.timers[e]=(new Date).getTime()+s}getTimer(e){return(new Date).getTime()-this.timers[e]}setLevelCompleted(){console.log("Nerp runner marks level as complete"),this.halted=!0,this.onLevelEnd(Et.COMPLETE)}setLevelFail(){console.log("NerpRunner marks level as failed; at line: "+this.scriptLines[this.programCounter]),this.halted=!0,this.onLevelEnd(Et.FAILED)}setTutorialFlags(e){0!==e&&console.warn("NERP: setTutorialFlags not yet implemented",e)}setMessagePermit(e){this.messagePermit=!e}setBuildingsUpgradeLevel(e,t){this.entityMgr.buildings.forEach((s=>{s.entityType===e&&s.setLevel(t)}))}setToolStoreLevel(e){this.setBuildingsUpgradeLevel(M.TOOLSTATION,e)}setTeleportPadLevel(e){this.setBuildingsUpgradeLevel(M.TELEPORT_PAD,e)}setPowerStationLevel(e){this.setBuildingsUpgradeLevel(M.POWER_STATION,e)}setBarracksLevel(e){this.setBuildingsUpgradeLevel(M.BARRACKS,e)}getToolStoresBuilt(){return this.entityMgr.buildings.count((e=>e.entityType===M.TOOLSTATION))}getMinifiguresOnLevel(){return this.entityMgr.raiders.length}getCrystalsCurrentlyStored(){return o.numCrystal}getObjectiveSwitch(){return!1}setMessageTimerValues(e,t,s){}getMessageTimer(){return 0}cameraUnlock(){}setMessage(e,t){if(!this.messagePermit)return;if(0===e)return;const s=this.messages[e];console.log(s.txt)}setCameraGotoTutorial(e){}getTutorialBlockIsGround(e){return 0}getTutorialBlockIsPath(e){return 0}getUnitAtBlock(e){return 0}getOxygenLevel(){return 100*o.airLevel}getObjectiveShowing(){return!1}addPoweredCrystals(){}disallowAll(){}getPoweredPowerStationsBuilt(){return this.entityMgr.buildings.count((e=>e.isUsable()&&e.entityType===M.POWER_STATION))}getPoweredBarracksBuilt(){return this.entityMgr.buildings.count((e=>e.isUsable()&&e.entityType===M.BARRACKS))}getRecordObjectAtTutorial(){}getHiddenObjectsFound(){return 0}getLevel1PowerStationsBuilt(){return this.entityMgr.buildings.count((e=>e.entityType===M.POWER_STATION&&e.level>=1))}getRandom100(){return(0,a.sZ)(100)}getSlugsOnLevel(){return 0}generateSlug(){console.warn("Slugs not yet implemented")}callMethod(e,t){if("Stop"===e)throw"Stop";if("TRUE"===e)return!0;if("FALSE"===e)return!1;const s=e.match(/^SetR([0-7])$/);if(s)return this.setR(s[1],t[0]);const i=e.match(/^AddR([0-7])$/);if(i)return this.addR(i[1],t[0]);const r=e.match(/^GetR([0-7])$/);if(r)return this.getR(r[1]);const n=e.match(/^SetTimer([0-3])$/);if(n)return this.setTimer(n[1],t[0]);const a=e.match(/^GetTimer([0-3])$/);if(a)return this.getTimer(a[1]);const o=e.toLowerCase(),l=Object.getOwnPropertyNames(Is.prototype).find((e=>e.toLowerCase()===o));if(l)return this[l].apply(this,t);throw new Error("Undefined method: "+e)}conditional(e,t){const s=this.executeStatement(e);this.debug&&console.log("Condition evaluated to "+s),s&&this.executeStatement(t)}executeStatement(e){if(e.invoke){const t="conditional"!==e.invoke?e.args.map((e=>this.executeStatement(e))):e.args,s=this.callMethod(e.invoke,t);return void 0!==s&&this.debug&&console.log("Method returned: "+s),s}if(e.comparator){const t=this.executeStatement(e.left),s=this.executeStatement(e.right);if("="===e.comparator)return t===s;if("!="===e.comparator)return t!==s;if("<"===e.comparator)return t<s;if(">"===e.comparator)return t>s;throw console.log(e),new Error("Unknown comparator: "+e.comparator)}if(!isNaN(e))return e;if(!e.jump)throw console.log(e),new Error("Unknown expression in line "+this.programCounter+": "+e);if(this.programCounter=this.labelsByName[e.jump],void 0===this.programCounter)throw new Error("Label '"+e.jump+"' is unknown!");this.debug&&console.log("Jumping to label '"+e.jump+"' in line "+this.programCounter)}execute(e=!1){if(this.debug=e,!this.halted)try{for(this.debug&&(console.log("Executing following script\n"+this.scriptLines.join("\n")),console.log("Registers: "+this.registers)),this.programCounter=0;this.programCounter<this.statements.length;this.programCounter++){const e=this.statements[this.programCounter];this.debug&&(console.log(this.programCounter+": "+this.scriptLines[this.programCounter]),console.log(e)),e.label||this.executeStatement(e)}}catch(e){if("Stop"===e)return;console.error(e),console.error("FATAL ERROR! Script execution failed! You can NOT win anymore!"),this.halted=!0}}}class xs{static parse(e,t){const s=new Is(e),i=t.split("\n").map((e=>e.split("//")[0].trim().split(";")[0].trim().replace(/_/g,"").replace(/\bTRUE \? /,"").replace(/[{}]/g,"")));for(let t=0;t<i.length;t++){const r=i[t];if(!(r.length<1))if(r.startsWith("#include ")){const t=r.replace(/^#include /,"").trim().slice(1,-1);if("nerpdef.h"===t)continue;const i=xs.parse(e,bt.getResource("Levels/"+t));if(!i||!i.scriptLines||i.scriptLines.length<1)throw"Can't include unknown nerp script: "+r;s.scriptLines=s.scriptLines.concat(i.scriptLines),s.macrosByName=Object.assign({},s.macrosByName,i.macrosByName)}else if(r.startsWith("#define ")){const e=r.replace(/^#define /,"").split(" "),n=[e.splice(1).join(" ").replace(/\\$/,"").trim()];let a=r,o=!1;for(;a.endsWith("\\")&&t<i.length-1;){t++,a=i[t].trim();const e=a.replace(/\\$/,"").trim();e.length>0&&(o?(o=!1,n[n.length-1]+=e):n.push(e)),a.match(/:\\$/)&&(o=!0)}const l=e[0].split("(");s.macrosByName[l[0]]={args:l[1].replace(/\)$/,"").split(","),lines:n}}else s.scriptLines=s.scriptLines.concat(this.replaceMacros(s.macrosByName,r))}for(let e=0;e<s.scriptLines.length;e++){const t=s.scriptLines[e];s.statements[e]=t.replace(/\(\)/g,"").split(" ? ");const i=t.match(/(\S+):/);if(2===s.statements[e].length)s.statements[e]={invoke:"conditional",args:[this.preProcess(s.statements[e][0]),this.preProcess(s.statements[e][1])]};else if(i){const t=i[1].toLowerCase();s.labelsByName[t]=e,s.statements[e]={label:t}}else{if(1!==s.statements[e].length)throw"Can't deal with line: "+t;s.statements[e]=this.preProcess(s.statements[e][0])}}return s}static replaceMacros(e,t){const s=t.split("("),i=e[s[0]];if(i){const r=s.splice(1).join("(").slice(0,-1).split(",");if(r.length!==i.args.length)throw"Invalid number of args provided for macro in line "+t;const n=[];return i.lines.forEach((t=>{for(let e=0;e<r.length;e++)t=t.replace(new RegExp("\\b"+i.args[e]+"\\b"),r[e]);n.push(...this.replaceMacros(e,t))})),n}return[t]}static preProcess(e){e=e.trim().replace(/^_/,"");const t=parseInt(e);if(!isNaN(t))return t;const s=e.split(/ (=) | (!=) | (>) | (<) /).filter((e=>void 0!==e)),i=e.match(/^(.+)\((.+)\)$/),r=e.split(" "),n=e.match(/([^:]+):$/),a=e.match(/^:([^:]+)$/);if(3===s.length)return{left:this.preProcess(s[0]),comparator:s[1],right:this.preProcess(s[2])};if(i){const e=i[2].split(",").map((e=>this.preProcess(e)));return{invoke:i[1],args:e}}if(r.length>1){const e=2===r.length?[this.preProcess(r[1])]:r.splice(1).map((e=>this.preProcess(e)));return{invoke:r[0],args:e}}if(n)return{label:n[1]};if(a)return{jump:a[1].toLowerCase()};if(e.match(/[ =?><!]/))throw"Invalid expression given, parsing must have failed before somewhere";return{invoke:e,args:[]}}}class Os{constructor(){this.nerpRunner=null,this.jobSupervisor=null,this.masterTimeout=null,this.oxygenRate=0,this.elapsedGameTimeMs=0,this.requestedRaiders=0,this.spawnRaiderTimer=0,T.registerEventListener(S.Z.CAVERN_DISCOVERED,(()=>o.discoveredCaverns++)),T.registerEventListener(S.Z.PAUSE_GAME,(()=>this.pause())),T.registerEventListener(S.Z.UNPAUSE_GAME,(()=>this.unPause()))}setup(e,t){var s,i;o.totalCaverns=(null===(i=null===(s=e.reward)||void 0===s?void 0:s.quota)||void 0===i?void 0:i.caverns)||0,this.oxygenRate=e.oxygenRate,this.elapsedGameTimeMs=0,this.requestedRaiders=0,this.spawnRaiderTimer=0,this.nerpRunner=xs.parse(this.entityMgr,bt.getResource(e.nerpFile)),this.nerpRunner.messages.push(...bt.getResource(e.nerpMessageFile)),this.nerpRunner.onLevelEnd=t}pause(){this.masterTimeout=(0,a.L4)(this.masterTimeout)}unPause(){this.masterTimeout=(0,a.L4)(this.masterTimeout),this.masterTimeout=setTimeout((()=>this.update(l.Ld)),l.Ld)}update(e){const t=window.performance.now();this.elapsedGameTimeMs+=l.Ld,this.updateOxygen(e),this.checkSpawnRaiders(e),y(this.entityMgr,e),y(this.sceneMgr.terrain,e),y(this.jobSupervisor,e),y(this.nerpRunner,e);const s=window.performance.now()-t,i=l.Ld-Math.round(s);this.masterTimeout=(0,a.L4)(this.masterTimeout),this.masterTimeout=setTimeout((()=>this.update(l.Ld)),i)}updateOxygen(e){try{const t=this.entityMgr.getOxygenSum(),s=.001,i=.04,r=.001,n=t*this.oxygenRate*s*i*e*r/10,a=Math.min(1,Math.max(0,o.airLevel+n));o.airLevel!==a&&(o.airLevel=a,T.publishEvent(new G(o.airLevel)))}catch(e){console.error(e)}}checkSpawnRaiders(e){try{for(this.spawnRaiderTimer+=e;this.spawnRaiderTimer>=l.Wc;this.spawnRaiderTimer-=l.Wc)if(this.requestedRaiders>0&&!this.entityMgr.hasMaxRaiders()){const e=this.entityMgr.findTeleportBuilding(M.PILOT);if(e){this.requestedRaiders--,T.publishEvent(new se(this.requestedRaiders));const t=new Ts(this.sceneMgr,this.entityMgr);this.entityMgr.raidersInBeam.push(t),e.teleport.teleportIn(t,this.entityMgr.raiders,this.entityMgr.raidersInBeam)}}}catch(e){console.error(e)}}}class Ds{constructor(e,t){this.active=!0,this.canvas=document.createElement("canvas"),e||(this.canvas.style.background="#f0f"),t&&(this.context=this.canvas.getContext("2d",{alpha:e})),this.hide()}reset(){}setZIndex(e){this.canvas.style.zIndex=String(e)}static compareZ(e,t){var s,i,r,n;let a=(null===(i=null===(s=null==e?void 0:e.canvas)||void 0===s?void 0:s.style)||void 0===i?void 0:i.zIndex)||0;const o=(null===(n=null===(r=null==t?void 0:t.canvas)||void 0===r?void 0:r.style)||void 0===n?void 0:n.zIndex)||0;return a===o?0:a>o?-1:1}resize(e,t){this.canvas.width=e,this.canvas.height=t}redraw(){this.onRedraw&&this.isActive()&&requestAnimationFrame(this.onRedraw.bind(this,this.context))}show(){this.reset(),this.active=!0,this.canvas.style.visibility="visible",this.redraw()}hide(){this.active=!1,this.canvas.style.visibility="hidden"}isActive(){return this.active}toCanvasCoords(e,t){const s=this.canvas.getBoundingClientRect();return[e-s.left,t-s.top]}handlePointerEvent(e){return new Promise((e=>e(!1)))}handleKeyEvent(e){return new Promise((e=>e(!1)))}handleWheelEvent(e){return new Promise((e=>e(!1)))}}class Ns extends Ds{constructor(e=!0,t=!0){super(e,t),this.fixedWidth=l.Du,this.fixedHeight=l.DG,this.updateScale()}updateScale(){this.scaleX=this.canvas.width/this.fixedWidth,this.scaleY=this.canvas.height/this.fixedHeight}toScaledCoords(e,t){const[s,i]=this.toCanvasCoords(e,t);return[s/this.scaleX,i/this.scaleY].map((e=>Math.round(e)))}resize(e,t){super.resize(e,t),this.updateScale(),this.context.scale(this.scaleX,this.scaleY)}}!function(e){e[e.MAIN=0]="MAIN",e[e.MIDDLE=1]="MIDDLE",e[e.SECONDARY=2]="SECONDARY"}(Ls||(Ls={})),function(e){e[e.MOVE=0]="MOVE",e[e.DOWN=1]="DOWN",e[e.UP=2]="UP"}(As||(As={})),function(e){e[e.DOWN=0]="DOWN",e[e.UP=1]="UP"}(Rs||(Rs={}));class _s{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.key=t.key,this.code=t.code}}class Fs{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.clientX=t.clientX,this.clientY=t.clientY,this.pointerType=t.pointerType,this.button=t.button,this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.shiftKey=t.shiftKey}}class Bs{constructor(e){this.type=e.type,this.bubbles=!1,this.clientX=e.clientX,this.clientY=e.clientY,this.deltaX=e.deltaX,this.deltaY=e.deltaY,this.deltaZ=e.deltaZ,this.button=e.button,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey}}class ks{constructor(e){e.gameCanvasContainer.addEventListener("contextmenu",(t=>{e.isInRect(t)&&t.preventDefault()})),new Map([["pointermove",As.MOVE],["pointerdown",As.DOWN],["pointerup",As.UP]]).forEach(((t,s)=>{e.gameCanvasContainer.addEventListener(s,(s=>{if(!e.isInRect(s))return;s.preventDefault();const i=new Fs(t,s),r=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Ds.compareZ(e,t)));ks.publishPointerEvent(r,i)}))})),new Map([["keydown",Rs.DOWN],["keyup",Rs.UP]]).forEach(((t,s)=>{e.gameCanvasContainer.addEventListener(s,(s=>{l.Sl||s.preventDefault();const i=new _s(t,s),r=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Ds.compareZ(e,t)));ks.publishKeyEvent(r,i)}))})),e.gameCanvasContainer.addEventListener("wheel",(t=>{if(!e.isInRect(t))return;const s=new Bs(t),i=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Ds.compareZ(e,t)));ks.publishWheelEvent(i,s)}))}static publishPointerEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handlePointerEvent(t).then((s=>{s||this.publishPointerEvent(e,t)}))}static publishKeyEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handleKeyEvent(t).then((s=>{s||this.publishKeyEvent(e,t)}))}static publishWheelEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handleWheelEvent(t).then((s=>{s||this.publishWheelEvent(e,t)}))}}class Us extends Ds{constructor(e){super(!0,!1),this.currentCursor=null,this.timedCursor=null,this.cursorTimeout=null,this.activeCursor=null,e.registerEventListener(S.Z.CHANGE_CURSOR,(e=>{this.active&&this.changeCursor(e.cursor,e.timeout)}))}reset(){this.changeCursor(A.C.Pointer_Standard)}hide(){var e;super.hide(),this.canvas.style.cursor=null,this.currentCursor=null,this.timedCursor=null,this.cursorTimeout=(0,a.L4)(this.cursorTimeout),null===(e=this.activeCursor)||void 0===e||e.disableAnimation(),this.activeCursor=null}handlePointerEvent(e){if(e.eventEnum===As.MOVE&&this.sceneMgr){const[t,s]=this.toCanvasCoords(e.clientX,e.clientY),i=t/this.canvas.width*2-1,r=-s/this.canvas.height*2+1,n=new h.iMs;n.setFromCamera({x:i,y:r},this.sceneMgr.camera),this.changeCursor(this.determineCursor(n))}return super.handlePointerEvent(e)}determineCursor(e){if(this.sceneMgr.hasBuildModeSelection())return this.sceneMgr.buildMarker.lastCheck?A.C.Pointer_CanBuild:A.C.Pointer_CannotBuild;let t=e.intersectObjects(this.entityMgr.raiders.map((e=>e.sceneEntity.pickSphere)));if(t.length>0)return A.C.Pointer_Selected;if(t=e.intersectObjects(this.entityMgr.vehicles.map((e=>e.sceneEntity.pickSphere))),t.length>0){const e=t[0].object.userData;if(e&&e.hasOwnProperty("selectable")){const t=e.selectable;if(!(null==t?void 0:t.driver)&&this.entityMgr.selection.raiders.length>0)return A.C.Pointer_GetIn}return A.C.Pointer_Selected}if(t=e.intersectObjects(this.entityMgr.buildings.map((e=>e.sceneEntity.pickSphere))),t.length>0)return A.C.Pointer_Selected;if(t=e.intersectObjects(this.sceneMgr.terrain.floorGroup.children),t.length>0){const e=t[0].object.userData;if(e&&e.hasOwnProperty("surface")){const t=e.surface;if(t)return this.entityMgr.selection.raiders.some((e=>e.canDrill(t)))||this.entityMgr.selection.vehicles.some((e=>e.canDrill(t)))?t.surfaceType.cursorFulfiller:t.surfaceType.cursor}}return A.C.Pointer_Standard}changeCursor(e,t=null){if(t){this.cursorTimeout=(0,a.L4)(this.cursorTimeout),this.timedCursor!==e&&this.setCursor(e);const s=this;this.cursorTimeout=setTimeout((()=>{s.cursorTimeout=null,s.setCursor(s.currentCursor)}),t)}else if(this.currentCursor!==e){if(this.currentCursor=e,this.cursorTimeout)return;this.setCursor(e)}}setCursor(e){var t;null===(t=this.activeCursor)||void 0===t||t.disableAnimation(),this.activeCursor=bt.getCursor(e),this.activeCursor.enableAnimation(this.canvas.style)}}class Ws{constructor(){if(this.layers=[],this.width=l.Du,this.height=l.DG,this.ratio=l.Du/l.DG,this.gameCanvasContainer=document.getElementById("game-canvas-container"),this.gameCanvasContainer.focus(),this.eventMgr=new ks(this),!this.gameCanvasContainer)throw"Fatal error: game canvas container not found!";window.addEventListener("resize",(()=>this.onWindowResize())),this.onWindowResize(),this.cursorLayer=this.addLayer(new Us(this),1e3)}addLayer(e,t=0){return e.resize(this.width,this.height),e.setZIndex(t),this.layers.push(e),this.gameCanvasContainer.appendChild(e.canvas),e}redraw(){this.layers.forEach((e=>e.redraw()))}show(){this.layers.forEach((e=>e.show())),this.redraw()}hide(){this.layers.forEach((e=>e.hide()))}onWindowResize(){const e=this.gameCanvasContainer.offsetWidth,t=this.gameCanvasContainer.offsetHeight,s=Math.round(e/this.ratio);s>t?this.resize(Math.round(t*this.ratio),t):this.resize(e,s)}resize(e,t){this.width=e,this.height=t,this.layers.forEach((s=>{const i=s.canvas;s.resize(e,t),i!==s.canvas&&(this.gameCanvasContainer.removeChild(i),this.gameCanvasContainer.appendChild(s.canvas))})),this.redraw()}isInRect(e){if(this.layers.length<1)return!1;const t=this.layers[0];if(!t.isActive()||!t.canvas)return!1;const s=t.canvas.getBoundingClientRect(),i=e.clientX,r=e.clientY;return i>=s.left&&i<s.right&&r>=s.top&&r<s.bottom}publishEvent(e){T.publishEvent(e)}registerEventListener(e,t){T.registerEventListener(e,t)}}class Gs extends Ds{constructor(e){super(!1,!1),this.rightDown={x:0,y:0},this.parent=e}reset(){super.reset(),this.rightDown={x:0,y:0}}handlePointerEvent(e){const[t,s]=this.toCanvasCoords(e.clientX,e.clientY),i=t/this.canvas.width*2-1,r=-s/this.canvas.height*2+1,n=this.sceneMgr.getTerrainIntersectionPoint(i,r),a=this.sceneMgr.buildMarker;return e.eventEnum===As.MOVE?(n&&this.sceneMgr.setTorchPosition(n),a.update(n)):e.eventEnum===As.UP?e.button===Ls.MAIN?a.createBuildingSite():e.button===Ls.SECONDARY&&Math.abs(e.clientX-this.rightDown.x)+Math.abs(e.clientY-this.rightDown.y)<3&&(this.sceneMgr.hasBuildModeSelection()?this.sceneMgr.setBuildModeSelection(null):(this.entityMgr.selection.raiders.length>0||this.entityMgr.selection.vehicles.length>0)&&this.handleSecondaryClickForSelection(i,r,n)):e.eventEnum===As.DOWN&&e.button===Ls.SECONDARY&&(this.rightDown.x=e.clientX,this.rightDown.y=e.clientY),this.canvas.dispatchEvent(new PointerEvent(e.type,e)),this.canvas.ownerDocument.dispatchEvent(new PointerEvent(e.type,e)),new Promise((e=>e(!0)))}handleSecondaryClickForSelection(e,t,s){const i=this.sceneMgr.getFirstByRay(e,t);if(i.vehicle){const e=this.entityMgr.selection.raiders;if(e.length>0){const t=new zt(i.vehicle);e.some((e=>{if(e.isPrepared(t))e.setJob(t);else{const s=t.getRequiredTraining(),i=e.entityMgr.getClosestTrainingSite(e.sceneEntity.position.clone(),s);if(!i)return!1;e.setJob(new Kt(e.entityMgr,s,i),t)}return T.publishEvent(new W),!0})),T.publishEvent(new ee(t))}}else if(i.material);else if(i.surface){const e=i.surface.createDrillJob();this.entityMgr.selection.assignSurfaceJob(e);const t=i.surface.createClearRubbleJob();this.entityMgr.selection.assignSurfaceJob(t),e||t||!i.surface.isWalkable()||this.entityMgr.selection.assignMoveJob(s),this.entityMgr.selection.isEmpty()||this.publishEvent(new W)}}handleKeyEvent(e){if(l.Sl&&e.eventEnum===Rs.UP&&this.entityMgr.selection.surface)if("KeyC"===e.code)this.entityMgr.selection.surface.collapse(),this.publishEvent(new W);else if("KeyF"===e.code){const e=this.entityMgr.selection.surface;e.surfaceType.floor||this.sceneMgr.terrain.createFallIn(e,this.sceneMgr.terrain.findFallInTarget(e)),this.publishEvent(new W)}return this.canvas.dispatchEvent(new KeyboardEvent(e.type,e)),new Promise((e=>e(!0)))}handleWheelEvent(e){return this.canvas.dispatchEvent(new WheelEvent(e.type,e)),new Promise((e=>e(!0)))}publishEvent(e){var t;null===(t=this.parent)||void 0===t||t.publishEvent(e)}registerEventListener(e,t){this.parent.registerEventListener(e,t)}}var Hs=h.M8C.generateUUID;class Js extends Ds{constructor(e){super(!0,!1),this.resolveCallbackByEventId=new Map,this.worker=e,this.sendMessage({type:wt.n.INIT,resourceByName:bt.resourceByName,cfg:bt.configuration,stats:bt.stats}),this.worker.onmessage=e=>{const t=e.data;if(t.type===wt.n.RESPONSE_EVENT){const e=t;this.resolveCallbackByEventId.get(e.eventId)(e.eventConsumed),this.resolveCallbackByEventId.delete(e.eventId)}else if(t.type===wt.n.GAME_EVENT){const e=t.gameEvent;e.eventKey===S.Z.PLAY_SOUND&&u.P.playSample(e.sample),T.publishEvent(e)}else this.onMessage(t)||console.warn("Offscreen layer ignored message: "+wt.n[t.type])},T.registerWorkerListener((e=>{if(e.guiForward)try{this.sendMessage({type:wt.n.GAME_EVENT,gameEvent:e})}catch(t){console.warn("Could not send event to GUI worker: ",t,e)}}))}sendMessage(e,t){this.worker.postMessage(e,t)}reset(){this.sendMessage({type:wt.n.RESET}),this.sendMessage({type:wt.n.GAME_EVENT,gameEvent:new J(this.entityMgr)}),this.sendMessage({type:wt.n.GAME_EVENT,gameEvent:new V(this.entityMgr)}),this.sendMessage({type:wt.n.GAME_EVENT,gameEvent:new ie})}resize(e,t){const s=Number(this.canvas.style.zIndex)||0;this.canvas=document.createElement("canvas"),this.active||(this.canvas.style.visibility="hidden"),super.resize(e,t),this.setZIndex(s);const i=this.canvas.transferControlToOffscreen();this.sendMessage({type:wt.n.CANVAS,canvas:i},[i])}redraw(){this.isActive()&&this.sendMessage({type:wt.n.REDRAW})}handlePointerEvent(e){return[e.canvasX,e.canvasY]=this.toCanvasCoords(e.clientX,e.clientY),this.sendEventMessage(wt.n.EVENT_POINTER,e)}handleKeyEvent(e){return this.sendEventMessage(wt.n.EVENT_KEY,e)}handleWheelEvent(e){return[e.canvasX,e.canvasY]=this.toCanvasCoords(e.clientX,e.clientY),this.sendEventMessage(wt.n.EVENT_POINTER,e)}sendEventMessage(e,t){const s=Hs();return this.sendMessage({type:e,eventId:s,inputEvent:t}),new Promise((e=>this.resolveCallbackByEventId.set(s,e)))}}class Vs extends Js{constructor(){super(new Worker(new URL(s.p+s.u(101),s.b))),this.onOptionsShow=()=>console.log("Show options triggered")}onMessage(e){return e.type===wt.n.SHOW_OPTIONS&&(this.onOptionsShow(),!0)}setSpaceToContinue(e){this.sendMessage({type:wt.n.SPACE_TO_CONINUE,messageState:e})}}class qs extends Js{constructor(){super(new Worker(new URL(s.p+s.u(804),s.b))),this.onSetSpaceToContinue=e=>console.log("set space to continue: "+e),this.onAbortGame=()=>console.log("abort the game"),this.onRestartGame=()=>console.log("restart the game")}onMessage(e){if(e.type===wt.n.SPACE_TO_CONINUE)this.onSetSpaceToContinue(e.messageState);else if(e.type===wt.n.GAME_ABORT)this.onAbortGame();else{if(e.type!==wt.n.GAME_RESTART)return!1;this.onRestartGame()}return!0}setup(e,t){this.sendMessage({type:wt.n.OVERLAY_SETUP,objectiveText:e,objectiveBackImgCfg:t})}sendMessage(e,t){super.sendMessage(e,t)}showOptions(){this.sendMessage({type:wt.n.SHOW_OPTIONS})}}class js extends Ds{constructor(){super(!0,!0),this.selectStart=null}reset(){super.reset(),this.selectStart=null}handlePointerEvent(e){if(this.sceneMgr.hasBuildModeSelection())return new Promise((e=>e(!1)));const[t,s]=this.toCanvasCoords(e.clientX,e.clientY);if(e.eventEnum===As.DOWN){if(e.button===Ls.MAIN)return new Promise((e=>e(this.startSelection(t,s))))}else{if(e.eventEnum===As.MOVE)return new Promise((e=>e(this.changeSelection(t,s))));if(e.eventEnum===As.UP&&e.button===Ls.MAIN)return new Promise((e=>e(this.selectEntities(t,s))))}return new Promise((e=>e(!1)))}startSelection(e,t){return this.selectStart={x:e,y:t},!0}changeSelection(e,t){return!!this.selectStart&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="rgba(128, 192, 192, 0.5)",this.context.lineWidth=2,this.context.strokeRect(this.selectStart.x,this.selectStart.y,e-this.selectStart.x,t-this.selectStart.y),!0)}selectEntities(e,t){if(!this.selectStart)return!1;let s;if(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),Math.abs(e-this.selectStart.x)<5&&Math.abs(t-this.selectStart.y)<5){const i=(this.selectStart.x+e)/this.canvas.width-1,r=-(this.selectStart.y+t)/this.canvas.height+1;s=this.sceneMgr.getSelectionByRay(i,r)}else{const i=this.selectStart.x/this.canvas.width*2-1,r=-this.selectStart.y/this.canvas.height*2+1,n=e/this.canvas.width*2-1,a=-t/this.canvas.height*2+1;s=this.sceneMgr.getEntitiesInFrustum(i,r,n,a)}return this.entityMgr.selection.set(s),T.publishEvent(this.entityMgr.selection.isEmpty()?new W:new U(this.entityMgr)),this.selectStart=null,!0}}class Zs extends Ws{constructor(){super(),this.onLevelEnd=()=>console.log("Level aborted"),this.gameLayer=this.addLayer(new Gs(this),0),this.selectionLayer=this.addLayer(new js,10),this.guiLayer=this.addLayer(new Vs,20),this.overlayLayer=this.addLayer(new qs,30),this.entityMgr=new Mt,this.worldMgr=new Os,this.sceneMgr=new lt(this.gameLayer.canvas),this.sceneMgr.worldMgr=this.worldMgr,this.sceneMgr.entityMgr=this.entityMgr,this.worldMgr.sceneMgr=this.sceneMgr,this.worldMgr.entityMgr=this.entityMgr,this.worldMgr.jobSupervisor=new Ps(this.worldMgr.sceneMgr,this.worldMgr.entityMgr),this.cursorLayer.worldMgr=this.worldMgr,this.cursorLayer.sceneMgr=this.sceneMgr,this.cursorLayer.entityMgr=this.entityMgr,this.gameLayer.worldMgr=this.worldMgr,this.gameLayer.sceneMgr=this.sceneMgr,this.gameLayer.entityMgr=this.entityMgr,this.selectionLayer.worldMgr=this.worldMgr,this.selectionLayer.sceneMgr=this.sceneMgr,this.selectionLayer.entityMgr=this.entityMgr,this.guiLayer.entityMgr=this.entityMgr,this.overlayLayer.entityMgr=this.entityMgr,this.guiMgr=new ps(this.worldMgr,this.sceneMgr,this.entityMgr,this.gameLayer.canvas),this.guiLayer.onOptionsShow=()=>this.overlayLayer.showOptions(),this.overlayLayer.onSetSpaceToContinue=e=>this.guiLayer.setSpaceToContinue(e),this.overlayLayer.onAbortGame=()=>this.onLevelEnd(new ys(Et.QUIT,this.entityMgr,this.worldMgr)),this.overlayLayer.onRestartGame=()=>this.restartLevel()}startLevel(e,t){this.levelName=e,this.levelConf=t,this.setupAndStartLevel()}restartLevel(){this.hide(),o.reset(),this.setupAndStartLevel()}setupAndStartLevel(){this.entityMgr.reset(),console.log("Starting level "+this.levelName+" - "+this.levelConf.fullName),this.worldMgr.setup(this.levelConf,(e=>this.onLevelEnd(new ys(e,this.entityMgr,this.worldMgr)))),this.sceneMgr.setupScene(this.levelConf),this.guiMgr.buildingCycleIndex=0,this.guiLayer.reset();const e=(0,a.hh)(bt.getResource(this.levelConf.objectiveText),this.levelName);this.overlayLayer.setup(e.objective,this.levelConf.objectiveImage640x480),T.publishEvent(new H(this.levelConf.priorities)),class{static loadObjectList(e,t,s,i){const r=bt.getResource(e.oListFile);Object.values(r).forEach((t=>{const r=(n=t.type?t.type.toLowerCase():t.type,"Pilot".equalsIgnoreCase(n)?M.PILOT:"Toolstation".equalsIgnoreCase(n)?M.TOOLSTATION:"TeleportPad".equalsIgnoreCase(n)?M.TELEPORT_PAD:"Docks".equalsIgnoreCase(n)?M.DOCKS:"PowerStation".equalsIgnoreCase(n)?M.POWER_STATION:"Barracks".equalsIgnoreCase(n)?M.BARRACKS:"Upgrade".equalsIgnoreCase(n)?M.UPGRADE:"GEO-Dome".equalsIgnoreCase(n)?M.GEODOME:"OreRefinery".equalsIgnoreCase(n)?M.ORE_REFINERY:"GunStation".equalsIgnoreCase(n)?M.GUNSTATION:"TeleportBIG".equalsIgnoreCase(n)?M.TELEPORT_BIG:"Bat".equalsIgnoreCase(n)?M.BAT:"SmallSpider".equalsIgnoreCase(n)?M.SMALL_SPIDER:"RockMonster".equalsIgnoreCase(n)?M.ROCK_MONSTER:"IceMonster".equalsIgnoreCase(n)?M.ICE_MONSTER:"LavaMonster".equalsIgnoreCase(n)?M.LAVA_MONSTER:"Dynamite".equalsIgnoreCase(n)?M.DYNAMITE:"EletricFence".equalsIgnoreCase(n)?M.ELECTRIC_FENCE:"PowerCrystal".equalsIgnoreCase(n)?M.CRYSTAL:"Ore".equalsIgnoreCase(n)?M.ORE:"Brick".equalsIgnoreCase(n)?M.BRICK:"Barrier".equalsIgnoreCase(n)?M.BARRIER:"Hoverboard".equalsIgnoreCase(n)?M.HOVERBOARD:"SmallDigger".equalsIgnoreCase(n)?M.SMALL_DIGGER:"SamllTruck".equalsIgnoreCase(n)?M.SMALL_TRUCK:"SmallCat".equalsIgnoreCase(n)?M.SMALL_CAT:"SmallMLP".equalsIgnoreCase(n)?M.SMALL_MLP:"SmallHeli".equalsIgnoreCase(n)?M.SMALL_HELI:"Bulldozer".equalsIgnoreCase(n)?M.BULLDOZER:"WalkerDigger".equalsIgnoreCase(n)?M.WALKER_DIGGER:"LargeMLP".equalsIgnoreCase(n)?M.LARGE_MLP:"LargeDigger".equalsIgnoreCase(n)?M.LARGE_DIGGER:"LargeCat".equalsIgnoreCase(n)?M.LARGE_CAT:"TVCamera".equalsIgnoreCase(n)?M.TV_CAMERA:(console.error("Could not identify entity type from string: "+n),null));var n;const a=new h.FM8(t.xPos,t.yPos).addScalar(-1).multiplyScalar(l.pM),o=bt.cfg("BuildingTypes",t.type),c=Cs(t.heading);if(r===M.TV_CAMERA){const e=new h.FM8(6,0).rotateAround(new h.FM8(0,0),c+Math.PI/2),t=s.getFloorPosition(e.multiplyScalar(l.pM).add(a));t.y+=4*l.pM,s.camera.position.copy(t),s.controls.target.copy(s.getFloorPosition(a)),s.controls.update(),s.setTorchPosition(new h.FM8(a.x,a.y-l.pM/2))}else if(r===M.PILOT){const e=new Ts(s,i);e.sceneEntity.changeActivity(),e.sceneEntity.createPickSphere(e.stats.PickSphere,e),e.sceneEntity.addToScene(a,c-Math.PI/2),e.sceneEntity.visible?(i.raiders.push(e),T.publishEvent(new V(i))):i.raidersUndiscovered.push(e)}else if(o)console.log(t.type+" heading: "+Math.round(t.heading%360)),qt.createBuildingFromType(r,s,i).placeDown(a,-c-Math.PI,e.disableStartTeleport);else if(r===M.CRYSTAL)i.placeMaterial(new Ke(s,i),a);else if(r===M.SMALL_SPIDER){const e=new Ss(s,i);e.sceneEntity.changeActivity(),e.sceneEntity.addToScene(a,c),i.spiders.push(e)}else if(r===M.BAT){const e=new Es(s,i);e.sceneEntity.changeActivity(),e.sceneEntity.addToScene(a,c),i.bats.push(e)}else if(r===M.SMALL_DIGGER){const e=new hs(s,i);e.sceneEntity.changeActivity(),e.sceneEntity.createPickSphere(e.stats.PickSphere,e),e.sceneEntity.addToScene(a,c+Math.PI),e.sceneEntity.visible?i.vehicles.push(e):i.vehiclesUndiscovered.push(e)}else if(r===M.ICE_MONSTER){const e=new ws(s,i);e.sceneEntity.changeActivity(fs.Unpowered),e.sceneEntity.addToScene(a,c-Math.PI/2),i.rockMonsters.push(e)}else if(r===M.LAVA_MONSTER){const e=new bs(s,i);e.sceneEntity.changeActivity(fs.Unpowered),e.sceneEntity.addToScene(a,c-Math.PI/2),i.rockMonsters.push(e)}else if(r===M.ROCK_MONSTER){const e=new Ms(s,i);e.sceneEntity.changeActivity(fs.Unpowered),e.sceneEntity.addToScene(a,c-Math.PI/2),i.rockMonsters.push(e)}else console.warn("Object type "+t.type+" not yet implemented")}))}}.loadObjectList(this.levelConf,this.worldMgr,this.sceneMgr,this.entityMgr),T.publishEvent(new j(this.sceneMgr.terrain,this.sceneMgr.controls.target.clone())),this.show()}show(){super.show(),this.sceneMgr.startScene(),this.worldMgr.unPause(),this.entityMgr.start()}hide(){this.entityMgr.stop(),this.worldMgr.pause(),this.sceneMgr.disposeScene(),super.hide()}resize(e,t){var s;super.resize(e,t),null===(s=this.sceneMgr)||void 0===s||s.resize(e,t)}}function Ks(e){const t=Array.isArray(e)?e.join(","):e;return null==t?void 0:t.replace(/_/g," ")}class Ys{constructor(){this.x=0,this.y=0,this.width=0,this.height=0,this.zIndex=100,this.scrollAffected=!1,this.needsRedraw=!1,this.hover=!1,this.pressed=!1,this.actionName="",this.targetIndex=0}static compareZ(e,t){return e.zIndex===t.zIndex?0:e.zIndex>t.zIndex?-1:1}checkHover(e,t){const s=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height;return this.hover!==s&&(this.hover=s,this.needsRedraw=!0,this.onHoverChange()),this.hover||(this.pressed=!1),this.hover}onHoverChange(){}checkSetPressed(){this.hover&&(this.pressed||(this.needsRedraw=!0),this.pressed=!0)}setReleased(){this.pressed&&(this.needsRedraw=!0),this.pressed=!1}draw(e){this.needsRedraw=!1}}class zs extends Ys{constructor(e,t){super(),this.imgNormal=null,this.imgHover=null,this.imgPressed=null,this.tooltip="",this.imgNormal=bt.getImage(t.imgNormal),this.imgHover=bt.getImage(t.imgHover),this.imgPressed=bt.getImage(t.imgPressed),this.tooltip=(t.tooltip||"").replace(/_/g," "),this.width=Math.max(this.imgNormal.width,this.imgHover.width,this.imgPressed.width),this.height=Math.max(this.imgNormal.height,this.imgHover.height,this.imgPressed.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);let t=this.imgNormal;this.hover&&(t=this.imgHover),this.pressed&&(t=this.imgPressed),e.drawImage(t,this.x,this.y)}}class Xs extends Ys{constructor(e,t){super(),this.labelImgLo=null,this.labelImgHi=null,this.labelImgLo=e.loFont.createTextImage(t.label),this.labelImgHi=e.hiFont.createTextImage(t.label),this.width=Math.max(this.labelImgLo.width,this.labelImgHi.width),this.height=Math.max(this.labelImgLo.height,this.labelImgHi.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);const t=this.hover&&!this.pressed?this.labelImgHi:this.labelImgLo;e.drawImage(t,this.x,this.y)}}class $s extends Ns{constructor(e,t){super(),this.items=[],this.scrollY=0,this.scrollSpeedY=0,this.scrollInterval=null,this.screen=e,this.cfg=t,this.loFont=t.loFont?bt.getBitmapFont(t.loFont):null,this.hiFont=t.hiFont?bt.getBitmapFont(t.hiFont):null,this.menuImage=t.menuImage?bt.getImage(t.menuImage):null,this.titleImage=this.loFont.createTextImage(t.fullName),t.itemsLabel.forEach((e=>{e.label?this.items.push(new Xs(this,e)):this.items.push(new zs(this,e))})),this.items.sort(((e,t)=>Ys.compareZ(e,t))),this.onRedraw=e=>{e.drawImage(this.menuImage,0,-this.scrollY),t.displayTitle&&e.drawImage(this.titleImage,(this.fixedWidth-this.titleImage.width)/2,this.cfg.position[1]),this.items.forEach(((t,s)=>this.items[this.items.length-1-s].draw(e)))}}reset(){super.reset(),this.scrollY=0,this.scrollSpeedY=0}show(){super.show();const e=this;this.scrollInterval=setInterval((()=>{0!==e.scrollSpeedY&&e.setScrollY(e.scrollSpeedY)}),1e3/l.OK)}hide(){this.scrollInterval=(0,a.nJ)(this.scrollInterval),super.hide()}handlePointerEvent(e){if(e.eventEnum===As.MOVE){const[t,s]=this.toScaledCoords(e.clientX,e.clientY);let i=!1;if(this.items.forEach((e=>{if(i)e.hover&&(e.needsRedraw=!0),e.hover=!1,e.setReleased();else{const r=s+(e.scrollAffected?this.scrollY:0);i=e.checkHover(t,r)}})),this.cfg.canScroll){const e=100;s<e?this.setScrollSpeedY(-(e-s)):s>this.fixedHeight-e?this.setScrollSpeedY(s-(this.fixedHeight-e)):this.setScrollSpeedY(0)}}else e.eventEnum===As.DOWN?e.button===Ls.MAIN&&this.items.forEach((e=>e.checkSetPressed())):e.eventEnum===As.UP&&e.button===Ls.MAIN&&this.items.forEach((e=>{e.pressed&&(e.setReleased(),"next"===e.actionName.toLowerCase()?this.screen.showMainMenu(e.targetIndex):"selectlevel"===e.actionName.toLowerCase()?this.screen.selectLevel(e.levelKey):e.actionName&&console.warn("not implemented: "+e.actionName+" - "+e.targetIndex))}));return this.needsRedraw()&&this.redraw(),new Promise((e=>e(!1)))}setScrollSpeedY(e){this.scrollSpeedY=Math.sign(e)*Math.pow(Math.round(e/20),2)}handleWheelEvent(e){return this.cfg.canScroll?(this.setScrollY(e.deltaY),new Promise((e=>e(!0)))):new Promise((e=>e(!1)))}setScrollY(e){const t=this.scrollY;this.scrollY=Math.min(Math.max(this.scrollY+e,0),this.menuImage.height-this.fixedHeight),t!==this.scrollY&&this.redraw()}needsRedraw(){return this.items.some((e=>e.needsRedraw))}}class Qs extends Ys{constructor(e,t,s){super(),this.imgActive=null,this.imgInactive=null,this.imgCross=null,this.unlocked=!1,this.levelKey="",this.layer=e,this.actionName="selectlevel",this.levelKey=t,this.x=s.frontEndX,this.y=s.frontEndY,this.zIndex=10,this.scrollAffected=!0;const[i,r,n]=s.menuBMP;this.imgActive=bt.getImage(i),this.imgInactive=bt.getImage(r),this.imgCross=bt.getImage(n),this.width=Math.max(this.imgActive.width,this.imgInactive.width,this.imgCross.width),this.height=Math.max(this.imgActive.height,this.imgInactive.height,this.imgCross.height),this.unlocked=s.frontEndOpen,this.unlocked=!0}draw(e){super.draw(e);let t=this.imgCross;this.unlocked&&(t=this.hover?this.imgActive:this.imgInactive),e.drawImage(t,this.x,this.y-this.layer.scrollY)}}class ei extends Ys{constructor(e,t){super(),this.zIndex=50,this.context=(0,c.kr)(e.width,e.height),this.context.putImageData(e,0,0),this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}checkHover(e,t){const s=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height&&this.context.getImageData(e,t,1,1).data[3]>0;return this.hover!==s&&(this.needsRedraw=!0),this.hover=s,this.hover}draw(e){super.draw(e),e.drawImage(this.context.canvas,this.x,this.y,this.width,this.height)}}class ti extends Ys{constructor(e,t){super(),this.imgFirstLine=null,this.imgSecondLine=null,this.font=e,this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}setFirstLine(e){this.imgFirstLine=e?this.font.createTextImage(e):null}setSecondLine(e){this.imgSecondLine=e?this.font.createTextImage(e):null}draw(e){super.draw(e);const t=this.x+this.width/2,s=this.y+this.height/2;this.imgFirstLine&&e.drawImage(this.imgFirstLine,t-this.imgFirstLine.width/2,s-this.imgFirstLine.height),this.imgSecondLine&&e.drawImage(this.imgSecondLine,t-this.imgSecondLine.width/2,s)}}class si extends $s{constructor(e,t,s){super(e,t);const i=bt.getResource("Levels"),r=new ii;this.items.push(new ei(r.panelImgData,r.panelPos));const n=new ti(bt.getDefaultFont(),r.window);n.setFirstLine(s?r.level:r.tutorial),this.items.push(n),Object.keys(i.levelsByName).forEach((e=>{const t=i.levelsByName[e],s=new Qs(this,e,t);s.onHoverChange=()=>n.setSecondLine(s.hover?t.fullName:""),this.items.push(s)})),this.items.sort(((e,t)=>Ys.compareZ(e,t)))}}class ii{constructor(){this.window={x:0,y:0,w:0,h:0},this.panelPos={x:0,y:0,w:0,h:0},this.level="",this.tutorial="";const e=bt.cfg("Menu","LevelText"),t=(0,a.hh)(e,"Window");this.window={x:t[0],y:t[1],w:t[2],h:t[3]};const s=(0,a.hh)(e,"Panel");this.panelImgData=bt.getImageData(s[0]),this.panelPos={x:s[1],y:s[2],w:s[3],h:s[4]},this.level=Ks((0,a.hh)(e,"Level")),this.tutorial=Ks((0,a.hh)(e,"Tutorial"))}}class ri extends Ws{constructor(){super(),this.onLevelSelected=null,this.menus=[],bt.getResource("MainMenuFull").menus.forEach((e=>{let t;t="Levels"===e.title?new si(this,e,!0):"Tutorials"===e.title?new si(this,e,!1):new $s(this,e),this.menus.push(t),this.addLayer(t)}))}showMainMenu(e=0){this.menus.forEach(((t,s)=>s===e?t.show():t.hide())),this.cursorLayer.show()}showLevelSelection(){this.showMainMenu(1)}selectLevel(e){this.hide(),this.onLevelSelected(e)}}class ni extends Ys{constructor(e){let t,s,i,r;super(),this.disabled=!1,this.visible=!0,[t,s,i,r,this.x,this.y]=e,this.imgNormal=bt.getImage(t),this.imgHover=bt.getImage(s),this.imgPressed=bt.getImage(i),this.imgDisabled=bt.getImage(r),this.width=this.imgNormal.width,this.height=this.imgNormal.height}draw(e){if(super.draw(e),!this.visible)return;let t=this.imgNormal;this.disabled?t=this.imgDisabled:this.pressed?t=this.imgPressed:this.hover&&(t=this.imgHover),e.drawImage(t,this.x,this.y)}}class ai extends Ws{constructor(){super(),this.cfg=null,this.resultIndex=0,this.resultLastIndex=0,this.images=[],this.boxes=[],this.fonts={},this.texts=[],this.uncoverTimeout=null,this.resultValues=[],this.cfg=bt.getResource("Reward"),this.titleFont=bt.getBitmapFont(this.cfg.titleFont);const e=bt.getImage(this.cfg.wallpaper);this.addLayer(new Ns).onRedraw=t=>t.drawImage(e,0,0),this.cfg.images.forEach((e=>{this.images.push({img:bt.getImage(e.filePath),x:e.x,y:e.y})})),this.cfg.boxImages.forEach((e=>{this.boxes.push({img:bt.getImage(e.filePath),x:e.x,y:e.y})})),Object.keys(this.cfg.fonts).forEach(((e,t)=>{const s=bt.getBitmapFont(this.cfg.fonts[e]);this.fonts[e.toLowerCase()]=s;const i=this.cfg.texts[t],r=t<9?s:bt.getBitmapFont(this.cfg.backFont);this.texts.push(r.createTextImage(i.text))})),this.resultsLayer=this.addLayer(new Ns),this.resultsLayer.handlePointerEvent=e=>e.eventEnum===As.UP?(this.uncoverTimeout=(0,a.L4)(this.uncoverTimeout),this.uncoverTimeout=null,this.resultIndex=this.resultLastIndex,this.btnSave.visible=!0,this.btnAdvance.visible=!0,this.redraw(),new Promise((e=>e(!0)))):new Promise((e=>e(!1))),this.descriptionTextLayer=this.addLayer(new Ns,20),this.btnLayer=this.addLayer(new Ns,50),this.btnSave=new ni(this.cfg.saveButton),this.btnSave.disabled=!0,this.btnAdvance=new ni(this.cfg.advanceButton),this.btnLayer.handlePointerEvent=e=>{if(e.eventEnum===As.MOVE){const[t,s]=this.btnLayer.toScaledCoords(e.clientX,e.clientY);this.btnSave.checkHover(t,s),this.btnAdvance.checkHover(t,s)}else e.eventEnum===As.DOWN?e.button===Ls.MAIN&&(this.btnSave.checkSetPressed(),this.btnAdvance.checkSetPressed()):e.eventEnum===As.UP&&e.button===Ls.MAIN&&(this.btnSave.pressed?this.btnSave.setReleased():this.btnAdvance.pressed&&(this.btnAdvance.setReleased(),this.hide(),this.onAdvance()));return(this.btnSave.needsRedraw||this.btnAdvance.needsRedraw)&&this.redraw(),new Promise((e=>e(!1)))},this.btnLayer.onRedraw=e=>{this.btnSave.draw(e),this.btnAdvance.draw(e)}}setGameResult(e){this.resultText=this.cfg.quitText,this.resultLastIndex=this.images.length-2,e.state===Et.COMPLETE?(this.resultText=this.cfg.completeText,this.resultLastIndex=this.images.length-1):e.state===Et.FAILED&&(this.resultText=this.cfg.failedText),this.resultValues=[],this.resultValues.push(this.fonts.crystals.createTextImage(this.percentString(o.numCrystal,o.neededCrystals))),this.resultValues.push(this.fonts.ore.createTextImage(this.percentString(o.numOre,o.totalOres))),this.resultValues.push(this.fonts.diggable.createTextImage(this.percentString(o.remainingDiggables,o.totalDiggables,!0))),this.resultValues.push(this.fonts.constructions.createTextImage(e.numBuildings.toString())),this.resultValues.push(this.fonts.caverns.createTextImage(this.percentString(o.discoveredCaverns,o.totalCaverns))),this.resultValues.push(this.fonts.figures.createTextImage(this.percentString(e.numRaiders,e.numMaxRaiders))),this.resultValues.push(this.fonts.rockmonsters.createTextImage(this.percentString(0))),this.resultValues.push(this.fonts.oxygen.createTextImage(this.percentString(o.airLevel))),this.resultValues.push(this.fonts.timer.createTextImage(this.timeString(e.gameTimeSeconds))),this.resultValues.push(this.fonts.score.createTextImage(this.percentString(this.calcScore(e))))}calcScore(e){if(!this.rewardConfig)return 0;let t=this.rewardConfig.quota,s=this.rewardConfig.importance;const i=o.numCrystal>=(t.crystals||1/0)?s.crystals:0,r=e.gameTimeSeconds<=(t.timer||0)?s.timer:0,n=t.caverns?Math.min(1,o.discoveredCaverns/t.caverns)*s.caverns:0,a=t.constructions?Math.min(1,e.numBuildings/t.constructions*s.constructions):0,h=o.airLevel*s.oxygen,c=e.numRaiders>=l.d?s.figures:0;return Math.max(0,Math.min(100,Math.round(i+r+n+a+h+c)/100))}show(){this.resultIndex=0,this.btnSave.visible=!1,this.btnAdvance.visible=!1,this.uncoverResult();const e=this.titleFont.createTextImage(this.resultText);this.resultsLayer.onRedraw=t=>{t.clearRect(0,0,this.resultsLayer.fixedWidth,this.resultsLayer.fixedHeight);for(let e=0;e<=this.resultIndex;e++){const s=this.images[e];s&&t.drawImage(s.img,s.x,s.y)}for(let e=0;e<=this.resultIndex;e++){const s=this.boxes[e];s&&t.drawImage(s.img,s.x,s.y)}for(let e=0;e<=this.resultIndex;e++){const s=this.cfg.texts[e],i=this.resultValues[e];i&&t.drawImage(i,s.x-i.width/2,s.y)}t.drawImage(this.levelFullNameImg,this.resultsLayer.fixedWidth/2-this.levelFullNameImg.width/2,this.cfg.vertSpacing-this.levelFullNameImg.height/2),t.drawImage(e,this.resultsLayer.fixedWidth/2-e.width/2,this.cfg.vertSpacing+this.levelFullNameImg.height/2)},this.descriptionTextLayer.onRedraw=e=>{const t=this.texts[this.resultIndex];e.clearRect(0,this.cfg.textPos[1],this.descriptionTextLayer.fixedWidth,this.descriptionTextLayer.fixedHeight-this.cfg.textPos[1]);const s=this.resultIndex!==this.images.length-1?this.cfg.textPos[0]:305,i=this.resultIndex!==this.images.length-1?this.cfg.textPos[1]:195;e.drawImage(t,s-t.width/2,i)},super.show()}percentString(e,t=1,s=!1){0===t&&(t=1);let i=Math.round(100*Math.max(Math.min(e/t,1),0));return s&&(i=100-i),i.toString()+"%"}padLeft(e,t="0",s=2){for(;e.length<s;)e=t+e;return e}timeString(e){const t=this.padLeft((e%60).toString()),s=Math.floor(e/60),i=this.padLeft((s%60).toString());return this.padLeft(Math.floor(s/60).toString())+":"+i+":"+t}uncoverResult(){this.uncoverTimeout=setTimeout((()=>{this.uncoverTimeout=null,this.resultIndex++,this.resultIndex<this.resultLastIndex?this.uncoverResult():(this.btnSave.visible=!0,this.btnAdvance.visible=!0),this.redraw()}),1e3*this.cfg.timer)}setup(e,t){this.levelFullNameImg=this.titleFont.createTextImage(e),this.rewardConfig=t}}l.Sl&&console.warn("DEV MODE ACTIVE");const oi=new class extends Ws{constructor(){super(),this.assetIndex=0,this.layer=this.addLayer(new Ns)}show(){this.layers.forEach((e=>{e!==this.cursorLayer&&e.show()})),this.setLoadingMessage("Loading...")}setLoadingMessage(e){this.layer.onRedraw=t=>{t.fillStyle="black",t.fillRect(0,0,this.layer.fixedWidth,this.layer.fixedHeight),t.font="24px Arial",t.fillStyle="white",t.fillText("Loading Rock Raiders",20,this.layer.fixedHeight-50),t.font="18px Arial",t.fillStyle="white",t.fillText(e,20,this.layer.fixedHeight-20)},this.redraw()}enableGraphicMode(e){const t=bt.getImage(bt.cfg("Main","LoadScreen")),s=bt.getImage(bt.cfg("Main","ProgressBar")),i=bt.getDefaultFont().createTextImage(bt.cfg("Main","LoadingText"));this.layer.onRedraw=r=>{r.drawImage(t,0,0);const n=353*(this.assetIndex<e?Math.round(this.assetIndex/e):1);r.drawImage(s,142,450,n,9),r.drawImage(i,Math.round(320-i.width/2),Math.round(456-i.height/2))},this.cursorLayer.show(),this.redraw()}increaseLoadingState(){this.assetIndex++,this.redraw()}},li=new n.WadFileSelectionModal("game-container"),hi=new r.GithubBox("game-container"),ci=new i.ClearCacheButton("game-container");li.onStart=(e,t)=>{bt.startLoadingFromUrl(e,t)},bt.onMessage=e=>{oi.setLoadingMessage(e)},bt.onCacheMissed=()=>{li.show()},bt.onInitialLoad=e=>{li.hide(),oi.enableGraphicMode(e)},bt.onAssetLoaded=()=>{oi.increaseLoadingState()},bt.onLoadDone=()=>{const e=new ri,t=new Zs,s=new ai;e.onLevelSelected=i=>{let r=null;try{r=bt.getResource("Levels").levelsByName[i],r&&(s.setup(r.fullName,r.reward),t.startLevel(i,r))}catch(e){console.error("Could not load level: "+i,e)}finally{r||(console.error('Could not find level configuration for "'+i+'"'),t.hide(),e.showLevelSelection())}},t.onLevelEnd=e=>{t.hide(),s.setGameResult(e),s.show()},s.onAdvance=()=>{o.reset(),e.showLevelSelection()},oi.hide(),hi.hide(),ci.hide();const i=new URLSearchParams(window.location.search),r=i.get("entry");l.Sl&&r?(o.numOre=Number(i.get("numOre"))||0,o.numCrystal=Number(i.get("numCrystal"))||0,"level"===r?e.showLevelSelection():"reward"===r?s.show():"random"===r?e.selectLevel("Level"+("00"+(0,a.$u)(1,25)).substr(-2)):r&&e.selectLevel(r)):e.showMainMenu()},oi.show(),bt.startLoadingFromCache()},848:(e,t,s)=>{"use strict";s.d(t,{Sl:()=>i,UV:()=>r,$I:()=>n,p$:()=>a,Wc:()=>o,d:()=>l,oq:()=>h,w$:()=>c,lZ:()=>u,m8:()=>d,pR:()=>g,On:()=>p,Ld:()=>y,Du:()=>m,DG:()=>f,pM:()=>v,OK:()=>E,l3:()=>w});const i=!1,r="RockRaidersWeb",n=1e3,a=5e3,o=1e3,l=12,h=10,c=.1,u=200,d=20,g=49,p=49,y=Math.round(1e3/30),m=640,f=480,v=40,E=30,w=1e3/E},351:(e,t,s)=>{"use strict";e.exports=s.p+"266ca63177bca6f330a7.png"}}]);
//# sourceMappingURL=112.index.js.map