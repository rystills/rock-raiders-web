(self.webpackChunkrock_raiders_web=self.webpackChunkrock_raiders_web||[]).push([[617,990,694,372],{662:(e,t,i)=>{"use strict";i.d(t,{Z:()=>o});var s=i(15),r=i.n(s),n=i(645),a=i.n(n)()(r());a.push([e.id,".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n","",{version:3,sources:["webpack://./site/clearcache/clearCacheButton.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,kBAAkB;IAClB,OAAO;IACP,MAAM;AACV",sourcesContent:[".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n"],sourceRoot:""}]);const o=a},27:(e,t,i)=>{"use strict";i.d(t,{Z:()=>o});var s=i(15),r=i.n(s),n=i(645),a=i.n(n)()(r());a.push([e.id,".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n","",{version:3,sources:["webpack://./site/github/github.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,aAAa;IACb,kBAAkB;IAClB,MAAM;IACN,QAAQ;IACR,oCAAoC;IACpC,WAAW;AACf;;AAEA;IACI,WAAW;IACX,qBAAqB;IACrB,YAAY;AAChB;;AAEA;IACI,WAAW;IACX,0BAA0B;AAC9B;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iBAAiB;IACjB,sBAAsB;AAC1B",sourcesContent:[".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n"],sourceRoot:""}]);const o=a},372:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ClearCacheButton:()=>o});var s=i(848),r=i(379),n=i.n(r),a=i(662);n()(a.Z,{insert:"head",singleton:!1}),a.Z.locals;class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("clear-cache-box");const t=this.rootElement.appendChild(document.createElement("button"));t.classList.add("btn","btn-info"),t.innerText="Clear cached wad files and restart",t.onclick=()=>{indexedDB.deleteDatabase(s.UV),location.reload()}}hide(){this.rootElement.style.visibility="hidden"}}},990:(e,t,i)=>{"use strict";i.r(t),i.d(t,{GithubBox:()=>o});var s=i(379),r=i.n(s),n=i(27);r()(n.Z,{insert:"head",singleton:!1}),n.Z.locals;var a=i(351);class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("github-box");const t=this.rootElement.appendChild(document.createElement("a"));t.href="https://github.com/scarabol/rock-raiders-web";const i=t.appendChild(document.createElement("img"));i.src=a,i.classList.add("github-logo"),i.alt="Fork on GitHub",t.appendChild(document.createElement("span")).textContent=i.alt}hide(){this.rootElement.style.visibility="hidden"}}},694:(e,t,i)=>{"use strict";i.r(t),i.d(t,{WadFileSelectionModal:()=>r});var s=i(169);class r{constructor(e){this.onStart=null;const t=document.getElementById(e).appendChild(document.createElement("div"));t.classList.add("modal"),t.tabIndex=-1,t.setAttribute("role","dialog"),t.setAttribute("aria-hidden","true");const i=t.appendChild(document.createElement("div"));i.classList.add("modal-dialog"),t.setAttribute("role","document");const n=i.appendChild(document.createElement("div"));n.classList.add("modal-content");const a=n.appendChild(document.createElement("div"));a.classList.add("modal-header");const o=a.appendChild(document.createElement("h5"));o.classList.add("modal-title"),o.innerText="Load .wad files",o.id="wadfileSelectModalLabel",t.setAttribute("aria-labelledby",o.id);const h=n.appendChild(document.createElement("div"));h.classList.add("modal-body"),h.appendChild(document.createElement("p")).innerText="Assets not included! In order to play the game, please select the game files.";const l=h.appendChild(document.createElement("nav")).appendChild(document.createElement("div"));l.id="nav-tab",l.classList.add("nav","nav-tabs"),l.setAttribute("role","tablist");const c=r.appendNavButton(l,!0,"nav-file-tab","nav-file","Local files (recommended)"),d=r.appendNavButton(l,!1,"nav-url-tab","nav-url","Online from URL"),u=h.appendChild(document.createElement("div"));u.classList.add("tab-content"),this.appendNavFileTab(u,c.id),this.appendNavUrlTab(u,d.id),this.modal=new s.u_(t,{backdrop:"static",keyboard:!1})}static appendNavButton(e,t,i,s,r){const n=e.appendChild(document.createElement("button"));return n.classList.add("nav-link"),t&&n.classList.add("active"),n.id=i,n.setAttribute("data-bs-toggle","tab"),n.setAttribute("data-bs-target","#"+s),n.type="button",n.setAttribute("role","tab"),n.setAttribute("aria-controls",s),n.setAttribute("aria-selected",String(t)),n.innerText=r,n}appendNavFileTab(e,t){const i=r.appendNavTab(e,!0,"nav-file",t),s=r.appendWadFileGroup(i,"wad0-file","LegoRR0.wad"),n=r.appendWadFileGroup(i,"wad1-file","LegoRR1.wad"),a=i.appendChild(document.createElement("button"));a.type="submit",a.classList.add("btn","btn-primary","float-end"),a.id="button-start-file",a.innerText="Start Game",a.addEventListener("click",(()=>{a.disabled=!0;const e=URL.createObjectURL(s.files[0]),t=URL.createObjectURL(n.files[0]);this.onStart(e,t)}))}static appendWadFileGroup(e,t,i){const s=e.appendChild(document.createElement("div"));s.classList.add("my-3");const r=s.appendChild(document.createElement("label"));r.setAttribute("for",t),r.classList.add("form-label"),r.innerHTML='Select <span class="fw-bold">'+i+"</span> here:";const n=s.appendChild(document.createElement("input"));return n.type="file",n.classList.add("form-control"),n.id=t,n.required=!0,n}appendNavUrlTab(e,t){const i=r.appendNavTab(e,!1,"nav-url",t),s=i.appendChild(document.createElement("div"));s.classList.add("my-3"),s.innerText="Direct links with correct Allow-Origin-CORS-Headers required here.";const n=r.appendWadUrlGroup(i,"wad0-url","LegoRR0.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),a=r.appendWadUrlGroup(i,"wad1-url","LegoRR1.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),o=i.appendChild(document.createElement("button"));o.type="submit",o.classList.add("btn","btn-primary","float-end"),o.id="button-start-url",o.innerText="Start Game",o.addEventListener("click",(()=>{o.disabled=!0,this.onStart(n.value,a.value)}))}static appendNavTab(e,t,i,s){const r=e.appendChild(document.createElement("div"));return r.classList.add("tab-pane","fade"),t&&r.classList.add("show","active"),r.id=i,r.setAttribute("role","tabpanel"),r.setAttribute("aria-labelledby",s),r}static appendWadUrlGroup(e,t,i,s){const r=e.appendChild(document.createElement("div"));r.classList.add("my-3");const n=r.appendChild(document.createElement("label"));n.setAttribute("for",t),n.classList.add("form-label"),n.innerHTML='Enter url for <span class="fw-bold">'+i+"</span> here:";const a=r.appendChild(document.createElement("input"));return a.type="url",a.classList.add("form-control"),a.id=t,a.required=!0,a.value=s,a}show(){this.modal.show()}hide(){this.modal.hide()}}},617:(e,t,i)=>{"use strict";i.r(t);var s,r,n=i(372),a=i(990),o=i(694);function h(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const i=t.lastIndexOf("/");return t.substring(i+1)}function l(e,...t){return t.forEach((t=>{e=(e=Object.keys(e).filter((e=>e.toLowerCase()===t.toLowerCase())).map((t=>e[t])))?e[0]:e})),e}function c(e){return(new TextDecoder).decode(e).replace(/\0/g,"")}function d(e){return c(e).replace(/\\/g,"/")}function u(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function g(e){return u(0,e)}function p(){return 2*u(0,1)-1}function m(e){return e&&clearTimeout(e),null}function f(e){return e&&clearInterval(e),null}Array.prototype.remove=function(e){const t=this.indexOf(e);-1!==t&&this.splice(t,1)},Array.prototype.count=function(e){let t=0;return this.forEach((i=>e(i)&&t++)),t},Map.prototype.getOrUpdate=function(e,t){let i=this.get(e);return void 0===i&&(i=t(),this.set(e,i)),i},(r=s||(s={}))[r.SELECTED_SURFACE=0]="SELECTED_SURFACE",r[r.SELECTED_BUILDING=1]="SELECTED_BUILDING",r[r.SELECTED_RAIDER=2]="SELECTED_RAIDER",r[r.SELECTED_VEHICLE=3]="SELECTED_VEHICLE",r[r.DESELECTED_ENTITY=4]="DESELECTED_ENTITY",r[r.JOB_CREATE=5]="JOB_CREATE",r[r.JOB_DELETE=6]="JOB_DELETE",r[r.RAIDER_REQUESTED=7]="RAIDER_REQUESTED",r[r.MATERIAL_AMOUNT_CHANGED=8]="MATERIAL_AMOUNT_CHANGED",r[r.ENTITY_ADDED=9]="ENTITY_ADDED",r[r.ENTITY_REMOVED=10]="ENTITY_REMOVED",r[r.CAVERN_DISCOVERED=11]="CAVERN_DISCOVERED",r[r.ORE_FOUND=12]="ORE_FOUND",r[r.BUILDING_UPGRADED=13]="BUILDING_UPGRADED",r[r.RAIDER_TRAINED=14]="RAIDER_TRAINED",r[r.LOCATION_DEATH=15]="LOCATION_DEATH",r[r.LOCATION_MONSTER=16]="LOCATION_MONSTER",r[r.LOCATION_CRYSTAL_FOUND=17]="LOCATION_CRYSTAL_FOUND",r[r.LOCATION_UNDER_ATTACK=18]="LOCATION_UNDER_ATTACK",r[r.LOCATION_LANDSLIDE=19]="LOCATION_LANDSLIDE",r[r.LOCATION_POWER_DRAIN=20]="LOCATION_POWER_DRAIN",r[r.LOCATION_SLUG_EMERGE=21]="LOCATION_SLUG_EMERGE",r[r.LOCATION_RAIDER_DISCOVERED=22]="LOCATION_RAIDER_DISCOVERED",r[r.SURFACE_CHANGED=23]="SURFACE_CHANGED",r[r.AIR_LEVEL_CHANGED=24]="AIR_LEVEL_CHANGED",r[r.CANCEL_BUILD_MODE=25]="CANCEL_BUILD_MODE",r[r.CHANGE_CURSOR=26]="CHANGE_CURSOR";class y{static publishEvent(e){this.blockedEvents.includes(e.eventKey)||(e.isLocal||console.log("Event published: "+s[e.eventKey]),this.blockedEvents.push(e.eventKey),this.getListener(e.eventKey).forEach((t=>t(e))),this.blockedEvents.remove(e.eventKey))}static registerEventListener(e,t){this.getListener(e).push(t)}static getListener(e){return this.eventListener.getOrUpdate(e,(()=>[]))}}y.eventListener=new Map,y.blockedEvents=[];class w{constructor(e){this.eventKey=e}}class v extends w{constructor(e){super(e),this.isLocal=!0}}class b extends v{constructor(e){super(e)}}class I extends b{constructor(e){super(s.SELECTED_SURFACE),this.surface=e}}class E extends b{constructor(e){super(s.SELECTED_BUILDING),this.building=e}}class T extends b{constructor(e){super(s.SELECTED_RAIDER),this.raider=e}}class S extends v{constructor(){super(s.DESELECTED_ENTITY)}}class C extends v{constructor(e){super(s.SURFACE_CHANGED),this.surface=e}}class R extends v{constructor(){super(s.AIR_LEVEL_CHANGED)}}class P extends v{constructor(){super(s.CANCEL_BUILD_MODE)}}class L extends v{constructor(e){super(s.CHANGE_CURSOR),this.cursor=e}}var M,x,A,O,D=i(848);!function(e){e[e.PILOT=0]="PILOT",e[e.TOOLSTATION=1]="TOOLSTATION",e[e.TELEPORT_PAD=2]="TELEPORT_PAD",e[e.DOCKS=3]="DOCKS",e[e.POWER_STATION=4]="POWER_STATION",e[e.BARRACKS=5]="BARRACKS",e[e.UPGRADE=6]="UPGRADE",e[e.GEODOME=7]="GEODOME",e[e.ORE_REFINERY=8]="ORE_REFINERY",e[e.GUNSTATION=9]="GUNSTATION",e[e.TELEPORT_BIG=10]="TELEPORT_BIG",e[e.BAT=11]="BAT",e[e.SMALL_SPIDER=12]="SMALL_SPIDER",e[e.DYNAMITE=13]="DYNAMITE",e[e.ELECTRIC_FENCE=14]="ELECTRIC_FENCE",e[e.CRYSTAL=15]="CRYSTAL",e[e.ORE=16]="ORE",e[e.BRICK=17]="BRICK",e[e.BARRIER=18]="BARRIER"}(M||(M={})),function(e){e[e.RAIDER=0]="RAIDER",e[e.BUILDING=1]="BUILDING",e[e.MONSTER=2]="MONSTER",e[e.MATERIAL=3]="MATERIAL"}(x||(x={}));class _{constructor(){this.levelDefault=[],this.current=[]}setList(e){this.levelDefault=e,this.reset()}toggle(e){this.current[e].enabled=!this.current[e].enabled}upOne(e){const t=this.current[e];this.current[e]=this.current[e+1],this.current[e+1]=t}reset(){this.current=this.levelDefault.map((e=>new k(e)))}pushToTop(e){const t=this.current[e];for(let t=e;t>0;t--)this.current[t]=this.current[t-1];this.current[0]=t}getPriority(e){let t=0;return this.current.some(((i,s)=>{if(i.key===e.getPriorityIdentifier())return t=s,!0})),t}}class k{constructor(e){this.key=e.key,this.enabled=e.enabled}}class B{constructor(e){this.name=e}}B.DRIVER=new B("driver"),B.ENGINEER=new B("engineer"),B.GEOLOGIST=new B("geologist"),B.PILOT=new B("pilot"),B.SAILOR=new B("sailor"),B.DEMOLITION=new B("demolition"),function(e){e[e.SURFACE=0]="SURFACE",e[e.RAIDER=1]="RAIDER",e[e.BUILDING=2]="BUILDING",e[e.VEHICLE=3]="VEHICLE",e[e.GROUP=4]="GROUP"}(A||(A={})),function(e){e[e.RUNNING=0]="RUNNING",e[e.COMPLETE=1]="COMPLETE",e[e.FAILED=2]="FAILED"}(O||(O={}));class N{static reset(){this.resultState=O.RUNNING,this.levelFullName="",this.numCrystal=0,this.numOre=0,this.numBrick=0,this.usedCrystals=0,this.neededCrystals=0,this.airLevel=1,this.selectedEntities=[],this.selectionType=null,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.requestedRaiders=0,this.materials=[],this.materialsUndiscovered=[],this.buildingSites=[],this.spiders=[],this.spidersBySurface=new Map,this.bats=[],this.totalCrystals=0,this.totalOres=0,this.totalDiggables=0,this.remainingDiggables=0,this.totalCaverns=0,this.discoveredCaverns=0,this.levelStartTime=0,this.levelStopTime=0,this.rewardConfig=null,this.priorityList=new _,this.oxygenRate=0,this.buildModeSelection=null}static getBuildingsByType(...e){return this.buildings.filter((t=>!t.inBeam&&t.isPowered()&&e.some((e=>t.entityType===e))))}static getClosestBuildingByType(e,...t){const i=N.getBuildingsByType(...t);let s=null,r=null;return i.forEach((t=>{const i=t.getDropPosition(),n=e.distanceToSquared(i);(null===s||n<r)&&(s=t,r=n)})),s}static hasOneBuildingOf(...e){return this.buildings.some((t=>e.some((e=>t.entityType===e))&&t.isPowered()))}static hasBuildingWithUpgrades(e,t=0){return this.buildings.some((i=>i.entityType===e&&i.level>=t&&i.isPowered()))}static getTrainingSites(e,t){return t===B.DEMOLITION?this.buildings.filter((e=>e.stats.TrainDynamite&&e.stats.TrainDynamite[e.level])):[]}static selectEntities(e){this.selectedEntities=this.selectedEntities.filter((t=>{const i=-1!==e.indexOf(t);return i||t.deselect(),i}));const t=[];e.forEach((e=>{const i=e.select();i&&(this.selectedEntities.push(e),t.push(i))}));const i=this.selectedEntities.length;i>1?this.selectionType=A.GROUP:1===i?this.selectionType=this.selectedEntities[0].getSelectionType():null!==this.selectionType&&(this.selectionType=null,y.publishEvent(new S)),t.forEach((e=>y.publishEvent(e)))}static getMaxRaiders(){return D.d+N.buildings.count((e=>e.isPowered()&&e.entityType===M.BARRACKS))*D.oq}static discoverSurface(e){const t=e.x*D.pM,i=e.y*D.pM,s=t+D.pM,r=i+D.pM;this.discoverEntities(this.raidersUndiscovered,t,s,i,r),this.discoverEntities(this.buildingsUndiscovered,t,s,i,r),this.discoverEntities(this.materialsUndiscovered,t,s,i,r)}static discoverEntities(e,t,i,s,r){const n=[];e.forEach((e=>{const a=e.getPosition();a.x>=t&&a.x<i&&a.z>=s&&a.z<r&&(e.onDiscover(),n.push(e))})),n.forEach((t=>e.remove(t)))}static get gameTimeSeconds(){return Math.round((N.levelStopTime-N.levelStartTime)/1e3)}static get score(){if(!N.rewardConfig)return 0;let e=N.rewardConfig.quota,t=N.rewardConfig.importance;const i=N.numCrystal>=(e.crystals||1/0)?t.crystals:0,s=N.gameTimeSeconds<=(e.timer||0)?t.timer:0,r=e.caverns?Math.min(1,N.discoveredCaverns/e.caverns)*t.caverns:0,n=e.constructions?Math.min(1,N.buildings.length/e.constructions*t.constructions):0,a=N.airLevel*t.oxygen,o=N.raiders.length>=D.d?t.figures:0;return Math.round(i+s+r+n+a+o)/100}static get selectedSurface(){return this.selectionType===A.SURFACE&&this.selectedEntities.length>0?this.selectedEntities[0]:null}static get selectedBuilding(){return this.selectionType===A.BUILDING&&this.selectedEntities.length>0?this.selectedEntities[0]:null}static get selectedRaiders(){return(this.selectionType===A.RAIDER||this.selectionType===A.GROUP)&&this.selectedEntities.length>0?this.selectedEntities:[]}static get totalOre(){return this.numOre+5*this.numBrick}static getNearbySpiders(e){const t=e.sceneMgr.terrain,i=t.getSurfaceFromWorld(e.getPosition()),s=[];for(let e=i.x;e<=i.x+1;e++)for(let r=i.y;r<=i.y+1;r++){const i=t.getSurface(e,r);s.push(...N.spidersBySurface.get(i)||[])}return s}}N.resultState=O.RUNNING,N.levelFullName="",N.numCrystal=0,N.numOre=0,N.numBrick=0,N.usedCrystals=0,N.neededCrystals=0,N.airLevel=1,N.selectedEntities=[],N.selectionType=null,N.buildings=[],N.buildingsUndiscovered=[],N.raiders=[],N.raidersUndiscovered=[],N.requestedRaiders=0,N.materials=[],N.materialsUndiscovered=[],N.buildingSites=[],N.spiders=[],N.spidersBySurface=new Map,N.bats=[],N.totalCrystals=0,N.totalOres=0,N.totalDiggables=0,N.remainingDiggables=0,N.totalCaverns=0,N.discoveredCaverns=0,N.levelStartTime=0,N.levelStopTime=0,N.rewardConfig=null,N.priorityList=new _,N.oxygenRate=0,N.buildModeSelection=null;var F=i(212);function U(e,t){if(e<1||t<1)return console.error("Can't create context with size "+e+" x "+t),function(e,t){const i=U(64,64);for(let e=0;e<64;e+=16)for(let t=0;t<64;t+=16)i.fillStyle=t/16%2==e/16%2?"rgb(0,255,255)":"rgb(255,0,255)",i.fillRect(t,e,16,16);return i}();const i=document.createElement("canvas");i.setAttribute("width",e),i.setAttribute("height",t);const s=i.getContext("2d");return s.width=e,s.height=t,s}function W(e,t){const i=new ImageData(e,t);for(let s=0;s<t;s+=16)for(let t=0;t<e;t+=16){const e=t/16%2==s/16%2;for(let r=t;r<t+16;r++)for(let t=s;t<s+16;t++)H(i,r,t,e?0:255,e?255:0,255)}return i}function H(e,t,i,s,r,n,a=255){const o=4*(i*e.width+t);e.data[o]=s,e.data[o+1]=r,e.data[o+2]=n,e.data[o+3]=a}function G(e,t,i){const s=4*(i*e.width+t);return{r:e.data[s],g:e.data[s+1],b:e.data[s+2],a:e.data[s+3]}}class J{constructor(){this.carryNullName="",this.depositNullName="",this.toolNullName="",this.mediumPoly={},this.highPoly={},this.fPPoly={},this.activities=new Map}}var V=i(886);const Y=i(466);class j{constructor(){this.stats=new Y,this.stats.setMode(0),this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement),this.hide()}show(){this.stats.domElement.style.visibility="visible"}hide(){this.stats.domElement.style.visibility="hidden"}renderStart(){this.stats.begin()}renderDone(){this.stats.end()}}class X{constructor(e,t){this.location=e,this.heading=e.clone().sub(t).angle(),e.y===t.y?this.heading-=Math.PI/2:this.heading+=Math.PI/2}}var K;!function(e){e[e.Pointer_Blank=0]="Pointer_Blank",e[e.Pointer_Standard=1]="Pointer_Standard",e[e.Pointer_Drill=2]="Pointer_Drill",e[e.Pointer_CantDrill=3]="Pointer_CantDrill",e[e.Pointer_Clear=4]="Pointer_Clear",e[e.Pointer_Go=5]="Pointer_Go",e[e.Pointer_CantGo=6]="Pointer_CantGo",e[e.Pointer_Teleport=7]="Pointer_Teleport",e[e.Pointer_CantTeleport=8]="Pointer_CantTeleport",e[e.Pointer_Reinforce=9]="Pointer_Reinforce",e[e.Pointer_CantReinforce=10]="Pointer_CantReinforce",e[e.Pointer_Selected=11]="Pointer_Selected",e[e.Pointer_RadarPan=12]="Pointer_RadarPan",e[e.Pointer_TrackObject=13]="Pointer_TrackObject",e[e.Pointer_Zoom=14]="Pointer_Zoom",e[e.Pointer_CantZoom=15]="Pointer_CantZoom",e[e.Pointer_Help=16]="Pointer_Help",e[e.Pointer_CantHelp=17]="Pointer_CantHelp",e[e.Pointer_PutDown=18]="Pointer_PutDown",e[e.Pointer_GetIn=19]="Pointer_GetIn",e[e.Pointer_GetOut=20]="Pointer_GetOut",e[e.Pointer_Okay=21]="Pointer_Okay",e[e.Pointer_NotOkay=22]="Pointer_NotOkay",e[e.Pointer_CanBuild=23]="Pointer_CanBuild",e[e.Pointer_CannotBuild=24]="Pointer_CannotBuild",e[e.Pointer_Dynamite=25]="Pointer_Dynamite",e[e.Pointer_CantDynamite=26]="Pointer_CantDynamite",e[e.Pointer_PickUp=27]="Pointer_PickUp",e[e.Pointer_CantPickUp=28]="Pointer_CantPickUp",e[e.Pointer_PickUpOre=29]="Pointer_PickUpOre",e[e.Pointer_LegoManCantDig=30]="Pointer_LegoManCantDig",e[e.Pointer_VehicleCantDig=31]="Pointer_VehicleCantDig",e[e.Pointer_LegoManDig=32]="Pointer_LegoManDig",e[e.Pointer_VehicleDig=33]="Pointer_VehicleDig",e[e.Pointer_LegoManCantPickUp=34]="Pointer_LegoManCantPickUp",e[e.Pointer_VehicleCantPickUp=35]="Pointer_VehicleCantPickUp",e[e.Pointer_LegoManPickUp=36]="Pointer_LegoManPickUp",e[e.Pointer_VehiclePickUp=37]="Pointer_VehiclePickUp",e[e.Pointer_LegoManCantGo=38]="Pointer_LegoManCantGo",e[e.Pointer_VehicleCantGo=39]="Pointer_VehicleCantGo",e[e.Pointer_LegoManGo=40]="Pointer_LegoManGo",e[e.Pointer_VehicleGo=41]="Pointer_VehicleGo",e[e.Pointer_LegoManClear=42]="Pointer_LegoManClear",e[e.Pointer_VehicleClear=43]="Pointer_VehicleClear",e[e.Pointer_SurfaceType_Immovable=44]="Pointer_SurfaceType_Immovable",e[e.Pointer_SurfaceType_Hard=45]="Pointer_SurfaceType_Hard",e[e.Pointer_SurfaceType_Medium=46]="Pointer_SurfaceType_Medium",e[e.Pointer_SurfaceType_Loose=47]="Pointer_SurfaceType_Loose",e[e.Pointer_SurfaceType_Soil=48]="Pointer_SurfaceType_Soil",e[e.Pointer_SurfaceType_OreSeam=49]="Pointer_SurfaceType_OreSeam",e[e.Pointer_SurfaceType_CrystalSeam=50]="Pointer_SurfaceType_CrystalSeam",e[e.Pointer_SurfaceType_RechargeSeam=51]="Pointer_SurfaceType_RechargeSeam"}(K||(K={}));class q{constructor(e={}){this.shaping=!1,this.matIndex="00",this.floor=!1,this.selectable=!1,this.drillable=!1,this.drillableHard=!1,this.explodable=!1,this.reinforcable=!1,this.cursor=K.Pointer_Standard,Object.assign(this,e)}static getByNum(e){switch(e){case 0:return q.POWER_PATH_BUILDING;case 1:return q.SOLID_ROCK;case 2:return q.HARD_ROCK;case 3:return q.LOOSE_ROCK;case 4:case 5:return q.DIRT;case 6:return q.LAVA;case 8:return q.ORE_SEAM;case 9:return q.WATER;case 10:return q.CRYSTAL_SEAM;case 11:return q.RECHARGE_SEAM;case 30:case 40:return q.SLUG_HOLE;case 100:return q.RUBBLE4;case 101:return q.RUBBLE3;case 102:return q.RUBBLE2;case 103:return q.RUBBLE1;default:return console.error("Unexpected surface type num: "+e),q.SOLID_ROCK}}}q.GROUND=new q({name:"ground",floor:!0,selectable:!0}),q.SOLID_ROCK=new q({name:"solid rock",shaping:!0,matIndex:"5",cursor:K.Pointer_SurfaceType_Immovable}),q.HARD_ROCK=new q({name:"hard rock",shaping:!0,matIndex:"4",selectable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:K.Pointer_SurfaceType_Hard}),q.LOOSE_ROCK=new q({name:"loose rock",shaping:!0,matIndex:"3",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:K.Pointer_SurfaceType_Medium}),q.DIRT=new q({name:"dirt",shaping:!0,matIndex:"1",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:K.Pointer_SurfaceType_Loose}),q.SLUG_HOLE=new q({name:"slug hole",floor:!0,matIndex:"30"}),q.LAVA=new q({name:"lava",floor:!0,matIndex:"46"}),q.ORE_SEAM=new q({name:"ore seam",matIndex:"40",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:K.Pointer_SurfaceType_OreSeam}),q.WATER=new q({name:"water",floor:!0,matIndex:"45"}),q.CRYSTAL_SEAM=new q({name:"energy crystal seam",matIndex:"20",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:K.Pointer_SurfaceType_CrystalSeam}),q.RECHARGE_SEAM=new q({name:"recharge seam",matIndex:"67",cursor:K.Pointer_SurfaceType_RechargeSeam}),q.POWER_PATH=new q({name:"power path all",floor:!0,matIndex:"60",selectable:!0}),q.POWER_PATH_SITE=new q({name:"power path site",floor:!0,matIndex:"61",selectable:!0}),q.POWER_PATH_BUILDING=new q({name:"power path",floor:!0,matIndex:"76"}),q.RUBBLE1=new q({name:"rubble 1",floor:!0,matIndex:"13",selectable:!0}),q.RUBBLE2=new q({name:"rubble 2",floor:!0,matIndex:"12",selectable:!0}),q.RUBBLE3=new q({name:"rubble 3",floor:!0,matIndex:"11",selectable:!0}),q.RUBBLE4=new q({name:"rubble 4",floor:!0,matIndex:"10",selectable:!0});var z,Z=i(586);!function(e){e[e.CORNER=1]="CORNER",e[e.WALL=2]="WALL",e[e.INVERTED_CORNER=3]="INVERTED_CORNER",e[e.WEIRD_CREVICE=20]="WEIRD_CREVICE"}(z||(z={}));class ${static create(e,t,i,s,r,n,a,o,h){let l=0;!t.y||i.y||e!==z.INVERTED_CORNER&&(e===z.WALL||e===z.WEIRD_CREVICE)!==Boolean(s.y)||(l=0),!s.y||r.y||e!==z.INVERTED_CORNER&&(e===z.WALL||e===z.WEIRD_CREVICE)!==Boolean(i.y)||(l=3),!i.y||t.y||e!==z.INVERTED_CORNER&&(e===z.WALL||e===z.WEIRD_CREVICE)!==Boolean(r.y)||(l=2),!r.y||s.y||e!==z.INVERTED_CORNER&&(e===z.WALL||e===z.WEIRD_CREVICE)!==Boolean(t.y)||(l=1),e!==z.WALL&&e!==z.WEIRD_CREVICE||(t.y&&i.y&&(l=0),s.y&&r.y&&(l=3));const c=[new F.FM8(0,1),new F.FM8(1,1),new F.FM8(1,0),new F.FM8(0,0)],d=[],u=[];function g(e,t,i){d.push(e,t,i);const s=(new F.Pa4).subVectors(i,t);s.cross((new F.Pa4).subVectors(e,t)),s.normalize(),u.push(s,s,s)}const p=[];s.y===r.y&&(e!==z.WALL&&e!==z.WEIRD_CREVICE||s.y&&r.y)?(p.push(0,3,2),p.push(0,2,1),t.y=n,s.y=a,i.y=o,r.y=h,g(t,r,i),g(t,i,s)):(p.push(1,3,2),p.push(1,0,3),t.y=n,s.y=a,i.y=o,r.y=h,g(s,r,i),g(s,t,r));const m=p.map((e=>c[(e+l)%4])),f=new F.u9r;return f.setAttribute("position",new Z.Tl(new Float32Array(18),3).copyVector3sArray(d)),f.setAttribute("normal",new Z.Tl(new Float32Array(18),3).copyVector3sArray(u)),f.setAttribute("uv",new Z.Tl(new Float32Array(12),2).copyVector2sArray(m)),f}}class Q extends F.Kj0{constructor(e){super(Q.geometry,new F.xoR({shininess:0,transparent:!0,opacity:.4,color:e})),this.standardColor=e,this.visible=!1}updateState(e,t,i){this.visible=!!e,e&&this.position.set(e.x,0,e.y).multiplyScalar(D.pM).applyAxisAngle(new F.Pa4(0,1,0),-t+Math.PI/2).add(i)}markAsValid(e){const t=e?this.standardColor:5242880;this.material.color.setHex(t)}}Q.geometry=$.create(z.WALL,new F.Pa4(0,0,0),new F.Pa4(D.pM,0,D.pM),new F.Pa4(D.pM,0,0),new F.Pa4(0,0,D.pM),1,1,1,1);class ee{constructor(){this.group=new F.ZAu,this.markers=[],this.buildingMarkerPrimary=null,this.buildingMarkerSecondary=null,this.powerPathMarkerPrimary=null,this.powerPathMarkerSecondary=null,this.waterPathMarker=null,this.heading=0,this.sdx=0,this.sdz=0,this.lastCheck=!1,this.visibleSurfaces=[],this.primarySurface=null,this.secondarySurface=null,this.waterSurface=null,this.buildingMarkerPrimary=new Q(ee.buildingMarkerColor),this.buildingMarkerSecondary=new Q(ee.buildingMarkerColor),this.powerPathMarkerPrimary=new Q(ee.pathMarkerColor),this.powerPathMarkerSecondary=new Q(ee.pathMarkerColor),this.waterPathMarker=new Q(ee.waterMarkerColor),this.addMarker(this.buildingMarkerPrimary),this.addMarker(this.buildingMarkerSecondary),this.addMarker(this.powerPathMarkerPrimary),this.addMarker(this.powerPathMarkerSecondary),this.addMarker(this.waterPathMarker)}addMarker(e){this.group.add(e),this.markers.push(e)}update(e,t){if(t&&N.buildModeSelection){const i=this.updateAllMarker(e,t);this.markers.forEach((e=>e.markAsValid(i)))}else this.hideAllMarker()}updateAllMarker(e,t=null){const i=N.buildModeSelection(e.worldMgr,e.sceneMgr);this.buildingMarkerPrimary.visible=!0,this.buildingMarkerPrimary.position.copy(e.sceneMgr.getFloorPosition(new F.FM8(Math.floor(t.x/D.pM)*D.pM,Math.floor(t.y/D.pM)*D.pM)));const s=t.x-this.buildingMarkerPrimary.position.x-D.pM/2,r=t.y-this.buildingMarkerPrimary.position.z-D.pM/2,n=Math.abs(s)>Math.abs(r)?Math.sign(s):0,a=Math.abs(r)>Math.abs(s)?Math.sign(r):0;return this.sdx===n&&this.sdz===a||(this.sdx=n,this.sdz=a,this.heading=Math.atan2(a,n),this.buildingMarkerSecondary.updateState(i.secondaryBuildingPart,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerPrimary.updateState(i.primaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerSecondary.updateState(i.secondaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.waterPathMarker.updateState(i.waterPathSurface,this.heading,this.buildingMarkerPrimary.position),this.visibleSurfaces=[this.buildingMarkerPrimary,this.buildingMarkerSecondary,this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].filter((e=>e.visible)).map((t=>e.getSurfaceFromWorld(t.position))),this.primarySurface=this.visibleSurfaces[0],this.secondarySurface=this.buildingMarkerSecondary.visible?this.visibleSurfaces[1]:null,this.waterSurface=this.waterPathMarker.visible?e.getSurfaceFromWorld(this.waterPathMarker.position):null,this.lastCheck=this.visibleSurfaces.every((e=>e.surfaceType===q.GROUND))&&([this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].some((t=>t.visible&&e.getSurfaceFromWorld(t.position).neighbors.some((e=>e.surfaceType===q.POWER_PATH))))||!i.primaryPowerPath&&this.primarySurface.neighbors.some((e=>e.surfaceType===q.POWER_PATH)))&&(!this.waterPathMarker.visible||this.waterSurface.surfaceType===q.WATER)),this.lastCheck}hideAllMarker(){this.markers.forEach((e=>e.visible=!1)),this.lastCheck=!1}getBarrierLocations(){const e=[],t=this.primarySurface.getCenterWorld2D(),i=9*D.pM/20;if(this.secondarySurface){const s=this.secondarySurface.getCenterWorld2D(),r=Math.sign(s.x-t.x),n=Math.sign(s.y-t.y);0!==r?(e.push(new X(new F.FM8(t.x-r*i,t.y),t)),e.push(new X(new F.FM8(t.x,t.y-i),t)),e.push(new X(new F.FM8(t.x,t.y+i),t)),e.push(new X(new F.FM8(s.x+r*i,t.y),s)),e.push(new X(new F.FM8(s.x,s.y-i),s)),e.push(new X(new F.FM8(s.x,s.y+i),s))):(e.push(new X(new F.FM8(t.x,t.y-n*i),t)),e.push(new X(new F.FM8(t.x-i,t.y),t)),e.push(new X(new F.FM8(t.x+i,t.y),t)),e.push(new X(new F.FM8(s.x,s.y+n*i),s)),e.push(new X(new F.FM8(s.x-i,t.y),s)),e.push(new X(new F.FM8(s.x+i,t.y),s)))}else e.push(new X(new F.FM8(t.x-i,t.y),t)),e.push(new X(new F.FM8(t.x,t.y-i),t)),e.push(new X(new F.FM8(t.x+i,t.y),t)),e.push(new X(new F.FM8(t.x,t.y+i),t));return e}}function te(e){let t=e;const i=[];for(;t.parent;)i.unshift(t),t=t.parent;return i}ee.buildingMarkerColor=20480,ee.pathMarkerColor=5263360,ee.waterMarkerColor=80;const ie={search(e,t,i,s=null){e.cleanDirty();const r=(s=s||{}).heuristic||ie.heuristics.manhattan,n=s.closest||!1,a=new ne((function(e){return e.f}));let o=t;for(t.h=r(t,i),e.markDirty(t),a.push(t);a.size()>0;){const t=a.pop();if(t===i)return te(t);t.closed=!0;const s=e.neighbors(t);let h=0;const l=s.length;for(;h<l;++h){const l=s[h];if(l.closed||l.isWall())continue;const c=t.g+l.getCost(t),d=l.visited;(!d||c<l.g)&&(l.visited=!0,l.parent=t,l.h=l.h||r(l,i),l.g=c,l.f=l.g+l.h,e.markDirty(l),n&&(l.h<o.h||l.h===o.h&&l.g<o.g)&&(o=l),d?a.rescoreElement(l):a.push(l))}}return n?te(o):[]},heuristics:{manhattan:(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),diagonal(e,t){const i=Math.sqrt(2),s=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return 1*(s+r)+(i-2)*Math.min(s,r)}},cleanNode(e){e.f=0,e.g=0,e.h=0,e.visited=!1,e.closed=!1,e.parent=null}};class se{constructor(e,t=null){this.nodes=[],this.grid=[],this.dirtyNodes=[],t=t||{},this.diagonal=!!t.diagonal;for(let t=0;t<e.length;t++){this.grid[t]=[];let i=0;const s=e[t];for(;i<s.length;i++){const e=new re(t,i,s[i]);this.grid[t][i]=e,this.nodes.push(e)}}this.init()}init(){this.dirtyNodes=[];for(let e=0;e<this.nodes.length;e++)ie.cleanNode(this.nodes[e])}cleanDirty(){for(let e=0;e<this.dirtyNodes.length;e++)ie.cleanNode(this.dirtyNodes[e]);this.dirtyNodes=[]}markDirty(e){this.dirtyNodes.push(e)}neighbors(e){const t=[],i=e.x,s=e.y,r=this.grid;return r[i-1]&&r[i-1][s]&&t.push(r[i-1][s]),r[i+1]&&r[i+1][s]&&t.push(r[i+1][s]),r[i]&&r[i][s-1]&&t.push(r[i][s-1]),r[i]&&r[i][s+1]&&t.push(r[i][s+1]),this.diagonal&&(r[i-1]&&r[i-1][s-1]&&t.push(r[i-1][s-1]),r[i+1]&&r[i+1][s-1]&&t.push(r[i+1][s-1]),r[i-1]&&r[i-1][s+1]&&t.push(r[i-1][s+1]),r[i+1]&&r[i+1][s+1]&&t.push(r[i+1][s+1])),t}toString(){const e=[],t=this.grid;for(let i=0;i<t.length;i++){const s=[],r=t[i];for(let e=0;e<r.length;e++)s.push(r[e].weight);e.push(s.join(" "))}return e.join("\n")}}class re{constructor(e,t,i){this.x=e,this.y=t,this.weight=i}toString(){return"["+this.x+" "+this.y+"]"}getCost(e){return e&&e.x!=this.x&&e.y!=this.y?1.41421*this.weight:this.weight}isWall(){return 0===this.weight}}class ne{constructor(e){this.content=[],this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.sinkDown(this.content.length-1)}pop(){const e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e}remove(e){const t=this.content.indexOf(e),i=this.content.pop();t!==this.content.length-1&&(this.content[t]=i,this.scoreFunction(i)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))}size(){return this.content.length}rescoreElement(e){this.sinkDown(this.content.indexOf(e))}sinkDown(e){const t=this.content[e];for(;e>0;){const i=(e+1>>1)-1,s=this.content[i];if(!(this.scoreFunction(t)<this.scoreFunction(s)))break;this.content[i]=t,this.content[e]=s,e=i}}bubbleUp(e){const t=this.content.length,i=this.content[e],s=this.scoreFunction(i);for(;;){const r=e+1<<1,n=r-1;let a,o=null;if(n<t){const e=this.content[n];a=this.scoreFunction(e),a<s&&(o=n)}if(r<t){const e=this.content[r];this.scoreFunction(e)<(null===o?s:a)&&(o=r)}if(null===o)break;this.content[e]=this.content[o],this.content[o]=i,e=o}}}class ae extends w{constructor(e){super(e),this.isLocal=!1}}class oe extends ae{constructor(e,t){super(e),this.job=t}}class he extends oe{constructor(e){super(s.JOB_CREATE,e)}}class le extends oe{constructor(e){super(s.JOB_DELETE,e)}}class ce extends ae{constructor(){super(s.RAIDER_REQUESTED)}}class de extends ae{constructor(e){super(s.MATERIAL_AMOUNT_CHANGED),this.entityType=e}}class ue extends ae{constructor(e){super(s.ENTITY_ADDED),this.superType=e.superType,this.entity=e}}class ge extends ae{constructor(){super(s.CAVERN_DISCOVERED)}}class pe extends ae{constructor(){super(s.ORE_FOUND)}}class me extends ae{constructor(e){super(s.BUILDING_UPGRADED),this.building=e}}class fe extends ae{constructor(e,t){super(s.RAIDER_TRAINED),this.entity=e,this.training=t}}class ye extends ae{constructor(e,t){super(e),this.location=t}}class we extends ye{constructor(e){super(s.LOCATION_CRYSTAL_FOUND,e)}}class ve extends ye{constructor(e){super(s.LOCATION_LANDSLIDE,e)}}class be extends ye{constructor(e){super(s.LOCATION_RAIDER_DISCOVERED,e)}}class Ie{constructor(){this.looping=!1,this.transcoef=1,this.firstFrame=null,this.lastFrame=null,this.framesPerSecond=null,this.bodies=[]}}var Ee=F.M8C.degToRad;class Te{constructor(){this.name="",this.filename="",this.relPos=[],this.relRot=[],this.relScale=[],this.opacity=[],this.parentObjInd=null,this.model=null}radVec(e,t,i){return new F.USm(Ee(t),Ee(e),Ee(i),"YXZ")}setFrameAndFollowing(e,t,i){this.relPos[e]=new F.Pa4(i[0],i[1],i[2]),this.relRot[e]=this.radVec(i[3],i[4],i[5]),this.relScale[e]=new F.Pa4(i[6],i[7],i[8]);for(let i=e;i<=t;i++)this.relPos[i]=this.relPos[e],this.relRot[i]=this.relRot[e],this.relScale[i]=this.relScale[e]}setOpacityAndFollowing(e,t,i){for(let s=e;s<=t;s++)this.opacity[s]=i}}class Se{constructor(e,t){this.mesh=null,this.textureSequences=[],this.mesh=e,this.textureSequences=t}dispose(){var e;this.textureSequences.forEach((e=>f(e))),this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach((e=>e.dispose())):null===(e=this.mesh.material)||void 0===e||e.dispose()}}const Ce=1448366670;function Re(e,t){let i=new F.Pa4;return i.x=e.getFloat32(t),i.y=e.getFloat32(t+4),i.z=e.getFloat32(t+8),i}class Pe{constructor(e,t=!1){this.path="",this.verbose=!1,this.materials=[],this.geometry=new F.u9r,this.vertices=null,this.indices=null,this.uvs=null,this.sequenceIntervals=[],this.path=e,this.verbose=t,this.verbose&&console.log("LWO path: "+this.path)}parsePoints(e,t,i){if(i%12!=0)return void console.error("LWOLoader.parse: F12 does not evenly divide into chunk size ("+i+"). Possible corruption.");let s=i/4/3;this.vertices=new Float32Array(3*s),this.uvs=new Float32Array(2*s);for(let i=0;i<s;i++){let s=3*i,r=4*s;this.vertices[s]=e.getFloat32(t+r),this.vertices[s+1]=e.getFloat32(t+r+4),this.vertices[s+2]=e.getFloat32(t+r+8)}}parseSurfaceNames(e,t,i){let s=(new TextDecoder).decode(new Uint8Array(e,t,i)).split("\0").filter((function(e){return""!==e}));for(let e=0;e<s.length;e++){const t=new F.xoR;t.name=s[e],t.side=F.ehD,this.materials.push(t)}this.verbose&&console.log("LWO contains "+this.materials.length+" materials with following names: "+s)}parsePolygons(e,t,i){let s=0,r=0;for(;r<i;){const i=e.getInt16(t+r),n=e.getInt16(t+r+2+2*i);this.geometry.addGroup(s,3*(i-2),n-1),s+=3*(i-2),r+=4+2*i}r=0;let n=0;for(this.indices=new Uint16Array(s);r<i;){let i=e.getInt16(t+r);r+=2;let s=new Int16Array(i);for(let n=0;n<=i;n++)s[n]=e.getInt16(t+r+2*n);for(let e=0;e<i-2;e++)this.COUNTER_CLOCKWISE?(this.indices[n++]=s[0],this.indices[n++]=s[e+2],this.indices[n++]=s[e+1]):(this.indices[n++]=s[0],this.indices[n++]=s[e+1],this.indices[n++]=s[e+2]);r+=2+2*i}}parseSurface(e,t,i,s){let r=0;for(;0!==e.getUint8(i+r);)r++;let n=c(new Uint8Array(t,i,r));this.verbose&&console.log("Parsing surface: "+n);let a=-1,o=null,l=0,u=new F.Pa4(0,0,0),g=new F.Pa4(0,0,0);for(let e=0;e<this.materials.length;e++)this.materials[e].name===n&&(a=e,o=this.materials[e]);if(o){for(o.shininess=0;r<s;){const s=i+r;if(0===e.getUint8(s))r++;else{const i=e.getInt32(s),n=e.getInt16(s+4);switch(this.verbose&&console.log("Parsing subchunk "+(new TextDecoder).decode(new Uint8Array(t,s,4))+" at "+s+"; length "+n),i){case 1129270354:const r=[e.getUint8(s+6+0)/255,e.getUint8(s+6+1)/255,e.getUint8(s+6+2)/255];o.color=(new F.Ilk).fromArray(r),this.verbose&&console.log("Material color (COLR): "+r.join(" "));break;case 1179402567:const a=e.getUint16(s+6);this.verbose&&console.log("Flags (FLAG): "+a.toString(2)),this.verbose&&2&a&&console.warn("Flag is set but unhandled: outline"),this.verbose&&4&a&&console.warn("Flag is set but unhandled: smoothing"),this.verbose&&8&a&&console.warn("Flag is set but unhandled: colorHighlights"),this.verbose&&16&a&&console.warn("Flag is set but unhandled: colorFilter"),this.verbose&&32&a&&console.warn("Flag is set but unhandled: opaqueEdge"),this.verbose&&64&a&&console.warn("Flag is set but unhandled: transparentEdge"),this.verbose&&128&a&&console.warn("Flag is set but unhandled: sharpTerminator"),256&a&&(o.side=F.ehD),512&a&&(o.blending=F.WMw,o.depthWrite=!1),this.verbose&&1024&a&&console.warn("Flag is set but unhandled: shadowAlpha");break;case 1162102597:const c=e.getFloat32(s+6);this.verbose&&console.warn("Edge transparency threshold (0.0 to 1.0): "+c);break;case 1280658761:const p=e.getInt16(s+6)/256;this.verbose&&console.log("Luminosity (LUMI): "+p),o.emissiveIntensity=p;break;case 1145652806:const m=e.getInt16(s+6)/256;this.verbose&&console.log("Diffuse (DIFF): "+m),m||(o.color=null);break;case 1397769539:const f=e.getInt16(s+6)/256;this.verbose&&console.warn("Specular (SPEC): "+f);break;case 1380271692:let y=0;y=1447449164===y?e.getFloat32(s+6):e.getInt16(s+6)/256,o.reflectivity=y,this.verbose&&console.log("Reflectivity (REFL): "+o.reflectivity);break;case 1414676814:case Ce:let w=0;w=i===Ce?e.getFloat32(s+6):e.getInt16(s+6)/256,o.opacity=1-w,this.verbose&&console.log("Opacity (TRAN/VTRN): "+o.opacity),o.transparent=o.transparent||o.opacity<1;break;case 1447843149:const v=e.getFloat32(s+6);this.verbose&&console.log("Luminosity (VLUM): "+v),o.emissiveIntensity=v;break;case 1447315782:let b=e.getFloat32(s+6);this.verbose&&console.log("Diffuse (VDIF): "+b);break;case 1448300611:let I=e.getFloat32(s+6);this.verbose&&console.warn("Specular (VSPC): "+I);break;case 1413893191:l=e.getUint16(s+6),this.verbose&&console.log("Flags (TFLG): "+l.toString(2)),this.verbose&&1&l&&console.warn("Flag is set but unhandled: X Axis"),this.verbose&&2&l&&console.warn("Flag is set but unhandled: Y Axis"),this.verbose&&4&l&&console.warn("Flag is set but unhandled: Z Axis"),this.verbose&&8&l&&console.warn("Flag is set but unhandled: World Coords"),this.verbose&&16&l&&console.warn("Flag is set but unhandled: Negative Image"),this.verbose&&32&l&&console.warn("Flag is set but unhandled: Pixel Blending"),this.verbose&&64&l&&console.log("Flag is set: Antialiasing");break;case 1414744410:u=Re(e,s+6),this.verbose&&console.warn("Texture size (TSIZ): "+u.toArray().join(" "));break;case 1413698642:g=Re(e,s+6),this.verbose&&console.warn("Texture center (TCTR): "+g.toArray().join(" "));break;case 1129596248:case 1146373464:case 1398031704:case 1381254488:case 1414808920:case 1112819032:const E=d(new Uint8Array(t,s+6,n));this.verbose&&console.log("Texture typename: "+E);break;case 1413696594:const T=e.getUint16(s+6)/256;this.verbose&&console.warn("Texture value (TVAL): "+T);break;case 1413696594:const S=[e.getUint8(s+6+0)/255,e.getUint8(s+6+1)/255,e.getUint8(s+6+2)/255,e.getUint8(s+6+3)/255];this.verbose&&console.log("Texture color (TCLR): "+S.join(" "));break;case 1414090055:let C=d(new Uint8Array(t,s+6,n));if(this.verbose&&console.log("Texture filepath (TIMG): "+C),"(none)"===C)break;let R=!1;C.endsWith(" (sequence)")&&(R=!0,C=C.substring(0,C.length-" (sequence)".length));let P=h(C);o.transparent=o.transparent||!!P.match(/^a\d+.+.bmp/i);const L=this.path+P;if(R){const e=L.match(/(.+\D)0+(\d+)\..+/),t=ct.filterTextureSequenceNames(e[1]).map((e=>ct.getTexture(e)));if(t){let e=0;o.color=null,this.sequenceIntervals.push(setInterval((()=>{o.map=t[e++],e>=t.length&&(e=0)}),1e3/D.a4))}}const M=L.toLowerCase();if("miscanims/barrier/a_side.bmp"===M||"miscanims/barrier/a_top.bmp"===M||"world/shared/teofoilreflections.jpg"===M||"buildings/barracks/wingbase3.bmp"===M)break;o.map=ct.getTexture(L),o.color=null;break;default:this.verbose&&console.warn("Found unrecognised SURF subchunk type "+(new TextDecoder).decode(new Uint8Array(t,s,4))+" at "+s+"; length "+n)}r+=6+n}}!function(e,t,i,s,r,n,a,o){if(7&o)for(let h of e.groups)if(h.materialIndex===r)for(let e=h.start;e<h.start+h.count;e++){let r=3*s[e],h=t[r]-a.x,l=t[r+1]-a.y,c=t[r+2]-a.z,d=2*s[e],u=0,g=0;1&o?(u=c/n.z+.5,g=l/n.y+.5):2&o?(u=h/n.x+.5,g=c/n.z+.5):4&o&&(u=h/n.x+.5,g=l/n.y+.5),i[d]=u,i[d+1]=g}}(this.geometry,this.vertices,this.uvs,this.indices,a,u,g,l)}else console.error("LWOLoader.parse: Surface in SURF chunk does not exist in SRFS")}parse(e){const t=new DataView(e);if(1179603533!==t.getUint32(0))return void console.error("LWOLoader.parse: Cannot find header.");const i=t.getUint32(4);if(i+8!==t.byteLength&&console.warn("LWOLoader.parse: Discrepancy between size in header ("+(i+8)+" bytes) and actual size ("+t.byteLength+" bytes)."),1280790338!==t.getUint32(8)){const t=c(new Uint8Array(e,8,4));return void console.error("LWOLoader.parse: Invalid magic ID ("+t+") in LWO header.")}let s=12;for(;s<t.byteLength;)if(0===t.getUint8(s))s++;else{const i=t.getInt32(s),r=t.getInt32(s+4);switch(s+=8,i){case 1347310675:this.parsePoints(t,s,r);break;case 1397900883:this.parseSurfaceNames(e,s,r);break;case 1347374163:this.parsePolygons(t,s,r);break;case 1398100550:this.parseSurface(t,e,s,r);break;default:console.warn("Found unrecognised chunk type "+c(new Uint8Array(e,s-8,4))+" at "+s)}s+=r}return this.geometry.setAttribute("position",new F.TlE(this.vertices,3)),this.geometry.setAttribute("uv",new F.TlE(this.uvs,2)),this.geometry.setIndex(new F.TlE(this.indices,1)),this.geometry.computeVertexNormals(),new Se(new F.Kj0(this.geometry,this.materials),this.sequenceIntervals)}}class Le{constructor(e,t=!1){this.path="",this.verbose=!1,this.animationClip=new Ie,this.lines=[],this.lineIndex=0,this.path=e,this.verbose=t,this.verbose&&console.log("Using verbose mode")}parse(e){if(this.lines=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((e=>e.trim())),"LWSC"!==this.lines[0])throw"Invalid start of file! Expected 'LWSC' in first line";const t=parseInt(this.lines[1],10);for(1!==t&&console.warn("Unexpected scene file version: "+t),this.lineIndex=2;this.lineIndex<this.lines.length;this.lineIndex++){let e=this.lines[this.lineIndex];if(!e)continue;const t=e.split(" ")[0];"FirstFrame"===t?this.parseFrameBlock():"AddNullObject"===t||"LoadObject"===t?(this.parseObjectBlock(),this.verbose&&console.log(this.animationClip.bodies[this.animationClip.bodies.length-1])):e.startsWith("PreviewFirstFrame ")||e.startsWith("PreviewLastFrame ")||e.startsWith("PreviewFrameStep ")}return this.verbose&&console.log(this.animationClip),this.animationClip}parseLine(e){return e.split(" ").filter((e=>""!==e))}parseFrameBlock(){for(;this.lineIndex<this.lines.length;this.lineIndex++){const e=this.lines[this.lineIndex];if(!e)return;const[t,i]=this.parseLine(e);if("FirstFrame"===t)this.animationClip.firstFrame=parseInt(i);else if("LastFrame"===t)this.animationClip.lastFrame=parseInt(i);else if("FrameStep"===t){const e=parseInt(i);1!==e&&console.error("Animation frameStep has unexpected value: "+e)}else"FramesPerSecond"===t?this.animationClip.framesPerSecond=parseInt(i):"PreviewFirstFrame"===t||"PreviewLastFrame"===t||"PreviewFrameStep"===t||console.warn("Unexpected key in frame block")}console.error("Parsing block reached content end")}parseObjectBlock(){const e=new Te;for(this.animationClip.bodies.push(e);this.lineIndex<this.lines.length;this.lineIndex++){let t=this.lines[this.lineIndex];if(!t)return;const[i,s]=this.parseLine(t);if("AddNullObject"===i||"LoadObject"===i)if("LoadObject"===i){const t=h(s);e.name=t.slice(0,t.length-".lwo".length),e.filename=this.path+t;const i=ct.getResource(e.filename);e.model=nt.registerMesh(new Pe(this.path).parse(i))}else{if("AddNullObject"!==i)throw"Unexpected line: "+t;e.name=s,e.model=new F.ZAu}else if("ObjectMotion"===i){let t=this.lines[++this.lineIndex];const i=parseInt(t);t=this.lines[++this.lineIndex];const s=parseInt(t);this.lineIndex++;for(let t=0;t<s;t++){let s=this.lines[this.lineIndex+2*t];if(s.startsWith("EndBehavior"))break;const r=s.split(" ").map(Number);r.length!==i&&console.warn("Number of infos ("+r.length+") does not match if specified count ("+i+")"),s=this.lines[this.lineIndex+2*t+1];const n=parseInt(s.split(" ")[0]);e.setFrameAndFollowing(n,this.animationClip.lastFrame,r)}this.lineIndex+=2*s}else if("ParentObject"===i)e.parentObjInd=Number(s)-1,this.verbose&&console.log("parent obj ind is: "+e.parentObjInd);else if("ShowObject"===i||"LockedChannels"===i);else if("ShadowOptions"===i);else if("ObjDissolve"===i)if("(envelope)"==s){let t=this.lines[++this.lineIndex];const i=parseInt(t);1!==i&&console.error("Number of information channels for opacity is not 1, but: "+i),t=this.lines[++this.lineIndex];const s=parseInt(t);this.lineIndex++;for(let t=0;t<s;t++){let i=this.lines[this.lineIndex+2*t];if(i.startsWith("EndBehavior"))break;const s=1-Number(i);i=this.lines[this.lineIndex+2*t+1];const r=Number(i.split(" ")[0]);e.setOpacityAndFollowing(r,this.animationClip.lastFrame,s)}this.lineIndex+=2*s}else{const t=1-Number(s);e.setOpacityAndFollowing(0,this.animationClip.lastFrame,t)}}return console.error("Parsing block reached content end"),e}}var Me,xe,Ae,Oe,De,_e,ke;!function(e){e[e.aiPriorityTrain=0]="aiPriorityTrain",e[e.aiPriorityGetIn=1]="aiPriorityGetIn",e[e.aiPriorityCrystal=2]="aiPriorityCrystal",e[e.aiPriorityOre=3]="aiPriorityOre",e[e.aiPriorityRepair=4]="aiPriorityRepair",e[e.aiPriorityClearing=5]="aiPriorityClearing",e[e.aiPriorityDestruction=6]="aiPriorityDestruction",e[e.aiPriorityConstruction=7]="aiPriorityConstruction",e[e.aiPriorityReinforce=8]="aiPriorityReinforce",e[e.aiPriorityRecharge=9]="aiPriorityRecharge"}(Me||(Me={}));class Be{constructor(e){this.activityKey=e}}class Ne extends Be{}Ne.Stand=new Ne("Activity_Stand");class Fe extends class{constructor(e,t,i,s){this.group=new F.ZAu,this.superType=null,this.entityType=null,this.level=0,this.floorOffset=0,this.worldMgr=e,this.sceneMgr=t,this.superType=i,this.entityType=s}get stats(){return null}getPosition(){return this.group.position.clone()}getPosition2D(){return new F.FM8(this.group.position.x,this.group.position.z)}getHeading(){return this.group.rotation.y}onDiscover(){this.group.visible=!0}addToScene(e,t){e&&(this.group.position.copy(this.sceneMgr.getFloorPosition(e)),this.group.position.y+=this.floorOffset),null!=t&&this.group.rotateOnAxis(new F.Pa4(0,1,0),t),this.group.visible=this.surfaces.every((e=>e.discovered)),this.sceneMgr.scene.add(this.group)}removeFromScene(){this.sceneMgr.scene.remove(this.group)}get surfaces(){return[this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position)]}}{constructor(e,t,i,s,r){super(e,t,i,s),this.animationEntityType=null,this.poly=[],this.animation=null,this.animationTimeout=null,this.selectionFrame=null,this.pickSphere=null,this.carryJoint=null,this.depositJoint=null,this.getToolJoint=null,this.activity=null,this.radiusSq=0,r&&(this.animationEntityType=ct.getAnimationEntityType(r))}beamUp(){y.publishEvent(new S),this.changeActivity(),Fe.moveUp(this,6*D.pM)}static moveUp(e,t){t>0?(t--,e.group.position.y+=D.pM/D.OK/2,setTimeout((()=>Fe.moveUp(e,t)),1e3/D.OK)):e.removeFromScene()}changeActivity(e=this.getDefaultActivity(),t=null,i=null){if(this.activity===e||null===this.animationEntityType)return;this.activity=e;let s=e.activityKey.toLowerCase(),r=this.animationEntityType.activities.get(s);if(r||this.animationEntityType.activities.forEach(((e,t)=>{!r&&s.startsWith(t)&&(r=e)})),!(null==r?void 0:r.animation))return console.warn("Activity "+e.activityKey+" unknown or has no animation defined"),void console.log(this.animationEntityType.activities);t&&t.bind(this),this.animation=r.animation,this.animation.looping=!0,this.animationTimeout=m(this.animationTimeout),this.group.remove(...this.poly),this.poly=[];const n=this.carryJoint&&this.carryJoint.children||[];this.carryJoint=null,this.animation.bodies.forEach((e=>{var t,i,s;let r=l(this.animationEntityType.highPoly,e.name);r||(r=l(this.animationEntityType.mediumPoly,e.name)),r||(r=e.model);const a=r.clone(!0);if(this.poly.push(a),e.name){const r=e.name.toLowerCase();r===(null===(t=this.animationEntityType.carryNullName)||void 0===t?void 0:t.toLowerCase())?(this.carryJoint=a,n.length>0&&this.carryJoint.add(...n)):r===(null===(i=this.animationEntityType.depositNullName)||void 0===i?void 0:i.toLowerCase())?this.depositJoint=a:r===(null===(s=this.animationEntityType.toolNullName)||void 0===s?void 0:s.toLowerCase())&&(this.getToolJoint=a)}})),this.animation.bodies.forEach(((e,t)=>{const i=this.poly[t],s=e.parentObjInd;null!=s?this.poly[s].add(i):this.group.add(i)}));const a=new F.aLr;(new F.ZzF).setFromObject(this.group).getBoundingSphere(a),this.radiusSq=a.radius*a.radius,this.animate(0,t,i)}animate(e,t,i){if(this.poly.length!==this.animation.bodies.length)throw"Cannot animate poly. Length differs from bodies length";this.animation.bodies.forEach(((t,i)=>{const s=this.poly[i];if(s.position.copy(t.relPos[e]),s.rotation.copy(t.relRot[e]),s.scale.copy(t.relScale[e]),s.hasOwnProperty("material")){const i=s.material,r=t.opacity[e];i&&void 0!==r&&(Array.isArray(i)?i:[i]).forEach((e=>{e.opacity=r,e.transparent=e.transparent||e.opacity<1}))}})),this.animationTimeout=m(this.animationTimeout);let s=e+1;if(s<=this.animation.lastFrame||!t||null!==i&&i>0){s>this.animation.lastFrame&&(s=this.animation.firstFrame);const e=1e3/this.animation.framesPerSecond*this.animation.transcoef;null!==i&&(i-=e);const r=this,n=null!==i?Math.max(0,Math.min(i,e)):e;this.animationTimeout=setTimeout((()=>r.animate(s,t,i)),n)}else t&&t()}getDefaultActivity(){return Ne.Stand}createPickSphere(){if(this.pickSphere)return;const e=this.stats.PickSphere,t=e/2,i=new F.xo$(t,t,t),s=new F.vBJ({color:16776960,visible:!1});this.pickSphere=new F.Kj0(i,s),this.pickSphere.userData={selectable:this};const r=this.getPickSphereCenter();this.pickSphere.position.copy(r),this.group.add(this.pickSphere),this.createSelectionFrame(e,r)}getPickSphereCenter(){return this.getBoundingBoxCenter()}getBoundingBoxCenter(){const e=new F.Pa4;return(new F.ZzF).setFromObject(this.group).getCenter(e),e.sub(this.group.position),e.applyMatrix4((new F.yGw).makeScale(-1,1,1)),e}createSelectionFrame(e,t){const i=128,s=U(i,i);s.fillStyle="#0f0";const r=Math.round(50/e),n=21.333333333333332;s.fillRect(0,0,n,r),s.fillRect(0,0,r,n),s.fillRect(106.66666666666667,0,n,r),s.fillRect(i-r,0,r,n),s.fillRect(i-r,106.66666666666667,r,n),s.fillRect(106.66666666666667,i-r,n,r),s.fillRect(0,i-r,n,r),s.fillRect(0,106.66666666666667,r,n);const a=new F.ROQ(s.canvas),o=new F.xeV({map:a,depthTest:!1});this.selectionFrame=new F.jyi(o),this.selectionFrame.position.copy(t);const h=e;this.selectionFrame.scale.set(h,h,h),this.selectionFrame.visible=!1,this.group.add(this.selectionFrame)}}!function(e){e[e.INCOMPLETE=0]="INCOMPLETE",e[e.COMPLETE=1]="COMPLETE",e[e.CANCELED=2]="CANCELED"}(xe||(xe={}));class Ue{constructor(e){this.fulfiller=[],this.type=e,this.jobstate=xe.INCOMPLETE}assign(e){const t=this.fulfiller.indexOf(e);e&&-1===t&&this.fulfiller.push(e)}unassign(e){this.fulfiller.remove(e)}cancel(){this.jobstate=xe.CANCELED;const e=this.fulfiller;this.fulfiller=[],e.forEach((e=>e.stopJob()))}getRequiredTool(){return null}getRequiredTraining(){return null}isReadyToComplete(){return!0}onJobComplete(){this.jobstate=xe.COMPLETE}setActualWorkplace(e){}getCarryItem(){return null}getWorkActivity(){return null}getWorkDuration(){return null}}class We extends Ue{}!function(e){e[e.DRILL=0]="DRILL",e[e.REINFORCE=1]="REINFORCE",e[e.CLEAR_RUBBLE=2]="CLEAR_RUBBLE",e[e.CARRY=3]="CARRY",e[e.MOVE=4]="MOVE",e[e.TRAIN=5]="TRAIN",e[e.GET_TOOL=6]="GET_TOOL",e[e.EAT=7]="EAT",e[e.COMPLETE_POWER_PATH=8]="COMPLETE_POWER_PATH"}(Ae||(Ae={}));class He extends We{constructor(e){super(Ae.CARRY),this.actualTarget=null,this.item=e}getWorkplaces(){return this.item.getCarryTargets()}getPriorityIdentifier(){return this.item.getPriorityIdentifier()}setActualWorkplace(e){this.item.setTargetSite(e.site),this.actualTarget=e}getCarryItem(){return this.item}getWorkActivity(){return this.actualTarget.getDropAction()}isReadyToComplete(){return this.actualTarget.canGatherItem()}onJobComplete(){super.onJobComplete();const e=this.actualTarget.targetLocation;this.fulfiller.forEach((t=>{t.group.lookAt(new F.Pa4(e.x,t.group.position.y,e.y)),t.dropItem()})),this.actualTarget.gatherItem(this.item)}}class Ge extends Ne{}Ge.Teleport=new Ge("Activity_Teleport"),Ge.Deposit=new Ge("Activity_Deposit"),Ge.Explode=new Ge("Activity_Explode"),Ge.Unpowered=new Ge("Activity_Unpowered");class Je extends Ne{}Je.Route=new Je("Activity_Route"),Je.RunPanic=new Je("Activity_RunPanic"),Je.Drill=new Je("Activity_Drill"),Je.Walk=new Je("!Activity_Walk"),Je.Reinforce=new Je("Activity_Reinforce"),Je.Reverse=new Je("!Activity_Reverse"),Je.TurnLeft=new Je("!Activity_TurnLeft"),Je.TurnRight=new Je("!Activity_TurnRight"),Je.CantDo=new Je("!Activity_CantDo"),Je.Collect=new Je("Activity_Collect"),Je.Clear=new Je("Activity_Clear"),Je.Carry=new Je("Activity_Carry"),Je.CarryTurnLeft=new Je("!Activity_CarryTurnLeft"),Je.CarryTurnRight=new Je("!Activity_CarryTurnRight"),Je.CarryStand=new Je("Activity_CarryStand"),Je.Dynamite=new Je("Activity_Dynamite"),Je.Place=new Je("Activity_Place"),Je.Deposit=new Je("!Activity_Deposit"),Je.TeleportIn=new Je("Activity_TeleportIn"),Je.Repair=new Je("Activity_Repair"),Je.rest=new Je("Activity_rest"),Je.routeRubble=new Je("!Activity_routeRubble"),Je.CarryRubble=new Je("!Activity_CarryRubble"),Je.Eat=new Je("Activity_Eat"),Je.FireLaser=new Je("Activity_FireLaser"),Je.GetUp=new Je("!Activity_GetUp"),Je.ThrownByRockMonster=new Je("Activity_ThrownByRockMonster"),Je.Slip=new Je("Activity_Slip"),Je.Train=new Je("Activity_Train"),Je.Recharge=new Je("!Activity_Recharge"),Je.Waiting1=new Je("Activity_Waiting1"),Je.Waiting2=new Je("Activity_Waiting2"),Je.Waiting3=new Je("Activity_Waiting3"),Je.Waiting4=new Je("Activity_Waiting4"),Je.Hoverboard=new Je("Activity_Hoverboard"),Je.Standhoverboard=new Je("Activity_Standhoverboard"),Je.HitLefthoverboard=new Je("!Activity_HitLefthoverboard"),Je.HitRighthoverboard=new Je("!Activity_HitRighthoverboard"),Je.HitFronthoverboard=new Je("!Activity_HitFronthoverboard"),Je.HitBackhoverboard=new Je("!Activity_HitBackhoverboard"),Je.SMALLTRUCK=new Je("Activity_SMALLTRUCK"),Je.StandSMALLTRUCK=new Je("Activity_StandSMALLTRUCK"),Je.HitLeftSMALLTRUCK=new Je("!Activity_HitLeftSMALLTRUCK"),Je.HitRightSMALLTRUCK=new Je("!Activity_HitRightSMALLTRUCK"),Je.HitFrontSMALLTRUCK=new Je("!Activity_HitFrontSMALLTRUCK"),Je.HitBackSMALLTRUCK=new Je("!Activity_HitBackSMALLTRUCK"),Je.SMALLheli=new Je("Activity_SMALLheli"),Je.StandSMALLheli=new Je("Activity_StandSMALLheli"),Je.HitLeftSMALLheli=new Je("!Activity_HitLeftSMALLheli"),Je.HitRightSMALLheli=new Je("!Activity_HitRightSMALLheli"),Je.HitFrontSMALLheli=new Je("!Activity_HitFrontSMALLheli"),Je.HitBackSMALLheli=new Je("!Activity_HitBackSMALLheli"),Je.SMALLCAT=new Je("Activity_SMALLCAT"),Je.StandSMALLCAT=new Je("Activity_StandSMALLCAT"),Je.HitLeftSMALLCAT=new Je("!Activity_HitLeftSMALLCAT"),Je.HitRightSMALLCAT=new Je("!Activity_HitRightSMALLCAT"),Je.HitFrontSMALLCAT=new Je("!Activity_HitFrontSMALLCAT"),Je.HitBackSMALLCAT=new Je("!Activity_HitBackSMALLCAT"),Je.SMALLMLP=new Je("Activity_SMALLMLP"),Je.StandSMALLMLP=new Je("Activity_StandSMALLMLP"),Je.HitLeftSMALLMLP=new Je("!Activity_HitLeftSMALLMLP"),Je.HitRightSMALLMLP=new Je("!Activity_HitRightSMALLMLP"),Je.HitFrontSMALLMLP=new Je("!Activity_HitFrontSMALLMLP"),Je.HitBackSMALLMLP=new Je("!Activity_HitBackSMALLMLP"),Je.LARGECAT=new Je("Activity_LARGECAT"),Je.StandLARGECAT=new Je("Activity_StandLARGECAT"),Je.HitLeftLARGECAT=new Je("!Activity_HitLeftLARGECAT"),Je.HitRightLARGECAT=new Je("!Activity_HitRightLARGECAT"),Je.HitFrontLARGECAT=new Je("!Activity_HitFrontLARGECAT"),Je.HitBackLARGECAT=new Je("!Activity_HitBackLARGECAT"),Je.SMALLDIGGER=new Je("Activity_SMALLDIGGER"),Je.StandSMALLDIGGER=new Je("Activity_StandSMALLDIGGER");class Ve{constructor(e){this.targetLocation=e}isInArea(e){return!1}canGatherItem(){return!1}gatherItem(e){e.addToScene(null,null)}getDropAction(){return Je.Place}}class Ye extends Ve{constructor(e,t,i){super(e),this.site=t,this.building=i}canGatherItem(){return!this.building||this.building.activity.activityKey===this.building.getDefaultActivity().activityKey}gatherItem(e){this.site?this.site.addItem(e):this.building?this.building.entityType===M.POWER_STATION||this.building.entityType===M.ORE_REFINERY?(this.building.carryJoint&&(this.building.carryJoint.add(e.group),e.group.position.set(0,0,0)),this.building.changeActivity(Ge.Deposit,(()=>{this.building.changeActivity(),this.building.carryJoint&&this.building.carryJoint.remove(e.group),Ye.addItemToStorage(e)}))):(e.removeFromScene(),Ye.addItemToStorage(e)):e.addToScene(null,null)}static addItemToStorage(e){switch(e.entityType){case M.CRYSTAL:N.numCrystal++,y.publishEvent(new de(e.entityType));break;case M.ORE:N.numOre++,y.publishEvent(new de(e.entityType))}}getDropAction(){return(this.building||this.site).getDropAction()}}class je extends Fe{constructor(e,t,i,s=null){super(e,t,x.MATERIAL,i,s),this.targetBuildingTypes=[],this.priorityIdentifier=null,this.targets=[],this.targetSite=null,this.targetBuildingTypes=[M.TOOLSTATION]}getCarryTargets(){return this.updateTargets()}resetTarget(){this.targets=[],this.targetSite=null,this.updateTargets()}updateTargets(){if(this.targets.length<1){const e=N.buildingSites.filter((e=>e.needs(this.entityType)));if(e.length>0)this.targets=e.map((e=>new Ye(e.getRandomDropPosition(),e,null)));else{const e=N.getBuildingsByType(...this.getTargetBuildingTypes());e.length>0&&(this.targets=e.map((e=>new Ye(e.getDropPosition2D(),null,e))))}}else(this.targets.some((e=>e.site&&e.site.complete))||this.targets.some((e=>e.building&&!e.building.isPowered())))&&this.resetTarget();return this.targets}onDiscover(){super.onDiscover(),N.materialsUndiscovered.remove(this),N.materials.push(this),y.publishEvent(new he(this.createCarryJob()))}setTargetSite(e){var t,i;this.targetSite!==e&&(null===(t=this.targetSite)||void 0===t||t.unAssign(this),this.targetSite=e,null===(i=this.targetSite)||void 0===i||i.assign(this))}getPriorityIdentifier(){return this.priorityIdentifier}getTargetBuildingTypes(){return this.targetBuildingTypes}createCarryJob(){return new He(this)}onAddToSite(){this.addToScene(null,null)}}class Xe extends je{constructor(e,t){super(e,t,M.CRYSTAL);const i=ct.getResource("MiscAnims/Crystal/vlp_greencrystal.lwo"),s=nt.registerMesh(new Pe("MiscAnims/Crystal/").parse(i));s.material.forEach((e=>{e.blending=F.WMw,e.depthWrite=!1,e.opacity=.5,e.transparent=e.opacity<1})),s.scale.set(1.75,1.75,1.75),this.group.add(s);const r=ct.getResource("World/Shared/Crystal.lwo"),n=nt.registerMesh(new Pe("World/Shared/").parse(r));n.material.forEach((e=>{e.emissive=new F.Ilk(0,8,0),e.color=new F.Ilk(0,0,0),e.opacity=.9,e.transparent=e.opacity<1})),this.group.add(n),this.targetBuildingTypes=[M.POWER_STATION,M.TOOLSTATION],this.priorityIdentifier=Me.aiPriorityCrystal}get stats(){return ct.stats.PowerCrystal}}class Ke extends Be{}Ke.Normal=new Ke("Normal"),Ke.TickDown=new Ke("TickDown");class qe extends He{constructor(e){super(e),this.color=10510432}getRequiredTraining(){return B.DEMOLITION}onJobComplete(){super.onJobComplete(),this.item.ignite()}}class ze extends je{constructor(e,t,i){super(e,t,M.DYNAMITE,"MiscAnims/Dynamite/Dynamite.ae"),this.targetSurface=i,this.priorityIdentifier=Me.aiPriorityDestruction,this.changeActivity()}getCarryTargets(){return this.targetSurface&&this.targetSurface.isExplodable()?this.targetSurface.getDigPositions().map((e=>new Ye(e,null,null))):N.getBuildingsByType(M.TOOLSTATION).map((e=>e.getDropPosition2D())).map((e=>new Ye(e,null,null)))}ignite(){const e=this.targetSurface.getCenterWorld();e.y=this.group.position.y,this.group.lookAt(e),this.changeActivity(Ke.TickDown,(()=>{this.removeFromScene(),this.targetSurface.collapse()}))}getDefaultActivity(){return Ke.Normal}createCarryJob(){return new qe(this)}}class Ze extends je{constructor(e,t){super(e,t,M.ORE);const i=ct.getResource("MiscAnims/Ore/Ore1st.lwo"),s=nt.registerMesh(new Pe("MiscAnims/Ore/").parse(i));this.group.add(s),this.targetBuildingTypes=[M.ORE_REFINERY,M.TOOLSTATION],this.priorityIdentifier=Me.aiPriorityOre}get stats(){return ct.stats.Ore}}class $e{constructor(e){this.name=e}}$e.DRILL=new $e("drill"),$e.HAMMER=new $e("hammer"),$e.SHOVEL=new $e("shovel"),$e.SPANNER=new $e("spanner"),$e.FREEZERGUN=new $e("freezergun"),$e.LASER=new $e("laser"),$e.PUSHERGUN=new $e("pushergun"),$e.BIRDSCARER=new $e("birdscarer");class Qe extends We{constructor(e){super(Ae.CLEAR_RUBBLE),this.surface=e}getRequiredTool(){return $e.SHOVEL}getWorkplaces(){const e=this.surface.rubblePositions;return e.length>0?[new Ve(e[0])]:[]}onJobComplete(){this.fulfiller.forEach((e=>e.changeActivity())),this.surface.reduceRubble(),this.fulfiller.forEach((e=>e.jobWorkplaces=this.getWorkplaces())),this.surface.hasRubble()||super.onJobComplete()}getPriorityIdentifier(){return Me.aiPriorityClearing}getWorkActivity(){return Je.Clear}}class et extends We{constructor(e){super(Ae.DRILL),this.color=10526880,this.surface=e}getRequiredTool(){return $e.DRILL}getWorkplaces(){return this.surface.getDigPositions().map((e=>new Ve(e)))}onJobComplete(){super.onJobComplete(),this.surface.collapse()}getPriorityIdentifier(){return Me.aiPriorityDestruction}getWorkActivity(){return Je.Drill}}class tt extends We{constructor(e){super(Ae.REINFORCE),this.color=6332512,this.surface=e}getWorkplaces(){return this.surface.getDigPositions().map((e=>new Ve(e)))}onJobComplete(){super.onJobComplete(),this.surface.reinforce()}getPriorityIdentifier(){return Me.aiPriorityReinforce}getWorkActivity(){return Je.Reinforce}getWorkDuration(){return 2700}}class it{constructor(e,t,i,s,r){this.containedOres=0,this.containedCrystals=0,this.heightOffset=null,this.discovered=!1,this.selected=!1,this.reinforced=!1,this.drillJob=null,this.reinforceJob=null,this.dynamiteJob=null,this.clearRubbleJob=null,this.surfaceRotation=0,this.seamLevel=0,this.fallinTimeout=null,this.fallinGrp=null,this.animationTimeout=null,this.wallType=null,this.mesh=null,this.needsMeshUpdate=!1,this.topLeftHeightOffset=0,this.topRightHeightOffset=0,this.bottomLeftHeightOffset=0,this.bottomRightHeightOffset=0,this.rubblePositions=[],this.building=null,this.fence=null,this.hasPower=!1,this.terrain=e,this.worldMgr=this.terrain.worldMgr,this.sceneMgr=this.terrain.sceneMgr,this.surfaceType=t,t!==q.CRYSTAL_SEAM&&t!==q.ORE_SEAM||(this.seamLevel=4),this.x=i,this.y=s,this.heightOffset=r}discover(){if(this.discovered||N.discoverSurface(this),this.discovered=!0,this.needsMeshUpdate=!0,!this.surfaceType.floor)return!1;const e=[],t=[];for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){if(0===i&&0===s)continue;const r=this.terrain.getSurface(this.x+i,this.y+s);0!==i&&0!==s||!r.surfaceType.floor?t.push(r):e.push(r)}let i=!1,s=0;for(;e.length>0;){s++;const r=e.shift();r.discovered=!0,r.needsMeshUpdate=!0;for(let s=-1;s<=1;s++)for(let n=-1;n<=1;n++){if(0===s&&0===n)continue;const a=r.terrain.getSurface(r.x+s,r.y+n);0!==s&&0!==n||!a.surfaceType.floor||a.discovered?t.push(a):(e.push(a),i=!0)}}return t.forEach((e=>{e.discovered=!0,e.needsMeshUpdate=!0,e.isSupported()||e.collapse()})),console.log("surface discover handled "+s+" floors and "+t.length+" others"),i}collapse(){this.cancelJobs(),this.fallinTimeout=m(this.fallinTimeout),this.surfaceType=q.RUBBLE4,this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=4,this.needsMeshUpdate=!0,this.discover()&&y.publishEvent(new ge),this.dropContainedOre(this.containedOres-4);for(let e=0;e<this.containedCrystals;e++){const e=this.worldMgr.placeMaterial(new Xe(this.worldMgr,this.sceneMgr),this.getRandomPosition());y.publishEvent(new we(e.getPosition()))}for(let e=this.x-1;e<=this.x+1;e++)for(let t=this.y-1;t<=this.y+1;t++)if(e!==this.x||t!==this.y){const i=this.terrain.getSurface(e,t);i.needsMeshUpdate=!0,i.isSupported()||i.collapse()}this.terrain.updateSurfaceMeshes(),this.terrain.floorGroup.updateWorldMatrix(!0,!0)}dropContainedOre(e){for(let t=0;t<e&&this.containedOres>0;t++)this.containedOres--,this.worldMgr.placeMaterial(new Ze(this.worldMgr,this.sceneMgr),this.getRandomPosition()),y.publishEvent(new pe)}getRandomPosition(){return new F.FM8(this.x*D.pM+D.pM/2+p()*g(D.pM/4),this.y*D.pM+D.pM/2+p()*g(D.pM/4))}cancelJobs(){this.drillJob=it.safeRemoveJob(this.drillJob),this.reinforceJob=it.safeRemoveJob(this.reinforceJob),this.dynamiteJob=it.safeRemoveJob(this.dynamiteJob),this.clearRubbleJob=it.safeRemoveJob(this.clearRubbleJob),this.updateJobColor()}static safeRemoveJob(e){return e&&y.publishEvent(new le(e)),null}reduceRubble(){this.rubblePositions.shift(),this.surfaceType===q.RUBBLE4?this.surfaceType=q.RUBBLE3:this.surfaceType===q.RUBBLE3?this.surfaceType=q.RUBBLE2:this.surfaceType===q.RUBBLE2?this.surfaceType=q.RUBBLE1:this.surfaceType===q.RUBBLE1&&(this.surfaceType=q.GROUND),this.dropContainedOre(this.containedOres-this.rubblePositions.length),this.updateTexture(),y.publishEvent(new C(this))}isSupported(){if(this.surfaceType.floor)return!0;const e=this.terrain.getSurface(this.x-1,this.y),t=this.terrain.getSurface(this.x-1,this.y-1),i=this.terrain.getSurface(this.x,this.y-1),s=this.terrain.getSurface(this.x+1,this.y-1),r=this.terrain.getSurface(this.x+1,this.y),n=this.terrain.getSurface(this.x+1,this.y+1),a=this.terrain.getSurface(this.x,this.y+1),o=this.terrain.getSurface(this.x-1,this.y+1);function h(e,t,i){return!(e.discovered&&t.discovered&&i.discovered&&(e.surfaceType.floor||t.surfaceType.floor||i.surfaceType.floor))}return h(e,t,i)||h(i,s,r)||h(r,n,a)||h(a,o,e)}updateMesh(e=!0){if(!e&&!this.needsMeshUpdate)return;this.needsMeshUpdate=!1;const t=new F.Pa4(this.x,0,this.y),i=new F.Pa4(this.x+1,0,this.y),s=new F.Pa4(this.x,0,this.y+1),r=new F.Pa4(this.x+1,0,this.y+1),n=this.terrain.getSurface(this.x-1,this.y),a=this.terrain.getSurface(this.x-1,this.y-1),o=this.terrain.getSurface(this.x,this.y-1),h=this.terrain.getSurface(this.x+1,this.y-1),l=this.terrain.getSurface(this.x+1,this.y),c=this.terrain.getSurface(this.x+1,this.y+1),d=this.terrain.getSurface(this.x,this.y+1),u=this.terrain.getSurface(this.x-1,this.y+1);function g(e,t,i){return!(e.discovered&&t.discovered&&i.discovered&&(e.surfaceType.floor||t.surfaceType.floor||i.surfaceType.floor))}this.discovered?this.surfaceType.floor&&this.neighbors.some((e=>e.surfaceType.floor&&e.discovered))||(g(n,a,o)&&(t.y=1),g(o,h,l)&&(i.y=1),g(l,c,d)&&(r.y=1),g(d,u,n)&&(s.y=1)):(t.y=1,i.y=1,r.y=1,s.y=1);let p=t.y+i.y+r.y+s.y;p===z.WALL&&t.y===r.y&&(p=z.WEIRD_CREVICE),this.wallType!==p&&(this.wallType=p,this.updateGeometry(t,r,i,s,a,o,n,h,l,c,d,u),this.wallType!==z.WALL&&this.cancelReinforceJobs()),this.updateTexture(),this.updateJobColor(),this.updateGraphWalk()}updateGraphWalk(){const e=this.getGraphWalkWeight();for(let t=0;t<3;t++)for(let i=0;i<3;i++)this.terrain.graphWalk.grid[3*this.x+t][3*this.y+i].weight=e}cancelReinforceJobs(){this.reinforceJob=it.safeRemoveJob(this.reinforceJob),this.updateJobColor()}updateTexture(){let e=this.terrain.textureSet.texturebasename;this.discovered?this.surfaceType===q.POWER_PATH?e+=this.updatePowerPathTexture():!this.surfaceType.shaping&&this.neighbors.some((e=>e.discovered&&e.surfaceType.floor))?this.surfaceType===q.POWER_PATH_BUILDING&&this.hasPower?e+="66":e+=this.surfaceType.matIndex.toString():this.wallType===z.WEIRD_CREVICE?e+="77":(this.wallType===z.CORNER?e+="5":this.wallType===z.INVERTED_CORNER?e+="3":this.reinforced?e+="2":e+="0",e+=this.surfaceType.shaping?this.surfaceType.matIndex:q.SOLID_ROCK.matIndex):e+="70",e+=".bmp";const t=ct.getTexture(e);t.center.set(.5,.5),t.rotation=this.surfaceRotation,this.accessMaterials().forEach((e=>e.map=t))}updatePowerPathTexture(){this.surfaceRotation=0;const e=this.terrain.getSurface(this.x-1,this.y).isPath(),t=this.terrain.getSurface(this.x,this.y-1).isPath(),i=this.terrain.getSurface(this.x+1,this.y).isPath(),s=this.terrain.getSurface(this.x,this.y+1).isPath(),r=(e?1:0)+(t?1:0)+(i?1:0)+(s?1:0);return 0===r||1===r?(e&&(this.surfaceRotation=-Math.PI/2),t&&(this.surfaceRotation=Math.PI),i&&(this.surfaceRotation=Math.PI/2),this.hasPower?"75":"65"):2===r?e===i?(this.surfaceRotation=e?Math.PI/2:0,this.hasPower?"72":"62"):(e&&s&&(this.surfaceRotation=-Math.PI/2),e&&t&&(this.surfaceRotation=Math.PI),t&&i&&(this.surfaceRotation=Math.PI/2),this.hasPower?"73":"63"):3===r?(t||(this.surfaceRotation=-Math.PI/2),i||(this.surfaceRotation=Math.PI),s||(this.surfaceRotation=Math.PI/2),this.hasPower?"74":"64"):this.hasPower?"71":"60"}accessMaterials(){return this.mesh&&this.mesh.material?Array.isArray(this.mesh.material)?this.mesh.material:[this.mesh.material]:[]}updateGeometry(e,t,i,s,r,n,a,o,h,l,c,d){var u,g;function p(...e){let t=0,i=0;return e.map((e=>e.heightOffset)).filter(Boolean).forEach((e=>{t+=e,i++})),t/i}this.mesh&&this.terrain.floorGroup.remove(this.mesh),null===(g=null===(u=this.mesh)||void 0===u?void 0:u.geometry)||void 0===g||g.dispose(),this.topLeftHeightOffset=p(r,n,this,a)*D.ED,this.topRightHeightOffset=p(n,o,h,this)*D.ED,this.bottomRightHeightOffset=p(this,h,l,c)*D.ED,this.bottomLeftHeightOffset=p(a,this,c,d)*D.ED;const m=$.create(this.wallType,e,t,i,s,e.y+this.topLeftHeightOffset,i.y+this.topRightHeightOffset,t.y+this.bottomRightHeightOffset,s.y+this.bottomLeftHeightOffset);this.mesh=new F.Kj0(m,new F.xoR({shininess:0})),this.mesh.userData={selectable:this,surface:this},this.terrain.floorGroup.add(this.mesh),this.terrain.floorGroup.updateWorldMatrix(!0,!0)}getSelectionType(){return A.SURFACE}select(){return this.surfaceType.selectable&&this.wallType!==z.INVERTED_CORNER&&this.wallType!==z.WEIRD_CREVICE&&!this.selected&&this.discovered?(this.selected=!0,this.accessMaterials().forEach((e=>e.color.setHex(6316192))),console.log("Surface selected at "+this.x+"/"+this.y),new I(this)):null}deselect(){this.selected&&(this.selected=!1,this.updateJobColor())}getSelectionCenter(){return null}updateJobColor(){var e,t,i;const s=(null===(e=this.dynamiteJob)||void 0===e?void 0:e.color)||(null===(t=this.reinforceJob)||void 0===t?void 0:t.color)||(null===(i=this.drillJob)||void 0===i?void 0:i.color)||16777215;this.accessMaterials().forEach((e=>e.color.setHex(s)))}hasRubble(){return this.rubblePositions.length>0}isPath(){return this.surfaceType===q.POWER_PATH||this.surfaceType===q.POWER_PATH_BUILDING}isWalkable(){var e;return this.surfaceType.floor&&this.discovered&&this.surfaceType!==q.LAVA&&this.surfaceType!==q.WATER&&!(null===(e=this.building)||void 0===e?void 0:e.blocksPathSurface)}isDrillable(){return this.surfaceType.drillable&&this.discovered&&(this.wallType===z.WALL||this.wallType===z.CORNER)}isDrillableHard(){return this.surfaceType.drillableHard&&this.discovered&&(this.wallType===z.WALL||this.wallType===z.CORNER)}isReinforcable(){return this.surfaceType.reinforcable&&this.discovered&&this.wallType===z.WALL&&!this.reinforced}isExplodable(){return this.surfaceType.explodable&&this.discovered&&(this.wallType===z.WALL||this.wallType===z.CORNER)}isDigable(){return this.isDrillable()||this.isExplodable()}getDigPositions(){const e=[];return this.terrain.getSurface(this.x-1,this.y).isWalkable()&&e.push(new F.FM8(this.x*D.pM-1,this.y*D.pM+D.pM/2)),this.terrain.getSurface(this.x,this.y-1).isWalkable()&&e.push(new F.FM8(this.x*D.pM+D.pM/2,this.y*D.pM-1)),this.terrain.getSurface(this.x+1,this.y).isWalkable()&&e.push(new F.FM8(this.x*D.pM+D.pM+1,this.y*D.pM+D.pM/2)),this.terrain.getSurface(this.x,this.y+1).isWalkable()&&e.push(new F.FM8(this.x*D.pM+D.pM/2,this.y*D.pM+D.pM+1)),e}reinforce(){this.reinforced=!0,this.cancelReinforceJobs(),this.fallinTimeout=m(this.fallinTimeout),this.updateTexture()}getCenterWorld2D(){return new F.FM8(this.x,this.y).addScalar(.5).multiplyScalar(D.pM)}getCenterWorld(){const e=this.getCenterWorld2D();return new F.Pa4(e.x,this.sceneMgr.getTerrainHeight(e.x,e.y),e.y)}setFallinLevel(e){if(e<1)return;let t,i;this.surfaceType.floor?(t=this.terrain.findFallInOrigin(this.x,this.y),i=[this.x,this.y]):(t=[this.x,this.y],i=this.terrain.findFallInTarget(this.x,this.y)),t&&i&&this.terrain.getSurface(t[0],t[1]).scheduleFallin(i[0],i[1])}scheduleFallin(e,t){this.fallinTimeout=setTimeout((()=>{this.createFallin(e,t),this.scheduleFallin(e,t)}),1e3*(30+g(60)))}createFallin(e,t){const i=this.terrain.getSurface(e,t).getCenterWorld();y.publishEvent(new ve(i));const s=ct.getResource("MiscAnims/RockFall/Rock3Sides.lws"),r=new Le("MiscAnims/RockFall/").parse(s);this.fallinGrp=new F.ZAu,this.fallinGrp.position.copy(i);const n=this.x-e,a=t-this.y;this.fallinGrp.rotateOnAxis(new F.Pa4(0,1,0),Math.atan2(a,n)+Math.PI/2),this.sceneMgr.scene.add(this.fallinGrp);const o=[];r.bodies.forEach((e=>{const t=e.model.clone(!0);o.push(t)})),r.bodies.forEach(((e,t)=>{const i=o[t],s=e.parentObjInd;null!=s?o[s].add(i):this.fallinGrp.add(i)})),this.animate(o,r,0),this.terrain.getSurface(e,t).makeRubble()}animate(e,t,i){if(e.length!==t.bodies.length)throw"Cannot animate poly. Length differs from bodies length";if(t.bodies.forEach(((t,s)=>{const r=e[s];if(r.position.copy(t.relPos[i]),r.rotation.copy(t.relRot[i]),r.scale.copy(t.relScale[i]),r.hasOwnProperty("material")){const e=r.material,s=t.opacity[i];e&&void 0!==s&&(Array.isArray(e)?e:[e]).forEach((e=>{e.opacity=s,e.transparent=e.transparent||e.opacity<1}))}})),this.animationTimeout=null,i+1>t.lastFrame&&!t.looping)this.sceneMgr.scene.remove(this.fallinGrp),this.fallinGrp=null;else{let s=i+1;s>t.lastFrame&&(s=t.firstFrame);const r=this;this.animationTimeout=setTimeout((()=>r.animate(e,t,s)),1e3/t.framesPerSecond*t.transcoef)}}dispose(){var e,t;this.fallinTimeout=m(this.fallinTimeout),this.accessMaterials().forEach((e=>e.dispose())),null===(t=null===(e=this.mesh)||void 0===e?void 0:e.geometry)||void 0===t||t.dispose()}getFloorHeight(e,t){const i=e/D.pM-this.x,s=t/D.pM-this.y,r=it.interpolate(this.topLeftHeightOffset,this.topRightHeightOffset,i),n=it.interpolate(this.bottomLeftHeightOffset,this.bottomRightHeightOffset,i);return it.interpolate(r,n,s)*D.pM}static interpolate(e,t,i){return e+i*(t-e)}get neighbors(){return[this.terrain.getSurface(this.x-1,this.y),this.terrain.getSurface(this.x,this.y-1),this.terrain.getSurface(this.x+1,this.y),this.terrain.getSurface(this.x,this.y+1)]}makeRubble(e=0){this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=e,this.surfaceType=q.RUBBLE4,this.updateTexture()}setBuilding(e){this.building=e,this.updateGraphWalk()}getGraphWalkWeight(){return this.isWalkable()?this.hasRubble()?4:1:0}setHasPower(e,t){this.hasPower!==e&&(this.hasPower=e,this.updateTexture(),t&&this.neighbors.forEach((i=>i.isPath()&&i.setHasPower(e,t))))}canPlaceFence(){return(this.surfaceType===q.GROUND||this.isPath())&&!this.building&&!this.fence&&[1,2].some((e=>!!(this.terrain.getSurface(this.x-e,this.y).building||this.terrain.getSurface(this.x,this.y-e).building||this.terrain.getSurface(this.x+e,this.y).building||this.terrain.getSurface(this.x,this.y+e).building||this.terrain.getSurface(this.x-e,this.y).fence||this.terrain.getSurface(this.x,this.y-e).fence||this.terrain.getSurface(this.x+e,this.y).fence||this.terrain.getSurface(this.x,this.y+e).fence)))}createDrillJob(){return this.drillJob||(this.drillJob=new et(this),this.updateJobColor(),y.publishEvent(new he(this.drillJob))),this.drillJob}createReinforceJob(){return this.reinforceJob||(this.reinforceJob=new tt(this),this.updateJobColor(),y.publishEvent(new he(this.reinforceJob))),this.reinforceJob}createDynamiteJob(){if(!this.dynamiteJob){const e=N.getClosestBuildingByType(this.getCenterWorld(),M.TOOLSTATION);if(!e)throw"Could not find toolstation to spawn dynamite";const t=new ze(this.worldMgr,this.sceneMgr,this);t.addToScene(e.getDropPosition2D(),e.getHeading()),this.dynamiteJob=new qe(t),this.updateJobColor(),y.publishEvent(new he(this.dynamiteJob))}return this.dynamiteJob}createClearRubbleJob(){return this.clearRubbleJob||(this.clearRubbleJob=new Qe(this),this.updateJobColor(),y.publishEvent(new he(this.clearRubbleJob))),this.clearRubbleJob}}class st{constructor(e,t){this.target=null,this.locations=[],this.lengthSq=0,this.target=e,this.locations=Array.isArray(t)?t:[t];for(let e=0;e<this.locations.length-1;e++){const t=this.locations[e],i=this.locations[e+1];this.lengthSq+=t.distanceToSquared(i)}}addLocation(e){return this.locations.push(e),this.locations.length>1&&(this.lengthSq+=this.locations[this.locations.length-2].distanceToSquared(e)),this}get targetPosition(){return this.locations[this.locations.length-1]||null}get firstLocation(){return this.locations[0]||null}}class rt{constructor(e,t){this.textureSet={},this.width=0,this.height=0,this.surfaces=[],this.floorGroup=new F.ZAu,this.roofGroup=new F.ZAu,this.graphWalk=null,this.cachedPaths=new Map,this.worldMgr=e,this.sceneMgr=t,this.floorGroup.scale.setScalar(D.pM),this.roofGroup.scale.setScalar(D.pM),this.roofGroup.visible=!1,y.registerEventListener(s.ENTITY_ADDED,(e=>{e.superType===x.BUILDING&&e.entity.surfaces.forEach((e=>e.neighbors.forEach((e=>e.updateTexture()))))}))}getSurfaceFromWorld(e){return this.getSurfaceFromWorldXZ(e.x,e.z)}getSurfaceFromWorld2D(e){return this.getSurfaceFromWorldXZ(e.x,e.y)}getSurfaceFromWorldXZ(e,t){return this.getSurface(e/D.pM,t/D.pM)}getSurface(e,t){return e=Math.floor(e),t=Math.floor(t),this.getSurfaceOrNull(e,t)||new it(this,q.SOLID_ROCK,e,t,0)}getSurfaceOrNull(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height?this.surfaces[e][t]:null}updateSurfaceMeshes(e=!1){this.forEachSurface((t=>t.updateMesh(e))),this.floorGroup.updateWorldMatrix(!0,!0),this.resetGraphWalk()}resetGraphWalk(){this.graphWalk.init(),this.cachedPaths.clear(),console.log("Cached paths cleared")}findPath(e,t){const i=t.targetLocation,s=Math.floor(3*e.x/D.pM),r=Math.floor(3*e.y/D.pM),n=Math.floor(3*i.x/D.pM),a=Math.floor(3*i.y/D.pM);if(s===n&&r===a)return new st(t,i);const o=s+"/"+r+" -> "+n+"/"+a,h=this.cachedPaths.get(o);return h?h.addLocation(i):this.searchPath(s,r,n,a,t,o)}searchPath(e,t,i,s,r,n){const a=this.graphWalk.grid[e][t],o=this.graphWalk.grid[i][s],h=ie.search(this.graphWalk,a,o).map((e=>rt.gridNodeToWorldPos(e)));return h.length<1?null:(h.pop(),h.push(r.targetLocation),this.cachedPaths.set(n,new st(r,h.slice(0,-1))),new st(r,h))}static gridNodeToWorldPos(e){return new F.FM8(Math.random(),Math.random()).divideScalar(2).add(e).multiplyScalar(D.pM/3)}findFallInOrigin(e,t){const i=this.getSurface(e-1,t);if(i.isReinforcable())return[i.x,i.y];const s=this.getSurface(e,t-1);if(s.isReinforcable())return[s.x,s.y];const r=this.getSurface(e+1,t);if(r.isReinforcable())return[r.x,r.y];const n=this.getSurface(e,t+1);if(n.isReinforcable())return[n.x,n.y];const a=this.getSurface(e-1,t);if(a.isDigable())return[a.x,a.y];const o=this.getSurface(e,t-1);if(o.isDigable())return[o.x,o.y];const h=this.getSurface(e+1,t);if(h.isDigable())return[h.x,h.y];const l=this.getSurface(e,t+1);return l.isDigable()?[l.x,l.y]:null}findFallInTarget(e,t){const i=this.getSurface(e-1,t);if(i.isWalkable())return[i.x,i.y];const s=this.getSurface(e,t-1);if(s.isWalkable())return[s.x,s.y];const r=this.getSurface(e+1,t);if(r.isWalkable())return[r.x,r.y];const n=this.getSurface(e,t+1);return n.isWalkable()?[n.x,n.y]:null}dispose(){this.forEachSurface((e=>e.dispose()))}forEachSurface(e){var t;null===(t=this.surfaces)||void 0===t||t.forEach((t=>t.forEach((t=>e(t)))))}countDiggables(){let e=0;return this.forEachSurface((t=>e+=t.isDigable()?1:0)),e}countCrystals(){let e=0;return this.forEachSurface((t=>e+=t.containedCrystals)),e}countOres(){let e=0;return this.forEachSurface((t=>e+=t.containedOres)),e}}!function(e){e[e.NONE=0]="NONE",e[e.RUBBLE=1]="RUBBLE",e[e.POWER_PATH=2]="POWER_PATH"}(Oe||(Oe={})),function(e){e[e.WALL=0]="WALL",e[e.CAVERN_EXPOSED=1]="CAVERN_EXPOSED",e[e.CAVERN_HIDDEN=2]="CAVERN_HIDDEN",e[e.SLUG_HOLE_EXPOSED=3]="SLUG_HOLE_EXPOSED",e[e.SLUG_HOLE_HIDDEN=4]="SLUG_HOLE_HIDDEN"}(De||(De={}));class nt{constructor(e){this.maxFps=30,this.debugHelper=new j,this.renderer=new F.CP7({antialias:!0,canvas:e}),this.renderer.setClearColor(0),this.camera=new F.cPb(30,e.width/e.height,.1,5e3),this.controls=new V.o(this.camera,this.renderer.domElement),this.controls.mouseButtons={LEFT:null,MIDDLE:F.RsA.ROTATE,RIGHT:F.RsA.PAN},this.buildMarker=new ee,y.registerEventListener(s.CANCEL_BUILD_MODE,(()=>{N.buildModeSelection=null,this.buildMarker.hideAllMarker()}))}selectEntitiesByRay(e,t){const i=new F.iMs;i.setFromCamera({x:e,y:t},this.camera);let s=i.intersectObjects(N.raiders.map((e=>e.pickSphere)));s.length<1&&(s=i.intersectObjects(N.buildings.map((e=>e.pickSphere)))),s.length<1&&this.terrain&&(s=i.intersectObjects(this.terrain.floorGroup.children));const r=[];if(s.length>0){const e=s[0].object.userData;if(e&&e.hasOwnProperty("selectable")){const t=e.selectable;t&&r.push(t)}}N.selectEntities(r)}selectEntitiesInFrustum(e,t,i,s){const r=new F.Pa4(e,t,.5),n=new F.Pa4(i,s,.5);r.x===n.x&&(n.x+=Number.EPSILON),r.y===n.y&&(n.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld();const a=new F.Pa4;a.copy(r),a.x=Math.min(r.x,n.x),a.y=Math.max(r.y,n.y),n.x=Math.max(r.x,n.x),n.y=Math.min(r.y,n.y);const o=new F.Pa4,h=new F.Pa4,l=new F.Pa4,c=new F.Pa4,d=new F.Pa4;o.setFromMatrixPosition(this.camera.matrixWorld),h.copy(a),l.set(n.x,a.y,0),c.copy(n),d.set(a.x,n.y,0),h.unproject(this.camera),l.unproject(this.camera),c.unproject(this.camera),d.unproject(this.camera);const u=new F.Pa4,g=new F.Pa4,p=new F.Pa4;u.copy(h).sub(o),g.copy(l).sub(o),p.copy(c).sub(o),u.normalize(),g.normalize(),p.normalize();const m=Number.MAX_VALUE;u.multiplyScalar(m),g.multiplyScalar(m),p.multiplyScalar(m),u.add(o),g.add(o),p.add(o);const f=new F.iWj,y=f.planes;y[0].setFromCoplanarPoints(o,h,l),y[1].setFromCoplanarPoints(o,l,c),y[2].setFromCoplanarPoints(c,d,o),y[3].setFromCoplanarPoints(d,h,o),y[4].setFromCoplanarPoints(l,c,d),y[5].setFromCoplanarPoints(p,g,u),y[5].normal.multiplyScalar(-1);let w=N.raiders.filter((e=>f.containsPoint(e.getSelectionCenter())));w.length<1&&(w=N.buildings.filter((e=>f.containsPoint(e.getSelectionCenter())))),N.selectEntities(w)}setupScene(e,t){this.scene=new F.xsS;const i=ct.cfg("Main","AmbientRGB")||[10,10,10],s=Math.min(255,Math.max(0,...i)),r=i.map((e=>e/(s||1))),n=new F.Ilk(r[0],r[1],r[2]);this.ambientLight=new F.Mig(n,.4),this.scene.add(this.ambientLight),this.cursorTorchlight=new F.cek(16777215,1.5,4,1),this.cursorTorchlight.distance*=D.pM,this.scene.add(this.cursorTorchlight),this.scene.add(this.buildMarker.group),this.terrain=class{static loadTerrain(e,t,i){var s,r,n,a,o,h;const l=e.blockSize;l!==D.pM&&console.error("Unexpected tile size in level configuration: "+l);const c=new rt(t,i),d=e.textureSet[1];c.textureSet=ct.cfg("Textures",d);const u=ct.getResource(e.terrainMap);c.width=u.width,c.height=u.height;const g=null===(s=ct.getResource(e.pathMap))||void 0===s?void 0:s.level,p=null===(r=ct.getResource(e.surfaceMap))||void 0===r?void 0:r.level,m=null===(n=ct.getResource(e.predugMap))||void 0===n?void 0:n.level,f=null===(a=ct.getResource(e.cryOreMap))||void 0===a?void 0:a.level,y=null===(o=ct.getResource(e.fallinMap))||void 0===o?void 0:o.level,w=null===(h=ct.getResource(e.erodeMap))||void 0===h?void 0:h.level;for(let e=0;e<u.level.length;e++)for(let t=0;t<u.level[e].length;t++){c.surfaces[t]=c.surfaces[t]||[];const i=u.level[e][t];let s=q.getByNum(i);const r=m[e][t];r===De.CAVERN_EXPOSED?s===q.GROUND||s===q.DIRT?s=q.GROUND:s!==q.WATER&&s!==q.LAVA&&console.warn("Unexpected cavern surface type: "+s.name):r===De.SLUG_HOLE_EXPOSED||r===De.SLUG_HOLE_HIDDEN?s=q.SLUG_HOLE:r!==De.WALL&&r!==De.CAVERN_HIDDEN&&console.warn("Unexpected predug level: "+r);const n=g&&s.floor?g[e][t]:Oe.NONE;n===Oe.RUBBLE?s=q.RUBBLE4:n===Oe.POWER_PATH?s=q.POWER_PATH:n!==Oe.NONE&&console.warn("Unexpected path map level: "+n);const a=new it(c,s,t,e,p[e][t]);if(f){const i=f[e][t];i%2==1?a.containedCrystals=(i+1)/2:a.containedOres=i/2}c.surfaces[t].push(a)}c.forEachSurface((e=>{if(m[e.y][e.x]===De.CAVERN_EXPOSED||m[e.y][e.x]===De.SLUG_HOLE_EXPOSED)for(let t=e.x-1;t<=e.x+1;t++)for(let i=e.y-1;i<=e.y+1;i++)c.getSurfaceOrNull(t,i).discovered=!0})),c.forEachSurface((e=>{const t=c.getSurfaceOrNull(e.x,e.y);m[e.y][e.x]!==De.CAVERN_HIDDEN||t.discovered||(t.surfaceType=q.GROUND)}));const v=[];for(let e=0;e<c.width;e++){const t=[];for(let i=0;i<c.height;i++){const s=c.getSurfaceOrNull(e,i).getGraphWalkWeight();t.push(s,s,s)}v.push(t,t,t)}if(c.graphWalk=new se(v,{diagonal:!0}),c.forEachSurface((e=>{e.isSupported()||e.collapse()})),c.updateSurfaceMeshes(!0),y)for(let e=0;e<c.width;e++)for(let t=0;t<c.height;t++)c.getSurface(e,t).setFallinLevel(y[t][e]);return w&&console.warn("Lucky you! Lava erosion not yet implemented"),c}}.loadTerrain(e,t,this),this.scene.add(this.terrain.floorGroup),N.totalDiggables=this.terrain.countDiggables(),N.totalCrystals=this.terrain.countCrystals(),N.totalOres=this.terrain.countOres()}startScene(){this.debugHelper.show(),this.renderInterval=setInterval((()=>{this.animRequest=requestAnimationFrame((()=>{this.debugHelper.renderStart(),this.renderer.render(this.scene,this.camera),this.debugHelper.renderDone()}))}),1e3/this.maxFps)}disposeScene(){var e,t;this.debugHelper.hide(),this.renderInterval=f(this.renderInterval),this.animRequest&&(cancelAnimationFrame(this.animRequest),this.animRequest=null),N.remainingDiggables=(null===(e=this.terrain)||void 0===e?void 0:e.countDiggables())||0,null===(t=this.terrain)||void 0===t||t.dispose(),this.terrain=null,nt.meshRegistry.forEach((e=>e.dispose())),nt.meshRegistry=[]}static registerMesh(e){return this.meshRegistry.push(e),e.mesh}resize(e,t){this.renderer.setSize(e,t)}getTerrainIntersectionPoint(e,t){if(!this.terrain)return null;const i=new F.iMs;i.setFromCamera({x:e,y:t},this.camera);const s=i.intersectObjects(this.terrain.floorGroup.children);return s.length>0?new F.FM8(s[0].point.x,s[0].point.z):null}setTorchPosition(e){this.cursorTorchlight.position.copy(this.getFloorPosition(e)),this.cursorTorchlight.position.y+=2*D.pM}getFloorPosition(e){const t=this.terrain.getSurfaceFromWorldXZ(e.x,e.y).getFloorHeight(e.x,e.y);return new F.Pa4(e.x,t,e.y)}getTerrainHeight(e,t){const i=new F.iMs(new F.Pa4(Number(e),3*D.pM,Number(t)),new F.Pa4(0,-1,0)).intersectObject(this.terrain.floorGroup,!0);return i.length>0?i[0].point.y:(console.warn("could not determine terrain height for "+e+"/"+t),0)}}function at(e,...t){return t.forEach((t=>{e=(e=Object.keys(e).filter((e=>e.toLowerCase()===t.toLowerCase())).map((t=>e[t])))?e[0]:e})),e}nt.meshRegistry=[];class ot{constructor(e,t=10,i=19){this.letters=[];const s=[" ","!",'"',"#","$","%","","`","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","'","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","","","","","","","","","","","","","","","","E","","","","","","e","","","e","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],r=e.width/t;function n(e){for(let t=0;t<e.height/i;t++){let i=4*t*e.width;if(255!==e.data[i]&&255!==e.data[i+2]){for(let t=0;t<r;t++){let i=4*t;if(255===e.data[i]||255===e.data[i+2])return t}return r}}return 0}this.charHeight=e.height/i;for(let t=0;t<s.length;t++){let i=this.extractData(e,t%10*r,Math.floor(t/10)*this.charHeight,r,this.charHeight),a=n(i);i=a>0?this.extractData(i,0,0,a,this.charHeight):W(r,this.charHeight),this.letters[s[t]]=i}}extractData(e,t,i,s,r){const n=G(e,t+s-1,i+r-1),a=new ImageData(s,r);for(let o=0;o<s;o++)for(let s=0;s<r;s++){const r=G(e,t+o,i+s);r.r===n.r&&r.g===n.g&&r.b===n.b&&(r.a=0),H(a,o,s,r.r,r.g,r.b,r.a)}return a}createTextImage(e,t,i=!0){if(null==e||e.length<1)return U(1,1).canvas;e=e.replace(/_/g," ");const s=this.determineRows(e,t),r=Math.max(...s.map((e=>e.width))),n=new ImageData(r,this.charHeight*s.length);s.forEach(((e,t)=>{const s=i?Math.round((r-e.width)/2):0,a=t*this.charHeight;let o=0;for(let t=0;t<e.text.length;t++){const i=this.letters[e.text.charAt(t)];if(i){for(let e=o;e<o+i.width;e++)for(let t=0;t<i.height;t++){const r=G(i,e-o,t);H(n,s+e,a+t,r.r,r.g,r.b,r.a)}o+=i.width}}}));const a=U(n.width,n.height);return a.putImageData(n,0,0),a.canvas}determineRows(e,t){const i=this.letters[" "].width,s=[];let r="",n=0;return e.split(" ").map((e=>{let a=0;for(let t=0;t<e.length;t++){const i=e.charAt(t),s=this.letters[i];s?a+=s.width:console.error("Letter '"+i+"' not found in charset! Ignoring it")}return n>0?!t||n+i+a<t?(r+=" "+e,n+=i+a):(s.push({text:r,width:n}),r=e,n=a):(r+=e,n+=a),a})),n>0&&s.push({text:r,width:n}),s}}class ht{static cfg(...e){return at(this.configuration,...e)}static getResource(e){const t=e?e.toString().toLowerCase():null;return this.resourceByName.get(t)||null}static getImageData(e){if(!e)throw"imageName must not be undefined, null or empty - was "+e;return this.resourceByName.getOrUpdate(e.toLowerCase(),(()=>(console.error("Image '"+e+"' unknown! Using placeholder image instead"),W(64,64))))}static getImage(e){const t=this.getImageData(e),i=U(t.width,t.height);return i.putImageData(t,0,0),i.canvas}static getImageOrNull(e){return e?this.getImage(e):null}static getBitmapFont(e){return this.fontCache.getOrUpdate(e,(()=>{const t=this.getResource(e);if(!t)throw"Could not load font image data for: "+e;return new ot(t)}))}static getDefaultFont(){return this.getBitmapFont("Interface/Fonts/Font5_Hi.bmp")}}ht.configuration={},ht.resourceByName=new Map,ht.fontCache=new Map;class lt{constructor(e,t){this.wad0FileUrl=e,this.wad1FileUrl=t}}!function(e){e[e.MSG=0]="MSG",e[e.CFG=1]="CFG",e[e.CACHE_MISS=2]="CACHE_MISS",e[e.SFX=3]="SFX",e[e.ASSET=4]="ASSET",e[e.DONE=5]="DONE"}(_e||(_e={}));class ct extends ht{static startLoadingFromCache(){return this.startLoading(null)}static startLoadingFromUrl(e,t){return this.startLoading(new lt(e,t))}static startLoading(e){this.worker.onmessage=e=>{const t=e.data;if(t.type===_e.ASSET){this.resourceByName.set(t.assetName.toLowerCase(),t.assetObj);const e=t.assetName.toLowerCase().match(/(.*a)\d\d\d(_.+)/);e&&this.resourceByName.set(e[1]+e[2],t.assetObj),this.onAssetLoaded()}else t.type===_e.MSG?this.onMessage(t.text):t.type===_e.CFG?(this.configuration=t.cfg,this.stats=t.stats,this.onInitialLoad(t.totalResources)):t.type===_e.CACHE_MISS?this.onCacheMissed():t.type===_e.DONE&&(console.log("Loading of about "+t.totalResources+" assets complete! Total load time: "+t.loadingTimeSeconds+" seconds."),this.onLoadDone())},this.worker.postMessage(e)}static filterTextureSequenceNames(e){const t=e.toLowerCase(),i=[];return this.resourceByName.forEach(((e,s)=>{s.startsWith(t)&&i.push(s)})),i.length>0?i:t.startsWith("world/shared/")?(console.warn("Texture sequence not found: "+e),null):this.filterTextureSequenceNames("world/shared/"+h(e))}static getTexture(e){if(!e||0===e.length)throw"textureName must not be undefined, null or empty - was "+e;const t=e.toLowerCase(),i=this.resourceByName.getOrUpdate(t,(()=>{const i="world/shared/"+h(t);return this.resourceByName.getOrUpdate(i,(()=>(console.warn("Texture '"+e+"' ("+t+", "+i+") unknown! Using placeholder texture instead"),W(64,64))))})),s=new F.xEZ(i,F.xEZ.DEFAULT_MAPPING,F.rpg,F.rpg);return s.needsUpdate=!0,s}static getAnimationEntityType(e){let t=this.getResource(e);if(!t)throw"Could not get animation entity type for: "+e;return class{static loadModels(e,t){const i=function(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const i=t.lastIndexOf("/");return t=t.substring(0,i+1),t.startsWith("/")&&(t=t.substring(1)),t}(e),s=new J;s.carryNullName=at(t,"CarryNullName"),s.depositNullName=at(t,"DepositNullName"),s.toolNullName=at(t,"ToolNullName");const r=at(t,"highpoly");r&&(s.highPoly={},Object.keys(r).forEach((e=>{const t=r[e]+".lwo",n=e.startsWith("!")?e.slice(1):e,a=ct.getResource(i+t);s.highPoly[n]=nt.registerMesh(new Pe(i).parse(a))})));const n=at(t,"Activities");return n&&Object.keys(n).forEach((e=>{try{let r=at(n,e);const a=at(t,r),o=at(a,"FILE"),h=!0===at(a,"LWSFILE"),l=at(a,"TRANSCOEF"),c=!0===at(a,"LOOPING");if(h){const t=ct.getResource(i+o+".lws");a.animation=new Le(i).parse(t),a.animation.looping=c,a.animation.transcoef=l?Number(l):1,s.activities.set(e.toLowerCase(),a)}else console.error("Found activity which is not an LWS file")}catch(i){console.error(i),console.log(t),console.log(n),console.log(e)}})),s}}.loadModels(e,t)}}ct.worker=new Worker(new URL(i.p+i.u(190),i.b)),ct.onMessage=e=>{console.log(e)},ct.onCacheMissed=()=>{console.log("Worker missed cache")},ct.onInitialLoad=()=>{console.log("Initial loading done.")},ct.onAssetLoaded=()=>{},ct.onLoadDone=()=>{};class dt extends Ue{constructor(e){super(Ae.MOVE),this.target=[new Ve(e)]}getWorkplaces(){return this.target}}class ut{constructor(e){this.vec=null,this.targetReached=!1,this.vec=e}}!function(e){e[e.MOVED=0]="MOVED",e[e.TARGET_REACHED=1]="TARGET_REACHED",e[e.TARGET_UNREACHABLE=2]="TARGET_UNREACHABLE"}(ke||(ke={}));class gt extends Fe{constructor(e,t,i,s,r){super(e,t,i,s,r),this.currentPath=null}getPosition(){return new F.Pa4(this.group.position.x,this.group.position.y,this.group.position.z)}getPosition2D(){return new F.FM8(this.group.position.x,this.group.position.z)}getSpeed(){var e;return this.stats.RouteSpeed[this.level]*((null===(e=this.animation)||void 0===e?void 0:e.transcoef)||1)*(this.isOnPath()?this.stats.PathCoef:1)}moveToClosestTarget(e){if(e.length<1&&console.warn("No targets given"),!this.currentPath||!e.some((e=>e.targetLocation.equals(this.currentPath.target.targetLocation)))){const t=e.map((e=>this.findPathToTarget(e))).sort(((e,t)=>e.lengthSq-t.lengthSq));if(this.currentPath=t.length>0?t[0]:null,!this.currentPath)return ke.TARGET_UNREACHABLE}const t=this.currentPath.firstLocation;this.group.lookAt(new F.Pa4(t.x,this.group.position.y,t.y));const i=this.determineStep();return i.targetReached||this.currentPath.target.isInArea(this.getPosition2D())?ke.TARGET_REACHED:(this.group.position.add(i.vec),this.changeActivity(this.getRouteActivity()),ke.MOVED)}findPathToTarget(e){return new st(e,e.targetLocation)}determineStep(){const e=this.getEntityStep(this.currentPath.firstLocation),t=e.vec.lengthSq(),i=this.getSpeed();if(this.currentPath.locations.length>1){if(t<i*i)return this.currentPath.locations.shift(),this.determineStep()}else t<D.Ob*D.Ob&&(e.targetReached=!0);return e.vec.setLength(Math.min(i,D.Ob)),e}getEntityStep(e){const t=this.sceneMgr.getFloorPosition(e);return t.y+=this.floorOffset,new ut(t.sub(this.group.position))}isOnRubble(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position).hasRubble()}isOnPath(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position).isPath()}}class pt extends gt{constructor(e,t,i,s,r,n){super(e,t,i,s,r),this.workInterval=null,this.job=null,this.followUpJob=null,this.carries=null,this.jobWorkplaces=[],this.selectionType=n,this.group.userData={selectable:this},this.workInterval=setInterval(this.work.bind(this),1e3/D.OK)}resetWorkInterval(){this.workInterval=f(this.workInterval)}dropItem(){if(!this.carries)return;const e=this.getPosition();this.carryJoint&&(this.carryJoint.remove(this.carries.group),this.carryJoint.getWorldPosition(e)),this.carries.addToScene(new F.FM8(e.x,e.z),null),this.carries=null}pickupItem(e){this.carries=e,this.carryJoint&&this.carryJoint.add(this.carries.group),this.carries.group.position.set(0,0,0)}setJob(e,t=null){this.job!==e&&this.stopJob(),this.job=e,this.job&&this.job.assign(this),this.followUpJob=t,this.followUpJob&&this.followUpJob.assign(this),this.jobWorkplaces=this.job.getWorkplaces()}stopJob(){this.dropItem(),this.job&&(this.job.unassign(this),this.followUpJob&&this.followUpJob.unassign(this),this.job=null,this.followUpJob=null,this.jobWorkplaces=[],this.changeActivity())}getSelectionType(){return this.selectionType}deselect(){this.selectionFrame.visible=!1,this.selected=!1}}var mt=F.M8C.degToRad;class ft extends pt{constructor(e,t){super(e,t,x.RAIDER,M.PILOT,"mini-figures/pilot/pilot.ae",A.RAIDER),this.tools=new Map,this.trainings=new Map,this.slipped=!1,this.tools.set($e.DRILL,!0)}get stats(){return ct.stats.Pilot}findPathToTarget(e){return this.sceneMgr.terrain.findPath(this.getPosition2D(),e)}onDiscover(){super.onDiscover(),N.raidersUndiscovered.remove(this),N.raiders.push(this),y.publishEvent(new ue(this)),y.publishEvent(new be(this.getPosition()))}select(){return this.selectionFrame.visible=!this.slipped,this.selected||this.slipped?null:(this.selected=!0,this.changeActivity(),new T(this))}getSelectionCenter(){return this.pickSphere?(new F.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null}isDriving(){return!1}getRouteActivity(){return this.isOnRubble()?this.carries?Je.CarryRubble:Je.routeRubble:this.carries?Je.Carry:Je.Route}moveToClosestTarget(e){var t;const i=super.moveToClosestTarget(e);return this.job.setActualWorkplace(null===(t=this.currentPath)||void 0===t?void 0:t.target),i===ke.MOVED?N.getNearbySpiders(this).some((e=>{if(this.group.position.distanceToSquared(e.group.position)<this.radiusSq+e.radiusSq)return this.slip(),e.onDeath(),!0})):i===ke.TARGET_UNREACHABLE&&(console.log("Entity could not move to job target, stopping job"),this.stopJob()),i}slip(){u(0,100)<10&&this.stopJob(),this.dropItem(),this.slipped=!0,this.changeActivity(Je.Slip,(()=>{this.slipped=!1}))}moveToClosestWorkplace(){return this.moveToClosestTarget(this.jobWorkplaces)===ke.TARGET_REACHED}work(){if(this.job&&!this.selected&&!this.slipped)if(this.job.jobstate===xe.INCOMPLETE)if(this.job.type===Ae.DRILL){if(this.moveToClosestWorkplace()){const e=this.job;let t=this.getDrillTime(e.surface.surfaceType);const i=e.surface.getCenterWorld();i.y=this.group.position.y,this.group.lookAt(i),this.changeActivity(Je.Drill,(()=>{if(e.surface.seamLevel>0){e.surface.seamLevel--;const t=(new F.FM8).copy(this.getPosition2D()).sub(e.surface.getCenterWorld2D()).multiplyScalar(.3+g(3)/10).rotateAround(new F.FM8(0,0),mt(-10+g(20))).add(this.getPosition2D());if(e.surface.surfaceType===q.CRYSTAL_SEAM){const e=this.worldMgr.placeMaterial(new Xe(this.worldMgr,this.sceneMgr),t);y.publishEvent(new we(e.getPosition()))}else e.surface.surfaceType===q.ORE_SEAM&&(this.worldMgr.placeMaterial(new Ze(this.worldMgr,this.sceneMgr),t),y.publishEvent(new pe));this.changeActivity()}else this.completeJob()}),t)}}else{const e=this.job.getCarryItem();if(e&&this.carries!==e)this.dropItem(),this.moveToClosestTarget([new Ve(e.getPosition2D())])&&this.changeActivity(Je.Collect,(()=>{this.pickupItem(e)}));else if(this.moveToClosestWorkplace())if(this.job.isReadyToComplete()){const e=this.job.getWorkActivity()||this.getDefaultActivity();this.changeActivity(e,(()=>{this.completeJob()}),this.job.getWorkDuration())}else this.changeActivity()}else this.stopJob()}getDrillTime(e){let t=null;return e===q.HARD_ROCK?t=1e3*this.stats.HardDrillTime[this.level]:e===q.LOOSE_ROCK?t=1e3*this.stats.LooseDrillTime[this.level]:e===q.DIRT?t=1e3*this.stats.SoilDrillTime[this.level]:e!==q.ORE_SEAM&&e!==q.CRYSTAL_SEAM||(t=1e3*this.stats.SeamDrillTime[this.level]),t=t||0,t||console.warn("According to cfg this entity cannot drill this material"),t}completeJob(){var e,t,i;null===(e=this.job)||void 0===e||e.onJobComplete(),(null===(t=this.job)||void 0===t?void 0:t.jobstate)!==xe.INCOMPLETE&&(this.job&&this.job.unassign(this),this.job=this.followUpJob,this.followUpJob=null,this.jobWorkplaces=(null===(i=this.job)||void 0===i?void 0:i.getWorkplaces())||[],this.changeActivity())}getDefaultActivity(){return this.carries?Je.CarryStand:super.getDefaultActivity()}beamUp(){this.stopJob(),super.beamUp()}removeFromScene(){super.removeFromScene(),N.raiders.remove(this)}hasTool(e){return!e||this.tools.has(e)}hasTraining(e){return!e||this.trainings.has(e)}addTool(e){this.tools.set(e,!0)}addTraining(e){this.trainings.set(e,!0)}}class yt extends Ne{}yt.Short=new Ne("Short"),yt.Expand=new Ne("Expand"),yt.Long=new Ne("Long"),yt.Teleport=new Ne("Teleport");class wt extends je{constructor(e,t,i,s){super(e,t,M.BARRIER,"MiscAnims/Barrier/Barrier.ae"),this.heading=i.heading,this.priorityIdentifier=Me.aiPriorityConstruction,this.changeActivity(),this.targets=[new Ye(i.location,s,null)]}updateTargets(){return this.targets}getDefaultActivity(){return yt.Short}onAddToSite(){super.onAddToSite(),this.group.rotation.y=this.heading,this.changeActivity(yt.Expand,(()=>this.changeActivity(yt.Long)))}}class vt extends He{onJobComplete(){super.onJobComplete(),this.item.targetSurface.canPlaceFence()&&(this.item.addToScene(null,null),this.item.targetSurface.fence=this.item)}}class bt extends je{constructor(e,t,i){super(e,t,M.ELECTRIC_FENCE);const s=ct.getResource("Buildings/E-Fence/E-Fence4.lwo"),r=nt.registerMesh(new Pe("Buildings/E-Fence/").parse(s));this.group.add(r),this.targetSurface=i,this.priorityIdentifier=Me.aiPriorityConstruction}updateTargets(){return this.targets.length<1?this.targetSurface.canPlaceFence()?this.targets=[new Ye(this.targetSurface.getCenterWorld2D(),null,null)]:this.targets=N.getBuildingsByType(...this.getTargetBuildingTypes()).map((e=>new Ye(e.getDropPosition2D(),null,e))):this.targetSurface.canPlaceFence()||this.targets[0].building||(this.targets=N.getBuildingsByType(...this.getTargetBuildingTypes()).map((e=>new Ye(e.getDropPosition2D(),null,e)))),this.targets}createCarryJob(){return new vt(this)}}class It extends Fe{constructor(e,t,i,r){super(e,t,x.BUILDING,i,r),this.blocksPathSurface=!0,this.secondaryBuildingPart=null,this.primaryPowerPath=new F.FM8(0,1),this.secondaryPowerPath=null,this.waterPathSurface=null,this.powerSwitch=!0,this.spawning=!1,this.primarySurface=null,this.secondarySurface=null,this.primaryPathSurface=null,this.secondaryPathSurface=null,this.upgradeCostOre=0,this.upgradeCostBrick=0,this.crystalsInUse=0,this.inBeam=!1,this.group.applyMatrix4((new F.yGw).makeScale(-1,1,1)),this.group.userData={selectable:this},this.upgradeCostOre=ct.cfg("Main","BuildingUpgradeCostOre"),this.upgradeCostBrick=ct.cfg("Main","BuildingUpgradeCostStuds"),y.registerEventListener(s.MATERIAL_AMOUNT_CHANGED,(e=>{e.entityType===M.CRYSTAL&&this.powerSwitch&&this.turnOnPower()}))}getSelectionType(){return A.BUILDING}select(){return this.inBeam?null:(this.selectionFrame.visible=!0,this.selected?null:(this.selected=!0,new E(this)))}deselect(){this.selectionFrame.visible=!1,this.selected=!1}getSelectionCenter(){return this.pickSphere?(new F.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null}getPickSphereCenter(){return new F.Pa4(0,this.stats.PickSphere/4,0)}getDropPosition2D(){if(this.getToolJoint){const e=new F.Pa4;return this.getToolJoint.getWorldPosition(e),new F.FM8(e.x,e.z)}if(this.depositJoint){const e=new F.Pa4;return this.depositJoint.getWorldPosition(e),new F.FM8(e.x,e.z)}return this.getPosition2D()}getDropPosition(){return this.sceneMgr.getFloorPosition(this.getDropPosition2D())}isPowered(){return this.powerSwitch&&(this.stats.SelfPowered||this.stats.PowerBuilding||this.crystalsInUse>0)}onDiscover(){super.onDiscover(),N.buildingsUndiscovered.remove(this),N.buildings.push(this),y.publishEvent(new ue(this))}hasMaxLevel(){return this.level>=this.stats.Levels-1}upgrade(){this.canUpgrade()&&(N.numBrick>=this.upgradeCostBrick?(N.numBrick-=this.upgradeCostBrick,y.publishEvent(new de(M.BRICK))):(N.numOre-=this.upgradeCostOre,y.publishEvent(new de(M.ORE))),this.level++,y.publishEvent(new S),y.publishEvent(new me(this)))}getDefaultActivity(){return this.isPowered()?Ne.Stand:Ge.Unpowered}beamUp(){N.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.inBeam=!0;for(let e=0;e<this.stats.CostOre;e++)this.worldMgr.placeMaterial(new Ze(this.worldMgr,this.sceneMgr),this.primarySurface.getRandomPosition());for(let e=0;e<this.stats.CostCrystal;e++)this.worldMgr.placeMaterial(new Xe(this.worldMgr,this.sceneMgr),this.primarySurface.getRandomPosition());this.surfaces.forEach((e=>{e.surfaceType=q.GROUND,e.setBuilding(null),e.updateTexture(),e.neighbors.forEach((e=>e.updateTexture()))})),super.beamUp()}removeFromScene(){super.removeFromScene(),N.buildings.remove(this)}canUpgrade(){return!this.hasMaxLevel()&&(N.numOre>=this.upgradeCostOre||N.numBrick>=this.upgradeCostBrick)}spawnMaterials(e,t){const i=[];if(e===M.CRYSTAL)for(;N.numCrystal>0&&i.length<t;)N.numCrystal--,i.push(new Xe(this.worldMgr,this.sceneMgr));else if(e===M.ORE)for(;N.numOre>0&&i.length<t;)N.numOre--,i.push(new Ze(this.worldMgr,this.sceneMgr));else console.error("Material drop not implemented for: "+e);i.length>0&&y.publishEvent(new de(e)),i.forEach((e=>this.worldMgr.placeMaterial(e,this.getDropPosition2D())))}spawnBarriers(e,t){e.map((e=>new wt(this.worldMgr,this.sceneMgr,e,t))).forEach((e=>this.worldMgr.placeMaterial(e,this.getDropPosition2D())))}spawnFence(e){this.worldMgr.placeMaterial(new bt(this.worldMgr,this.sceneMgr,e),this.getDropPosition2D())}turnOnPower(){this.crystalsInUse>0||N.usedCrystals>=N.numCrystal||this.entityType!==M.POWER_STATION&&!this.surfaces.some((e=>e.neighbors.some((e=>e.hasPower))))||(this.crystalsInUse=1,N.usedCrystals+=this.crystalsInUse,this.surfaces.forEach((e=>e.setHasPower(!0,!0))),this.changeActivity())}turnOffPower(){this.crystalsInUse<1||(N.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.surfaces.forEach((e=>e.setHasPower(!1,!1))),this.changeActivity())}get surfaces(){const e=[];return this.primarySurface&&e.push(this.primarySurface),this.secondarySurface&&e.push(this.secondarySurface),this.primaryPathSurface&&e.push(this.primaryPathSurface),this.secondaryPathSurface&&e.push(this.secondaryPathSurface),e}placeDown(e,t,i){this.addToScene(e,t),this.createPickSphere();const s=this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position);if(s.setBuilding(this),s.surfaceType=q.POWER_PATH_BUILDING,s.updateTexture(),this.primarySurface=s,this.secondaryBuildingPart){const e=new F.Pa4(D.pM*this.secondaryBuildingPart.x,0,D.pM*this.secondaryBuildingPart.y).applyAxisAngle(new F.Pa4(0,1,0),t).add(this.group.position),i=this.sceneMgr.terrain.getSurfaceFromWorld(e);i.setBuilding(this),i.surfaceType=q.POWER_PATH_BUILDING,i.updateTexture(),this.secondarySurface=i}if(this.primaryPowerPath){const e=new F.Pa4(this.primaryPowerPath.x,0,this.primaryPowerPath.y).multiplyScalar(D.pM).applyAxisAngle(new F.Pa4(0,1,0),t).add(this.group.position),i=this.sceneMgr.terrain.getSurfaceFromWorld(e);this.entityType===M.GEODOME&&(i.building=this),i.surfaceType=q.POWER_PATH_BUILDING,i.updateTexture(),this.primaryPathSurface=i}this.group.visible?N.buildings.push(this):N.buildingsUndiscovered.push(this),this.group.visible&&!i?(this.inBeam=!0,this.changeActivity(Ge.Teleport,(()=>{this.inBeam=!1,this.onPlaceDown()}))):this.onPlaceDown(),this.sceneMgr.terrain.resetGraphWalk()}onPlaceDown(){this.changeActivity(),this.turnOnPower(),y.publishEvent(new ue(this))}getDropAction(){return Je.Place}}class Et extends It{constructor(e,t){super(e,t,M.BARRACKS,"Buildings/Barracks/Barracks.ae")}get stats(){return ct.stats.Barracks}}class Tt extends It{constructor(e,t){super(e,t,M.DOCKS,"Buildings/Docks/Docks.ae"),this.waterPathSurface=new F.FM8(0,1)}get stats(){return ct.stats.Docks}}class St extends It{constructor(e,t){super(e,t,M.GEODOME,"Buildings/Geo-dome/Geo-dome.ae"),this.primaryPowerPath=null,this.secondaryBuildingPart=new F.FM8(0,1)}get stats(){return ct.stats.Geodome}}class Ct extends It{constructor(e,t){super(e,t,M.GUNSTATION,"Buildings/gunstation/gunstation.ae"),this.primaryPowerPath=null}getDefaultActivity(){return Ge.Stand}get stats(){return ct.stats.GunStation}}class Rt extends It{constructor(e,t){super(e,t,M.ORE_REFINERY,"Buildings/OreRefinery/OreRefinery.ae"),this.primaryPowerPath=new F.FM8(0,2),this.secondaryBuildingPart=new F.FM8(0,1)}get stats(){return ct.stats.OreRefinery}getDropAction(){return Je.Deposit}}class Pt extends It{constructor(e,t){super(e,t,M.POWER_STATION,"Buildings/Powerstation/Powerstation.ae"),this.secondaryBuildingPart=new F.FM8(-1,0)}get stats(){return ct.stats.Powerstation}getDropAction(){return Je.Deposit}}class Lt extends It{constructor(e,t){super(e,t,M.TELEPORT_BIG,"Buildings/BIGTeleport/BIGTeleport.ae"),this.secondaryBuildingPart=new F.FM8(1,0),this.secondaryPowerPath=new F.FM8(1,1)}get stats(){return ct.stats.TeleportBIG}}class Mt extends It{constructor(e,t){super(e,t,M.TELEPORT_PAD,"Buildings/Teleports/Teleports.ae")}get stats(){return ct.stats.TeleportPad}}class xt extends It{constructor(e,t){super(e,t,M.TOOLSTATION,"Buildings/Toolstation/Toolstation.ae"),this.blocksPathSurface=!1}get stats(){return ct.stats.Toolstation}}class At extends It{constructor(e,t){super(e,t,M.UPGRADE,"Buildings/Upgrade/Upgrade.ae")}get stats(){return ct.stats.Upgrade}}class Ot extends Ne{}Ot.Route=new Ot("Activity_Route");class Dt extends gt{constructor(e,t,i,s){super(e,t,x.MONSTER,i,s),this.target=[]}onLevelEnd(){this.moveTimeout=m(this.moveTimeout),this.removeFromScene()}getRouteActivity(){return Ot.Route}}class _t extends Dt{constructor(e,t){super(e,t,M.BAT,"Creatures/bat/bat.ae"),this.floorOffset=D.pM/2}get stats(){return ct.stats.Bat}startRandomMove(){_t.onMove(this)}static onMove(e){(e.target.length<1||e.moveToClosestTarget(e.target)===ke.TARGET_REACHED)&&(e.target=[e.findTarget()]),e.moveTimeout=setTimeout((()=>_t.onMove(e)),1e3/D.OK)}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.getPosition()).getCenterWorld();for(let i=0;i<20;i++){const i=u(t.x-(D.pM+D.pM/2),t.x+D.pM+D.pM/2),s=u(t.z-D.pM/2,t.z+D.pM/2);if(e.getSurfaceFromWorldXZ(i,s).surfaceType.floor)return new Ve(new F.FM8(i,s))}return console.warn("Could not find a target"),null}onDeath(){this.onLevelEnd(),N.bats.remove(this)}}class kt extends Dt{constructor(e,t){super(e,t,M.SMALL_SPIDER,"Creatures/SpiderSB/SpiderSB.ae"),this.floorOffset=1}get stats(){return ct.stats.SmallSpider}startMoving(){kt.onMove(this)}static onMove(e){e.surfaces.forEach((t=>N.spidersBySurface.getOrUpdate(t,(()=>[])).remove(e))),e.target.length>0&&e.moveToClosestTarget(e.target)===ke.MOVED?(e.surfaces.forEach((t=>N.spidersBySurface.getOrUpdate(t,(()=>[])).push(e))),e.sceneMgr.terrain.getSurfaceFromWorld(e.getPosition()).surfaceType.floor?e.moveTimeout=setTimeout((()=>kt.onMove(e)),1e3/D.OK):e.onDeath()):(e.changeActivity(),e.moveTimeout=setTimeout((()=>{e.target=[e.findTarget()],kt.onMove(e)}),1e3+g(9e3)))}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.getPosition()).getCenterWorld();for(let i=0;i<20;i++){const i=u(t.x-(D.pM+D.pM/2),t.x+D.pM+D.pM/2),s=u(t.z-D.pM/2,t.z+D.pM/2),r=e.getSurfaceFromWorldXZ(i,s).surfaceType;if(r!==q.WATER&&r!==q.LAVA)return new Ve(new F.FM8(i,s))}return console.warn("Could not find a target"),null}onDeath(){this.onLevelEnd(),N.spiders.remove(this),this.surfaces.forEach((e=>N.spidersBySurface.getOrUpdate(e,(()=>[])).remove(this)))}}var Bt,Nt,Ft,Ut=F.M8C.degToRad;class Wt extends Ue{constructor(e,t){super(Ae.GET_TOOL),this.target=[new Ve(e)],this.tool=t}getWorkplaces(){return this.target}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>e.addTool(this.tool)))}}class Ht{constructor(e,t,i,s){this.x0=0,this.y0=0,this.x1=0,this.y1=0,this.center=null,this.x0=e,this.y0=t,this.x1=i,this.y1=s,this.center=new F.FM8((this.x0+this.x1)/2,(this.y0+this.y1)/2)}}class Gt extends Ue{constructor(e,t){super(Ae.TRAIN),this.workplaces=[new Jt(e)],this.training=t}getWorkplaces(){return this.workplaces}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>{e.addTraining(this.training),y.publishEvent(new fe(e,this.training))}))}getWorkActivity(){return Je.Train}getWorkDuration(){return 1e4}}class Jt extends Ve{constructor(e){super(e.getCenterWorld2D()),this.targetArea=new Ht(e.x*D.pM-D.Ob,e.y*D.pM-D.Ob,(e.x+1)*D.pM+D.Ob,(e.y+1)*D.pM+D.Ob)}isInArea(e){return e.x>=this.targetArea.x0&&e.x<this.targetArea.x1&&e.y>=this.targetArea.y0&&e.y<this.targetArea.y1}}class Vt{constructor(e){this.jobs=[],this.assignInterval=null,this.checkRubbleInterval=null,this.worldMgr=e,y.registerEventListener(s.JOB_CREATE,(e=>{this.jobs.push(e.job)})),y.registerEventListener(s.JOB_DELETE,(e=>{e.job.cancel()}))}start(){stop(),this.assignInterval=setInterval(this.assignJobs.bind(this),D.$I),this.checkRubbleInterval=setInterval(this.checkUnclearedRubble.bind(this),D.Cw)}stop(){this.assignInterval=f(this.assignInterval),this.checkRubbleInterval=f(this.checkRubbleInterval),N.raiders.forEach((e=>e.resetWorkInterval())),N.raidersUndiscovered.forEach((e=>e.resetWorkInterval()))}assignJobs(){const e=[];this.jobs=this.jobs.filter((t=>{const i=t.jobstate===xe.INCOMPLETE;return i&&t.fulfiller.length<1&&e.push(t),i})),e.sort(((e,t)=>Math.sign(N.priorityList.getPriority(e)-N.priorityList.getPriority(t))));const t=N.raiders.filter((e=>!e.job));e.forEach((e=>{let i=null,s=null,r=null,n=null,a=null,o=null,h=null,l=null,c=null,d=null,u=null,g=null,p=null;t.forEach(((t,m)=>{const f=e.getRequiredTool(),y=t.hasTool(f),w=e.getRequiredTraining(),v=t.hasTraining(w),b=t.getPosition();if(y&&v){const n=e.getWorkplaces().map((e=>t.findPathToTarget(e))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(n){const e=n.lengthSq;(null===r||e<r)&&(i=t,s=m,r=e)}}else if(y){const e=N.getTrainingSites(b,w).map((e=>t.findPathToTarget(new Ve(e.getPosition2D())))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const i=e.lengthSq;(null===u||i<u)&&(c=t,d=m,u=i,g=t.sceneMgr.terrain.getSurfaceFromWorld2D(e.targetPosition),p=w)}}else{const e=N.getBuildingsByType(M.TOOLSTATION).map((e=>t.findPathToTarget(new Ve(e.getPosition2D())))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const i=e.lengthSq;(null===o||i<o)&&(n=t,a=m,o=i,h=e.targetPosition,l=f)}}})),i?(i.setJob(e),t.splice(s,1)):n?(n.setJob(new Wt(h,l),e),t.splice(a,1)):c&&(c.setJob(new Gt(g,p),e),t.splice(d,1))}))}checkUnclearedRubble(){N.raiders.forEach((e=>{if(e.job)return;const t=e.sceneMgr.terrain.getSurfaceFromWorld(e.getPosition());for(let i=0;i<10;i++)for(let s=t.x-i;s<=t.x+i;s++)for(let r=t.y-i;r<=t.y+i;r++){const t=e.sceneMgr.terrain.getSurfaceOrNull(s,r);if(!(null==t?void 0:t.hasRubble())||!(null==t?void 0:t.discovered))continue;const i=t.createClearRubbleJob();if(!i)continue;const n=i.getRequiredTool();if(e.hasTool(n))e.setJob(i);else{const t=N.getBuildingsByType(M.TOOLSTATION).map((t=>e.findPathToTarget(new Ve(t.getPosition2D())))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];t&&e.setJob(new Wt(t.targetPosition,n),i)}}}))}}class Yt{constructor(e=!1){this.debug=!1,this.onLevelEnd=null,this.nerpInterval=null,this.registers=new Array(8).fill(0),this.timers=new Array(4).fill(0),this.scriptLines=[],this.statements=[],this.macrosByName={},this.labelsByName={},this.halted=!1,this.programCounter=0,this.messages=[],this.messagePermit=null,this.debug=e}startExecution(){const e=this;this.nerpInterval=setInterval((()=>{e.execute()}),2e3)}pauseExecution(){this.nerpInterval=f(this.nerpInterval)}checkRegister(e){const t=parseInt(e);if(isNaN(t)||t<0||t>this.registers.length)throw new Error("Invalid register ("+e+") provided");return t}checkRegisterValue(e){const t=parseInt(e);if(isNaN(t))throw new Error("Invalid register value ("+e+") provided");return t}getR(e){return e=this.checkRegister(e),this.registers[e]}setR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]=t}addR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]+=t}setTimer(e,t){const i=parseInt(t);if(isNaN(i))throw new Error("Can't set timer to NaN value: "+t);this.timers[e]=(new Date).getTime()+i}getTimer(e){return(new Date).getTime()-this.timers[e]}setLevelCompleted(){console.log("Nerp runner marks level as complete"),this.halted=!0,N.resultState=O.COMPLETE,this.onLevelEnd()}setLevelFail(){console.log("NerpRunner marks level as failed"),this.halted=!0,N.resultState=O.FAILED,this.onLevelEnd()}setTutorialFlags(e){}setMessagePermit(e){this.messagePermit=!e}setBuildingsUpgradeLevel(e,t){N.buildings.forEach((i=>{i.entityType===e&&(i.level=t)}))}setToolStoreLevel(e){this.setBuildingsUpgradeLevel(M.TOOLSTATION,e)}setTeleportPadLevel(e){this.setBuildingsUpgradeLevel(M.TELEPORT_PAD,e)}setPowerStationLevel(e){this.setBuildingsUpgradeLevel(M.POWER_STATION,e)}setBarracksLevel(e){this.setBuildingsUpgradeLevel(M.BARRACKS,e)}getToolStoresBuilt(){return N.buildings.count((e=>e.entityType===M.TOOLSTATION))}getMinifiguresOnLevel(){return N.raiders.length}getCrystalsCurrentlyStored(){return N.numCrystal}getObjectiveSwitch(){return 0}setMessageTimerValues(e,t,i){}getMessageTimer(){return 0}cameraUnlock(){}setMessage(e,t){if(!this.messagePermit)return;if(0===e)return;const i=this.messages[e];console.log(i.txt)}setCameraGotoTutorial(e){}getTutorialBlockIsGround(e){return 0}getTutorialBlockIsPath(e){return 0}getUnitAtBlock(e){return 0}getOxygenLevel(){return 100}getObjectiveShowing(){return!1}addPoweredCrystals(){}disallowAll(){}getPoweredPowerStationsBuilt(){return N.buildings.count((e=>e.isPowered()&&e.entityType===M.POWER_STATION))}getPoweredBarracksBuilt(){return N.buildings.count((e=>e.isPowered()&&e.entityType===M.BARRACKS))}getRecordObjectAtTutorial(){}getHiddenObjectsFound(){return 0}getLevel1PowerStationsBuilt(){return 0}getRandom100(){return g(100)}getSlugsOnLevel(){return 0}generateSlug(){console.warn("Slugs not yet implemented")}callMethod(e,t){if("Stop"===e)throw"Stop";if("TRUE"===e)return!0;if("FALSE"===e)return!1;const i=e.match(/^SetR([0-7])$/);if(i)return this.setR(i[1],t[0]);const s=e.match(/^AddR([0-7])$/);if(s)return this.addR(s[1],t[0]);const r=e.match(/^GetR([0-7])$/);if(r)return this.getR(r[1]);const n=e.match(/^SetTimer([0-3])$/);if(n)return this.setTimer(n[1],t[0]);const a=e.match(/^GetTimer([0-3])$/);if(a)return this.getTimer(a[1]);const o=e.toLowerCase(),h=Object.getOwnPropertyNames(Yt.prototype).find((e=>e.toLowerCase()===o));if(h)return this[h].apply(this,t);throw new Error("Undefined method: "+e)}conditional(e,t){const i=this.executeStatement(e);this.debug&&console.log("Condition evaluated to "+i),i&&this.executeStatement(t)}executeStatement(e){if(e.invoke){const t="conditional"!==e.invoke?e.args.map((e=>this.executeStatement(e))):e.args,i=this.callMethod(e.invoke,t);return void 0!==i&&this.debug&&console.log("Method returned: "+i),i}if(e.comparator){const t=this.executeStatement(e.left),i=this.executeStatement(e.right);if("="===e.comparator)return t===i;if("!="===e.comparator)return t!==i;if("<"===e.comparator)return t<i;if(">"===e.comparator)return t>i;throw console.log(e),new Error("Unknown comparator: "+e.comparator)}if(!isNaN(e))return e;if(!e.jump)throw console.log(e),new Error("Unknown expression in line "+this.programCounter+": "+e);if(this.programCounter=this.labelsByName[e.jump],void 0===this.programCounter)throw new Error("Label '"+e.jump+"' is unknown!");this.debug&&console.log("Jumping to label '"+e.jump+"' in line "+this.programCounter)}execute(e=!1){if(this.debug=e,!this.halted)try{for(this.debug&&(console.log("Executing following script\n"+this.scriptLines.join("\n")),console.log("Registers: "+this.registers)),this.programCounter=0;this.programCounter<this.statements.length;this.programCounter++){const e=this.statements[this.programCounter];this.debug&&(console.log(this.programCounter+": "+this.scriptLines[this.programCounter]),console.log(e)),e.label||this.executeStatement(e)}}catch(e){if("Stop"===e)return;console.error(e),console.error("FATAL ERROR! Script execution failed! You can NOT win anymore!"),this.halted=!0}}}class jt{static parse(e){const t=new Yt,i=e.split("\n").map((e=>e.split("//")[0].trim().split(";")[0].trim().replace(/_/g,"").replace(/\bTRUE \? /,"").replace(/[{}]/g,"")));for(let e=0;e<i.length;e++){const s=i[e];if(!(s.length<1))if(s.startsWith("#include ")){const e=s.replace(/^#include /,"").trim().slice(1,-1);if("nerpdef.h"===e)continue;const i=jt.parse(ct.getResource("Levels/"+e));if(!i||!i.scriptLines||i.scriptLines.length<1)throw"Can't include unknown nerp script: "+s;t.scriptLines=t.scriptLines.concat(i.scriptLines),t.macrosByName=Object.assign({},t.macrosByName,i.macrosByName)}else if(s.startsWith("#define ")){const r=s.replace(/^#define /,"").split(" "),n=[r.splice(1).join(" ").replace(/\\$/,"").trim()];let a=s,o=!1;for(;a.endsWith("\\")&&e<i.length-1;){e++,a=i[e].trim();const t=a.replace(/\\$/,"").trim();t.length>0&&(o?(o=!1,n[n.length-1]+=t):n.push(t)),a.match(/:\\$/)&&(o=!0)}const h=r[0].split("(");t.macrosByName[h[0]]={args:h[1].replace(/\)$/,"").split(","),lines:n}}else t.scriptLines=t.scriptLines.concat(this.replaceMacros(t.macrosByName,s))}for(let e=0;e<t.scriptLines.length;e++){const i=t.scriptLines[e];t.statements[e]=i.replace(/\(\)/g,"").split(" ? ");const s=i.match(/(\S+):/);if(2===t.statements[e].length)t.statements[e]={invoke:"conditional",args:[this.preProcess(t.statements[e][0]),this.preProcess(t.statements[e][1])]};else if(s){const i=s[1].toLowerCase();t.labelsByName[i]=e,t.statements[e]={label:i}}else{if(1!==t.statements[e].length)throw"Can't deal with line: "+i;t.statements[e]=this.preProcess(t.statements[e][0])}}return t}static replaceMacros(e,t){const i=t.split("("),s=e[i[0]];if(s){const r=i.splice(1).join("(").slice(0,-1).split(",");if(r.length!==s.args.length)throw"Invalid number of args provided for macro in line "+t;const n=[];return s.lines.forEach((t=>{for(let e=0;e<r.length;e++)t=t.replace(new RegExp("\\b"+s.args[e]+"\\b"),r[e]);n.push(...this.replaceMacros(e,t))})),n}return[t]}static preProcess(e){e=e.trim().replace(/^_/,"");const t=parseInt(e);if(!isNaN(t))return t;const i=e.split(/ (=) | (!=) | (>) | (<) /).filter((e=>void 0!==e)),s=e.match(/^(.+)\((.+)\)$/),r=e.split(" "),n=e.match(/([^:]+):$/),a=e.match(/^:([^:]+)$/);if(3===i.length)return{left:this.preProcess(i[0]),comparator:i[1],right:this.preProcess(i[2])};if(s){const e=s[2].split(",").map((e=>this.preProcess(e)));return{invoke:s[1],args:e}}if(r.length>1){const e=2===r.length?[this.preProcess(r[1])]:r.splice(1).map((e=>this.preProcess(e)));return{invoke:r[0],args:e}}if(n)return{label:n[1]};if(a)return{jump:a[1].toLowerCase()};if(e.match(/[ =?><!]/))throw"Invalid expression given, parsing must have failed before somewhere";return{invoke:e,args:[]}}}class Xt{constructor(){this.nerpRunner=null,this.oxygenUpdateInterval=null,y.registerEventListener(s.DESELECTED_ENTITY,(()=>N.selectEntities([]))),y.registerEventListener(s.CAVERN_DISCOVERED,(()=>{N.discoveredCaverns++})),this.oxygenUpdateInterval=setInterval(this.updateOxygen.bind(this),D.SO)}setup(e,t){var i,s;N.levelFullName=e.fullName,N.totalCaverns=(null===(s=null===(i=e.reward)||void 0===i?void 0:i.quota)||void 0===s?void 0:s.caverns)||0,N.rewardConfig=e.reward,N.priorityList.setList(e.priorities),N.oxygenRate=e.oxygenRate,this.nerpRunner=jt.parse(ct.getResource(e.nerpFile)),this.nerpRunner.messages.push(...ct.getResource(e.nerpMessageFile)),this.nerpRunner.onLevelEnd=t}start(){var e;null===(e=this.nerpRunner)||void 0===e||e.startExecution(),N.levelStartTime=Date.now()}stop(){var e;N.levelStopTime=Date.now(),null===(e=this.nerpRunner)||void 0===e||e.pauseExecution(),N.spiders.forEach((e=>e.onLevelEnd())),N.bats.forEach((e=>e.onLevelEnd()))}placeMaterial(e,t){return e.addToScene(t,0),e.group.visible?(N.materials.push(e),y.publishEvent(new he(e.createCarryJob()))):N.materialsUndiscovered.push(e),e}updateOxygen(){const e=(N.raiders.map((e=>e.stats.OxygenCoef)).reduce(((e,t)=>e+t),0)+N.buildings.map((e=>e.isPowered()?e.stats.OxygenCoef:0)).reduce(((e,t)=>e+t),0))*N.oxygenRate*.001*.04*D.SO*.001/10;e&&(N.airLevel=Math.min(1,Math.max(0,N.airLevel+e)),y.publishEvent(new R))}}class Kt{constructor(e=!1,t=!0){this.active=!0,this.canvas=document.createElement("canvas"),e||(this.canvas.style.background="#f0f"),t&&(this.context=this.canvas.getContext("2d",{alpha:e})),this.hide()}reset(){}setZIndex(e){this.canvas.style.zIndex=String(e)}static compareZ(e,t){var i,s,r,n;let a=(null===(s=null===(i=null==e?void 0:e.canvas)||void 0===i?void 0:i.style)||void 0===s?void 0:s.zIndex)||0;const o=(null===(n=null===(r=null==t?void 0:t.canvas)||void 0===r?void 0:r.style)||void 0===n?void 0:n.zIndex)||0;return a===o?0:a>o?-1:1}resize(e,t){this.canvas.width=e,this.canvas.height=t}redraw(){const e=this.onRedraw;if(this.isActive()&&e){const t=this.context;requestAnimationFrame((()=>e(t)))}}show(){this.reset(),this.active=!0,this.canvas.style.visibility="visible",this.redraw()}hide(){this.active=!1,this.canvas.style.visibility="hidden"}isActive(){return this.active}toCanvasCoords(e,t){const i=this.canvas.getBoundingClientRect();return[e-i.left,t-i.top]}handlePointerEvent(e){return!1}handleKeyEvent(e){return!1}handleWheelEvent(e){return!1}}class qt extends Kt{constructor(){super(!0),this.fixedWidth=D.Du,this.fixedHeight=D.DG,this.updateScale()}updateScale(){this.scaleX=this.canvas.width/this.fixedWidth,this.scaleY=this.canvas.height/this.fixedHeight}toScaledCoords(e,t){const[i,s]=this.toCanvasCoords(e,t);return[i/this.scaleX,s/this.scaleY].map((e=>Math.round(e)))}resize(e,t){super.resize(e,t),this.updateScale(),this.context.scale(this.scaleX,this.scaleY)}}!function(e){e[e.MAIN=0]="MAIN",e[e.MIDDLE=1]="MIDDLE",e[e.SECONDARY=2]="SECONDARY"}(Bt||(Bt={})),function(e){e[e.MOVE=0]="MOVE",e[e.DOWN=1]="DOWN",e[e.UP=2]="UP"}(Nt||(Nt={})),function(e){e[e.DOWN=0]="DOWN",e[e.UP=1]="UP"}(Ft||(Ft={}));class zt{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.key=t.key}}class Zt{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.clientX=t.clientX,this.clientY=t.clientY,this.pointerType=t.pointerType,this.button=t.button,this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.shiftKey=t.shiftKey}}class $t{constructor(e){this.type=e.type,this.bubbles=!1,this.clientX=e.clientX,this.clientY=e.clientY,this.deltaX=e.deltaX,this.deltaY=e.deltaY,this.deltaZ=e.deltaZ,this.button=e.button,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey}}class Qt{constructor(e){e.gameCanvasContainer.addEventListener("contextmenu",(t=>{e.isInRect(t)&&t.preventDefault()})),new Map([["pointermove",Nt.MOVE],["pointerdown",Nt.DOWN],["pointerup",Nt.UP]]).forEach(((t,i)=>{e.gameCanvasContainer.addEventListener(i,(i=>{if(!e.isInRect(i))return;i.preventDefault();const s=new Zt(t,i);e.layers.filter((e=>e.isActive())).sort(((e,t)=>Kt.compareZ(e,t))).some((e=>e.handlePointerEvent(s)))}))})),new Map([["keydown",Ft.DOWN],["keyup",Ft.UP]]).forEach(((t,i)=>{e.gameCanvasContainer.addEventListener(i,(i=>{D.Sl||i.preventDefault();const s=new zt(t,i);e.layers.filter((e=>e.isActive())).sort(((e,t)=>Kt.compareZ(e,t))).some((e=>e.handleKeyEvent(s)))}))})),e.gameCanvasContainer.addEventListener("wheel",(t=>{if(!e.isInRect(t))return;const i=new $t(t);e.layers.filter((e=>e.isActive())).sort(((e,t)=>Kt.compareZ(e,t))).some((e=>e.handleWheelEvent(i)))}))}}class ei extends Kt{constructor(){super(!0,!1),y.registerEventListener(s.CHANGE_CURSOR,(e=>{this.changeCursor(e.cursor)}))}show(){super.show(),this.pointersCfg=ct.cfg("Pointers"),this.changeCursor(K.Pointer_Standard)}hide(){super.hide(),this.canvas.style.cursor=null}changeCursor(e){if(this.curUrl&&URL.revokeObjectURL(this.curUrl),!this.pointersCfg)return;const t=l(this.pointersCfg,K[e]),i=ct.getImage(t);this.curUrl=i.toDataURL(),this.canvas.style.cursor="url("+this.curUrl+"), auto"}}class ti{constructor(){if(this.layers=[],this.width=D.Du,this.height=D.DG,this.ratio=D.Du/D.DG,this.gameCanvasContainer=document.getElementById("game-canvas-container"),this.gameCanvasContainer.focus(),this.eventMgr=new Qt(this),!this.gameCanvasContainer)throw"Fatal error: game canvas container not found!";window.addEventListener("resize",(()=>this.onWindowResize())),this.onWindowResize(),this.cursorLayer=this.addLayer(new ei,1e3)}addLayer(e,t=0){return e.resize(this.width,this.height),e.setZIndex(t),this.layers.push(e),this.gameCanvasContainer.appendChild(e.canvas),e}redraw(){this.layers.forEach((e=>e.redraw()))}show(){this.layers.forEach((e=>e.show())),this.redraw()}hide(){this.layers.forEach((e=>e.hide()))}onWindowResize(){const e=this.gameCanvasContainer.offsetWidth,t=this.gameCanvasContainer.offsetHeight,i=Math.round(e/this.ratio);i>t?this.resize(Math.round(t*this.ratio),t):this.resize(e,i)}resize(e,t){this.width=e,this.height=t,this.layers.forEach((i=>i.resize(e,t))),this.redraw()}isInRect(e){if(this.layers.length<1)return!1;const t=this.layers[0];if(!t.isActive()||!t.canvas)return!1;const i=t.canvas.getBoundingClientRect(),s=e.clientX,r=e.clientY;return s>=i.left&&s<i.right&&r>=i.top&&r<i.bottom}}class ii extends We{constructor(e,t){super(Ae.COMPLETE_POWER_PATH),this.surface=e,this.placedItems=t,this.workplaces=[new Ve(e.getRandomPosition())]}onJobComplete(){super.onJobComplete(),this.placedItems.forEach((e=>e.removeFromScene())),this.surface.surfaceType=q.POWER_PATH,this.surface.updateTexture(),this.surface.neighbors.forEach((e=>e.updateTexture()))}getRequiredTool(){return $e.SHOVEL}getPriorityIdentifier(){return Me.aiPriorityConstruction}getWorkplaces(){return this.workplaces}getWorkActivity(){return Je.Clear}}class si{constructor(e,t=null,i=null){this.primarySurface=null,this.secondarySurface=null,this.heading=0,this.neededByType=new Map,this.assignedByType=new Map,this.onSiteByType=new Map,this.complete=!1,this.primarySurface=e,this.secondarySurface=t,this.building=i}getRandomDropPosition(){return this.primarySurface.getRandomPosition()}needs(e){return this.neededByType.getOrUpdate(e,(()=>0))>this.assignedByType.getOrUpdate(e,(()=>[])).length}assign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).push(e)}unAssign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).remove(e)}addItem(e){const t=this.neededByType.getOrUpdate(e.entityType,(()=>0));this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).length<t?(e.onAddToSite(),this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).push(e),this.checkComplete()):e.resetTarget()}checkComplete(){if(!this.complete&&(this.complete=!0,this.neededByType.forEach(((e,t)=>{this.complete=this.complete&&this.onSiteByType.getOrUpdate(t,(()=>[])).length>=e})),this.complete))if(N.buildingSites.remove(this),this.building){this.onSiteByType.getOrUpdate(M.BARRIER,(()=>[])).forEach((e=>{e.changeActivity(yt.Teleport,(()=>e.removeFromScene()))})),this.onSiteByType.getOrUpdate(M.CRYSTAL,(()=>[])).forEach((e=>{e.removeFromScene()})),this.onSiteByType.getOrUpdate(M.ORE,(()=>[])).forEach((e=>{e.removeFromScene()}));const e=this.primarySurface.getCenterWorld2D();this.building.placeDown(e,-this.heading+Math.PI/2,!1)}else{const e=[];this.onSiteByType.forEach((t=>e.push(...t))),y.publishEvent(new he(new ii(this.primarySurface,e)))}}getDropAction(){return Je.Place}}class ri extends Kt{constructor(){super(!1,!1),this.rightDown={x:0,y:0},this.lastCursor=K.Pointer_Standard}reset(){super.reset(),this.rightDown={x:0,y:0},this.lastCursor=K.Pointer_Standard}hide(){super.hide(),y.publishEvent(new L(K.Pointer_Standard))}handlePointerEvent(e){const t=this.sceneMgr.buildMarker;if(e.eventEnum===Nt.MOVE){const i=this.getTerrainPositionFromEvent(e);i&&this.sceneMgr.setTorchPosition(i),t.update(this.sceneMgr.terrain,i),this.updateCursor(e)}else if(e.eventEnum===Nt.UP){if(e.button===Bt.MAIN){if(N.buildModeSelection&&t.lastCheck){const e=N.buildModeSelection(this.worldMgr,this.sceneMgr);t.visibleSurfaces.forEach((e=>{e.surfaceType=q.POWER_PATH_BUILDING,e.updateTexture(),e.neighbors.forEach((e=>e.updateTexture()))}));const i=t.getBarrierLocations(),s=e.stats,r=(null==s?void 0:s.CostCrystal)||0,n=(null==s?void 0:s.CostOre)||0,a=new si(t.primarySurface,t.secondarySurface,e);a.heading=t.heading,a.neededByType.set(M.BARRIER,i.length),a.neededByType.set(M.CRYSTAL,r),a.neededByType.set(M.ORE,n),N.buildingSites.push(a);const o=N.getClosestBuildingByType(t.primarySurface.getCenterWorld(),M.TOOLSTATION);o&&(o.spawnBarriers(i,a),o.spawnMaterials(M.CRYSTAL,r),o.spawnMaterials(M.ORE,n)),y.publishEvent(new S),y.publishEvent(new P)}}else if(e.button===Bt.SECONDARY)if(Math.abs(e.clientX-this.rightDown.x)+Math.abs(e.clientY-this.rightDown.y)<3&&(N.selectionType===A.RAIDER||N.selectionType===A.GROUP)){const t=this.getTerrainPositionFromEvent(e);if(t){const e=this.sceneMgr.terrain.getSurfaceFromWorldXZ(t.x,t.y);e&&(e.isDrillable()?this.assignSurfaceJob(e.createDrillJob(),e,t):e.hasRubble()?this.assignSurfaceJob(e.createClearRubbleJob(),e,t):e.isWalkable()&&(N.selectedEntities.forEach((e=>e.setJob(new dt(t)))),N.selectedEntities.length>0&&y.publishEvent(new S)))}}else N.buildModeSelection=null,t.hideAllMarker()}else e.eventEnum===Nt.DOWN&&e.button===Bt.SECONDARY&&(this.rightDown.x=e.clientX,this.rightDown.y=e.clientY);return this.canvas.dispatchEvent(new PointerEvent(e.type,e)),!0}updateCursor(e){const[t,i]=this.toCanvasCoords(e.clientX,e.clientY),s=t/this.canvas.width*2-1,r=-i/this.canvas.height*2+1,n=new F.iMs;n.setFromCamera({x:s,y:r},this.sceneMgr.camera);const a=this.determineCursor(n);a!==this.lastCursor&&(this.lastCursor=a,y.publishEvent(new L(a)))}determineCursor(e){if(e.intersectObjects(N.raiders.map((e=>e.pickSphere))).length>0)return K.Pointer_Selected;{let t=e.intersectObjects(N.buildings.map((e=>e.pickSphere)));if(t.length>0)return K.Pointer_Selected;if(t=e.intersectObjects(this.sceneMgr.terrain.floorGroup.children),t.length>0){const e=t[0].object.userData;if(e&&e.hasOwnProperty("surface")){const t=e.surface;if(t)return t.surfaceType.cursor}}}return K.Pointer_Standard}handleKeyEvent(e){return!(!D.Sl||e.eventEnum!==Ft.UP||N.selectionType!==A.SURFACE||(N.selectedEntities.forEach((t=>{if("c"===e.key)t.surfaceType.floor||t.collapse();else if("f"===e.key){const e=t.terrain.findFallInTarget(t.x,t.y);t.surfaceType.floor||t.createFallin(e[0],e[1])}})),y.publishEvent(new S),0))}assignSurfaceJob(e,t,i){e&&(N.selectedEntities.forEach((s=>{s.hasTool(e.getRequiredTool())&&s.hasTraining(e.getRequiredTraining())?s.setJob(e):t.isWalkable()&&s.setJob(new dt(i))})),N.selectedEntities.length>0&&y.publishEvent(new S))}getTerrainPositionFromEvent(e){const[t,i]=this.toCanvasCoords(e.clientX,e.clientY),s=t/this.canvas.width*2-1,r=-i/this.canvas.height*2+1;return this.sceneMgr.getTerrainIntersectionPoint(s,r)}handleWheelEvent(e){return this.canvas.dispatchEvent(new WheelEvent(e.type,e)),!0}}class ni{static setFromCfg(e,t){return Object.keys(t).forEach((i=>{const s=(i.startsWith("!")?i.substring(1):i).toLowerCase().replace(/_/g,"").replace(/-/g,"");Object.keys(e).some((r=>e.assignValue(r,s,t[i])))||console.warn("cfg key does not exist: "+i)})),e}assignValue(e,t,i){if(e.toLowerCase()===t){const s=this[e],r=Array.isArray(s);let n=this.parseValue(t,i);const a=Array.isArray(n);return s&&r!==a&&r&&(n=[n]),this[e]=n,!0}}parseValue(e,t){return t}}class ai{constructor(){this.buttonType=null,this.normalFile=null,this.highlightFile=null,this.pressedFile=null,this.disabledFile=null,this.relX=0,this.relY=0,this.width=0,this.height=0,this.tooltip=null}}class oi extends ai{constructor(e){if(super(),9!==e.length)throw"Invalid number of arguments ("+e.length+") given for button configuration expected 9 or 5";[this.buttonType,this.normalFile,this.highlightFile,this.pressedFile,this.relX,this.relY,this.width,this.height,this.tooltip]=e}}class hi extends ni{constructor(e){super(),this.panelButtonInfoDockGoto=null,this.panelButtonInfoDockClose=null,ni.setFromCfg(this,e)}parseValue(e,t){return new oi(t)}}class li{constructor(e=null){this.parent=null,this.x=0,this.y=0,this.relX=0,this.relY=0,this.width=0,this.height=0,this.children=[],this.hidden=!1,this.disabled=!1,this.hover=!1,this.pressed=!1,this.parent=e}reset(){this.hidden=!1,this.disabled=!1,this.hover=!1,this.pressed=!1,this.children.forEach((e=>e.reset()))}addChild(e){return e.parent=this,this.children.push(e),e.updatePosition(),e}onRedraw(e){this.hidden||(this.children.forEach((t=>t.onRedraw(e))),this.children.forEach((t=>t.drawHover(e))),this.children.forEach((t=>t.drawTooltip(e))))}drawHover(e){}drawTooltip(e){}onClick(){}isInactive(){for(let e=this.parent;e;e=e.parent)if(e.isInactive())return!0;return this.hidden||this.disabled}hide(){this.hidden=!0,this.children.forEach((e=>e.hide()))}show(){this.hidden=!1,this.children.forEach((e=>e.show()))}updatePosition(){this.x=this.parent?this.parent.x+this.relX:this.relX,this.y=this.parent?this.parent.y+this.relY:this.relY,this.children.forEach((e=>e.updatePosition()))}isInRect(e,t){return e>=this.x&&t>=this.y&&e<this.x+this.width&&t<this.y+this.height}checkHover(e,t){if(this.isInactive())return!1;const i=this.isInRect(e,t);let s=this.hover!==i;return this.hover=i,this.pressed=this.pressed&&this.hover,this.children.forEach((i=>s=i.checkHover(e,t)||s)),s}checkClick(e,t){if(this.isInactive())return!1;const i=this.isInRect(e,t);let s=this.pressed!==i;return this.pressed=i,this.children.forEach((i=>s=i.checkClick(e,t)||s)),s}checkRelease(e,t){if(this.isInactive())return!1;this.isInRect(e,t)&&this.pressed&&this.onClick();let i=!1;return this.children.forEach((s=>i=s.checkRelease(e,t)||i)),i=this.pressed||i,this.pressed=!1,i}release(){let e=this.pressed||this.hover;return this.pressed=!1,this.hover=!1,this.children.forEach((t=>e=t.release()||e)),e}notifyRedraw(){this.parent&&this.parent.notifyRedraw()}}class ci extends li{constructor(e,t){var i,s,r,n,a;super(e),this.buttonType=null,this.imgNormal=null,this.imgHover=null,this.imgPressed=null,this.imgDisabled=null,this.tooltip=null,this.buttonType=t.buttonType,this.imgNormal=ct.getImageOrNull(t.normalFile),this.imgHover=ct.getImageOrNull(t.highlightFile),this.imgPressed=ct.getImageOrNull(t.pressedFile),this.imgDisabled=ct.getImageOrNull(t.disabledFile),this.relX=t.relX,this.relY=t.relY,this.width=t.width||(null===(i=this.imgNormal)||void 0===i?void 0:i.width)||(null===(s=this.imgPressed)||void 0===s?void 0:s.width),this.height=t.height||(null===(r=this.imgNormal)||void 0===r?void 0:r.height)||(null===(n=this.imgPressed)||void 0===n?void 0:n.height),this.tooltip=null===(a=t.tooltip)||void 0===a?void 0:a.replace(/_/g," "),this.updatePosition()}onClick(){console.log("button pressed: "+this.buttonType)}checkHover(e,t){const i=super.checkHover(e,t);return i&&this.notifyRedraw(),i}checkClick(e,t){const i=super.checkClick(e,t);return i&&this.notifyRedraw(),i}checkRelease(e,t){const i=super.checkRelease(e,t);return i&&this.notifyRedraw(),i}release(){const e=super.release();return e&&this.notifyRedraw(),e}onRedraw(e){if(this.hidden)return;let t=this.imgNormal;this.disabled?t=this.imgDisabled||this.imgPressed||this.imgNormal:this.pressed?t=this.imgPressed||this.imgNormal:this.hover&&(t=this.imgHover||this.imgNormal),t&&e.drawImage(t,this.x,this.y),super.onRedraw(e)}}class di extends li{constructor(e){super(),this.img=null,this.xOut=0,this.yOut=0,this.xIn=0,this.yIn=0,this.animationTimeout=null,this.movedIn=!0,e&&(this.img=ct.getImage(e.filename),this.xOut=e.xOut,this.yOut=e.yOut,this.xIn=e.xIn,this.yIn=e.yIn,this.relX=this.xIn,this.relY=this.yIn)}reset(){super.reset(),this.animationTimeout=m(this.animationTimeout),this.relX=this.xIn,this.relY=this.yIn,this.movedIn=!0,this.updatePosition()}isInactive(){return this.animationTimeout||super.isInactive()}setMovedIn(e,t=null){this.movedIn!==e?this.toggleState(t):t&&t()}toggleState(e=null){this.animationTimeout=m(this.animationTimeout),this.movedIn?(this.movedIn=!1,this.updateAnimation(this.xOut,this.yOut,D.CM,e)):(this.movedIn=!0,this.updateAnimation(this.xIn,this.yIn,D.CM,e))}updateAnimation(e,t,i,s){const r=e-this.relX,n=t-this.relY;if(Math.abs(r)<=i&&Math.abs(n)<=i)this.relX=e,this.relY=t,this.animationTimeout=null,s&&s();else{this.relX+=Math.round(Math.sign(r)*Math.sqrt(Math.abs(r))*i),this.relY+=Math.round(Math.sign(n)*Math.sqrt(Math.abs(n))*i);const a=this;this.animationTimeout=setTimeout((()=>a.updateAnimation(e,t,i,s)),1e3/D.OK)}this.updatePosition(),this.notifyRedraw()}onRedraw(e){this.hidden||(this.img&&e.drawImage(this.img,this.x,this.y),super.onRedraw(e))}}class ui extends di{constructor(e,t,i,s){super(e),this.fill=this.addChild(new di(t)),this.fill.relX=this.relX-this.fill.relX,this.fill.relY=this.relY-this.fill.relY,this.overlay=this.addChild(new di(i)),this.btnToggle=this.addChild(new ci(this,s.panelButtonRadarToggle)),this.btnToggle.onClick=()=>this.toggleState(),this.btnMap=this.addChild(new ci(this,s.panelButtonRadarMapView)),this.btnMap.onClick=()=>{},this.btnTagged=this.addChild(new ci(this,s.panelButtonRadarTaggedObjectView)),this.btnTagged.onClick=()=>{}}}class gi extends ni{constructor(e){super(),this.panelButtonRadarToggle=null,this.panelButtonRadarTaggedObjectView=null,this.panelButtonRadarZoomIn=null,this.panelButtonRadarZoomOut=null,this.panelButtonRadarMapView=null,ni.setFromCfg(this,e)}parseValue(e,t){return new oi(t)}}class pi extends li{constructor(e,t,i){super(e),this.relX=t.relX,this.relY=t.relY,this.width=t.width,this.height=t.height,this.tooltip=t.tooltip,this.label=i,this.updatePosition()}onRedraw(e){this.hidden||(e.textAlign="center",e.font="bold 10px Arial",e.fillStyle="#fff",e.fillText(this.label,this.x+this.width/2,this.y+this.height-2),super.onRedraw(e))}}class mi extends di{constructor(e,t){super(e),this.labelOre=this.addChild(new pi(this,t.panelButtonCrystalSideBarOre,N.totalOre.toString())),this.labelCrystal=this.addChild(new pi(this,t.panelButtonCrystalSideBarCrystals,N.numCrystal.toString())),this.imgNoCrystal=ct.getImage("Interface/RightPanel/NoSmallCrystal.bmp"),this.imgSmallCrystal=ct.getImage("Interface/RightPanel/SmallCrystal.bmp"),this.imgUsedCrystal=ct.getImage("Interface/RightPanel/UsedCrystal.bmp"),this.imgOre=ct.getImage("Interface/RightPanel/CrystalSideBar_Ore.bmp"),y.registerEventListener(s.MATERIAL_AMOUNT_CHANGED,(e=>{e.entityType!==M.CRYSTAL&&e.entityType!==M.ORE&&e.entityType!==M.BRICK||this.notifyRedraw()}))}onRedraw(e){this.labelOre.label=N.totalOre.toString(),this.labelCrystal.label=N.numCrystal.toString(),super.onRedraw(e);let t=this.x+this.img.width-8,i=this.y+this.img.height-34;for(let s=0;(N.neededCrystals<1||s<Math.max(N.neededCrystals,N.numCrystal))&&i>=Math.max(this.imgNoCrystal.height,this.imgSmallCrystal.height,this.imgUsedCrystal.height);s++){let r=this.imgNoCrystal;N.usedCrystals>s?r=this.imgUsedCrystal:N.numCrystal>s&&(r=this.imgSmallCrystal),i-=r.height,e.drawImage(r,t-r.width/2,i)}t=this.x+this.img.width-21,i=this.y+this.img.height-42;for(let s=0;s<N.numOre&&i>=this.imgOre.height;++s)i-=this.imgOre.height,e.drawImage(this.imgOre,t-this.imgOre.width/2,i)}}class fi extends ni{constructor(e){super(),this.panelButtonCrystalSideBarOre=null,this.panelButtonCrystalSideBarCrystals=null,ni.setFromCfg(this,e)}parseValue(e,t){return new oi(t)}}class yi extends ni{constructor(e){super(),this.panelButtonPriorityListDisable=[],this.panelButtonPriorityListUpOne=[],this.panelButtonPriorityListClose=null,this.panelButtonPriorityListReset=null,ni.setFromCfg(this,e)}assignValue(e,t,i){return t.match(/panelButtonPriorityListDisable\d+/i)?(this.panelButtonPriorityListDisable.push(this.parseValue(t,i)),!0):t.match(/panelButtonPriorityListUpOne\d+/i)?(this.panelButtonPriorityListUpOne.push(this.parseValue(t,i)),!0):super.assignValue(e,t,i)}parseValue(e,t){return new oi(t)}}class wi extends ni{constructor(e){super(),this.panelButtonTopPanelCallToArms=null,this.panelButtonTopPanelOptions=null,this.panelButtonTopPanelPriorities=null,ni.setFromCfg(this,e)}parseValue(e,t){return new oi(t)}}class vi extends ni{constructor(e){super(),this.panelButtonCameraControlZoomIn=null,this.panelButtonCameraControlZoomOut=null,this.panelButtonCameraControlCycleBuildings=null,this.panelButtonCameraControlRotate=null,ni.setFromCfg(this,e)}parseValue(e,t){return new oi(t)}}class bi extends ni{constructor(e){super(),this.panelButtonInformationToggle=null,this.panelButtonInformationFunction=null,ni.setFromCfg(this,e)}parseValue(e,t){return new oi(t)}}class Ii extends ni{constructor(e){super(),this.panelRadar=null,this.panelCrystalSideBar=null,this.panelTopPanel=null,this.panelInformation=null,this.panelPriorityList=null,this.panelCameraControl=null,this.panelInfoDock=null,this.panelEncyclopedia=null,ni.setFromCfg(this,e)}parseValue(e,t){const i={};return t.forEach((e=>i[e[0]]=e)),e==="panelRadar".toLowerCase()?new gi(i):e==="panelCrystalSideBar".toLowerCase()?new fi(i):e==="panelTopPanel".toLowerCase()?new wi(i):e==="panelInformation".toLowerCase()?new bi(i):e==="panelPriorityList".toLowerCase()?new yi(i):e==="panelCameraControl".toLowerCase()?new vi(i):e==="panelInfoDock".toLowerCase()?new hi(i):e==="panelEncyclopedia".toLowerCase()?null:i}}class Ei{constructor(e){[this.filename,this.xOut,this.yOut,this.xIn,this.yIn]=e}}class Ti extends ni{constructor(e){super(),this.panelRadar=null,this.panelRadarFill=null,this.panelRadarOverlay=null,this.panelMessages=null,this.panelMessagesSide=null,this.panelCrystalSideBar=null,this.panelTopPanel=null,this.panelInformation=null,this.panelPriorityList=null,this.panelCameraControl=null,this.panelInfoDock=null,this.panelEncyclopedia=null,ni.setFromCfg(this,e)}parseValue(e,t){return new Ei(t)}}class Si extends ai{constructor(e){super(),this.normalFile=e,this.highlightFile=e,this.pressedFile=e,this.disabledFile=e,this.relX=0,this.relY=0}}class Ci extends ci{constructor(e,t,i){super(e,new Si(t.buttonImageFilename)),this.messages=[],this.text=null,this.animationTimeout=null,this.animationSpeedX=.5,this.animationSpeedY=1,this.text=t.message,this.hidden=!0,this.onClick=()=>{this.messages.length<1||e.buttonClicked(this)},y.registerEventListener(i,(t=>{for(this.hidden=!1;this.messages.length>=9;)this.messages.pop();this.messages.unshift(t),e.showButton(this)}))}reset(){super.reset(),this.animationTimeout=m(this.animationTimeout),this.text=null,this.hidden=!0,this.messages=[]}slideToTarget(e,t){return new Promise((i=>this.updateAnimation(e,t,i)))}updateAnimation(e,t,i){const s=e-this.relX,r=t-this.relY;if(Math.abs(s)<=this.animationSpeedX&&Math.abs(r)<=this.animationSpeedY)this.relX=e,this.relY=t,this.animationTimeout=null,i&&i();else{this.relX+=Math.round(Math.sign(s)*Math.sqrt(Math.abs(s))*this.animationSpeedX),this.relY+=Math.round(Math.sign(r)*Math.sqrt(Math.abs(r))*this.animationSpeedY);const n=this;this.animationTimeout=setTimeout((()=>n.updateAnimation(e,t,i)),1e3/D.OK)}this.updatePosition(),this.notifyRedraw()}onRedraw(e){super.onRedraw(e),this.hidden||(e.textAlign="left",e.font="bold 10px Arial",e.fillStyle="#fff",e.fillText(this.messages.length.toString(),this.x+2,this.y+this.height/2+2))}}class Ri extends di{constructor(e,t,i,r){super(e),this.stackButtons=[],this.informationPanel=null,this.informationPanel=r,this.addChild(new ci(this,t.panelButtonInfoDockGoto)).onClick=()=>this.gotoLatestMessage(),this.addChild(new ci(this,t.panelButtonInfoDockClose)).onClick=()=>this.dropLatestMessage(),this.addChild(new Ci(this,i.infoGenericDeath,s.LOCATION_DEATH)),this.addChild(new Ci(this,i.infoGenericMonster,s.LOCATION_MONSTER)),this.addChild(new Ci(this,i.infoCrystalFound,s.LOCATION_CRYSTAL_FOUND)),this.addChild(new Ci(this,i.infoUnderAttack,s.LOCATION_UNDER_ATTACK)),this.addChild(new Ci(this,i.infoLandslide,s.LOCATION_LANDSLIDE)),this.addChild(new Ci(this,i.infoPowerDrain,s.LOCATION_POWER_DRAIN)),this.addChild(new Ci(this,i.infoSlugEmerge,s.LOCATION_SLUG_EMERGE)),this.addChild(new Ci(this,i.infoFoundMinifigure,s.LOCATION_RAIDER_DISCOVERED))}reset(){super.reset(),this.stackButtons=[]}gotoLatestMessage(){if(this.stackButtons.length<1)return;const e=this.stackButtons[0];if(e.messages.length<1)return;const t=e.messages[0];console.log("TODO force move camera to: "+t.location.toArray())}dropLatestMessage(){if(this.stackButtons.length<1)return;const e=this.stackButtons[0];e.messages.length<1||(e.messages.shift(),e.messages.length<1&&(e.hidden=!0,this.informationPanel.setMovedIn(!0),this.stackButtons.splice(this.stackButtons.indexOf(e),1),this.slideStackIntoPosition().then()),e.notifyRedraw())}showButton(e){this.stackButtons.includes(e)?e.notifyRedraw():this.slideInButton(e)}slideInButton(e){this.stackButtons.forEach((e=>e.disabled=!0));const t=-this.stackButtons.map((e=>e.height)).reduce(((e,t)=>e+t),0);this.stackButtons.push(e),e.relX=-e.width,e.relY=t-e.height,e.updatePosition(),e.slideToTarget(0,t).then((()=>this.stackButtons.forEach((e=>e.disabled=!1))))}buttonClicked(e){e!==this.stackButtons[0]?this.pushFirst(e):(this.informationPanel.setText(e.text),this.informationPanel.toggleState())}pushFirst(e){this.stackButtons.splice(this.stackButtons.indexOf(e),1),this.stackButtons.unshift(e),this.slideStackIntoPosition().then((()=>{this.informationPanel.setText(e.text),this.informationPanel.setMovedIn(!1)}))}slideStackIntoPosition(){this.stackButtons.forEach((e=>e.disabled=!0));let e=0;const t=this.stackButtons.map((t=>{const i=t.slideToTarget(0,e);return e-=t.height,i}));return new Promise((e=>{Promise.all(t).then((()=>{this.stackButtons.forEach((e=>e.disabled=!1)),e()}))}))}}class Pi{constructor(e){this.message=null,this.buttonImageFilename=null,this.sfx=null,this.timing=null,this.flag=null,[this.message,this.buttonImageFilename,this.sfx,this.timing,this.flag]=e,this.message=this.message.replace(/_/g," ")}}class Li extends ni{constructor(e){super(),this.infoGenericDeath=null,this.infoGenericMonster=null,this.infoCrystalFound=null,this.infoUnderAttack=null,this.infoLandslide=null,this.infoPowerDrain=null,this.infoSlugEmerge=null,this.infoFoundMinifigure=null,ni.setFromCfg(this,e)}parseValue(e,t){return new Pi(t)}}class Mi extends di{constructor(e){super(e),this.font=null,this.textImage=null,this.font=ct.getDefaultFont()}setText(e){this.textImage=e?this.font.createTextImage(e,this.img.width-80):null,this.notifyRedraw()}onRedraw(e){super.onRedraw(e),this.textImage&&e.drawImage(this.textImage,this.x+(this.img.width-this.textImage.width)/2,this.y+12)}}class xi extends ai{constructor(e){super(),[this.width,this.height,this.highlightFile,this.pressedFile,this.tooltip]=e,this.relX=4,this.relY=14}}class Ai extends ai{constructor(e){var t,i;if(super(),this.tooltipSfx=null,this.tooltipDisabled=null,this.tooltipDisabledSfx=null,this.hotkey=null,4===e.length)[this.normalFile,this.disabledFile,this.pressedFile,this.hotkey]=e;else if(6===e.length||7===e.length){let t,i;[this.normalFile,this.disabledFile,this.pressedFile,t,i,this.hotkey]=e,t&&(Array.isArray(t)?[this.tooltip,this.tooltipSfx]=t:this.tooltip=t),i&&(Array.isArray(i)?[this.tooltipDisabled,this.tooltipDisabledSfx]=i:this.tooltipDisabled=i)}else console.error("Unexpected menu item cfg value length: "+e.length);null===(t=this.tooltip)||void 0===t||t.replace(/_/g," "),null===(i=this.tooltipDisabled)||void 0===i||i.replace(/_/g," "),this.width=40,this.height=40}}class Oi extends ci{constructor(e,t,i,s,r){super(e,t),this.tooltipSfx=null,this.tooltipDisabled=null,this.tooltipDisabledSfx=null,this.hotkey=null,this.isDisabled=()=>this.disabled,this.buttonType=i,this.relX=s-59,this.relY=9+this.height*r,this.tooltipSfx=t.tooltipSfx,this.tooltipDisabled=t.tooltipDisabled,this.tooltipDisabledSfx=t.tooltipDisabledSfx,this.hotkey=t.hotkey,this.disabled=!0}reset(){super.reset(),this.disabled=!0,this.updateState(!1)}onClick(){console.log("menu item pressed: "+this.buttonType)}updateState(e=!0){const t=!!this.isDisabled(),i=this.disabled!==t;return this.disabled=t,i&&e&&this.notifyRedraw(),i}drawHover(e){super.drawHover(e),!this.disabled&&this.hover&&(e.strokeStyle="#0f0",e.lineWidth=2,e.strokeRect(this.x-e.lineWidth/2,this.y-e.lineWidth/2,this.width+e.lineWidth-1,this.height+e.lineWidth-1))}}class Di extends di{constructor(e,t=null){if(super(),this.backBtn=null,this.iconPanelButtons=[],t){const e=new xi(ct.cfg("InterfaceBackButton"));this.backBtn=this.addChild(new ci(this,e)),this.backBtn.onClick=()=>this.toggleState((()=>t.toggleState()))}const i=ct.cfg("InterfaceSurroundImages",e.toString()),[s,r,n,a,o,h,l,c]=i;this.img=t?ct.getImage(s):ct.getImage(h),this.xOut=-this.img.width}addMenuItem(e,t){const i=new Ai(ct.cfg(e,t)),s=this.addChild(new Oi(this,i,t,this.img.width,this.iconPanelButtons.length));return this.iconPanelButtons.push(s),s}toggleState(e=null){super.toggleState(e),this.movedIn||this.iconPanelButtons.forEach((e=>e.updateState()))}}class _i extends Di{constructor(e){super(10,e),this.backBtn.onClick=()=>{y.publishEvent(new P),this.toggleState((()=>e.toggleState()))},this.addBuildMenuItem("InterfaceBuildImages","Toolstation",((e,t)=>new xt(e,t))),this.addBuildMenuItem("InterfaceBuildImages","TeleportPad",((e,t)=>new Mt(e,t))),this.addBuildMenuItem("InterfaceBuildImages","Docks",((e,t)=>new Tt(e,t))),this.addBuildMenuItem("InterfaceBuildImages","Powerstation",((e,t)=>new Pt(e,t))),this.addBuildMenuItem("InterfaceBuildImages","Barracks",((e,t)=>new Et(e,t))),this.addBuildMenuItem("InterfaceBuildImages","Upgrade",((e,t)=>new At(e,t))),this.addBuildMenuItem("InterfaceBuildImages","Geo-dome",((e,t)=>new St(e,t))),this.addBuildMenuItem("InterfaceBuildImages","OreRefinery",((e,t)=>new Rt(e,t))),this.addBuildMenuItem("InterfaceBuildImages","Gunstation",((e,t)=>new Ct(e,t))),this.addBuildMenuItem("InterfaceBuildImages","TeleportBIG",((e,t)=>new Lt(e,t)))}addBuildMenuItem(e,t,i){const s=this.addMenuItem(e,t);return s.isDisabled=()=>!1,s.onClick=()=>N.buildModeSelection=i,s}}class ki extends Di{constructor(e){super(8,e),this.addGetToolItem("InterfaceImages","Interface_MenuItem_GetDrill",$e.DRILL),this.addGetToolItem("InterfaceImages","Interface_MenuItem_GetSpade",$e.SHOVEL),this.addGetToolItem("InterfaceImages","Interface_MenuItem_GetHammer",$e.HAMMER),this.addGetToolItem("InterfaceImages","Interface_MenuItem_GetSpanner",$e.SPANNER),this.addGetToolItem("InterfaceImages","Interface_MenuItem_GetFreezerGun",$e.FREEZERGUN),this.addGetToolItem("InterfaceImages","Interface_MenuItem_GetLaser",$e.LASER),this.addGetToolItem("InterfaceImages","Interface_MenuItem_GetPusherGun",$e.PUSHERGUN),this.addGetToolItem("InterfaceImages","Interface_MenuItem_GetBirdScarer",$e.BIRDSCARER)}addGetToolItem(e,t,i){const s=super.addMenuItem(e,t);return s.isDisabled=()=>!N.hasOneBuildingOf(M.TOOLSTATION)||N.selectedRaiders.every((e=>e.hasTool(i))),s.onClick=()=>{N.selectedRaiders.forEach((e=>{if(!e.hasTool(i)){const t=N.getBuildingsByType(M.TOOLSTATION).map((t=>e.findPathToTarget(new Ve(t.getPosition2D())))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];t&&e.setJob(new Wt(t.targetPosition,i))}})),y.publishEvent(new S)},s}}class Bi extends li{constructor(e){super(e),this.relX=4,this.relY=11,y.registerEventListener(s.RAIDER_REQUESTED,(()=>this.notifyRedraw()))}onRedraw(e){if(this.hidden)return;const t=N.requestedRaiders;t&&(e.textAlign="left",e.font="bold 10px Arial",e.fillStyle=this.disabled||this.parent&&this.parent.disabled?"#444":"#fff",e.fillText(t.toString(),this.x,this.y),super.onRedraw(e))}}class Ni extends Di{constructor(e){super(5,e),this.addMenuItem("InterfaceBuildImages","BullDozer"),this.addMenuItem("InterfaceBuildImages","WalkerDigger"),this.addMenuItem("InterfaceBuildImages","LargeMLP"),this.addMenuItem("InterfaceBuildImages","LargeDigger"),this.addMenuItem("InterfaceBuildImages","LargeCat")}}class Fi extends Oi{constructor(e,t,i,s,r){super(e,t,null,s,r),this.toggleState=!1,this.imgOnNormal=ct.getImageOrNull(i.normalFile),this.imgOnHover=ct.getImageOrNull(i.highlightFile),this.imgOnPressed=ct.getImageOrNull(i.pressedFile),this.imgOnDisabled=ct.getImageOrNull(i.disabledFile)}onClick(){this.toggleState=!this.toggleState,this.onToggleStateChange()}onToggleStateChange(){}onRedraw(e){if(this.hidden)return;let t=this.toggleState?this.imgOnNormal:this.imgNormal;this.disabled?t=this.toggleState?this.imgOnDisabled||this.imgOnPressed||this.imgOnNormal:this.imgDisabled||this.imgPressed||this.imgNormal:this.pressed?t=this.toggleState?this.imgOnPressed||this.imgOnNormal:this.imgPressed||this.imgNormal:this.hover&&(t=this.toggleState?this.imgOnHover||this.imgOnNormal:this.imgHover||this.imgNormal),t&&e.drawImage(t,this.x,this.y),this.children.forEach((t=>t.onRedraw(e))),this.children.forEach((t=>t.drawHover(e))),this.children.forEach((t=>t.drawTooltip(e)))}}class Ui extends Di{constructor(e,t){super(e,t),this.backBtn.onClick=()=>y.publishEvent(new S)}}class Wi extends Ui{constructor(e){super(4,e),this.addMenuItem("InterfaceImages","Interface_MenuItem_Repair");const t=new Ai(ct.cfg("InterfaceImages","Interface_MenuItem_PowerOff")),i=new Ai(ct.cfg("InterfaceImages","Interface_MenuItem_PowerOn")),r=this.addChild(new Fi(this,t,i,this.img.width,this.iconPanelButtons.length));this.iconPanelButtons.push(r),r.isDisabled=()=>{var e,t,i,s;return N.usedCrystals>=N.numCrystal||(null===(t=null===(e=N.selectedBuilding)||void 0===e?void 0:e.stats)||void 0===t?void 0:t.SelfPowered)||(null===(s=null===(i=N.selectedBuilding)||void 0===i?void 0:i.stats)||void 0===s?void 0:s.PowerBuilding)},r.onToggleStateChange=()=>{var e,t;r.toggleState?null===(e=N.selectedBuilding)||void 0===e||e.turnOffPower():null===(t=N.selectedBuilding)||void 0===t||t.turnOnPower()};const n=this.addMenuItem("InterfaceImages","Interface_MenuItem_UpgradeBuilding");n.isDisabled=()=>{var e;return!(null===(e=N.selectedBuilding)||void 0===e?void 0:e.canUpgrade())},n.onClick=()=>{var e;return null===(e=N.selectedBuilding)||void 0===e?void 0:e.upgrade()};const a=this.addMenuItem("InterfaceImages","Interface_MenuItem_DeleteBuilding");a.isDisabled=()=>!1,a.onClick=()=>{var e;return null===(e=N.selectedBuilding)||void 0===e?void 0:e.beamUp()},y.registerEventListener(s.SELECTED_BUILDING,(()=>{r.updateState(),n.updateState()})),y.registerEventListener(s.MATERIAL_AMOUNT_CHANGED,(()=>{r.updateState(),n.updateState()}))}}class Hi extends Ui{constructor(e){super(3,e);const t=this.addMenuItem("InterfaceImages","Interface_MenuItem_LayPath");t.onClick=()=>{var e;const t=N.selectedEntities[0];t.surfaceType=q.POWER_PATH_SITE,t.updateTexture(),null===(e=N.getClosestBuildingByType(t.getCenterWorld(),M.TOOLSTATION))||void 0===e||e.spawnMaterials(M.ORE,2);const i=new si(t);i.neededByType.set(M.ORE,2),N.buildingSites.push(i),y.publishEvent(new S)},t.isDisabled=()=>{var e;return(null===(e=N.selectedSurface)||void 0===e?void 0:e.surfaceType)!==q.GROUND};const i=this.addMenuItem("InterfaceImages","Interface_MenuItem_RemovePath");i.onClick=()=>{var e;null===(e=N.selectedSurface)||void 0===e||e.makeRubble(2),y.publishEvent(new S)},i.isDisabled=()=>{var e;return(null===(e=N.selectedSurface)||void 0===e?void 0:e.surfaceType)!==q.POWER_PATH};const r=this.addMenuItem("InterfaceImages","Interface_MenuItem_PlaceFence");r.isDisabled=()=>{var e;return!N.hasOneBuildingOf(M.POWER_STATION)||!(null===(e=N.selectedSurface)||void 0===e?void 0:e.canPlaceFence())},r.onClick=()=>{var e;const t=N.selectedSurface;t&&(null===(e=N.getClosestBuildingByType(t.getCenterWorld(),M.TOOLSTATION))||void 0===e||e.spawnFence(t)),y.publishEvent(new S)},y.registerEventListener(s.SELECTED_SURFACE,(()=>{t.updateState(),i.updateState(),r.updateState()}))}}class Gi extends Ue{constructor(){super(Ae.EAT)}getWorkplaces(){return this.fulfiller.map((e=>new Ve(e.getPosition2D())))}onJobComplete(){super.onJobComplete()}getWorkActivity(){return Je.Eat}}class Ji extends Ui{constructor(e){super(10,e);const t=this.addMenuItem("InterfaceImages","Interface_MenuItem_GoFeed");t.isDisabled=()=>!1,t.onClick=()=>{N.selectedRaiders.forEach((e=>!e.isDriving()&&e.setJob(new Gi))),y.publishEvent(new S)},this.addMenuItem("InterfaceImages","Interface_MenuItem_UnLoadMinifigure"),this.addMenuItem("InterfaceImages","Interface_MenuItem_MinifigurePickUp"),this.getToolItem=this.addMenuItem("InterfaceImages","Interface_MenuItem_GetTool"),this.getToolItem.isDisabled=()=>!1,this.addMenuItem("InterfaceImages","Interface_MenuItem_DropBirdScarer"),this.addMenuItem("InterfaceImages","Interface_MenuItem_UpgradeMan"),this.trainItem=this.addMenuItem("InterfaceImages","Interface_MenuItem_TrainSkill"),this.trainItem.isDisabled=()=>!1,this.addMenuItem("InterfaceImages","Interface_MenuItem_GotoFirstPerson"),this.addMenuItem("InterfaceImages","Interface_MenuItem_GotoSecondPerson");const i=this.addMenuItem("InterfaceImages","Interface_MenuItem_DeleteMan");i.isDisabled=()=>!1,i.onClick=()=>N.selectedRaiders.forEach((e=>e.beamUp()))}}class Vi extends Ui{constructor(e){super(2,e);const t=this.addMenuItem("InterfaceImages","Interface_MenuItem_ClearRubble");t.onClick=()=>{var e;null===(e=N.selectedSurface)||void 0===e||e.createClearRubbleJob(),y.publishEvent(new S)},t.isDisabled=()=>{var e;return!(null===(e=N.selectedSurface)||void 0===e?void 0:e.hasRubble())},this.addMenuItem("InterfaceImages","Interface_MenuItem_PlaceFence"),y.registerEventListener(s.SELECTED_SURFACE,(()=>t.updateState()))}}class Yi extends Ui{constructor(e){super(7,e)}}class ji extends Ui{constructor(e){super(4,e);const t=this.addWallMenuItem("Interface_MenuItem_Dig",(()=>{var e;return null===(e=N.selectedSurface)||void 0===e?void 0:e.createDrillJob()}));t.isDisabled=()=>{var e,t;return!(null===(e=N.selectedSurface)||void 0===e?void 0:e.isDrillable())&&!(null===(t=N.selectedSurface)||void 0===t?void 0:t.isDrillableHard())};const i=this.addWallMenuItem("Interface_MenuItem_Reinforce",(()=>{var e;return null===(e=N.selectedSurface)||void 0===e?void 0:e.createReinforceJob()}));i.isDisabled=()=>{var e;return!(null===(e=N.selectedSurface)||void 0===e?void 0:e.isReinforcable())};const r=this.addWallMenuItem("Interface_MenuItem_Dynamite",(()=>{var e;return null===(e=N.selectedSurface)||void 0===e?void 0:e.createDynamiteJob()}));r.isDisabled=()=>!N.hasBuildingWithUpgrades(M.TOOLSTATION,2)&&!N.raiders.some((e=>e.hasTraining(B.DEMOLITION)));const n=this.addMenuItem("InterfaceImages","Interface_MenuItem_DeselectDig");n.isDisabled=()=>!1,n.onClick=()=>{N.selectedEntities[0].cancelJobs(),y.publishEvent(new S)},y.registerEventListener(s.SELECTED_SURFACE,(()=>{t.updateState(!1),i.updateState(!1),r.updateState(!1),this.notifyRedraw()}))}addWallMenuItem(e,t){const i=this.addMenuItem("InterfaceImages",e);return i.onClick=()=>{t(),y.publishEvent(new S)},i}}class Xi extends Di{constructor(e){super(6,e),this.addMenuItem("InterfaceBuildImages","Hoverboard"),this.addMenuItem("InterfaceBuildImages","SmallDigger"),this.addMenuItem("InterfaceBuildImages","SmallTruck"),this.addMenuItem("InterfaceBuildImages","SmallCat"),this.addMenuItem("InterfaceBuildImages","SmallMLP"),this.addMenuItem("InterfaceBuildImages","SmallHeli")}}class Ki extends Di{constructor(e){super(6,e),this.addMenuItem("InterfaceImages","Interface_MenuItem_TrainDriver"),this.addMenuItem("InterfaceImages","Interface_MenuItem_TrainEngineer"),this.addMenuItem("InterfaceImages","Interface_MenuItem_TrainGeologist"),this.addMenuItem("InterfaceImages","Interface_MenuItem_TrainPilot"),this.addMenuItem("InterfaceImages","Interface_MenuItem_TrainSailor");const t=this.addMenuItem("InterfaceImages","Interface_MenuItem_TrainDynamite");t.isDisabled=()=>!N.getBuildingsByType(M.TOOLSTATION).some((e=>e.stats.TrainDynamite[e.level]))||N.selectedRaiders.every((e=>e.hasTraining(B.DEMOLITION))),t.onClick=()=>{N.getBuildingsByType(M.TOOLSTATION).some((e=>{if(e.stats.TrainDynamite[e.level])return N.selectedRaiders.forEach((t=>!t.hasTraining(B.DEMOLITION)&&t.setJob(new Gt(e.primarySurface,B.DEMOLITION)))),y.publishEvent(new S),!0}))},y.registerEventListener(s.BUILDING_UPGRADED,(()=>t.updateState()))}}class qi extends di{constructor(){super(),this.subPanels=[],this.relX=this.xOut=624,this.xIn=735,this.relY=this.yOut=this.yIn=9,this.movedIn=!1,this.mainPanel=this.addSubPanel(new Di(4)),this.mainPanel.relX=this.mainPanel.xOut,this.mainPanel.relY=this.mainPanel.yOut,this.mainPanel.movedIn=!1;const e=this.addSubPanel(new _i(this.mainPanel)),t=this.addSubPanel(new Xi(this.mainPanel)),i=this.addSubPanel(new Ni(this.mainPanel));this.selectWallPanel=this.addSubPanel(new ji(this.mainPanel)),this.selectFloorPanel=this.addSubPanel(new Hi(this.mainPanel)),this.selectRubblePanel=this.addSubPanel(new Vi(this.mainPanel));const r=this.addSubPanel(new Wi(this.mainPanel)),n=this.addSubPanel(new Ji(this.mainPanel)),a=this.addSubPanel(new Ki(n));n.trainItem.onClick=()=>n.toggleState((()=>a.toggleState()));const o=this.addSubPanel(new ki(n));n.getToolItem.onClick=()=>n.toggleState((()=>o.toggleState()));const h=this.addSubPanel(new Yi(this.mainPanel)),l=this.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_TeleportMan");l.isDisabled=()=>N.raiders.length>=N.getMaxRaiders()||N.requestedRaiders>=D.VD||!N.hasOneBuildingOf(M.TOOLSTATION,M.TELEPORT_PAD),l.updateState(),y.registerEventListener(s.RAIDER_REQUESTED,(()=>l.updateState())),y.registerEventListener(s.ENTITY_ADDED,(e=>{e.superType!==x.BUILDING&&e.superType!==x.RAIDER||l.updateState()})),y.registerEventListener(s.ENTITY_REMOVED,(e=>{e.superType!==x.BUILDING&&e.superType!==x.RAIDER||l.updateState()})),l.onClick=()=>{N.requestedRaiders++,y.publishEvent(new ce)},l.addChild(new Bi(l));const c=this.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildBuilding");c.isDisabled=()=>!1,c.onClick=()=>this.mainPanel.toggleState((()=>e.toggleState()));const d=this.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildSmallVehicle");d.isDisabled=()=>!1,d.onClick=()=>this.mainPanel.toggleState((()=>t.toggleState()));const u=this.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildLargeVehicle");u.isDisabled=()=>!1,u.onClick=()=>this.mainPanel.toggleState((()=>i.toggleState())),y.registerEventListener(s.SELECTED_SURFACE,(e=>{this.onSelectedSurfaceChange(e.surface)})),y.registerEventListener(s.SURFACE_CHANGED,(e=>{N.selectedSurface===e.surface&&this.onSelectedSurfaceChange(e.surface)})),y.registerEventListener(s.DESELECTED_ENTITY,(()=>this.selectSubPanel(this.mainPanel))),y.registerEventListener(s.SELECTED_BUILDING,(()=>this.selectSubPanel(r))),y.registerEventListener(s.SELECTED_RAIDER,(()=>this.selectSubPanel(n))),y.registerEventListener(s.SELECTED_VEHICLE,(()=>this.selectSubPanel(h)))}reset(){super.reset(),this.relX=this.xOut,this.relY=this.yOut,this.movedIn=!1,this.updatePosition(),this.mainPanel.relX=this.mainPanel.xOut,this.mainPanel.relY=this.mainPanel.yOut,this.mainPanel.movedIn=!1,this.mainPanel.updatePosition()}addSubPanel(e){return this.addChild(e),this.subPanels.push(e),e}selectSubPanel(e){this.subPanels.forEach((t=>t!==e&&t.setMovedIn(!0))),e.setMovedIn(!1)}onSelectedSurfaceChange(e){e.surfaceType.floor?e.hasRubble()?this.selectSubPanel(this.selectRubblePanel):this.selectSubPanel(this.selectFloorPanel):this.selectSubPanel(this.selectWallPanel)}}class zi{constructor(e,t,i){this.textImage=e.createTextImage(t.text,i),this.infoImage=ct.getImageOrNull(t.imageFilename)}}class Zi extends di{constructor(e,t){super(e),this.imgAir=null,this.currentMessage=null,this.messageTimeout=null,this.relX=this.xOut=this.xIn=42,this.relY=this.yOut=this.yIn=409,this.imgAir=ct.getImage("Interface/Airmeter/msgpanel_air_juice.bmp");const i=ct.getDefaultFont(),r=new zi(i,t.textCrystalFound,this.img.width);y.registerEventListener(s.LOCATION_CRYSTAL_FOUND,(()=>this.setMessage(r))),this.msgSpaceToContinue=new zi(i,t.textSpaceToContinue,this.img.width);const n=new zi(i,t.textCavernDiscovered,this.img.width);y.registerEventListener(s.CAVERN_DISCOVERED,(()=>this.setMessage(n)));const a=new zi(i,t.textOreFound,this.img.width);y.registerEventListener(s.ORE_FOUND,(()=>this.setMessage(a))),this.msgAirSupplyLow=new zi(i,t.textAirSupplyLow,this.img.width),this.msgAirSupplyRunningOut=new zi(i,t.textAirSupplyRunningOut,this.img.width),this.msgGameCompleted=new zi(i,t.textGameCompleted,this.img.width),this.msgManTrained=new zi(i,t.textManTrained,this.img.width),y.registerEventListener(s.RAIDER_TRAINED,(()=>this.setMessage(this.msgManTrained))),this.msgUnitUpgraded=new zi(i,t.textUnitUpgraded,this.img.width),y.registerEventListener(s.AIR_LEVEL_CHANGED,(()=>this.notifyRedraw()))}setMessage(e,t=3e3){if(this.messageTimeout=m(this.messageTimeout),this.currentMessage=e,this.notifyRedraw(),t){const e=this;this.messageTimeout=setTimeout((()=>{e.currentMessage=null,e.notifyRedraw()}),t)}}unsetMessage(e){this.currentMessage===e&&(this.currentMessage=null,this.notifyRedraw())}onRedraw(e){var t,i;if(super.onRedraw(e),N.airLevel>0){const t=Math.round(236*Math.min(1,N.airLevel));e.drawImage(this.imgAir,this.x+85,this.y+6,t,8)}const s=null===(t=this.currentMessage)||void 0===t?void 0:t.textImage,r=null===(i=this.currentMessage)||void 0===i?void 0:i.infoImage;if(s){const t=this.x+(this.img.width-s.width-(r?r.width:0))/2;e.drawImage(s,t,this.y+26)}if(r){const t=this.x+this.img.width-r.width;e.drawImage(r,t,this.y+16)}}}class $i{constructor(e){[this.text,this.imageFilename,this.sfxName]=e}}class Qi extends ni{constructor(e){super(),this.textCrystalFound=null,this.textSpaceToContinue=null,this.textCavernDiscovered=null,this.textOreFound=null,this.textAirSupplyLow=null,this.textAirSupplyRunningOut=null,this.textGameCompleted=null,this.textManTrained=null,this.textUnitUpgraded=null,ni.setFromCfg(this,e)}parseValue(e,t){return new $i(t)}}class es extends ni{constructor(e){super(),this.aiPriorityTrain=null,this.aiPriorityGetIn=null,this.aiPriorityCrystal=null,this.aiPriorityOre=null,this.aiPriorityRepair=null,this.aiPriorityClearing=null,this.aiPriorityDestruction=null,this.aiPriorityConstruction=null,this.aiPriorityReinforce=null,this.aiPriorityRecharge=null,ni.setFromCfg(this,e)}parseValue(e,t){return{buttonType:t[0],normalFile:t[1],highlightFile:t[1],pressedFile:t[2],disabledFile:t[3]}}}class ts extends di{constructor(e,t,i,s){super(e),this.prioPositions=[],this.prioByName=new Map,t.panelButtonPriorityListDisable.forEach(((e,t)=>{this.addChild(new ci(this,e)).onClick=()=>{N.priorityList.toggle(t),this.setList(N.priorityList.current)}})),t.panelButtonPriorityListUpOne.forEach(((e,t)=>{this.addChild(new ci(this,e)).onClick=()=>{N.priorityList.upOne(t),this.setList(N.priorityList.current)}})),this.addChild(new ci(this,t.panelButtonPriorityListReset)).onClick=()=>this.resetList(),this.prioPositions=i,this.prioByName.set(Me.aiPriorityTrain,this.addChild(new ci(this,s.aiPriorityTrain))),this.prioByName.set(Me.aiPriorityGetIn,this.addChild(new ci(this,s.aiPriorityGetIn))),this.prioByName.set(Me.aiPriorityCrystal,this.addChild(new ci(this,s.aiPriorityCrystal))),this.prioByName.set(Me.aiPriorityOre,this.addChild(new ci(this,s.aiPriorityOre))),this.prioByName.set(Me.aiPriorityRepair,this.addChild(new ci(this,s.aiPriorityRepair))),this.prioByName.set(Me.aiPriorityClearing,this.addChild(new ci(this,s.aiPriorityClearing))),this.prioByName.set(Me.aiPriorityDestruction,this.addChild(new ci(this,s.aiPriorityDestruction))),this.prioByName.set(Me.aiPriorityConstruction,this.addChild(new ci(this,s.aiPriorityConstruction))),this.prioByName.set(Me.aiPriorityReinforce,this.addChild(new ci(this,s.aiPriorityReinforce))),this.prioByName.set(Me.aiPriorityRecharge,this.addChild(new ci(this,s.aiPriorityRecharge)))}reset(){super.reset(),this.resetList()}resetList(){N.priorityList.reset(),this.setList(N.priorityList.current)}setList(e){this.prioByName.forEach((e=>e.hidden=!0));let t=0,i=!1;e.forEach((e=>{const s=this.prioByName.get(e.key);if(s){i=i||s.hidden||s.disabled!==!e.enabled,s.hidden=!1,s.disabled=!e.enabled,s.relX=this.prioPositions[t].x,s.relY=this.prioPositions[t].y,s.updatePosition();const r=t;s.onClick=()=>{N.priorityList.pushToTop(r),this.setList(N.priorityList.current)},t++}})),i&&this.notifyRedraw()}}class is{constructor(e){[this.x,this.y]=e}}class ss extends ci{constructor(e,t){super(e,t),this.toggleState=!1}checkHover(e,t){if(this.isInactive())return!1;const i=this.isInRect(e,t);let s=this.hover!==i;return this.hover=i,this.pressed=this.pressed&&this.hover||this.toggleState,this.children.forEach((i=>s=i.checkHover(e,t)||s)),s&&this.notifyRedraw(),s}checkClick(e,t){if(this.isInactive())return!1;const i=this.isInRect(e,t)||this.toggleState;let s=this.pressed!==i;return this.pressed=i,this.children.forEach((i=>s=i.checkClick(e,t)||s)),s&&this.notifyRedraw(),s}checkRelease(e,t){if(this.isInactive())return!1;const i=this.isInRect(e,t);let s=i&&this.pressed;return s&&(this.toggleState=!this.toggleState,this.onClick(),this.pressed=s&&this.toggleState,this.hover=i),this.children.forEach((i=>s=i.checkRelease(e,t)||s)),s&&this.notifyRedraw(),s}release(){return!1}}class rs extends di{constructor(e,t){super(e),this.btnCallToArms=this.addChild(new ss(this,t.panelButtonTopPanelCallToArms)),this.btnOptions=this.addChild(new ci(this,t.panelButtonTopPanelOptions)),this.btnPriorities=this.addChild(new ss(this,t.panelButtonTopPanelPriorities))}}class ns extends qt{constructor(){super(),this.rootElement=new li,this.panels=[],this.rootElement.notifyRedraw=()=>this.redraw(),this.onRedraw=e=>{e.clearRect(0,0,e.canvas.width,e.canvas.height),this.rootElement.onRedraw(e)}}reset(){super.reset(),this.panels.forEach((e=>e.reset()))}addPanel(e){return this.rootElement.addChild(e),this.panels.push(e),e}handlePointerEvent(e){const[t,i]=this.toCanvasCoords(e.clientX,e.clientY),[s,r]=this.toScaledCoords(e.clientX,e.clientY),n=this.context&&this.context.getImageData(t,i,1,1).data[3]>0;return n?e.eventEnum===Nt.MOVE?this.rootElement.checkHover(s,r):e.eventEnum===Nt.DOWN?e.button===Bt.MAIN&&this.rootElement.checkClick(s,r):e.eventEnum===Nt.UP&&e.button===Bt.MAIN&&this.rootElement.checkRelease(s,r):e.eventEnum===Nt.MOVE&&this.rootElement.release(),n}handleWheelEvent(e){const[t,i]=this.toCanvasCoords(e.clientX,e.clientY);return!this.context||this.context.getImageData(t,i,1,1).data[3]>0}}class as extends ns{constructor(){super(),this.onOptionsShow=()=>console.log("show options triggered");const e=new Ti(ct.cfg("Panels640x480")),t=new Ii(ct.cfg("Buttons640x480"));this.panelEncyclopedia=this.addPanel(new di(e.panelEncyclopedia)),this.panelInformation=this.addPanel(new Mi(e.panelInformation)),this.panelInfoDock=this.addPanel(new Ri(e.panelInfoDock,t.panelInfoDock,new Li(ct.cfg("InfoMessages")),this.panelInformation)),this.panelCameraControl=this.addPanel(new di(e.panelCameraControl));const i=new es(ct.cfg("PriorityImages")),s=Object.values(ct.cfg("PrioritiesImagePositions")).map((e=>new is(e)));this.panelPriorityList=this.addPanel(new ts(e.panelPriorityList,t.panelPriorityList,s,i)),this.panelTopPanel=this.addPanel(new rs(e.panelTopPanel,t.panelTopPanel)),this.panelMain=this.addPanel(new qi),this.panelCrystalSideBar=this.addPanel(new mi(e.panelCrystalSideBar,t.panelCrystalSideBar)),this.panelMessagesSide=this.addPanel(new di(e.panelMessagesSide)),this.panelMessages=this.addPanel(new Zi(e.panelMessages,new Qi(ct.cfg("TextMessagesWithImages")))),this.panelRadar=this.addPanel(new ui(e.panelRadar,e.panelRadarFill,e.panelRadarOverlay,t.panelRadar)),this.panelTopPanel.btnOptions.onClick=()=>this.onOptionsShow(),this.panelTopPanel.btnPriorities.onClick=()=>{this.panelTopPanel.btnPriorities.toggleState?this.panelMain.setMovedIn(!0,(()=>this.panelPriorityList.setMovedIn(!1))):this.panelPriorityList.setMovedIn(!0,(()=>this.panelMain.setMovedIn(!1)))}}}class os{constructor(e){this.x=0,this.y=0,this.w=0,this.h=0,[this.x,this.y,this.w,this.h]=e}}class hs extends ni{constructor(e){super(),this.image=null,this.titleWindow=null,this.textWindow=null,this.okWindow=null,this.cancelWindow=null,this.contrastOverlay=null,ni.setFromCfg(this,e)}parseValue(e,t){return e.endsWith("window")?new os(t):super.parseValue(e,t)}}class ls extends Ei{constructor(){super([]),this.titleFont=ct.getBitmapFont("Interface/Fonts/MbriefFont2.bmp"),this.title=ct.cfg("Main","MissionBriefingText");const e=new hs(ct.cfg("Dialog"));this.titleWindow=e.titleWindow,this.textFont=ct.getBitmapFont("Interface/Fonts/MbriefFont.bmp"),this.textWindow=e.textWindow,this.nextButtonCfg={buttonType:"Next briefing paragraph",relX:394,relY:214,normalFile:ct.cfg("Main","NextButton640x480")},this.backButtonCfg={buttonType:"Previous briefing paragraph",relX:54,relY:214,normalFile:ct.cfg("Main","BackArrow")}}}class cs extends di{constructor(){super(),this.cfg=null,this.imgTitle=null,this.titleRelX=0,this.titleRelY=0,this.btnNext=null,this.btnBack=null,this.imgBack=null,this.imgParagraph=[],this.paragraph=0,this.cfg=new ls,this.imgTitle=this.cfg.titleFont.createTextImage(this.cfg.title),this.titleRelX=this.cfg.titleWindow.x+(this.cfg.titleWindow.w-this.imgTitle.width)/2,this.titleRelY=this.cfg.titleWindow.y,this.btnNext=this.addChild(new ci(this,this.cfg.nextButtonCfg)),this.btnNext.onClick=()=>this.nextParagraph(),this.btnBack=this.addChild(new ci(this,this.cfg.backButtonCfg)),this.btnBack.onClick=()=>this.prevParagraph(),this.hidden=!0}reset(){super.reset(),this.hidden=!0,this.setParagraph(0)}setup(e,t){this.imgBack=ct.getImageOrNull(t.filename),this.xIn=t.x,this.yIn=t.y,this.width=this.imgBack.width,this.height=this.imgBack.height,this.updatePosition(),this.imgParagraph=e.split("\\a").map((e=>this.cfg.textFont.createTextImage(e,this.cfg.textWindow.w,!1)))}setParagraph(e){if(!(e<0)){if(e>this.imgParagraph.length-1)return this.hide(),void this.notifyRedraw();this.paragraph=e,this.btnNext.hidden=this.paragraph>=this.imgParagraph.length-1,this.btnBack.hidden=this.paragraph<1,this.notifyRedraw()}}nextParagraph(){this.setParagraph(this.paragraph+1)}prevParagraph(){this.setParagraph(this.paragraph-1)}show(){var e;super.show(),this.setParagraph(0),this.btnNext.hidden=this.paragraph>=this.imgParagraph.length-1,this.btnBack.hidden=this.paragraph<1,null===(e=this.messagePanel)||void 0===e||e.setMessage(this.messagePanel.msgSpaceToContinue,0)}hide(){var e;super.hide(),null===(e=this.messagePanel)||void 0===e||e.unsetMessage(this.messagePanel.msgSpaceToContinue)}onRedraw(e){this.hidden||(this.imgBack&&e.drawImage(this.imgBack,this.x,this.y),this.imgTitle&&e.drawImage(this.imgTitle,this.x+this.titleRelX,this.y+this.titleRelY),this.imgParagraph&&this.imgParagraph[this.paragraph]&&e.drawImage(this.imgParagraph[this.paragraph],this.x+this.cfg.textWindow.x,this.y+this.cfg.textWindow.y),super.onRedraw(e))}}class ds extends li{constructor(e,t){super(e),this.labelX=0,this.state=!1,this.relX=t.x,this.relY=t.y,this.labelX=t.width,this.imgTextNormal=e.loFont.createTextImage(t.description),this.imgTextHover=e.hiFont.createTextImage(t.description),this.imgLabelOffNormal=e.loFont.createTextImage(t.labelOff),this.imgLabelOffHover=e.hiFont.createTextImage(t.labelOff),this.imgLabelOnNormal=e.loFont.createTextImage(t.labelOn),this.imgLabelOnHover=e.hiFont.createTextImage(t.labelOn),this.width=t.width+Math.max(this.imgLabelOnHover.width,this.imgLabelOffHover.width),this.height=this.imgTextNormal.height}onClick(){this.state=!this.state,console.log("TODO: cycle item clicked; state: "+this.state)}checkHover(e,t){const i=super.checkHover(e,t);return i&&this.notifyRedraw(),i}checkClick(e,t){const i=super.checkClick(e,t);return i&&this.notifyRedraw(),i}checkRelease(e,t){const i=super.checkRelease(e,t);return i&&this.notifyRedraw(),i}release(){const e=super.release();return e&&this.notifyRedraw(),e}onRedraw(e){if(this.hidden)return;let t=this.imgTextNormal,i=this.state?this.imgLabelOnNormal:this.imgLabelOffNormal;this.hover&&(t=this.imgTextHover,i=this.state?this.imgLabelOnHover:this.imgLabelOffHover),e.drawImage(t,this.x,this.y),e.drawImage(i,this.x+this.labelX,this.y),super.onRedraw(e)}}class us extends li{constructor(e,t,i){super(e),this.target=t.target,this.loImg=e.loFont.createTextImage(t.label),this.hiImg=e.hiFont.createTextImage(t.label),this.width=this.loImg.width,this.height=this.loImg.height,this.relX=i?-e.relX+(e.menuImage.width-this.width)/2:t.x,this.relY=t.y}checkHover(e,t){const i=super.checkHover(e,t);return i&&this.notifyRedraw(),i}checkClick(e,t){const i=super.checkClick(e,t);return i&&this.notifyRedraw(),i}checkRelease(e,t){const i=super.checkRelease(e,t);return i&&this.notifyRedraw(),i}release(){const e=super.release();return e&&this.notifyRedraw(),e}onRedraw(e){this.hidden||(this.hover?e.drawImage(this.hiImg,this.x,this.y):e.drawImage(this.loImg,this.x,this.y),super.onRedraw(e))}}class gs extends li{constructor(e,t){super(e),this.sliderX=0,this.min=0,this.max=1,this.value=0,this.onValueChanged=e=>console.log("value changed to: "+e),this.relX=t.x,this.relY=t.y,this.sliderX=t.width,this.imgLeft=ct.getImage(t.imgLeft),this.imgNormal=ct.getImage(t.imgOff),this.imgHover=ct.getImage(t.imgOn),this.imgRight=ct.getImage(t.imgRight);const i=this.addChild(new ci(this,new ai));i.imgNormal=ct.getImage(t.btnLeftNormal),i.imgHover=ct.getImage(t.btnLeftHover),i.relX=this.sliderX-this.imgLeft.width-i.imgHover.width,i.width=i.imgHover.width,i.height=i.imgHover.height,i.updatePosition(),i.onClick=()=>{this.value>this.min&&(this.value--,this.onValueChanged(this.value))};const s=this.addChild(new ci(this,new ai));s.imgNormal=ct.getImage(t.btnRightNormal),s.imgHover=ct.getImage(t.btnRightHover),s.relX=this.sliderX+this.imgNormal.width+2*this.imgRight.width,s.width=s.imgHover.width,s.height=s.imgHover.height,s.updatePosition(),s.onClick=()=>{this.value<this.max&&(this.value++,this.onValueChanged(this.value))},this.width=t.width+i.imgHover.width+this.imgLeft.width+this.imgNormal.width+2*this.imgRight.width+s.imgHover.width,this.min=t.min,this.max=t.max||1,this.value=this.min,this.imgTextNormal=e.loFont.createTextImage(t.description),this.imgTextHover=e.hiFont.createTextImage(t.description),this.height=this.imgTextNormal.height}checkHover(e,t){const i=super.checkHover(e,t);return i&&this.notifyRedraw(),i}onRedraw(e){if(this.hidden)return;let t=this.imgTextNormal;this.hover&&(t=this.imgTextHover),e.drawImage(t,this.x,this.y);let i=this.x+this.sliderX;e.drawImage(this.imgLeft,i,this.y),e.drawImage(this.imgNormal,i,this.y);const s=Math.round(this.value/this.max*this.imgHover.width);e.drawImage(this.imgHover,0,0,s,this.imgHover.height,i,this.y,s,this.imgHover.height),i+=this.imgNormal.width,e.drawImage(this.imgRight,i,this.y),super.onRedraw(e)}}class ps extends li{constructor(e,t){super(e),this.itemsTrigger=[],this.itemsNext=[],this.relX=t.position[0],this.relY=t.position[1],this.menuImage=ct.getImageOrNull(t.menuImage[0]),this.titleImage=ct.getBitmapFont(t.menuFont).createTextImage(t.fullName),this.loFont=ct.getBitmapFont(t.loFont),this.hiFont=ct.getBitmapFont(t.hiFont),t.itemsLabel.forEach((e=>{const i=this.addChild(new us(this,e,t.autoCenter));"trigger"===e.actionName.toLowerCase()?this.itemsTrigger.push(i):this.itemsNext.push(i)})),t.itemsCycle.forEach((e=>this.addChild(new ds(this,e)))),t.itemsSlider.forEach((e=>this.addChild(new gs(this,e)))),this.hidden=!0}reset(){super.reset(),this.hidden=!0}onRedraw(e){this.hidden||(e.drawImage(this.menuImage,(this.parent.width-this.menuImage.width)/2,(this.parent.height-this.menuImage.height)/2),e.drawImage(this.titleImage,(this.parent.width-this.titleImage.width)/2,this.y),super.onRedraw(e))}}class ms extends di{constructor(e,t){super(),this.layersByKey=new Map,this.width=e.fixedWidth,this.height=e.fixedHeight,this.hidden=!0,t.menus.forEach(((e,t)=>this.layersByKey.set("menu"+(t+1),this.addChild(new ps(this,e)))));const i=this;this.layersByKey.forEach((e=>e.itemsNext.forEach((e=>e.onClick=()=>i.selectLayer(e.target)))))}reset(){super.reset(),this.hidden=!0}show(){this.hidden=!1,this.selectLayer("menu1")}hide(){super.hide(),this.notifyRedraw()}selectLayer(e){const t=this.layersByKey.get(e.toLowerCase());this.layersByKey.forEach((e=>e!==t&&e.hide())),t.show(),this.notifyRedraw()}}class fs extends ms{constructor(e,t){super(e,t),this.onRepeatBriefing=()=>console.log("repeat mission briefing");const i=this;this.layersByKey.get("menu1").itemsTrigger[0].onClick=()=>i.onRepeatBriefing(),this.layersByKey.get("menu1").itemsTrigger[1].onClick=()=>i.hide()}}class ys extends ms{constructor(e,t){super(e,t),this.onRepeatBriefing=()=>console.log("repeat mission briefing"),this.onAbortGame=()=>console.log("abort mission"),this.onRestartGame=()=>console.log("restart mission");const i=this;this.layersByKey.get("menu1").itemsTrigger[0].onClick=()=>i.hide(),this.layersByKey.get("menu2").itemsTrigger[0].onClick=()=>i.onRepeatBriefing(),this.layersByKey.get("menu3").itemsTrigger[0].onClick=()=>i.onAbortGame(),this.layersByKey.get("menu4").itemsTrigger[0].onClick=()=>i.onRestartGame()}}class ws extends ns{constructor(){super(),this.panelPause=this.addPanel(new ys(this,ct.getResource("PausedMenu"))),this.panelOptions=this.addPanel(new fs(this,ct.getResource("OptionsMenu"))),this.panelBriefing=this.addPanel(new cs),this.panelPause.onRepeatBriefing=()=>this.setActivePanel(this.panelBriefing),this.panelOptions.onRepeatBriefing=()=>this.setActivePanel(this.panelBriefing)}reset(){super.reset(),D.Sl||this.setActivePanel(this.panelBriefing)}setup(e,t){this.panelBriefing.setup(e,t)}handlePointerEvent(e){return!this.panels.every((e=>e.hidden))&&(super.handlePointerEvent(e)||!0)}handleKeyEvent(e){let t=!1;const i=e.key.toLowerCase();return e.eventEnum===Ft.UP&&("escape"===i?this.panelBriefing.hidden&&this.panelOptions.hidden&&(this.panelPause.hidden?this.setActivePanel(this.panelPause):this.panelPause.hide(),t=!0):" "===i&&(this.panelBriefing.hidden||(this.panelBriefing.nextParagraph(),t=!0))),t}setActivePanel(e){y.publishEvent(new L(K.Pointer_Standard)),this.panels.forEach((t=>t!==e&&t.hide())),e.show(),this.redraw()}}class vs extends Kt{constructor(){super(!0),this.selectStart=null}reset(){super.reset(),this.selectStart=null}handlePointerEvent(e){if(N.buildModeSelection)return;const[t,i]=this.toCanvasCoords(e.clientX,e.clientY);if(e.eventEnum===Nt.DOWN){if(e.button===Bt.MAIN)return this.startSelection(t,i)}else{if(e.eventEnum===Nt.MOVE)return this.changeSelection(t,i);if(e.eventEnum===Nt.UP&&e.button===Bt.MAIN)return this.selectEntities(t,i)}return!1}startSelection(e,t){return this.selectStart={x:e,y:t},!0}changeSelection(e,t){return!!this.selectStart&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="rgba(128, 192, 192, 0.5)",this.context.lineWidth=2,this.context.strokeRect(this.selectStart.x,this.selectStart.y,e-this.selectStart.x,t-this.selectStart.y),!0)}selectEntities(e,t){if(!this.selectStart)return!1;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.selectStart.x/this.canvas.width*2-1,s=-this.selectStart.y/this.canvas.height*2+1,r=e/this.canvas.width*2-1,n=-t/this.canvas.height*2+1;if(Math.abs(e-this.selectStart.x)<5&&Math.abs(t-this.selectStart.y)<5){const i=(this.selectStart.x+e)/this.canvas.width-1,s=-(this.selectStart.y+t)/this.canvas.height+1;this.sceneMgr.selectEntitiesByRay(i,s)}else this.sceneMgr.selectEntitiesInFrustum(i,s,r,n);return this.selectStart=null,!0}}var bs=F.M8C.degToRad;class Is extends ti{constructor(){super(),this.onLevelEnd=()=>console.log("Level aborted"),this.spawnRaiderInterval=null,this.gameLayer=this.addLayer(new ri,0),this.selectionLayer=this.addLayer(new vs,10),this.guiLayer=this.addLayer(new as,20),this.overlayLayer=this.addLayer(new ws,30),this.worldMgr=new Xt,this.gameLayer.worldMgr=this.worldMgr,this.sceneMgr=new nt(this.gameLayer.canvas),this.gameLayer.sceneMgr=this.sceneMgr,this.selectionLayer.sceneMgr=this.sceneMgr,this.jobSupervisor=new Vt(this.worldMgr),this.guiLayer.onOptionsShow=()=>this.overlayLayer.panelOptions.show(),this.overlayLayer.panelBriefing.messagePanel=this.guiLayer.panelMessages,this.overlayLayer.panelPause.onAbortGame=()=>this.onLevelEnd(),this.overlayLayer.panelPause.onRestartGame=()=>this.restartLevel(),y.registerEventListener(s.RAIDER_REQUESTED,(()=>{N.requestedRaiders>0&&!this.spawnRaiderInterval&&(this.spawnRaiderInterval=setInterval(this.checkSpawnRaiders.bind(this),D.IL))}))}startLevel(e){if(this.levelName=e,this.levelConf=ct.getResource("Levels").levelsByName[this.levelName],!this.levelConf)throw'Could not find level configuration for "'+this.levelName+'"';this.setupAndStartLevel()}restartLevel(){this.hide(),N.reset(),this.setupAndStartLevel()}setupAndStartLevel(){console.log("Starting level "+this.levelName+" - "+this.levelConf.fullName),this.worldMgr.setup(this.levelConf,(()=>this.onLevelEnd())),this.sceneMgr.setupScene(this.levelConf,this.worldMgr);const e=ct.getResource(this.levelConf.oListFile);(class{static loadObjectList(e,t,i,s){Object.values(i).forEach((i=>{const r=i.type?i.type.toLowerCase():i.type,n=new F.FM8(i.xPos,i.yPos).addScalar(-1).multiplyScalar(D.pM),a=ct.cfg("BuildingTypes",i.type),o=Ut(i.heading);if(r==="TVCamera".toLowerCase()){const e=t.getTerrainHeight(n.x,n.y),i=new F.Pa4(n.x,e,n.y-D.pM/2),s=new F.Pa4(5*D.pM,0,0).applyAxisAngle(new F.Pa4(0,1,0),o-Math.PI/16).add(i);t.camera.position.copy(s),t.camera.position.y=4.5*D.pM,t.controls.target.copy(i),t.controls.update(),t.setTorchPosition(new F.FM8(n.x,n.y-D.pM/2))}else if(r==="Pilot".toLowerCase()){const i=new ft(e,t);i.changeActivity(),i.createPickSphere(),i.addToScene(n,o-Math.PI/2),i.group.visible?(N.raiders.push(i),y.publishEvent(new ue(i))):N.raidersUndiscovered.push(i)}else if(a)this.createBuildingByName(a,e,t).placeDown(n,-o-Math.PI,s);else if(r==="PowerCrystal".toLowerCase())e.placeMaterial(new Xe(e,t),n);else if(r==="SmallSpider".toLowerCase()){const i=new kt(e,t);i.changeActivity(),i.addToScene(n,o),N.spiders.push(i),i.surfaces.forEach((e=>N.spidersBySurface.getOrUpdate(e,(()=>[])).push(i))),i.startMoving()}else if(r==="Bat".toLowerCase()){const i=new _t(e,t);i.changeActivity(),i.addToScene(n,o),N.bats.push(i),i.startRandomMove()}else console.warn("Object type "+i.type+" not yet implemented")})),N.buildings.forEach((e=>e.surfaces.forEach((e=>e.neighbors.forEach((e=>e.updateTexture()))))))}static createBuildingByName(e,t,i){const s=e.slice(e.lastIndexOf("/")+1).toLowerCase();if("toolstation"===s)return new xt(t,i);if("teleports"===s)return new Mt(t,i);if("docks"===s)return new Tt(t,i);if("powerstation"===s)return new Pt(t,i);if("barracks"===s)return new Et(t,i);if("upgrade"===s)return new At(t,i);if("geo-dome"===s)return new St(t,i);if("orerefinery"===s)return new Rt(t,i);if("gunstation"===s)return new Ct(t,i);if("teleportbig"===s)return new Lt(t,i);throw"Unknown building type: "+s}}).loadObjectList(this.worldMgr,this.sceneMgr,e,this.levelConf.disableStartTeleport);const t=l(ct.getResource(this.levelConf.objectiveText),this.levelName);this.guiLayer.reset(),this.overlayLayer.setup(t.objective,this.levelConf.objectiveImage640x480),this.show()}show(){super.show(),this.sceneMgr.startScene(),this.worldMgr.start(),this.jobSupervisor.start()}hide(){this.spawnRaiderInterval=f(this.spawnRaiderInterval),this.jobSupervisor.stop(),this.worldMgr.stop(),this.sceneMgr.disposeScene(),super.hide()}resize(e,t){var i;super.resize(e,t),null===(i=this.sceneMgr)||void 0===i||i.resize(e,t)}checkSpawnRaiders(){if(N.requestedRaiders<1)return void(this.spawnRaiderInterval=f(this.spawnRaiderInterval));if(N.raiders.length>=N.getMaxRaiders())return;const e=N.getBuildingsByType(M.TOOLSTATION,M.TELEPORT_PAD);for(let t=0;t<e.length&&N.requestedRaiders>0;t++){const i=e[t];if(i.spawning)continue;N.requestedRaiders--,y.publishEvent(new ce),i.spawning=!0;const s=new ft(this.worldMgr,this.sceneMgr),r=i.getHeading();s.changeActivity(Je.TeleportIn,(()=>{i.spawning=!1,s.changeActivity(),s.createPickSphere();const e=i.getPosition2D().add(new F.FM8(0,3*D.pM/4+g(D.pM/2)).rotateAround(new F.FM8(0,0),r+bs(-10+g(20))));s.setJob(new dt(e)),N.raiders.push(s),y.publishEvent(new ue(s))})),s.addToScene(i.primarySurface.getCenterWorld2D(),r)}}}class Es{constructor(){this.x=0,this.y=0,this.width=0,this.height=0,this.zIndex=100,this.scrollAffected=!1,this.needsRedraw=!1,this.hover=!1,this.pressed=!1,this.actionName="",this.targetIndex=0}static compareZ(e,t){return e.zIndex===t.zIndex?0:e.zIndex>t.zIndex?-1:1}checkHover(e,t){const i=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height;return this.hover!==i&&(this.hover=i,this.needsRedraw=!0,this.onHoverChange()),this.hover||(this.pressed=!1),this.hover}onHoverChange(){}checkSetPressed(){this.hover&&(this.pressed||(this.needsRedraw=!0),this.pressed=!0)}setReleased(){this.pressed&&(this.needsRedraw=!0),this.pressed=!1}draw(e){this.needsRedraw=!1}}class Ts extends Es{constructor(e,t){super(),this.imgNormal=null,this.imgHover=null,this.imgPressed=null,this.tooltip="",this.imgNormal=ct.getImage(t.imgNormal),this.imgHover=ct.getImage(t.imgHover),this.imgPressed=ct.getImage(t.imgPressed),this.tooltip=(t.tooltip||"").replace(/_/g," "),this.width=Math.max(this.imgNormal.width,this.imgHover.width,this.imgPressed.width),this.height=Math.max(this.imgNormal.height,this.imgHover.height,this.imgPressed.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);let t=this.imgNormal;this.hover&&(t=this.imgHover),this.pressed&&(t=this.imgPressed),e.drawImage(t,this.x,this.y)}}class Ss extends Es{constructor(e,t){super(),this.labelImgLo=null,this.labelImgHi=null,this.labelImgLo=e.loFont.createTextImage(t.label),this.labelImgHi=e.hiFont.createTextImage(t.label),this.width=Math.max(this.labelImgLo.width,this.labelImgHi.width),this.height=Math.max(this.labelImgLo.height,this.labelImgHi.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);const t=this.hover&&!this.pressed?this.labelImgHi:this.labelImgLo;e.drawImage(t,this.x,this.y)}}class Cs extends qt{constructor(e,t){super(),this.items=[],this.scrollY=0,this.scrollSpeedY=0,this.scrollInterval=null,this.screen=e,this.cfg=t,this.loFont=t.loFont?ct.getBitmapFont(t.loFont):null,this.hiFont=t.hiFont?ct.getBitmapFont(t.hiFont):null,this.menuImage=t.menuImage?ct.getImage(t.menuImage):null,this.titleImage=this.loFont.createTextImage(t.fullName),t.itemsLabel.forEach((e=>{e.label?this.items.push(new Ss(this,e)):this.items.push(new Ts(this,e))})),this.items.sort(((e,t)=>Es.compareZ(e,t))),this.onRedraw=e=>{e.drawImage(this.menuImage,0,-this.scrollY),t.displayTitle&&e.drawImage(this.titleImage,(this.fixedWidth-this.titleImage.width)/2,this.cfg.position[1]),this.items.forEach(((t,i)=>this.items[this.items.length-1-i].draw(e)))}}reset(){super.reset(),this.scrollY=0,this.scrollSpeedY=0}show(){super.show();const e=this;this.scrollInterval=setInterval((()=>{0!==e.scrollSpeedY&&e.setScrollY(e.scrollSpeedY)}),1e3/D.OK)}hide(){this.scrollInterval=f(this.scrollInterval),super.hide()}handlePointerEvent(e){if(e.eventEnum===Nt.MOVE){const[t,i]=this.toScaledCoords(e.clientX,e.clientY);let s=!1;if(this.items.forEach((e=>{if(s)e.hover&&(e.needsRedraw=!0),e.hover=!1,e.setReleased();else{const r=i+(e.scrollAffected?this.scrollY:0);s=e.checkHover(t,r)}})),this.cfg.canScroll){const e=100;i<e?this.setScrollSpeedY(-(e-i)):i>this.fixedHeight-e?this.setScrollSpeedY(i-(this.fixedHeight-e)):this.setScrollSpeedY(0)}}else e.eventEnum===Nt.DOWN?e.button===Bt.MAIN&&this.items.forEach((e=>e.checkSetPressed())):e.eventEnum===Nt.UP&&e.button===Bt.MAIN&&this.items.forEach((e=>{e.pressed&&(e.setReleased(),"next"===e.actionName.toLowerCase()?this.screen.showMainMenu(e.targetIndex):"selectlevel"===e.actionName.toLowerCase()?this.screen.selectLevel(e.levelKey):e.actionName&&console.warn("not implemented: "+e.actionName+" - "+e.targetIndex))}));return this.needsRedraw()&&this.redraw(),!1}setScrollSpeedY(e){this.scrollSpeedY=Math.sign(e)*Math.pow(Math.round(e/20),2)}handleWheelEvent(e){return!!this.cfg.canScroll&&(this.setScrollY(e.deltaY),!0)}setScrollY(e){const t=this.scrollY;this.scrollY=Math.min(Math.max(this.scrollY+e,0),this.menuImage.height-this.fixedHeight),t!==this.scrollY&&this.redraw()}needsRedraw(){return this.items.some((e=>e.needsRedraw))}}class Rs extends Es{constructor(e,t,i){super(),this.imgActive=null,this.imgInactive=null,this.imgCross=null,this.unlocked=!1,this.levelKey="",this.layer=e,this.actionName="selectlevel",this.levelKey=t,this.x=i.frontEndX,this.y=i.frontEndY,this.zIndex=10,this.scrollAffected=!0;const[s,r,n]=i.menuBMP;this.imgActive=ct.getImage(s),this.imgInactive=ct.getImage(r),this.imgCross=ct.getImage(n),this.width=Math.max(this.imgActive.width,this.imgInactive.width,this.imgCross.width),this.height=Math.max(this.imgActive.height,this.imgInactive.height,this.imgCross.height),this.unlocked=i.frontEndOpen,this.unlocked=!0}draw(e){super.draw(e);let t=this.imgCross;this.unlocked&&(t=this.hover?this.imgActive:this.imgInactive),e.drawImage(t,this.x,this.y-this.layer.scrollY)}}class Ps extends Es{constructor(e,t){super(),this.zIndex=50,this.context=U(e.width,e.height),this.context.putImageData(e,0,0),this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}checkHover(e,t){const i=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height&&this.context.getImageData(e,t,1,1).data[3]>0;return this.hover!==i&&(this.needsRedraw=!0),this.hover=i,this.hover}draw(e){super.draw(e),e.drawImage(this.context.canvas,this.x,this.y,this.width,this.height)}}class Ls extends Es{constructor(e,t){super(),this.imgFirstLine=null,this.imgSecondLine=null,this.font=e,this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}setFirstLine(e){this.imgFirstLine=e?this.font.createTextImage(e):null}setSecondLine(e){this.imgSecondLine=e?this.font.createTextImage(e):null}draw(e){super.draw(e);const t=this.x+this.width/2,i=this.y+this.height/2;this.imgFirstLine&&e.drawImage(this.imgFirstLine,t-this.imgFirstLine.width/2,i-this.imgFirstLine.height),this.imgSecondLine&&e.drawImage(this.imgSecondLine,t-this.imgSecondLine.width/2,i)}}class Ms extends Cs{constructor(e,t,i){super(e,t);const s=ct.getResource("Levels"),r=new xs;this.items.push(new Ps(r.panelImgData,r.panelPos));const n=new Ls(ct.getDefaultFont(),r.window);n.setFirstLine(i?r.level:r.tutorial),this.items.push(n),Object.keys(s.levelsByName).forEach((e=>{const t=s.levelsByName[e],i=new Rs(this,e,t);i.onHoverChange=()=>n.setSecondLine(i.hover?t.fullName:""),this.items.push(i)})),this.items.sort(((e,t)=>Es.compareZ(e,t)))}}class xs{constructor(){this.window={x:0,y:0,w:0,h:0},this.panelPos={x:0,y:0,w:0,h:0},this.level="",this.tutorial="";const e=ct.cfg("Menu","LevelText"),t=l(e,"Window");this.window={x:t[0],y:t[1],w:t[2],h:t[3]};const i=l(e,"Panel");this.panelImgData=ct.getImageData(i[0]),this.panelPos={x:i[1],y:i[2],w:i[3],h:i[4]},this.level=l(e,"Level").join(",").replace(/_/g," "),this.tutorial=l(e,"Tutorial").join(",").replace(/_/g," ")}}class As extends ti{constructor(){super(),this.onLevelSelected=null,this.menus=[],ct.getResource("MainMenuFull").menus.forEach((e=>{let t;t="Levels"===e.title?new Ms(this,e,!0):"Tutorials"===e.title?new Ms(this,e,!1):new Cs(this,e),this.menus.push(t),this.addLayer(t)}))}showMainMenu(e=0){this.hide(),this.menus[e].show(),this.cursorLayer.show()}showLevelSelection(){this.showMainMenu(1)}selectLevel(e){this.hide(),this.onLevelSelected(e)}}class Os extends Es{constructor(e){let t,i,s,r;super(),this.disabled=!1,this.visible=!0,[t,i,s,r,this.x,this.y]=e,this.imgNormal=ct.getImage(t),this.imgHover=ct.getImage(i),this.imgPressed=ct.getImage(s),this.imgDisabled=ct.getImage(r),this.width=this.imgNormal.width,this.height=this.imgNormal.height}draw(e){if(super.draw(e),!this.visible)return;let t=this.imgNormal;this.disabled?t=this.imgDisabled:this.pressed?t=this.imgPressed:this.hover&&(t=this.imgHover),e.drawImage(t,this.x,this.y)}}class Ds extends ti{constructor(){super(),this.cfg=null,this.resultIndex=0,this.resultLastIndex=0,this.images=[],this.boxes=[],this.fonts={},this.texts=[],this.uncoverTimeout=null,this.cfg=ct.getResource("Reward"),this.titleFont=ct.getBitmapFont(this.cfg.titleFont);const e=ct.getImage(this.cfg.wallpaper);this.addLayer(new qt).onRedraw=t=>t.drawImage(e,0,0),this.cfg.images.forEach((e=>{this.images.push({img:ct.getImage(e.filePath),x:e.x,y:e.y})})),this.cfg.boxImages.forEach((e=>{this.boxes.push({img:ct.getImage(e.filePath),x:e.x,y:e.y})})),Object.keys(this.cfg.fonts).forEach(((e,t)=>{const i=ct.getBitmapFont(this.cfg.fonts[e]);this.fonts[e.toLowerCase()]=i;const s=this.cfg.texts[t],r=t<9?i:ct.getBitmapFont(this.cfg.backFont);this.texts.push(r.createTextImage(s.text))})),this.resultsLayer=this.addLayer(new qt),this.resultsLayer.handlePointerEvent=e=>e.eventEnum===Nt.UP&&(this.uncoverTimeout=m(this.uncoverTimeout),this.uncoverTimeout=null,this.resultIndex=this.resultLastIndex,this.btnSave.visible=!0,this.btnAdvance.visible=!0,this.redraw(),!0),this.descriptionTextLayer=this.addLayer(new qt,20),this.btnLayer=this.addLayer(new qt,50),this.btnSave=new Os(this.cfg.saveButton),this.btnSave.disabled=!0,this.btnAdvance=new Os(this.cfg.advanceButton),this.btnLayer.handlePointerEvent=e=>{if(e.eventEnum===Nt.MOVE){const[t,i]=this.btnLayer.toScaledCoords(e.clientX,e.clientY);this.btnSave.checkHover(t,i),this.btnAdvance.checkHover(t,i)}else e.eventEnum===Nt.DOWN?e.button===Bt.MAIN&&(this.btnSave.checkSetPressed(),this.btnAdvance.checkSetPressed()):e.eventEnum===Nt.UP&&e.button===Bt.MAIN&&(this.btnSave.pressed?this.btnSave.setReleased():this.btnAdvance.pressed&&(this.btnAdvance.setReleased(),this.hide(),this.onAdvance()));return(this.btnSave.needsRedraw||this.btnAdvance.needsRedraw)&&this.redraw(),!1},this.btnLayer.onRedraw=e=>{this.btnSave.draw(e),this.btnAdvance.draw(e)}}show(){this.resultIndex=0,this.btnSave.visible=!1,this.btnAdvance.visible=!1,this.uncoverResult();const e=this.titleFont.createTextImage(N.levelFullName);let t=this.cfg.quitText;this.resultLastIndex=this.images.length-2,N.resultState===O.COMPLETE?(t=this.cfg.completeText,this.resultLastIndex=this.images.length-1):N.resultState===O.FAILED&&(t=this.cfg.failedText);const i=[];i.push(this.fonts.crystals.createTextImage(this.percentString(N.numCrystal,N.neededCrystals))),i.push(this.fonts.ore.createTextImage(this.percentString(N.numOre,N.totalOres))),i.push(this.fonts.diggable.createTextImage(this.percentString(N.remainingDiggables,N.totalDiggables,!0))),i.push(this.fonts.constructions.createTextImage(N.buildings.length.toString())),i.push(this.fonts.caverns.createTextImage(this.percentString(N.discoveredCaverns,N.totalCaverns))),i.push(this.fonts.figures.createTextImage(this.percentString(N.raiders.length,N.getMaxRaiders()))),i.push(this.fonts.rockmonsters.createTextImage(this.percentString(0))),i.push(this.fonts.oxygen.createTextImage(this.percentString(N.airLevel))),i.push(this.fonts.timer.createTextImage(this.timeString(N.gameTimeSeconds))),i.push(this.fonts.score.createTextImage(this.percentString(N.score)));const s=this.titleFont.createTextImage(t);this.resultsLayer.onRedraw=t=>{t.clearRect(0,0,this.resultsLayer.fixedWidth,this.resultsLayer.fixedHeight);for(let e=0;e<=this.resultIndex;e++){const i=this.images[e];i&&t.drawImage(i.img,i.x,i.y)}for(let e=0;e<=this.resultIndex;e++){const i=this.boxes[e];i&&t.drawImage(i.img,i.x,i.y)}for(let e=0;e<=this.resultIndex;e++){const s=this.cfg.texts[e],r=i[e];r&&t.drawImage(r,s.x-r.width/2,s.y)}t.drawImage(e,this.resultsLayer.fixedWidth/2-e.width/2,this.cfg.vertSpacing-e.height/2),t.drawImage(s,this.resultsLayer.fixedWidth/2-s.width/2,this.cfg.vertSpacing+e.height/2)},this.descriptionTextLayer.onRedraw=e=>{const t=this.texts[this.resultIndex];e.clearRect(0,this.cfg.textPos[1],this.descriptionTextLayer.fixedWidth,this.descriptionTextLayer.fixedHeight-this.cfg.textPos[1]);const i=this.resultIndex!==this.images.length-1?this.cfg.textPos[0]:305,s=this.resultIndex!==this.images.length-1?this.cfg.textPos[1]:195;e.drawImage(t,i-t.width/2,s)},super.show()}percentString(e,t=1,i=!1){0===t&&(t=1);let s=Math.round(100*Math.max(Math.min(e/t,1),0));return i&&(s=100-s),s.toString()+"%"}padLeft(e,t="0",i=2){for(;e.length<i;)e=t+e;return e}timeString(e){const t=this.padLeft((e%60).toString()),i=Math.floor(e/60),s=this.padLeft((i%60).toString());return this.padLeft(Math.floor(i/60).toString())+":"+s+":"+t}uncoverResult(){this.uncoverTimeout=setTimeout((()=>{this.uncoverTimeout=null,this.resultIndex++,this.resultIndex<this.resultLastIndex?this.uncoverResult():(this.btnSave.visible=!0,this.btnAdvance.visible=!0),this.redraw()}),1e3*this.cfg.timer)}}D.Sl&&console.warn("DEV MODE ACTIVE");const _s=new class extends ti{constructor(){super(),this.assetIndex=0,this.layer=this.addLayer(new qt)}show(){this.layers.forEach((e=>{e!==this.cursorLayer&&e.show()})),this.setLoadingMessage("Loading...")}setLoadingMessage(e){this.layer.onRedraw=t=>{t.fillStyle="black",t.fillRect(0,0,this.layer.fixedWidth,this.layer.fixedHeight),t.font="24px Arial",t.fillStyle="white",t.fillText("Loading Rock Raiders",20,this.layer.fixedHeight-50),t.font="18px Arial",t.fillStyle="white",t.fillText(e,20,this.layer.fixedHeight-20)},this.redraw()}enableGraphicMode(e){const t=ct.getImage(ct.cfg("Main","LoadScreen")),i=ct.getImage(ct.cfg("Main","ProgressBar")),s=ct.getDefaultFont().createTextImage(ct.cfg("Main","LoadingText"));this.layer.onRedraw=r=>{r.drawImage(t,0,0);const n=353*(this.assetIndex<e?Math.round(this.assetIndex/e):1);r.drawImage(i,142,450,n,9),r.drawImage(s,Math.round(320-s.width/2),Math.round(456-s.height/2))},this.cursorLayer.show(),this.redraw()}increaseLoadingState(){this.assetIndex++,this.redraw()}},ks=new o.WadFileSelectionModal("game-container"),Bs=new a.GithubBox("game-container"),Ns=new n.ClearCacheButton("game-container");ks.onStart=(e,t)=>{ct.startLoadingFromUrl(e,t)},ct.onMessage=e=>{_s.setLoadingMessage(e)},ct.onCacheMissed=()=>{ks.show()},ct.onInitialLoad=e=>{ks.hide(),_s.enableGraphicMode(e)},ct.onAssetLoaded=()=>{_s.increaseLoadingState()},ct.onLoadDone=()=>{const e=new As,t=new Is,i=new Ds;e.onLevelSelected=i=>{try{t.startLevel(i)}catch(s){console.error("Could not load level: "+i,s),t.hide(),e.showLevelSelection()}},t.onLevelEnd=()=>{t.hide(),i.show()},i.onAdvance=()=>{N.reset(),e.showLevelSelection()},_s.hide(),Bs.hide(),Ns.hide();const s=new URLSearchParams(window.location.search),r=s.get("entry");D.Sl&&r?(N.numOre=Number(s.get("numOre"))||0,N.numCrystal=Number(s.get("numCrystal"))||0,"level"===r?e.showLevelSelection():"reward"===r?i.show():"random"===r?e.selectLevel("Level"+("00"+u(1,25)).substr(-2)):r&&e.selectLevel(r)):e.showMainMenu()},_s.show(),ct.startLoadingFromCache()},848:(e,t,i)=>{"use strict";i.d(t,{Sl:()=>s,UV:()=>r,$I:()=>n,Cw:()=>a,Ob:()=>o,IL:()=>h,d:()=>l,VD:()=>c,oq:()=>d,SO:()=>u,CM:()=>g,ED:()=>p,a4:()=>m,Du:()=>f,DG:()=>y,pM:()=>w,OK:()=>v});const s=!1,r="RockRaidersWeb",n=1e3,a=5e3,o=5,h=1e3,l=12,c=9,d=10,u=5e3,g=3,p=.1,m=5,f=640,y=480,w=40,v=30},351:(e,t,i)=>{"use strict";e.exports=i.p+"266ca63177bca6f330a7.png"}}]);
//# sourceMappingURL=617.index.js.map