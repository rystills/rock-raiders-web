(self.webpackChunkrock_raiders_web=self.webpackChunkrock_raiders_web||[]).push([[643,990,694,372],{662:(e,t,i)=>{"use strict";i.d(t,{Z:()=>o});var s=i(15),r=i.n(s),n=i(645),a=i.n(n)()(r());a.push([e.id,".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n","",{version:3,sources:["webpack://./site/clearcache/clearCacheButton.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,kBAAkB;IAClB,OAAO;IACP,MAAM;AACV",sourcesContent:[".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n"],sourceRoot:""}]);const o=a},27:(e,t,i)=>{"use strict";i.d(t,{Z:()=>o});var s=i(15),r=i.n(s),n=i(645),a=i.n(n)()(r());a.push([e.id,".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n","",{version:3,sources:["webpack://./site/github/github.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,aAAa;IACb,kBAAkB;IAClB,MAAM;IACN,QAAQ;IACR,oCAAoC;IACpC,WAAW;AACf;;AAEA;IACI,WAAW;IACX,qBAAqB;IACrB,YAAY;AAChB;;AAEA;IACI,WAAW;IACX,0BAA0B;AAC9B;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iBAAiB;IACjB,sBAAsB;AAC1B",sourcesContent:[".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n"],sourceRoot:""}]);const o=a},372:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ClearCacheButton:()=>o});var s=i(848),r=i(379),n=i.n(r),a=i(662);n()(a.Z,{insert:"head",singleton:!1}),a.Z.locals;class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("clear-cache-box");const t=this.rootElement.appendChild(document.createElement("button"));t.classList.add("btn","btn-info"),t.innerText="Clear cached wad files and restart",t.onclick=()=>{indexedDB.deleteDatabase(s.UV),location.reload()}}hide(){this.rootElement.style.visibility="hidden"}}},990:(e,t,i)=>{"use strict";i.r(t),i.d(t,{GithubBox:()=>o});var s=i(379),r=i.n(s),n=i(27);r()(n.Z,{insert:"head",singleton:!1}),n.Z.locals;var a=i(351);class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("github-box");const t=this.rootElement.appendChild(document.createElement("a"));t.href="https://github.com/scarabol/rock-raiders-web";const i=t.appendChild(document.createElement("img"));i.src=a,i.classList.add("github-logo"),i.alt="Fork on GitHub",t.appendChild(document.createElement("span")).textContent=i.alt}hide(){this.rootElement.style.visibility="hidden"}}},694:(e,t,i)=>{"use strict";i.r(t),i.d(t,{WadFileSelectionModal:()=>r});var s=i(169);class r{constructor(e){this.onStart=null;const t=document.getElementById(e).appendChild(document.createElement("div"));t.classList.add("modal"),t.tabIndex=-1,t.setAttribute("role","dialog"),t.setAttribute("aria-hidden","true");const i=t.appendChild(document.createElement("div"));i.classList.add("modal-dialog"),t.setAttribute("role","document");const n=i.appendChild(document.createElement("div"));n.classList.add("modal-content");const a=n.appendChild(document.createElement("div"));a.classList.add("modal-header");const o=a.appendChild(document.createElement("h5"));o.classList.add("modal-title"),o.innerText="Load .wad files",o.id="wadfileSelectModalLabel",t.setAttribute("aria-labelledby",o.id);const l=n.appendChild(document.createElement("div"));l.classList.add("modal-body"),l.appendChild(document.createElement("p")).innerText="Assets not included! In order to play the game, please select the game files.";const h=l.appendChild(document.createElement("nav")).appendChild(document.createElement("div"));h.id="nav-tab",h.classList.add("nav","nav-tabs"),h.setAttribute("role","tablist");const c=r.appendNavButton(h,!0,"nav-file-tab","nav-file","Local files (recommended)"),u=r.appendNavButton(h,!1,"nav-url-tab","nav-url","Online from URL"),d=l.appendChild(document.createElement("div"));d.classList.add("tab-content"),this.appendNavFileTab(d,c.id),this.appendNavUrlTab(d,u.id),this.modal=new s.u_(t,{backdrop:"static",keyboard:!1})}static appendNavButton(e,t,i,s,r){const n=e.appendChild(document.createElement("button"));return n.classList.add("nav-link"),t&&n.classList.add("active"),n.id=i,n.setAttribute("data-bs-toggle","tab"),n.setAttribute("data-bs-target","#"+s),n.type="button",n.setAttribute("role","tab"),n.setAttribute("aria-controls",s),n.setAttribute("aria-selected",String(t)),n.innerText=r,n}appendNavFileTab(e,t){const i=r.appendNavTab(e,!0,"nav-file",t),s=r.appendWadFileGroup(i,"wad0-file","LegoRR0.wad"),n=r.appendWadFileGroup(i,"wad1-file","LegoRR1.wad"),a=i.appendChild(document.createElement("button"));a.type="submit",a.classList.add("btn","btn-primary","float-end"),a.id="button-start-file",a.innerText="Start Game",a.addEventListener("click",(()=>{a.disabled=!0;const e=URL.createObjectURL(s.files[0]),t=URL.createObjectURL(n.files[0]);this.onStart(e,t)}))}static appendWadFileGroup(e,t,i){const s=e.appendChild(document.createElement("div"));s.classList.add("my-3");const r=s.appendChild(document.createElement("label"));r.setAttribute("for",t),r.classList.add("form-label"),r.innerHTML='Select <span class="fw-bold">'+i+"</span> here:";const n=s.appendChild(document.createElement("input"));return n.type="file",n.classList.add("form-control"),n.id=t,n.required=!0,n}appendNavUrlTab(e,t){const i=r.appendNavTab(e,!1,"nav-url",t),s=i.appendChild(document.createElement("div"));s.classList.add("my-3"),s.innerText="Direct links with correct Allow-Origin-CORS-Headers required here.";const n=r.appendWadUrlGroup(i,"wad0-url","LegoRR0.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),a=r.appendWadUrlGroup(i,"wad1-url","LegoRR1.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),o=i.appendChild(document.createElement("button"));o.type="submit",o.classList.add("btn","btn-primary","float-end"),o.id="button-start-url",o.innerText="Start Game",o.addEventListener("click",(()=>{o.disabled=!0,this.onStart(n.value,a.value)}))}static appendNavTab(e,t,i,s){const r=e.appendChild(document.createElement("div"));return r.classList.add("tab-pane","fade"),t&&r.classList.add("show","active"),r.id=i,r.setAttribute("role","tabpanel"),r.setAttribute("aria-labelledby",s),r}static appendWadUrlGroup(e,t,i,s){const r=e.appendChild(document.createElement("div"));r.classList.add("my-3");const n=r.appendChild(document.createElement("label"));n.setAttribute("for",t),n.classList.add("form-label"),n.innerHTML='Enter url for <span class="fw-bold">'+i+"</span> here:";const a=r.appendChild(document.createElement("input"));return a.type="url",a.classList.add("form-control"),a.id=t,a.required=!0,a.value=s,a}show(){this.modal.show()}hide(){this.modal.hide()}}},643:(e,t,i)=>{"use strict";i.r(t);var s,r,n,a,o,l,h=i(372),c=i(990),u=i(694);function d(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const i=t.lastIndexOf("/");return t.substring(i+1)}function g(e,...t){return t.forEach((t=>{e=(e=Object.keys(e).filter((e=>e.toLowerCase()===t.toLowerCase())).map((t=>e[t])))?e[0]:e})),e}function p(e){return(new TextDecoder).decode(e).replace(/\0/g,"")}function m(e){return p(e).replace(/\\/g,"/")}function f(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function y(e){return f(0,e)}function E(){return 2*f(0,1)-1}function v(e){return e&&clearTimeout(e),null}function w(e){return e&&clearInterval(e),null}Array.prototype.remove=function(e){const t=this.indexOf(e);-1!==t&&this.splice(t,1)},Array.prototype.last=function(){return this.length>0?this[this.length-1]:void 0},Array.prototype.count=function(e){let t=0;return this.forEach((i=>e(i)&&t++)),t},Array.prototype.partition=function(e){const t=[],i=[];return this.forEach((s=>e(s)?t.push(s):i.push(s))),[t,i]},Map.prototype.getOrUpdate=function(e,t){let i=this.get(e);return void 0===i&&(i=t(),this.set(e,i)),i},String.prototype.equalsIgnoreCase=function(e){return this.toLowerCase()===(null==e?void 0:e.toLowerCase())},(l=s||(s={}))[l.SELECTION_CHANGED=0]="SELECTION_CHANGED",l[l.BUILDINGS_CHANGED=1]="BUILDINGS_CHANGED",l[l.RAIDERS_CHANGED=2]="RAIDERS_CHANGED",l[l.MATERIAL_AMOUNT_CHANGED=3]="MATERIAL_AMOUNT_CHANGED",l[l.JOB_CREATE=4]="JOB_CREATE",l[l.JOB_DELETE=5]="JOB_DELETE",l[l.REQUESTED_RAIDERS_CHANGED=6]="REQUESTED_RAIDERS_CHANGED",l[l.CAVERN_DISCOVERED=7]="CAVERN_DISCOVERED",l[l.ORE_FOUND=8]="ORE_FOUND",l[l.AIR_LEVEL_CHANGED=9]="AIR_LEVEL_CHANGED",l[l.CHANGE_PRIORITY_LIST=10]="CHANGE_PRIORITY_LIST",l[l.SETUP_PRIORITY_LIST=11]="SETUP_PRIORITY_LIST",l[l.CHANGE_CURSOR=12]="CHANGE_CURSOR",l[l.COMMAND_CHANGE_RAIDER_SPAWN_REQUEST=13]="COMMAND_CHANGE_RAIDER_SPAWN_REQUEST",l[l.COMMAND_CREATE_POWER_PATH=14]="COMMAND_CREATE_POWER_PATH",l[l.COMMAND_PLACE_FENCE=15]="COMMAND_PLACE_FENCE",l[l.COMMAND_MAKE_RUBBLE=16]="COMMAND_MAKE_RUBBLE",l[l.COMMAND_CREATE_CLEAR_RUBBLE_JOB=17]="COMMAND_CREATE_CLEAR_RUBBLE_JOB",l[l.COMMAND_CREATE_DRILL_JOB=18]="COMMAND_CREATE_DRILL_JOB",l[l.COMMAND_CREATE_REINFORCE_JOB=19]="COMMAND_CREATE_REINFORCE_JOB",l[l.COMMAND_CREATE_DYNAMITE_JOB=20]="COMMAND_CREATE_DYNAMITE_JOB",l[l.COMMAND_CANCEL_SURFACE_JOBS=21]="COMMAND_CANCEL_SURFACE_JOBS",l[l.COMMAND_CHANGE_BUILDING_POWER_STATE=22]="COMMAND_CHANGE_BUILDING_POWER_STATE",l[l.COMMAND_UPGRADE_BUILDING=23]="COMMAND_UPGRADE_BUILDING",l[l.COMMAND_BUILDING_BEAMUP=24]="COMMAND_BUILDING_BEAMUP",l[l.COMMAND_RAIDER_EAT=25]="COMMAND_RAIDER_EAT",l[l.COMMAND_PICK_TOOL=26]="COMMAND_PICK_TOOL",l[l.COMMAND_RAIDER_UPGRADE=27]="COMMAND_RAIDER_UPGRADE",l[l.COMMAND_RAIDER_BEAMUP=28]="COMMAND_RAIDER_BEAMUP",l[l.COMMAND_TRAIN_RAIDER=29]="COMMAND_TRAIN_RAIDER",l[l.COMMAND_RAIDER_DROP=30]="COMMAND_RAIDER_DROP",l[l.COMMAND_SELECT_BUILD_MODE=31]="COMMAND_SELECT_BUILD_MODE",l[l.COMMAND_CANCEL_BUILD_MODE=32]="COMMAND_CANCEL_BUILD_MODE",l[l.LOCATION_DEATH=33]="LOCATION_DEATH",l[l.LOCATION_MONSTER=34]="LOCATION_MONSTER",l[l.LOCATION_CRYSTAL_FOUND=35]="LOCATION_CRYSTAL_FOUND",l[l.LOCATION_UNDER_ATTACK=36]="LOCATION_UNDER_ATTACK",l[l.LOCATION_LANDSLIDE=37]="LOCATION_LANDSLIDE",l[l.LOCATION_POWER_DRAIN=38]="LOCATION_POWER_DRAIN",l[l.LOCATION_SLUG_EMERGE=39]="LOCATION_SLUG_EMERGE",l[l.LOCATION_RAIDER_DISCOVERED=40]="LOCATION_RAIDER_DISCOVERED";class b{static publishEvent(e){this.blockedEvents.includes(e.eventKey)||(e.isLocal||console.log("Event published: "+s[e.eventKey]),this.blockedEvents.push(e.eventKey),this.workerListener.forEach((t=>t(e))),this.getListener(e.eventKey).forEach((t=>t(e))),this.blockedEvents.remove(e.eventKey))}static registerEventListener(e,t){this.getListener(e).push(t)}static getListener(e){return this.eventListener.getOrUpdate(e,(()=>[]))}static registerWorkerListener(e){this.workerListener.push(e)}}b.eventListener=new Map,b.workerListener=[],b.blockedEvents=[],function(e){e[e.PILOT=0]="PILOT",e[e.TOOLSTATION=1]="TOOLSTATION",e[e.TELEPORT_PAD=2]="TELEPORT_PAD",e[e.DOCKS=3]="DOCKS",e[e.POWER_STATION=4]="POWER_STATION",e[e.BARRACKS=5]="BARRACKS",e[e.UPGRADE=6]="UPGRADE",e[e.GEODOME=7]="GEODOME",e[e.ORE_REFINERY=8]="ORE_REFINERY",e[e.GUNSTATION=9]="GUNSTATION",e[e.TELEPORT_BIG=10]="TELEPORT_BIG",e[e.BAT=11]="BAT",e[e.SMALL_SPIDER=12]="SMALL_SPIDER",e[e.DYNAMITE=13]="DYNAMITE",e[e.ELECTRIC_FENCE=14]="ELECTRIC_FENCE",e[e.CRYSTAL=15]="CRYSTAL",e[e.ORE=16]="ORE",e[e.BRICK=17]="BRICK",e[e.BARRIER=18]="BARRIER"}(r||(r={})),function(e){e[e.RAIDER=0]="RAIDER",e[e.BUILDING=1]="BUILDING",e[e.MONSTER=2]="MONSTER",e[e.MATERIAL=3]="MATERIAL"}(n||(n={})),function(e){e[e.Pointer_Blank=0]="Pointer_Blank",e[e.Pointer_Standard=1]="Pointer_Standard",e[e.Pointer_Drill=2]="Pointer_Drill",e[e.Pointer_CantDrill=3]="Pointer_CantDrill",e[e.Pointer_Clear=4]="Pointer_Clear",e[e.Pointer_Go=5]="Pointer_Go",e[e.Pointer_CantGo=6]="Pointer_CantGo",e[e.Pointer_Teleport=7]="Pointer_Teleport",e[e.Pointer_CantTeleport=8]="Pointer_CantTeleport",e[e.Pointer_Reinforce=9]="Pointer_Reinforce",e[e.Pointer_CantReinforce=10]="Pointer_CantReinforce",e[e.Pointer_Selected=11]="Pointer_Selected",e[e.Pointer_RadarPan=12]="Pointer_RadarPan",e[e.Pointer_TrackObject=13]="Pointer_TrackObject",e[e.Pointer_Zoom=14]="Pointer_Zoom",e[e.Pointer_CantZoom=15]="Pointer_CantZoom",e[e.Pointer_Help=16]="Pointer_Help",e[e.Pointer_CantHelp=17]="Pointer_CantHelp",e[e.Pointer_PutDown=18]="Pointer_PutDown",e[e.Pointer_GetIn=19]="Pointer_GetIn",e[e.Pointer_GetOut=20]="Pointer_GetOut",e[e.Pointer_Okay=21]="Pointer_Okay",e[e.Pointer_NotOkay=22]="Pointer_NotOkay",e[e.Pointer_CanBuild=23]="Pointer_CanBuild",e[e.Pointer_CannotBuild=24]="Pointer_CannotBuild",e[e.Pointer_Dynamite=25]="Pointer_Dynamite",e[e.Pointer_CantDynamite=26]="Pointer_CantDynamite",e[e.Pointer_PickUp=27]="Pointer_PickUp",e[e.Pointer_CantPickUp=28]="Pointer_CantPickUp",e[e.Pointer_PickUpOre=29]="Pointer_PickUpOre",e[e.Pointer_LegoManCantDig=30]="Pointer_LegoManCantDig",e[e.Pointer_VehicleCantDig=31]="Pointer_VehicleCantDig",e[e.Pointer_LegoManDig=32]="Pointer_LegoManDig",e[e.Pointer_VehicleDig=33]="Pointer_VehicleDig",e[e.Pointer_LegoManCantPickUp=34]="Pointer_LegoManCantPickUp",e[e.Pointer_VehicleCantPickUp=35]="Pointer_VehicleCantPickUp",e[e.Pointer_LegoManPickUp=36]="Pointer_LegoManPickUp",e[e.Pointer_VehiclePickUp=37]="Pointer_VehiclePickUp",e[e.Pointer_LegoManCantGo=38]="Pointer_LegoManCantGo",e[e.Pointer_VehicleCantGo=39]="Pointer_VehicleCantGo",e[e.Pointer_LegoManGo=40]="Pointer_LegoManGo",e[e.Pointer_VehicleGo=41]="Pointer_VehicleGo",e[e.Pointer_LegoManClear=42]="Pointer_LegoManClear",e[e.Pointer_VehicleClear=43]="Pointer_VehicleClear",e[e.Pointer_SurfaceType_Immovable=44]="Pointer_SurfaceType_Immovable",e[e.Pointer_SurfaceType_Hard=45]="Pointer_SurfaceType_Hard",e[e.Pointer_SurfaceType_Medium=46]="Pointer_SurfaceType_Medium",e[e.Pointer_SurfaceType_Loose=47]="Pointer_SurfaceType_Loose",e[e.Pointer_SurfaceType_Soil=48]="Pointer_SurfaceType_Soil",e[e.Pointer_SurfaceType_OreSeam=49]="Pointer_SurfaceType_OreSeam",e[e.Pointer_SurfaceType_CrystalSeam=50]="Pointer_SurfaceType_CrystalSeam",e[e.Pointer_SurfaceType_RechargeSeam=51]="Pointer_SurfaceType_RechargeSeam"}(a||(a={}));class T{constructor(e={}){this.shaping=!1,this.matIndex="00",this.floor=!1,this.selectable=!1,this.drillable=!1,this.drillableHard=!1,this.explodable=!1,this.reinforcable=!1,this.cursor=a.Pointer_Standard,this.statsDrillName=null,this.canCarryFence=!1,Object.assign(this,e)}static getByNum(e){switch(e){case 0:return T.POWER_PATH_BUILDING;case 1:return T.SOLID_ROCK;case 2:return T.HARD_ROCK;case 3:return T.LOOSE_ROCK;case 4:case 5:return T.DIRT;case 6:return T.LAVA;case 8:return T.ORE_SEAM;case 9:return T.WATER;case 10:return T.CRYSTAL_SEAM;case 11:return T.RECHARGE_SEAM;case 30:case 40:return T.SLUG_HOLE;case 100:return T.RUBBLE4;case 101:return T.RUBBLE3;case 102:return T.RUBBLE2;case 103:return T.RUBBLE1;default:return console.error("Unexpected surface type num: "+e),T.SOLID_ROCK}}}T.GROUND=new T({name:"ground",floor:!0,selectable:!0,canCarryFence:!0}),T.SOLID_ROCK=new T({name:"solid rock",shaping:!0,matIndex:"5",cursor:a.Pointer_SurfaceType_Immovable}),T.HARD_ROCK=new T({name:"hard rock",shaping:!0,matIndex:"4",selectable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:a.Pointer_SurfaceType_Hard,statsDrillName:"HardDrillTime"}),T.LOOSE_ROCK=new T({name:"loose rock",shaping:!0,matIndex:"3",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:a.Pointer_SurfaceType_Medium,statsDrillName:"LooseDrillTime"}),T.DIRT=new T({name:"dirt",shaping:!0,matIndex:"2",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:a.Pointer_SurfaceType_Loose,statsDrillName:"SoilDrillTime"}),T.SLUG_HOLE=new T({name:"slug hole",floor:!0,matIndex:"30"}),T.LAVA=new T({name:"lava",floor:!0,matIndex:"46"}),T.ORE_SEAM=new T({name:"ore seam",matIndex:"40",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:a.Pointer_SurfaceType_OreSeam,statsDrillName:"SeamDrillTime"}),T.WATER=new T({name:"water",floor:!0,matIndex:"45"}),T.CRYSTAL_SEAM=new T({name:"energy crystal seam",matIndex:"20",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:a.Pointer_SurfaceType_CrystalSeam,statsDrillName:"SeamDrillTime"}),T.RECHARGE_SEAM=new T({name:"recharge seam",matIndex:"67",cursor:a.Pointer_SurfaceType_RechargeSeam}),T.POWER_PATH=new T({name:"power path all",floor:!0,matIndex:"60",selectable:!0,canCarryFence:!0}),T.POWER_PATH_SITE=new T({name:"power path site",floor:!0,matIndex:"61",selectable:!0,canCarryFence:!0}),T.POWER_PATH_BUILDING=new T({name:"power path building",floor:!0,matIndex:"76"}),T.RUBBLE1=new T({name:"rubble 1",floor:!0,matIndex:"13",selectable:!0,canCarryFence:!0}),T.RUBBLE2=new T({name:"rubble 2",floor:!0,matIndex:"12",selectable:!0,canCarryFence:!0}),T.RUBBLE3=new T({name:"rubble 3",floor:!0,matIndex:"11",selectable:!0,canCarryFence:!0}),T.RUBBLE4=new T({name:"rubble 4",floor:!0,matIndex:"10",selectable:!0,canCarryFence:!0}),function(e){e[e.DRILL=0]="DRILL",e[e.HAMMER=1]="HAMMER",e[e.SHOVEL=2]="SHOVEL",e[e.SPANNER=3]="SPANNER",e[e.FREEZERGUN=4]="FREEZERGUN",e[e.LASER=5]="LASER",e[e.PUSHERGUN=6]="PUSHERGUN",e[e.BIRDSCARER=7]="BIRDSCARER"}(o||(o={}));const A=[o.DRILL,o.HAMMER,o.SHOVEL,o.SPANNER,o.FREEZERGUN,o.LASER,o.PUSHERGUN,o.BIRDSCARER];var S;!function(e){e[e.DRIVER=0]="DRIVER",e[e.ENGINEER=1]="ENGINEER",e[e.GEOLOGIST=2]="GEOLOGIST",e[e.PILOT=3]="PILOT",e[e.SAILOR=4]="SAILOR",e[e.DEMOLITION=5]="DEMOLITION"}(S||(S={}));const R=[S.DRIVER,S.ENGINEER,S.GEOLOGIST,S.PILOT,S.SAILOR,S.DEMOLITION],C=[];C[S.DRIVER]=r.BARRACKS,C[S.DRIVER]=r.BARRACKS,C[S.ENGINEER]=r.UPGRADE,C[S.GEOLOGIST]=r.GEODOME,C[S.PILOT]=r.TELEPORT_PAD,C[S.SAILOR]=r.DOCKS,C[S.DEMOLITION]=r.TOOLSTATION;const L=[];var M;L[S.DRIVER]="TrainDriver",L[S.ENGINEER]="TrainRepair",L[S.GEOLOGIST]="TrainScanner",L[S.PILOT]="TrainPilot",L[S.SAILOR]="TrainSailor",L[S.DEMOLITION]="TrainDynamite",function(e){e[e.NOTHING=0]="NOTHING",e[e.SURFACE=1]="SURFACE",e[e.RAIDER=2]="RAIDER",e[e.BUILDING=3]="BUILDING",e[e.VEHICLE=4]="VEHICLE",e[e.GROUP=5]="GROUP"}(M||(M={}));class P{constructor(e){this.eventKey=e,this.guiForward=!0}}class I extends P{constructor(e){super(e),this.isLocal=!0}}class O extends I{constructor(e=M.NOTHING,t=null,i=null,n=null){super(s.SELECTION_CHANGED),this.canDoTraining=new Map,this.everyHasTool=new Map,this.selectionType=e,this.isGround=(null==t?void 0:t.surfaceType)===T.GROUND,this.isPowerPath=(null==t?void 0:t.surfaceType)===T.POWER_PATH,this.isFloor=null==t?void 0:t.surfaceType.floor,this.hasRubble=null==t?void 0:t.hasRubble(),this.isDrillable=null==t?void 0:t.isDrillable(),this.isDrillableHard=null==t?void 0:t.isDrillableHard(),this.isReinforcable=null==t?void 0:t.isReinforcable(),this.canPlaceFence=(null==t?void 0:t.canPlaceFence())&&G.buildings.some((e=>e.entityType===r.POWER_STATION&&e.isUsable())),this.someCarries=!!(null==n?void 0:n.some((e=>!!e.carries))),this.everyHasMaxLevel=!!(null==n?void 0:n.every((e=>e.level>=e.stats.Levels))),R.forEach((e=>this.canDoTraining.set(e,G.getTrainingSites(e).length>0&&(null==n?void 0:n.some((t=>!t.hasTraining(e))))))),A.forEach((e=>this.everyHasTool.set(e,!!(null==n?void 0:n.every((t=>t.hasTool(e))))))),this.buildingCanUpgrade=null==i?void 0:i.canUpgrade(),this.buildingCanSwitchPower=(null==i?void 0:i.stats.SelfPowered)||(null==i?void 0:i.stats.PowerBuilding)}}class x extends I{constructor(e){super(s.AIR_LEVEL_CHANGED),this.airLevel=e}}class _ extends I{constructor(e){super(s.CHANGE_CURSOR),this.cursor=e}}class D extends I{constructor(e){super(s.SETUP_PRIORITY_LIST),this.priorityList=e}}class N extends I{constructor(){super(s.BUILDINGS_CHANGED),this.usableBuildingsByTypeAndLevel=new Map,G.buildings.forEach((e=>{if(e.isUsable()){const t=this.usableBuildingsByTypeAndLevel.getOrUpdate(e.entityType,(()=>new Map));t.set(e.level,t.getOrUpdate(e.level,(()=>0))+1)}}))}static countUsable(e,t,i=0){let s=0;return e.usableBuildingsByTypeAndLevel.getOrUpdate(t,(()=>new Map)).forEach(((e,t)=>{t>=i&&(s+=e)})),s}}class k extends I{constructor(e=null){super(s.RAIDERS_CHANGED),this.numRaiders=G.raiders.length,this.training=e}}var B,U=i(848);class F{constructor(){this.levelDefault=[],this.current=[]}setList(e){this.levelDefault=e,this.reset()}toggle(e){this.current[e].enabled=!this.current[e].enabled}upOne(e){const t=this.current[e];this.current[e]=this.current[e+1],this.current[e+1]=t}reset(){this.current=this.levelDefault.map((e=>new W(e)))}pushToTop(e){const t=this.current[e];for(let t=e;t>0;t--)this.current[t]=this.current[t-1];this.current[0]=t}getPriority(e){let t=0;return this.current.some(((i,s)=>{if(i.key===e.getPriorityIdentifier())return t=s,!0})),t}isEnabled(e){var t;return(null===(t=this.current.find((t=>t.key===e)))||void 0===t?void 0:t.enabled)||!1}}class W{constructor(e){this.key=e.key,this.enabled=e.enabled}}!function(e){e[e.RUNNING=0]="RUNNING",e[e.COMPLETE=1]="COMPLETE",e[e.FAILED=2]="FAILED"}(B||(B={}));class G{static reset(){this.resultState=B.RUNNING,this.levelFullName="",this.numCrystal=0,this.numOre=0,this.numBrick=0,this.usedCrystals=0,this.neededCrystals=0,this.airLevel=1,this.selectedEntities=[],this.selectionType=null,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.requestedRaiders=0,this.materials=[],this.materialsUndiscovered=[],this.buildingSites=[],this.spiders=[],this.spidersBySurface=new Map,this.bats=[],this.totalCrystals=0,this.totalOres=0,this.totalDiggables=0,this.remainingDiggables=0,this.totalCaverns=0,this.discoveredCaverns=0,this.levelStartTime=0,this.levelStopTime=0,this.rewardConfig=null,this.priorityList=new F,this.oxygenRate=0,this.buildModeSelection=null,this.objectiveShown=!1,this.objectiveSwitch=!1}static getBuildingsByType(...e){return this.buildings.filter((t=>t.isUsable()&&e.some((e=>t.entityType===e))))}static getClosestBuildingByType(e,...t){const i=G.getBuildingsByType(...t);let s=null,r=null;return i.forEach((t=>{const i=t.getDropPosition(),n=e.distanceToSquared(i);(null===s||n<r)&&(s=t,r=n)})),s}static getTrainingSites(e){return this.buildings.filter((t=>t.entityType===C[e]&&t.isUsable()&&t.stats[L[e]][t.level]))}static selectEntities(e){this.selectedEntities=this.selectedEntities.filter((t=>{const i=-1!==e.indexOf(t);return i||t.deselect(),i})),e.forEach((e=>{e.select()&&this.selectedEntities.push(e)}));const t=this.selectedEntities.length;t>1?this.selectionType=M.GROUP:1===t?this.selectionType=this.selectedEntities[0].getSelectionType():null!==this.selectionType&&(this.selectionType=M.NOTHING),b.publishEvent(new O(this.selectionType,this.selectedSurface,this.selectedBuilding,this.selectedRaiders))}static getMaxRaiders(){return U.d+G.buildings.count((e=>e.isUsable()&&e.entityType===r.BARRACKS))*U.oq}static discoverSurface(e){const t=e.x*U.pM,i=e.y*U.pM,s=t+U.pM,r=i+U.pM;this.discoverEntities(this.raidersUndiscovered,t,s,i,r),this.discoverEntities(this.buildingsUndiscovered,t,s,i,r),this.discoverEntities(this.materialsUndiscovered,t,s,i,r)}static discoverEntities(e,t,i,s,r){const n=[];e.forEach((e=>{const a=e.getPosition();a.x>=t&&a.x<i&&a.z>=s&&a.z<r&&(e.onDiscover(),n.push(e))})),n.forEach((t=>e.remove(t)))}static get gameTimeSeconds(){return Math.round((G.levelStopTime-G.levelStartTime)/1e3)}static get score(){if(!G.rewardConfig)return 0;let e=G.rewardConfig.quota,t=G.rewardConfig.importance;const i=G.numCrystal>=(e.crystals||1/0)?t.crystals:0,s=G.gameTimeSeconds<=(e.timer||0)?t.timer:0,r=e.caverns?Math.min(1,G.discoveredCaverns/e.caverns)*t.caverns:0,n=e.constructions?Math.min(1,G.buildings.length/e.constructions*t.constructions):0,a=G.airLevel*t.oxygen,o=G.raiders.length>=U.d?t.figures:0;return Math.round(i+s+r+n+a+o)/100}static get selectedSurface(){return this.selectionType===M.SURFACE&&this.selectedEntities.length>0?this.selectedEntities[0]:null}static get selectedBuilding(){return this.selectionType===M.BUILDING&&this.selectedEntities.length>0?this.selectedEntities[0]:null}static get selectedRaiders(){return(this.selectionType===M.RAIDER||this.selectionType===M.GROUP)&&this.selectedEntities.length>0?this.selectedEntities:[]}static get totalOre(){return this.numOre+5*this.numBrick}static getNearbySpiders(e){const t=e.sceneMgr.terrain,i=t.getSurfaceFromWorld(e.getPosition()),s=[];for(let e=i.x;e<=i.x+1;e++)for(let r=i.y;r<=i.y+1;r++){const i=t.getSurface(e,r);s.push(...G.spidersBySurface.get(i)||[])}return s}}G.resultState=B.RUNNING,G.levelFullName="",G.numCrystal=0,G.numOre=0,G.numBrick=0,G.usedCrystals=0,G.neededCrystals=0,G.airLevel=1,G.selectedEntities=[],G.selectionType=null,G.buildings=[],G.buildingsUndiscovered=[],G.raiders=[],G.raidersUndiscovered=[],G.requestedRaiders=0,G.materials=[],G.materialsUndiscovered=[],G.buildingSites=[],G.spiders=[],G.spidersBySurface=new Map,G.bats=[],G.totalCrystals=0,G.totalOres=0,G.totalDiggables=0,G.remainingDiggables=0,G.totalCaverns=0,G.discoveredCaverns=0,G.levelStartTime=0,G.levelStopTime=0,G.rewardConfig=null,G.priorityList=new F,G.oxygenRate=0,G.buildModeSelection=null,G.objectiveShown=!1,G.objectiveSwitch=!1;var H=i(212);function J(e,t){if(e<1||t<1)return console.error("Can't create context with size "+e+" x "+t),function(e,t){const i=J(64,64);for(let e=0;e<64;e+=16)for(let t=0;t<64;t+=16)i.fillStyle=t/16%2==e/16%2?"rgb(0,255,255)":"rgb(255,0,255)",i.fillRect(t,e,16,16);return i}();let i;"undefined"!=typeof document?(i=document.createElement("canvas"),i.setAttribute("width",e),i.setAttribute("height",t)):i=new OffscreenCanvas(e,t);const s=i.getContext("2d");return s.width=e,s.height=t,s}function V(e,t){const i=new ImageData(e,t);for(let s=0;s<t;s+=16)for(let t=0;t<e;t+=16){const e=t/16%2==s/16%2;for(let r=t;r<t+16;r++)for(let t=s;t<s+16;t++)j(i,r,t,e?0:255,e?255:0,255)}return i}function j(e,t,i,s,r,n,a=255){const o=4*(i*e.width+t);e.data[o]=s,e.data[o+1]=r,e.data[o+2]=n,e.data[o+3]=a}function Y(e,t,i){const s=4*(i*e.width+t);return{r:e.data[s],g:e.data[s+1],b:e.data[s+2],a:e.data[s+3]}}class K{constructor(){this.carryNullName="",this.depositNullName="",this.toolNullName="",this.mediumPoly={},this.highPoly={},this.fPPoly={},this.activities=new Map}}var q=i(886);const z=i(466);class Z{constructor(){this.stats=new z,this.stats.setMode(0),this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement),this.hide()}show(){this.stats.domElement.style.visibility="visible"}hide(){this.stats.domElement.style.visibility="hidden"}renderStart(){this.stats.begin()}renderDone(){this.stats.end()}}class X{constructor(e,t){this.location=e,this.heading=e.clone().sub(t).angle(),e.y===t.y?this.heading-=Math.PI/2:this.heading+=Math.PI/2}}var $,Q=i(586);!function(e){e[e.CORNER=1]="CORNER",e[e.WALL=2]="WALL",e[e.INVERTED_CORNER=3]="INVERTED_CORNER",e[e.WEIRD_CREVICE=20]="WEIRD_CREVICE"}($||($={}));class ee{static create(e,t,i,s,r,n,a,o,l){let h=0;!t.y||i.y||e!==$.INVERTED_CORNER&&(e===$.WALL||e===$.WEIRD_CREVICE)!==Boolean(s.y)||(h=0),!s.y||r.y||e!==$.INVERTED_CORNER&&(e===$.WALL||e===$.WEIRD_CREVICE)!==Boolean(i.y)||(h=3),!i.y||t.y||e!==$.INVERTED_CORNER&&(e===$.WALL||e===$.WEIRD_CREVICE)!==Boolean(r.y)||(h=2),!r.y||s.y||e!==$.INVERTED_CORNER&&(e===$.WALL||e===$.WEIRD_CREVICE)!==Boolean(t.y)||(h=1),e!==$.WALL&&e!==$.WEIRD_CREVICE||(t.y&&i.y&&(h=0),s.y&&r.y&&(h=3));const c=[new H.FM8(0,1),new H.FM8(1,1),new H.FM8(1,0),new H.FM8(0,0)],u=[],d=[];function g(e,t,i){u.push(e,t,i);const s=(new H.Pa4).subVectors(i,t);s.cross((new H.Pa4).subVectors(e,t)),s.normalize(),d.push(s,s,s)}const p=[];s.y===r.y&&(e!==$.WALL&&e!==$.WEIRD_CREVICE||s.y&&r.y)?(p.push(0,3,2),p.push(0,2,1),t.y=n,s.y=a,i.y=o,r.y=l,g(t,r,i),g(t,i,s)):(p.push(1,3,2),p.push(1,0,3),t.y=n,s.y=a,i.y=o,r.y=l,g(s,r,i),g(s,t,r));const m=p.map((e=>c[(e+h)%4])),f=new H.u9r;return f.setAttribute("position",new Q.Tl(new Float32Array(18),3).copyVector3sArray(u)),f.setAttribute("normal",new Q.Tl(new Float32Array(18),3).copyVector3sArray(d)),f.setAttribute("uv",new Q.Tl(new Float32Array(12),2).copyVector2sArray(m)),f}}class te extends H.Kj0{constructor(e){super(te.geometry,new H.xoR({shininess:0,transparent:!0,opacity:.4,color:e})),this.standardColor=e,this.visible=!1}updateState(e,t,i){this.visible=!!e,e&&this.position.set(e.x,0,e.y).multiplyScalar(U.pM).applyAxisAngle(new H.Pa4(0,1,0),-t+Math.PI/2).add(i)}markAsValid(e){const t=e?this.standardColor:5242880;this.material.color.setHex(t)}}te.geometry=ee.create($.WALL,new H.Pa4(0,0,0),new H.Pa4(U.pM,0,U.pM),new H.Pa4(U.pM,0,0),new H.Pa4(0,0,U.pM),1,1,1,1);class ie{constructor(){this.group=new H.ZAu,this.markers=[],this.buildingMarkerPrimary=null,this.buildingMarkerSecondary=null,this.powerPathMarkerPrimary=null,this.powerPathMarkerSecondary=null,this.waterPathMarker=null,this.heading=0,this.sdx=0,this.sdz=0,this.lastCheck=!1,this.visibleSurfaces=[],this.primarySurface=null,this.secondarySurface=null,this.waterSurface=null,this.buildingMarkerPrimary=new te(ie.buildingMarkerColor),this.buildingMarkerSecondary=new te(ie.buildingMarkerColor),this.powerPathMarkerPrimary=new te(ie.pathMarkerColor),this.powerPathMarkerSecondary=new te(ie.pathMarkerColor),this.waterPathMarker=new te(ie.waterMarkerColor),this.addMarker(this.buildingMarkerPrimary),this.addMarker(this.buildingMarkerSecondary),this.addMarker(this.powerPathMarkerPrimary),this.addMarker(this.powerPathMarkerSecondary),this.addMarker(this.waterPathMarker)}addMarker(e){this.group.add(e),this.markers.push(e)}update(e,t){if(t&&G.buildModeSelection){const i=this.updateAllMarker(e,t);this.markers.forEach((e=>e.markAsValid(i)))}else this.hideAllMarker()}updateAllMarker(e,t=null){this.buildingMarkerPrimary.visible=!0,this.buildingMarkerPrimary.position.copy(e.sceneMgr.getFloorPosition(new H.FM8(Math.floor(t.x/U.pM)*U.pM,Math.floor(t.y/U.pM)*U.pM)));const i=t.x-this.buildingMarkerPrimary.position.x-U.pM/2,s=t.y-this.buildingMarkerPrimary.position.z-U.pM/2,r=Math.abs(i)>Math.abs(s)?Math.sign(i):0,n=Math.abs(s)>Math.abs(i)?Math.sign(s):0;return this.sdx===r&&this.sdz===n||(this.sdx=r,this.sdz=n,this.heading=Math.atan2(n,r),this.buildingMarkerSecondary.updateState(G.buildModeSelection.secondaryBuildingPart,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerPrimary.updateState(G.buildModeSelection.primaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerSecondary.updateState(G.buildModeSelection.secondaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.waterPathMarker.updateState(G.buildModeSelection.waterPathSurface,this.heading,this.buildingMarkerPrimary.position),this.visibleSurfaces=[this.buildingMarkerPrimary,this.buildingMarkerSecondary,this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].filter((e=>e.visible)).map((t=>e.getSurfaceFromWorld(t.position))),this.primarySurface=this.visibleSurfaces[0],this.secondarySurface=this.buildingMarkerSecondary.visible?this.visibleSurfaces[1]:null,this.waterSurface=this.waterPathMarker.visible?e.getSurfaceFromWorld(this.waterPathMarker.position):null,this.lastCheck=this.visibleSurfaces.every((e=>e.surfaceType===T.GROUND))&&([this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].some((t=>t.visible&&e.getSurfaceFromWorld(t.position).neighbors.some((e=>e.surfaceType===T.POWER_PATH))))||!G.buildModeSelection.primaryPowerPath&&this.primarySurface.neighbors.some((e=>e.surfaceType===T.POWER_PATH)))&&(!this.waterPathMarker.visible||this.waterSurface.surfaceType===T.WATER)),this.lastCheck}hideAllMarker(){this.markers.forEach((e=>e.visible=!1)),this.lastCheck=!1}getBarrierLocations(){const e=[],t=this.primarySurface.getCenterWorld2D(),i=9*U.pM/20;if(this.secondarySurface){const s=this.secondarySurface.getCenterWorld2D(),r=Math.sign(s.x-t.x),n=Math.sign(s.y-t.y);0!==r?(e.push(new X(new H.FM8(t.x-r*i,t.y),t)),e.push(new X(new H.FM8(t.x,t.y-i),t)),e.push(new X(new H.FM8(t.x,t.y+i),t)),e.push(new X(new H.FM8(s.x+r*i,t.y),s)),e.push(new X(new H.FM8(s.x,s.y-i),s)),e.push(new X(new H.FM8(s.x,s.y+i),s))):(e.push(new X(new H.FM8(t.x,t.y-n*i),t)),e.push(new X(new H.FM8(t.x-i,t.y),t)),e.push(new X(new H.FM8(t.x+i,t.y),t)),e.push(new X(new H.FM8(s.x,s.y+n*i),s)),e.push(new X(new H.FM8(s.x-i,t.y),s)),e.push(new X(new H.FM8(s.x+i,t.y),s)))}else e.push(new X(new H.FM8(t.x-i,t.y),t)),e.push(new X(new H.FM8(t.x,t.y-i),t)),e.push(new X(new H.FM8(t.x+i,t.y),t)),e.push(new X(new H.FM8(t.x,t.y+i),t));return e}}function se(e){let t=e;const i=[];for(;t.parent;)i.unshift(t),t=t.parent;return i}ie.buildingMarkerColor=20480,ie.pathMarkerColor=5263360,ie.waterMarkerColor=80;const re={search(e,t,i,s=null){e.cleanDirty();const r=(s=s||{}).heuristic||re.heuristics.manhattan,n=s.closest||!1,a=new oe((function(e){return e.f}));let o=t;for(t.h=r(t,i),e.markDirty(t),a.push(t);a.size()>0;){const t=a.pop();if(t===i)return se(t);t.closed=!0;const s=e.neighbors(t);let l=0;const h=s.length;for(;l<h;++l){const h=s[l];if(h.closed||h.isWall())continue;const c=t.g+h.getCost(t),u=h.visited;(!u||c<h.g)&&(h.visited=!0,h.parent=t,h.h=h.h||r(h,i),h.g=c,h.f=h.g+h.h,e.markDirty(h),n&&(h.h<o.h||h.h===o.h&&h.g<o.g)&&(o=h),u?a.rescoreElement(h):a.push(h))}}return n?se(o):[]},heuristics:{manhattan:(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),diagonal(e,t){const i=Math.sqrt(2),s=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return 1*(s+r)+(i-2)*Math.min(s,r)}},cleanNode(e){e.f=0,e.g=0,e.h=0,e.visited=!1,e.closed=!1,e.parent=null}};class ne{constructor(e,t=null){this.nodes=[],this.grid=[],this.dirtyNodes=[],t=t||{},this.diagonal=!!t.diagonal;for(let t=0;t<e.length;t++){this.grid[t]=[];let i=0;const s=e[t];for(;i<s.length;i++){const e=new ae(t,i,s[i]);this.grid[t][i]=e,this.nodes.push(e)}}this.init()}init(){this.dirtyNodes=[];for(let e=0;e<this.nodes.length;e++)re.cleanNode(this.nodes[e])}cleanDirty(){for(let e=0;e<this.dirtyNodes.length;e++)re.cleanNode(this.dirtyNodes[e]);this.dirtyNodes=[]}markDirty(e){this.dirtyNodes.push(e)}neighbors(e){const t=[],i=e.x,s=e.y,r=this.grid;return r[i-1]&&r[i-1][s]&&t.push(r[i-1][s]),r[i+1]&&r[i+1][s]&&t.push(r[i+1][s]),r[i]&&r[i][s-1]&&t.push(r[i][s-1]),r[i]&&r[i][s+1]&&t.push(r[i][s+1]),this.diagonal&&(r[i-1]&&r[i-1][s-1]&&t.push(r[i-1][s-1]),r[i+1]&&r[i+1][s-1]&&t.push(r[i+1][s-1]),r[i-1]&&r[i-1][s+1]&&t.push(r[i-1][s+1]),r[i+1]&&r[i+1][s+1]&&t.push(r[i+1][s+1])),t}toString(){const e=[],t=this.grid;for(let i=0;i<t.length;i++){const s=[],r=t[i];for(let e=0;e<r.length;e++)s.push(r[e].weight);e.push(s.join(" "))}return e.join("\n")}}class ae{constructor(e,t,i){this.x=e,this.y=t,this.weight=i}toString(){return"["+this.x+" "+this.y+"]"}getCost(e){return e&&e.x!=this.x&&e.y!=this.y?1.41421*this.weight:this.weight}isWall(){return 0===this.weight}}class oe{constructor(e){this.content=[],this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.sinkDown(this.content.length-1)}pop(){const e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e}remove(e){const t=this.content.indexOf(e),i=this.content.pop();t!==this.content.length-1&&(this.content[t]=i,this.scoreFunction(i)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))}size(){return this.content.length}rescoreElement(e){this.sinkDown(this.content.indexOf(e))}sinkDown(e){const t=this.content[e];for(;e>0;){const i=(e+1>>1)-1,s=this.content[i];if(!(this.scoreFunction(t)<this.scoreFunction(s)))break;this.content[i]=t,this.content[e]=s,e=i}}bubbleUp(e){const t=this.content.length,i=this.content[e],s=this.scoreFunction(i);for(;;){const r=e+1<<1,n=r-1;let a,o=null;if(n<t){const e=this.content[n];a=this.scoreFunction(e),a<s&&(o=n)}if(r<t){const e=this.content[r];this.scoreFunction(e)<(null===o?s:a)&&(o=r)}if(null===o)break;this.content[e]=this.content[o],this.content[o]=i,e=o}}}class le extends P{constructor(e){super(e),this.isLocal=!1}}class he extends le{constructor(e,t){super(e),this.guiForward=!1,this.job=t}}class ce extends he{constructor(e){super(s.JOB_CREATE,e)}}class ue extends he{constructor(e){super(s.JOB_DELETE,e)}}class de extends le{constructor(e){super(s.REQUESTED_RAIDERS_CHANGED),this.numRequestedRaiders=e}}class ge extends le{constructor(){super(s.MATERIAL_AMOUNT_CHANGED),this.numCrystal=G.numCrystal,this.usedCrystal=G.usedCrystals,this.neededCrystal=G.neededCrystals,this.totalOre=G.totalOre}}class pe extends le{constructor(){super(s.CAVERN_DISCOVERED)}}class me extends le{constructor(){super(s.ORE_FOUND)}}class fe extends le{constructor(e,t){super(e),this.location=t}}class ye extends fe{constructor(e){super(s.LOCATION_CRYSTAL_FOUND,e)}}class Ee extends fe{constructor(e){super(s.LOCATION_LANDSLIDE,e)}}class ve extends fe{constructor(e){super(s.LOCATION_RAIDER_DISCOVERED,e)}}class we{constructor(){this.looping=!1,this.transcoef=1,this.firstFrame=null,this.lastFrame=null,this.framesPerSecond=null,this.bodies=[]}}var be=H.M8C.degToRad;class Te{constructor(){this.name="",this.filename="",this.relPos=[],this.relRot=[],this.relScale=[],this.opacity=[],this.parentObjInd=null,this.model=null}radVec(e,t,i){return new H.USm(be(t),be(e),be(i),"YXZ")}setFrameAndFollowing(e,t,i){this.relPos[e]=new H.Pa4(i[0],i[1],i[2]),this.relRot[e]=this.radVec(i[3],i[4],i[5]),this.relScale[e]=new H.Pa4(i[6],i[7],i[8]);for(let i=e;i<=t;i++)this.relPos[i]=this.relPos[e],this.relRot[i]=this.relRot[e],this.relScale[i]=this.relScale[e]}setOpacityAndFollowing(e,t,i){for(let s=e;s<=t;s++)this.opacity[s]=i}}class Ae{constructor(e,t){this.mesh=null,this.textureSequences=[],this.mesh=e,this.textureSequences=t}dispose(){var e;this.textureSequences.forEach((e=>w(e))),this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach((e=>e.dispose())):null===(e=this.mesh.material)||void 0===e||e.dispose()}}const Se=1448366670;function Re(e,t){let i=new H.Pa4;return i.x=e.getFloat32(t),i.y=e.getFloat32(t+4),i.z=e.getFloat32(t+8),i}class Ce{constructor(e,t=!1){this.path="",this.verbose=!1,this.materials=[],this.geometry=new H.u9r,this.vertices=null,this.indices=null,this.uvs=null,this.sequenceIntervals=[],this.path=e,this.verbose=t,this.verbose&&console.log("LWO path: "+this.path)}parsePoints(e,t,i){if(i%12!=0)return void console.error("LWOLoader.parse: F12 does not evenly divide into chunk size ("+i+"). Possible corruption.");let s=i/4/3;this.vertices=new Float32Array(3*s),this.uvs=new Float32Array(2*s);for(let i=0;i<s;i++){let s=3*i,r=4*s;this.vertices[s]=e.getFloat32(t+r),this.vertices[s+1]=e.getFloat32(t+r+4),this.vertices[s+2]=e.getFloat32(t+r+8)}}parseSurfaceNames(e,t,i){let s=(new TextDecoder).decode(new Uint8Array(e,t,i)).split("\0").filter((function(e){return""!==e}));for(let e=0;e<s.length;e++){const t=new H.xoR;t.name=s[e],t.side=H.ehD,t.alphaToCoverage=!0,this.materials.push(t)}this.verbose&&console.log("LWO contains "+this.materials.length+" materials with following names: "+s)}parsePolygons(e,t,i){let s=0,r=0;for(;r<i;){const i=e.getInt16(t+r),n=e.getInt16(t+r+2+2*i);this.geometry.addGroup(s,3*(i-2),n-1),s+=3*(i-2),r+=4+2*i}r=0;let n=0;for(this.indices=new Uint16Array(s);r<i;){let i=e.getInt16(t+r);r+=2;let s=new Int16Array(i);for(let n=0;n<=i;n++)s[n]=e.getInt16(t+r+2*n);for(let e=0;e<i-2;e++)this.COUNTER_CLOCKWISE?(this.indices[n++]=s[0],this.indices[n++]=s[e+2],this.indices[n++]=s[e+1]):(this.indices[n++]=s[0],this.indices[n++]=s[e+1],this.indices[n++]=s[e+2]);r+=2+2*i}}parseSurface(e,t,i,s){let r=0;for(;0!==e.getUint8(i+r);)r++;let n=p(new Uint8Array(t,i,r));this.verbose&&console.log("Parsing surface: "+n);let a=-1,o=null,l=0,h=new H.Pa4(0,0,0),c=new H.Pa4(0,0,0);for(let e=0;e<this.materials.length;e++)this.materials[e].name===n&&(a=e,o=this.materials[e]);if(o){for(o.shininess=0;r<s;){const s=i+r;if(0===e.getUint8(s))r++;else{const i=e.getInt32(s),n=e.getInt16(s+4);switch(this.verbose&&console.log("Parsing subchunk "+(new TextDecoder).decode(new Uint8Array(t,s,4))+" at "+s+"; length "+n),i){case 1129270354:const r=[e.getUint8(s+6+0)/255,e.getUint8(s+6+1)/255,e.getUint8(s+6+2)/255];o.color=(new H.Ilk).fromArray(r),this.verbose&&console.log("Material color (COLR): "+r.join(" "));break;case 1179402567:const a=e.getUint16(s+6);this.verbose&&console.log("Flags (FLAG): "+a.toString(2)),this.verbose&&2&a&&console.warn("Flag is set but unhandled: outline"),this.verbose&&4&a&&console.warn("Flag is set but unhandled: smoothing"),this.verbose&&8&a&&console.warn("Flag is set but unhandled: colorHighlights"),this.verbose&&16&a&&console.warn("Flag is set but unhandled: colorFilter"),this.verbose&&32&a&&console.warn("Flag is set but unhandled: opaqueEdge"),this.verbose&&64&a&&console.warn("Flag is set but unhandled: transparentEdge"),this.verbose&&128&a&&console.warn("Flag is set but unhandled: sharpTerminator"),256&a&&(o.side=H.ehD),512&a&&(o.blending=H.WMw,o.depthWrite=!1),this.verbose&&1024&a&&console.warn("Flag is set but unhandled: shadowAlpha");break;case 1162102597:const u=e.getFloat32(s+6);this.verbose&&console.warn("Edge transparency threshold (0.0 to 1.0): "+u);break;case 1280658761:const g=e.getInt16(s+6)/256;this.verbose&&console.log("Luminosity (LUMI): "+g),o.emissiveIntensity=g;break;case 1145652806:const p=e.getInt16(s+6)/256;this.verbose&&console.log("Diffuse (DIFF): "+p),p||(o.color=null);break;case 1397769539:const f=e.getInt16(s+6)/256;this.verbose&&console.warn("Specular (SPEC): "+f);break;case 1380271692:let y=0;y=1447449164===y?e.getFloat32(s+6):e.getInt16(s+6)/256,o.reflectivity=y,this.verbose&&console.log("Reflectivity (REFL): "+o.reflectivity);break;case 1414676814:case Se:let E=0;E=i===Se?e.getFloat32(s+6):e.getInt16(s+6)/256,o.opacity=1-E,this.verbose&&console.log("Opacity (TRAN/VTRN): "+o.opacity),o.transparent=o.transparent||o.opacity<1;break;case 1447843149:const v=e.getFloat32(s+6);this.verbose&&console.log("Luminosity (VLUM): "+v),o.emissiveIntensity=v;break;case 1447315782:let w=e.getFloat32(s+6);this.verbose&&console.log("Diffuse (VDIF): "+w);break;case 1448300611:let b=e.getFloat32(s+6);this.verbose&&console.warn("Specular (VSPC): "+b);break;case 1413893191:l=e.getUint16(s+6),this.verbose&&console.log("Flags (TFLG): "+l.toString(2)),this.verbose&&1&l&&console.warn("Flag is set but unhandled: X Axis"),this.verbose&&2&l&&console.warn("Flag is set but unhandled: Y Axis"),this.verbose&&4&l&&console.warn("Flag is set but unhandled: Z Axis"),this.verbose&&8&l&&console.warn("Flag is set but unhandled: World Coords"),this.verbose&&16&l&&console.warn("Flag is set but unhandled: Negative Image"),this.verbose&&32&l&&console.warn("Flag is set but unhandled: Pixel Blending"),this.verbose&&64&l&&console.log("Flag is set: Antialiasing");break;case 1414744410:h=Re(e,s+6),this.verbose&&console.warn("Texture size (TSIZ): "+h.toArray().join(" "));break;case 1413698642:c=Re(e,s+6),this.verbose&&console.warn("Texture center (TCTR): "+c.toArray().join(" "));break;case 1129596248:case 1146373464:case 1398031704:case 1381254488:case 1414808920:case 1112819032:const T=m(new Uint8Array(t,s+6,n));this.verbose&&console.log("Texture typename: "+T);break;case 1413696594:const A=e.getUint16(s+6)/256;this.verbose&&console.warn("Texture value (TVAL): "+A);break;case 1413696594:const S=[e.getUint8(s+6+0)/255,e.getUint8(s+6+1)/255,e.getUint8(s+6+2)/255,e.getUint8(s+6+3)/255];this.verbose&&console.log("Texture color (TCLR): "+S.join(" "));break;case 1414090055:let R=m(new Uint8Array(t,s+6,n));if(this.verbose&&console.log("Texture filepath (TIMG): "+R),"(none)"===R)break;let C=!1;R.endsWith(" (sequence)")&&(C=!0,R=R.substring(0,R.length-" (sequence)".length));let L=d(R);o.transparent=o.transparent||!!L.match(/^a\d+.+.bmp/i);const M=this.path+L;if(C){const e=M.match(/(.+\D)0+(\d+)\..+/),t=ct.filterTextureSequenceNames(e[1]).map((e=>ct.getTexture(e)));if(t){let e=0;o.color=null,this.sequenceIntervals.push(setInterval((()=>{o.map=t[e++],e>=t.length&&(e=0)}),1e3/U.a4))}}const P=M.toLowerCase();if("miscanims/barrier/a_side.bmp"===P||"miscanims/barrier/a_top.bmp"===P||"world/shared/teofoilreflections.jpg"===P||"buildings/barracks/wingbase3.bmp"===P)break;o.map=ct.getTexture(M),o.color=null;break;default:this.verbose&&console.warn("Found unrecognised SURF subchunk type "+(new TextDecoder).decode(new Uint8Array(t,s,4))+" at "+s+"; length "+n)}r+=6+n}}!function(e,t,i,s,r,n,a,o){if(7&o)for(let l of e.groups)if(l.materialIndex===r)for(let e=l.start;e<l.start+l.count;e++){let r=3*s[e],l=t[r]-a.x,h=t[r+1]-a.y,c=t[r+2]-a.z,u=2*s[e],d=0,g=0;1&o?(d=c/n.z+.5,g=h/n.y+.5):2&o?(d=l/n.x+.5,g=c/n.z+.5):4&o&&(d=l/n.x+.5,g=h/n.y+.5),i[u]=d,i[u+1]=g}}(this.geometry,this.vertices,this.uvs,this.indices,a,h,c,l)}else console.error("LWOLoader.parse: Surface in SURF chunk does not exist in SRFS")}parse(e){const t=new DataView(e);if(1179603533!==t.getUint32(0))return void console.error("LWOLoader.parse: Cannot find header.");const i=t.getUint32(4);if(i+8!==t.byteLength&&console.warn("LWOLoader.parse: Discrepancy between size in header ("+(i+8)+" bytes) and actual size ("+t.byteLength+" bytes)."),1280790338!==t.getUint32(8)){const t=p(new Uint8Array(e,8,4));return void console.error("LWOLoader.parse: Invalid magic ID ("+t+") in LWO header.")}let s=12;for(;s<t.byteLength;)if(0===t.getUint8(s))s++;else{const i=t.getInt32(s),r=t.getInt32(s+4);switch(s+=8,i){case 1347310675:this.parsePoints(t,s,r);break;case 1397900883:this.parseSurfaceNames(e,s,r);break;case 1347374163:this.parsePolygons(t,s,r);break;case 1398100550:this.parseSurface(t,e,s,r);break;default:console.warn("Found unrecognised chunk type "+p(new Uint8Array(e,s-8,4))+" at "+s)}s+=r}return this.geometry.setAttribute("position",new H.TlE(this.vertices,3)),this.geometry.setAttribute("uv",new H.TlE(this.uvs,2)),this.geometry.setIndex(new H.TlE(this.indices,1)),this.geometry.computeVertexNormals(),new Ae(new H.Kj0(this.geometry,this.materials),this.sequenceIntervals)}}class Le{constructor(e,t=!1){this.path="",this.verbose=!1,this.animationClip=new we,this.lines=[],this.lineIndex=0,this.path=e,this.verbose=t,this.verbose&&console.log("Using verbose mode")}parse(e){if(this.lines=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((e=>e.trim())),"LWSC"!==this.lines[0])throw"Invalid start of file! Expected 'LWSC' in first line";const t=parseInt(this.lines[1],10);for(1!==t&&console.warn("Unexpected scene file version: "+t),this.lineIndex=2;this.lineIndex<this.lines.length;this.lineIndex++){let e=this.lines[this.lineIndex];if(!e)continue;const t=e.split(" ")[0];"FirstFrame"===t?this.parseFrameBlock():"AddNullObject"===t||"LoadObject"===t?(this.parseObjectBlock(),this.verbose&&console.log(this.animationClip.bodies[this.animationClip.bodies.length-1])):e.startsWith("PreviewFirstFrame ")||e.startsWith("PreviewLastFrame ")||e.startsWith("PreviewFrameStep ")}return this.verbose&&console.log(this.animationClip),this.animationClip}parseLine(e){return e.split(" ").filter((e=>""!==e))}parseFrameBlock(){for(;this.lineIndex<this.lines.length;this.lineIndex++){const e=this.lines[this.lineIndex];if(!e)return;const[t,i]=this.parseLine(e);if("FirstFrame"===t)this.animationClip.firstFrame=parseInt(i);else if("LastFrame"===t)this.animationClip.lastFrame=parseInt(i);else if("FrameStep"===t){const e=parseInt(i);1!==e&&console.error("Animation frameStep has unexpected value: "+e)}else"FramesPerSecond"===t?this.animationClip.framesPerSecond=parseInt(i):"PreviewFirstFrame"===t||"PreviewLastFrame"===t||"PreviewFrameStep"===t||console.warn("Unexpected key in frame block")}console.error("Parsing block reached content end")}parseObjectBlock(){const e=new Te;for(this.animationClip.bodies.push(e);this.lineIndex<this.lines.length;this.lineIndex++){let t=this.lines[this.lineIndex];if(!t)return;const[i,s]=this.parseLine(t);if("AddNullObject"===i||"LoadObject"===i)if("LoadObject"===i){const t=d(s);e.name=t.slice(0,t.length-".lwo".length),e.filename=this.path+t;const i=ct.getResource(e.filename);e.model=at.registerMesh(new Ce(this.path).parse(i))}else{if("AddNullObject"!==i)throw"Unexpected line: "+t;e.name=s,e.model=new H.ZAu}else if("ObjectMotion"===i){let t=this.lines[++this.lineIndex];const i=parseInt(t);t=this.lines[++this.lineIndex];const s=parseInt(t);this.lineIndex++;for(let t=0;t<s;t++){let s=this.lines[this.lineIndex+2*t];if(s.startsWith("EndBehavior"))break;const r=s.split(" ").map(Number);r.length!==i&&console.warn("Number of infos ("+r.length+") does not match if specified count ("+i+")"),s=this.lines[this.lineIndex+2*t+1];const n=parseInt(s.split(" ")[0]);e.setFrameAndFollowing(n,this.animationClip.lastFrame,r)}this.lineIndex+=2*s}else if("ParentObject"===i)e.parentObjInd=Number(s)-1,this.verbose&&console.log("parent obj ind is: "+e.parentObjInd);else if("ShowObject"===i||"LockedChannels"===i);else if("ShadowOptions"===i);else if("ObjDissolve"===i)if("(envelope)"==s){let t=this.lines[++this.lineIndex];const i=parseInt(t);1!==i&&console.error("Number of information channels for opacity is not 1, but: "+i),t=this.lines[++this.lineIndex];const s=parseInt(t);this.lineIndex++;for(let t=0;t<s;t++){let i=this.lines[this.lineIndex+2*t];if(i.startsWith("EndBehavior"))break;const s=1-Number(i);i=this.lines[this.lineIndex+2*t+1];const r=Number(i.split(" ")[0]);e.setOpacityAndFollowing(r,this.animationClip.lastFrame,s)}this.lineIndex+=2*s}else{const t=1-Number(s);e.setOpacityAndFollowing(0,this.animationClip.lastFrame,t)}else this.verbose&&console.warn("Unhandled line in object block: "+t+"; key: "+i+"; value: "+s)}return console.error("Parsing block reached content end"),e}}var Me,Pe,Ie;!function(e){e[e.aiPriorityTrain=0]="aiPriorityTrain",e[e.aiPriorityGetIn=1]="aiPriorityGetIn",e[e.aiPriorityCrystal=2]="aiPriorityCrystal",e[e.aiPriorityOre=3]="aiPriorityOre",e[e.aiPriorityRepair=4]="aiPriorityRepair",e[e.aiPriorityClearing=5]="aiPriorityClearing",e[e.aiPriorityDestruction=6]="aiPriorityDestruction",e[e.aiPriorityConstruction=7]="aiPriorityConstruction",e[e.aiPriorityReinforce=8]="aiPriorityReinforce",e[e.aiPriorityRecharge=9]="aiPriorityRecharge"}(Me||(Me={}));class Oe{constructor(e){this.activityKey=e}}class xe extends Oe{}xe.Stand=new xe("Activity_Stand");class _e extends class{constructor(e,t,i,s){this.group=new H.ZAu,this.superType=null,this.entityType=null,this.level=0,this.floorOffset=0,this.worldMgr=e,this.sceneMgr=t,this.superType=i,this.entityType=s}get stats(){return null}getPosition(){return this.group.position.clone()}getPosition2D(){return new H.FM8(this.group.position.x,this.group.position.z)}getHeading(){return this.group.rotation.y}onDiscover(){this.group.visible=!0}addToScene(e,t){e&&(this.group.position.copy(this.sceneMgr.getFloorPosition(e)),this.group.position.y+=this.floorOffset),null!=t&&this.group.rotateOnAxis(new H.Pa4(0,1,0),t),this.group.visible=this.surfaces.some((e=>e.discovered)),this.sceneMgr.scene.add(this.group)}removeFromScene(){this.sceneMgr.scene.remove(this.group)}get surfaces(){return[this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position)]}}{constructor(e,t,i,s,r){super(e,t,i,s),this.animationEntityType=null,this.poly=[],this.animation=null,this.animationTimeout=null,this.selectionFrame=null,this.pickSphere=null,this.carryJoint=null,this.depositJoint=null,this.getToolJoint=null,this.activity=null,this.radiusSq=0,r&&(this.animationEntityType=ct.getAnimationEntityType(r))}beamUp(){b.publishEvent(new O),this.changeActivity(),_e.moveUp(this,6*U.pM)}static moveUp(e,t){t>0?(t--,e.group.position.y+=U.pM/U.OK/2,setTimeout((()=>_e.moveUp(e,t)),1e3/U.OK)):e.removeFromScene()}changeActivity(e=this.getDefaultActivity(),t=null,i=null){if(this.activity===e||null===this.animationEntityType)return;this.activity=e;let s=e.activityKey.toLowerCase(),r=this.animationEntityType.activities.get(s);if(r||this.animationEntityType.activities.forEach(((e,t)=>{!r&&s.startsWith(t)&&(r=e)})),!(null==r?void 0:r.animation))return console.warn("Activity "+e.activityKey+" unknown or has no animation defined"),void console.log(this.animationEntityType.activities);t&&t.bind(this),this.animation=r.animation,this.animation.looping=!0,this.animationTimeout=v(this.animationTimeout),this.group.remove(...this.poly),this.poly=[];const n=this.carryJoint&&this.carryJoint.children||[];this.carryJoint=null,this.animation.bodies.forEach((e=>{let t=g(this.animationEntityType.highPoly,e.name);t||(t=g(this.animationEntityType.mediumPoly,e.name)),t||(t=e.model);const i=t.clone(!0);this.poly.push(i),e.name&&(e.name.equalsIgnoreCase(this.animationEntityType.carryNullName)?(this.carryJoint=i,n.length>0&&this.carryJoint.add(...n)):e.name.equalsIgnoreCase(this.animationEntityType.depositNullName)?this.depositJoint=i:e.name.equalsIgnoreCase(this.animationEntityType.toolNullName)&&(this.getToolJoint=i))})),this.animation.bodies.forEach(((e,t)=>{const i=this.poly[t],s=e.parentObjInd;null!=s?this.poly[s].add(i):this.group.add(i)}));const a=new H.aLr;(new H.ZzF).setFromObject(this.group).getBoundingSphere(a),this.radiusSq=a.radius*a.radius,this.animate(0,t,i)}animate(e,t,i){if(this.poly.length!==this.animation.bodies.length)throw"Cannot animate poly. Length differs from bodies length";this.animation.bodies.forEach(((t,i)=>{const s=this.poly[i];if(s.position.copy(t.relPos[e]),s.rotation.copy(t.relRot[e]),s.scale.copy(t.relScale[e]),s.hasOwnProperty("material")){const i=s.material,r=t.opacity[e];i&&void 0!==r&&(Array.isArray(i)?i:[i]).forEach((e=>{e.opacity=r,e.transparent=e.transparent||e.opacity<1}))}})),this.animationTimeout=v(this.animationTimeout);let s=e+1;if(s<=this.animation.lastFrame||!t||null!==i&&i>0){s>this.animation.lastFrame&&(s=this.animation.firstFrame);const e=1e3/this.animation.framesPerSecond*this.animation.transcoef;null!==i&&(i-=e);const r=this,n=null!==i?Math.max(0,Math.min(i,e)):e;this.animationTimeout=setTimeout((()=>r.animate(s,t,i)),n)}else t&&t()}getDefaultActivity(){return xe.Stand}createPickSphere(){if(this.pickSphere)return;const e=this.stats.PickSphere,t=e/2,i=new H.xo$(t,t,t),s=new H.vBJ({color:16776960,visible:!1});this.pickSphere=new H.Kj0(i,s),this.pickSphere.userData={selectable:this};const r=this.getPickSphereCenter();this.pickSphere.position.copy(r),this.group.add(this.pickSphere),this.createSelectionFrame(e,r)}getPickSphereCenter(){return this.getBoundingBoxCenter()}getBoundingBoxCenter(){const e=new H.Pa4;return(new H.ZzF).setFromObject(this.group).getCenter(e),e.sub(this.group.position),e.applyMatrix4((new H.yGw).makeScale(-1,1,1)),e}createSelectionFrame(e,t){const i=128,s=J(i,i);s.fillStyle="#0f0";const r=Math.round(50/e),n=21.333333333333332;s.fillRect(0,0,n,r),s.fillRect(0,0,r,n),s.fillRect(106.66666666666667,0,n,r),s.fillRect(i-r,0,r,n),s.fillRect(i-r,106.66666666666667,r,n),s.fillRect(106.66666666666667,i-r,n,r),s.fillRect(0,i-r,n,r),s.fillRect(0,106.66666666666667,r,n);const a=new H.ROQ(s.canvas),o=new H.xeV({map:a,depthTest:!1});this.selectionFrame=new H.jyi(o),this.selectionFrame.position.copy(t);const l=e;this.selectionFrame.scale.set(l,l,l),this.selectionFrame.visible=!1,this.group.add(this.selectionFrame)}}!function(e){e[e.INCOMPLETE=0]="INCOMPLETE",e[e.COMPLETE=1]="COMPLETE",e[e.CANCELED=2]="CANCELED"}(Pe||(Pe={}));class De{constructor(e){this.fulfiller=[],this.type=e,this.jobState=Pe.INCOMPLETE}assign(e){const t=this.fulfiller.indexOf(e);e&&-1===t&&this.fulfiller.push(e)}unassign(e){this.fulfiller.remove(e)}cancel(){this.jobState=Pe.CANCELED;const e=this.fulfiller;this.fulfiller=[],e.forEach((e=>e.stopJob()))}getRequiredTool(){return null}getRequiredTraining(){return null}isReadyToComplete(){return!0}onJobComplete(){this.jobState=Pe.COMPLETE}setActualWorkplace(e){}getCarryItem(){return null}getWorkActivity(){return null}getWorkDuration(e){return null}}class Ne extends De{}!function(e){e[e.DRILL=0]="DRILL",e[e.REINFORCE=1]="REINFORCE",e[e.CLEAR_RUBBLE=2]="CLEAR_RUBBLE",e[e.CARRY=3]="CARRY",e[e.MOVE=4]="MOVE",e[e.TRAIN=5]="TRAIN",e[e.GET_TOOL=6]="GET_TOOL",e[e.EAT=7]="EAT",e[e.COMPLETE_POWER_PATH=8]="COMPLETE_POWER_PATH"}(Ie||(Ie={}));class ke extends Ne{constructor(e){super(Ie.CARRY),this.actualTarget=null,this.item=e}getWorkplaces(){return this.item.getCarryTargets()}getPriorityIdentifier(){return this.item.getPriorityIdentifier()}setActualWorkplace(e){var t;this.item.setTargetSite(null===(t=e)||void 0===t?void 0:t.site),this.actualTarget=e}getCarryItem(){return this.item}getWorkActivity(){return this.actualTarget.getDropAction()}isReadyToComplete(){return this.actualTarget.canGatherItem()}onJobComplete(){super.onJobComplete();const e=this.actualTarget.targetLocation;this.fulfiller.forEach((t=>{t.group.lookAt(new H.Pa4(e.x,t.group.position.y,e.y)),t.dropItem()})),this.actualTarget.gatherItem(this.item)}}class Be extends xe{}Be.Route=new Be("Activity_Route"),Be.RunPanic=new Be("Activity_RunPanic"),Be.Drill=new Be("Activity_Drill"),Be.Walk=new Be("!Activity_Walk"),Be.Reinforce=new Be("Activity_Reinforce"),Be.Reverse=new Be("!Activity_Reverse"),Be.TurnLeft=new Be("!Activity_TurnLeft"),Be.TurnRight=new Be("!Activity_TurnRight"),Be.CantDo=new Be("!Activity_CantDo"),Be.Collect=new Be("Activity_Collect"),Be.Clear=new Be("Activity_Clear"),Be.Carry=new Be("Activity_Carry"),Be.CarryTurnLeft=new Be("!Activity_CarryTurnLeft"),Be.CarryTurnRight=new Be("!Activity_CarryTurnRight"),Be.CarryStand=new Be("Activity_CarryStand"),Be.Dynamite=new Be("Activity_Dynamite"),Be.Place=new Be("Activity_Place"),Be.Deposit=new Be("!Activity_Deposit"),Be.TeleportIn=new Be("Activity_TeleportIn"),Be.Repair=new Be("Activity_Repair"),Be.rest=new Be("Activity_rest"),Be.routeRubble=new Be("!Activity_routeRubble"),Be.CarryRubble=new Be("!Activity_CarryRubble"),Be.Eat=new Be("Activity_Eat"),Be.FireLaser=new Be("Activity_FireLaser"),Be.GetUp=new Be("!Activity_GetUp"),Be.ThrownByRockMonster=new Be("Activity_ThrownByRockMonster"),Be.Slip=new Be("Activity_Slip"),Be.Train=new Be("Activity_Train"),Be.Recharge=new Be("!Activity_Recharge"),Be.Waiting1=new Be("Activity_Waiting1"),Be.Waiting2=new Be("Activity_Waiting2"),Be.Waiting3=new Be("Activity_Waiting3"),Be.Waiting4=new Be("Activity_Waiting4"),Be.Hoverboard=new Be("Activity_Hoverboard"),Be.Standhoverboard=new Be("Activity_Standhoverboard"),Be.HitLefthoverboard=new Be("!Activity_HitLefthoverboard"),Be.HitRighthoverboard=new Be("!Activity_HitRighthoverboard"),Be.HitFronthoverboard=new Be("!Activity_HitFronthoverboard"),Be.HitBackhoverboard=new Be("!Activity_HitBackhoverboard"),Be.SMALLTRUCK=new Be("Activity_SMALLTRUCK"),Be.StandSMALLTRUCK=new Be("Activity_StandSMALLTRUCK"),Be.HitLeftSMALLTRUCK=new Be("!Activity_HitLeftSMALLTRUCK"),Be.HitRightSMALLTRUCK=new Be("!Activity_HitRightSMALLTRUCK"),Be.HitFrontSMALLTRUCK=new Be("!Activity_HitFrontSMALLTRUCK"),Be.HitBackSMALLTRUCK=new Be("!Activity_HitBackSMALLTRUCK"),Be.SMALLheli=new Be("Activity_SMALLheli"),Be.StandSMALLheli=new Be("Activity_StandSMALLheli"),Be.HitLeftSMALLheli=new Be("!Activity_HitLeftSMALLheli"),Be.HitRightSMALLheli=new Be("!Activity_HitRightSMALLheli"),Be.HitFrontSMALLheli=new Be("!Activity_HitFrontSMALLheli"),Be.HitBackSMALLheli=new Be("!Activity_HitBackSMALLheli"),Be.SMALLCAT=new Be("Activity_SMALLCAT"),Be.StandSMALLCAT=new Be("Activity_StandSMALLCAT"),Be.HitLeftSMALLCAT=new Be("!Activity_HitLeftSMALLCAT"),Be.HitRightSMALLCAT=new Be("!Activity_HitRightSMALLCAT"),Be.HitFrontSMALLCAT=new Be("!Activity_HitFrontSMALLCAT"),Be.HitBackSMALLCAT=new Be("!Activity_HitBackSMALLCAT"),Be.SMALLMLP=new Be("Activity_SMALLMLP"),Be.StandSMALLMLP=new Be("Activity_StandSMALLMLP"),Be.HitLeftSMALLMLP=new Be("!Activity_HitLeftSMALLMLP"),Be.HitRightSMALLMLP=new Be("!Activity_HitRightSMALLMLP"),Be.HitFrontSMALLMLP=new Be("!Activity_HitFrontSMALLMLP"),Be.HitBackSMALLMLP=new Be("!Activity_HitBackSMALLMLP"),Be.LARGECAT=new Be("Activity_LARGECAT"),Be.StandLARGECAT=new Be("Activity_StandLARGECAT"),Be.HitLeftLARGECAT=new Be("!Activity_HitLeftLARGECAT"),Be.HitRightLARGECAT=new Be("!Activity_HitRightLARGECAT"),Be.HitFrontLARGECAT=new Be("!Activity_HitFrontLARGECAT"),Be.HitBackLARGECAT=new Be("!Activity_HitBackLARGECAT"),Be.SMALLDIGGER=new Be("Activity_SMALLDIGGER"),Be.StandSMALLDIGGER=new Be("Activity_StandSMALLDIGGER");class Ue{constructor(e){this.targetLocation=e}isInArea(e){return!1}canGatherItem(){return!1}gatherItem(e){e.addToScene(null,null)}getDropAction(){return Be.Place}}class Fe extends xe{}Fe.Teleport=new Fe("Activity_Teleport"),Fe.Deposit=new Fe("Activity_Deposit"),Fe.Explode=new Fe("Activity_Explode"),Fe.Unpowered=new Fe("Activity_Unpowered");class We extends Ue{constructor(e){super(e)}canGatherItem(){return!0}gatherItem(e){e.addToScene(null,null)}getDropAction(){return Be.Place}isInvalid(){return!1}}class Ge extends We{constructor(e,t){super(e),this.site=t}gatherItem(e){this.site.addItem(e)}getDropAction(){return this.site.getDropAction()}isInvalid(){return this.site.complete}}class He extends We{constructor(e,t){super(e),this.building=t}canGatherItem(){return this.building.activity.activityKey===this.building.getDefaultActivity().activityKey}gatherItem(e){this.building.entityType===r.POWER_STATION||this.building.entityType===r.ORE_REFINERY?(this.building.carryJoint&&(this.building.carryJoint.add(e.group),e.group.position.set(0,0,0)),this.building.changeActivity(Fe.Deposit,(()=>{this.building.changeActivity(),this.building.carryJoint&&this.building.carryJoint.remove(e.group),He.addItemToStorage(e)}))):(e.removeFromScene(),He.addItemToStorage(e))}static addItemToStorage(e){switch(e.entityType){case r.CRYSTAL:G.numCrystal++;break;case r.ORE:G.numOre++}b.publishEvent(new ge)}getDropAction(){return this.building.getDropAction()}isInvalid(){return!this.building.isUsable()}}class Je extends _e{constructor(e,t,i,s=null){super(e,t,n.MATERIAL,i,s),this.targetBuildingTypes=[],this.priorityIdentifier=null,this.targets=[],this.targetSite=null,this.positionPathTarget=null,this.targetBuildingTypes=[r.TOOLSTATION]}getCarryTargets(){return this.updateTargets()}resetTarget(){this.targets=[],this.targetSite=null,this.updateTargets()}updateTargets(){if(this.targets.length<1){const e=G.buildingSites.filter((e=>e.needs(this.entityType)));if(e.length>0)this.targets=e.map((e=>new Ge(e.getRandomDropPosition(),e)));else{const e=G.getBuildingsByType(...this.getTargetBuildingTypes());e.length>0&&(this.targets=e.map((e=>new He(e.getDropPosition2D(),e))))}}else this.targets.some((e=>e.isInvalid()))&&this.resetTarget();return this.targets}onDiscover(){super.onDiscover(),G.materialsUndiscovered.remove(this),G.materials.push(this),b.publishEvent(new ce(this.createCarryJob()))}setTargetSite(e){var t,i;this.targetSite!==e&&(null===(t=this.targetSite)||void 0===t||t.unAssign(this),this.targetSite=e,null===(i=this.targetSite)||void 0===i||i.assign(this))}getPriorityIdentifier(){return this.priorityIdentifier}getTargetBuildingTypes(){return this.targetBuildingTypes}createCarryJob(){return new ke(this)}onAddToSite(){this.addToScene(null,null)}getPositionPathTarget(){const e=this.getPosition2D();return this.positionPathTarget&&this.positionPathTarget[0].targetLocation.equals(e)||(this.positionPathTarget=[new Ue(e)]),this.positionPathTarget}}class Ve extends Je{constructor(e,t){super(e,t,r.CRYSTAL);const i=ct.getResource("MiscAnims/Crystal/vlp_greencrystal.lwo"),s=at.registerMesh(new Ce("MiscAnims/Crystal/").parse(i));s.material.forEach((e=>{e.blending=H.WMw,e.depthWrite=!1,e.opacity=.5,e.transparent=e.opacity<1})),s.scale.set(1.75,1.75,1.75),this.group.add(s);const n=ct.getResource("World/Shared/Crystal.lwo"),a=at.registerMesh(new Ce("World/Shared/").parse(n));a.material.forEach((e=>{e.emissive=new H.Ilk(0,8,0),e.color=new H.Ilk(0,0,0),e.opacity=.9,e.transparent=e.opacity<1})),this.group.add(a),this.targetBuildingTypes=[r.POWER_STATION,r.TOOLSTATION],this.priorityIdentifier=Me.aiPriorityCrystal}get stats(){return ct.stats.PowerCrystal}}class je extends Oe{}je.Normal=new je("Normal"),je.TickDown=new je("TickDown");class Ye extends ke{constructor(e){super(e),this.color=10510432}getRequiredTraining(){return S.DEMOLITION}onJobComplete(){super.onJobComplete(),this.item.ignite()}}class Ke extends Je{constructor(e,t,i){super(e,t,r.DYNAMITE,"MiscAnims/Dynamite/Dynamite.ae"),this.targetSurface=i,this.priorityIdentifier=Me.aiPriorityDestruction,this.changeActivity()}getCarryTargets(){return this.targetSurface&&this.targetSurface.isExplodable()?this.targetSurface.getDigPositions().map((e=>new We(e))):G.getBuildingsByType(r.TOOLSTATION).map((e=>e.getDropPosition2D())).map((e=>new We(e)))}ignite(){const e=this.targetSurface.getCenterWorld();e.y=this.group.position.y,this.group.lookAt(e),this.changeActivity(je.TickDown,(()=>{this.removeFromScene(),this.targetSurface.collapse()}))}getDefaultActivity(){return je.Normal}createCarryJob(){return new Ye(this)}}class qe extends Je{constructor(e,t){super(e,t,r.ORE);const i=ct.getResource("MiscAnims/Ore/Ore1st.lwo"),s=at.registerMesh(new Ce("MiscAnims/Ore/").parse(i));this.group.add(s),this.targetBuildingTypes=[r.ORE_REFINERY,r.TOOLSTATION],this.priorityIdentifier=Me.aiPriorityOre}get stats(){return ct.stats.Ore}}class ze extends Ne{constructor(e){super(Ie.CLEAR_RUBBLE),this.surface=e}getRequiredTool(){return o.SHOVEL}getWorkplaces(){const e=this.surface.rubblePositions;return e.length>0?[new Ue(e[0])]:[]}onJobComplete(){this.fulfiller.forEach((e=>e.changeActivity())),this.surface.reduceRubble(),this.fulfiller.forEach((e=>e.jobWorkplaces=this.getWorkplaces())),this.surface.hasRubble()||super.onJobComplete()}getPriorityIdentifier(){return Me.aiPriorityClearing}getWorkActivity(){return Be.Clear}}class Ze extends Ne{constructor(e){super(Ie.DRILL),this.color=10526880,this.surface=e}getRequiredTool(){return o.DRILL}getWorkplaces(){return this.surface.getDigPositions().map((e=>new Ue(e)))}onJobComplete(){this.surface.onDrillComplete(this.fulfiller.last().getPosition2D())&&super.onJobComplete()}getPriorityIdentifier(){return Me.aiPriorityDestruction}getWorkActivity(){return Be.Drill}getWorkDuration(e){const t=new Map;this.fulfiller.forEach((e=>{t.getOrUpdate(e.entityType,(()=>({drillTime:1e3*e.stats[this.surface.surfaceType.statsDrillName][e.level],count:0}))).count++}));const i=t.get(e.entityType),s=(null==i?void 0:i.drillTime)/((null==i?void 0:i.count)||1)||null;return s||console.warn("According to cfg this entity cannot drill this material"),s}}class Xe extends Ne{constructor(e){super(Ie.REINFORCE),this.color=6332512,this.surface=e}getWorkplaces(){return this.surface.getDigPositions().map((e=>new Ue(e)))}onJobComplete(){super.onJobComplete(),this.surface.reinforce()}getPriorityIdentifier(){return Me.aiPriorityReinforce}getWorkActivity(){return Be.Reinforce}getWorkDuration(e){return 2700}}var $e,Qe,et,tt,it=H.M8C.degToRad;class st{constructor(e,t,i,s,r){this.containedOres=0,this.containedCrystals=0,this.heightOffset=null,this.discovered=!1,this.selected=!1,this.reinforced=!1,this.drillJob=null,this.reinforceJob=null,this.dynamiteJob=null,this.clearRubbleJob=null,this.surfaceRotation=0,this.seamLevel=0,this.fallinTimeout=null,this.fallinGrp=null,this.animationTimeout=null,this.wallType=null,this.mesh=null,this.needsMeshUpdate=!1,this.topLeftHeightOffset=0,this.topRightHeightOffset=0,this.bottomLeftHeightOffset=0,this.bottomRightHeightOffset=0,this.rubblePositions=[],this.building=null,this.fence=null,this.hasPower=!1,this.terrain=e,this.worldMgr=this.terrain.worldMgr,this.sceneMgr=this.terrain.sceneMgr,this.surfaceType=t,t!==T.CRYSTAL_SEAM&&t!==T.ORE_SEAM||(this.seamLevel=4),this.x=i,this.y=s,this.heightOffset=r}discover(){if(this.setDiscovered(),this.needsMeshUpdate=!0,!this.surfaceType.floor)return!1;const e=[],t=[];for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){if(0===i&&0===s)continue;const r=this.terrain.getSurface(this.x+i,this.y+s);0!==i&&0!==s||!r.surfaceType.floor?t.push(r):e.push(r)}let i=!1,s=0;for(;e.length>0;){s++;const r=e.shift();r.setDiscovered();for(let s=-1;s<=1;s++)for(let n=-1;n<=1;n++){if(0===s&&0===n)continue;const a=r.terrain.getSurface(r.x+s,r.y+n);0!==s&&0!==n||!a.surfaceType.floor||a.discovered?t.push(a):(e.push(a),i=!0)}}return t.forEach((e=>{e.setDiscovered(),e.isSupported()||e.collapse()})),console.log("surface discover handled "+s+" floors and "+t.length+" others"),i}setDiscovered(){this.discovered||G.discoverSurface(this),this.discovered=!0,this.needsMeshUpdate=!0}onDrillComplete(e){if(this.seamLevel>0){this.seamLevel--;const t=(new H.FM8).copy(e).sub(this.getCenterWorld2D()).multiplyScalar(.3+y(3)/10).rotateAround(new H.FM8(0,0),it(-10+y(20))).add(e);if(this.surfaceType===T.CRYSTAL_SEAM){const e=this.worldMgr.placeMaterial(new Ve(this.worldMgr,this.sceneMgr),t);b.publishEvent(new ye(e.getPosition()))}else this.surfaceType===T.ORE_SEAM&&(this.worldMgr.placeMaterial(new qe(this.worldMgr,this.sceneMgr),t),b.publishEvent(new me))}return!(this.seamLevel>0||(this.collapse(),0))}collapse(){this.cancelJobs(),this.fallinTimeout=v(this.fallinTimeout),this.surfaceType=T.RUBBLE4,this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=4,this.needsMeshUpdate=!0,this.discover()&&b.publishEvent(new pe),this.dropContainedOre(this.containedOres-4);for(let e=0;e<this.containedCrystals;e++){const e=this.worldMgr.placeMaterial(new Ve(this.worldMgr,this.sceneMgr),this.getRandomPosition());b.publishEvent(new ye(e.getPosition()))}for(let e=this.x-1;e<=this.x+1;e++)for(let t=this.y-1;t<=this.y+1;t++)if(e!==this.x||t!==this.y){const i=this.terrain.getSurface(e,t);i.needsMeshUpdate=!0,i.isSupported()||i.collapse()}this.terrain.updateSurfaceMeshes(),this.terrain.floorGroup.updateWorldMatrix(!0,!0)}dropContainedOre(e){for(let t=0;t<e&&this.containedOres>0;t++)this.containedOres--,this.worldMgr.placeMaterial(new qe(this.worldMgr,this.sceneMgr),this.getRandomPosition()),b.publishEvent(new me)}getRandomPosition(){return new H.FM8(this.x*U.pM+U.pM/2+E()*y(U.pM/4),this.y*U.pM+U.pM/2+E()*y(U.pM/4))}cancelJobs(){this.drillJob=st.safeRemoveJob(this.drillJob),this.reinforceJob=st.safeRemoveJob(this.reinforceJob),this.dynamiteJob=st.safeRemoveJob(this.dynamiteJob),this.clearRubbleJob=st.safeRemoveJob(this.clearRubbleJob),this.updateJobColor()}static safeRemoveJob(e){return e&&b.publishEvent(new ue(e)),null}reduceRubble(){this.rubblePositions.shift(),this.surfaceType===T.RUBBLE4?this.surfaceType=T.RUBBLE3:this.surfaceType===T.RUBBLE3?this.surfaceType=T.RUBBLE2:this.surfaceType===T.RUBBLE2?this.surfaceType=T.RUBBLE1:this.surfaceType===T.RUBBLE1&&(this.surfaceType=T.GROUND),this.dropContainedOre(this.containedOres-this.rubblePositions.length),this.updateTexture(),this.selected&&b.publishEvent(new O(M.SURFACE,this))}isSupported(){if(this.surfaceType.floor)return!0;const e=this.terrain.getSurface(this.x-1,this.y),t=this.terrain.getSurface(this.x-1,this.y-1),i=this.terrain.getSurface(this.x,this.y-1),s=this.terrain.getSurface(this.x+1,this.y-1),r=this.terrain.getSurface(this.x+1,this.y),n=this.terrain.getSurface(this.x+1,this.y+1),a=this.terrain.getSurface(this.x,this.y+1),o=this.terrain.getSurface(this.x-1,this.y+1);function l(e,t,i){return!(e.discovered&&t.discovered&&i.discovered&&(e.surfaceType.floor||t.surfaceType.floor||i.surfaceType.floor))}return l(e,t,i)||l(i,s,r)||l(r,n,a)||l(a,o,e)}updateMesh(e=!0){if(!e&&!this.needsMeshUpdate)return;this.needsMeshUpdate=!1;const t=new H.Pa4(this.x,0,this.y),i=new H.Pa4(this.x+1,0,this.y),s=new H.Pa4(this.x,0,this.y+1),r=new H.Pa4(this.x+1,0,this.y+1),n=this.terrain.getSurface(this.x-1,this.y),a=this.terrain.getSurface(this.x-1,this.y-1),o=this.terrain.getSurface(this.x,this.y-1),l=this.terrain.getSurface(this.x+1,this.y-1),h=this.terrain.getSurface(this.x+1,this.y),c=this.terrain.getSurface(this.x+1,this.y+1),u=this.terrain.getSurface(this.x,this.y+1),d=this.terrain.getSurface(this.x-1,this.y+1);function g(e,t,i){return!(e.discovered&&t.discovered&&i.discovered&&(e.surfaceType.floor||t.surfaceType.floor||i.surfaceType.floor))}this.discovered?this.surfaceType.floor&&this.neighbors.some((e=>e.surfaceType.floor&&e.discovered))||(g(n,a,o)&&(t.y=1),g(o,l,h)&&(i.y=1),g(h,c,u)&&(r.y=1),g(u,d,n)&&(s.y=1)):(t.y=1,i.y=1,r.y=1,s.y=1);let p=t.y+i.y+r.y+s.y;p===$.WALL&&t.y===r.y&&(p=$.WEIRD_CREVICE),this.wallType!==p&&(this.wallType=p,this.updateGeometry(t,r,i,s,a,o,n,l,h,c,u,d),this.wallType!==$.WALL&&this.cancelReinforceJobs()),this.updateTexture(),this.updateJobColor(),this.updateGraphWalk()}updateGraphWalk(){const e=this.getGraphWalkWeight();for(let t=0;t<3;t++)for(let i=0;i<3;i++)this.terrain.graphWalk.grid[3*this.x+t][3*this.y+i].weight=e}cancelReinforceJobs(){this.reinforceJob=st.safeRemoveJob(this.reinforceJob),this.updateJobColor()}updateTexture(){let e=this.terrain.textureSet.texturebasename;this.discovered?this.surfaceType===T.POWER_PATH?e+=this.updatePowerPathTexture():!this.surfaceType.shaping&&this.neighbors.some((e=>e.discovered&&e.surfaceType.floor))?this.surfaceType===T.POWER_PATH_BUILDING&&this.hasPower?e+="66":e+=this.surfaceType.matIndex.toString():this.wallType===$.WEIRD_CREVICE?e+="77":(this.wallType===$.CORNER?e+="5":this.wallType===$.INVERTED_CORNER?e+="3":this.reinforced?e+="2":e+="0",e+=this.surfaceType.shaping?this.surfaceType.matIndex:T.SOLID_ROCK.matIndex):e+="70",e+=".bmp",this.forEachMaterial((e=>{var t;return null===(t=e.map)||void 0===t?void 0:t.dispose()}));const t=ct.getTexture(e);t.center.set(.5,.5),t.rotation=this.surfaceRotation,this.forEachMaterial((e=>e.map=t))}updatePowerPathTexture(){this.surfaceRotation=0;const e=this.terrain.getSurface(this.x-1,this.y).isPath(),t=this.terrain.getSurface(this.x,this.y-1).isPath(),i=this.terrain.getSurface(this.x+1,this.y).isPath(),s=this.terrain.getSurface(this.x,this.y+1).isPath(),r=(e?1:0)+(t?1:0)+(i?1:0)+(s?1:0);return 0===r||1===r?(e&&(this.surfaceRotation=-Math.PI/2),t&&(this.surfaceRotation=Math.PI),i&&(this.surfaceRotation=Math.PI/2),this.hasPower?"75":"65"):2===r?e===i?(this.surfaceRotation=e?Math.PI/2:0,this.hasPower?"72":"62"):(e&&s&&(this.surfaceRotation=-Math.PI/2),e&&t&&(this.surfaceRotation=Math.PI),t&&i&&(this.surfaceRotation=Math.PI/2),this.hasPower?"73":"63"):3===r?(t||(this.surfaceRotation=-Math.PI/2),i||(this.surfaceRotation=Math.PI),s||(this.surfaceRotation=Math.PI/2),this.hasPower?"74":"64"):this.hasPower?"71":"60"}forEachMaterial(e){var t;(null===(t=this.mesh)||void 0===t?void 0:t.material)&&(Array.isArray(this.mesh.material)?this.mesh.material:[this.mesh.material]).forEach((t=>e(t)))}updateGeometry(e,t,i,s,r,n,a,o,l,h,c,u){var d,g;function p(...e){let t=0,i=0;return e.map((e=>e.heightOffset)).filter(Boolean).forEach((e=>{t+=e,i++})),t/i}this.mesh&&this.terrain.floorGroup.remove(this.mesh),null===(g=null===(d=this.mesh)||void 0===d?void 0:d.geometry)||void 0===g||g.dispose(),this.topLeftHeightOffset=p(r,n,this,a)*U.ED,this.topRightHeightOffset=p(n,o,l,this)*U.ED,this.bottomRightHeightOffset=p(this,l,h,c)*U.ED,this.bottomLeftHeightOffset=p(a,this,c,u)*U.ED;const m=ee.create(this.wallType,e,t,i,s,e.y+this.topLeftHeightOffset,i.y+this.topRightHeightOffset,t.y+this.bottomRightHeightOffset,s.y+this.bottomLeftHeightOffset);this.mesh=new H.Kj0(m,new H.xoR({shininess:0})),this.mesh.userData={selectable:this,surface:this},this.terrain.floorGroup.add(this.mesh),this.terrain.floorGroup.updateWorldMatrix(!0,!0)}getSelectionType(){return M.SURFACE}select(){return!(!this.surfaceType.selectable||this.wallType===$.INVERTED_CORNER||this.wallType===$.WEIRD_CREVICE||this.selected||!this.discovered||(this.selected=!0,this.forEachMaterial((e=>e.color.setHex(6316192))),console.log("Surface selected at "+this.x+"/"+this.y),0))}deselect(){this.selected&&(this.selected=!1,this.updateJobColor())}getSelectionCenter(){return null}updateJobColor(){var e,t,i;const s=(null===(e=this.dynamiteJob)||void 0===e?void 0:e.color)||(null===(t=this.reinforceJob)||void 0===t?void 0:t.color)||(null===(i=this.drillJob)||void 0===i?void 0:i.color)||16777215;this.forEachMaterial((e=>e.color.setHex(s)))}hasRubble(){return this.rubblePositions.length>0}isPath(){return this.surfaceType===T.POWER_PATH||this.surfaceType===T.POWER_PATH_BUILDING}isWalkable(){var e;return this.surfaceType.floor&&this.discovered&&this.surfaceType!==T.LAVA&&this.surfaceType!==T.WATER&&!(null===(e=this.building)||void 0===e?void 0:e.blocksPathSurface)}isDrillable(){return this.surfaceType.drillable&&this.discovered&&(this.wallType===$.WALL||this.wallType===$.CORNER)}isDrillableHard(){return this.surfaceType.drillableHard&&this.discovered&&(this.wallType===$.WALL||this.wallType===$.CORNER)}isReinforcable(){return this.surfaceType.reinforcable&&this.discovered&&this.wallType===$.WALL&&!this.reinforced}isExplodable(){return this.surfaceType.explodable&&this.discovered&&(this.wallType===$.WALL||this.wallType===$.CORNER)}isDigable(){return this.isDrillable()||this.isExplodable()}getDigPositions(){const e=[];return this.terrain.getSurface(this.x-1,this.y).isWalkable()&&e.push(new H.FM8(this.x*U.pM-1,this.y*U.pM+U.pM/2)),this.terrain.getSurface(this.x,this.y-1).isWalkable()&&e.push(new H.FM8(this.x*U.pM+U.pM/2,this.y*U.pM-1)),this.terrain.getSurface(this.x+1,this.y).isWalkable()&&e.push(new H.FM8(this.x*U.pM+U.pM+1,this.y*U.pM+U.pM/2)),this.terrain.getSurface(this.x,this.y+1).isWalkable()&&e.push(new H.FM8(this.x*U.pM+U.pM/2,this.y*U.pM+U.pM+1)),e}reinforce(){this.reinforced=!0,this.cancelReinforceJobs(),this.fallinTimeout=v(this.fallinTimeout),this.updateTexture()}getCenterWorld2D(){return new H.FM8(this.x,this.y).addScalar(.5).multiplyScalar(U.pM)}getCenterWorld(){const e=this.getCenterWorld2D();return new H.Pa4(e.x,this.sceneMgr.getTerrainHeight(e.x,e.y),e.y)}setFallinLevel(e){if(e<1)return;let t,i;this.surfaceType.floor?(t=this.terrain.findFallInOrigin(this.x,this.y),i=[this.x,this.y]):(t=[this.x,this.y],i=this.terrain.findFallInTarget(this.x,this.y)),t&&i&&this.terrain.getSurface(t[0],t[1]).scheduleFallin(i[0],i[1])}scheduleFallin(e,t){this.fallinTimeout=setTimeout((()=>{this.createFallin(e,t),this.scheduleFallin(e,t)}),1e3*(30+y(60)))}createFallin(e,t){const i=this.terrain.getSurface(e,t).getCenterWorld();b.publishEvent(new Ee(i));const s=ct.getResource("MiscAnims/RockFall/Rock3Sides.lws"),r=new Le("MiscAnims/RockFall/").parse(s);this.fallinGrp=new H.ZAu,this.fallinGrp.position.copy(i);const n=this.x-e,a=t-this.y;this.fallinGrp.rotateOnAxis(new H.Pa4(0,1,0),Math.atan2(a,n)+Math.PI/2),this.sceneMgr.scene.add(this.fallinGrp);const o=[];r.bodies.forEach((e=>{const t=e.model.clone(!0);o.push(t)})),r.bodies.forEach(((e,t)=>{const i=o[t],s=e.parentObjInd;null!=s?o[s].add(i):this.fallinGrp.add(i)})),this.animate(o,r,0),this.terrain.getSurface(e,t).makeRubble()}animate(e,t,i){if(e.length!==t.bodies.length)throw"Cannot animate poly. Length differs from bodies length";if(t.bodies.forEach(((t,s)=>{const r=e[s];if(r.position.copy(t.relPos[i]),r.rotation.copy(t.relRot[i]),r.scale.copy(t.relScale[i]),r.hasOwnProperty("material")){const e=r.material,s=t.opacity[i];e&&void 0!==s&&(Array.isArray(e)?e:[e]).forEach((e=>{e.opacity=s,e.transparent=e.transparent||e.opacity<1}))}})),this.animationTimeout=null,i+1>t.lastFrame&&!t.looping)this.sceneMgr.scene.remove(this.fallinGrp),this.fallinGrp=null;else{let s=i+1;s>t.lastFrame&&(s=t.firstFrame);const r=this;this.animationTimeout=setTimeout((()=>r.animate(e,t,s)),1e3/t.framesPerSecond*t.transcoef)}}dispose(){var e,t;this.fallinTimeout=v(this.fallinTimeout),this.forEachMaterial((e=>e.dispose())),null===(t=null===(e=this.mesh)||void 0===e?void 0:e.geometry)||void 0===t||t.dispose()}getFloorHeight(e,t){const i=e/U.pM-this.x,s=t/U.pM-this.y,r=st.interpolate(this.topLeftHeightOffset,this.topRightHeightOffset,i),n=st.interpolate(this.bottomLeftHeightOffset,this.bottomRightHeightOffset,i);return st.interpolate(r,n,s)*U.pM}static interpolate(e,t,i){return e+i*(t-e)}get neighbors(){return[this.terrain.getSurface(this.x-1,this.y),this.terrain.getSurface(this.x,this.y-1),this.terrain.getSurface(this.x+1,this.y),this.terrain.getSurface(this.x,this.y+1)]}makeRubble(e=0){this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=e,this.surfaceType=T.RUBBLE4,this.updateTexture()}setBuilding(e){this.building=e,this.updateGraphWalk()}getGraphWalkWeight(){return this.isWalkable()?this.hasRubble()?4:1:0}setHasPower(e,t){this.hasPower!==e&&(this.hasPower=e,this.updateTexture(),t&&this.neighbors.forEach((i=>i.isPath()&&i.setHasPower(e,t))))}canPlaceFence(){return this.surfaceType.canCarryFence&&!this.building&&!this.fence&&[1,2].some((e=>!!(this.terrain.getSurface(this.x-e,this.y).building||this.terrain.getSurface(this.x,this.y-e).building||this.terrain.getSurface(this.x+e,this.y).building||this.terrain.getSurface(this.x,this.y+e).building||this.terrain.getSurface(this.x-e,this.y).fence||this.terrain.getSurface(this.x,this.y-e).fence||this.terrain.getSurface(this.x+e,this.y).fence||this.terrain.getSurface(this.x,this.y+e).fence)))}createDrillJob(){return this.drillJob||(this.drillJob=new Ze(this),this.updateJobColor(),b.publishEvent(new ce(this.drillJob))),this.drillJob}createReinforceJob(){return this.reinforceJob||(this.reinforceJob=new Xe(this),this.updateJobColor(),b.publishEvent(new ce(this.reinforceJob))),this.reinforceJob}createDynamiteJob(){if(!this.dynamiteJob){const e=G.getClosestBuildingByType(this.getCenterWorld(),r.TOOLSTATION);if(!e)throw"Could not find toolstation to spawn dynamite";const t=new Ke(this.worldMgr,this.sceneMgr,this);t.addToScene(e.getDropPosition2D(),e.getHeading()),this.dynamiteJob=new Ye(t),this.updateJobColor(),b.publishEvent(new ce(this.dynamiteJob))}return this.dynamiteJob}createClearRubbleJob(){return this.clearRubbleJob||(this.clearRubbleJob=new ze(this),this.updateJobColor(),b.publishEvent(new ce(this.clearRubbleJob))),this.clearRubbleJob}}class rt{constructor(e,t){this.target=null,this.locations=[],this.lengthSq=0,this.target=e,this.locations=Array.isArray(t)?t:[t];for(let e=0;e<this.locations.length-1;e++){const t=this.locations[e],i=this.locations[e+1];this.lengthSq+=t.distanceToSquared(i)}}addLocation(e){return this.locations.push(e),this.locations.length>1&&(this.lengthSq+=this.locations[this.locations.length-2].distanceToSquared(e)),this}get targetPosition(){return this.locations[this.locations.length-1]||null}get firstLocation(){return this.locations[0]||null}}class nt{constructor(e,t){this.textureSet={},this.width=0,this.height=0,this.surfaces=[],this.floorGroup=new H.ZAu,this.roofGroup=new H.ZAu,this.graphWalk=null,this.cachedPaths=new Map,this.worldMgr=e,this.sceneMgr=t,this.floorGroup.scale.setScalar(U.pM),this.roofGroup.scale.setScalar(U.pM),this.roofGroup.visible=!1}getSurfaceFromWorld(e){return this.getSurfaceFromWorldXZ(e.x,e.z)}getSurfaceFromWorld2D(e){return this.getSurfaceFromWorldXZ(e.x,e.y)}getSurfaceFromWorldXZ(e,t){return this.getSurface(e/U.pM,t/U.pM)}getSurface(e,t){return e=Math.floor(e),t=Math.floor(t),this.getSurfaceOrNull(e,t)||new st(this,T.SOLID_ROCK,e,t,0)}getSurfaceOrNull(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height?this.surfaces[e][t]:null}updateSurfaceMeshes(e=!1){this.forEachSurface((t=>t.updateMesh(e))),this.floorGroup.updateWorldMatrix(!0,!0),this.resetGraphWalk()}resetGraphWalk(){this.graphWalk.init(),this.cachedPaths.clear(),console.log("Cached paths cleared")}findPath(e,t){const i=t.targetLocation,s=Math.floor(3*e.x/U.pM),r=Math.floor(3*e.y/U.pM),n=Math.floor(3*i.x/U.pM),a=Math.floor(3*i.y/U.pM);if(s===n&&r===a)return new rt(t,i);const o=s+"/"+r+" -> "+n+"/"+a,l=this.cachedPaths.get(o);return l?l.addLocation(i):this.searchPath(s,r,n,a,t,o)}searchPath(e,t,i,s,r,n){const a=this.graphWalk.grid[e][t],o=this.graphWalk.grid[i][s],l=re.search(this.graphWalk,a,o).map((e=>nt.gridNodeToWorldPos(e)));return l.length<1?null:(l.pop(),l.push(r.targetLocation),this.cachedPaths.set(n,new rt(r,l.slice(0,-1))),new rt(r,l))}static gridNodeToWorldPos(e){return new H.FM8(Math.random(),Math.random()).divideScalar(2).add(e).multiplyScalar(U.pM/3)}findFallInOrigin(e,t){const i=this.getSurface(e-1,t);if(i.isReinforcable())return[i.x,i.y];const s=this.getSurface(e,t-1);if(s.isReinforcable())return[s.x,s.y];const r=this.getSurface(e+1,t);if(r.isReinforcable())return[r.x,r.y];const n=this.getSurface(e,t+1);if(n.isReinforcable())return[n.x,n.y];const a=this.getSurface(e-1,t);if(a.isDigable())return[a.x,a.y];const o=this.getSurface(e,t-1);if(o.isDigable())return[o.x,o.y];const l=this.getSurface(e+1,t);if(l.isDigable())return[l.x,l.y];const h=this.getSurface(e,t+1);return h.isDigable()?[h.x,h.y]:null}findFallInTarget(e,t){const i=this.getSurface(e-1,t);if(i.isWalkable())return[i.x,i.y];const s=this.getSurface(e,t-1);if(s.isWalkable())return[s.x,s.y];const r=this.getSurface(e+1,t);if(r.isWalkable())return[r.x,r.y];const n=this.getSurface(e,t+1);return n.isWalkable()?[n.x,n.y]:null}dispose(){this.forEachSurface((e=>e.dispose()))}forEachSurface(e){var t;null===(t=this.surfaces)||void 0===t||t.forEach((t=>t.forEach((t=>e(t)))))}countDiggables(){let e=0;return this.forEachSurface((t=>e+=t.isDigable()?1:0)),e}countCrystals(){let e=0;return this.forEachSurface((t=>e+=t.containedCrystals)),e}countOres(){let e=0;return this.forEachSurface((t=>e+=t.containedOres)),e}}!function(e){e[e.NONE=0]="NONE",e[e.RUBBLE=1]="RUBBLE",e[e.POWER_PATH=2]="POWER_PATH"}($e||($e={})),function(e){e[e.WALL=0]="WALL",e[e.CAVERN_EXPOSED=1]="CAVERN_EXPOSED",e[e.CAVERN_HIDDEN=2]="CAVERN_HIDDEN",e[e.SLUG_HOLE_EXPOSED=3]="SLUG_HOLE_EXPOSED",e[e.SLUG_HOLE_HIDDEN=4]="SLUG_HOLE_HIDDEN"}(Qe||(Qe={}));class at{constructor(e){this.maxFps=30,this.debugHelper=new Z,this.renderer=new H.CP7({antialias:!0,canvas:e}),this.renderer.setClearColor(0),this.camera=new H.cPb(30,e.width/e.height,.1,5e3),this.controls=new q.o(this.camera,this.renderer.domElement),this.controls.mouseButtons={LEFT:null,MIDDLE:H.RsA.ROTATE,RIGHT:H.RsA.PAN},this.controls.listenToKeyEvents(this.renderer.domElement),this.controls.keyPanSpeed=20*this.controls.keyPanSpeed,this.buildMarker=new ie,b.registerEventListener(s.COMMAND_CANCEL_BUILD_MODE,(()=>{G.buildModeSelection=null,this.buildMarker.hideAllMarker()}))}selectEntitiesByRay(e,t){const i=new H.iMs;i.setFromCamera({x:e,y:t},this.camera);let s=i.intersectObjects(G.raiders.map((e=>e.pickSphere)));s.length<1&&(s=i.intersectObjects(G.buildings.map((e=>e.pickSphere)))),s.length<1&&this.terrain&&(s=i.intersectObjects(this.terrain.floorGroup.children));const r=[];if(s.length>0){const e=s[0].object.userData;if(e&&e.hasOwnProperty("selectable")){const t=e.selectable;t&&r.push(t)}}G.selectEntities(r)}selectEntitiesInFrustum(e,t,i,s){const r=new H.Pa4(e,t,.5),n=new H.Pa4(i,s,.5);r.x===n.x&&(n.x+=Number.EPSILON),r.y===n.y&&(n.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld();const a=new H.Pa4;a.copy(r),a.x=Math.min(r.x,n.x),a.y=Math.max(r.y,n.y),n.x=Math.max(r.x,n.x),n.y=Math.min(r.y,n.y);const o=new H.Pa4,l=new H.Pa4,h=new H.Pa4,c=new H.Pa4,u=new H.Pa4;o.setFromMatrixPosition(this.camera.matrixWorld),l.copy(a),h.set(n.x,a.y,0),c.copy(n),u.set(a.x,n.y,0),l.unproject(this.camera),h.unproject(this.camera),c.unproject(this.camera),u.unproject(this.camera);const d=new H.Pa4,g=new H.Pa4,p=new H.Pa4;d.copy(l).sub(o),g.copy(h).sub(o),p.copy(c).sub(o),d.normalize(),g.normalize(),p.normalize();const m=Number.MAX_VALUE;d.multiplyScalar(m),g.multiplyScalar(m),p.multiplyScalar(m),d.add(o),g.add(o),p.add(o);const f=new H.iWj,y=f.planes;y[0].setFromCoplanarPoints(o,l,h),y[1].setFromCoplanarPoints(o,h,c),y[2].setFromCoplanarPoints(c,u,o),y[3].setFromCoplanarPoints(u,l,o),y[4].setFromCoplanarPoints(h,c,u),y[5].setFromCoplanarPoints(p,g,d),y[5].normal.multiplyScalar(-1);let E=G.raiders.filter((e=>f.containsPoint(e.getSelectionCenter())));E.length<1&&(E=G.buildings.filter((e=>f.containsPoint(e.getSelectionCenter())))),G.selectEntities(E)}setupScene(e,t){this.scene=new H.xsS;const i=ct.cfg("Main","AmbientRGB")||[10,10,10],s=Math.min(255,Math.max(0,...i)),r=i.map((e=>e/(s||1))),n=new H.Ilk(r[0],r[1],r[2]);this.ambientLight=new H.Mig(n,.4),this.scene.add(this.ambientLight),this.cursorTorchlight=new H.cek(16777215,1.5,4,1),this.cursorTorchlight.distance*=U.pM,this.scene.add(this.cursorTorchlight),this.scene.add(this.buildMarker.group),this.terrain=class{static loadTerrain(e,t,i){var s,r,n,a,o,l,h;const c=e.blockSize;c!==U.pM&&console.error("Unexpected tile size in level configuration: "+c);const u=new nt(t,i),d=e.textureSet[1];u.textureSet=ct.cfg("Textures",d);const g=ct.getResource(e.terrainMap);u.width=g.width,u.height=g.height;const p=null===(s=ct.getResource(e.pathMap))||void 0===s?void 0:s.level,m=null===(r=ct.getResource(e.surfaceMap))||void 0===r?void 0:r.level,f=null===(n=ct.getResource(e.predugMap))||void 0===n?void 0:n.level,y=null===(a=ct.getResource(e.cryOreMap))||void 0===a?void 0:a.level,E=null===(o=ct.getResource(e.fallinMap))||void 0===o?void 0:o.level,v=null===(l=ct.getResource(e.erodeMap))||void 0===l?void 0:l.level;null===(h=ct.getResource(e.blockPointersMap))||void 0===h||h.level;for(let e=0;e<g.level.length;e++)for(let t=0;t<g.level[e].length;t++){u.surfaces[t]=u.surfaces[t]||[];const i=g.level[e][t];let s=T.getByNum(i);const r=f[e][t];r===Qe.CAVERN_EXPOSED?s===T.GROUND||s===T.DIRT||s===T.POWER_PATH_BUILDING?s=T.GROUND:s!==T.WATER&&s!==T.LAVA&&console.warn("Unexpected cavern surface type: "+s.name):r===Qe.SLUG_HOLE_EXPOSED||r===Qe.SLUG_HOLE_HIDDEN?s=T.SLUG_HOLE:r!==Qe.WALL&&r!==Qe.CAVERN_HIDDEN&&console.warn("Unexpected predug level: "+r);const n=p&&s.floor?p[e][t]:$e.NONE;n===$e.RUBBLE?s=T.RUBBLE4:n===$e.POWER_PATH?s=T.POWER_PATH:n!==$e.NONE&&console.warn("Unexpected path map level: "+n);const a=new st(u,s,t,e,m[e][t]);if(y){const i=y[e][t];i%2==1?a.containedCrystals=(i+1)/2:a.containedOres=i/2}u.surfaces[t].push(a)}u.forEachSurface((e=>{if(f[e.y][e.x]===Qe.CAVERN_EXPOSED||f[e.y][e.x]===Qe.SLUG_HOLE_EXPOSED)for(let t=e.x-1;t<=e.x+1;t++)for(let i=e.y-1;i<=e.y+1;i++)u.getSurfaceOrNull(t,i).discovered=!0})),u.forEachSurface((e=>{const t=u.getSurfaceOrNull(e.x,e.y);f[e.y][e.x]!==Qe.CAVERN_HIDDEN||t.discovered||(t.surfaceType=T.GROUND)}));const w=[];for(let e=0;e<u.width;e++){const t=[];for(let i=0;i<u.height;i++){const s=u.getSurfaceOrNull(e,i).getGraphWalkWeight();t.push(s,s,s)}w.push(t,t,t)}if(u.graphWalk=new ne(w,{diagonal:!0}),u.forEachSurface((e=>{e.isSupported()||e.collapse()})),u.updateSurfaceMeshes(!0),E)for(let e=0;e<u.width;e++)for(let t=0;t<u.height;t++)u.getSurface(e,t).setFallinLevel(E[t][e]);return v&&console.warn("Lucky you! Lava erosion not yet implemented"),u}}.loadTerrain(e,t,this),this.scene.add(this.terrain.floorGroup),G.totalDiggables=this.terrain.countDiggables(),G.totalCrystals=this.terrain.countCrystals(),G.totalOres=this.terrain.countOres()}startScene(){this.debugHelper.show(),this.renderInterval=setInterval((()=>{this.animRequest=requestAnimationFrame((()=>{this.debugHelper.renderStart(),this.renderer.render(this.scene,this.camera),this.debugHelper.renderDone()}))}),1e3/this.maxFps)}disposeScene(){var e,t;this.debugHelper.hide(),this.renderInterval=w(this.renderInterval),this.animRequest&&(cancelAnimationFrame(this.animRequest),this.animRequest=null),G.remainingDiggables=(null===(e=this.terrain)||void 0===e?void 0:e.countDiggables())||0,null===(t=this.terrain)||void 0===t||t.dispose(),this.terrain=null,at.meshRegistry.forEach((e=>e.dispose())),at.meshRegistry=[]}static registerMesh(e){return this.meshRegistry.push(e),e.mesh}resize(e,t){this.renderer.setSize(e,t)}getTerrainIntersectionPoint(e,t){if(!this.terrain)return null;const i=new H.iMs;i.setFromCamera({x:e,y:t},this.camera);const s=i.intersectObjects(this.terrain.floorGroup.children);return s.length>0?new H.FM8(s[0].point.x,s[0].point.z):null}setTorchPosition(e){this.cursorTorchlight.position.copy(this.getFloorPosition(e)),this.cursorTorchlight.position.y+=2*U.pM}getFloorPosition(e){const t=this.terrain.getSurfaceFromWorldXZ(e.x,e.y).getFloorHeight(e.x,e.y);return new H.Pa4(e.x,t,e.y)}getTerrainHeight(e,t){const i=new H.iMs(new H.Pa4(Number(e),3*U.pM,Number(t)),new H.Pa4(0,-1,0)).intersectObject(this.terrain.floorGroup,!0);return i.length>0?i[0].point.y:(console.warn("could not determine terrain height for "+e+"/"+t),0)}}at.meshRegistry=[];class ot{constructor(e,t=10,i=19){this.letters=[];const s=[" ","!",'"',"#","$","%","⌵","`","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","'","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","Ä","Å","Á","À","Â","Ã","Ą","ä","å","á","à","â","ã","ą","Ë","E̊","É","È","É","Ę","ë","e̊","é","è","e̊","ę̊","","","","","","","","","Ö","","","","","ö","","","","","Ü","","","","ü","","","","","","","","","","","","","","","","","","","","","","","","ß","","","","Ñ","","ñ",""],r=e.width/t;function n(e){for(let t=0;t<e.height/i;t++){let i=4*t*e.width;if(255!==e.data[i]&&255!==e.data[i+2]){for(let t=0;t<r;t++){let i=4*t;if(255===e.data[i]||255===e.data[i+2])return t}return r}}return 0}this.charHeight=e.height/i;for(let t=0;t<s.length;t++){let i=this.extractData(e,t%10*r,Math.floor(t/10)*this.charHeight,r,this.charHeight),a=n(i);i=a>0?this.extractData(i,0,0,a,this.charHeight):V(r,this.charHeight),this.letters[s[t]]=i}}extractData(e,t,i,s,r){const n=Y(e,t+s-1,i+r-1),a=new ImageData(s,r);for(let o=0;o<s;o++)for(let s=0;s<r;s++){const r=Y(e,t+o,i+s);r.r===n.r&&r.g===n.g&&r.b===n.b&&(r.a=0),j(a,o,s,r.r,r.g,r.b,r.a)}return a}createTextImage(e,t,i=!0){if(null==e||e.length<1)return J(1,1).canvas;e=e.replace(/_/g," ");const s=this.determineRows(e,t),r=Math.max(...s.map((e=>e.width))),n=new ImageData(r,this.charHeight*s.length);s.forEach(((e,t)=>{const s=i?Math.round((r-e.width)/2):0,a=t*this.charHeight;let o=0;for(let t=0;t<e.text.length;t++){const i=this.letters[e.text.charAt(t)];if(i){for(let e=o;e<o+i.width;e++)for(let t=0;t<i.height;t++){const r=Y(i,e-o,t);j(n,s+e,a+t,r.r,r.g,r.b,r.a)}o+=i.width}}}));const a=J(n.width,n.height);return a.putImageData(n,0,0),a.canvas}determineRows(e,t){const i=this.letters[" "].width,s=[];let r="",n=0;return e.split(" ").map((e=>{let a=0;for(let t=0;t<e.length;t++){const i=e.charAt(t),s=this.letters[i];s?a+=s.width:console.error("Letter '"+i+"' not found in charset! Ignoring it")}return n>0?!t||n+i+a<t?(r+=" "+e,n+=i+a):(s.push({text:r,width:n}),r=e,n=a):(r+=e,n+=a),a})),n>0&&s.push({text:r,width:n}),s}}class lt{static cfg(...e){return g(this.configuration,...e)}static getResource(e){var t;const i=(null===(t=null==e?void 0:e.toString())||void 0===t?void 0:t.toLowerCase())||null;return this.resourceByName.get(i)||null}static getImageData(e){if(!e)throw"imageName must not be undefined, null or empty - was "+e;return this.resourceByName.getOrUpdate(e.toLowerCase(),(()=>(console.error("Image '"+e+"' unknown! Using placeholder image instead"),V(64,64))))}static getImage(e){const t=this.getImageData(e),i=J(t.width,t.height);return i.putImageData(t,0,0),i.canvas}static getImageOrNull(e){return e?this.getImage(e):null}static getBitmapFont(e){return this.fontCache.getOrUpdate(e,(()=>{const t=this.getResource(e);if(!t)throw"Could not load font image data for: "+e;return new ot(t)}))}static getDefaultFont(){return this.getBitmapFont("Interface/Fonts/Font5_Hi.bmp")}}lt.configuration={},lt.resourceByName=new Map,lt.fontCache=new Map;class ht{constructor(e,t){this.wad0FileUrl=e,this.wad1FileUrl=t}}!function(e){e[e.MSG=0]="MSG",e[e.CFG=1]="CFG",e[e.CACHE_MISS=2]="CACHE_MISS",e[e.SFX=3]="SFX",e[e.ASSET=4]="ASSET",e[e.DONE=5]="DONE",e[e.INIT=6]="INIT",e[e.CANVAS=7]="CANVAS",e[e.REDRAW=8]="REDRAW",e[e.RESET=9]="RESET",e[e.EVENT_POINTER=10]="EVENT_POINTER",e[e.EVENT_KEY=11]="EVENT_KEY",e[e.EVENT_WHEEL=12]="EVENT_WHEEL",e[e.RESPONSE_EVENT=13]="RESPONSE_EVENT",e[e.OVERLAY_SETUP=14]="OVERLAY_SETUP",e[e.SPACE_TO_CONINUE=15]="SPACE_TO_CONINUE",e[e.SHOW_OPTIONS=16]="SHOW_OPTIONS",e[e.GAME_ABORT=17]="GAME_ABORT",e[e.GAME_RESTART=18]="GAME_RESTART",e[e.GAME_EVENT=19]="GAME_EVENT"}(et||(et={}));class ct extends lt{static startLoadingFromCache(){return this.startLoading(null)}static startLoadingFromUrl(e,t){return this.startLoading(new ht(e,t))}static startLoading(e){this.worker.onmessage=e=>{const t=e.data;t.type===et.ASSET?(t.assetNames.forEach((e=>this.resourceByName.set(e.toLowerCase(),t.assetObj))),this.onAssetLoaded()):t.type===et.MSG?this.onMessage(t.text):t.type===et.CFG?(this.configuration=t.cfg,this.stats=t.stats,this.onInitialLoad(t.totalResources)):t.type===et.CACHE_MISS?this.onCacheMissed():t.type===et.DONE&&(console.log("Loading of about "+t.totalResources+" assets complete! Total load time: "+t.loadingTimeSeconds+" seconds."),this.onLoadDone())},this.worker.postMessage(e)}static filterTextureSequenceNames(e){const t=e.toLowerCase(),i=[];return this.resourceByName.forEach(((e,s)=>{s.startsWith(t)&&i.push(s)})),i.length>0?i:t.startsWith("world/shared/")?(console.warn("Texture sequence not found: "+e),null):this.filterTextureSequenceNames("world/shared/"+d(e))}static getTexture(e){if(!e||0===e.length)throw"textureName must not be undefined, null or empty - was "+e;const t=e.toLowerCase(),i=this.resourceByName.getOrUpdate(t,(()=>{const i="world/shared/"+d(t);return this.resourceByName.getOrUpdate(i,(()=>(console.warn("Texture '"+e+"' ("+t+", "+i+") unknown! Using placeholder texture instead"),V(64,64))))})),s=new H.xEZ(i,H.xEZ.DEFAULT_MAPPING,H.rpg,H.rpg);return s.needsUpdate=!0,s}static getAnimationEntityType(e){let t=this.getResource(e);if(!t)throw"Could not get animation entity type for: "+e;return class{static loadModels(e,t){const i=function(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const i=t.lastIndexOf("/");return t=t.substring(0,i+1),t.startsWith("/")&&(t=t.substring(1)),t}(e),s=new K;s.carryNullName=g(t,"CarryNullName"),s.depositNullName=g(t,"DepositNullName"),s.toolNullName=g(t,"ToolNullName");const r=g(t,"highpoly");r&&(s.highPoly={},Object.keys(r).forEach((e=>{const t=r[e]+".lwo",n=e.startsWith("!")?e.slice(1):e,a=ct.getResource(i+t);s.highPoly[n]=at.registerMesh(new Ce(i).parse(a))})));const n=g(t,"Activities");return n&&Object.keys(n).forEach((e=>{try{let r=g(n,e);const a=g(t,r),o=g(a,"FILE"),l=!0===g(a,"LWSFILE"),h=g(a,"TRANSCOEF"),c=!0===g(a,"LOOPING");if(l){const t=ct.getResource(i+o+".lws");a.animation=new Le(i).parse(t),a.animation.looping=c,a.animation.transcoef=h?Number(h):1,s.activities.set(e.toLowerCase(),a)}else console.error("Found activity which is not an LWS file")}catch(i){console.error(i),console.log(t),console.log(n),console.log(e)}})),s}}.loadModels(e,t)}}ct.worker=new Worker(new URL(i.p+i.u(737),i.b)),ct.onMessage=e=>{console.log(e)},ct.onCacheMissed=()=>{console.log("Worker missed cache")},ct.onInitialLoad=()=>{console.log("Initial loading done.")},ct.onAssetLoaded=()=>{},ct.onLoadDone=()=>{};class ut extends xe{}ut.Short=new xe("Short"),ut.Expand=new xe("Expand"),ut.Long=new xe("Long"),ut.Teleport=new xe("Teleport");class dt extends Ne{constructor(e,t){super(Ie.COMPLETE_POWER_PATH),this.surface=e,this.placedItems=t,this.workplaces=[new Ue(e.getRandomPosition())]}onJobComplete(){super.onJobComplete(),this.placedItems.forEach((e=>e.removeFromScene())),this.surface.surfaceType=T.POWER_PATH,this.surface.updateTexture(),this.surface.neighbors.forEach((e=>e.updateTexture()))}getRequiredTool(){return o.SHOVEL}getPriorityIdentifier(){return Me.aiPriorityConstruction}getWorkplaces(){return this.workplaces}getWorkActivity(){return Be.Clear}}class gt{constructor(e,t=null,i=null){this.primarySurface=null,this.secondarySurface=null,this.heading=0,this.neededByType=new Map,this.assignedByType=new Map,this.onSiteByType=new Map,this.complete=!1,this.primarySurface=e,this.secondarySurface=t,this.building=i}getRandomDropPosition(){return this.primarySurface.getRandomPosition()}needs(e){return this.neededByType.getOrUpdate(e,(()=>0))>this.assignedByType.getOrUpdate(e,(()=>[])).length}assign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).push(e)}unAssign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).remove(e)}addItem(e){const t=this.neededByType.getOrUpdate(e.entityType,(()=>0));this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).length<t?(e.onAddToSite(),this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).push(e),this.checkComplete()):e.resetTarget()}checkComplete(){if(!this.complete&&(this.complete=!0,this.neededByType.forEach(((e,t)=>{this.complete=this.complete&&this.onSiteByType.getOrUpdate(t,(()=>[])).length>=e})),this.complete))if(G.buildingSites.remove(this),this.building){this.onSiteByType.getOrUpdate(r.BARRIER,(()=>[])).forEach((e=>{e.changeActivity(ut.Teleport,(()=>e.removeFromScene()))})),this.onSiteByType.getOrUpdate(r.CRYSTAL,(()=>[])).forEach((e=>{e.removeFromScene()})),this.onSiteByType.getOrUpdate(r.ORE,(()=>[])).forEach((e=>{e.removeFromScene()}));const e=this.primarySurface.getCenterWorld2D();this.building.placeDown(e,-this.heading+Math.PI/2,!1)}else{const e=[];this.onSiteByType.forEach((t=>e.push(...t))),b.publishEvent(new ce(new dt(this.primarySurface,e)))}}getDropAction(){return Be.Place}}class pt extends Je{constructor(e,t,i,s){super(e,t,r.BARRIER,"MiscAnims/Barrier/Barrier.ae"),this.heading=i.heading,this.priorityIdentifier=Me.aiPriorityConstruction,this.changeActivity(),this.targets=[new Ge(i.location,s)]}updateTargets(){return this.targets}getDefaultActivity(){return ut.Short}onAddToSite(){super.onAddToSite(),this.group.rotation.y=this.heading,this.changeActivity(ut.Expand,(()=>this.changeActivity(ut.Long)))}}class mt extends ke{onJobComplete(){super.onJobComplete(),this.item.targetSurface.canPlaceFence()&&(this.item.addToScene(null,null),this.item.targetSurface.fence=this.item)}}class ft extends Je{constructor(e,t,i){super(e,t,r.ELECTRIC_FENCE);const s=ct.getResource("Buildings/E-Fence/E-Fence4.lwo"),n=at.registerMesh(new Ce("Buildings/E-Fence/").parse(s));this.group.add(n),this.targetSurface=i,this.priorityIdentifier=Me.aiPriorityConstruction}updateTargets(){return this.targets.length<1?this.targetSurface.canPlaceFence()?this.targets=[new We(this.targetSurface.getCenterWorld2D())]:this.targets=G.getBuildingsByType(...this.getTargetBuildingTypes()).map((e=>new He(e.getDropPosition2D(),e))):this.targetSurface.canPlaceFence()||this.targets[0].building||(this.targets=G.getBuildingsByType(...this.getTargetBuildingTypes()).map((e=>new He(e.getDropPosition2D(),e)))),this.targets}createCarryJob(){return new mt(this)}}class yt extends _e{constructor(e,t,i,r){super(e,t,n.BUILDING,i,r),this.blocksPathSurface=!0,this.secondaryBuildingPart=null,this.primaryPowerPath=new H.FM8(0,1),this.secondaryPowerPath=null,this.waterPathSurface=null,this.powerSwitch=!0,this.spawning=!1,this.primarySurface=null,this.secondarySurface=null,this.primaryPathSurface=null,this.secondaryPathSurface=null,this.upgradeCostOre=0,this.upgradeCostBrick=0,this.crystalsInUse=0,this.inBeam=!1,this.group.applyMatrix4((new H.yGw).makeScale(-1,1,1)),this.group.userData={selectable:this},this.upgradeCostOre=ct.cfg("Main","BuildingUpgradeCostOre"),this.upgradeCostBrick=ct.cfg("Main","BuildingUpgradeCostStuds"),b.registerEventListener(s.MATERIAL_AMOUNT_CHANGED,(()=>{this.powerSwitch&&this.turnOnPower()}))}getSelectionType(){return M.BUILDING}select(){return!this.selected&&!this.inBeam&&(this.selectionFrame.visible=!0,this.selected=!0,!0)}deselect(){this.selectionFrame.visible=!1,this.selected=!1}getSelectionCenter(){return this.pickSphere?(new H.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null}getPickSphereCenter(){return new H.Pa4(0,this.stats.PickSphere/4,0)}getDropPosition2D(){if(this.getToolJoint){const e=new H.Pa4;return this.getToolJoint.getWorldPosition(e),new H.FM8(e.x,e.z)}if(this.depositJoint){const e=new H.Pa4;return this.depositJoint.getWorldPosition(e),new H.FM8(e.x,e.z)}return this.getPosition2D()}getDropPosition(){return this.sceneMgr.getFloorPosition(this.getDropPosition2D())}isUsable(){return!this.inBeam&&this.powerSwitch&&(this.isPowered()||this.stats.PowerBuilding)}isPowered(){return this.stats.SelfPowered||this.crystalsInUse>0}onDiscover(){super.onDiscover(),G.buildingsUndiscovered.remove(this),G.buildings.push(this),b.publishEvent(new N)}hasMaxLevel(){return this.level>=this.stats.Levels-1}upgrade(){this.canUpgrade()&&(G.numBrick>=this.upgradeCostBrick?G.numBrick-=this.upgradeCostBrick:G.numOre-=this.upgradeCostOre,b.publishEvent(new ge),this.level++,b.publishEvent(new O),b.publishEvent(new N))}getDefaultActivity(){return this.isPowered()?xe.Stand:Fe.Unpowered}beamUp(){G.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.inBeam=!0;for(let e=0;e<this.stats.CostOre;e++)this.worldMgr.placeMaterial(new qe(this.worldMgr,this.sceneMgr),this.primarySurface.getRandomPosition());for(let e=0;e<this.stats.CostCrystal;e++)this.worldMgr.placeMaterial(new Ve(this.worldMgr,this.sceneMgr),this.primarySurface.getRandomPosition());this.surfaces.forEach((e=>{e.surfaceType=T.GROUND,e.setBuilding(null),e.updateTexture(),e.neighbors.forEach((e=>e.updateTexture()))})),super.beamUp(),b.publishEvent(new N)}removeFromScene(){super.removeFromScene(),G.buildings.remove(this)}canUpgrade(){return!this.hasMaxLevel()&&(G.numOre>=this.upgradeCostOre||G.numBrick>=this.upgradeCostBrick)}spawnMaterials(e,t){const i=[];if(e===r.CRYSTAL)for(;G.numCrystal>0&&i.length<t;)G.numCrystal--,i.push(new Ve(this.worldMgr,this.sceneMgr));else if(e===r.ORE)for(;G.numOre>0&&i.length<t;)G.numOre--,i.push(new qe(this.worldMgr,this.sceneMgr));else console.error("Material drop not implemented for: "+e);i.length>0&&b.publishEvent(new ge),i.forEach((e=>this.worldMgr.placeMaterial(e,this.getDropPosition2D())))}spawnBarriers(e,t){e.map((e=>new pt(this.worldMgr,this.sceneMgr,e,t))).forEach((e=>this.worldMgr.placeMaterial(e,this.getDropPosition2D())))}spawnFence(e){this.worldMgr.placeMaterial(new ft(this.worldMgr,this.sceneMgr,e),this.getDropPosition2D())}turnOnPower(){this.crystalsInUse>0||G.usedCrystals>=G.numCrystal||this.entityType!==r.POWER_STATION&&!this.surfaces.some((e=>e.neighbors.some((e=>e.hasPower))))||(this.crystalsInUse=1,G.usedCrystals+=this.crystalsInUse,this.surfaces.forEach((e=>e.setHasPower(!0,!0))),this.changeActivity(),b.publishEvent(new N))}turnOffPower(){this.crystalsInUse<1||(G.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.surfaces.forEach((e=>e.setHasPower(!1,!1))),this.changeActivity(),b.publishEvent(new N))}get surfaces(){const e=[];return this.primarySurface&&e.push(this.primarySurface),this.secondarySurface&&e.push(this.secondarySurface),this.primaryPathSurface&&e.push(this.primaryPathSurface),this.secondaryPathSurface&&e.push(this.secondaryPathSurface),e}placeDown(e,t,i){const s=this.sceneMgr.terrain.getSurfaceFromWorld2D(e);if(s.setBuilding(this),s.surfaceType=T.POWER_PATH_BUILDING,s.updateTexture(),s.neighbors.forEach((e=>e.updateTexture())),this.primarySurface=s,this.secondaryBuildingPart){const i=new H.FM8(U.pM*this.secondaryBuildingPart.x,U.pM*this.secondaryBuildingPart.y).rotateAround(new H.FM8(0,0),-t).add(e),s=this.sceneMgr.terrain.getSurfaceFromWorld2D(i);s.setBuilding(this),s.surfaceType=T.POWER_PATH_BUILDING,s.updateTexture(),s.neighbors.forEach((e=>e.updateTexture())),this.secondarySurface=s}if(this.primaryPowerPath){const i=new H.FM8(this.primaryPowerPath.x,this.primaryPowerPath.y).multiplyScalar(U.pM).rotateAround(new H.FM8(0,0),-t).add(e),s=this.sceneMgr.terrain.getSurfaceFromWorld2D(i);this.entityType===r.GEODOME&&(s.building=this),s.surfaceType=T.POWER_PATH_BUILDING,s.updateTexture(),s.neighbors.forEach((e=>e.updateTexture())),this.primaryPathSurface=s}this.addToScene(e,t),this.createPickSphere(),this.group.visible?G.buildings.push(this):G.buildingsUndiscovered.push(this),this.group.visible&&!i?(this.inBeam=!0,this.changeActivity(Fe.Teleport,(()=>{this.inBeam=!1,this.onPlaceDown()}))):this.onPlaceDown(),this.sceneMgr.terrain.resetGraphWalk()}onPlaceDown(){this.changeActivity(),this.turnOnPower(),b.publishEvent(new N)}getDropAction(){return Be.Place}getTrainingTargets(){return[new H.FM8(-1,0),new H.FM8(0,1),new H.FM8(1,0),new H.FM8(0,-1)].map((e=>new Ue(e.multiplyScalar(U.pM/2).add(this.primarySurface.getCenterWorld2D()))))}}class Et extends yt{constructor(e,t){super(e,t,r.BARRACKS,"Buildings/Barracks/Barracks.ae")}get stats(){return ct.stats.Barracks}}class vt extends yt{constructor(e,t){super(e,t,r.DOCKS,"Buildings/Docks/Docks.ae"),this.waterPathSurface=new H.FM8(0,1)}get stats(){return ct.stats.Docks}}class wt extends yt{constructor(e,t){super(e,t,r.GEODOME,"Buildings/Geo-dome/Geo-dome.ae"),this.primaryPowerPath=null,this.secondaryBuildingPart=new H.FM8(0,1)}get stats(){return ct.stats.Geodome}}class bt extends yt{constructor(e,t){super(e,t,r.GUNSTATION,"Buildings/gunstation/gunstation.ae"),this.primaryPowerPath=null}getDefaultActivity(){return Fe.Stand}get stats(){return ct.stats.GunStation}}class Tt extends yt{constructor(e,t){super(e,t,r.ORE_REFINERY,"Buildings/OreRefinery/OreRefinery.ae"),this.primaryPowerPath=new H.FM8(0,2),this.secondaryBuildingPart=new H.FM8(0,1)}get stats(){return ct.stats.OreRefinery}getDropAction(){return Be.Deposit}}class At extends yt{constructor(e,t){super(e,t,r.POWER_STATION,"Buildings/Powerstation/Powerstation.ae"),this.secondaryBuildingPart=new H.FM8(-1,0)}get stats(){return ct.stats.Powerstation}getDropAction(){return Be.Deposit}}class St extends yt{constructor(e,t){super(e,t,r.TELEPORT_BIG,"Buildings/BIGTeleport/BIGTeleport.ae"),this.secondaryBuildingPart=new H.FM8(1,0),this.secondaryPowerPath=new H.FM8(1,1)}get stats(){return ct.stats.TeleportBIG}}class Rt extends yt{constructor(e,t){super(e,t,r.TELEPORT_PAD,"Buildings/Teleports/Teleports.ae")}get stats(){return ct.stats.TeleportPad}}class Ct extends yt{constructor(e,t){super(e,t,r.TOOLSTATION,"Buildings/Toolstation/Toolstation.ae"),this.blocksPathSurface=!1}get stats(){return ct.stats.Toolstation}}class Lt extends yt{constructor(e,t){super(e,t,r.UPGRADE,"Buildings/Upgrade/Upgrade.ae")}get stats(){return ct.stats.Upgrade}}class Mt extends De{constructor(){super(Ie.EAT)}getWorkplaces(){return this.fulfiller.map((e=>new Ue(e.getPosition2D())))}onJobComplete(){super.onJobComplete()}getWorkActivity(){return Be.Eat}}class Pt extends De{constructor(e,t){super(Ie.GET_TOOL),this.target=[new Ue(e)],this.tool=t}getWorkplaces(){return this.target}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>e.addTool(this.tool)))}}class It extends De{constructor(e,t){super(Ie.TRAIN),this.building=e,this.workplaces=e.getTrainingTargets(),this.training=t}getWorkplaces(){return this.building.isUsable()?this.workplaces:[]}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>{e.addTraining(this.training),b.publishEvent(new k(this.training))}))}getWorkActivity(){return Be.Train}getWorkDuration(e){return 1e4}}class Ot extends De{constructor(e){super(Ie.TRAIN),this.building=e,this.workplaces=e.getTrainingTargets()}getWorkplaces(){return this.building.isUsable()?this.workplaces:[]}onJobComplete(){super.onJobComplete(),this.fulfiller.forEach((e=>{e.level<e.stats.Levels&&e.level++}))}getWorkActivity(){return Be.Train}getWorkDuration(e){return 3e4}}class xt{constructor(e,t){b.registerEventListener(s.COMMAND_PICK_TOOL,(e=>{G.selectedRaiders.forEach((t=>{if(!t.hasTool(e.tool)){const i=G.getBuildingsByType(r.TOOLSTATION).map((e=>t.findPathToTarget(new Ue(e.getPosition2D())))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];i&&t.setJob(new Pt(i.targetPosition,e.tool))}})),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_CREATE_POWER_PATH,(()=>{var e;const t=G.selectedSurface;t.surfaceType=T.POWER_PATH_SITE,t.updateTexture(),null===(e=G.getClosestBuildingByType(t.getCenterWorld(),r.TOOLSTATION))||void 0===e||e.spawnMaterials(r.ORE,2);const i=new gt(t);i.neededByType.set(r.ORE,2),G.buildingSites.push(i),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_MAKE_RUBBLE,(()=>{var e;null===(e=G.selectedSurface)||void 0===e||e.makeRubble(2),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_PLACE_FENCE,(()=>{var e;const t=G.selectedSurface;t&&(null===(e=G.getClosestBuildingByType(t.getCenterWorld(),r.TOOLSTATION))||void 0===e||e.spawnFence(t)),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_CHANGE_RAIDER_SPAWN_REQUEST,(e=>{e.increase?G.requestedRaiders++:G.requestedRaiders--,b.publishEvent(new de(G.requestedRaiders))})),b.registerEventListener(s.COMMAND_CREATE_DRILL_JOB,(()=>{var e;null===(e=G.selectedSurface)||void 0===e||e.createDrillJob(),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_CREATE_REINFORCE_JOB,(()=>{var e;null===(e=G.selectedSurface)||void 0===e||e.createReinforceJob(),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_CREATE_DYNAMITE_JOB,(()=>{var e;null===(e=G.selectedSurface)||void 0===e||e.createDynamiteJob(),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_CANCEL_SURFACE_JOBS,(()=>{var e;null===(e=G.selectedSurface)||void 0===e||e.cancelJobs(),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_CREATE_CLEAR_RUBBLE_JOB,(()=>{var e;null===(e=G.selectedSurface)||void 0===e||e.createClearRubbleJob(),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_UPGRADE_BUILDING,(()=>{var e;null===(e=G.selectedBuilding)||void 0===e||e.upgrade()})),b.registerEventListener(s.COMMAND_BUILDING_BEAMUP,(()=>{var e;null===(e=G.selectedBuilding)||void 0===e||e.beamUp()})),b.registerEventListener(s.COMMAND_CHANGE_BUILDING_POWER_STATE,(e=>{var t,i;e.state?null===(i=G.selectedBuilding)||void 0===i||i.turnOnPower():null===(t=G.selectedBuilding)||void 0===t||t.turnOffPower()})),b.registerEventListener(s.COMMAND_RAIDER_EAT,(()=>{G.selectedRaiders.forEach((e=>!e.isDriving()&&e.setJob(new Mt))),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_RAIDER_UPGRADE,(()=>{G.selectedRaiders.forEach((e=>{const t=G.getClosestBuildingByType(e.getPosition(),r.TOOLSTATION);t&&e.level<e.stats.Levels&&e.setJob(new Ot(t))})),b.publishEvent(new O)})),b.registerEventListener(s.COMMAND_RAIDER_BEAMUP,(()=>{G.selectedRaiders.forEach((e=>e.beamUp()))})),b.registerEventListener(s.COMMAND_TRAIN_RAIDER,(e=>{G.getBuildingsByType(C[e.training]).some((t=>{if(t.stats[L[e.training]][t.level])return G.selectedRaiders.forEach((i=>!i.hasTraining(e.training)&&i.setJob(new It(t,e.training)))),b.publishEvent(new O),!0}))})),b.registerEventListener(s.COMMAND_RAIDER_DROP,(()=>{var e;null===(e=G.selectedRaiders)||void 0===e||e.forEach((e=>e.dropItem()))})),b.registerEventListener(s.COMMAND_SELECT_BUILD_MODE,(i=>{G.buildModeSelection=xt.buildingFromType(i.entityType,e,t)})),b.registerEventListener(s.COMMAND_CANCEL_BUILD_MODE,(()=>{G.buildModeSelection=null}))}static buildingFromType(e,t,i){switch(e){case r.TOOLSTATION:return new Ct(t,i);case r.TELEPORT_PAD:return new Rt(t,i);case r.DOCKS:return new vt(t,i);case r.POWER_STATION:return new At(t,i);case r.BARRACKS:return new Et(t,i);case r.UPGRADE:return new Lt(t,i);case r.GEODOME:return new wt(t,i);case r.ORE_REFINERY:return new Tt(t,i);case r.GUNSTATION:return new bt(t,i);case r.TELEPORT_BIG:return new St(t,i);default:throw"Unexpected building type: "+r[e]}}}class _t extends De{constructor(e){super(Ie.MOVE),this.target=[new Ue(e)]}getWorkplaces(){return this.target}}class Dt{constructor(e){this.vec=null,this.targetReached=!1,this.vec=e}}!function(e){e[e.MOVED=0]="MOVED",e[e.TARGET_REACHED=1]="TARGET_REACHED",e[e.TARGET_UNREACHABLE=2]="TARGET_UNREACHABLE"}(tt||(tt={}));class Nt extends _e{constructor(e,t,i,s,r){super(e,t,i,s,r),this.currentPath=null}getPosition(){return new H.Pa4(this.group.position.x,this.group.position.y,this.group.position.z)}getPosition2D(){return new H.FM8(this.group.position.x,this.group.position.z)}getSpeed(){var e;return(null===(e=this.animation)||void 0===e?void 0:e.transcoef)||1}moveToClosestTarget(e){if((null==e?void 0:e.length)||console.warn("No targets given"),!this.currentPath||!e.some((e=>e.targetLocation.equals(this.currentPath.target.targetLocation)))){const t=e.map((e=>this.findPathToTarget(e))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq));if(this.currentPath=t.length>0?t[0]:null,!this.currentPath)return tt.TARGET_UNREACHABLE}const t=this.currentPath.firstLocation;this.group.lookAt(new H.Pa4(t.x,this.group.position.y,t.y));const i=this.determineStep();return i.targetReached||this.currentPath.target.isInArea(this.getPosition2D())?tt.TARGET_REACHED:(this.group.position.add(i.vec),this.changeActivity(this.getRouteActivity()),tt.MOVED)}findPathToTarget(e){return new rt(e,e.targetLocation)}determineStep(){const e=this.getEntityStep(this.currentPath.firstLocation),t=e.vec.lengthSq(),i=this.getSpeed();if(this.currentPath.locations.length>1){if(t<i*i)return this.currentPath.locations.shift(),this.determineStep()}else t<U.Ob*U.Ob&&(e.targetReached=!0);return e.vec.setLength(Math.min(i,U.Ob)),e}getEntityStep(e){const t=this.sceneMgr.getFloorPosition(e);return t.y+=this.floorOffset,new Dt(t.sub(this.group.position))}}class kt extends Nt{constructor(e,t,i,s,r,n){super(e,t,i,s,r),this.workInterval=null,this.job=null,this.followUpJob=null,this.carries=null,this.jobWorkplaces=[],this.selectionType=n,this.group.userData={selectable:this},this.workInterval=setInterval(this.work.bind(this),1e3/U.OK)}resetWorkInterval(){this.workInterval=w(this.workInterval)}dropItem(){if(!this.carries)return;const e=this.getPosition();this.carryJoint&&(this.carryJoint.remove(this.carries.group),this.carryJoint.getWorldPosition(e)),this.carries.addToScene(new H.FM8(e.x,e.z),null),this.carries=null}pickupItem(e){this.carries=e,this.carryJoint&&this.carryJoint.add(this.carries.group),this.carries.group.position.set(0,0,0)}setJob(e,t=null){this.job!==e&&this.stopJob(),this.job=e,this.job&&this.job.assign(this),this.followUpJob=t,this.followUpJob&&this.followUpJob.assign(this),this.jobWorkplaces=this.job.getWorkplaces()}stopJob(){this.dropItem(),this.job&&(this.job.unassign(this),this.followUpJob&&this.followUpJob.unassign(this),this.job=null,this.followUpJob=null,this.jobWorkplaces=[],this.changeActivity())}getSelectionType(){return this.selectionType}deselect(){this.selectionFrame.visible=!1,this.selected=!1}}class Bt extends kt{constructor(e,t){super(e,t,n.RAIDER,r.PILOT,"mini-figures/pilot/pilot.ae",M.RAIDER),this.tools=new Map,this.trainings=new Map,this.slipped=!1,this.tools.set(o.DRILL,!0)}get stats(){return ct.stats.Pilot}findPathToTarget(e){return this.sceneMgr.terrain.findPath(this.getPosition2D(),e)}onDiscover(){super.onDiscover(),G.raidersUndiscovered.remove(this),G.raiders.push(this),b.publishEvent(new k),b.publishEvent(new ve(this.getPosition()))}select(){return this.selectionFrame.visible=!this.slipped,!this.selected&&!this.slipped&&(this.selected=!0,this.changeActivity(),!0)}getSelectionCenter(){return this.pickSphere?(new H.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null}isDriving(){return!1}getSpeed(){return super.getSpeed()*this.stats.RouteSpeed[this.level]*(this.isOnPath()?this.stats.PathCoef:1)}isOnPath(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position).isPath()}isOnRubble(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.group.position).hasRubble()}getRouteActivity(){return this.isOnRubble()?this.carries?Be.CarryRubble:Be.routeRubble:this.carries?Be.Carry:Be.Route}moveToClosestTarget(e){var t;const i=super.moveToClosestTarget(e);return this.job.setActualWorkplace(null===(t=this.currentPath)||void 0===t?void 0:t.target),i===tt.MOVED?G.getNearbySpiders(this).some((e=>{if(this.group.position.distanceToSquared(e.group.position)<this.radiusSq+e.radiusSq)return this.slip(),e.onDeath(),!0})):i===tt.TARGET_UNREACHABLE&&(console.log("Entity could not move to job target, stopping job"),this.stopJob()),i}slip(){f(0,100)<10&&this.stopJob(),this.dropItem(),this.slipped=!0,this.changeActivity(Be.Slip,(()=>{this.slipped=!1}))}moveToClosestWorkplace(){return this.moveToClosestTarget(this.jobWorkplaces)===tt.TARGET_REACHED}work(){if(this.job&&!this.selected&&!this.slipped)if(this.job.jobState!==Pe.INCOMPLETE)this.stopJob();else{const e=this.job.getCarryItem();if(e&&this.carries!==e)this.dropItem(),this.moveToClosestTarget(e.getPositionPathTarget())&&this.changeActivity(Be.Collect,(()=>{this.pickupItem(e)}));else if(this.moveToClosestWorkplace())if(this.job.isReadyToComplete()){const e=this.job.getWorkActivity()||this.getDefaultActivity();this.changeActivity(e,(()=>{this.completeJob()}),this.job.getWorkDuration(this))}else this.changeActivity()}}completeJob(){var e,t,i;null===(e=this.job)||void 0===e||e.onJobComplete(),(null===(t=this.job)||void 0===t?void 0:t.jobState)!==Pe.INCOMPLETE&&(this.job&&this.job.unassign(this),this.job=this.followUpJob,this.followUpJob=null,this.jobWorkplaces=(null===(i=this.job)||void 0===i?void 0:i.getWorkplaces())||[],this.changeActivity())}getDefaultActivity(){return this.carries?Be.CarryStand:super.getDefaultActivity()}beamUp(){this.stopJob(),super.beamUp(),b.publishEvent(new k)}removeFromScene(){super.removeFromScene(),G.raiders.remove(this)}hasTool(e){return!e||this.tools.has(e)}hasTraining(e){return!e||this.trainings.has(e)}addTool(e){this.tools.set(e,!0)}addTraining(e){this.trainings.set(e,!0)}}class Ut extends xe{}Ut.Route=new Ut("Activity_Route");class Ft extends Nt{constructor(e,t,i,s){super(e,t,n.MONSTER,i,s),this.target=[]}onLevelEnd(){this.moveTimeout=v(this.moveTimeout),this.removeFromScene()}getRouteActivity(){return Ut.Route}}class Wt extends Ft{constructor(e,t){super(e,t,r.BAT,"Creatures/bat/bat.ae"),this.floorOffset=U.pM/2}get stats(){return ct.stats.Bat}startRandomMove(){Wt.onMove(this)}static onMove(e){(e.target.length<1||e.moveToClosestTarget(e.target)===tt.TARGET_REACHED)&&(e.target=[e.findTarget()]),e.moveTimeout=setTimeout((()=>Wt.onMove(e)),1e3/U.OK)}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.getPosition()).getCenterWorld();for(let i=0;i<20;i++){const i=f(t.x-(U.pM+U.pM/2),t.x+U.pM+U.pM/2),s=f(t.z-U.pM/2,t.z+U.pM/2);if(e.getSurfaceFromWorldXZ(i,s).surfaceType.floor)return new Ue(new H.FM8(i,s))}return console.warn("Could not find a target"),null}onDeath(){this.onLevelEnd(),G.bats.remove(this)}}class Gt extends Ft{constructor(e,t){super(e,t,r.SMALL_SPIDER,"Creatures/SpiderSB/SpiderSB.ae"),this.floorOffset=1}get stats(){return ct.stats.SmallSpider}startMoving(){Gt.onMove(this)}static onMove(e){e.surfaces.forEach((t=>G.spidersBySurface.getOrUpdate(t,(()=>[])).remove(e))),e.target.length>0&&e.moveToClosestTarget(e.target)===tt.MOVED?(e.surfaces.forEach((t=>G.spidersBySurface.getOrUpdate(t,(()=>[])).push(e))),e.sceneMgr.terrain.getSurfaceFromWorld(e.getPosition()).surfaceType.floor?e.moveTimeout=setTimeout((()=>Gt.onMove(e)),1e3/U.OK):e.onDeath()):(e.changeActivity(),e.moveTimeout=setTimeout((()=>{e.target=[e.findTarget()],Gt.onMove(e)}),1e3+y(9e3)))}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.getPosition()).getCenterWorld();for(let i=0;i<20;i++){const i=f(t.x-(U.pM+U.pM/2),t.x+U.pM+U.pM/2),s=f(t.z-U.pM/2,t.z+U.pM/2),r=e.getSurfaceFromWorldXZ(i,s).surfaceType;if(r!==T.WATER&&r!==T.LAVA)return new Ue(new H.FM8(i,s))}return console.warn("Could not find a target"),null}onDeath(){this.onLevelEnd(),G.spiders.remove(this),this.surfaces.forEach((e=>G.spidersBySurface.getOrUpdate(e,(()=>[])).remove(this)))}}var Ht,Jt,Vt,jt=H.M8C.degToRad;class Yt{constructor(e){this.jobs=[],this.assignInterval=null,this.checkRubbleInterval=null,this.worldMgr=e,b.registerEventListener(s.JOB_CREATE,(e=>{this.jobs.push(e.job)})),b.registerEventListener(s.JOB_DELETE,(e=>{e.job.cancel()}))}start(){stop(),this.assignInterval=setInterval(this.assignJobs.bind(this),U.$I),this.checkRubbleInterval=setInterval(this.checkUnclearedRubble.bind(this),U.Cw)}stop(){this.assignInterval=w(this.assignInterval),this.checkRubbleInterval=w(this.checkRubbleInterval),G.raiders.forEach((e=>e.resetWorkInterval())),G.raidersUndiscovered.forEach((e=>e.resetWorkInterval()))}assignJobs(){const e=[];this.jobs=this.jobs.filter((t=>{const i=t.jobState===Pe.INCOMPLETE;return i&&t.fulfiller.length<1&&G.priorityList.isEnabled(t.getPriorityIdentifier())&&e.push(t),i})),e.sort(((e,t)=>Math.sign(G.priorityList.getPriority(e)-G.priorityList.getPriority(t))));const t=G.raiders.filter((e=>!e.job));e.forEach((e=>{let i=null,s=null,n=null,a=null,o=null,l=null,h=null,c=null,u=null,d=null,g=null,p=null,m=null;t.forEach(((t,f)=>{const y=e.getRequiredTool(),E=t.hasTool(y),v=e.getRequiredTraining(),w=t.hasTraining(v);if(t.getPosition(),E&&w){const r=e.getWorkplaces().map((e=>t.findPathToTarget(e))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(r){const e=r.lengthSq;(null===n||e<n)&&(i=t,s=f,n=e)}}else if(E){const e=G.getTrainingSites(v).sort(((e,i)=>t.findPathToTarget(new Ue(e.getPosition2D())).lengthSq-t.findPathToTarget(new Ue(i.getPosition2D())).lengthSq))[0];if(e){const i=t.findPathToTarget(new Ue(e.getPosition2D())).lengthSq;(null===g||i<g)&&(u=t,d=f,g=i,p=e,m=v)}}else{const e=G.getBuildingsByType(r.TOOLSTATION).map((e=>t.findPathToTarget(new Ue(e.getPosition2D())))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const i=e.lengthSq;(null===l||i<l)&&(a=t,o=f,l=i,h=e.targetPosition,c=y)}}})),i?(i.setJob(e),t.splice(s,1)):a?(a.setJob(new Pt(h,c),e),t.splice(o,1)):u&&(u.setJob(new It(p,m),e),t.splice(d,1))}))}checkUnclearedRubble(){G.priorityList.isEnabled(Me.aiPriorityClearing)&&G.raiders.forEach((e=>{if(e.job)return;const t=e.sceneMgr.terrain.getSurfaceFromWorld(e.getPosition());for(let i=0;i<10;i++)for(let s=t.x-i;s<=t.x+i;s++)for(let n=t.y-i;n<=t.y+i;n++){const t=e.sceneMgr.terrain.getSurfaceOrNull(s,n);if(!(null==t?void 0:t.hasRubble())||!(null==t?void 0:t.discovered))continue;const i=t.createClearRubbleJob();if(!i)continue;const a=i.getRequiredTool();if(e.hasTool(a))e.setJob(i);else{const t=G.getBuildingsByType(r.TOOLSTATION).map((t=>e.findPathToTarget(new Ue(t.getPosition2D())))).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];t&&e.setJob(new Pt(t.targetPosition,a),i)}}}))}}class Kt{constructor(e=!1){this.debug=!1,this.onLevelEnd=null,this.nerpInterval=null,this.registers=new Array(8).fill(0),this.timers=new Array(4).fill(0),this.scriptLines=[],this.statements=[],this.macrosByName={},this.labelsByName={},this.halted=!1,this.programCounter=0,this.messages=[],this.messagePermit=null,this.debug=e}startExecution(){const e=this;this.nerpInterval=setInterval((()=>{e.execute()}),2e3)}pauseExecution(){this.nerpInterval=w(this.nerpInterval)}checkRegister(e){const t=parseInt(e);if(isNaN(t)||t<0||t>this.registers.length)throw new Error("Invalid register ("+e+") provided");return t}checkRegisterValue(e){const t=parseInt(e);if(isNaN(t))throw new Error("Invalid register value ("+e+") provided");return t}getR(e){return e=this.checkRegister(e),this.registers[e]}setR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]=t}addR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]+=t}setTimer(e,t){const i=parseInt(t);if(isNaN(i))throw new Error("Can't set timer to NaN value: "+t);this.timers[e]=(new Date).getTime()+i}getTimer(e){return(new Date).getTime()-this.timers[e]}setLevelCompleted(){console.log("Nerp runner marks level as complete"),this.halted=!0,G.resultState=B.COMPLETE,this.onLevelEnd()}setLevelFail(){console.log("NerpRunner marks level as failed; at line: "+this.scriptLines[this.programCounter]),this.halted=!0,G.resultState=B.FAILED,this.onLevelEnd()}setTutorialFlags(e){0!==e&&console.warn("NERP: setTutorialFlags not yet implemented",e)}setMessagePermit(e){this.messagePermit=!e}setBuildingsUpgradeLevel(e,t){G.buildings.forEach((i=>{i.entityType===e&&(i.level=t)}))}setToolStoreLevel(e){this.setBuildingsUpgradeLevel(r.TOOLSTATION,e)}setTeleportPadLevel(e){this.setBuildingsUpgradeLevel(r.TELEPORT_PAD,e)}setPowerStationLevel(e){this.setBuildingsUpgradeLevel(r.POWER_STATION,e)}setBarracksLevel(e){this.setBuildingsUpgradeLevel(r.BARRACKS,e)}getToolStoresBuilt(){return G.buildings.count((e=>e.entityType===r.TOOLSTATION))}getMinifiguresOnLevel(){return G.raiders.length}getCrystalsCurrentlyStored(){return G.numCrystal}getObjectiveSwitch(){return G.objectiveSwitch}setMessageTimerValues(e,t,i){}getMessageTimer(){return 0}cameraUnlock(){}setMessage(e,t){if(!this.messagePermit)return;if(0===e)return;const i=this.messages[e];console.log(i.txt)}setCameraGotoTutorial(e){}getTutorialBlockIsGround(e){return 0}getTutorialBlockIsPath(e){return 0}getUnitAtBlock(e){return 0}getOxygenLevel(){return 100*G.airLevel}getObjectiveShowing(){return G.objectiveShown}addPoweredCrystals(){}disallowAll(){}getPoweredPowerStationsBuilt(){return G.buildings.count((e=>e.isUsable()&&e.entityType===r.POWER_STATION))}getPoweredBarracksBuilt(){return G.buildings.count((e=>e.isUsable()&&e.entityType===r.BARRACKS))}getRecordObjectAtTutorial(){}getHiddenObjectsFound(){return 0}getLevel1PowerStationsBuilt(){return G.buildings.count((e=>e.entityType===r.POWER_STATION&&e.level>=1))}getRandom100(){return y(100)}getSlugsOnLevel(){return 0}generateSlug(){console.warn("Slugs not yet implemented")}callMethod(e,t){if("Stop"===e)throw"Stop";if("TRUE"===e)return!0;if("FALSE"===e)return!1;const i=e.match(/^SetR([0-7])$/);if(i)return this.setR(i[1],t[0]);const s=e.match(/^AddR([0-7])$/);if(s)return this.addR(s[1],t[0]);const r=e.match(/^GetR([0-7])$/);if(r)return this.getR(r[1]);const n=e.match(/^SetTimer([0-3])$/);if(n)return this.setTimer(n[1],t[0]);const a=e.match(/^GetTimer([0-3])$/);if(a)return this.getTimer(a[1]);const o=e.toLowerCase(),l=Object.getOwnPropertyNames(Kt.prototype).find((e=>e.toLowerCase()===o));if(l)return this[l].apply(this,t);throw new Error("Undefined method: "+e)}conditional(e,t){const i=this.executeStatement(e);this.debug&&console.log("Condition evaluated to "+i),i&&this.executeStatement(t)}executeStatement(e){if(e.invoke){const t="conditional"!==e.invoke?e.args.map((e=>this.executeStatement(e))):e.args,i=this.callMethod(e.invoke,t);return void 0!==i&&this.debug&&console.log("Method returned: "+i),i}if(e.comparator){const t=this.executeStatement(e.left),i=this.executeStatement(e.right);if("="===e.comparator)return t===i;if("!="===e.comparator)return t!==i;if("<"===e.comparator)return t<i;if(">"===e.comparator)return t>i;throw console.log(e),new Error("Unknown comparator: "+e.comparator)}if(!isNaN(e))return e;if(!e.jump)throw console.log(e),new Error("Unknown expression in line "+this.programCounter+": "+e);if(this.programCounter=this.labelsByName[e.jump],void 0===this.programCounter)throw new Error("Label '"+e.jump+"' is unknown!");this.debug&&console.log("Jumping to label '"+e.jump+"' in line "+this.programCounter)}execute(e=!1){if(this.debug=e,!this.halted)try{for(this.debug&&(console.log("Executing following script\n"+this.scriptLines.join("\n")),console.log("Registers: "+this.registers)),this.programCounter=0;this.programCounter<this.statements.length;this.programCounter++){const e=this.statements[this.programCounter];this.debug&&(console.log(this.programCounter+": "+this.scriptLines[this.programCounter]),console.log(e)),e.label||this.executeStatement(e)}}catch(e){if("Stop"===e)return;console.error(e),console.error("FATAL ERROR! Script execution failed! You can NOT win anymore!"),this.halted=!0}}}class qt{static parse(e){const t=new Kt,i=e.split("\n").map((e=>e.split("//")[0].trim().split(";")[0].trim().replace(/_/g,"").replace(/\bTRUE \? /,"").replace(/[{}]/g,"")));for(let e=0;e<i.length;e++){const s=i[e];if(!(s.length<1))if(s.startsWith("#include ")){const e=s.replace(/^#include /,"").trim().slice(1,-1);if("nerpdef.h"===e)continue;const i=qt.parse(ct.getResource("Levels/"+e));if(!i||!i.scriptLines||i.scriptLines.length<1)throw"Can't include unknown nerp script: "+s;t.scriptLines=t.scriptLines.concat(i.scriptLines),t.macrosByName=Object.assign({},t.macrosByName,i.macrosByName)}else if(s.startsWith("#define ")){const r=s.replace(/^#define /,"").split(" "),n=[r.splice(1).join(" ").replace(/\\$/,"").trim()];let a=s,o=!1;for(;a.endsWith("\\")&&e<i.length-1;){e++,a=i[e].trim();const t=a.replace(/\\$/,"").trim();t.length>0&&(o?(o=!1,n[n.length-1]+=t):n.push(t)),a.match(/:\\$/)&&(o=!0)}const l=r[0].split("(");t.macrosByName[l[0]]={args:l[1].replace(/\)$/,"").split(","),lines:n}}else t.scriptLines=t.scriptLines.concat(this.replaceMacros(t.macrosByName,s))}for(let e=0;e<t.scriptLines.length;e++){const i=t.scriptLines[e];t.statements[e]=i.replace(/\(\)/g,"").split(" ? ");const s=i.match(/(\S+):/);if(2===t.statements[e].length)t.statements[e]={invoke:"conditional",args:[this.preProcess(t.statements[e][0]),this.preProcess(t.statements[e][1])]};else if(s){const i=s[1].toLowerCase();t.labelsByName[i]=e,t.statements[e]={label:i}}else{if(1!==t.statements[e].length)throw"Can't deal with line: "+i;t.statements[e]=this.preProcess(t.statements[e][0])}}return t}static replaceMacros(e,t){const i=t.split("("),s=e[i[0]];if(s){const r=i.splice(1).join("(").slice(0,-1).split(",");if(r.length!==s.args.length)throw"Invalid number of args provided for macro in line "+t;const n=[];return s.lines.forEach((t=>{for(let e=0;e<r.length;e++)t=t.replace(new RegExp("\\b"+s.args[e]+"\\b"),r[e]);n.push(...this.replaceMacros(e,t))})),n}return[t]}static preProcess(e){e=e.trim().replace(/^_/,"");const t=parseInt(e);if(!isNaN(t))return t;const i=e.split(/ (=) | (!=) | (>) | (<) /).filter((e=>void 0!==e)),s=e.match(/^(.+)\((.+)\)$/),r=e.split(" "),n=e.match(/([^:]+):$/),a=e.match(/^:([^:]+)$/);if(3===i.length)return{left:this.preProcess(i[0]),comparator:i[1],right:this.preProcess(i[2])};if(s){const e=s[2].split(",").map((e=>this.preProcess(e)));return{invoke:s[1],args:e}}if(r.length>1){const e=2===r.length?[this.preProcess(r[1])]:r.splice(1).map((e=>this.preProcess(e)));return{invoke:r[0],args:e}}if(n)return{label:n[1]};if(a)return{jump:a[1].toLowerCase()};if(e.match(/[ =?><!]/))throw"Invalid expression given, parsing must have failed before somewhere";return{invoke:e,args:[]}}}class zt{constructor(){this.nerpRunner=null,this.oxygenUpdateInterval=null,b.registerEventListener(s.SELECTION_CHANGED,(e=>{e.selectionType===M.NOTHING&&G.selectEntities([])})),b.registerEventListener(s.CAVERN_DISCOVERED,(()=>{G.discoveredCaverns++})),this.oxygenUpdateInterval=setInterval(this.updateOxygen.bind(this),U.SO)}setup(e,t){var i,s;G.levelFullName=e.fullName,G.totalCaverns=(null===(s=null===(i=e.reward)||void 0===i?void 0:i.quota)||void 0===s?void 0:s.caverns)||0,G.rewardConfig=e.reward,G.priorityList.setList(e.priorities),b.publishEvent(new D(G.priorityList.levelDefault)),G.oxygenRate=e.oxygenRate,this.nerpRunner=qt.parse(ct.getResource(e.nerpFile)),this.nerpRunner.messages.push(...ct.getResource(e.nerpMessageFile)),this.nerpRunner.onLevelEnd=t}start(){var e;null===(e=this.nerpRunner)||void 0===e||e.startExecution(),G.levelStartTime=Date.now()}stop(){var e;G.levelStopTime=Date.now(),null===(e=this.nerpRunner)||void 0===e||e.pauseExecution(),G.spiders.forEach((e=>e.onLevelEnd())),G.bats.forEach((e=>e.onLevelEnd()))}placeMaterial(e,t){return e.addToScene(t,0),e.group.visible?(G.materials.push(e),b.publishEvent(new ce(e.createCarryJob()))):G.materialsUndiscovered.push(e),e}updateOxygen(){const e=(G.raiders.map((e=>e.stats.OxygenCoef)).reduce(((e,t)=>e+t),0)+G.buildings.map((e=>e.isUsable()?e.stats.OxygenCoef:0)).reduce(((e,t)=>e+t),0))*G.oxygenRate*.001*.04*U.SO*.001/10,t=Math.min(1,Math.max(0,G.airLevel+e));G.airLevel!==t&&(G.airLevel=t,b.publishEvent(new x(G.airLevel)))}}class Zt{constructor(e,t){this.active=!0,this.canvas=document.createElement("canvas"),e||(this.canvas.style.background="#f0f"),t&&(this.context=this.canvas.getContext("2d",{alpha:e})),this.hide()}reset(){}setZIndex(e){this.canvas.style.zIndex=String(e)}static compareZ(e,t){var i,s,r,n;let a=(null===(s=null===(i=null==e?void 0:e.canvas)||void 0===i?void 0:i.style)||void 0===s?void 0:s.zIndex)||0;const o=(null===(n=null===(r=null==t?void 0:t.canvas)||void 0===r?void 0:r.style)||void 0===n?void 0:n.zIndex)||0;return a===o?0:a>o?-1:1}resize(e,t){this.canvas.width=e,this.canvas.height=t}redraw(){const e=this.onRedraw;if(this.isActive()&&e){const t=this.context;requestAnimationFrame((()=>e(t)))}}show(){this.reset(),this.active=!0,this.canvas.style.visibility="visible",this.redraw()}hide(){this.active=!1,this.canvas.style.visibility="hidden"}isActive(){return this.active}toCanvasCoords(e,t){const i=this.canvas.getBoundingClientRect();return[e-i.left,t-i.top]}handlePointerEvent(e){return new Promise((e=>e(!1)))}handleKeyEvent(e){return new Promise((e=>e(!1)))}handleWheelEvent(e){return new Promise((e=>e(!1)))}}class Xt extends Zt{constructor(e=!0,t=!0){super(e,t),this.fixedWidth=U.Du,this.fixedHeight=U.DG,this.updateScale()}updateScale(){this.scaleX=this.canvas.width/this.fixedWidth,this.scaleY=this.canvas.height/this.fixedHeight}toScaledCoords(e,t){const[i,s]=this.toCanvasCoords(e,t);return[i/this.scaleX,s/this.scaleY].map((e=>Math.round(e)))}resize(e,t){super.resize(e,t),this.updateScale(),this.context.scale(this.scaleX,this.scaleY)}}!function(e){e[e.MAIN=0]="MAIN",e[e.MIDDLE=1]="MIDDLE",e[e.SECONDARY=2]="SECONDARY"}(Ht||(Ht={})),function(e){e[e.MOVE=0]="MOVE",e[e.DOWN=1]="DOWN",e[e.UP=2]="UP"}(Jt||(Jt={})),function(e){e[e.DOWN=0]="DOWN",e[e.UP=1]="UP"}(Vt||(Vt={}));class $t{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.key=t.key,this.code=t.code}}class Qt{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.clientX=t.clientX,this.clientY=t.clientY,this.pointerType=t.pointerType,this.button=t.button,this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.shiftKey=t.shiftKey}}class ei{constructor(e){this.type=e.type,this.bubbles=!1,this.clientX=e.clientX,this.clientY=e.clientY,this.deltaX=e.deltaX,this.deltaY=e.deltaY,this.deltaZ=e.deltaZ,this.button=e.button,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey}}class ti{constructor(e){e.gameCanvasContainer.addEventListener("contextmenu",(t=>{e.isInRect(t)&&t.preventDefault()})),new Map([["pointermove",Jt.MOVE],["pointerdown",Jt.DOWN],["pointerup",Jt.UP]]).forEach(((t,i)=>{e.gameCanvasContainer.addEventListener(i,(i=>{if(!e.isInRect(i))return;i.preventDefault();const s=new Qt(t,i),r=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Zt.compareZ(e,t)));ti.publishPointerEvent(r,s)}))})),new Map([["keydown",Vt.DOWN],["keyup",Vt.UP]]).forEach(((t,i)=>{e.gameCanvasContainer.addEventListener(i,(i=>{U.Sl||i.preventDefault();const s=new $t(t,i),r=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Zt.compareZ(e,t)));ti.publishKeyEvent(r,s)}))})),e.gameCanvasContainer.addEventListener("wheel",(t=>{if(!e.isInRect(t))return;const i=new ei(t),s=e.layers.filter((e=>e.isActive())).sort(((e,t)=>Zt.compareZ(e,t)));ti.publishWheelEvent(s,i)}))}static publishPointerEvent(e,t){var i;null===(i=e.shift())||void 0===i||i.handlePointerEvent(t).then((i=>{i||this.publishPointerEvent(e,t)}))}static publishKeyEvent(e,t){var i;null===(i=e.shift())||void 0===i||i.handleKeyEvent(t).then((i=>{i||this.publishKeyEvent(e,t)}))}static publishWheelEvent(e,t){var i;null===(i=e.shift())||void 0===i||i.handleWheelEvent(t).then((i=>{i||this.publishWheelEvent(e,t)}))}}class ii extends Zt{constructor(e){super(!0,!1),e.registerEventListener(s.CHANGE_CURSOR,(e=>{this.changeCursor(e.cursor)}))}show(){super.show(),this.pointersCfg=ct.cfg("Pointers"),this.changeCursor(a.Pointer_Standard)}hide(){super.hide(),this.canvas.style.cursor=null}changeCursor(e){if(this.curUrl&&URL.revokeObjectURL(this.curUrl),!this.pointersCfg)return;const t=g(this.pointersCfg,a[e]),i=ct.getImage(t);this.curUrl=i.toDataURL(),this.canvas.style.cursor="url("+this.curUrl+"), auto"}}class si{constructor(){if(this.layers=[],this.width=U.Du,this.height=U.DG,this.ratio=U.Du/U.DG,this.gameCanvasContainer=document.getElementById("game-canvas-container"),this.gameCanvasContainer.focus(),this.eventMgr=new ti(this),!this.gameCanvasContainer)throw"Fatal error: game canvas container not found!";window.addEventListener("resize",(()=>this.onWindowResize())),this.onWindowResize(),this.cursorLayer=this.addLayer(new ii(this),1e3)}addLayer(e,t=0){return e.resize(this.width,this.height),e.setZIndex(t),this.layers.push(e),this.gameCanvasContainer.appendChild(e.canvas),e}redraw(){this.layers.forEach((e=>e.redraw()))}show(){this.layers.forEach((e=>e.show())),this.redraw()}hide(){this.layers.forEach((e=>e.hide()))}onWindowResize(){const e=this.gameCanvasContainer.offsetWidth,t=this.gameCanvasContainer.offsetHeight,i=Math.round(e/this.ratio);i>t?this.resize(Math.round(t*this.ratio),t):this.resize(e,i)}resize(e,t){this.width=e,this.height=t,this.layers.forEach((i=>{const s=i.canvas;i.resize(e,t),s!==i.canvas&&(this.gameCanvasContainer.removeChild(s),this.gameCanvasContainer.appendChild(i.canvas))})),this.redraw()}isInRect(e){if(this.layers.length<1)return!1;const t=this.layers[0];if(!t.isActive()||!t.canvas)return!1;const i=t.canvas.getBoundingClientRect(),s=e.clientX,r=e.clientY;return s>=i.left&&s<i.right&&r>=i.top&&r<i.bottom}publishEvent(e){b.publishEvent(e)}registerEventListener(e,t){b.registerEventListener(e,t)}}class ri extends I{}class ni extends ri{constructor(){super(s.COMMAND_CANCEL_BUILD_MODE)}}class ai extends Zt{constructor(e){super(!1,!1),this.rightDown={x:0,y:0},this.lastCursor=a.Pointer_Standard,this.parent=e}reset(){super.reset(),this.rightDown={x:0,y:0},this.lastCursor=a.Pointer_Standard}hide(){super.hide(),this.publishEvent(new _(a.Pointer_Standard))}handlePointerEvent(e){const t=this.sceneMgr.buildMarker;if(e.eventEnum===Jt.MOVE){const i=this.getTerrainPositionFromEvent(e);i&&this.sceneMgr.setTorchPosition(i),t.update(this.sceneMgr.terrain,i),this.updateCursor(e)}else if(e.eventEnum===Jt.UP){if(e.button===Ht.MAIN){if(G.buildModeSelection&&t.lastCheck){t.visibleSurfaces.forEach((e=>{e.surfaceType=T.POWER_PATH_BUILDING,e.updateTexture(),e.neighbors.forEach((e=>e.updateTexture()))}));const e=t.getBarrierLocations(),i=G.buildModeSelection.stats,s=(null==i?void 0:i.CostCrystal)||0,n=(null==i?void 0:i.CostOre)||0,a=new gt(t.primarySurface,t.secondarySurface,G.buildModeSelection);a.heading=t.heading,a.neededByType.set(r.BARRIER,e.length),a.neededByType.set(r.CRYSTAL,s),a.neededByType.set(r.ORE,n),G.buildingSites.push(a);const o=G.getClosestBuildingByType(t.primarySurface.getCenterWorld(),r.TOOLSTATION);o&&(o.spawnBarriers(e,a),o.spawnMaterials(r.CRYSTAL,s),o.spawnMaterials(r.ORE,n)),this.publishEvent(new O),this.publishEvent(new ni)}}else if(e.button===Ht.SECONDARY)if(Math.abs(e.clientX-this.rightDown.x)+Math.abs(e.clientY-this.rightDown.y)<3&&(G.selectionType===M.RAIDER||G.selectionType===M.GROUP)){const t=this.getTerrainPositionFromEvent(e);if(t){const e=this.sceneMgr.terrain.getSurfaceFromWorldXZ(t.x,t.y);e&&(e.isDrillable()?this.assignSurfaceJob(e.createDrillJob(),e,t):e.hasRubble()?this.assignSurfaceJob(e.createClearRubbleJob(),e,t):e.isWalkable()&&(G.selectedEntities.forEach((e=>e.setJob(new _t(t)))),G.selectedEntities.length>0&&this.publishEvent(new O)))}}else G.buildModeSelection=null,t.hideAllMarker()}else e.eventEnum===Jt.DOWN&&e.button===Ht.SECONDARY&&(this.rightDown.x=e.clientX,this.rightDown.y=e.clientY);return this.canvas.dispatchEvent(new PointerEvent(e.type,e)),new Promise((e=>e(!0)))}updateCursor(e){const[t,i]=this.toCanvasCoords(e.clientX,e.clientY),s=t/this.canvas.width*2-1,r=-i/this.canvas.height*2+1,n=new H.iMs;n.setFromCamera({x:s,y:r},this.sceneMgr.camera);const a=this.determineCursor(n);a!==this.lastCursor&&(this.lastCursor=a,this.publishEvent(new _(a)))}determineCursor(e){if(e.intersectObjects(G.raiders.map((e=>e.pickSphere))).length>0)return a.Pointer_Selected;{let t=e.intersectObjects(G.buildings.map((e=>e.pickSphere)));if(t.length>0)return a.Pointer_Selected;if(t=e.intersectObjects(this.sceneMgr.terrain.floorGroup.children),t.length>0){const e=t[0].object.userData;if(e&&e.hasOwnProperty("surface")){const t=e.surface;if(t)return t.surfaceType.cursor}}}return a.Pointer_Standard}handleKeyEvent(e){if(U.Sl&&e.eventEnum===Vt.UP&&G.selectionType===M.SURFACE){if("KeyC"===e.code)return G.selectedEntities.forEach((e=>{e.surfaceType.floor||e.collapse()})),this.publishEvent(new O),new Promise((e=>e(!0)));if("KeyF"===e.code)return G.selectedEntities.forEach((e=>{const t=e.terrain.findFallInTarget(e.x,e.y);e.surfaceType.floor||e.createFallin(t[0],t[1])})),this.publishEvent(new O),new Promise((e=>e(!0)))}return this.canvas.dispatchEvent(new KeyboardEvent(e.type,e)),new Promise((e=>e(!0)))}assignSurfaceJob(e,t,i){e&&(G.selectedEntities.forEach((s=>{s.hasTool(e.getRequiredTool())&&s.hasTraining(e.getRequiredTraining())?s.setJob(e):t.isWalkable()&&s.setJob(new _t(i))})),G.selectedEntities.length>0&&this.publishEvent(new O))}getTerrainPositionFromEvent(e){const[t,i]=this.toCanvasCoords(e.clientX,e.clientY),s=t/this.canvas.width*2-1,r=-i/this.canvas.height*2+1;return this.sceneMgr.getTerrainIntersectionPoint(s,r)}handleWheelEvent(e){return this.canvas.dispatchEvent(new WheelEvent(e.type,e)),new Promise((e=>e(!0)))}publishEvent(e){var t;null===(t=this.parent)||void 0===t||t.publishEvent(e)}registerEventListener(e,t){this.parent.registerEventListener(e,t)}}var oi=H.M8C.generateUUID;class li extends Zt{constructor(e){super(!0,!1),this.resolveCallbackByEventId=new Map,this.worker=e,this.sendMessage({type:et.INIT,resourceByName:ct.resourceByName,cfg:ct.configuration,stats:ct.stats}),this.worker.onmessage=e=>{const t=e.data;if(t.type===et.RESPONSE_EVENT){const e=t;this.resolveCallbackByEventId.get(e.eventId)(e.eventConsumed),this.resolveCallbackByEventId.delete(e.eventId)}else if(t.type===et.GAME_EVENT){const e=t.gameEvent;b.publishEvent(e)}else this.onMessage(t)||console.warn("Offscreen layer ignored message: "+et[t.type])},b.registerWorkerListener((e=>{if(e.guiForward)try{this.sendMessage({type:et.GAME_EVENT,gameEvent:e})}catch(t){console.warn("Could not send event to GUI worker: ",t,e)}}))}sendMessage(e,t){this.worker.postMessage(e,t)}reset(){this.sendMessage({type:et.RESET}),this.sendMessage({type:et.GAME_EVENT,gameEvent:new N}),this.sendMessage({type:et.GAME_EVENT,gameEvent:new k}),this.sendMessage({type:et.GAME_EVENT,gameEvent:new ge})}resize(e,t){const i=Number(this.canvas.style.zIndex)||0;this.canvas=document.createElement("canvas"),this.active||(this.canvas.style.visibility="hidden"),super.resize(e,t),this.setZIndex(i);const s=this.canvas.transferControlToOffscreen();this.sendMessage({type:et.CANVAS,canvas:s},[s])}redraw(){this.isActive()&&this.sendMessage({type:et.REDRAW})}handlePointerEvent(e){return[e.canvasX,e.canvasY]=this.toCanvasCoords(e.clientX,e.clientY),this.sendEventMessage(et.EVENT_POINTER,e)}handleKeyEvent(e){return this.sendEventMessage(et.EVENT_KEY,e)}handleWheelEvent(e){return[e.canvasX,e.canvasY]=this.toCanvasCoords(e.clientX,e.clientY),this.sendEventMessage(et.EVENT_POINTER,e)}sendEventMessage(e,t){const i=oi();return this.sendMessage({type:e,eventId:i,inputEvent:t}),new Promise((e=>this.resolveCallbackByEventId.set(i,e)))}}class hi extends li{constructor(){super(new Worker(new URL(i.p+i.u(588),i.b))),this.onOptionsShow=()=>console.log("Show options triggered")}onMessage(e){return e.type===et.SHOW_OPTIONS&&(this.onOptionsShow(),!0)}setSpaceToContinue(e){this.sendMessage({type:et.SPACE_TO_CONINUE,messageState:e})}}class ci extends li{constructor(){super(new Worker(new URL(i.p+i.u(633),i.b))),this.onSetSpaceToContinue=e=>console.log("set space to continue: "+e),this.onAbortGame=()=>console.log("abort the game"),this.onRestartGame=()=>console.log("pause the game")}onMessage(e){if(e.type===et.SPACE_TO_CONINUE)this.onSetSpaceToContinue(e.messageState);else if(e.type===et.GAME_ABORT)this.onAbortGame();else{if(e.type!==et.GAME_RESTART)return!1;this.onRestartGame()}return!0}setup(e,t){this.sendMessage({type:et.OVERLAY_SETUP,objectiveText:e,objectiveBackImgCfg:t})}showOptions(){this.sendMessage({type:et.SHOW_OPTIONS})}}class ui extends Zt{constructor(){super(!0,!0),this.selectStart=null}reset(){super.reset(),this.selectStart=null}handlePointerEvent(e){if(G.buildModeSelection)return new Promise((e=>e(!1)));const[t,i]=this.toCanvasCoords(e.clientX,e.clientY);if(e.eventEnum===Jt.DOWN){if(e.button===Ht.MAIN)return new Promise((e=>e(this.startSelection(t,i))))}else{if(e.eventEnum===Jt.MOVE)return new Promise((e=>e(this.changeSelection(t,i))));if(e.eventEnum===Jt.UP&&e.button===Ht.MAIN)return new Promise((e=>e(this.selectEntities(t,i))))}return new Promise((e=>e(!1)))}startSelection(e,t){return this.selectStart={x:e,y:t},!0}changeSelection(e,t){return!!this.selectStart&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="rgba(128, 192, 192, 0.5)",this.context.lineWidth=2,this.context.strokeRect(this.selectStart.x,this.selectStart.y,e-this.selectStart.x,t-this.selectStart.y),!0)}selectEntities(e,t){if(!this.selectStart)return!1;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.selectStart.x/this.canvas.width*2-1,s=-this.selectStart.y/this.canvas.height*2+1,r=e/this.canvas.width*2-1,n=-t/this.canvas.height*2+1;if(Math.abs(e-this.selectStart.x)<5&&Math.abs(t-this.selectStart.y)<5){const i=(this.selectStart.x+e)/this.canvas.width-1,s=-(this.selectStart.y+t)/this.canvas.height+1;this.sceneMgr.selectEntitiesByRay(i,s)}else this.sceneMgr.selectEntitiesInFrustum(i,s,r,n);return this.selectStart=null,!0}}var di=H.M8C.degToRad;class gi extends si{constructor(){super(),this.onLevelEnd=()=>console.log("Level aborted"),this.spawnRaiderInterval=null,this.gameLayer=this.addLayer(new ai(this),0),this.selectionLayer=this.addLayer(new ui,10),this.guiLayer=this.addLayer(new hi,20),this.overlayLayer=this.addLayer(new ci,30),this.worldMgr=new zt,this.gameLayer.worldMgr=this.worldMgr,this.sceneMgr=new at(this.gameLayer.canvas),this.gameLayer.sceneMgr=this.sceneMgr,this.selectionLayer.sceneMgr=this.sceneMgr,this.jobSupervisor=new Yt(this.worldMgr),this.guiMgr=new xt(this.worldMgr,this.sceneMgr),this.guiLayer.onOptionsShow=()=>this.overlayLayer.showOptions(),this.overlayLayer.onSetSpaceToContinue=e=>this.guiLayer.setSpaceToContinue(e),this.overlayLayer.onAbortGame=()=>this.onLevelEnd(),this.overlayLayer.onRestartGame=()=>this.restartLevel(),this.registerEventListener(s.REQUESTED_RAIDERS_CHANGED,(()=>{G.requestedRaiders>0&&!this.spawnRaiderInterval&&(this.spawnRaiderInterval=setInterval(this.checkSpawnRaiders.bind(this),U.IL))}))}startLevel(e){if(this.levelName=e,this.levelConf=ct.getResource("Levels").levelsByName[this.levelName],!this.levelConf)throw'Could not find level configuration for "'+this.levelName+'"';this.setupAndStartLevel()}restartLevel(){this.hide(),G.reset(),this.setupAndStartLevel()}setupAndStartLevel(){console.log("Starting level "+this.levelName+" - "+this.levelConf.fullName),this.worldMgr.setup(this.levelConf,(()=>this.onLevelEnd())),this.sceneMgr.setupScene(this.levelConf,this.worldMgr);const e=g(ct.getResource(this.levelConf.objectiveText),this.levelName);this.guiLayer.reset(),this.overlayLayer.setup(e.objective,this.levelConf.objectiveImage640x480);const t=ct.getResource(this.levelConf.oListFile);(class{static loadObjectList(e,t,i,s){Object.values(i).forEach((i=>{const r=i.type?i.type.toLowerCase():i.type,n=new H.FM8(i.xPos,i.yPos).addScalar(-1).multiplyScalar(U.pM),a=ct.cfg("BuildingTypes",i.type),o=jt(i.heading);if(r==="TVCamera".toLowerCase()){const e=t.getTerrainHeight(n.x,n.y),i=new H.Pa4(n.x,e,n.y-U.pM/2),s=new H.Pa4(5*U.pM,0,0).applyAxisAngle(new H.Pa4(0,1,0),o-Math.PI/16).add(i);t.camera.position.copy(s),t.camera.position.y=4.5*U.pM,t.controls.target.copy(i),t.controls.update(),t.setTorchPosition(new H.FM8(n.x,n.y-U.pM/2))}else if(r==="Pilot".toLowerCase()){const i=new Bt(e,t);i.changeActivity(),i.createPickSphere(),i.addToScene(n,o-Math.PI/2),i.group.visible?(G.raiders.push(i),b.publishEvent(new k)):G.raidersUndiscovered.push(i)}else if(a)this.createBuildingByName(a,e,t).placeDown(n,-o-Math.PI,s);else if(r==="PowerCrystal".toLowerCase())e.placeMaterial(new Ve(e,t),n);else if(r==="SmallSpider".toLowerCase()){const i=new Gt(e,t);i.changeActivity(),i.addToScene(n,o),G.spiders.push(i),i.surfaces.forEach((e=>G.spidersBySurface.getOrUpdate(e,(()=>[])).push(i))),i.startMoving()}else if(r==="Bat".toLowerCase()){const i=new Wt(e,t);i.changeActivity(),i.addToScene(n,o),G.bats.push(i),i.startRandomMove()}else console.warn("Object type "+i.type+" not yet implemented")}))}static createBuildingByName(e,t,i){const s=e.slice(e.lastIndexOf("/")+1).toLowerCase();if("toolstation"===s)return new Ct(t,i);if("teleports"===s)return new Rt(t,i);if("docks"===s)return new vt(t,i);if("powerstation"===s)return new At(t,i);if("barracks"===s)return new Et(t,i);if("upgrade"===s)return new Lt(t,i);if("geo-dome"===s)return new wt(t,i);if("orerefinery"===s)return new Tt(t,i);if("gunstation"===s)return new bt(t,i);if("teleportbig"===s)return new St(t,i);throw"Unknown building type: "+s}}).loadObjectList(this.worldMgr,this.sceneMgr,t,this.levelConf.disableStartTeleport),this.show()}show(){super.show(),this.sceneMgr.startScene(),this.worldMgr.start(),this.jobSupervisor.start()}hide(){this.spawnRaiderInterval=w(this.spawnRaiderInterval),this.jobSupervisor.stop(),this.worldMgr.stop(),this.sceneMgr.disposeScene(),super.hide()}resize(e,t){var i;super.resize(e,t),null===(i=this.sceneMgr)||void 0===i||i.resize(e,t)}checkSpawnRaiders(){if(G.requestedRaiders<1)return void(this.spawnRaiderInterval=w(this.spawnRaiderInterval));if(G.raiders.length>=G.getMaxRaiders())return;const e=G.getBuildingsByType(r.TOOLSTATION,r.TELEPORT_PAD);for(let t=0;t<e.length&&G.requestedRaiders>0;t++){const i=e[t];if(i.spawning)continue;G.requestedRaiders--,this.publishEvent(new de(G.requestedRaiders)),i.spawning=!0;const s=new Bt(this.worldMgr,this.sceneMgr),r=i.getHeading();s.changeActivity(Be.TeleportIn,(()=>{i.spawning=!1,s.changeActivity(),s.createPickSphere();const e=i.getPosition2D().add(new H.FM8(0,3*U.pM/4+y(U.pM/2)).rotateAround(new H.FM8(0,0),r+di(-10+y(20))));s.setJob(new _t(e)),G.raiders.push(s),this.publishEvent(new k)})),s.addToScene(new H.FM8(0,U.pM/2).rotateAround(new H.FM8(0,0),i.getHeading()).add(i.getPosition2D()),r)}}}class pi{constructor(){this.x=0,this.y=0,this.width=0,this.height=0,this.zIndex=100,this.scrollAffected=!1,this.needsRedraw=!1,this.hover=!1,this.pressed=!1,this.actionName="",this.targetIndex=0}static compareZ(e,t){return e.zIndex===t.zIndex?0:e.zIndex>t.zIndex?-1:1}checkHover(e,t){const i=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height;return this.hover!==i&&(this.hover=i,this.needsRedraw=!0,this.onHoverChange()),this.hover||(this.pressed=!1),this.hover}onHoverChange(){}checkSetPressed(){this.hover&&(this.pressed||(this.needsRedraw=!0),this.pressed=!0)}setReleased(){this.pressed&&(this.needsRedraw=!0),this.pressed=!1}draw(e){this.needsRedraw=!1}}class mi extends pi{constructor(e,t){super(),this.imgNormal=null,this.imgHover=null,this.imgPressed=null,this.tooltip="",this.imgNormal=ct.getImage(t.imgNormal),this.imgHover=ct.getImage(t.imgHover),this.imgPressed=ct.getImage(t.imgPressed),this.tooltip=(t.tooltip||"").replace(/_/g," "),this.width=Math.max(this.imgNormal.width,this.imgHover.width,this.imgPressed.width),this.height=Math.max(this.imgNormal.height,this.imgHover.height,this.imgPressed.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);let t=this.imgNormal;this.hover&&(t=this.imgHover),this.pressed&&(t=this.imgPressed),e.drawImage(t,this.x,this.y)}}class fi extends pi{constructor(e,t){super(),this.labelImgLo=null,this.labelImgHi=null,this.labelImgLo=e.loFont.createTextImage(t.label),this.labelImgHi=e.hiFont.createTextImage(t.label),this.width=Math.max(this.labelImgLo.width,this.labelImgHi.width),this.height=Math.max(this.labelImgLo.height,this.labelImgHi.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);const t=this.hover&&!this.pressed?this.labelImgHi:this.labelImgLo;e.drawImage(t,this.x,this.y)}}class yi extends Xt{constructor(e,t){super(),this.items=[],this.scrollY=0,this.scrollSpeedY=0,this.scrollInterval=null,this.screen=e,this.cfg=t,this.loFont=t.loFont?ct.getBitmapFont(t.loFont):null,this.hiFont=t.hiFont?ct.getBitmapFont(t.hiFont):null,this.menuImage=t.menuImage?ct.getImage(t.menuImage):null,this.titleImage=this.loFont.createTextImage(t.fullName),t.itemsLabel.forEach((e=>{e.label?this.items.push(new fi(this,e)):this.items.push(new mi(this,e))})),this.items.sort(((e,t)=>pi.compareZ(e,t))),this.onRedraw=e=>{e.drawImage(this.menuImage,0,-this.scrollY),t.displayTitle&&e.drawImage(this.titleImage,(this.fixedWidth-this.titleImage.width)/2,this.cfg.position[1]),this.items.forEach(((t,i)=>this.items[this.items.length-1-i].draw(e)))}}reset(){super.reset(),this.scrollY=0,this.scrollSpeedY=0}show(){super.show();const e=this;this.scrollInterval=setInterval((()=>{0!==e.scrollSpeedY&&e.setScrollY(e.scrollSpeedY)}),1e3/U.OK)}hide(){this.scrollInterval=w(this.scrollInterval),super.hide()}handlePointerEvent(e){if(e.eventEnum===Jt.MOVE){const[t,i]=this.toScaledCoords(e.clientX,e.clientY);let s=!1;if(this.items.forEach((e=>{if(s)e.hover&&(e.needsRedraw=!0),e.hover=!1,e.setReleased();else{const r=i+(e.scrollAffected?this.scrollY:0);s=e.checkHover(t,r)}})),this.cfg.canScroll){const e=100;i<e?this.setScrollSpeedY(-(e-i)):i>this.fixedHeight-e?this.setScrollSpeedY(i-(this.fixedHeight-e)):this.setScrollSpeedY(0)}}else e.eventEnum===Jt.DOWN?e.button===Ht.MAIN&&this.items.forEach((e=>e.checkSetPressed())):e.eventEnum===Jt.UP&&e.button===Ht.MAIN&&this.items.forEach((e=>{e.pressed&&(e.setReleased(),"next"===e.actionName.toLowerCase()?this.screen.showMainMenu(e.targetIndex):"selectlevel"===e.actionName.toLowerCase()?this.screen.selectLevel(e.levelKey):e.actionName&&console.warn("not implemented: "+e.actionName+" - "+e.targetIndex))}));return this.needsRedraw()&&this.redraw(),new Promise((e=>e(!1)))}setScrollSpeedY(e){this.scrollSpeedY=Math.sign(e)*Math.pow(Math.round(e/20),2)}handleWheelEvent(e){return this.cfg.canScroll?(this.setScrollY(e.deltaY),new Promise((e=>e(!0)))):new Promise((e=>e(!1)))}setScrollY(e){const t=this.scrollY;this.scrollY=Math.min(Math.max(this.scrollY+e,0),this.menuImage.height-this.fixedHeight),t!==this.scrollY&&this.redraw()}needsRedraw(){return this.items.some((e=>e.needsRedraw))}}class Ei extends pi{constructor(e,t,i){super(),this.imgActive=null,this.imgInactive=null,this.imgCross=null,this.unlocked=!1,this.levelKey="",this.layer=e,this.actionName="selectlevel",this.levelKey=t,this.x=i.frontEndX,this.y=i.frontEndY,this.zIndex=10,this.scrollAffected=!0;const[s,r,n]=i.menuBMP;this.imgActive=ct.getImage(s),this.imgInactive=ct.getImage(r),this.imgCross=ct.getImage(n),this.width=Math.max(this.imgActive.width,this.imgInactive.width,this.imgCross.width),this.height=Math.max(this.imgActive.height,this.imgInactive.height,this.imgCross.height),this.unlocked=i.frontEndOpen,this.unlocked=!0}draw(e){super.draw(e);let t=this.imgCross;this.unlocked&&(t=this.hover?this.imgActive:this.imgInactive),e.drawImage(t,this.x,this.y-this.layer.scrollY)}}class vi extends pi{constructor(e,t){super(),this.zIndex=50,this.context=J(e.width,e.height),this.context.putImageData(e,0,0),this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}checkHover(e,t){const i=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height&&this.context.getImageData(e,t,1,1).data[3]>0;return this.hover!==i&&(this.needsRedraw=!0),this.hover=i,this.hover}draw(e){super.draw(e),e.drawImage(this.context.canvas,this.x,this.y,this.width,this.height)}}class wi extends pi{constructor(e,t){super(),this.imgFirstLine=null,this.imgSecondLine=null,this.font=e,this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}setFirstLine(e){this.imgFirstLine=e?this.font.createTextImage(e):null}setSecondLine(e){this.imgSecondLine=e?this.font.createTextImage(e):null}draw(e){super.draw(e);const t=this.x+this.width/2,i=this.y+this.height/2;this.imgFirstLine&&e.drawImage(this.imgFirstLine,t-this.imgFirstLine.width/2,i-this.imgFirstLine.height),this.imgSecondLine&&e.drawImage(this.imgSecondLine,t-this.imgSecondLine.width/2,i)}}class bi extends yi{constructor(e,t,i){super(e,t);const s=ct.getResource("Levels"),r=new Ti;this.items.push(new vi(r.panelImgData,r.panelPos));const n=new wi(ct.getDefaultFont(),r.window);n.setFirstLine(i?r.level:r.tutorial),this.items.push(n),Object.keys(s.levelsByName).forEach((e=>{const t=s.levelsByName[e],i=new Ei(this,e,t);i.onHoverChange=()=>n.setSecondLine(i.hover?t.fullName:""),this.items.push(i)})),this.items.sort(((e,t)=>pi.compareZ(e,t)))}}class Ti{constructor(){this.window={x:0,y:0,w:0,h:0},this.panelPos={x:0,y:0,w:0,h:0},this.level="",this.tutorial="";const e=ct.cfg("Menu","LevelText"),t=g(e,"Window");this.window={x:t[0],y:t[1],w:t[2],h:t[3]};const i=g(e,"Panel");this.panelImgData=ct.getImageData(i[0]),this.panelPos={x:i[1],y:i[2],w:i[3],h:i[4]},this.level=Ti.parseLabel(g(e,"Level")),this.tutorial=Ti.parseLabel(g(e,"Tutorial"))}static parseLabel(e){return e?Array.isArray(e)?e.join(",").replace(/_/g," "):e.replace(/_/g," "):""}}class Ai extends si{constructor(){super(),this.onLevelSelected=null,this.menus=[],ct.getResource("MainMenuFull").menus.forEach((e=>{let t;t="Levels"===e.title?new bi(this,e,!0):"Tutorials"===e.title?new bi(this,e,!1):new yi(this,e),this.menus.push(t),this.addLayer(t)}))}showMainMenu(e=0){this.menus.forEach(((t,i)=>i===e?t.show():t.hide())),this.cursorLayer.show()}showLevelSelection(){this.showMainMenu(1)}selectLevel(e){this.hide(),this.onLevelSelected(e)}}class Si extends pi{constructor(e){let t,i,s,r;super(),this.disabled=!1,this.visible=!0,[t,i,s,r,this.x,this.y]=e,this.imgNormal=ct.getImage(t),this.imgHover=ct.getImage(i),this.imgPressed=ct.getImage(s),this.imgDisabled=ct.getImage(r),this.width=this.imgNormal.width,this.height=this.imgNormal.height}draw(e){if(super.draw(e),!this.visible)return;let t=this.imgNormal;this.disabled?t=this.imgDisabled:this.pressed?t=this.imgPressed:this.hover&&(t=this.imgHover),e.drawImage(t,this.x,this.y)}}class Ri extends si{constructor(){super(),this.cfg=null,this.resultIndex=0,this.resultLastIndex=0,this.images=[],this.boxes=[],this.fonts={},this.texts=[],this.uncoverTimeout=null,this.cfg=ct.getResource("Reward"),this.titleFont=ct.getBitmapFont(this.cfg.titleFont);const e=ct.getImage(this.cfg.wallpaper);this.addLayer(new Xt).onRedraw=t=>t.drawImage(e,0,0),this.cfg.images.forEach((e=>{this.images.push({img:ct.getImage(e.filePath),x:e.x,y:e.y})})),this.cfg.boxImages.forEach((e=>{this.boxes.push({img:ct.getImage(e.filePath),x:e.x,y:e.y})})),Object.keys(this.cfg.fonts).forEach(((e,t)=>{const i=ct.getBitmapFont(this.cfg.fonts[e]);this.fonts[e.toLowerCase()]=i;const s=this.cfg.texts[t],r=t<9?i:ct.getBitmapFont(this.cfg.backFont);this.texts.push(r.createTextImage(s.text))})),this.resultsLayer=this.addLayer(new Xt),this.resultsLayer.handlePointerEvent=e=>e.eventEnum===Jt.UP?(this.uncoverTimeout=v(this.uncoverTimeout),this.uncoverTimeout=null,this.resultIndex=this.resultLastIndex,this.btnSave.visible=!0,this.btnAdvance.visible=!0,this.redraw(),new Promise((e=>e(!0)))):new Promise((e=>e(!1))),this.descriptionTextLayer=this.addLayer(new Xt,20),this.btnLayer=this.addLayer(new Xt,50),this.btnSave=new Si(this.cfg.saveButton),this.btnSave.disabled=!0,this.btnAdvance=new Si(this.cfg.advanceButton),this.btnLayer.handlePointerEvent=e=>{if(e.eventEnum===Jt.MOVE){const[t,i]=this.btnLayer.toScaledCoords(e.clientX,e.clientY);this.btnSave.checkHover(t,i),this.btnAdvance.checkHover(t,i)}else e.eventEnum===Jt.DOWN?e.button===Ht.MAIN&&(this.btnSave.checkSetPressed(),this.btnAdvance.checkSetPressed()):e.eventEnum===Jt.UP&&e.button===Ht.MAIN&&(this.btnSave.pressed?this.btnSave.setReleased():this.btnAdvance.pressed&&(this.btnAdvance.setReleased(),this.hide(),this.onAdvance()));return(this.btnSave.needsRedraw||this.btnAdvance.needsRedraw)&&this.redraw(),new Promise((e=>e(!1)))},this.btnLayer.onRedraw=e=>{this.btnSave.draw(e),this.btnAdvance.draw(e)}}show(){this.resultIndex=0,this.btnSave.visible=!1,this.btnAdvance.visible=!1,this.uncoverResult();const e=this.titleFont.createTextImage(G.levelFullName);let t=this.cfg.quitText;this.resultLastIndex=this.images.length-2,G.resultState===B.COMPLETE?(t=this.cfg.completeText,this.resultLastIndex=this.images.length-1):G.resultState===B.FAILED&&(t=this.cfg.failedText);const i=[];i.push(this.fonts.crystals.createTextImage(this.percentString(G.numCrystal,G.neededCrystals))),i.push(this.fonts.ore.createTextImage(this.percentString(G.numOre,G.totalOres))),i.push(this.fonts.diggable.createTextImage(this.percentString(G.remainingDiggables,G.totalDiggables,!0))),i.push(this.fonts.constructions.createTextImage(G.buildings.length.toString())),i.push(this.fonts.caverns.createTextImage(this.percentString(G.discoveredCaverns,G.totalCaverns))),i.push(this.fonts.figures.createTextImage(this.percentString(G.raiders.length,G.getMaxRaiders()))),i.push(this.fonts.rockmonsters.createTextImage(this.percentString(0))),i.push(this.fonts.oxygen.createTextImage(this.percentString(G.airLevel))),i.push(this.fonts.timer.createTextImage(this.timeString(G.gameTimeSeconds))),i.push(this.fonts.score.createTextImage(this.percentString(G.score)));const s=this.titleFont.createTextImage(t);this.resultsLayer.onRedraw=t=>{t.clearRect(0,0,this.resultsLayer.fixedWidth,this.resultsLayer.fixedHeight);for(let e=0;e<=this.resultIndex;e++){const i=this.images[e];i&&t.drawImage(i.img,i.x,i.y)}for(let e=0;e<=this.resultIndex;e++){const i=this.boxes[e];i&&t.drawImage(i.img,i.x,i.y)}for(let e=0;e<=this.resultIndex;e++){const s=this.cfg.texts[e],r=i[e];r&&t.drawImage(r,s.x-r.width/2,s.y)}t.drawImage(e,this.resultsLayer.fixedWidth/2-e.width/2,this.cfg.vertSpacing-e.height/2),t.drawImage(s,this.resultsLayer.fixedWidth/2-s.width/2,this.cfg.vertSpacing+e.height/2)},this.descriptionTextLayer.onRedraw=e=>{const t=this.texts[this.resultIndex];e.clearRect(0,this.cfg.textPos[1],this.descriptionTextLayer.fixedWidth,this.descriptionTextLayer.fixedHeight-this.cfg.textPos[1]);const i=this.resultIndex!==this.images.length-1?this.cfg.textPos[0]:305,s=this.resultIndex!==this.images.length-1?this.cfg.textPos[1]:195;e.drawImage(t,i-t.width/2,s)},super.show()}percentString(e,t=1,i=!1){0===t&&(t=1);let s=Math.round(100*Math.max(Math.min(e/t,1),0));return i&&(s=100-s),s.toString()+"%"}padLeft(e,t="0",i=2){for(;e.length<i;)e=t+e;return e}timeString(e){const t=this.padLeft((e%60).toString()),i=Math.floor(e/60),s=this.padLeft((i%60).toString());return this.padLeft(Math.floor(i/60).toString())+":"+s+":"+t}uncoverResult(){this.uncoverTimeout=setTimeout((()=>{this.uncoverTimeout=null,this.resultIndex++,this.resultIndex<this.resultLastIndex?this.uncoverResult():(this.btnSave.visible=!0,this.btnAdvance.visible=!0),this.redraw()}),1e3*this.cfg.timer)}}U.Sl&&console.warn("DEV MODE ACTIVE");const Ci=new class extends si{constructor(){super(),this.assetIndex=0,this.layer=this.addLayer(new Xt)}show(){this.layers.forEach((e=>{e!==this.cursorLayer&&e.show()})),this.setLoadingMessage("Loading...")}setLoadingMessage(e){this.layer.onRedraw=t=>{t.fillStyle="black",t.fillRect(0,0,this.layer.fixedWidth,this.layer.fixedHeight),t.font="24px Arial",t.fillStyle="white",t.fillText("Loading Rock Raiders",20,this.layer.fixedHeight-50),t.font="18px Arial",t.fillStyle="white",t.fillText(e,20,this.layer.fixedHeight-20)},this.redraw()}enableGraphicMode(e){const t=ct.getImage(ct.cfg("Main","LoadScreen")),i=ct.getImage(ct.cfg("Main","ProgressBar")),s=ct.getDefaultFont().createTextImage(ct.cfg("Main","LoadingText"));this.layer.onRedraw=r=>{r.drawImage(t,0,0);const n=353*(this.assetIndex<e?Math.round(this.assetIndex/e):1);r.drawImage(i,142,450,n,9),r.drawImage(s,Math.round(320-s.width/2),Math.round(456-s.height/2))},this.cursorLayer.show(),this.redraw()}increaseLoadingState(){this.assetIndex++,this.redraw()}},Li=new u.WadFileSelectionModal("game-container"),Mi=new c.GithubBox("game-container"),Pi=new h.ClearCacheButton("game-container");Li.onStart=(e,t)=>{ct.startLoadingFromUrl(e,t)},ct.onMessage=e=>{Ci.setLoadingMessage(e)},ct.onCacheMissed=()=>{Li.show()},ct.onInitialLoad=e=>{Li.hide(),Ci.enableGraphicMode(e)},ct.onAssetLoaded=()=>{Ci.increaseLoadingState()},ct.onLoadDone=()=>{const e=new Ai,t=new gi,i=new Ri;e.onLevelSelected=i=>{try{t.startLevel(i)}catch(s){console.error("Could not load level: "+i,s),t.hide(),e.showLevelSelection()}},t.onLevelEnd=()=>{t.hide(),i.show()},i.onAdvance=()=>{G.reset(),e.showLevelSelection()},Ci.hide(),Mi.hide(),Pi.hide();const s=new URLSearchParams(window.location.search),r=s.get("entry");U.Sl&&r?(G.numOre=Number(s.get("numOre"))||0,G.numCrystal=Number(s.get("numCrystal"))||0,"level"===r?e.showLevelSelection():"reward"===r?i.show():"random"===r?e.selectLevel("Level"+("00"+f(1,25)).substr(-2)):r&&e.selectLevel(r)):e.showMainMenu()},Ci.show(),ct.startLoadingFromCache()},848:(e,t,i)=>{"use strict";i.d(t,{Sl:()=>s,UV:()=>r,$I:()=>n,Cw:()=>a,Ob:()=>o,IL:()=>l,d:()=>h,oq:()=>c,SO:()=>u,ED:()=>d,a4:()=>g,Du:()=>p,DG:()=>m,pM:()=>f,OK:()=>y});const s=!1,r="RockRaidersWeb",n=1e3,a=5e3,o=5,l=1e3,h=12,c=10,u=5e3,d=.1,g=5,p=640,m=480,f=40,y=30},351:(e,t,i)=>{"use strict";e.exports=i.p+"266ca63177bca6f330a7.png"}}]);
//# sourceMappingURL=643.index.js.map