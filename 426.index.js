(self.webpackChunkrock_raiders_web=self.webpackChunkrock_raiders_web||[]).push([[426,694],{694:(t,e,n)=>{"use strict";n.r(e),n.d(e,{WadFileSelectionModal:()=>i});var r=n(169),i=function(){function t(e){this.onStart=null;var n=document.getElementById(e).appendChild(document.createElement("div"));n.classList.add("modal"),n.tabIndex=-1,n.setAttribute("role","dialog"),n.setAttribute("aria-hidden","true");var i=n.appendChild(document.createElement("div"));i.classList.add("modal-dialog"),n.setAttribute("role","document");var o=i.appendChild(document.createElement("div"));o.classList.add("modal-content");var a=o.appendChild(document.createElement("div"));a.classList.add("modal-header");var s=a.appendChild(document.createElement("h5"));s.classList.add("modal-title"),s.innerText="Load .wad files",s.id="wadfileSelectModalLabel",n.setAttribute("aria-labelledby",s.id);var u=o.appendChild(document.createElement("div"));u.classList.add("modal-body"),u.appendChild(document.createElement("p")).innerText="Assets not included! In order to play the game, please select the game files.";var c=u.appendChild(document.createElement("nav")).appendChild(document.createElement("div"));c.id="nav-tab",c.classList.add("nav","nav-tabs"),c.setAttribute("role","tablist");var l=t.appendNavButton(c,!0,"nav-file-tab","nav-file","Local files (recommended)"),h=t.appendNavButton(c,!1,"nav-url-tab","nav-url","Online from URL"),p=u.appendChild(document.createElement("div"));p.classList.add("tab-content"),this.appendNavFileTab(p,l.id),this.appendNavUrlTab(p,h.id),this.modal=new r.u_(n,{backdrop:"static",keyboard:!1})}return t.appendNavButton=function(t,e,n,r,i){var o=t.appendChild(document.createElement("button"));return o.classList.add("nav-link"),e&&o.classList.add("active"),o.id=n,o.setAttribute("data-bs-toggle","tab"),o.setAttribute("data-bs-target","#"+r),o.type="button",o.setAttribute("role","tab"),o.setAttribute("aria-controls",r),o.setAttribute("aria-selected",String(e)),o.innerText=i,o},t.prototype.appendNavFileTab=function(e,n){var r=this,i=t.appendNavTab(e,!0,"nav-file",n),o=t.appendWadFileGroup(i,"wad0-file","LegoRR0.wad"),a=t.appendWadFileGroup(i,"wad1-file","LegoRR1.wad"),s=i.appendChild(document.createElement("button"));s.type="submit",s.classList.add("btn","btn-primary","float-end"),s.id="button-start-file",s.innerText="Start Game",s.addEventListener("click",(function(){s.disabled=!0;var t=URL.createObjectURL(o.files[0]),e=URL.createObjectURL(a.files[0]);r.onStart(t,e)}))},t.appendWadFileGroup=function(t,e,n){var r=t.appendChild(document.createElement("div"));r.classList.add("my-3");var i=r.appendChild(document.createElement("label"));i.setAttribute("for",e),i.classList.add("form-label"),i.innerHTML='Select <span class="fw-bold">'+n+"</span> here:";var o=r.appendChild(document.createElement("input"));return o.type="file",o.classList.add("form-control"),o.id=e,o.required=!0,o},t.prototype.appendNavUrlTab=function(e,n){var r=this,i=t.appendNavTab(e,!1,"nav-url",n),o=i.appendChild(document.createElement("div"));o.classList.add("my-3"),o.innerText="Direct links with correct Allow-Origin-CORS-Headers required here.";var a=t.appendWadUrlGroup(i,"wad0-url","LegoRR0.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),s=t.appendWadUrlGroup(i,"wad1-url","LegoRR1.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),u=i.appendChild(document.createElement("button"));u.type="submit",u.classList.add("btn","btn-primary","float-end"),u.id="button-start-url",u.innerText="Start Game",u.addEventListener("click",(function(){u.disabled=!0,r.onStart(a.value,s.value)}))},t.appendNavTab=function(t,e,n,r){var i=t.appendChild(document.createElement("div"));return i.classList.add("tab-pane","fade"),e&&i.classList.add("show","active"),i.id=n,i.setAttribute("role","tabpanel"),i.setAttribute("aria-labelledby",r),i},t.appendWadUrlGroup=function(t,e,n,r){var i=t.appendChild(document.createElement("div"));i.classList.add("my-3");var o=i.appendChild(document.createElement("label"));o.setAttribute("for",e),o.classList.add("form-label"),o.innerHTML='Enter url for <span class="fw-bold">'+n+"</span> here:";var a=i.appendChild(document.createElement("input"));return a.type="url",a.classList.add("form-control"),a.id=e,a.required=!0,a.value=r,a},t.prototype.show=function(){this.modal.show()},t.prototype.hide=function(){this.modal.hide()},t}()},426:(t,e,n)=>{"use strict";n.r(e);var r,i=n(694);!function(t){t[t.SELECTED_SURFACE=0]="SELECTED_SURFACE",t[t.SELECTED_BUILDING=1]="SELECTED_BUILDING",t[t.SELECTED_RAIDER=2]="SELECTED_RAIDER",t[t.SELECTED_VEHICLE=3]="SELECTED_VEHICLE",t[t.DESELECTED_ENTITY=4]="DESELECTED_ENTITY",t[t.JOB_CREATE=5]="JOB_CREATE",t[t.JOB_DELETE=6]="JOB_DELETE",t[t.RAIDER_REQUESTED=7]="RAIDER_REQUESTED",t[t.MATERIAL_AMOUNT_CHANGED=8]="MATERIAL_AMOUNT_CHANGED",t[t.ENTITY_ADDED=9]="ENTITY_ADDED",t[t.ENTITY_REMOVED=10]="ENTITY_REMOVED",t[t.CAVERN_DISCOVERED=11]="CAVERN_DISCOVERED",t[t.ORE_FOUND=12]="ORE_FOUND",t[t.BUILDING_UPGRADED=13]="BUILDING_UPGRADED",t[t.RAIDER_TRAINED=14]="RAIDER_TRAINED",t[t.LOCATION_DEATH=15]="LOCATION_DEATH",t[t.LOCATION_MONSTER=16]="LOCATION_MONSTER",t[t.LOCATION_CRYSTAL_FOUND=17]="LOCATION_CRYSTAL_FOUND",t[t.LOCATION_UNDER_ATTACK=18]="LOCATION_UNDER_ATTACK",t[t.LOCATION_LANDSLIDE=19]="LOCATION_LANDSLIDE",t[t.LOCATION_POWER_DRAIN=20]="LOCATION_POWER_DRAIN",t[t.LOCATION_SLUG_EMERGE=21]="LOCATION_SLUG_EMERGE",t[t.LOCATION_RAIDER_DISCOVERED=22]="LOCATION_RAIDER_DISCOVERED",t[t.SURFACE_CHANGED=23]="SURFACE_CHANGED",t[t.AIR_LEVEL_CHANGED=24]="AIR_LEVEL_CHANGED",t[t.CANCEL_BUILD_MODE=25]="CANCEL_BUILD_MODE",t[t.CHANGE_CURSOR=26]="CHANGE_CURSOR"}(r||(r={}));var o,a,s=function(){function t(){}return t.publishEvent=function(t){this.blockedEvents.includes(t.eventKey)||(t.isLocal||console.log("Event published: "+r[t.eventKey]),this.blockedEvents.push(t.eventKey),this.getListener(t.eventKey).forEach((function(e){return e(t)})),this.blockedEvents.remove(t.eventKey))},t.registerEventListener=function(t,e){this.getListener(t).push(e)},t.getListener=function(t){return this.eventListener.getOrUpdate(t,(function(){return[]}))},t.eventListener=new Map,t.blockedEvents=[],t}(),u=function(t){this.eventKey=t},c=(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),l=function(t){function e(e){var n=t.call(this,e)||this;return n.isLocal=!0,n}return c(e,t),e}(u),h=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e}(l),p=function(t){function e(e){var n=t.call(this,r.SELECTED_SURFACE)||this;return n.surface=e,n}return c(e,t),e}(h),f=function(t){function e(e){var n=t.call(this,r.SELECTED_BUILDING)||this;return n.building=e,n}return c(e,t),e}(h),d=function(t){function e(e){var n=t.call(this,r.SELECTED_RAIDER)||this;return n.raider=e,n}return c(e,t),e}(h),y=function(t){function e(){return t.call(this,r.DESELECTED_ENTITY)||this}return c(e,t),e}(l),g=function(t){function e(e){var n=t.call(this,r.SURFACE_CHANGED)||this;return n.surface=e,n}return c(e,t),e}(l),v=function(t){function e(){return t.call(this,r.AIR_LEVEL_CHANGED)||this}return c(e,t),e}(l),m=function(t){function e(){return t.call(this,r.CANCEL_BUILD_MODE)||this}return c(e,t),e}(l),w=function(t){function e(e){var n=t.call(this,r.CHANGE_CURSOR)||this;return n.cursor=e,n}return c(e,t),e}(l),b=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),_=function(t){function e(e){var n=t.call(this,e)||this;return n.isLocal=!1,n}return b(e,t),e}(u),O=function(t){function e(e,n){var r=t.call(this,e)||this;return r.job=n,r}return b(e,t),e}(_),E=function(t){function e(e){return t.call(this,r.JOB_CREATE,e)||this}return b(e,t),e}(O),P=function(t){function e(e){return t.call(this,r.JOB_DELETE,e)||this}return b(e,t),e}(O),T=function(t){function e(){return t.call(this,r.RAIDER_REQUESTED)||this}return b(e,t),e}(_),S=function(t){function e(e){var n=t.call(this,r.MATERIAL_AMOUNT_CHANGED)||this;return n.entityType=e,n}return b(e,t),e}(_),I=function(t){function e(e){var n=t.call(this,r.ENTITY_ADDED)||this;return n.superType=e.superType,n.entity=e,n}return b(e,t),e}(_),C=(b((function(t){var e=a.call(this,r.ENTITY_REMOVED)||this;return e.superType=t.superType,e.entity=t,e}),a=_),function(t){function e(){return t.call(this,r.CAVERN_DISCOVERED)||this}return b(e,t),e}(_)),R=function(t){function e(){return t.call(this,r.ORE_FOUND)||this}return b(e,t),e}(_),L=function(t){function e(e){var n=t.call(this,r.BUILDING_UPGRADED)||this;return n.building=e,n}return b(e,t),e}(_),A=function(t){function e(e,n){var i=t.call(this,r.RAIDER_TRAINED)||this;return i.entity=e,i.training=n,i}return b(e,t),e}(_),M=.1,x=40,D=n(212);function k(t){if(!t)return t;var e=t.toString().replace(/\\/g,"/");e.startsWith("/")&&(e=e.substring(1));var n=e.lastIndexOf("/");return e.substring(n+1)}function N(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return e.forEach((function(e){t=(t=Object.keys(t).filter((function(t){return t.toLowerCase()===e.toLowerCase()})).map((function(e){return t[e]})))?t[0]:t})),t}function B(t){return(new TextDecoder).decode(t).replace(/\0/g,"")}function j(t){return B(t).replace(/\\/g,"/")}function F(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}function U(t){return F(0,t)}function W(){return 2*F(0,1)-1}function H(t){return t&&clearTimeout(t),null}function G(t){return t&&clearInterval(t),null}Array.prototype.remove=function(t){var e=this.indexOf(t);-1!==e&&this.splice(e,1)},Array.prototype.count=function(t){var e=0;return this.forEach((function(n){return t(n)&&e++})),e},Map.prototype.getOrUpdate=function(t,e){var n=this.get(t);return void 0===n&&(n=e(),this.set(t,n)),n};var J=function(){function t(t,e){this.mesh=null,this.textureSequences=[],this.mesh=t,this.textureSequences=e}return t.prototype.dispose=function(){var t;this.textureSequences.forEach((function(t){return G(t)})),this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach((function(t){return t.dispose()})):null===(t=this.mesh.material)||void 0===t||t.dispose()},t}();function V(t,e){if(t<1||e<1)return console.error("Can't create context with size "+t+" x "+e),function(t,e){const n=V(64,64);for(let t=0;t<64;t+=16)for(let e=0;e<64;e+=16)n.fillStyle=e/16%2==t/16%2?"rgb(0,255,255)":"rgb(255,0,255)",n.fillRect(e,t,16,16);return n}();const n=document.createElement("canvas");n.setAttribute("width",t),n.setAttribute("height",e);const r=n.getContext("2d");return r.width=t,r.height=e,r}function Y(t,e){const n=new ImageData(t,e);for(let r=0;r<e;r+=16)for(let e=0;e<t;e+=16){const t=e/16%2==r/16%2;for(let i=e;i<e+16;i++)for(let e=r;e<r+16;e++)X(n,i,e,t?0:255,t?255:0,255)}return n}function X(t,e,n,r,i,o,a=255){const s=4*(n*t.width+e);t.data[s]=r,t.data[s+1]=i,t.data[s+2]=o,t.data[s+3]=a}function K(t,e,n){const r=4*(n*t.width+e);return{r:t.data[r],g:t.data[r+1],b:t.data[r+2],a:t.data[r+3]}}var q,z=function(){this.carryNullName="",this.depositNullName="",this.toolNullName="",this.mediumPoly={},this.highPoly={},this.fPPoly={},this.activities=new Map},Z=n(886),Q=n(466),$=function(){function t(){this.stats=new Q,this.stats.setMode(0),this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement),this.hide()}return t.prototype.show=function(){this.stats.domElement.style.visibility="visible"},t.prototype.hide=function(){this.stats.domElement.style.visibility="hidden"},t.prototype.renderStart=function(){this.stats.begin()},t.prototype.renderDone=function(){this.stats.end()},t}(),tt=function(t,e){this.location=t,this.heading=t.clone().sub(e).angle(),t.y===e.y?this.heading-=Math.PI/2:this.heading+=Math.PI/2};!function(t){t[t.Pointer_Blank=0]="Pointer_Blank",t[t.Pointer_Standard=1]="Pointer_Standard",t[t.Pointer_Drill=2]="Pointer_Drill",t[t.Pointer_CantDrill=3]="Pointer_CantDrill",t[t.Pointer_Clear=4]="Pointer_Clear",t[t.Pointer_Go=5]="Pointer_Go",t[t.Pointer_CantGo=6]="Pointer_CantGo",t[t.Pointer_Teleport=7]="Pointer_Teleport",t[t.Pointer_CantTeleport=8]="Pointer_CantTeleport",t[t.Pointer_Reinforce=9]="Pointer_Reinforce",t[t.Pointer_CantReinforce=10]="Pointer_CantReinforce",t[t.Pointer_Selected=11]="Pointer_Selected",t[t.Pointer_RadarPan=12]="Pointer_RadarPan",t[t.Pointer_TrackObject=13]="Pointer_TrackObject",t[t.Pointer_Zoom=14]="Pointer_Zoom",t[t.Pointer_CantZoom=15]="Pointer_CantZoom",t[t.Pointer_Help=16]="Pointer_Help",t[t.Pointer_CantHelp=17]="Pointer_CantHelp",t[t.Pointer_PutDown=18]="Pointer_PutDown",t[t.Pointer_GetIn=19]="Pointer_GetIn",t[t.Pointer_GetOut=20]="Pointer_GetOut",t[t.Pointer_Okay=21]="Pointer_Okay",t[t.Pointer_NotOkay=22]="Pointer_NotOkay",t[t.Pointer_CanBuild=23]="Pointer_CanBuild",t[t.Pointer_CannotBuild=24]="Pointer_CannotBuild",t[t.Pointer_Dynamite=25]="Pointer_Dynamite",t[t.Pointer_CantDynamite=26]="Pointer_CantDynamite",t[t.Pointer_PickUp=27]="Pointer_PickUp",t[t.Pointer_CantPickUp=28]="Pointer_CantPickUp",t[t.Pointer_PickUpOre=29]="Pointer_PickUpOre",t[t.Pointer_LegoManCantDig=30]="Pointer_LegoManCantDig",t[t.Pointer_VehicleCantDig=31]="Pointer_VehicleCantDig",t[t.Pointer_LegoManDig=32]="Pointer_LegoManDig",t[t.Pointer_VehicleDig=33]="Pointer_VehicleDig",t[t.Pointer_LegoManCantPickUp=34]="Pointer_LegoManCantPickUp",t[t.Pointer_VehicleCantPickUp=35]="Pointer_VehicleCantPickUp",t[t.Pointer_LegoManPickUp=36]="Pointer_LegoManPickUp",t[t.Pointer_VehiclePickUp=37]="Pointer_VehiclePickUp",t[t.Pointer_LegoManCantGo=38]="Pointer_LegoManCantGo",t[t.Pointer_VehicleCantGo=39]="Pointer_VehicleCantGo",t[t.Pointer_LegoManGo=40]="Pointer_LegoManGo",t[t.Pointer_VehicleGo=41]="Pointer_VehicleGo",t[t.Pointer_LegoManClear=42]="Pointer_LegoManClear",t[t.Pointer_VehicleClear=43]="Pointer_VehicleClear",t[t.Pointer_SurfaceType_Immovable=44]="Pointer_SurfaceType_Immovable",t[t.Pointer_SurfaceType_Hard=45]="Pointer_SurfaceType_Hard",t[t.Pointer_SurfaceType_Medium=46]="Pointer_SurfaceType_Medium",t[t.Pointer_SurfaceType_Loose=47]="Pointer_SurfaceType_Loose",t[t.Pointer_SurfaceType_Soil=48]="Pointer_SurfaceType_Soil",t[t.Pointer_SurfaceType_OreSeam=49]="Pointer_SurfaceType_OreSeam",t[t.Pointer_SurfaceType_CrystalSeam=50]="Pointer_SurfaceType_CrystalSeam",t[t.Pointer_SurfaceType_RechargeSeam=51]="Pointer_SurfaceType_RechargeSeam"}(q||(q={}));var et,nt=function(){function t(t){void 0===t&&(t={}),this.shaping=!1,this.matIndex="00",this.floor=!1,this.selectable=!1,this.drillable=!1,this.drillableHard=!1,this.explodable=!1,this.reinforcable=!1,this.cursor=q.Pointer_Standard,Object.assign(this,t)}return t.getByNum=function(e){switch(e){case 0:return t.POWER_PATH_BUILDING;case 1:return t.SOLID_ROCK;case 2:return t.HARD_ROCK;case 3:return t.LOOSE_ROCK;case 4:case 5:return t.DIRT;case 6:return t.LAVA;case 8:return t.ORE_SEAM;case 9:return t.WATER;case 10:return t.CRYSTAL_SEAM;case 11:return t.RECHARGE_SEAM;case 30:case 40:return t.SLUG_HOLE;case 100:return t.RUBBLE4;case 101:return t.RUBBLE3;case 102:return t.RUBBLE2;case 103:return t.RUBBLE1;default:return console.error("Unexpected surface type num: "+e),t.SOLID_ROCK}},t.GROUND=new t({name:"ground",floor:!0,selectable:!0}),t.SOLID_ROCK=new t({name:"solid rock",shaping:!0,matIndex:"5",cursor:q.Pointer_SurfaceType_Immovable}),t.HARD_ROCK=new t({name:"hard rock",shaping:!0,matIndex:"4",selectable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:q.Pointer_SurfaceType_Hard}),t.LOOSE_ROCK=new t({name:"loose rock",shaping:!0,matIndex:"3",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:q.Pointer_SurfaceType_Medium}),t.DIRT=new t({name:"dirt",shaping:!0,matIndex:"1",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:q.Pointer_SurfaceType_Loose}),t.SLUG_HOLE=new t({name:"slug hole",floor:!0,matIndex:"30"}),t.LAVA=new t({name:"lava",floor:!0,matIndex:"46"}),t.ORE_SEAM=new t({name:"ore seam",matIndex:"40",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:q.Pointer_SurfaceType_OreSeam}),t.WATER=new t({name:"water",floor:!0,matIndex:"45"}),t.CRYSTAL_SEAM=new t({name:"energy crystal seam",matIndex:"20",selectable:!0,drillable:!0,drillableHard:!0,explodable:!0,reinforcable:!0,cursor:q.Pointer_SurfaceType_CrystalSeam}),t.RECHARGE_SEAM=new t({name:"recharge seam",matIndex:"67",cursor:q.Pointer_SurfaceType_RechargeSeam}),t.POWER_PATH=new t({name:"power path all",floor:!0,matIndex:"60",selectable:!0}),t.POWER_PATH_SITE=new t({name:"power path site",floor:!0,matIndex:"61",selectable:!0}),t.POWER_PATH_BUILDING=new t({name:"power path",floor:!0,matIndex:"76"}),t.RUBBLE1=new t({name:"rubble 1",floor:!0,matIndex:"13",selectable:!0}),t.RUBBLE2=new t({name:"rubble 2",floor:!0,matIndex:"12",selectable:!0}),t.RUBBLE3=new t({name:"rubble 3",floor:!0,matIndex:"11",selectable:!0}),t.RUBBLE4=new t({name:"rubble 4",floor:!0,matIndex:"10",selectable:!0}),t}(),rt=n(586);!function(t){t[t.CORNER=1]="CORNER",t[t.WALL=2]="WALL",t[t.INVERTED_CORNER=3]="INVERTED_CORNER",t[t.WEIRD_CREVICE=20]="WEIRD_CREVICE"}(et||(et={}));var it=function(){function t(){}return t.create=function(t,e,n,r,i,o,a,s,u){var c=0;!e.y||n.y||t!==et.INVERTED_CORNER&&(t===et.WALL||t===et.WEIRD_CREVICE)!==Boolean(r.y)||(c=0),!r.y||i.y||t!==et.INVERTED_CORNER&&(t===et.WALL||t===et.WEIRD_CREVICE)!==Boolean(n.y)||(c=3),!n.y||e.y||t!==et.INVERTED_CORNER&&(t===et.WALL||t===et.WEIRD_CREVICE)!==Boolean(i.y)||(c=2),!i.y||r.y||t!==et.INVERTED_CORNER&&(t===et.WALL||t===et.WEIRD_CREVICE)!==Boolean(e.y)||(c=1),t!==et.WALL&&t!==et.WEIRD_CREVICE||(e.y&&n.y&&(c=0),r.y&&i.y&&(c=3));var l=[new D.FM8(0,1),new D.FM8(1,1),new D.FM8(1,0),new D.FM8(0,0)],h=[],p=[];function f(t,e,n){h.push(t,e,n);var r=(new D.Pa4).subVectors(n,e);r.cross((new D.Pa4).subVectors(t,e)),r.normalize(),p.push(r,r,r)}var d=[];r.y===i.y&&(t!==et.WALL&&t!==et.WEIRD_CREVICE||r.y&&i.y)?(d.push(0,3,2),d.push(0,2,1),e.y=o,r.y=a,n.y=s,i.y=u,f(e,i,n),f(e,n,r)):(d.push(1,3,2),d.push(1,0,3),e.y=o,r.y=a,n.y=s,i.y=u,f(r,i,n),f(r,e,i));var y=d.map((function(t){return l[(t+c)%4]})),g=new D.u9r;return g.setAttribute("position",new rt.Tl(new Float32Array(18),3).copyVector3sArray(h)),g.setAttribute("normal",new rt.Tl(new Float32Array(18),3).copyVector3sArray(p)),g.setAttribute("uv",new rt.Tl(new Float32Array(12),2).copyVector2sArray(y)),g},t}(),ot=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),at=function(t){function e(n){var r=t.call(this,e.geometry,new D.xoR({shininess:0,transparent:!0,opacity:.4,color:n}))||this;return r.standardColor=n,r.visible=!1,r}return ot(e,t),e.prototype.updateState=function(t,e,n){this.visible=!!t,t&&this.position.set(t.x,0,t.y).multiplyScalar(x).applyAxisAngle(new D.Pa4(0,1,0),-e+Math.PI/2).add(n)},e.prototype.markAsValid=function(t){var e=t?this.standardColor:5242880;this.material.color.setHex(e)},e.geometry=it.create(et.WALL,new D.Pa4(0,0,0),new D.Pa4(x,0,x),new D.Pa4(x,0,0),new D.Pa4(0,0,x),1,1,1,1),e}(D.Kj0),st=function(){function t(){this.group=new D.ZAu,this.markers=[],this.buildingMarkerPrimary=null,this.buildingMarkerSecondary=null,this.powerPathMarkerPrimary=null,this.powerPathMarkerSecondary=null,this.waterPathMarker=null,this.heading=0,this.sdx=0,this.sdz=0,this.lastCheck=!1,this.visibleSurfaces=[],this.primarySurface=null,this.secondarySurface=null,this.waterSurface=null,this.buildingMarkerPrimary=new at(t.buildingMarkerColor),this.buildingMarkerSecondary=new at(t.buildingMarkerColor),this.powerPathMarkerPrimary=new at(t.pathMarkerColor),this.powerPathMarkerSecondary=new at(t.pathMarkerColor),this.waterPathMarker=new at(t.waterMarkerColor),this.addMarker(this.buildingMarkerPrimary),this.addMarker(this.buildingMarkerSecondary),this.addMarker(this.powerPathMarkerPrimary),this.addMarker(this.powerPathMarkerSecondary),this.addMarker(this.waterPathMarker)}return t.prototype.addMarker=function(t){this.group.add(t),this.markers.push(t)},t.prototype.update=function(t,e){if(e&&ie.buildModeSelection){var n=this.updateAllMarker(t,e);this.markers.forEach((function(t){return t.markAsValid(n)}))}else this.hideAllMarker()},t.prototype.updateAllMarker=function(t,e){void 0===e&&(e=null);var n=ie.buildModeSelection;this.buildingMarkerPrimary.visible=!0,this.buildingMarkerPrimary.position.copy(t.worldMgr.getFloorPosition(new D.FM8(Math.floor(e.x/x)*x,Math.floor(e.y/x)*x)));var r=e.x-this.buildingMarkerPrimary.position.x-20,i=e.y-this.buildingMarkerPrimary.position.z-20,o=Math.abs(r)>Math.abs(i)?Math.sign(r):0,a=Math.abs(i)>Math.abs(r)?Math.sign(i):0;return this.sdx===o&&this.sdz===a||(this.sdx=o,this.sdz=a,this.heading=Math.atan2(a,o),this.buildingMarkerSecondary.updateState(n.secondaryBuildingPart,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerPrimary.updateState(n.primaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerSecondary.updateState(n.secondaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.waterPathMarker.updateState(n.waterPathSurface,this.heading,this.buildingMarkerPrimary.position),this.visibleSurfaces=[this.buildingMarkerPrimary,this.buildingMarkerSecondary,this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].filter((function(t){return t.visible})).map((function(e){return t.getSurfaceFromWorld(e.position)})),this.primarySurface=this.visibleSurfaces[0],this.secondarySurface=this.buildingMarkerSecondary.visible?this.visibleSurfaces[1]:null,this.waterSurface=this.waterPathMarker.visible?t.getSurfaceFromWorld(this.waterPathMarker.position):null,this.lastCheck=this.visibleSurfaces.every((function(t){return t.surfaceType===nt.GROUND}))&&([this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].some((function(e){return e.visible&&t.getSurfaceFromWorld(e.position).neighbors.some((function(t){return t.surfaceType===nt.POWER_PATH}))}))||!n.primaryPowerPath&&this.primarySurface.neighbors.some((function(t){return t.surfaceType===nt.POWER_PATH})))&&(!this.waterPathMarker.visible||this.waterSurface.surfaceType===nt.WATER)),this.lastCheck},t.prototype.hideAllMarker=function(){this.markers.forEach((function(t){return t.visible=!1})),this.lastCheck=!1},t.prototype.getBarrierLocations=function(){var t=[],e=this.primarySurface.getCenterWorld2D(),n=18;if(this.secondarySurface){var r=this.secondarySurface.getCenterWorld2D(),i=Math.sign(r.x-e.x),o=Math.sign(r.y-e.y);0!==i?(t.push(new tt(new D.FM8(e.x-i*n,e.y),e)),t.push(new tt(new D.FM8(e.x,e.y-n),e)),t.push(new tt(new D.FM8(e.x,e.y+n),e)),t.push(new tt(new D.FM8(r.x+i*n,e.y),r)),t.push(new tt(new D.FM8(r.x,r.y-n),r)),t.push(new tt(new D.FM8(r.x,r.y+n),r))):(t.push(new tt(new D.FM8(e.x,e.y-o*n),e)),t.push(new tt(new D.FM8(e.x-n,e.y),e)),t.push(new tt(new D.FM8(e.x+n,e.y),e)),t.push(new tt(new D.FM8(r.x,r.y+o*n),r)),t.push(new tt(new D.FM8(r.x-n,e.y),r)),t.push(new tt(new D.FM8(r.x+n,e.y),r)))}else t.push(new tt(new D.FM8(e.x-n,e.y),e)),t.push(new tt(new D.FM8(e.x,e.y-n),e)),t.push(new tt(new D.FM8(e.x+n,e.y),e)),t.push(new tt(new D.FM8(e.x,e.y+n),e));return t},t.buildingMarkerColor=20480,t.pathMarkerColor=5263360,t.waterMarkerColor=80,t}(),ut=function(){function t(t){var e=this;this.maxFps=30,this.debugHelper=new $,this.renderer=new D.CP7({antialias:!0,canvas:t}),this.renderer.setClearColor(0),this.camera=new D.cPb(30,t.width/t.height,.1,5e3),this.controls=new Z.o(this.camera,this.renderer.domElement),this.controls.mouseButtons={LEFT:null,MIDDLE:D.RsA.ROTATE,RIGHT:D.RsA.PAN},this.buildMarker=new st,s.registerEventListener(r.CANCEL_BUILD_MODE,(function(){ie.buildModeSelection=null,e.buildMarker.hideAllMarker()}))}return t.prototype.selectEntitiesByRay=function(t,e){var n=new D.iMs;n.setFromCamera({x:t,y:e},this.camera);var r=n.intersectObjects(ie.raiders.map((function(t){return t.pickSphere})));r.length<1&&(r=n.intersectObjects(ie.buildings.map((function(t){return t.pickSphere})))),r.length<1&&this.terrain&&(r=n.intersectObjects(this.terrain.floorGroup.children));var i=[];if(r.length>0){var o=r[0].object.userData;if(o&&o.hasOwnProperty("selectable")){var a=o.selectable;a&&i.push(a)}}ie.selectEntities(i)},t.prototype.selectEntitiesInFrustum=function(t,e,n,r){var i=new D.Pa4(t,e,.5),o=new D.Pa4(n,r,.5);i.x===o.x&&(o.x+=Number.EPSILON),i.y===o.y&&(o.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld();var a=new D.Pa4;a.copy(i),a.x=Math.min(i.x,o.x),a.y=Math.max(i.y,o.y),o.x=Math.max(i.x,o.x),o.y=Math.min(i.y,o.y);var s=new D.Pa4,u=new D.Pa4,c=new D.Pa4,l=new D.Pa4,h=new D.Pa4;s.setFromMatrixPosition(this.camera.matrixWorld),u.copy(a),c.set(o.x,a.y,0),l.copy(o),h.set(a.x,o.y,0),u.unproject(this.camera),c.unproject(this.camera),l.unproject(this.camera),h.unproject(this.camera);var p=new D.Pa4,f=new D.Pa4,d=new D.Pa4;p.copy(u).sub(s),f.copy(c).sub(s),d.copy(l).sub(s),p.normalize(),f.normalize(),d.normalize();var y=Number.MAX_VALUE;p.multiplyScalar(y),f.multiplyScalar(y),d.multiplyScalar(y),p.add(s),f.add(s),d.add(s);var g=new D.iWj,v=g.planes;v[0].setFromCoplanarPoints(s,u,c),v[1].setFromCoplanarPoints(s,c,l),v[2].setFromCoplanarPoints(l,h,s),v[3].setFromCoplanarPoints(h,u,s),v[4].setFromCoplanarPoints(c,l,h),v[5].setFromCoplanarPoints(d,f,p),v[5].normal.multiplyScalar(-1);var m=ie.raiders.filter((function(t){return g.containsPoint(t.getSelectionCenter())}));m.length<1&&(m=ie.buildings.filter((function(t){return g.containsPoint(t.getSelectionCenter())}))),ie.selectEntities(m)},t.prototype.setupScene=function(t){this.scene=new D.xsS,this.ambientLight=new D.Mig(t,.4),this.scene.add(this.ambientLight),this.cursorTorchlight=new D.cek(16777215,1.5,4,1),this.cursorTorchlight.distance*=x,this.scene.add(this.cursorTorchlight),this.scene.add(this.buildMarker.group)},t.prototype.startScene=function(){var t=this;this.debugHelper.show(),this.renderInterval=setInterval((function(){t.animRequest=requestAnimationFrame((function(){t.debugHelper.renderStart(),t.renderer.render(t.scene,t.camera),t.debugHelper.renderDone()}))}),1e3/this.maxFps)},t.prototype.disposeScene=function(){var e;this.debugHelper.hide(),this.renderInterval=G(this.renderInterval),this.animRequest&&(cancelAnimationFrame(this.animRequest),this.animRequest=null),null===(e=this.terrain)||void 0===e||e.dispose(),this.terrain=null,t.meshRegistry.forEach((function(t){return t.dispose()})),t.meshRegistry=[]},t.registerMesh=function(t){return this.meshRegistry.push(t),t.mesh},t.meshRegistry=[],t}(),ct=function(){this.looping=!1,this.transcoef=1,this.firstFrame=null,this.lastFrame=null,this.framesPerSecond=null,this.bodies=[]},lt=D.M8C.degToRad,ht=function(){function t(){this.name="",this.filename="",this.relPos=[],this.relRot=[],this.relScale=[],this.opacity=[],this.parentObjInd=null,this.model=null}return t.prototype.radVec=function(t,e,n){return new D.USm(lt(e),lt(t),lt(n),"YXZ")},t.prototype.setFrameAndFollowing=function(t,e,n){this.relPos[t]=new D.Pa4(n[0],n[1],n[2]),this.relRot[t]=this.radVec(n[3],n[4],n[5]),this.relScale[t]=new D.Pa4(n[6],n[7],n[8]);for(var r=t;r<=e;r++)this.relPos[r]=this.relPos[t],this.relRot[r]=this.relRot[t],this.relScale[r]=this.relScale[t]},t.prototype.setOpacityAndFollowing=function(t,e,n){for(var r=t;r<=e;r++)this.opacity[r]=n},t}(),pt=function(){function t(t,e){void 0===e&&(e=!1),this.path="",this.verbose=!1,this.animationClip=new ct,this.lines=[],this.lineIndex=0,this.path=t,this.verbose=e,this.verbose&&console.log("Using verbose mode")}return t.prototype.parse=function(t){if(this.lines=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((function(t){return t.trim()})),"LWSC"!==this.lines[0])throw"Invalid start of file! Expected 'LWSC' in first line";var e=parseInt(this.lines[1],10);for(1!==e&&console.warn("Unexpected scene file version: "+e),this.lineIndex=2;this.lineIndex<this.lines.length;this.lineIndex++){var n=this.lines[this.lineIndex];if(n){var r=n.split(" ")[0];"FirstFrame"===r?this.parseFrameBlock():"AddNullObject"===r||"LoadObject"===r?(this.parseObjectBlock(),this.verbose&&console.log(this.animationClip.bodies[this.animationClip.bodies.length-1])):n.startsWith("PreviewFirstFrame ")||n.startsWith("PreviewLastFrame ")||n.startsWith("PreviewFrameStep ")}}return this.verbose&&console.log(this.animationClip),this.animationClip},t.prototype.parseLine=function(t){return t.split(" ").filter((function(t){return""!==t}))},t.prototype.parseFrameBlock=function(){for(;this.lineIndex<this.lines.length;this.lineIndex++){var t=this.lines[this.lineIndex];if(!t)return;var e=this.parseLine(t),n=e[0],r=e[1];if("FirstFrame"===n)this.animationClip.firstFrame=parseInt(r);else if("LastFrame"===n)this.animationClip.lastFrame=parseInt(r);else if("FrameStep"===n){var i=parseInt(r);1!==i&&console.error("Animation frameStep has unexpected value: "+i)}else"FramesPerSecond"===n?this.animationClip.framesPerSecond=parseInt(r):"PreviewFirstFrame"===n||"PreviewLastFrame"===n||"PreviewFrameStep"===n||console.warn("Unexpected key in frame block")}console.error("Parsing block reached content end")},t.prototype.parseObjectBlock=function(){var t=new ht;for(this.animationClip.bodies.push(t);this.lineIndex<this.lines.length;this.lineIndex++){var e=this.lines[this.lineIndex];if(!e)return;var n=this.parseLine(e),r=n[0],i=n[1];if("AddNullObject"===r||"LoadObject"===r)if("LoadObject"===r){var o=k(i);t.name=o.slice(0,o.length-".lwo".length),t.filename=this.path+o;var a=_t.getResource(t.filename);t.model=ut.registerMesh(new It(this.path).parse(a))}else{if("AddNullObject"!==r)throw"Unexpected line: "+e;t.name=i,t.model=new D.ZAu}else if("ObjectMotion"===r){var s=this.lines[++this.lineIndex],u=parseInt(s);s=this.lines[++this.lineIndex];var c=parseInt(s);this.lineIndex++;for(var l=0;l<c;l++){var h=this.lines[this.lineIndex+2*l];if(h.startsWith("EndBehavior"))break;var p=h.split(" ").map(Number);p.length!==u&&console.warn("Number of infos ("+p.length+") does not match if specified count ("+u+")"),h=this.lines[this.lineIndex+2*l+1];var f=parseInt(h.split(" ")[0]);t.setFrameAndFollowing(f,this.animationClip.lastFrame,p)}this.lineIndex+=2*c}else if("ParentObject"===r)t.parentObjInd=Number(i)-1,this.verbose&&console.log("parent obj ind is: "+t.parentObjInd);else if("ShowObject"===r||"LockedChannels"===r);else if("ShadowOptions"===r);else if("ObjDissolve"===r)if("(envelope)"==i){var d=this.lines[++this.lineIndex],y=parseInt(d);1!==y&&console.error("Number of information channels for opacity is not 1, but: "+y),d=this.lines[++this.lineIndex];var g=parseInt(d);for(this.lineIndex++,l=0;l<g;l++){var v=this.lines[this.lineIndex+2*l];if(v.startsWith("EndBehavior"))break;var m=1-Number(v);v=this.lines[this.lineIndex+2*l+1];var w=Number(v.split(" ")[0]);t.setOpacityAndFollowing(w,this.animationClip.lastFrame,m)}this.lineIndex+=2*g}else m=1-Number(i),t.setOpacityAndFollowing(0,this.animationClip.lastFrame,m)}return console.error("Parsing block reached content end"),t},t}();function ft(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return e.forEach((function(e){t=(t=Object.keys(t).filter((function(t){return t.toLowerCase()===e.toLowerCase()})).map((function(e){return t[e]})))?t[0]:t})),t}var dt,yt=function(){function t(){}return t.loadModels=function(t,e){var n=function(t){if(!t)return t;var e=t.toString().replace(/\\/g,"/");e.startsWith("/")&&(e=e.substring(1));var n=e.lastIndexOf("/");return(e=e.substring(0,n+1)).startsWith("/")&&(e=e.substring(1)),e}(t),r=new z;r.carryNullName=ft(e,"CarryNullName"),r.depositNullName=ft(e,"DepositNullName"),r.toolNullName=ft(e,"ToolNullName");var i=ft(e,"highpoly");i&&(r.highPoly={},Object.keys(i).forEach((function(t){var e=i[t]+".lwo",o=t.startsWith("!")?t.slice(1):t,a=_t.getResource(n+e);r.highPoly[o]=ut.registerMesh(new It(n).parse(a))})));var o=ft(e,"Activities");return o&&Object.keys(o).forEach((function(t){try{var i=ft(o,t),a=ft(e,i),s=ft(a,"FILE"),u=!0===ft(a,"LWSFILE"),c=ft(a,"TRANSCOEF"),l=!0===ft(a,"LOOPING");if(u){var h=_t.getResource(n+s+".lws");a.animation=new pt(n).parse(h),a.animation.looping=l,a.animation.transcoef=c?Number(c):1,r.activities.set(t.toLowerCase(),a)}else console.error("Found activity which is not an LWS file")}catch(n){console.error(n),console.log(e),console.log(o),console.log(t)}})),r},t}(),gt=function(){function t(t,e,n){void 0===e&&(e=10),void 0===n&&(n=19),this.letters=[];var r=[" ","!",'"',"#","$","%","⌵","`","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","'","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","Ä","Å","Á","À","Â","Ã","Ą","ä","å","á","à","â","ã","ą","Ë","E̊","É","È","É","Ę","ë","e̊","é","è","e̊","ę̊","","","","","","","","","Ö","","","","","ö","","","","","Ü","","","","ü","","","","","","","","","","","","","","","","","","","","","","","","ß","","","","Ñ","","ñ",""],i=t.width/e;function o(t){for(var e=0;e<t.height/n;e++){var r=4*e*t.width;if(255!==t.data[r]&&255!==t.data[r+2]){for(var o=0;o<i;o++){var a=4*o;if(255===t.data[a]||255===t.data[a+2])return o}return i}}return 0}this.charHeight=t.height/n;for(var a=0;a<r.length;a++){var s=this.extractData(t,a%10*i,Math.floor(a/10)*this.charHeight,i,this.charHeight),u=o(s);s=u>0?this.extractData(s,0,0,u,this.charHeight):Y(i,this.charHeight),this.letters[r[a]]=s}}return t.prototype.extractData=function(t,e,n,r,i){for(var o=K(t,e+r-1,n+i-1),a=new ImageData(r,i),s=0;s<r;s++)for(var u=0;u<i;u++){var c=K(t,e+s,n+u);c.r===o.r&&c.g===o.g&&c.b===o.b&&(c.a=0),X(a,s,u,c.r,c.g,c.b,c.a)}return a},t.prototype.createTextImage=function(t,e,n){var r=this;if(void 0===n&&(n=!0),null==t||t.length<1)return V(1,1).canvas;t=t.replace(/_/g," ");var i=this.determineRows(t,e),o=Math.max.apply(Math,i.map((function(t){return t.width}))),a=new ImageData(o,this.charHeight*i.length);i.forEach((function(t,e){for(var i=n?Math.round((o-t.width)/2):0,s=e*r.charHeight,u=0,c=0;c<t.text.length;c++){var l=r.letters[t.text.charAt(c)];if(l){for(var h=u;h<u+l.width;h++)for(var p=0;p<l.height;p++){var f=K(l,h-u,p);X(a,i+h,s+p,f.r,f.g,f.b,f.a)}u+=l.width}}}));var s=V(a.width,a.height);return s.putImageData(a,0,0),s.canvas},t.prototype.determineRows=function(t,e){var n=this,r=this.letters[" "].width,i=[],o="",a=0;return t.split(" ").map((function(t){for(var s=0,u=0;u<t.length;u++){var c=t.charAt(u),l=n.letters[c];l?s+=l.width:console.error("Letter '"+c+"' not found in charset! Ignoring it")}return a>0?!e||a+r+s<e?(o+=" "+t,a+=r+s):(i.push({text:o,width:a}),o=t,a=s):(o+=t,a+=s),s})),a>0&&i.push({text:o,width:a}),i},t}(),vt=function(t,e){for(var n=0,r=e.length,i=t.length;n<r;n++,i++)t[i]=e[n];return t},mt=function(){function t(){}return t.cfg=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return ft.apply(void 0,vt([this.configuration],t))},t.getResource=function(t){var e=t?t.toString().toLowerCase():null;return this.resourceByName.get(e)||null},t.getImageData=function(t){if(!t)throw"imageName must not be undefined, null or empty - was "+t;return this.resourceByName.getOrUpdate(t.toLowerCase(),(function(){return console.error("Image '"+t+"' unknown! Using placeholder image instead"),Y(64,64)}))},t.getImage=function(t){var e=this.getImageData(t),n=V(e.width,e.height);return n.putImageData(e,0,0),n.canvas},t.getImageOrNull=function(t){return t?this.getImage(t):null},t.getBitmapFont=function(t){var e=this;return this.fontCache.getOrUpdate(t,(function(){var n=e.getResource(t);if(!n)throw"Could not load font image data for: "+t;return new gt(n)}))},t.getDefaultFont=function(){return this.getBitmapFont("Interface/Fonts/Font5_Hi.bmp")},t.configuration={},t.resourceByName=new Map,t.fontCache=new Map,t}(),wt=function(t,e){this.wad0FileUrl=t,this.wad1FileUrl=e};!function(t){t[t.MSG=0]="MSG",t[t.CFG=1]="CFG",t[t.CACHE_MISS=2]="CACHE_MISS",t[t.SFX=3]="SFX",t[t.ASSET=4]="ASSET",t[t.DONE=5]="DONE"}(dt||(dt={}));var bt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),_t=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return bt(e,t),e.startLoadingFromCache=function(){return this.startLoading(null)},e.startLoadingFromUrl=function(t,e){return this.startLoading(new wt(t,e))},e.startLoading=function(t){var e=this;this.worker.onmessage=function(t){var n=t.data;if(n.type===dt.ASSET){e.resourceByName.set(n.assetName.toLowerCase(),n.assetObj);var r=n.assetName.toLowerCase().match(/(.*a)\d\d\d(_.+)/);r&&e.resourceByName.set(r[1]+r[2],n.assetObj),e.onAssetLoaded()}else n.type===dt.MSG?e.onMessage(n.text):n.type===dt.CFG?(e.configuration=n.cfg,e.stats=n.stats,e.onInitialLoad(n.totalResources)):n.type===dt.CACHE_MISS?e.onCacheMissed():n.type===dt.DONE&&(console.log("Loading of about "+n.totalResources+" assets complete! Total load time: "+n.loadingTimeSeconds+" seconds."),e.onLoadDone())},this.worker.postMessage(t)},e.filterTextureSequenceNames=function(t){var e=t.toLowerCase(),n=[];return this.resourceByName.forEach((function(t,r){r.startsWith(e)&&n.push(r)})),n.length>0?n:e.startsWith("world/shared/")?(console.warn("Texture sequence not found: "+t),null):this.filterTextureSequenceNames("world/shared/"+k(t))},e.getTexture=function(t){var e=this;if(!t||0===t.length)throw"textureName must not be undefined, null or empty - was "+t;var n=t.toLowerCase(),r=this.resourceByName.getOrUpdate(n,(function(){var r="world/shared/"+k(n);return e.resourceByName.getOrUpdate(r,(function(){return console.warn("Texture '"+t+"' ("+n+", "+r+") unknown! Using placeholder texture instead"),Y(64,64)}))})),i=new D.xEZ(r,D.xEZ.DEFAULT_MAPPING,D.rpg,D.rpg);return i.needsUpdate=!0,i},e.getAnimationEntityType=function(t){var e=this.getResource(t);if(!e)throw"Could not get animation entity type for: "+t;return yt.loadModels(t,e)},e.worker=new Worker(new URL(n.p+n.u(315),n.b)),e.onMessage=function(t){console.log(t)},e.onCacheMissed=function(){console.log("Worker missed cache")},e.onInitialLoad=function(){console.log("Initial loading done.")},e.onAssetLoaded=function(){},e.onLoadDone=function(){},e}(mt),Ot=1448366670;function Et(t,e){var n=new D.Pa4;return n.x=t.getFloat32(e),n.y=t.getFloat32(e+4),n.z=t.getFloat32(e+8),n}var Pt,Tt,St,It=function(){function t(t,e){void 0===e&&(e=!1),this.path="",this.verbose=!1,this.materials=[],this.geometry=new D.u9r,this.vertices=null,this.indices=null,this.uvs=null,this.sequenceIntervals=[],this.path=t,this.verbose=e,this.verbose&&console.log("LWO path: "+this.path)}return t.prototype.parsePoints=function(t,e,n){if(n%12==0){var r=n/4/3;this.vertices=new Float32Array(3*r),this.uvs=new Float32Array(2*r);for(var i=0;i<r;i++){var o=3*i,a=4*o;this.vertices[o]=t.getFloat32(e+a),this.vertices[o+1]=t.getFloat32(e+a+4),this.vertices[o+2]=t.getFloat32(e+a+8)}}else console.error("LWOLoader.parse: F12 does not evenly divide into chunk size ("+n+"). Possible corruption.")},t.prototype.parseSurfaceNames=function(t,e,n){for(var r=(new TextDecoder).decode(new Uint8Array(t,e,n)).split("\0").filter((function(t){return""!==t})),i=0;i<r.length;i++){var o=new D.xoR;o.name=r[i],o.side=D.ehD,this.materials.push(o)}this.verbose&&console.log("LWO contains "+this.materials.length+" materials with following names: "+r)},t.prototype.parsePolygons=function(t,e,n){for(var r=0,i=0;i<n;){var o=t.getInt16(e+i),a=t.getInt16(e+i+2+2*o);this.geometry.addGroup(r,3*(o-2),a-1),r+=3*(o-2),i+=4+2*o}i=0;var s=0;for(this.indices=new Uint16Array(r);i<n;){o=t.getInt16(e+i),i+=2;for(var u=new Int16Array(o),c=0;c<=o;c++)u[c]=t.getInt16(e+i+2*c);for(c=0;c<o-2;c++)this.COUNTER_CLOCKWISE?(this.indices[s++]=u[0],this.indices[s++]=u[c+2],this.indices[s++]=u[c+1]):(this.indices[s++]=u[0],this.indices[s++]=u[c+1],this.indices[s++]=u[c+2]);i+=2+2*o}},t.prototype.parseSurface=function(t,e,n,r){for(var i=0;0!==t.getUint8(n+i);)i++;var o=B(new Uint8Array(e,n,i));this.verbose&&console.log("Parsing surface: "+o);for(var a=-1,s=null,u=0,c=new D.Pa4(0,0,0),l=new D.Pa4(0,0,0),h=0;h<this.materials.length;h++)this.materials[h].name===o&&(a=h,s=this.materials[h]);if(s){s.shininess=0;for(var p=function(){var r=n+i;if(0===t.getUint8(r))i++;else{var o=t.getInt32(r),a=t.getInt16(r+4);switch(f.verbose&&console.log("Parsing subchunk "+(new TextDecoder).decode(new Uint8Array(e,r,4))+" at "+r+"; length "+a),o){case 1129270354:var h=[t.getUint8(r+6+0)/255,t.getUint8(r+6+1)/255,t.getUint8(r+6+2)/255];s.color=(new D.Ilk).fromArray(h),f.verbose&&console.log("Material color (COLR): "+h.join(" "));break;case 1179402567:var p=t.getUint16(r+6);f.verbose&&console.log("Flags (FLAG): "+p.toString(2)),f.verbose&&2&p&&console.warn("Flag is set but unhandled: outline"),f.verbose&&4&p&&console.warn("Flag is set but unhandled: smoothing"),f.verbose&&8&p&&console.warn("Flag is set but unhandled: colorHighlights"),f.verbose&&16&p&&console.warn("Flag is set but unhandled: colorFilter"),f.verbose&&32&p&&console.warn("Flag is set but unhandled: opaqueEdge"),f.verbose&&64&p&&console.warn("Flag is set but unhandled: transparentEdge"),f.verbose&&128&p&&console.warn("Flag is set but unhandled: sharpTerminator"),256&p&&(s.side=D.ehD),512&p&&(s.blending=D.WMw,s.depthWrite=!1),f.verbose&&1024&p&&console.warn("Flag is set but unhandled: shadowAlpha");break;case 1162102597:var d=t.getFloat32(r+6);f.verbose&&console.warn("Edge transparency threshold (0.0 to 1.0): "+d);break;case 1280658761:var y=t.getInt16(r+6)/256;f.verbose&&console.log("Luminosity (LUMI): "+y),s.emissiveIntensity=y;break;case 1145652806:var g=t.getInt16(r+6)/256;f.verbose&&console.log("Diffuse (DIFF): "+g),g||(s.color=null);break;case 1397769539:var v=t.getInt16(r+6)/256;f.verbose&&console.warn("Specular (SPEC): "+v);break;case 1380271692:var m=0;m=1447449164===m?t.getFloat32(r+6):t.getInt16(r+6)/256,s.reflectivity=m,f.verbose&&console.log("Reflectivity (REFL): "+s.reflectivity);break;case 1414676814:case Ot:var w;w=o===Ot?t.getFloat32(r+6):t.getInt16(r+6)/256,s.opacity=1-w,f.verbose&&console.log("Opacity (TRAN/VTRN): "+s.opacity),s.transparent=s.transparent||s.opacity<1;break;case 1447843149:var b=t.getFloat32(r+6);f.verbose&&console.log("Luminosity (VLUM): "+b),s.emissiveIntensity=b;break;case 1447315782:var _=t.getFloat32(r+6);f.verbose&&console.log("Diffuse (VDIF): "+_);break;case 1448300611:var O=t.getFloat32(r+6);f.verbose&&console.warn("Specular (VSPC): "+O);break;case 1413893191:u=t.getUint16(r+6),f.verbose&&console.log("Flags (TFLG): "+u.toString(2)),f.verbose&&1&u&&console.warn("Flag is set but unhandled: X Axis"),f.verbose&&2&u&&console.warn("Flag is set but unhandled: Y Axis"),f.verbose&&4&u&&console.warn("Flag is set but unhandled: Z Axis"),f.verbose&&8&u&&console.warn("Flag is set but unhandled: World Coords"),f.verbose&&16&u&&console.warn("Flag is set but unhandled: Negative Image"),f.verbose&&32&u&&console.warn("Flag is set but unhandled: Pixel Blending"),f.verbose&&64&u&&console.log("Flag is set: Antialiasing");break;case 1414744410:c=Et(t,r+6),f.verbose&&console.warn("Texture size (TSIZ): "+c.toArray().join(" "));break;case 1413698642:l=Et(t,r+6),f.verbose&&console.warn("Texture center (TCTR): "+l.toArray().join(" "));break;case 1129596248:case 1146373464:case 1398031704:case 1381254488:case 1414808920:case 1112819032:var E=j(new Uint8Array(e,r+6,a));f.verbose&&console.log("Texture typename: "+E);break;case 1413696594:var P=t.getUint16(r+6)/256;f.verbose&&console.warn("Texture value (TVAL): "+P);break;case 1413696594:var T=[t.getUint8(r+6+0)/255,t.getUint8(r+6+1)/255,t.getUint8(r+6+2)/255,t.getUint8(r+6+3)/255];f.verbose&&console.log("Texture color (TCLR): "+T.join(" "));break;case 1414090055:var S=j(new Uint8Array(e,r+6,a));if(f.verbose&&console.log("Texture filepath (TIMG): "+S),"(none)"===S)break;var I=!1;S.endsWith(" (sequence)")&&(I=!0,S=S.substring(0,S.length-" (sequence)".length));var C=k(S);s.transparent=s.transparent||!!C.match(/^a\d+.+.bmp/i);var R=f.path+C;if(I){var L=R.match(/(.+\D)0+(\d+)\..+/),A=_t.filterTextureSequenceNames(L[1]);if(A){var M=0;f.sequenceIntervals.push(setInterval((function(){s.map=_t.getTexture(A[M]),s.color=null,++M>=A.length&&(M=0)}),200))}}var x=R.toLowerCase();if("miscanims/barrier/a_side.bmp"===x||"miscanims/barrier/a_top.bmp"===x||"world/shared/teofoilreflections.jpg"===x||"buildings/barracks/wingbase3.bmp"===x)break;s.map=_t.getTexture(R),s.color=null;break;default:f.verbose&&console.warn("Found unrecognised SURF subchunk type "+(new TextDecoder).decode(new Uint8Array(e,r,4))+" at "+r+"; length "+a)}i+=6+a}},f=this;i<r;)p();!function(t,e,n,r,i,o,a,s){if(7&s)for(var u=0,c=t.groups;u<c.length;u++){var l=c[u];if(l.materialIndex===i)for(var h=l.start;h<l.start+l.count;h++){var p=3*r[h],f=e[p]-a.x,d=e[p+1]-a.y,y=e[p+2]-a.z,g=2*r[h],v=0,m=0;1&s?(v=y/o.z+.5,m=d/o.y+.5):2&s?(v=f/o.x+.5,m=y/o.z+.5):4&s&&(v=f/o.x+.5,m=d/o.y+.5),n[g]=v,n[g+1]=m}}}(this.geometry,this.vertices,this.uvs,this.indices,a,c,l,u)}else console.error("LWOLoader.parse: Surface in SURF chunk does not exist in SRFS")},t.prototype.parse=function(t){var e=new DataView(t);if(1179603533===e.getUint32(0)){var n=e.getUint32(4);if(n+8!==e.byteLength&&console.warn("LWOLoader.parse: Discrepancy between size in header ("+(n+8)+" bytes) and actual size ("+e.byteLength+" bytes)."),1280790338===e.getUint32(8)){for(var r=12;r<e.byteLength;)if(0===e.getUint8(r))r++;else{var i=e.getInt32(r),o=e.getInt32(r+4);switch(r+=8,i){case 1347310675:this.parsePoints(e,r,o);break;case 1397900883:this.parseSurfaceNames(t,r,o);break;case 1347374163:this.parsePolygons(e,r,o);break;case 1398100550:this.parseSurface(e,t,r,o);break;default:console.warn("Found unrecognised chunk type "+B(new Uint8Array(t,r-8,4))+" at "+r)}r+=o}return this.geometry.setAttribute("position",new D.TlE(this.vertices,3)),this.geometry.setAttribute("uv",new D.TlE(this.uvs,2)),this.geometry.setIndex(new D.TlE(this.indices,1)),this.geometry.computeVertexNormals(),new J(new D.Kj0(this.geometry,this.materials),this.sequenceIntervals)}var a=B(new Uint8Array(t,8,4));console.error("LWOLoader.parse: Invalid magic ID ("+a+") in LWO header.")}else console.error("LWOLoader.parse: Cannot find header.")},t}();!function(t){t[t.PILOT=0]="PILOT",t[t.TOOLSTATION=1]="TOOLSTATION",t[t.TELEPORT_PAD=2]="TELEPORT_PAD",t[t.DOCKS=3]="DOCKS",t[t.POWER_STATION=4]="POWER_STATION",t[t.BARRACKS=5]="BARRACKS",t[t.UPGRADE=6]="UPGRADE",t[t.GEODOME=7]="GEODOME",t[t.ORE_REFINERY=8]="ORE_REFINERY",t[t.GUNSTATION=9]="GUNSTATION",t[t.TELEPORT_BIG=10]="TELEPORT_BIG",t[t.BAT=11]="BAT",t[t.SMALL_SPIDER=12]="SMALL_SPIDER",t[t.DYNAMITE=13]="DYNAMITE",t[t.ELECTRIC_FENCE=14]="ELECTRIC_FENCE",t[t.CRYSTAL=15]="CRYSTAL",t[t.ORE=16]="ORE",t[t.BRICK=17]="BRICK",t[t.BARRIER=18]="BARRIER"}(Pt||(Pt={})),function(t){t[t.RAIDER=0]="RAIDER",t[t.BUILDING=1]="BUILDING",t[t.MONSTER=2]="MONSTER",t[t.MATERIAL=3]="MATERIAL"}(Tt||(Tt={})),function(t){t[t.aiPriorityTrain=0]="aiPriorityTrain",t[t.aiPriorityGetIn=1]="aiPriorityGetIn",t[t.aiPriorityCrystal=2]="aiPriorityCrystal",t[t.aiPriorityOre=3]="aiPriorityOre",t[t.aiPriorityRepair=4]="aiPriorityRepair",t[t.aiPriorityClearing=5]="aiPriorityClearing",t[t.aiPriorityDestruction=6]="aiPriorityDestruction",t[t.aiPriorityConstruction=7]="aiPriorityConstruction",t[t.aiPriorityReinforce=8]="aiPriorityReinforce",t[t.aiPriorityRecharge=9]="aiPriorityRecharge"}(St||(St={}));var Ct,Rt=function(t){this.activityKey=t},Lt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),At=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Lt(e,t),e.Stand=new e("Activity_Stand"),e}(Rt),Mt=function(){function t(t,e){this.group=new D.ZAu,this.superType=null,this.entityType=null,this.level=0,this.superType=t,this.entityType=e}return Object.defineProperty(t.prototype,"stats",{get:function(){return null},enumerable:!1,configurable:!0}),t.prototype.getPosition=function(){return this.group.position.clone()},t.prototype.getPosition2D=function(){return new D.FM8(this.group.position.x,this.group.position.z)},t.prototype.getHeading=function(){return this.group.rotation.y},t.prototype.onDiscover=function(){this.group.visible=!0},t.prototype.removeFromScene=function(){this.worldMgr.sceneManager.scene.remove(this.group)},Object.defineProperty(t.prototype,"surfaces",{get:function(){return[this.worldMgr.sceneManager.terrain.getSurfaceFromWorld(this.group.position)]},enumerable:!1,configurable:!0}),t}(),xt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Dt=function(t){function e(e,n,r){var i=t.call(this,e,n)||this;return i.animationEntityType=null,i.poly=[],i.animation=null,i.animationTimeout=null,i.selectionFrame=null,i.pickSphere=null,i.carryJoint=null,i.depositJoint=null,i.getToolJoint=null,i.activity=null,i.radiusSq=0,r&&(i.animationEntityType=_t.getAnimationEntityType(r)),i}return xt(e,t),e.prototype.beamUp=function(){s.publishEvent(new y),this.changeActivity(),e.moveUp(this,240)},e.moveUp=function(t,n){n>0?(n--,t.group.position.y+=.6666666666666666,setTimeout((function(){return e.moveUp(t,n)}),33.333333333333336)):t.removeFromScene()},e.prototype.changeActivity=function(t,e,n){var r,i=this;if(void 0===t&&(t=this.getDefaultActivity()),void 0===e&&(e=null),void 0===n&&(n=null),this.activity!==t&&null!==this.animationEntityType){this.activity=t;var o=t.activityKey.toLowerCase(),a=this.animationEntityType.activities.get(o);if(a||this.animationEntityType.activities.forEach((function(t,e){!a&&o.startsWith(e)&&(a=t)})),!(null==a?void 0:a.animation))return console.warn("Activity "+t.activityKey+" unknown or has no animation defined"),void console.log(this.animationEntityType.activities);e&&e.bind(this),this.animation=a.animation,this.animation.looping=!0,this.animationTimeout=H(this.animationTimeout),(r=this.group).remove.apply(r,this.poly),this.poly=[];var s=this.carryJoint&&this.carryJoint.children||[];this.carryJoint=null,this.animation.bodies.forEach((function(t){var e,n,r,o,a=N(i.animationEntityType.highPoly,t.name);a||(a=N(i.animationEntityType.mediumPoly,t.name)),a||(a=t.model);var u=a.clone(!0);if(i.poly.push(u),t.name){var c=t.name.toLowerCase();c===(null===(n=i.animationEntityType.carryNullName)||void 0===n?void 0:n.toLowerCase())?(i.carryJoint=u,s.length>0&&(e=i.carryJoint).add.apply(e,s)):c===(null===(r=i.animationEntityType.depositNullName)||void 0===r?void 0:r.toLowerCase())?i.depositJoint=u:c===(null===(o=i.animationEntityType.toolNullName)||void 0===o?void 0:o.toLowerCase())&&(i.getToolJoint=u)}})),this.animation.bodies.forEach((function(t,e){var n=i.poly[e],r=t.parentObjInd;null!=r?i.poly[r].add(n):i.group.add(n)}));var u=new D.aLr;(new D.ZzF).setFromObject(this.group).getBoundingSphere(u),this.radiusSq=u.radius*u.radius,this.animate(0,e,n)}},e.prototype.animate=function(t,e,n){var r=this;if(this.poly.length!==this.animation.bodies.length)throw"Cannot animate poly. Length differs from bodies length";this.animation.bodies.forEach((function(e,n){var i=r.poly[n];if(i.position.copy(e.relPos[t]),i.rotation.copy(e.relRot[t]),i.scale.copy(e.relScale[t]),i.hasOwnProperty("material")){var o=i.material,a=e.opacity[t];o&&void 0!==a&&(Array.isArray(o)?o:[o]).forEach((function(t){t.opacity=a,t.transparent=t.transparent||t.opacity<1}))}})),this.animationTimeout=H(this.animationTimeout);var i=t+1;if(i<=this.animation.lastFrame||!e||null!==n&&n>0){i>this.animation.lastFrame&&(i=this.animation.firstFrame);var o=1e3/this.animation.framesPerSecond*this.animation.transcoef;null!==n&&(n-=o);var a=this,s=null!==n?Math.max(0,Math.min(n,o)):o;this.animationTimeout=setTimeout((function(){return a.animate(i,e,n)}),s)}else e&&e()},e.prototype.getDefaultActivity=function(){return At.Stand},e.prototype.createPickSphere=function(){if(!this.pickSphere){var t=this.stats.PickSphere,e=t/2,n=new D.xo$(e,e,e),r=new D.vBJ({color:16776960,visible:!1});this.pickSphere=new D.Kj0(n,r),this.pickSphere.userData={selectable:this};var i=this.getPickSphereCenter();this.pickSphere.position.copy(i),this.group.add(this.pickSphere),this.createSelectionFrame(t,i)}},e.prototype.getPickSphereCenter=function(){return this.getBoundingBoxCenter()},e.prototype.getBoundingBoxCenter=function(){var t=new D.Pa4;return(new D.ZzF).setFromObject(this.group).getCenter(t),t.sub(this.group.position),t.applyMatrix4((new D.yGw).makeScale(-1,1,1)),t},e.prototype.createSelectionFrame=function(t,e){var n=128,r=V(n,n);r.fillStyle="#0f0";var i=Math.round(50/t),o=21.333333333333332;r.fillRect(0,0,o,i),r.fillRect(0,0,i,o),r.fillRect(106.66666666666667,0,o,i),r.fillRect(n-i,0,i,o),r.fillRect(n-i,106.66666666666667,i,o),r.fillRect(106.66666666666667,n-i,o,i),r.fillRect(0,n-i,o,i),r.fillRect(0,106.66666666666667,i,o);var a=new D.ROQ(r.canvas),s=new D.xeV({map:a,depthTest:!1});this.selectionFrame=new D.jyi(s),this.selectionFrame.position.copy(e);var u=t;this.selectionFrame.scale.set(u,u,u),this.selectionFrame.visible=!1,this.group.add(this.selectionFrame)},e}(Mt);!function(t){t[t.INCOMPLETE=0]="INCOMPLETE",t[t.COMPLETE=1]="COMPLETE",t[t.CANCELED=2]="CANCELED"}(Ct||(Ct={}));var kt,Nt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Bt=function(){function t(t){this.fulfiller=[],this.type=t,this.jobstate=Ct.INCOMPLETE}return t.prototype.assign=function(t){var e=this.fulfiller.indexOf(t);t&&-1===e&&this.fulfiller.push(t)},t.prototype.unassign=function(t){this.fulfiller.remove(t)},t.prototype.cancel=function(){this.jobstate=Ct.CANCELED;var t=this.fulfiller;this.fulfiller=[],t.forEach((function(t){return t.stopJob()}))},t.prototype.getRequiredTool=function(){return null},t.prototype.getRequiredTraining=function(){return null},t.prototype.isReadyToComplete=function(){return!0},t.prototype.onJobComplete=function(){this.jobstate=Ct.COMPLETE},t.prototype.setActualWorkplace=function(t){},t.prototype.getCarryItem=function(){return null},t.prototype.getWorkActivity=function(){return null},t.prototype.getWorkDuration=function(){return null},t}(),jt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Nt(e,t),e}(Bt);!function(t){t[t.DRILL=0]="DRILL",t[t.REINFORCE=1]="REINFORCE",t[t.CLEAR_RUBBLE=2]="CLEAR_RUBBLE",t[t.CARRY=3]="CARRY",t[t.MOVE=4]="MOVE",t[t.TRAIN=5]="TRAIN",t[t.GET_TOOL=6]="GET_TOOL",t[t.EAT=7]="EAT",t[t.COMPLETE_POWER_PATH=8]="COMPLETE_POWER_PATH"}(kt||(kt={}));var Ft,Ut,Wt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ht=function(t){function e(e){var n=t.call(this,kt.CARRY)||this;return n.actualTarget=null,n.item=e,n}return Wt(e,t),e.prototype.getWorkplaces=function(){return this.item.getCarryTargets()},e.prototype.getPriorityIdentifier=function(){return this.item.getPriorityIdentifier()},e.prototype.setActualWorkplace=function(t){this.item.setTargetSite(t.site),this.actualTarget=t},e.prototype.getCarryItem=function(){return this.item},e.prototype.getWorkActivity=function(){return this.actualTarget.getDropAction()},e.prototype.isReadyToComplete=function(){return this.actualTarget.canGatherItem()},e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this);var e=this.actualTarget.targetLocation;this.fulfiller.forEach((function(t){t.group.lookAt(new D.Pa4(e.x,t.group.position.y,e.y)),t.dropItem()})),this.actualTarget.gatherItem(this.item)},e}(jt),Gt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Jt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Gt(e,t),e.Teleport=new e("Activity_Teleport"),e.Deposit=new e("Activity_Deposit"),e.Explode=new e("Activity_Explode"),e.Unpowered=new e("Activity_Unpowered"),e}(At),Vt=function(){function t(t){this.targetLocation=t}return t.prototype.isInArea=function(t){return!1},t}(),Yt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Xt=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.site=n,i.building=r,i}return Yt(e,t),e.prototype.canGatherItem=function(){return!this.building||this.building.activity.activityKey===this.building.getDefaultActivity().activityKey},e.prototype.gatherItem=function(t){var n=this;this.site?this.site.addItem(t):this.building?this.building.entityType===Pt.POWER_STATION||this.building.entityType===Pt.ORE_REFINERY?(this.building.carryJoint&&(this.building.carryJoint.add(t.group),t.group.position.set(0,0,0)),this.building.changeActivity(Jt.Deposit,(function(){n.building.changeActivity(),n.building.carryJoint&&n.building.carryJoint.remove(t.group),e.addItemToStorage(t)}))):(t.removeFromScene(),e.addItemToStorage(t)):t.worldMgr.sceneManager.scene.add(t.group)},e.addItemToStorage=function(t){switch(t.entityType){case Pt.CRYSTAL:ie.numCrystal++,s.publishEvent(new S(t.entityType));break;case Pt.ORE:ie.numOre++,s.publishEvent(new S(t.entityType))}},e.prototype.getDropAction=function(){return(this.building||this.site).getDropAction()},e}(Vt),Kt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),qt=function(t){function e(e,n){void 0===n&&(n=null);var r=t.call(this,Tt.MATERIAL,e,n)||this;return r.targetBuildingTypes=[],r.priorityIdentifier=null,r.targets=[],r.targetSite=null,r.targetBuildingTypes=[Pt.TOOLSTATION],r}return Kt(e,t),e.prototype.getCarryTargets=function(){return this.updateTargets()},e.prototype.resetTarget=function(){this.targets=[],this.targetSite=null,this.updateTargets()},e.prototype.updateTargets=function(){var t=this;if(this.targets.length<1){var e=ie.buildingSites.filter((function(e){return e.needs(t.entityType)}));if(e.length>0)this.targets=e.map((function(t){return new Xt(t.getRandomDropPosition(),t,null)}));else{var n=ie.getBuildingsByType.apply(ie,this.getTargetBuildingTypes());n.length>0&&(this.targets=n.map((function(t){return new Xt(t.getDropPosition2D(),null,t)})))}}else(this.targets.some((function(t){return t.site&&t.site.complete}))||this.targets.some((function(t){return t.building&&!t.building.isPowered()})))&&this.resetTarget();return this.targets},e.prototype.onDiscover=function(){t.prototype.onDiscover.call(this),ie.materialsUndiscovered.remove(this),ie.materials.push(this),s.publishEvent(new E(this.createCarryJob()))},e.prototype.setTargetSite=function(t){var e,n;this.targetSite!==t&&(null===(e=this.targetSite)||void 0===e||e.unAssign(this),this.targetSite=t,null===(n=this.targetSite)||void 0===n||n.assign(this))},e.prototype.getPriorityIdentifier=function(){return this.priorityIdentifier},e.prototype.getTargetBuildingTypes=function(){return this.targetBuildingTypes},e.prototype.createCarryJob=function(){return new Ht(this)},e.prototype.onAddToSite=function(){this.worldMgr.sceneManager.scene.add(this.group)},e}(Dt),zt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Zt=function(t){function e(){var e=t.call(this,Pt.CRYSTAL)||this,n=_t.getResource("MiscAnims/Crystal/vlp_greencrystal.lwo"),r=ut.registerMesh(new It("MiscAnims/Crystal/").parse(n));r.material.forEach((function(t){t.blending=D.WMw,t.depthWrite=!1,t.opacity=.5,t.transparent=t.opacity<1})),r.scale.set(1.75,1.75,1.75),e.group.add(r);var i=_t.getResource("World/Shared/Crystal.lwo"),o=ut.registerMesh(new It("World/Shared/").parse(i));return o.material.forEach((function(t){t.emissive=new D.Ilk(0,8,0),t.color=new D.Ilk(0,0,0),t.opacity=.9,t.transparent=t.opacity<1})),e.group.add(o),e.targetBuildingTypes=[Pt.POWER_STATION,Pt.TOOLSTATION],e.priorityIdentifier=St.aiPriorityCrystal,e}return zt(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.PowerCrystal},enumerable:!1,configurable:!0}),e}(qt),Qt=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),$t=function(t){function e(){var e=t.call(this,Pt.ORE)||this,n=_t.getResource("MiscAnims/Ore/Ore1st.lwo"),r=ut.registerMesh(new It("MiscAnims/Ore/").parse(n));return e.group.add(r),e.targetBuildingTypes=[Pt.ORE_REFINERY,Pt.TOOLSTATION],e.priorityIdentifier=St.aiPriorityOre,e}return Qt(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Ore},enumerable:!1,configurable:!0}),e}(qt),te=function(){function t(){this.levelDefault=[],this.current=[]}return t.prototype.setList=function(t){this.levelDefault=t,this.reset()},t.prototype.toggle=function(t){this.current[t].enabled=!this.current[t].enabled},t.prototype.upOne=function(t){var e=this.current[t];this.current[t]=this.current[t+1],this.current[t+1]=e},t.prototype.reset=function(){this.current=this.levelDefault.map((function(t){return new ee(t)}))},t.prototype.pushToTop=function(t){for(var e=this.current[t],n=t;n>0;n--)this.current[n]=this.current[n-1];this.current[0]=e},t.prototype.getPriority=function(t){var e=0;return this.current.some((function(n,r){if(n.key===t.getPriorityIdentifier())return e=r,!0})),e},t}(),ee=function(t){this.key=t.key,this.enabled=t.enabled},ne=function(){function t(t){this.name=t}return t.DRIVER=new t("driver"),t.ENGINEER=new t("engineer"),t.GEOLOGIST=new t("geologist"),t.PILOT=new t("pilot"),t.SAILOR=new t("sailor"),t.DEMOLITION=new t("demolition"),t}();!function(t){t[t.SURFACE=0]="SURFACE",t[t.RAIDER=1]="RAIDER",t[t.BUILDING=2]="BUILDING",t[t.VEHICLE=3]="VEHICLE",t[t.GROUP=4]="GROUP"}(Ft||(Ft={})),function(t){t[t.RUNNING=0]="RUNNING",t[t.COMPLETE=1]="COMPLETE",t[t.FAILED=2]="FAILED"}(Ut||(Ut={}));var re,ie=function(){function t(){}return t.reset=function(){this.resultState=Ut.RUNNING,this.levelFullName="",this.numCrystal=0,this.numOre=0,this.numBrick=0,this.usedCrystals=0,this.neededCrystals=0,this.airLevel=1,this.selectedEntities=[],this.selectionType=null,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.requestedRaiders=0,this.materials=[],this.materialsUndiscovered=[],this.buildingSites=[],this.spiders=[],this.spidersBySurface=new Map,this.bats=[],this.totalCrystals=0,this.totalOres=0,this.totalDiggables=0,this.remainingDiggables=0,this.totalCaverns=0,this.discoveredCaverns=0,this.levelStartTime=0,this.levelStopTime=0,this.rewardConfig=null,this.priorityList=new te,this.oxygenRate=0,this.buildModeSelection=null},t.getBuildingsByType=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.buildings.filter((function(e){return!e.inBeam&&e.isPowered()&&t.some((function(t){return e.entityType===t}))}))},t.getClosestBuildingByType=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var i=t.getBuildingsByType.apply(t,n),o=null,a=null;return i.forEach((function(t){var n=t.getDropPosition(),r=e.distanceToSquared(n);(null===o||r<a)&&(o=t,a=r)})),o},t.hasOneBuildingOf=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.buildings.some((function(e){return t.some((function(t){return e.entityType===t}))&&e.isPowered()}))},t.hasBuildingWithUpgrades=function(t,e){return void 0===e&&(e=0),this.buildings.some((function(n){return n.entityType===t&&n.level>=e&&n.isPowered()}))},t.getTrainingSites=function(t,e){return e===ne.DEMOLITION?this.buildings.filter((function(t){return t.stats.TrainDynamite&&t.stats.TrainDynamite[t.level]})):[]},t.selectEntities=function(t){var e=this;this.selectedEntities=this.selectedEntities.filter((function(e){var n=-1!==t.indexOf(e);return n||e.deselect(),n}));var n=[];t.forEach((function(t){var r=t.select();r&&(e.selectedEntities.push(t),n.push(r))}));var r=this.selectedEntities.length;r>1?this.selectionType=Ft.GROUP:1===r?this.selectionType=this.selectedEntities[0].getSelectionType():null!==this.selectionType&&(this.selectionType=null,s.publishEvent(new y)),n.forEach((function(t){return s.publishEvent(t)}))},t.getMaxRaiders=function(){return 12+10*t.buildings.count((function(t){return t.isPowered()&&t.entityType===Pt.BARRACKS}))},t.discoverSurface=function(t){var e=t.x*x,n=t.y*x,r=e+x,i=n+x;this.discoverEntities(this.raidersUndiscovered,e,r,n,i),this.discoverEntities(this.buildingsUndiscovered,e,r,n,i),this.discoverEntities(this.materialsUndiscovered,e,r,n,i)},t.discoverEntities=function(t,e,n,r,i){var o=[];t.forEach((function(t){var a=t.getPosition();a.x>=e&&a.x<n&&a.z>=r&&a.z<i&&(t.onDiscover(),o.push(t))})),o.forEach((function(e){return t.remove(e)}))},t.dropMaterial=function(e,n){var r=[];if(e===Pt.CRYSTAL)for(;t.numCrystal>0&&r.length<n;)t.numCrystal--,r.push(new Zt);else if(e===Pt.ORE)for(;t.numOre>0&&r.length<n;)t.numOre--,r.push(new $t);else console.error("Material drop not implemented for: "+e);return r.length>0&&s.publishEvent(new S(e)),r},Object.defineProperty(t,"gameTimeSeconds",{get:function(){return Math.round((t.levelStopTime-t.levelStartTime)/1e3)},enumerable:!1,configurable:!0}),Object.defineProperty(t,"score",{get:function(){if(!t.rewardConfig)return 0;var e=t.rewardConfig.quota,n=t.rewardConfig.importance,r=t.numCrystal>=(e.crystals||1/0)?n.crystals:0,i=t.gameTimeSeconds<=(e.timer||0)?n.timer:0,o=e.caverns?Math.min(1,t.discoveredCaverns/e.caverns)*n.caverns:0,a=e.constructions?Math.min(1,t.buildings.length/e.constructions*n.constructions):0,s=t.airLevel*n.oxygen,u=t.raiders.length>=12?n.figures:0;return Math.round(r+i+o+a+s+u)/100},enumerable:!1,configurable:!0}),Object.defineProperty(t,"selectedSurface",{get:function(){return this.selectionType===Ft.SURFACE&&this.selectedEntities.length>0?this.selectedEntities[0]:null},enumerable:!1,configurable:!0}),Object.defineProperty(t,"selectedBuilding",{get:function(){return this.selectionType===Ft.BUILDING&&this.selectedEntities.length>0?this.selectedEntities[0]:null},enumerable:!1,configurable:!0}),Object.defineProperty(t,"selectedRaiders",{get:function(){return(this.selectionType===Ft.RAIDER||this.selectionType===Ft.GROUP)&&this.selectedEntities.length>0?this.selectedEntities:[]},enumerable:!1,configurable:!0}),Object.defineProperty(t,"totalOre",{get:function(){return this.numOre+5*this.numBrick},enumerable:!1,configurable:!0}),t.getNearbySpiders=function(e){for(var n=e.worldMgr.sceneManager.terrain,r=n.getSurfaceFromWorld(e.getPosition()),i=[],o=r.x;o<=r.x+1;o++)for(var a=r.y;a<=r.y+1;a++){var s=n.getSurface(o,a);i.push.apply(i,t.spidersBySurface.get(s)||[])}return i},t.resultState=Ut.RUNNING,t.levelFullName="",t.numCrystal=0,t.numOre=0,t.numBrick=0,t.usedCrystals=0,t.neededCrystals=0,t.airLevel=1,t.selectedEntities=[],t.selectionType=null,t.buildings=[],t.buildingsUndiscovered=[],t.raiders=[],t.raidersUndiscovered=[],t.requestedRaiders=0,t.materials=[],t.materialsUndiscovered=[],t.buildingSites=[],t.spiders=[],t.spidersBySurface=new Map,t.bats=[],t.totalCrystals=0,t.totalOres=0,t.totalDiggables=0,t.remainingDiggables=0,t.totalCaverns=0,t.discoveredCaverns=0,t.levelStartTime=0,t.levelStopTime=0,t.rewardConfig=null,t.priorityList=new te,t.oxygenRate=0,t.buildModeSelection=null,t}(),oe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ae=function(t){function e(e,n){var r=t.call(this,kt.GET_TOOL)||this;return r.target=[new Vt(e)],r.tool=n,r}return oe(e,t),e.prototype.getWorkplaces=function(){return this.target},e.prototype.onJobComplete=function(){var e=this;t.prototype.onJobComplete.call(this),this.fulfiller.forEach((function(t){return t.addTool(e.tool)}))},e}(Bt),se=function(){function t(t,e,n,r){this.x0=0,this.y0=0,this.x1=0,this.y1=0,this.center=null,this.x0=t,this.y0=e,this.x1=n,this.y1=r,this.center=new D.FM8((this.x0+this.x1)/2,(this.y0+this.y1)/2)}return t.prototype.getCenter=function(){return this.center.clone()},t}(),ue=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ce=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ue(e,t),e.Route=new e("Activity_Route"),e.RunPanic=new e("Activity_RunPanic"),e.Drill=new e("Activity_Drill"),e.Walk=new e("!Activity_Walk"),e.Reinforce=new e("Activity_Reinforce"),e.Reverse=new e("!Activity_Reverse"),e.TurnLeft=new e("!Activity_TurnLeft"),e.TurnRight=new e("!Activity_TurnRight"),e.CantDo=new e("!Activity_CantDo"),e.Collect=new e("Activity_Collect"),e.Clear=new e("Activity_Clear"),e.Carry=new e("Activity_Carry"),e.CarryTurnLeft=new e("!Activity_CarryTurnLeft"),e.CarryTurnRight=new e("!Activity_CarryTurnRight"),e.CarryStand=new e("Activity_CarryStand"),e.Dynamite=new e("Activity_Dynamite"),e.Place=new e("Activity_Place"),e.Deposit=new e("!Activity_Deposit"),e.TeleportIn=new e("Activity_TeleportIn"),e.Repair=new e("Activity_Repair"),e.rest=new e("Activity_rest"),e.routeRubble=new e("!Activity_routeRubble"),e.CarryRubble=new e("!Activity_CarryRubble"),e.Eat=new e("Activity_Eat"),e.FireLaser=new e("Activity_FireLaser"),e.GetUp=new e("!Activity_GetUp"),e.ThrownByRockMonster=new e("Activity_ThrownByRockMonster"),e.Slip=new e("Activity_Slip"),e.Train=new e("Activity_Train"),e.Recharge=new e("!Activity_Recharge"),e.Waiting1=new e("Activity_Waiting1"),e.Waiting2=new e("Activity_Waiting2"),e.Waiting3=new e("Activity_Waiting3"),e.Waiting4=new e("Activity_Waiting4"),e.Hoverboard=new e("Activity_Hoverboard"),e.Standhoverboard=new e("Activity_Standhoverboard"),e.HitLefthoverboard=new e("!Activity_HitLefthoverboard"),e.HitRighthoverboard=new e("!Activity_HitRighthoverboard"),e.HitFronthoverboard=new e("!Activity_HitFronthoverboard"),e.HitBackhoverboard=new e("!Activity_HitBackhoverboard"),e.SMALLTRUCK=new e("Activity_SMALLTRUCK"),e.StandSMALLTRUCK=new e("Activity_StandSMALLTRUCK"),e.HitLeftSMALLTRUCK=new e("!Activity_HitLeftSMALLTRUCK"),e.HitRightSMALLTRUCK=new e("!Activity_HitRightSMALLTRUCK"),e.HitFrontSMALLTRUCK=new e("!Activity_HitFrontSMALLTRUCK"),e.HitBackSMALLTRUCK=new e("!Activity_HitBackSMALLTRUCK"),e.SMALLheli=new e("Activity_SMALLheli"),e.StandSMALLheli=new e("Activity_StandSMALLheli"),e.HitLeftSMALLheli=new e("!Activity_HitLeftSMALLheli"),e.HitRightSMALLheli=new e("!Activity_HitRightSMALLheli"),e.HitFrontSMALLheli=new e("!Activity_HitFrontSMALLheli"),e.HitBackSMALLheli=new e("!Activity_HitBackSMALLheli"),e.SMALLCAT=new e("Activity_SMALLCAT"),e.StandSMALLCAT=new e("Activity_StandSMALLCAT"),e.HitLeftSMALLCAT=new e("!Activity_HitLeftSMALLCAT"),e.HitRightSMALLCAT=new e("!Activity_HitRightSMALLCAT"),e.HitFrontSMALLCAT=new e("!Activity_HitFrontSMALLCAT"),e.HitBackSMALLCAT=new e("!Activity_HitBackSMALLCAT"),e.SMALLMLP=new e("Activity_SMALLMLP"),e.StandSMALLMLP=new e("Activity_StandSMALLMLP"),e.HitLeftSMALLMLP=new e("!Activity_HitLeftSMALLMLP"),e.HitRightSMALLMLP=new e("!Activity_HitRightSMALLMLP"),e.HitFrontSMALLMLP=new e("!Activity_HitFrontSMALLMLP"),e.HitBackSMALLMLP=new e("!Activity_HitBackSMALLMLP"),e.LARGECAT=new e("Activity_LARGECAT"),e.StandLARGECAT=new e("Activity_StandLARGECAT"),e.HitLeftLARGECAT=new e("!Activity_HitLeftLARGECAT"),e.HitRightLARGECAT=new e("!Activity_HitRightLARGECAT"),e.HitFrontLARGECAT=new e("!Activity_HitFrontLARGECAT"),e.HitBackLARGECAT=new e("!Activity_HitBackLARGECAT"),e.SMALLDIGGER=new e("Activity_SMALLDIGGER"),e.StandSMALLDIGGER=new e("Activity_StandSMALLDIGGER"),e}(At),le=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),he=function(t){function e(e,n){var r=t.call(this,kt.TRAIN)||this;return r.workplaces=[new pe(e)],r.training=n,r}return le(e,t),e.prototype.getWorkplaces=function(){return this.workplaces},e.prototype.onJobComplete=function(){var e=this;t.prototype.onJobComplete.call(this),this.fulfiller.forEach((function(t){t.addTraining(e.training),s.publishEvent(new A(t,e.training))}))},e.prototype.getWorkActivity=function(){return ce.Train},e.prototype.getWorkDuration=function(){return 1e4},e}(Bt),pe=function(t){function e(e){var n=t.call(this,e.getCenterWorld2D())||this;return n.targetArea=new se(e.x*x-5,e.y*x-5,(e.x+1)*x+5,(e.y+1)*x+5),n}return le(e,t),e.prototype.isInArea=function(t){return t.x>=this.targetArea.x0&&t.x<this.targetArea.x1&&t.y>=this.targetArea.y0&&t.y<this.targetArea.y1},e}(Vt),fe=function(){function t(t){var e=this;this.jobs=[],this.assignInterval=null,this.checkRubbleInterval=null,this.worldMgr=t,s.registerEventListener(r.JOB_CREATE,(function(t){e.jobs.push(t.job)})),s.registerEventListener(r.JOB_DELETE,(function(t){t.job.cancel()}))}return t.prototype.start=function(){stop(),this.assignInterval=setInterval(this.assignJobs.bind(this),1e3),this.checkRubbleInterval=setInterval(this.checkUnclearedRubble.bind(this),5e3)},t.prototype.stop=function(){this.assignInterval=G(this.assignInterval),this.checkRubbleInterval=G(this.checkRubbleInterval),ie.raiders.forEach((function(t){return t.resetWorkInterval()})),ie.raidersUndiscovered.forEach((function(t){return t.resetWorkInterval()}))},t.prototype.assignJobs=function(){var t=[];this.jobs=this.jobs.filter((function(e){var n=e.jobstate===Ct.INCOMPLETE;return n&&e.fulfiller.length<1&&t.push(e),n})),t.sort((function(t,e){return Math.sign(ie.priorityList.getPriority(t)-ie.priorityList.getPriority(e))}));var e=ie.raiders.filter((function(t){return!t.job}));t.forEach((function(t){var n=null,r=null,i=null,o=null,a=null,s=null,u=null,c=null,l=null,h=null,p=null,f=null,d=null;e.forEach((function(e,y){var g=t.getRequiredTool(),v=e.hasTool(g),m=t.getRequiredTraining(),w=e.hasTraining(m),b=e.getPosition();if(v&&w){var _=t.getWorkplaces().map((function(t){return e.findPathToTarget(t)})).sort((function(t,e){return t.lengthSq-e.lengthSq}))[0];if(_){var O=_.lengthSq;(null===i||O<i)&&(n=e,r=y,i=O)}}else if(v){var E=ie.getTrainingSites(b,m).map((function(t){return e.findPathToTarget(new Vt(t.getPosition2D()))})).sort((function(t,e){return t.lengthSq-e.lengthSq}))[0];E&&(O=E.lengthSq,(null===p||O<p)&&(l=e,h=y,p=O,f=e.worldMgr.sceneManager.terrain.getSurfaceFromWorld2D(E.targetPosition),d=m))}else{var P=ie.getBuildingsByType(Pt.TOOLSTATION).map((function(t){return e.findPathToTarget(new Vt(t.getPosition2D()))})).sort((function(t,e){return t.lengthSq-e.lengthSq}))[0];if(P){O=P.lengthSq;(null===s||O<s)&&(o=e,a=y,s=O,u=P.targetPosition,c=g)}}})),n?(n.setJob(t),e.splice(r,1)):o?(o.setJob(new ae(u,c),t),e.splice(a,1)):l&&(l.setJob(new he(f,d),t),e.splice(h,1))}))},t.prototype.checkUnclearedRubble=function(){ie.raiders.forEach((function(t){if(!t.job)for(var e=t.worldMgr.sceneManager.terrain.getSurfaceFromWorld(t.getPosition()),n=0;n<10;n++)for(var r=e.x-n;r<=e.x+n;r++)for(var i=e.y-n;i<=e.y+n;i++){var o=t.worldMgr.sceneManager.terrain.getSurfaceOrNull(r,i);if((null==o?void 0:o.hasRubble())&&(null==o?void 0:o.discovered)){var a=o.createClearRubbleJob();if(a){var s=a.getRequiredTool();if(t.hasTool(s))t.setJob(a);else{var u=ie.getBuildingsByType(Pt.TOOLSTATION).map((function(e){return t.findPathToTarget(new Vt(e.getPosition2D()))})).sort((function(t,e){return t.lengthSq-e.lengthSq}))[0];u&&t.setJob(new ae(u.targetPosition,s),a)}}}}}))},t}(),de=function(){function t(t){void 0===t&&(t=!1),this.debug=!1,this.onLevelComplete=null,this.nerpInterval=null,this.registers=new Array(8).fill(0),this.timers=new Array(4).fill(0),this.scriptLines=[],this.statements=[],this.macrosByName={},this.labelsByName={},this.halted=!1,this.programCounter=0,this.messages=[],this.messagePermit=null,this.debug=t}return t.prototype.startExecution=function(){var t=this;this.nerpInterval=setInterval((function(){t.execute()}),2e3)},t.prototype.pauseExecution=function(){this.nerpInterval=G(this.nerpInterval)},t.prototype.checkRegister=function(t){var e=parseInt(t);if(isNaN(e)||e<0||e>this.registers.length)throw new Error("Invalid register ("+t+") provided");return e},t.prototype.checkRegisterValue=function(t){var e=parseInt(t);if(isNaN(e))throw new Error("Invalid register value ("+t+") provided");return e},t.prototype.getR=function(t){return t=this.checkRegister(t),this.registers[t]},t.prototype.setR=function(t,e){t=this.checkRegister(t),e=this.checkRegisterValue(e),this.registers[t]=e},t.prototype.addR=function(t,e){t=this.checkRegister(t),e=this.checkRegisterValue(e),this.registers[t]+=e},t.prototype.setTimer=function(t,e){var n=parseInt(e);if(isNaN(n))throw new Error("Can't set timer to NaN value: "+e);this.timers[t]=(new Date).getTime()+n},t.prototype.getTimer=function(t){return(new Date).getTime()-this.timers[t]},t.prototype.setLevelCompleted=function(){console.log("Nerp runner marks level as complete"),this.halted=!0,ie.resultState=Ut.COMPLETE,this.onLevelComplete()},t.prototype.setLevelFail=function(){console.log("NerpRunner marks level as failed"),this.halted=!0,ie.resultState=Ut.FAILED,this.onLevelComplete()},t.prototype.setTutorialFlags=function(t){},t.prototype.setMessagePermit=function(t){this.messagePermit=!t},t.prototype.setBuildingsUpgradeLevel=function(t,e){ie.buildings.forEach((function(n){n.entityType===t&&(n.level=e)}))},t.prototype.setToolStoreLevel=function(t){this.setBuildingsUpgradeLevel(Pt.TOOLSTATION,t)},t.prototype.setTeleportPadLevel=function(t){this.setBuildingsUpgradeLevel(Pt.TELEPORT_PAD,t)},t.prototype.setPowerStationLevel=function(t){this.setBuildingsUpgradeLevel(Pt.POWER_STATION,t)},t.prototype.setBarracksLevel=function(t){this.setBuildingsUpgradeLevel(Pt.BARRACKS,t)},t.prototype.getToolStoresBuilt=function(){return ie.buildings.count((function(t){return t.entityType===Pt.TOOLSTATION}))},t.prototype.getMinifiguresOnLevel=function(){return ie.raiders.length},t.prototype.getCrystalsCurrentlyStored=function(){return ie.numCrystal},t.prototype.getObjectiveSwitch=function(){return 0},t.prototype.setMessageTimerValues=function(t,e,n){},t.prototype.getMessageTimer=function(){return 0},t.prototype.cameraUnlock=function(){},t.prototype.setMessage=function(t,e){if(this.messagePermit&&0!==t){var n=this.messages[t];console.log(n.txt)}},t.prototype.setCameraGotoTutorial=function(t){},t.prototype.getTutorialBlockIsGround=function(t){return 0},t.prototype.getTutorialBlockIsPath=function(t){return 0},t.prototype.getUnitAtBlock=function(t){return 0},t.prototype.getOxygenLevel=function(){return 100},t.prototype.getObjectiveShowing=function(){return!1},t.prototype.addPoweredCrystals=function(){},t.prototype.disallowAll=function(){},t.prototype.getPoweredPowerStationsBuilt=function(){return ie.buildings.count((function(t){return t.isPowered()&&t.entityType===Pt.POWER_STATION}))},t.prototype.getPoweredBarracksBuilt=function(){return ie.buildings.count((function(t){return t.isPowered()&&t.entityType===Pt.BARRACKS}))},t.prototype.getRecordObjectAtTutorial=function(){},t.prototype.getHiddenObjectsFound=function(){return 0},t.prototype.getLevel1PowerStationsBuilt=function(){return 0},t.prototype.callMethod=function(t,e){if("Stop"===t)throw"Stop";if("TRUE"===t)return!0;if("FALSE"===t)return!1;var n=t.match(/^SetR([0-7])$/);if(n)return this.setR(n[1],e[0]);var r=t.match(/^AddR([0-7])$/);if(r)return this.addR(r[1],e[0]);var i=t.match(/^GetR([0-7])$/);if(i)return this.getR(i[1]);var o=t.match(/^SetTimer([0-3])$/);if(o)return this.setTimer(o[1],e[0]);var a=t.match(/^GetTimer([0-3])$/);if(a)return this.getTimer(a[1]);var s=t.toLowerCase();for(var u in this)if(u.toLowerCase()===s)return this[u].apply(this,e);throw new Error("Undefined method: "+t)},t.prototype.conditional=function(t,e){var n=this.executeStatement(t);this.debug&&console.log("Condition evaluated to "+n),n&&this.executeStatement(e)},t.prototype.executeStatement=function(t){var e=this;if(t.invoke){var n="conditional"!==t.invoke?t.args.map((function(t){return e.executeStatement(t)})):t.args,r=this.callMethod(t.invoke,n);return void 0!==r&&this.debug&&console.log("Method returned: "+r),r}if(t.comparator){var i=this.executeStatement(t.left),o=this.executeStatement(t.right);if("="===t.comparator)return i===o;if("!="===t.comparator)return i!==o;if("<"===t.comparator)return i<o;if(">"===t.comparator)return i>o;throw console.log(t),new Error("Unknown comparator: "+t.comparator)}if(!isNaN(t))return t;if(!t.jump)throw console.log(t),new Error("Unknown expression in line "+this.programCounter+": "+t);if(this.programCounter=this.labelsByName[t.jump],void 0===this.programCounter)throw new Error("Label '"+t.jump+"' is unknown!");this.debug&&console.log("Jumping to label '"+t.jump+"' in line "+this.programCounter)},t.prototype.execute=function(t){if(void 0===t&&(t=!1),this.debug=t,!this.halted)try{for(this.debug&&(console.log("Executing following script\n"+this.scriptLines.join("\n")),console.log("Registers: "+this.registers)),this.programCounter=0;this.programCounter<this.statements.length;this.programCounter++){var e=this.statements[this.programCounter];this.debug&&(console.log(this.programCounter+": "+this.scriptLines[this.programCounter]),console.log(e)),e.label||this.executeStatement(e)}}catch(t){if("Stop"===t)return;console.error(t),console.error("FATAL ERROR! Script execution failed! You can NOT win anymore!"),this.halted=!0}},t}(),ye=function(){function t(){}return t.parse=function(e){for(var n=new de,r=e.split("\n").map((function(t){return t.split("//")[0].trim().split(";")[0].trim().replace(/_/g,"").replace(/\bTRUE \? /,"").replace(/[{}]/g,"")})),i=0;i<r.length;i++)if(!((f=r[i]).length<1))if(f.startsWith("#include ")){var o=f.replace(/^#include /,"").trim().slice(1,-1);if("nerpdef.h"===o)continue;var a=t.parse(_t.getResource("Levels/"+o));if(!a||!a.scriptLines||a.scriptLines.length<1)throw"Can't include unknown nerp script: "+f;n.scriptLines=n.scriptLines.concat(a.scriptLines),n.macrosByName=Object.assign({},n.macrosByName,a.macrosByName)}else if(f.startsWith("#define ")){for(var s=f.replace(/^#define /,"").split(" "),u=[s.splice(1).join(" ").replace(/\\$/,"").trim()],c=f,l=!1;c.endsWith("\\")&&i<r.length-1;){var h=(c=r[++i].trim()).replace(/\\$/,"").trim();h.length>0&&(l?(l=!1,u[u.length-1]+=h):u.push(h)),c.match(/:\\$/)&&(l=!0)}var p=s[0].split("(");n.macrosByName[p[0]]={args:p[1].replace(/\)$/,"").split(","),lines:u}}else n.scriptLines=n.scriptLines.concat(this.replaceMacros(n.macrosByName,f));for(i=0;i<n.scriptLines.length;i++){var f=n.scriptLines[i];n.statements[i]=f.replace(/\(\)/g,"").split(" ? ");var d=f.match(/(\S+):/);if(2===n.statements[i].length)n.statements[i]={invoke:"conditional",args:[this.preProcess(n.statements[i][0]),this.preProcess(n.statements[i][1])]};else if(d){var y=d[1].toLowerCase();n.labelsByName[y]=i,n.statements[i]={label:y}}else{if(1!==n.statements[i].length)throw"Can't deal with line: "+f;n.statements[i]=this.preProcess(n.statements[i][0])}}return n},t.replaceMacros=function(t,e){var n=this,r=e.split("("),i=t[r[0]];if(i){var o=r.splice(1).join("(").slice(0,-1).split(",");if(o.length!==i.args.length)throw"Invalid number of args provided for macro in line "+e;var a=[];return i.lines.forEach((function(e){for(var r=0;r<o.length;r++)e=e.replace(new RegExp("\\b"+i.args[r]+"\\b"),o[r]);a.push.apply(a,n.replaceMacros(t,e))})),a}return[e]},t.preProcess=function(t){var e=this;t=t.trim().replace(/^_/,"");var n=parseInt(t);if(!isNaN(n))return n;var r=t.split(/ (=) | (!=) | (>) | (<) /).filter((function(t){return void 0!==t})),i=t.match(/^(.+)\((.+)\)$/),o=t.split(" "),a=t.match(/([^:]+):$/),s=t.match(/^:([^:]+)$/);if(3===r.length)return{left:this.preProcess(r[0]),comparator:r[1],right:this.preProcess(r[2])};if(i){var u=i[2].split(",").map((function(t){return e.preProcess(t)}));return{invoke:i[1],args:u}}if(o.length>1)return u=2===o.length?[this.preProcess(o[1])]:o.splice(1).map((function(t){return e.preProcess(t)})),{invoke:o[0],args:u};if(a)return{label:a[1]};if(s)return{jump:s[1].toLowerCase()};if(t.match(/[ =?><!]/))throw"Invalid expression given, parsing must have failed before somewhere";return{invoke:t,args:[]}},t}(),ge=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ve=function(t){function e(e){var n=t.call(this,kt.MOVE)||this;return n.target=[new Vt(e)],n}return ge(e,t),e.prototype.getWorkplaces=function(){return this.target},e}(Bt),me=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),we=function(t){function e(e,n){var r=t.call(this,e)||this;return r.location=n,r}return me(e,t),e}(_),be=(function(t){me((function(e){return t.call(this,r.LOCATION_DEATH,e)||this}),t)}(we),function(t){me((function(e){return t.call(this,r.LOCATION_MONSTER,e)||this}),t)}(we),function(t){function e(e){return t.call(this,r.LOCATION_CRYSTAL_FOUND,e)||this}return me(e,t),e}(we)),_e=(function(t){me((function(e){return t.call(this,r.LOCATION_UNDER_ATTACK,e)||this}),t)}(we),function(t){function e(e){return t.call(this,r.LOCATION_LANDSLIDE,e)||this}return me(e,t),e}(we)),Oe=(function(t){me((function(e){return t.call(this,r.LOCATION_POWER_DRAIN,e)||this}),t)}(we),function(t){me((function(e){return t.call(this,r.LOCATION_SLUG_EMERGE,e)||this}),t)}(we),function(t){function e(e){return t.call(this,r.LOCATION_RAIDER_DISCOVERED,e)||this}return me(e,t),e}(we)),Ee=function(t){this.vec=null,this.targetReached=!1,this.vec=t},Pe=function(){function t(t,e){this.target=null,this.locations=[],this.lengthSq=0,this.target=t,this.locations=Array.isArray(e)?e:[e];for(var n=0;n<this.locations.length-1;n++){var r=this.locations[n],i=this.locations[n+1];this.lengthSq+=r.distanceToSquared(i)}}return t.prototype.addLocation=function(t){return this.locations.push(t),this.locations.length>1&&(this.lengthSq+=this.locations[this.locations.length-2].distanceToSquared(t)),this},Object.defineProperty(t.prototype,"targetPosition",{get:function(){return this.locations[this.locations.length-1]||null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"firstLocation",{get:function(){return this.locations[0]||null},enumerable:!1,configurable:!0}),t}();!function(t){t[t.MOVED=0]="MOVED",t[t.TARGET_REACHED=1]="TARGET_REACHED",t[t.TARGET_UNREACHABLE=2]="TARGET_UNREACHABLE"}(re||(re={}));var Te=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Se=function(t){function e(e,n,r){var i=t.call(this,e,n,r)||this;return i.currentPath=null,i.floorOffset=0,i}return Te(e,t),e.prototype.getPosition=function(){return new D.Pa4(this.group.position.x,this.group.position.y,this.group.position.z)},e.prototype.getPosition2D=function(){return new D.FM8(this.group.position.x,this.group.position.z)},e.prototype.getSpeed=function(){var t;return this.stats.RouteSpeed[this.level]*((null===(t=this.animation)||void 0===t?void 0:t.transcoef)||1)*(this.isOnPath()?this.stats.PathCoef:1)},e.prototype.moveToClosestTarget=function(t){var e=this;if(t.length<1&&console.warn("No targets given"),!this.currentPath||!t.some((function(t){return t.targetLocation.equals(e.currentPath.target.targetLocation)}))){var n=t.map((function(t){return e.findPathToTarget(t)})).sort((function(t,e){return t.lengthSq-e.lengthSq}));if(this.currentPath=n.length>0?n[0]:null,!this.currentPath)return re.TARGET_UNREACHABLE}var r=this.currentPath.firstLocation;this.group.lookAt(new D.Pa4(r.x,this.group.position.y,r.y));var i=this.determineStep();return i.targetReached||this.currentPath.target.isInArea(this.getPosition2D())?re.TARGET_REACHED:(this.group.position.add(i.vec),this.changeActivity(this.getRouteActivity()),re.MOVED)},e.prototype.findPathToTarget=function(t){return new Pe(t,t.targetLocation)},e.prototype.determineStep=function(){var t=this.getEntityStep(this.currentPath.firstLocation),e=t.vec.lengthSq(),n=this.getSpeed();if(this.currentPath.locations.length>1){if(e<n*n)return this.currentPath.locations.shift(),this.determineStep()}else e<25&&(t.targetReached=!0);return t.vec.setLength(Math.min(n,5)),t},e.prototype.getEntityStep=function(t){var e=this.worldMgr.getFloorPosition(t);return e.y+=this.floorOffset,new Ee(e.sub(this.group.position))},e.prototype.isOnRubble=function(){return this.worldMgr.sceneManager.terrain.getSurfaceFromWorld(this.group.position).hasRubble()},e.prototype.isOnPath=function(){return this.worldMgr.sceneManager.terrain.getSurfaceFromWorld(this.group.position).isPath()},e}(Dt),Ie=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ce=function(t){function e(e,n,r,i){var o=t.call(this,e,n,r)||this;return o.workInterval=null,o.job=null,o.followUpJob=null,o.carries=null,o.jobWorkplaces=[],o.selectionType=i,o.group.userData={selectable:o},o.workInterval=setInterval(o.work.bind(o),33.333333333333336),o}return Ie(e,t),e.prototype.resetWorkInterval=function(){this.workInterval=G(this.workInterval)},e.prototype.dropItem=function(){this.carries&&(this.carryJoint?(this.carryJoint.remove(this.carries.group),this.carryJoint.getWorldPosition(this.carries.group.position)):this.carries.group.position.copy(this.worldMgr.getFloorPosition(this.getPosition2D())),this.carries.worldMgr.sceneManager.scene.add(this.carries.group),this.carries=null)},e.prototype.pickupItem=function(t){this.carries=t,this.carryJoint&&this.carryJoint.add(this.carries.group),this.carries.group.position.set(0,0,0)},e.prototype.setJob=function(t,e){void 0===e&&(e=null),this.job!==t&&this.stopJob(),this.job=t,this.job&&this.job.assign(this),this.followUpJob=e,this.followUpJob&&this.followUpJob.assign(this),this.jobWorkplaces=this.job.getWorkplaces()},e.prototype.stopJob=function(){this.dropItem(),this.job&&(this.job.unassign(this),this.followUpJob&&this.followUpJob.unassign(this),this.job=null,this.followUpJob=null,this.jobWorkplaces=[],this.changeActivity())},e.prototype.getSelectionType=function(){return this.selectionType},e.prototype.deselect=function(){this.selectionFrame.visible=!1,this.selected=!1},e}(Se),Re=function(){function t(t){this.name=t}return t.DRILL=new t("drill"),t.HAMMER=new t("hammer"),t.SHOVEL=new t("shovel"),t.SPANNER=new t("spanner"),t.FREEZERGUN=new t("freezergun"),t.LASER=new t("laser"),t.PUSHERGUN=new t("pushergun"),t.BIRDSCARER=new t("birdscarer"),t}(),Le=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ae=D.M8C.degToRad,Me=function(t){function e(){var e=t.call(this,Tt.RAIDER,Pt.PILOT,"mini-figures/pilot/pilot.ae",Ft.RAIDER)||this;return e.tools=new Map,e.trainings=new Map,e.slipped=!1,e.tools.set(Re.DRILL,!0),e}return Le(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Pilot},enumerable:!1,configurable:!0}),e.prototype.findPathToTarget=function(t){return this.worldMgr.sceneManager.terrain.findPath(this.getPosition2D(),t)},e.prototype.onDiscover=function(){t.prototype.onDiscover.call(this),ie.raidersUndiscovered.remove(this),ie.raiders.push(this),s.publishEvent(new I(this)),s.publishEvent(new Oe(this.getPosition()))},e.prototype.select=function(){return this.selectionFrame.visible=!this.slipped,this.selected||this.slipped?null:(this.selected=!0,this.changeActivity(),new d(this))},e.prototype.getSelectionCenter=function(){return this.pickSphere?(new D.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null},e.prototype.isDriving=function(){return!1},e.prototype.getRouteActivity=function(){return this.isOnRubble()?this.carries?ce.CarryRubble:ce.routeRubble:this.carries?ce.Carry:ce.Route},e.prototype.moveToClosestTarget=function(e){var n,r=this,i=t.prototype.moveToClosestTarget.call(this,e);return this.job.setActualWorkplace(null===(n=this.currentPath)||void 0===n?void 0:n.target),i===re.MOVED?ie.getNearbySpiders(this).some((function(t){if(r.group.position.distanceToSquared(t.group.position)<r.radiusSq+t.radiusSq)return r.slip(),t.onDeath(),!0})):i===re.TARGET_UNREACHABLE&&(console.log("Entity could not move to job target, stopping job"),this.stopJob()),i},e.prototype.slip=function(){var t=this;F(0,100)<10&&this.stopJob(),this.dropItem(),this.slipped=!0,this.changeActivity(ce.Slip,(function(){t.slipped=!1}))},e.prototype.moveToClosestWorkplace=function(){return this.moveToClosestTarget(this.jobWorkplaces)===re.TARGET_REACHED},e.prototype.work=function(){var t=this;if(this.job&&!this.selected&&!this.slipped)if(this.job.jobstate===Ct.INCOMPLETE)if(this.job.type===kt.DRILL){if(this.moveToClosestWorkplace()){var e=this.job,n=this.getDrillTime(e.surface.surfaceType),r=e.surface.getCenterWorld();r.y=this.group.position.y,this.group.lookAt(r),this.changeActivity(ce.Drill,(function(){if(e.surface.seamLevel>0){e.surface.seamLevel--;var n=(new D.FM8).copy(t.getPosition2D()).sub(e.surface.getCenterWorld2D()).multiplyScalar(.3+U(3)/10).rotateAround(new D.FM8(0,0),Ae(-10+U(20))).add(t.getPosition2D());if(e.surface.surfaceType===nt.CRYSTAL_SEAM){var r=t.worldMgr.placeMaterial(new Zt,n);s.publishEvent(new be(r.getPosition()))}else e.surface.surfaceType===nt.ORE_SEAM&&(t.worldMgr.placeMaterial(new $t,n),s.publishEvent(new R));t.changeActivity()}else t.completeJob()}),n)}}else{var i=this.job.getCarryItem();if(i&&this.carries!==i)this.dropItem(),this.moveToClosestTarget([new Vt(i.getPosition2D())])&&this.changeActivity(ce.Collect,(function(){t.pickupItem(i)}));else if(this.moveToClosestWorkplace())if(this.job.isReadyToComplete()){var o=this.job.getWorkActivity()||this.getDefaultActivity();this.changeActivity(o,(function(){t.completeJob()}),this.job.getWorkDuration())}else this.changeActivity()}else this.stopJob()},e.prototype.getDrillTime=function(t){var e=null;return t===nt.HARD_ROCK?e=1e3*this.stats.HardDrillTime[this.level]:t===nt.LOOSE_ROCK?e=1e3*this.stats.LooseDrillTime[this.level]:t===nt.DIRT?e=1e3*this.stats.SoilDrillTime[this.level]:t!==nt.ORE_SEAM&&t!==nt.CRYSTAL_SEAM||(e=1e3*this.stats.SeamDrillTime[this.level]),(e=e||0)||console.warn("According to cfg this entity cannot drill this material"),e},e.prototype.completeJob=function(){var t,e,n;null===(t=this.job)||void 0===t||t.onJobComplete(),(null===(e=this.job)||void 0===e?void 0:e.jobstate)!==Ct.INCOMPLETE&&(this.job&&this.job.unassign(this),this.job=this.followUpJob,this.followUpJob=null,this.jobWorkplaces=(null===(n=this.job)||void 0===n?void 0:n.getWorkplaces())||[],this.changeActivity())},e.prototype.getDefaultActivity=function(){return this.carries?ce.CarryStand:t.prototype.getDefaultActivity.call(this)},e.prototype.beamUp=function(){this.stopJob(),t.prototype.beamUp.call(this)},e.prototype.removeFromScene=function(){t.prototype.removeFromScene.call(this),ie.raiders.remove(this)},e.prototype.hasTool=function(t){return!t||this.tools.has(t)},e.prototype.hasTraining=function(t){return!t||this.trainings.has(t)},e.prototype.addTool=function(t){this.tools.set(t,!0)},e.prototype.addTraining=function(t){this.trainings.set(t,!0)},e}(Ce),xe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),De=function(t){function e(e,n){var i=t.call(this,Tt.BUILDING,e,n)||this;return i.blocksPathSurface=!0,i.secondaryBuildingPart=null,i.primaryPowerPath={x:0,y:1},i.secondaryPowerPath=null,i.waterPathSurface=null,i.powerSwitch=!0,i.spawning=!1,i.primarySurface=null,i.secondarySurface=null,i.primaryPathSurface=null,i.secondaryPathSurface=null,i.upgradeCostOre=0,i.upgradeCostBrick=0,i.crystalsInUse=0,i.inBeam=!1,i.group.applyMatrix4((new D.yGw).makeScale(-1,1,1)),i.group.userData={selectable:i},i.upgradeCostOre=_t.cfg("Main","BuildingUpgradeCostOre"),i.upgradeCostBrick=_t.cfg("Main","BuildingUpgradeCostStuds"),s.registerEventListener(r.MATERIAL_AMOUNT_CHANGED,(function(t){t.entityType===Pt.CRYSTAL&&i.powerSwitch&&i.turnOnPower()})),i}return xe(e,t),e.prototype.getSelectionType=function(){return Ft.BUILDING},e.prototype.select=function(){return this.inBeam?null:(this.selectionFrame.visible=!0,this.selected?null:(this.selected=!0,new f(this)))},e.prototype.deselect=function(){this.selectionFrame.visible=!1,this.selected=!1},e.prototype.getSelectionCenter=function(){return this.pickSphere?(new D.Pa4).copy(this.pickSphere.position).applyMatrix4(this.group.matrixWorld):null},e.prototype.getPickSphereCenter=function(){return new D.Pa4(0,this.stats.PickSphere/4,0)},e.prototype.getDropPosition2D=function(){if(this.getToolJoint){var t=new D.Pa4;return this.getToolJoint.getWorldPosition(t),new D.FM8(t.x,t.z)}return this.depositJoint?(t=new D.Pa4,this.depositJoint.getWorldPosition(t),new D.FM8(t.x,t.z)):this.getPosition2D()},e.prototype.getDropPosition=function(){return this.worldMgr.getFloorPosition(this.getDropPosition2D())},e.prototype.isPowered=function(){return this.powerSwitch&&(this.stats.SelfPowered||this.stats.PowerBuilding||this.crystalsInUse>0)},e.prototype.onDiscover=function(){t.prototype.onDiscover.call(this),ie.buildingsUndiscovered.remove(this),ie.buildings.push(this),s.publishEvent(new I(this))},e.prototype.hasMaxLevel=function(){return this.level>=this.stats.Levels-1},e.prototype.upgrade=function(){this.canUpgrade()&&(ie.numBrick>=this.upgradeCostBrick?(ie.numBrick-=this.upgradeCostBrick,s.publishEvent(new S(Pt.BRICK))):(ie.numOre-=this.upgradeCostOre,s.publishEvent(new S(Pt.ORE))),this.level++,s.publishEvent(new y),s.publishEvent(new L(this)))},e.prototype.getDefaultActivity=function(){return this.isPowered()?At.Stand:Jt.Unpowered},e.prototype.beamUp=function(){ie.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.inBeam=!0;for(var e=0;e<this.stats.CostOre;e++)this.worldMgr.placeMaterial(new $t,this.primarySurface.getRandomPosition());for(e=0;e<this.stats.CostCrystal;e++)this.worldMgr.placeMaterial(new Zt,this.primarySurface.getRandomPosition());this.surfaces.forEach((function(t){t.surfaceType=nt.GROUND,t.setBuilding(null),t.updateTexture(),t.neighbors.forEach((function(t){return t.updateTexture()}))})),t.prototype.beamUp.call(this)},e.prototype.removeFromScene=function(){t.prototype.removeFromScene.call(this),ie.buildings.remove(this)},e.prototype.canUpgrade=function(){return!this.hasMaxLevel()&&(ie.numOre>=this.upgradeCostOre||ie.numBrick>=this.upgradeCostBrick)},e.prototype.spawnMaterials=function(t){var e=this;t.forEach((function(t){return e.worldMgr.placeMaterial(t,e.getDropPosition2D())}))},e.prototype.turnOnPower=function(){this.crystalsInUse>0||ie.usedCrystals>=ie.numCrystal||this.entityType!==Pt.POWER_STATION&&!this.surfaces.some((function(t){return t.neighbors.some((function(t){return t.hasPower}))}))||(this.crystalsInUse=1,ie.usedCrystals+=this.crystalsInUse,this.surfaces.forEach((function(t){return t.setHasPower(!0,!0)})),this.changeActivity())},e.prototype.turnOffPower=function(){this.crystalsInUse<1||(ie.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.surfaces.forEach((function(t){return t.setHasPower(!1,!1)})),this.changeActivity())},Object.defineProperty(e.prototype,"surfaces",{get:function(){var t=[];return this.primarySurface&&t.push(this.primarySurface),this.secondarySurface&&t.push(this.secondarySurface),this.primaryPathSurface&&t.push(this.primaryPathSurface),this.secondaryPathSurface&&t.push(this.secondaryPathSurface),t},enumerable:!1,configurable:!0}),e.prototype.addToScene=function(t,e,n,r,i){var o=this;this.worldMgr=t,this.group.position.copy(t.getFloorPosition(new D.FM8(e,n))),this.group.rotateOnAxis(new D.Pa4(0,1,0),r),this.group.visible=t.sceneManager.terrain.getSurfaceFromWorld(this.group.position).discovered,t.sceneManager.scene.add(this.group),this.createPickSphere();var a=t.sceneManager.terrain.getSurfaceFromWorld(this.group.position);if(a.setBuilding(this),a.surfaceType=nt.POWER_PATH_BUILDING,a.updateTexture(),this.primarySurface=a,this.secondaryBuildingPart){var s=new D.Pa4(x*this.secondaryBuildingPart.x,0,x*this.secondaryBuildingPart.y).applyAxisAngle(new D.Pa4(0,1,0),r).add(this.group.position),u=t.sceneManager.terrain.getSurfaceFromWorld(s);u.setBuilding(this),u.surfaceType=nt.POWER_PATH_BUILDING,u.updateTexture(),this.secondarySurface=u}if(this.primaryPowerPath){var c=new D.Pa4(this.primaryPowerPath.x,0,this.primaryPowerPath.y).multiplyScalar(x).applyAxisAngle(new D.Pa4(0,1,0),r).add(this.group.position),l=t.sceneManager.terrain.getSurfaceFromWorld(c);this.entityType===Pt.GEODOME&&(l.building=this),l.surfaceType=nt.POWER_PATH_BUILDING,l.updateTexture(),this.primaryPathSurface=l}this.group.visible?ie.buildings.push(this):ie.buildingsUndiscovered.push(this),this.group.visible&&!i?(this.inBeam=!0,this.changeActivity(Jt.Teleport,(function(){return o.onAddToScene()}))):this.onAddToScene(),t.sceneManager.terrain.resetGraphWalk()},e.prototype.onAddToScene=function(){this.inBeam=!1,this.changeActivity(),s.publishEvent(new I(this)),this.turnOnPower()},e.prototype.getDropAction=function(){return ce.Place},e}(Dt),ke=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ne=function(t){function e(){return t.call(this,Pt.BARRACKS,"Buildings/Barracks/Barracks.ae")||this}return ke(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Barracks},enumerable:!1,configurable:!0}),e}(De),Be=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),je=function(t){function e(){var e=t.call(this,Pt.DOCKS,"Buildings/Docks/Docks.ae")||this;return e.waterPathSurface={x:0,y:1},e}return Be(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Docks},enumerable:!1,configurable:!0}),e}(De),Fe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ue=function(t){function e(){var e=t.call(this,Pt.GEODOME,"Buildings/Geo-dome/Geo-dome.ae")||this;return e.primaryPowerPath=null,e.secondaryBuildingPart={x:0,y:1},e}return Fe(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Geodome},enumerable:!1,configurable:!0}),e}(De),We=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),He=function(t){function e(){var e=t.call(this,Pt.GUNSTATION,"Buildings/gunstation/gunstation.ae")||this;return e.primaryPowerPath=null,e}return We(e,t),e.prototype.getDefaultActivity=function(){return Jt.Stand},Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.GunStation},enumerable:!1,configurable:!0}),e}(De),Ge=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Je=function(t){function e(){var e=t.call(this,Pt.ORE_REFINERY,"Buildings/OreRefinery/OreRefinery.ae")||this;return e.primaryPowerPath={x:0,y:2},e.secondaryBuildingPart={x:0,y:1},e}return Ge(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.OreRefinery},enumerable:!1,configurable:!0}),e.prototype.getDropAction=function(){return ce.Deposit},e}(De),Ve=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ye=function(t){function e(){var e=t.call(this,Pt.POWER_STATION,"Buildings/Powerstation/Powerstation.ae")||this;return e.secondaryBuildingPart={x:-1,y:0},e}return Ve(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Powerstation},enumerable:!1,configurable:!0}),e.prototype.getDropAction=function(){return ce.Deposit},e}(De),Xe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ke=function(t){function e(){var e=t.call(this,Pt.TELEPORT_BIG,"Buildings/BIGTeleport/BIGTeleport.ae")||this;return e.secondaryBuildingPart={x:1,y:0},e.secondaryPowerPath={x:1,y:1},e}return Xe(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.TeleportBIG},enumerable:!1,configurable:!0}),e}(De),qe=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ze=function(t){function e(){return t.call(this,Pt.TELEPORT_PAD,"Buildings/Teleports/Teleports.ae")||this}return qe(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.TeleportPad},enumerable:!1,configurable:!0}),e}(De),Ze=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Qe=function(t){function e(){var e=t.call(this,Pt.TOOLSTATION,"Buildings/Toolstation/Toolstation.ae")||this;return e.blocksPathSurface=!1,e}return Ze(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Toolstation},enumerable:!1,configurable:!0}),e}(De),$e=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),tn=function(t){function e(){return t.call(this,Pt.UPGRADE,"Buildings/Upgrade/Upgrade.ae")||this}return $e(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Upgrade},enumerable:!1,configurable:!0}),e}(De),en=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),nn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return en(e,t),e.Route=new e("Activity_Route"),e}(At),rn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),on=function(t){function e(e,n){var r=t.call(this,Tt.MONSTER,e,n)||this;return r.target=[],r}return rn(e,t),e.prototype.onLevelEnd=function(){this.moveTimeout=H(this.moveTimeout),this.removeFromScene()},e.prototype.getRouteActivity=function(){return nn.Route},e}(Se),an=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),sn=function(t){function e(){var e=t.call(this,Pt.BAT,"Creatures/bat/bat.ae")||this;return e.floorOffset=20,e}return an(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.Bat},enumerable:!1,configurable:!0}),e.prototype.startRandomMove=function(){e.onMove(this)},e.onMove=function(t){(t.target.length<1||t.moveToClosestTarget(t.target)===re.TARGET_REACHED)&&(t.target=[t.findTarget()]),t.moveTimeout=setTimeout((function(){return e.onMove(t)}),33.333333333333336)},e.prototype.findTarget=function(){for(var t=this.worldMgr.sceneManager.terrain,e=t.getSurfaceFromWorld(this.getPosition()).getCenterWorld(),n=0;n<20;n++){var r=F(e.x-60,e.x+x+20),i=F(e.z-20,e.z+20);if(t.getSurfaceFromWorldXZ(r,i).surfaceType.floor)return new Vt(new D.FM8(r,i))}return console.warn("Could not find a target"),null},e.prototype.onDeath=function(){this.onLevelEnd(),ie.bats.remove(this)},e}(on),un=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),cn=function(t){function e(){var e=t.call(this,Pt.SMALL_SPIDER,"Creatures/SpiderSB/SpiderSB.ae")||this;return e.currentSurface=null,e}return un(e,t),Object.defineProperty(e.prototype,"stats",{get:function(){return _t.stats.SmallSpider},enumerable:!1,configurable:!0}),e.prototype.startMoving=function(){e.onMove(this)},e.onMove=function(t){var n=t.currentSurface||t.worldMgr.sceneManager.terrain.getSurfaceFromWorld(t.group.position);if(t.target.length>0&&t.moveToClosestTarget(t.target)===re.MOVED){var r=t.worldMgr.sceneManager.terrain.getSurfaceFromWorld(t.group.position);n!==r&&((ie.spidersBySurface.get(n)||[]).remove(t),ie.spidersBySurface.getOrUpdate(r,(function(){return[]})).push(t)),t.worldMgr.sceneManager.terrain.getSurfaceFromWorld(t.getPosition()).surfaceType.floor?t.moveTimeout=setTimeout((function(){return e.onMove(t)}),33.333333333333336):t.onDeath()}else t.changeActivity(),t.moveTimeout=setTimeout((function(){t.target=[t.findTarget()],e.onMove(t)}),1e3+U(9e3))},e.prototype.findTarget=function(){for(var t=this.worldMgr.sceneManager.terrain,e=t.getSurfaceFromWorld(this.getPosition()).getCenterWorld(),n=0;n<20;n++){var r=F(e.x-60,e.x+x+20),i=F(e.z-20,e.z+20),o=t.getSurfaceFromWorldXZ(r,i).surfaceType;if(o!==nt.WATER&&o!==nt.LAVA)return new Vt(new D.FM8(r,i))}return console.warn("Could not find a target"),null},e.prototype.onDeath=function(){this.onLevelEnd(),ie.spiders.remove(this),ie.spidersBySurface.getOrUpdate(this.currentSurface,(function(){return[]})).remove(this)},e}(on),ln=D.M8C.degToRad,hn=function(){function t(){}return t.loadObjectList=function(t,e,n){var r=this;Object.values(e).forEach((function(e){var i=e.type?e.type.toLowerCase():e.type,o=(e.xPos-1)*x,a=(e.yPos-1)*x,u=t.getTerrainHeight(o,a),c=_t.cfg("BuildingTypes",e.type),l=ln(e.heading);if(i==="TVCamera".toLowerCase()){var h=new D.Pa4(200,0,0).applyAxisAngle(new D.Pa4(0,1,0),l-Math.PI/16).add(new D.Pa4(o,u,a-20));t.sceneManager.camera.position.copy(h),t.sceneManager.camera.position.y=180,t.sceneManager.controls.target.copy(new D.Pa4(o,u,a-20)),t.sceneManager.controls.update(),t.setTorchPosition(new D.FM8(o,a-20))}else if(i==="Pilot".toLowerCase()){var p=new Me;p.worldMgr=t,p.changeActivity(),p.createPickSphere(),p.group.position.set(o,u,a),p.group.rotateOnAxis(new D.Pa4(0,1,0),l-Math.PI/2),p.group.visible=t.sceneManager.terrain.getSurfaceFromWorld(p.group.position).discovered,p.group.visible?(ie.raiders.push(p),s.publishEvent(new I(p))):ie.raidersUndiscovered.push(p),t.sceneManager.scene.add(p.group)}else if(c)r.createBuildingByName(c).addToScene(t,o,a,-l-Math.PI,n);else if(i==="PowerCrystal".toLowerCase())t.placeMaterial(new Zt,new D.FM8(o,a));else if(i==="SmallSpider".toLowerCase()){var f=new cn;f.worldMgr=t,f.changeActivity(),f.group.position.set(o,u,a);var d=t.sceneManager.terrain.getSurfaceFromWorld(f.group.position);f.group.visible=d.discovered,t.sceneManager.scene.add(f.group),ie.spiders.push(f),ie.spidersBySurface.getOrUpdate(d,(function(){return[]})).push(f),f.startMoving()}else if(i==="Bat".toLowerCase()){var y=new sn;y.worldMgr=t,y.changeActivity(),y.group.position.set(o,y.floorOffset,a),y.group.visible=t.sceneManager.terrain.getSurfaceFromWorld(y.group.position).discovered,t.sceneManager.scene.add(y.group),ie.bats.push(y),y.startRandomMove()}else console.warn("Object type "+e.type+" not yet implemented")})),ie.buildings.forEach((function(t){return t.surfaces.forEach((function(t){return t.neighbors.forEach((function(t){return t.updateTexture()}))}))}))},t.createBuildingByName=function(t){var e=t.slice(t.lastIndexOf("/")+1).toLowerCase();if("toolstation"===e)return new Qe;if("teleports"===e)return new ze;if("docks"===e)return new je;if("powerstation"===e)return new Ye;if("barracks"===e)return new Ne;if("upgrade"===e)return new tn;if("geo-dome"===e)return new Ue;if("orerefinery"===e)return new Je;if("gunstation"===e)return new He;if("teleportbig"===e)return new Ke;throw"Unknown building type: "+e},t}();function pn(t){for(var e=t,n=[];e.parent;)n.unshift(e),e=e.parent;return n}var fn,dn,yn={search:function(t,e,n,r){void 0===r&&(r=null),t.cleanDirty();var i=(r=r||{}).heuristic||yn.heuristics.manhattan,o=r.closest||!1,a=new mn((function(t){return t.f})),s=e;for(e.h=i(e,n),t.markDirty(e),a.push(e);a.size()>0;){var u=a.pop();if(u===n)return pn(u);u.closed=!0;for(var c=t.neighbors(u),l=0,h=c.length;l<h;++l){var p=c[l];if(!p.closed&&!p.isWall()){var f=u.g+p.getCost(u),d=p.visited;(!d||f<p.g)&&(p.visited=!0,p.parent=u,p.h=p.h||i(p,n),p.g=f,p.f=p.g+p.h,t.markDirty(p),o&&(p.h<s.h||p.h===s.h&&p.g<s.g)&&(s=p),d?a.rescoreElement(p):a.push(p))}}}return o?pn(s):[]},heuristics:{manhattan:function(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)},diagonal:function(t,e){var n=Math.sqrt(2),r=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return 1*(r+i)+(n-2)*Math.min(r,i)}},cleanNode:function(t){t.f=0,t.g=0,t.h=0,t.visited=!1,t.closed=!1,t.parent=null}},gn=function(){function t(t,e){void 0===e&&(e=null),this.nodes=[],this.grid=[],this.dirtyNodes=[],e=e||{},this.diagonal=!!e.diagonal;for(var n=0;n<t.length;n++){this.grid[n]=[];for(var r=0,i=t[n];r<i.length;r++){var o=new vn(n,r,i[r]);this.grid[n][r]=o,this.nodes.push(o)}}this.init()}return t.prototype.init=function(){this.dirtyNodes=[];for(var t=0;t<this.nodes.length;t++)yn.cleanNode(this.nodes[t])},t.prototype.cleanDirty=function(){for(var t=0;t<this.dirtyNodes.length;t++)yn.cleanNode(this.dirtyNodes[t]);this.dirtyNodes=[]},t.prototype.markDirty=function(t){this.dirtyNodes.push(t)},t.prototype.neighbors=function(t){var e=[],n=t.x,r=t.y,i=this.grid;return i[n-1]&&i[n-1][r]&&e.push(i[n-1][r]),i[n+1]&&i[n+1][r]&&e.push(i[n+1][r]),i[n]&&i[n][r-1]&&e.push(i[n][r-1]),i[n]&&i[n][r+1]&&e.push(i[n][r+1]),this.diagonal&&(i[n-1]&&i[n-1][r-1]&&e.push(i[n-1][r-1]),i[n+1]&&i[n+1][r-1]&&e.push(i[n+1][r-1]),i[n-1]&&i[n-1][r+1]&&e.push(i[n-1][r+1]),i[n+1]&&i[n+1][r+1]&&e.push(i[n+1][r+1])),e},t.prototype.toString=function(){for(var t=[],e=this.grid,n=0;n<e.length;n++){for(var r=[],i=e[n],o=0;o<i.length;o++)r.push(i[o].weight);t.push(r.join(" "))}return t.join("\n")},t}(),vn=function(){function t(t,e,n){this.x=t,this.y=e,this.weight=n}return t.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},t.prototype.getCost=function(t){return t&&t.x!=this.x&&t.y!=this.y?1.41421*this.weight:this.weight},t.prototype.isWall=function(){return 0===this.weight},t}(),mn=function(){function t(t){this.content=[],this.content=[],this.scoreFunction=t}return t.prototype.push=function(t){this.content.push(t),this.sinkDown(this.content.length-1)},t.prototype.pop=function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.bubbleUp(0)),t},t.prototype.remove=function(t){var e=this.content.indexOf(t),n=this.content.pop();e!==this.content.length-1&&(this.content[e]=n,this.scoreFunction(n)<this.scoreFunction(t)?this.sinkDown(e):this.bubbleUp(e))},t.prototype.size=function(){return this.content.length},t.prototype.rescoreElement=function(t){this.sinkDown(this.content.indexOf(t))},t.prototype.sinkDown=function(t){for(var e=this.content[t];t>0;){var n=(t+1>>1)-1,r=this.content[n];if(!(this.scoreFunction(e)<this.scoreFunction(r)))break;this.content[n]=e,this.content[t]=r,t=n}},t.prototype.bubbleUp=function(t){for(var e=this.content.length,n=this.content[t],r=this.scoreFunction(n);;){var i=t+1<<1,o=i-1,a=null,s=void 0;if(o<e){var u=this.content[o];(s=this.scoreFunction(u))<r&&(a=o)}if(i<e){var c=this.content[i];this.scoreFunction(c)<(null===a?r:s)&&(a=i)}if(null===a)break;this.content[t]=this.content[a],this.content[a]=n,t=a}},t}(),wn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),bn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return wn(e,t),e.Normal=new e("Normal"),e.TickDown=new e("TickDown"),e}(Rt),_n=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),On=function(t){function e(e){var n=t.call(this,e)||this;return n.color=10510432,n}return _n(e,t),e.prototype.getRequiredTraining=function(){return ne.DEMOLITION},e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this),this.item.ignite()},e}(Ht),En=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Pn=function(t){function e(e){var n=t.call(this,Pt.DYNAMITE,"MiscAnims/Dynamite/Dynamite.ae")||this;return n.targetSurface=e,n.priorityIdentifier=St.aiPriorityDestruction,n.changeActivity(),n}return En(e,t),e.prototype.getCarryTargets=function(){return this.targetSurface&&this.targetSurface.isExplodable()?this.targetSurface.getDigPositions().map((function(t){return new Xt(t,null,null)})):ie.getBuildingsByType(Pt.TOOLSTATION).map((function(t){return t.getDropPosition2D()})).map((function(t){return new Xt(t,null,null)}))},e.prototype.ignite=function(){var t=this;this.worldMgr.sceneManager.scene.add(this.group);var e=this.targetSurface.getCenterWorld();e.y=this.group.position.y,this.group.lookAt(e),this.changeActivity(bn.TickDown,(function(){t.removeFromScene(),t.targetSurface.collapse()}))},e.prototype.getDefaultActivity=function(){return bn.Normal},e.prototype.createCarryJob=function(){return new On(this)},e}(qt),Tn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Sn=function(t){function e(e){var n=t.call(this,kt.CLEAR_RUBBLE)||this;return n.surface=e,n}return Tn(e,t),e.prototype.getRequiredTool=function(){return Re.SHOVEL},e.prototype.getWorkplaces=function(){var t=this.surface.rubblePositions;return t.length>0?[new Vt(t[0])]:[]},e.prototype.onJobComplete=function(){var e=this;this.fulfiller.forEach((function(t){return t.changeActivity()})),this.surface.reduceRubble(),this.fulfiller.forEach((function(t){return t.jobWorkplaces=e.getWorkplaces()})),this.surface.hasRubble()||t.prototype.onJobComplete.call(this)},e.prototype.getPriorityIdentifier=function(){return St.aiPriorityClearing},e.prototype.getWorkActivity=function(){return ce.Clear},e}(jt),In=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Cn=function(t){function e(e){var n=t.call(this,kt.DRILL)||this;return n.color=10526880,n.surface=e,n}return In(e,t),e.prototype.getRequiredTool=function(){return Re.DRILL},e.prototype.getWorkplaces=function(){return this.surface.getDigPositions().map((function(t){return new Vt(t)}))},e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this),this.surface.collapse()},e.prototype.getPriorityIdentifier=function(){return St.aiPriorityDestruction},e.prototype.getWorkActivity=function(){return ce.Drill},e}(jt),Rn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ln=function(t){function e(e){var n=t.call(this,kt.REINFORCE)||this;return n.color=6332512,n.surface=e,n}return Rn(e,t),e.prototype.getWorkplaces=function(){return this.surface.getDigPositions().map((function(t){return new Vt(t)}))},e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this),this.surface.reinforce()},e.prototype.getPriorityIdentifier=function(){return St.aiPriorityReinforce},e.prototype.getWorkActivity=function(){return ce.Reinforce},e.prototype.getWorkDuration=function(){return 2700},e}(jt),An=function(){function t(t,e,n,r,i){this.containedOres=0,this.containedCrystals=0,this.heightOffset=null,this.discovered=!1,this.selected=!1,this.reinforced=!1,this.drillJob=null,this.reinforceJob=null,this.dynamiteJob=null,this.clearRubbleJob=null,this.surfaceRotation=0,this.seamLevel=0,this.fallinTimeout=null,this.fallinGrp=null,this.animationTimeout=null,this.wallType=null,this.mesh=null,this.needsMeshUpdate=!1,this.topLeftHeightOffset=0,this.topRightHeightOffset=0,this.bottomLeftHeightOffset=0,this.bottomRightHeightOffset=0,this.rubblePositions=[],this.building=null,this.fence=null,this.hasPower=!1,this.terrain=t,this.surfaceType=e,e!==nt.CRYSTAL_SEAM&&e!==nt.ORE_SEAM||(this.seamLevel=4),this.x=n,this.y=r,this.heightOffset=i}return t.prototype.discoverNeighbors=function(){this.discovered||ie.discoverSurface(this),this.discovered=!0,this.needsMeshUpdate=!0;var t=!1;if(this.surfaceType.floor)for(var e=this.x-1;e<=this.x+1;e++)for(var n=this.y-1;n<=this.y+1;n++)if(e!==this.x||n!==this.y){var r=this.terrain.getSurfaceOrNull(e,n);r&&!r.discovered&&(t=r.discoverNeighbors()||r.surfaceType.floor,r.needsMeshUpdate=!0)}return t},t.prototype.collapse=function(){this.cancelJobs(),this.fallinTimeout=H(this.fallinTimeout),this.surfaceType=nt.RUBBLE4,this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=4,this.needsMeshUpdate=!0,this.discoverNeighbors()&&s.publishEvent(new C),this.dropContainedOre(this.containedOres-4);for(var t=0;t<this.containedCrystals;t++){var e=this.terrain.worldMgr.placeMaterial(new Zt,this.getRandomPosition());s.publishEvent(new be(e.getPosition()))}for(var n=this.x-1;n<=this.x+1;n++)for(var r=this.y-1;r<=this.y+1;r++)if(n!==this.x||r!==this.y){var i=this.terrain.getSurface(n,r);i.needsMeshUpdate=!0,i.isSupported()||i.collapse()}this.terrain.updateSurfaceMeshes(),this.terrain.floorGroup.updateWorldMatrix(!0,!0)},t.prototype.dropContainedOre=function(t){for(var e=0;e<t&&this.containedOres>0;e++)this.containedOres--,this.terrain.worldMgr.placeMaterial(new $t,this.getRandomPosition()),s.publishEvent(new R)},t.prototype.getRandomPosition=function(){return new D.FM8(this.x*x+20+W()*U(10),this.y*x+20+W()*U(10))},t.prototype.cancelJobs=function(){this.drillJob=t.safeRemoveJob(this.drillJob),this.reinforceJob=t.safeRemoveJob(this.reinforceJob),this.dynamiteJob=t.safeRemoveJob(this.dynamiteJob),this.clearRubbleJob=t.safeRemoveJob(this.clearRubbleJob),this.updateJobColor()},t.safeRemoveJob=function(t){return t&&s.publishEvent(new P(t)),null},t.prototype.reduceRubble=function(){this.rubblePositions.shift(),this.surfaceType===nt.RUBBLE4?this.surfaceType=nt.RUBBLE3:this.surfaceType===nt.RUBBLE3?this.surfaceType=nt.RUBBLE2:this.surfaceType===nt.RUBBLE2?this.surfaceType=nt.RUBBLE1:this.surfaceType===nt.RUBBLE1&&(this.surfaceType=nt.GROUND),this.dropContainedOre(this.containedOres-this.rubblePositions.length),this.updateTexture(),s.publishEvent(new g(this))},t.prototype.isSupported=function(){if(this.surfaceType.floor)return!0;var t=this.terrain.getSurface(this.x-1,this.y),e=this.terrain.getSurface(this.x-1,this.y-1),n=this.terrain.getSurface(this.x,this.y-1),r=this.terrain.getSurface(this.x+1,this.y-1),i=this.terrain.getSurface(this.x+1,this.y),o=this.terrain.getSurface(this.x+1,this.y+1),a=this.terrain.getSurface(this.x,this.y+1),s=this.terrain.getSurface(this.x-1,this.y+1);function u(t,e,n){return!(t.discovered&&e.discovered&&n.discovered&&(t.surfaceType.floor||e.surfaceType.floor||n.surfaceType.floor))}return u(t,e,n)||u(n,r,i)||u(i,o,a)||u(a,s,t)},t.prototype.updateMesh=function(t){if(void 0===t&&(t=!0),t||this.needsMeshUpdate){this.needsMeshUpdate=!1;var e=new D.Pa4(this.x,0,this.y),n=new D.Pa4(this.x+1,0,this.y),r=new D.Pa4(this.x,0,this.y+1),i=new D.Pa4(this.x+1,0,this.y+1),o=this.terrain.getSurface(this.x-1,this.y),a=this.terrain.getSurface(this.x-1,this.y-1),s=this.terrain.getSurface(this.x,this.y-1),u=this.terrain.getSurface(this.x+1,this.y-1),c=this.terrain.getSurface(this.x+1,this.y),l=this.terrain.getSurface(this.x+1,this.y+1),h=this.terrain.getSurface(this.x,this.y+1),p=this.terrain.getSurface(this.x-1,this.y+1);this.discovered?this.surfaceType.floor||(d(o,a,s)&&(e.y=1),d(s,u,c)&&(n.y=1),d(c,l,h)&&(i.y=1),d(h,p,o)&&(r.y=1)):(e.y=1,n.y=1,i.y=1,r.y=1);var f=e.y+n.y+i.y+r.y;f===et.WALL&&e.y===i.y&&(f=et.WEIRD_CREVICE),this.wallType!==f&&(this.wallType=f,this.updateGeometry(e,i,n,r,a,s,o,u,c,l,h,p),this.wallType!==et.WALL&&this.cancelReinforceJobs()),this.updateTexture(),this.updateJobColor(),this.updateGraphWalk()}function d(t,e,n){return!(t.discovered&&e.discovered&&n.discovered&&(t.surfaceType.floor||e.surfaceType.floor||n.surfaceType.floor))}},t.prototype.updateGraphWalk=function(){for(var t=this.getGraphWalkWeight(),e=0;e<3;e++)for(var n=0;n<3;n++)this.terrain.graphWalk.grid[3*this.x+e][3*this.y+n].weight=t},t.prototype.cancelReinforceJobs=function(){this.reinforceJob=t.safeRemoveJob(this.reinforceJob),this.updateJobColor()},t.prototype.updateTexture=function(){var t=this.terrain.textureSet.texturebasename;this.discovered?this.surfaceType===nt.POWER_PATH?t+=this.updatePowerPathTexture():this.surfaceType.shaping?this.wallType===et.WEIRD_CREVICE?t+="77":(this.wallType===et.CORNER?t+="5":this.wallType===et.INVERTED_CORNER?t+="3":this.reinforced?t+="2":t+="0",t+=this.surfaceType.matIndex):this.surfaceType===nt.POWER_PATH_BUILDING&&this.hasPower?t+="66":t+=this.surfaceType.matIndex.toString():t+="70",t+=".bmp";var e=_t.getTexture(t);e.center.set(.5,.5),e.rotation=this.surfaceRotation,this.accessMaterials().forEach((function(t){return t.map=e}))},t.prototype.updatePowerPathTexture=function(){this.surfaceRotation=0;var t=this.terrain.getSurface(this.x-1,this.y).isPath(),e=this.terrain.getSurface(this.x,this.y-1).isPath(),n=this.terrain.getSurface(this.x+1,this.y).isPath(),r=this.terrain.getSurface(this.x,this.y+1).isPath(),i=(t?1:0)+(e?1:0)+(n?1:0)+(r?1:0);return 0===i||1===i?(t&&(this.surfaceRotation=-Math.PI/2),e&&(this.surfaceRotation=Math.PI),n&&(this.surfaceRotation=Math.PI/2),this.hasPower?"75":"65"):2===i?t===n?(this.surfaceRotation=t?Math.PI/2:0,this.hasPower?"72":"62"):(t&&r&&(this.surfaceRotation=-Math.PI/2),t&&e&&(this.surfaceRotation=Math.PI),e&&n&&(this.surfaceRotation=Math.PI/2),this.hasPower?"73":"63"):3===i?(e||(this.surfaceRotation=-Math.PI/2),n||(this.surfaceRotation=Math.PI),r||(this.surfaceRotation=Math.PI/2),this.hasPower?"74":"64"):this.hasPower?"71":"60"},t.prototype.accessMaterials=function(){return this.mesh&&this.mesh.material?Array.isArray(this.mesh.material)?this.mesh.material:[this.mesh.material]:[]},t.prototype.updateGeometry=function(t,e,n,r,i,o,a,s,u,c,l,h){var p,f;function d(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=0,r=0;return t.map((function(t){return t.heightOffset})).filter(Boolean).forEach((function(t){n+=t,r++})),n/r}this.mesh&&this.terrain.floorGroup.remove(this.mesh),null===(f=null===(p=this.mesh)||void 0===p?void 0:p.geometry)||void 0===f||f.dispose(),this.topLeftHeightOffset=d(i,o,this,a)*M,this.topRightHeightOffset=d(o,s,u,this)*M,this.bottomRightHeightOffset=d(this,u,c,l)*M,this.bottomLeftHeightOffset=d(a,this,l,h)*M;var y=it.create(this.wallType,t,e,n,r,t.y+this.topLeftHeightOffset,n.y+this.topRightHeightOffset,e.y+this.bottomRightHeightOffset,r.y+this.bottomLeftHeightOffset);this.mesh=new D.Kj0(y,new D.xoR({shininess:0})),this.mesh.userData={selectable:this,surface:this},this.terrain.floorGroup.add(this.mesh),this.terrain.floorGroup.updateWorldMatrix(!0,!0)},t.prototype.getSelectionType=function(){return Ft.SURFACE},t.prototype.select=function(){return this.surfaceType.selectable&&this.wallType!==et.INVERTED_CORNER&&this.wallType!==et.WEIRD_CREVICE&&!this.selected?(this.selected=!0,this.accessMaterials().forEach((function(t){return t.color.setHex(6316192)})),new p(this)):null},t.prototype.deselect=function(){this.selected&&(this.selected=!1,this.updateJobColor())},t.prototype.getSelectionCenter=function(){return null},t.prototype.updateJobColor=function(){var t,e,n,r=(null===(t=this.dynamiteJob)||void 0===t?void 0:t.color)||(null===(e=this.reinforceJob)||void 0===e?void 0:e.color)||(null===(n=this.drillJob)||void 0===n?void 0:n.color)||16777215;this.accessMaterials().forEach((function(t){return t.color.setHex(r)}))},t.prototype.hasRubble=function(){return this.rubblePositions.length>0},t.prototype.isPath=function(){return this.surfaceType===nt.POWER_PATH||this.surfaceType===nt.POWER_PATH_BUILDING},t.prototype.isWalkable=function(){var t;return this.surfaceType.floor&&this.discovered&&this.surfaceType!==nt.LAVA&&this.surfaceType!==nt.WATER&&!(null===(t=this.building)||void 0===t?void 0:t.blocksPathSurface)},t.prototype.isDrillable=function(){return this.surfaceType.drillable&&this.discovered&&(this.wallType===et.WALL||this.wallType===et.CORNER)},t.prototype.isDrillableHard=function(){return this.surfaceType.drillableHard&&this.discovered&&(this.wallType===et.WALL||this.wallType===et.CORNER)},t.prototype.isReinforcable=function(){return this.surfaceType.reinforcable&&this.discovered&&this.wallType===et.WALL&&!this.reinforced},t.prototype.isExplodable=function(){return this.surfaceType.explodable&&this.discovered&&(this.wallType===et.WALL||this.wallType===et.CORNER)},t.prototype.isDigable=function(){return this.isDrillable()||this.isExplodable()},t.prototype.getDigPositions=function(){var t=[];return this.terrain.getSurface(this.x-1,this.y).isWalkable()&&t.push(new D.FM8(this.x*x-1,this.y*x+20)),this.terrain.getSurface(this.x,this.y-1).isWalkable()&&t.push(new D.FM8(this.x*x+20,this.y*x-1)),this.terrain.getSurface(this.x+1,this.y).isWalkable()&&t.push(new D.FM8(this.x*x+x+1,this.y*x+20)),this.terrain.getSurface(this.x,this.y+1).isWalkable()&&t.push(new D.FM8(this.x*x+20,this.y*x+x+1)),t},t.prototype.reinforce=function(){this.reinforced=!0,this.cancelReinforceJobs(),this.fallinTimeout=H(this.fallinTimeout),this.updateTexture()},t.prototype.getCenterWorld2D=function(){return new D.FM8(this.x*x+20,this.y*x+20)},t.prototype.getCenterWorld=function(){var t=this.getCenterWorld2D();return new D.Pa4(t.x,this.terrain.worldMgr.getTerrainHeight(t.x,t.y),t.y)},t.prototype.setFallinLevel=function(t){var e,n;t<1||(this.surfaceType.floor?(e=this.terrain.findFallInOrigin(this.x,this.y),n=[this.x,this.y]):(e=[this.x,this.y],n=this.terrain.findFallInTarget(this.x,this.y)),e&&n&&this.terrain.getSurface(e[0],e[1]).scheduleFallin(n[0],n[1]))},t.prototype.scheduleFallin=function(t,e){var n=this;this.fallinTimeout=setTimeout((function(){n.createFallin(t,e),n.scheduleFallin(t,e)}),1e3*(30+U(60)))},t.prototype.createFallin=function(t,e){var n=this,r=this.terrain.getSurface(t,e).getCenterWorld();s.publishEvent(new _e(r));var i=_t.getResource("MiscAnims/RockFall/Rock3Sides.lws"),o=new pt("MiscAnims/RockFall/").parse(i);this.fallinGrp=new D.ZAu,this.fallinGrp.position.copy(r);var a=this.x-t,u=e-this.y;this.fallinGrp.rotateOnAxis(new D.Pa4(0,1,0),Math.atan2(u,a)+Math.PI/2),this.terrain.worldMgr.sceneManager.scene.add(this.fallinGrp);var c=[];o.bodies.forEach((function(t){var e=t.model.clone(!0);c.push(e)})),o.bodies.forEach((function(t,e){var r=c[e],i=t.parentObjInd;null!=i?c[i].add(r):n.fallinGrp.add(r)})),this.animate(c,o,0),this.terrain.getSurface(t,e).makeRubble()},t.prototype.animate=function(t,e,n){if(t.length!==e.bodies.length)throw"Cannot animate poly. Length differs from bodies length";if(e.bodies.forEach((function(e,r){var i=t[r];if(i.position.copy(e.relPos[n]),i.rotation.copy(e.relRot[n]),i.scale.copy(e.relScale[n]),i.hasOwnProperty("material")){var o=i.material,a=e.opacity[n];o&&void 0!==a&&(Array.isArray(o)?o:[o]).forEach((function(t){t.opacity=a,t.transparent=t.transparent||t.opacity<1}))}})),this.animationTimeout=null,n+1>e.lastFrame&&!e.looping)this.terrain.worldMgr.sceneManager.scene.remove(this.fallinGrp),this.fallinGrp=null;else{var r=n+1;r>e.lastFrame&&(r=e.firstFrame);var i=this;this.animationTimeout=setTimeout((function(){return i.animate(t,e,r)}),1e3/e.framesPerSecond*e.transcoef)}},t.prototype.dispose=function(){var t,e;this.fallinTimeout=H(this.fallinTimeout),this.accessMaterials().forEach((function(t){return t.dispose()})),null===(e=null===(t=this.mesh)||void 0===t?void 0:t.geometry)||void 0===e||e.dispose()},t.prototype.getFloorHeight=function(e,n){var r=e/x-this.x,i=n/x-this.y,o=t.interpolate(this.topLeftHeightOffset,this.topRightHeightOffset,r),a=t.interpolate(this.bottomLeftHeightOffset,this.bottomRightHeightOffset,r);return t.interpolate(o,a,i)*x},t.interpolate=function(t,e,n){return t+n*(e-t)},Object.defineProperty(t.prototype,"neighbors",{get:function(){return[this.terrain.getSurface(this.x-1,this.y),this.terrain.getSurface(this.x,this.y-1),this.terrain.getSurface(this.x+1,this.y),this.terrain.getSurface(this.x,this.y+1)]},enumerable:!1,configurable:!0}),t.prototype.makeRubble=function(t){void 0===t&&(t=0),this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=t,this.surfaceType=nt.RUBBLE4,this.updateTexture()},t.prototype.setBuilding=function(t){this.building=t,this.updateGraphWalk()},t.prototype.getGraphWalkWeight=function(){return this.isWalkable()?this.hasRubble()?4:1:0},t.prototype.setHasPower=function(t,e){this.hasPower!==t&&(this.hasPower=t,this.updateTexture(),e&&this.neighbors.forEach((function(n){return n.isPath()&&n.setHasPower(t,e)})))},t.prototype.canPlaceFence=function(){var t=this;return(this.surfaceType===nt.GROUND||this.isPath())&&!this.building&&!this.fence&&[1,2].some((function(e){return!!(t.terrain.getSurface(t.x-e,t.y).building||t.terrain.getSurface(t.x,t.y-e).building||t.terrain.getSurface(t.x+e,t.y).building||t.terrain.getSurface(t.x,t.y+e).building||t.terrain.getSurface(t.x-e,t.y).fence||t.terrain.getSurface(t.x,t.y-e).fence||t.terrain.getSurface(t.x+e,t.y).fence||t.terrain.getSurface(t.x,t.y+e).fence)}))},t.prototype.createDrillJob=function(){return this.drillJob||(this.drillJob=new Cn(this),this.updateJobColor(),s.publishEvent(new E(this.drillJob))),this.drillJob},t.prototype.createReinforceJob=function(){return this.reinforceJob||(this.reinforceJob=new Ln(this),this.updateJobColor(),s.publishEvent(new E(this.reinforceJob))),this.reinforceJob},t.prototype.createDynamiteJob=function(){if(!this.dynamiteJob){var t=ie.getClosestBuildingByType(this.getCenterWorld(),Pt.TOOLSTATION);if(!t)throw"Could not find toolstation to spawn dynamite";var e=new Pn(this);e.worldMgr=this.terrain.worldMgr,e.group.position.copy(t.getDropPosition()),e.worldMgr.sceneManager.scene.add(e.group),this.dynamiteJob=new On(e),this.updateJobColor(),s.publishEvent(new E(this.dynamiteJob))}return this.dynamiteJob},t.prototype.createClearRubbleJob=function(){return this.clearRubbleJob||(this.clearRubbleJob=new Sn(this),this.updateJobColor(),s.publishEvent(new E(this.clearRubbleJob))),this.clearRubbleJob},t}(),Mn=function(){function t(t){this.textureSet={},this.width=0,this.height=0,this.surfaces=[],this.floorGroup=new D.ZAu,this.roofGroup=new D.ZAu,this.graphWalk=null,this.cachedPaths=new Map,this.worldMgr=t,this.floorGroup.scale.set(x,x,x),this.roofGroup.visible=!1,s.registerEventListener(r.ENTITY_ADDED,(function(t){t.superType===Tt.BUILDING&&t.entity.surfaces.forEach((function(t){return t.neighbors.forEach((function(t){return t.updateTexture()}))}))}))}return t.prototype.getSurfaceFromWorld=function(t){return this.getSurfaceFromWorldXZ(t.x,t.z)},t.prototype.getSurfaceFromWorld2D=function(t){return this.getSurfaceFromWorldXZ(t.x,t.y)},t.prototype.getSurfaceFromWorldXZ=function(t,e){return this.getSurface(t/x,e/x)},t.prototype.getSurface=function(t,e){return t=Math.floor(t),e=Math.floor(e),this.getSurfaceOrNull(t,e)||new An(this,nt.SOLID_ROCK,t,e,0)},t.prototype.getSurfaceOrNull=function(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height?this.surfaces[t][e]:null},t.prototype.updateSurfaceMeshes=function(t){void 0===t&&(t=!1),this.forEachSurface((function(e){return e.updateMesh(t)})),this.floorGroup.updateWorldMatrix(!0,!0),this.resetGraphWalk()},t.prototype.resetGraphWalk=function(){this.graphWalk.init(),this.cachedPaths.clear(),console.log("Cached paths cleared")},t.prototype.findPath=function(t,e){var n=e.targetLocation,r=Math.floor(3*t.x/x),i=Math.floor(3*t.y/x),o=Math.floor(3*n.x/x),a=Math.floor(3*n.y/x);if(r===o&&i===a)return new Pe(e,n);var s=r+"/"+i+" -> "+o+"/"+a,u=this.cachedPaths.get(s);return u?u.addLocation(n):this.searchPath(r,i,o,a,e,s)},t.prototype.searchPath=function(t,e,n,r,i,o){var a=this,s=this.graphWalk.grid[t][e],u=this.graphWalk.grid[n][r],c=yn.search(this.graphWalk,s,u).map((function(t){return a.gridNodeToWorldPos(t)}));return c.length<1?null:(c.pop(),c.push(i.targetLocation),this.cachedPaths.set(o,new Pe(i,c.slice(0,-1))),new Pe(i,c))},t.prototype.gridNodeToWorldPos=function(t){return new D.FM8((t.x+.25+Math.random()/2)*x/3,(t.y+.25+Math.random()/2)*x/3)},t.prototype.findFallInOrigin=function(t,e){var n=this.getSurface(t-1,e);if(n.isReinforcable())return[n.x,n.y];var r=this.getSurface(t,e-1);if(r.isReinforcable())return[r.x,r.y];var i=this.getSurface(t+1,e);if(i.isReinforcable())return[i.x,i.y];var o=this.getSurface(t,e+1);if(o.isReinforcable())return[o.x,o.y];var a=this.getSurface(t-1,e);if(a.isDigable())return[a.x,a.y];var s=this.getSurface(t,e-1);if(s.isDigable())return[s.x,s.y];var u=this.getSurface(t+1,e);if(u.isDigable())return[u.x,u.y];var c=this.getSurface(t,e+1);return c.isDigable()?[c.x,c.y]:null},t.prototype.findFallInTarget=function(t,e){var n=this.getSurface(t-1,e);if(n.isWalkable())return[n.x,n.y];var r=this.getSurface(t,e-1);if(r.isWalkable())return[r.x,r.y];var i=this.getSurface(t+1,e);if(i.isWalkable())return[i.x,i.y];var o=this.getSurface(t,e+1);return o.isWalkable()?[o.x,o.y]:null},t.prototype.dispose=function(){this.forEachSurface((function(t){return t.dispose()}))},t.prototype.forEachSurface=function(t){var e;null===(e=this.surfaces)||void 0===e||e.forEach((function(e){return e.forEach((function(e){return t(e)}))}))},t}(),xn=function(){function t(){}return t.loadTerrain=function(t,e){var n,r,i,o,a,s,u=t.blockSize;u!==x&&console.error("Unexpected tile size in level configuration: "+u);var c=new Mn(e),l=t.textureSet[1];c.textureSet=_t.cfg("Textures",l);var h=_t.getResource(t.terrainMap);c.width=h.width,c.height=h.height;for(var p=null===(n=_t.getResource(t.pathMap))||void 0===n?void 0:n.level,f=null===(r=_t.getResource(t.surfaceMap))||void 0===r?void 0:r.level,d=null===(i=_t.getResource(t.predugMap))||void 0===i?void 0:i.level,y=null===(o=_t.getResource(t.cryOreMap))||void 0===o?void 0:o.level,g=null===(a=_t.getResource(t.fallinMap))||void 0===a?void 0:a.level,v=null===(s=_t.getResource(t.erodeMap))||void 0===s?void 0:s.level,m=0;m<h.level.length;m++)for(var w=0;w<h.level[m].length;w++){c.surfaces[w]=c.surfaces[w]||[];var b=h.level[m][w],_=nt.getByNum(b),O=d[m][w];O===dn.CAVERN_EXPOSED?_===nt.GROUND||_===nt.DIRT?_=nt.GROUND:_!==nt.WATER&&_!==nt.LAVA&&console.warn("Unexpected cavern surface type: "+_.name):O===dn.SLUG_HOLE_EXPOSED||O===dn.SLUG_HOLE_HIDDEN?_=nt.SLUG_HOLE:O!==dn.WALL&&O!==dn.CAVERN_HIDDEN&&console.warn("Unexpected predug level: "+O);var E=p&&_.floor?p[m][w]:fn.NONE;E===fn.RUBBLE?_=nt.RUBBLE4:E===fn.POWER_PATH?_=nt.POWER_PATH:E!==fn.NONE&&console.warn("Unexpected path map level: "+E);var P=new An(c,_,w,m,f[m][w]);if(y){var T=y[m][w];T%2==1?P.containedCrystals=(T+1)/2:P.containedOres=T/2}c.surfaces[w].push(P)}c.forEachSurface((function(t){if(d[t.y][t.x]===dn.CAVERN_EXPOSED||d[t.y][t.x]===dn.SLUG_HOLE_EXPOSED)for(var e=t.x-1;e<=t.x+1;e++)for(var n=t.y-1;n<=t.y+1;n++)c.getSurfaceOrNull(e,n).discovered=!0})),c.forEachSurface((function(t){var e=c.getSurfaceOrNull(t.x,t.y);d[t.y][t.x]!==dn.CAVERN_HIDDEN||e.discovered||(e.surfaceType=nt.GROUND)}));for(var S=[],I=0;I<c.width;I++){for(var C=[],R=0;R<c.height;R++){var L=c.getSurfaceOrNull(I,R).getGraphWalkWeight();C.push(L,L,L)}S.push(C,C,C)}if(c.graphWalk=new gn(S),c.forEachSurface((function(t){t.isSupported()||t.collapse()})),c.updateSurfaceMeshes(!0),g)for(I=0;I<c.width;I++)for(R=0;R<c.height;R++)c.getSurface(I,R).setFallinLevel(g[R][I]);return v&&console.warn("Lucky you! Lava erosion not yet implemented"),c},t}();!function(t){t[t.NONE=0]="NONE",t[t.RUBBLE=1]="RUBBLE",t[t.POWER_PATH=2]="POWER_PATH"}(fn||(fn={})),function(t){t[t.WALL=0]="WALL",t[t.CAVERN_EXPOSED=1]="CAVERN_EXPOSED",t[t.CAVERN_HIDDEN=2]="CAVERN_HIDDEN",t[t.SLUG_HOLE_EXPOSED=3]="SLUG_HOLE_EXPOSED",t[t.SLUG_HOLE_HIDDEN=4]="SLUG_HOLE_HIDDEN"}(dn||(dn={}));var Dn,kn,Nn,Bn=D.M8C.degToRad,jn=function(){function t(t){var e=this;this.sceneManager=null,this.spawnRaiderInterval=null,this.nerpRunner=null,this.oxygenUpdateInterval=null,this.sceneManager=new ut(t),s.registerEventListener(r.DESELECTED_ENTITY,(function(){return ie.selectEntities([])})),s.registerEventListener(r.RAIDER_REQUESTED,(function(){ie.requestedRaiders>0&&!e.spawnRaiderInterval&&(e.spawnRaiderInterval=setInterval(e.checkSpawnRaiders.bind(e),1e3))})),s.registerEventListener(r.CAVERN_DISCOVERED,(function(){ie.discoveredCaverns++})),this.oxygenUpdateInterval=setInterval(this.updateOxygen.bind(this),5e3)}return t.prototype.setup=function(t,e){var n,r,i;ie.levelFullName=t.fullName,ie.totalCaverns=(null===(i=null===(r=t.reward)||void 0===r?void 0:r.quota)||void 0===i?void 0:i.caverns)||0,ie.rewardConfig=t.reward,ie.priorityList.setList(t.priorities),ie.oxygenRate=t.oxygenRate;var o=_t.cfg("Main","AmbientRGB")||[10,10,10],a=Math.min(255,Math.max.apply(Math,function(t,e){for(var n=0,r=e.length,i=t.length;n<r;n++,i++)t[i]=e[n];return t}([0],o))),s=o.map((function(t){return t/(a||1)})),u=new D.Ilk(s[0],s[1],s[2]);this.sceneManager.setupScene(u),this.sceneManager.terrain=xn.loadTerrain(t,this),this.sceneManager.scene.add(this.sceneManager.terrain.floorGroup);var c=_t.getResource(t.oListFile);hn.loadObjectList(this,c,t.disableStartTeleport),this.nerpRunner=ye.parse(_t.getResource(t.nerpFile)),(n=this.nerpRunner.messages).push.apply(n,_t.getResource(t.nerpMessageFile)),this.nerpRunner.onLevelComplete=function(){return e.onLevelEnd()},ie.totalDiggables=0,this.sceneManager.terrain.forEachSurface((function(t){return ie.totalDiggables+=t.isDigable()?1:0})),ie.totalCrystals=0,this.sceneManager.terrain.forEachSurface((function(t){return ie.totalCrystals+=t.containedCrystals})),ie.totalOres=0,this.sceneManager.terrain.forEachSurface((function(t){return ie.totalOres+=t.containedOres}))},t.prototype.start=function(){var t;this.sceneManager.startScene(),null===(t=this.nerpRunner)||void 0===t||t.startExecution(),ie.levelStartTime=Date.now()},t.prototype.stop=function(){var t,e,n;ie.levelStopTime=Date.now(),null===(t=this.nerpRunner)||void 0===t||t.pauseExecution(),this.spawnRaiderInterval=G(this.spawnRaiderInterval),ie.spiders.forEach((function(t){return t.onLevelEnd()})),ie.bats.forEach((function(t){return t.onLevelEnd()})),ie.remainingDiggables=0,null===(n=null===(e=this.sceneManager)||void 0===e?void 0:e.terrain)||void 0===n||n.forEachSurface((function(t){return ie.remainingDiggables+=t.isDigable()?1:0})),this.sceneManager.disposeScene()},t.prototype.resize=function(t,e){this.sceneManager&&this.sceneManager.renderer.setSize(t,e)},t.prototype.getTerrainIntersectionPoint=function(t,e){if(!this.sceneManager.terrain)return null;var n=new D.iMs;n.setFromCamera({x:t,y:e},this.sceneManager.camera);var r=n.intersectObjects(this.sceneManager.terrain.floorGroup.children);return r.length>0?r[0].point:null},t.prototype.setTorchPosition=function(t){this.sceneManager.cursorTorchlight.position.x=t.x,this.sceneManager.cursorTorchlight.position.y=this.sceneManager.terrain.getSurfaceFromWorldXZ(t.x,t.y).getFloorHeight(t.x,t.y)+80,this.sceneManager.cursorTorchlight.position.z=t.y},t.prototype.getFloorPosition=function(t){var e=this.sceneManager.terrain.getSurfaceFromWorldXZ(t.x,t.y).getFloorHeight(t.x,t.y);return new D.Pa4(t.x,e,t.y)},t.prototype.getTerrainHeight=function(t,e){var n=new D.iMs(new D.Pa4(Number(t),120,Number(e)),new D.Pa4(0,-1,0)).intersectObject(this.sceneManager.terrain.floorGroup,!0);return n.length>0?n[0].point.y:(console.warn("could not determine terrain height for "+t+"/"+e),0)},t.prototype.placeMaterial=function(t,e){return t.worldMgr=this,t.group.position.copy(this.getFloorPosition(e)),t.group.visible=this.sceneManager.terrain.getSurfaceFromWorld(t.group.position).discovered,this.sceneManager.scene.add(t.group),t.group.visible?(ie.materials.push(t),s.publishEvent(new E(t.createCarryJob()))):ie.materialsUndiscovered.push(t),t},t.prototype.checkSpawnRaiders=function(){if(ie.requestedRaiders<1)this.spawnRaiderInterval=G(this.spawnRaiderInterval);else if(!(ie.raiders.length>=ie.getMaxRaiders()))for(var t=ie.getBuildingsByType(Pt.TOOLSTATION,Pt.TELEPORT_PAD),e=function(e){var r=t[e];if(r.spawning)return"continue";ie.requestedRaiders--,s.publishEvent(new T),r.spawning=!0;var i=new Me;i.worldMgr=n,i.changeActivity(ce.TeleportIn,(function(){r.spawning=!1,i.changeActivity(),i.createPickSphere();var t=r.getPosition2D().add(new D.FM8(0,30+U(20)).rotateAround(new D.FM8(0,0),r.getHeading()+Bn(-10+U(20))));i.setJob(new ve(t)),ie.raiders.push(i),s.publishEvent(new I(i))})),i.group.position.copy(r.group.position).add(new D.Pa4(0,0,20).applyEuler(r.group.rotation)),i.group.rotation.copy(r.group.rotation),n.sceneManager.scene.add(i.group)},n=this,r=0;r<t.length&&ie.requestedRaiders>0;r++)e(r)},t.prototype.updateOxygen=function(){var t=(ie.raiders.map((function(t){return t.stats.OxygenCoef})).reduce((function(t,e){return t+e}),0)+ie.buildings.map((function(t){return t.isPowered()?t.stats.OxygenCoef:0})).reduce((function(t,e){return t+e}),0))*ie.oxygenRate*.001*.04*5e3*.001/10;t&&(ie.airLevel=Math.min(1,Math.max(0,ie.airLevel+t)),s.publishEvent(new v))},t}(),Fn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Un=function(){function t(t,e){void 0===t&&(t=!1),void 0===e&&(e=!0),this.active=!0,this.canvas=document.createElement("canvas"),t||(this.canvas.style.background="#f0f"),e&&(this.context=this.canvas.getContext("2d",{alpha:t})),this.hide()}return t.prototype.reset=function(){},t.prototype.setZIndex=function(t){this.canvas.style.zIndex=String(t)},t.compareZ=function(t,e){var n,r,i,o,a=(null===(r=null===(n=null==t?void 0:t.canvas)||void 0===n?void 0:n.style)||void 0===r?void 0:r.zIndex)||0,s=(null===(o=null===(i=null==e?void 0:e.canvas)||void 0===i?void 0:i.style)||void 0===o?void 0:o.zIndex)||0;return a===s?0:a>s?-1:1},t.prototype.resize=function(t,e){this.canvas.width=t,this.canvas.height=e},t.prototype.redraw=function(){var t=this.onRedraw;if(this.isActive()&&t){var e=this.context;requestAnimationFrame((function(){return t(e)}))}},t.prototype.show=function(){this.reset(),this.active=!0,this.canvas.style.visibility="visible",this.redraw()},t.prototype.hide=function(){this.active=!1,this.canvas.style.visibility="hidden"},t.prototype.isActive=function(){return this.active},t.prototype.toCanvasCoords=function(t,e){var n=this.canvas.getBoundingClientRect();return[t-n.left,e-n.top]},t.prototype.handlePointerEvent=function(t){return!1},t.prototype.handleKeyEvent=function(t){return!1},t.prototype.handleWheelEvent=function(t){return!1},t}(),Wn=function(t){function e(){var e=t.call(this,!0)||this;return e.fixedWidth=640,e.fixedHeight=480,e.updateScale(),e}return Fn(e,t),e.prototype.updateScale=function(){this.scaleX=this.canvas.width/this.fixedWidth,this.scaleY=this.canvas.height/this.fixedHeight},e.prototype.toScaledCoords=function(t,e){var n=this.toCanvasCoords(t,e),r=n[0],i=n[1];return[r/this.scaleX,i/this.scaleY].map((function(t){return Math.round(t)}))},e.prototype.resize=function(e,n){t.prototype.resize.call(this,e,n),this.updateScale(),this.context.scale(this.scaleX,this.scaleY)},e}(Un);!function(t){t[t.MAIN=0]="MAIN",t[t.MIDDLE=1]="MIDDLE",t[t.SECONDARY=2]="SECONDARY"}(Dn||(Dn={})),function(t){t[t.MOVE=0]="MOVE",t[t.DOWN=1]="DOWN",t[t.UP=2]="UP"}(kn||(kn={})),function(t){t[t.DOWN=0]="DOWN",t[t.UP=1]="UP"}(Nn||(Nn={}));var Hn=function(t,e){this.eventEnum=t,this.type=e.type,this.bubbles=!1,this.key=e.key},Gn=function(t,e){this.eventEnum=t,this.type=e.type,this.bubbles=!1,this.clientX=e.clientX,this.clientY=e.clientY,this.pointerType=e.pointerType,this.button=e.button,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey},Jn=function(t){this.type=t.type,this.bubbles=!1,this.clientX=t.clientX,this.clientY=t.clientY,this.deltaX=t.deltaX,this.deltaY=t.deltaY,this.deltaZ=t.deltaZ,this.button=t.button,this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.shiftKey=t.shiftKey},Vn=function(t){t.gameCanvasContainer.addEventListener("contextmenu",(function(e){t.isInRect(e)&&e.preventDefault()})),new Map([["pointermove",kn.MOVE],["pointerdown",kn.DOWN],["pointerup",kn.UP]]).forEach((function(e,n){t.gameCanvasContainer.addEventListener(n,(function(n){if(t.isInRect(n)){n.preventDefault();var r=new Gn(e,n);t.layers.filter((function(t){return t.isActive()})).sort((function(t,e){return Un.compareZ(t,e)})).some((function(t){return t.handlePointerEvent(r)}))}}))})),new Map([["keydown",Nn.DOWN],["keyup",Nn.UP]]).forEach((function(e,n){t.gameCanvasContainer.addEventListener(n,(function(n){n.preventDefault();var r=new Hn(e,n);t.layers.filter((function(t){return t.isActive()})).sort((function(t,e){return Un.compareZ(t,e)})).some((function(t){return t.handleKeyEvent(r)}))}))})),t.gameCanvasContainer.addEventListener("wheel",(function(e){if(t.isInRect(e)){var n=new Jn(e);t.layers.filter((function(t){return t.isActive()})).sort((function(t,e){return Un.compareZ(t,e)})).some((function(t){return t.handleWheelEvent(n)}))}}))},Yn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Xn=function(t){function e(){var e=t.call(this,!0,!1)||this;return s.registerEventListener(r.CHANGE_CURSOR,(function(t){e.changeCursor(t.cursor)})),e}return Yn(e,t),e.prototype.show=function(){t.prototype.show.call(this),this.pointersCfg=_t.cfg("Pointers"),this.changeCursor(q.Pointer_Standard)},e.prototype.hide=function(){t.prototype.hide.call(this),this.canvas.style.cursor=null},e.prototype.changeCursor=function(t){if(this.curUrl&&URL.revokeObjectURL(this.curUrl),this.pointersCfg){var e=N(this.pointersCfg,q[t]),n=_t.getImage(e);this.curUrl=n.toDataURL(),this.canvas.style.cursor="url("+this.curUrl+"), auto"}},e}(Un),Kn=function(){function t(){var t=this;if(this.layers=[],this.width=640,this.height=480,this.ratio=640/480,this.gameCanvasContainer=document.getElementById("game-canvas-container"),this.gameCanvasContainer.focus(),this.eventMgr=new Vn(this),!this.gameCanvasContainer)throw"Fatal error: game canvas container not found!";window.addEventListener("resize",(function(){return t.onWindowResize()})),this.onWindowResize(),this.cursorLayer=this.addLayer(new Xn,1e3)}return t.prototype.addLayer=function(t,e){return void 0===e&&(e=0),t.resize(this.width,this.height),t.setZIndex(e),this.layers.push(t),this.gameCanvasContainer.appendChild(t.canvas),t},t.prototype.redraw=function(){this.layers.forEach((function(t){return t.redraw()}))},t.prototype.show=function(){this.layers.forEach((function(t){return t.show()})),this.redraw()},t.prototype.hide=function(){this.layers.forEach((function(t){return t.hide()}))},t.prototype.onWindowResize=function(){var t=this.gameCanvasContainer.offsetWidth,e=this.gameCanvasContainer.offsetHeight,n=Math.round(t/this.ratio);n>e?this.resize(Math.round(e*this.ratio),e):this.resize(t,n)},t.prototype.resize=function(t,e){this.width=t,this.height=e,this.layers.forEach((function(n){return n.resize(t,e)})),this.redraw()},t.prototype.isInRect=function(t){if(this.layers.length<1)return!1;var e=this.layers[0];if(!e.isActive()||!e.canvas)return!1;var n=e.canvas.getBoundingClientRect(),r=t.clientX,i=t.clientY;return r>=n.left&&r<n.right&&i>=n.top&&i<n.bottom},t}(),qn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),zn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return qn(e,t),e.Short=new At("Short"),e.Expand=new At("Expand"),e.Long=new At("Long"),e.Teleport=new At("Teleport"),e}(At),Zn=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Qn=function(t){function e(e,n){var r=t.call(this,kt.COMPLETE_POWER_PATH)||this;return r.surface=e,r.placedItems=n,r.workplaces=[new Vt(e.getRandomPosition())],r}return Zn(e,t),e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this),this.placedItems.forEach((function(t){return t.removeFromScene()})),this.surface.surfaceType=nt.POWER_PATH,this.surface.updateTexture(),this.surface.neighbors.forEach((function(t){return t.updateTexture()}))},e.prototype.getRequiredTool=function(){return Re.SHOVEL},e.prototype.getPriorityIdentifier=function(){return St.aiPriorityConstruction},e.prototype.getWorkplaces=function(){return this.workplaces},e.prototype.getWorkActivity=function(){return ce.Clear},e}(jt),$n=function(){function t(t,e,n){void 0===e&&(e=null),void 0===n&&(n=null),this.primarySurface=null,this.secondarySurface=null,this.heading=0,this.neededByType=new Map,this.assignedByType=new Map,this.onSiteByType=new Map,this.complete=!1,this.primarySurface=t,this.secondarySurface=e,this.building=n}return t.prototype.getRandomDropPosition=function(){return this.primarySurface.getRandomPosition()},t.prototype.needs=function(t){return this.neededByType.getOrUpdate(t,(function(){return 0}))>this.assignedByType.getOrUpdate(t,(function(){return[]})).length},t.prototype.assign=function(t){this.assignedByType.getOrUpdate(t.entityType,(function(){return[]})).push(t)},t.prototype.unAssign=function(t){this.assignedByType.getOrUpdate(t.entityType,(function(){return[]})).remove(t)},t.prototype.addItem=function(t){var e=this.neededByType.getOrUpdate(t.entityType,(function(){return 0}));this.onSiteByType.getOrUpdate(t.entityType,(function(){return[]})).length<e?(t.onAddToSite(),this.onSiteByType.getOrUpdate(t.entityType,(function(){return[]})).push(t),this.checkComplete()):t.resetTarget()},t.prototype.checkComplete=function(){var t=this;if(!this.complete&&(this.complete=!0,this.neededByType.forEach((function(e,n){t.complete=t.complete&&t.onSiteByType.getOrUpdate(n,(function(){return[]})).length>=e})),this.complete))if(ie.buildingSites.remove(this),this.building){this.onSiteByType.getOrUpdate(Pt.BARRIER,(function(){return[]})).forEach((function(t){t.changeActivity(zn.Teleport,(function(){return t.removeFromScene()}))})),this.onSiteByType.getOrUpdate(Pt.CRYSTAL,(function(){return[]})).forEach((function(t){t.removeFromScene()})),this.onSiteByType.getOrUpdate(Pt.ORE,(function(){return[]})).forEach((function(t){t.removeFromScene()}));var e=this.primarySurface.getCenterWorld2D();this.building.addToScene(this.primarySurface.terrain.worldMgr,e.x,e.y,-this.heading+Math.PI/2,!1)}else{var n=[];this.onSiteByType.forEach((function(t){return n.push.apply(n,t)})),s.publishEvent(new E(new Qn(this.primarySurface,n)))}},t.prototype.getDropAction=function(){return ce.Place},t}(),tr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),er=function(t){function e(e,n){var r=t.call(this,Pt.BARRIER,"MiscAnims/Barrier/Barrier.ae")||this;return r.heading=e.heading,r.priorityIdentifier=St.aiPriorityConstruction,r.changeActivity(),r.targets=[new Xt(e.location,n,null)],r}return tr(e,t),e.prototype.updateTargets=function(){return this.targets},e.prototype.getDefaultActivity=function(){return zn.Short},e.prototype.onAddToSite=function(){var e=this;t.prototype.onAddToSite.call(this),this.group.rotation.y=this.heading,this.changeActivity(zn.Expand,(function(){return e.changeActivity(zn.Long)}))},e}(qt),nr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),rr=function(t){function e(){var e=t.call(this,!1,!1)||this;return e.rightDown={x:0,y:0},e.lastCursor=q.Pointer_Standard,e}return nr(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.rightDown={x:0,y:0},this.lastCursor=q.Pointer_Standard},e.prototype.hide=function(){t.prototype.hide.call(this),s.publishEvent(new w(q.Pointer_Standard))},e.prototype.setWorldManager=function(t){this.worldMgr=t},e.prototype.handlePointerEvent=function(t){var e=this.worldMgr.sceneManager.buildMarker;if(t.eventEnum===kn.MOVE){var n=this.getTerrainPositionFromEvent(t);n&&this.worldMgr.setTorchPosition(n),e.update(this.worldMgr.sceneManager.terrain,n),this.updateCursor(t)}else if(t.eventEnum===kn.UP){if(t.button===Dn.MAIN){if(ie.buildModeSelection&&e.lastCheck){e.visibleSurfaces.forEach((function(t){t.surfaceType=nt.POWER_PATH_BUILDING,t.updateTexture(),t.neighbors.forEach((function(t){return t.updateTexture()}))}));var r=e.getBarrierLocations(),i=ie.buildModeSelection.stats,o=(null==i?void 0:i.CostCrystal)||0,a=(null==i?void 0:i.CostOre)||0,u=new $n(e.primarySurface,e.secondarySurface,ie.buildModeSelection);u.heading=e.heading,u.neededByType.set(Pt.BARRIER,r.length),u.neededByType.set(Pt.CRYSTAL,o),u.neededByType.set(Pt.ORE,a),ie.buildingSites.push(u);var c=ie.getClosestBuildingByType(e.primarySurface.getCenterWorld(),Pt.TOOLSTATION);c&&(c.spawnMaterials(r.map((function(t){return new er(t,u)}))),c.spawnMaterials(ie.dropMaterial(Pt.CRYSTAL,o)),c.spawnMaterials(ie.dropMaterial(Pt.ORE,a))),s.publishEvent(new y),s.publishEvent(new m)}}else if(t.button===Dn.SECONDARY)if(Math.abs(t.clientX-this.rightDown.x)+Math.abs(t.clientY-this.rightDown.y)<3&&(ie.selectionType===Ft.RAIDER||ie.selectionType===Ft.GROUP)){var l=this.getTerrainPositionFromEvent(t);if(l){var h=this.worldMgr.sceneManager.terrain.getSurfaceFromWorldXZ(l.x,l.y);h&&(h.isDrillable()?this.assignSurfaceJob(h.createDrillJob(),h,l):h.hasRubble()?this.assignSurfaceJob(h.createClearRubbleJob(),h,l):h.isWalkable()&&(ie.selectedEntities.forEach((function(t){return t.setJob(new ve(l))})),ie.selectedEntities.length>0&&s.publishEvent(new y)))}}else ie.buildModeSelection=null,e.hideAllMarker()}else t.eventEnum===kn.DOWN&&t.button===Dn.SECONDARY&&(this.rightDown.x=t.clientX,this.rightDown.y=t.clientY);return this.canvas.dispatchEvent(new PointerEvent(t.type,t)),!0},e.prototype.updateCursor=function(t){var e=this.toCanvasCoords(t.clientX,t.clientY),n=e[0],r=e[1],i=n/this.canvas.width*2-1,o=-r/this.canvas.height*2+1,a=new D.iMs;a.setFromCamera({x:i,y:o},this.worldMgr.sceneManager.camera);var u=this.determineCursor(a);u!==this.lastCursor&&(this.lastCursor=u,s.publishEvent(new w(u)))},e.prototype.determineCursor=function(t){if(t.intersectObjects(ie.raiders.map((function(t){return t.pickSphere}))).length>0)return q.Pointer_Selected;var e=t.intersectObjects(ie.buildings.map((function(t){return t.pickSphere})));if(e.length>0)return q.Pointer_Selected;if((e=t.intersectObjects(this.worldMgr.sceneManager.terrain.floorGroup.children)).length>0){var n=e[0].object.userData;if(n&&n.hasOwnProperty("surface")){var r=n.surface;if(r)return r.surfaceType.cursor}}return q.Pointer_Standard},e.prototype.handleKeyEvent=function(t){return!1},e.prototype.assignSurfaceJob=function(t,e,n){t&&(ie.selectedEntities.forEach((function(r){r.hasTool(t.getRequiredTool())&&r.hasTraining(t.getRequiredTraining())?r.setJob(t):e.isWalkable()&&r.setJob(new ve(n))})),ie.selectedEntities.length>0&&s.publishEvent(new y))},e.prototype.getTerrainPositionFromEvent=function(t){var e=this.toCanvasCoords(t.clientX,t.clientY),n=e[0],r=e[1],i=n/this.canvas.width*2-1,o=-r/this.canvas.height*2+1,a=this.worldMgr.getTerrainIntersectionPoint(i,o);return a?new D.FM8(a.x,a.z):null},e.prototype.handleWheelEvent=function(t){return this.canvas.dispatchEvent(new WheelEvent(t.type,t)),!0},e}(Un),ir=function(){function t(){}return t.setFromCfg=function(t,e){return Object.keys(e).forEach((function(n){var r=(n.startsWith("!")?n.substring(1):n).toLowerCase().replace(/_/g,"").replace(/-/g,"");Object.keys(t).some((function(i){return t.assignValue(i,r,e[n])}))||console.warn("cfg key does not exist: "+n)})),t},t.prototype.assignValue=function(t,e,n){if(t.toLowerCase()===e){var r=this[t],i=Array.isArray(r),o=this.parseValue(e,n),a=Array.isArray(o);return r&&i!==a&&i&&(o=[o]),this[t]=o,!0}},t.prototype.parseValue=function(t,e){return e},t}(),or=function(){this.buttonType=null,this.normalFile=null,this.highlightFile=null,this.pressedFile=null,this.disabledFile=null,this.relX=0,this.relY=0,this.width=0,this.height=0,this.tooltip=null},ar=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),sr=function(t){function e(e){var n=t.call(this)||this;if(9!==e.length)throw"Invalid number of arguments ("+e.length+") given for button configuration expected 9 or 5";return n.buttonType=e[0],n.normalFile=e[1],n.highlightFile=e[2],n.pressedFile=e[3],n.relX=e[4],n.relY=e[5],n.width=e[6],n.height=e[7],n.tooltip=e[8],n}return ar(e,t),e}(or),ur=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),cr=function(t){function e(e){var n=t.call(this)||this;return n.panelButtonInfoDockGoto=null,n.panelButtonInfoDockClose=null,ir.setFromCfg(n,e),n}return ur(e,t),e.prototype.parseValue=function(t,e){return new sr(e)},e}(ir),lr=function(){function t(t){void 0===t&&(t=null),this.parent=null,this.x=0,this.y=0,this.relX=0,this.relY=0,this.width=0,this.height=0,this.children=[],this.hidden=!1,this.disabled=!1,this.hover=!1,this.pressed=!1,this.parent=t}return t.prototype.reset=function(){this.hidden=!1,this.disabled=!1,this.hover=!1,this.pressed=!1,this.children.forEach((function(t){return t.reset()}))},t.prototype.addChild=function(t){return t.parent=this,this.children.push(t),t.updatePosition(),t},t.prototype.onRedraw=function(t){this.hidden||(this.children.forEach((function(e){return e.onRedraw(t)})),this.children.forEach((function(e){return e.drawHover(t)})),this.children.forEach((function(e){return e.drawTooltip(t)})))},t.prototype.drawHover=function(t){},t.prototype.drawTooltip=function(t){},t.prototype.onClick=function(){},t.prototype.isInactive=function(){for(var t=this.parent;t;t=t.parent)if(t.isInactive())return!0;return this.hidden||this.disabled},t.prototype.hide=function(){this.hidden=!0,this.children.forEach((function(t){return t.hide()}))},t.prototype.show=function(){this.hidden=!1,this.children.forEach((function(t){return t.show()}))},t.prototype.updatePosition=function(){this.x=this.parent?this.parent.x+this.relX:this.relX,this.y=this.parent?this.parent.y+this.relY:this.relY,this.children.forEach((function(t){return t.updatePosition()}))},t.prototype.isInRect=function(t,e){return t>=this.x&&e>=this.y&&t<this.x+this.width&&e<this.y+this.height},t.prototype.checkHover=function(t,e){if(this.isInactive())return!1;var n=this.isInRect(t,e),r=this.hover!==n;return this.hover=n,this.pressed=this.pressed&&this.hover,this.children.forEach((function(n){return r=n.checkHover(t,e)||r})),r},t.prototype.checkClick=function(t,e){if(this.isInactive())return!1;var n=this.isInRect(t,e),r=this.pressed!==n;return this.pressed=n,this.children.forEach((function(n){return r=n.checkClick(t,e)||r})),r},t.prototype.checkRelease=function(t,e){if(this.isInactive())return!1;this.isInRect(t,e)&&this.pressed&&this.onClick();var n=!1;return this.children.forEach((function(r){return n=r.checkRelease(t,e)||n})),n=this.pressed||n,this.pressed=!1,n},t.prototype.release=function(){var t=this.pressed||this.hover;return this.pressed=!1,this.hover=!1,this.children.forEach((function(e){return t=e.release()||t})),t},t.prototype.notifyRedraw=function(){this.parent&&this.parent.notifyRedraw()},t}(),hr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),pr=function(t){function e(e,n){var r,i,o,a,s,u=t.call(this,e)||this;return u.buttonType=null,u.imgNormal=null,u.imgHover=null,u.imgPressed=null,u.imgDisabled=null,u.tooltip=null,u.buttonType=n.buttonType,u.imgNormal=_t.getImageOrNull(n.normalFile),u.imgHover=_t.getImageOrNull(n.highlightFile),u.imgPressed=_t.getImageOrNull(n.pressedFile),u.imgDisabled=_t.getImageOrNull(n.disabledFile),u.relX=n.relX,u.relY=n.relY,u.width=n.width||(null===(r=u.imgNormal)||void 0===r?void 0:r.width)||(null===(i=u.imgPressed)||void 0===i?void 0:i.width),u.height=n.height||(null===(o=u.imgNormal)||void 0===o?void 0:o.height)||(null===(a=u.imgPressed)||void 0===a?void 0:a.height),u.tooltip=null===(s=n.tooltip)||void 0===s?void 0:s.replace(/_/g," "),u.updatePosition(),u}return hr(e,t),e.prototype.onClick=function(){console.log("button pressed: "+this.buttonType)},e.prototype.checkHover=function(e,n){var r=t.prototype.checkHover.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.checkClick=function(e,n){var r=t.prototype.checkClick.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.checkRelease=function(e,n){var r=t.prototype.checkRelease.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.release=function(){var e=t.prototype.release.call(this);return e&&this.notifyRedraw(),e},e.prototype.onRedraw=function(e){if(!this.hidden){var n=this.imgNormal;this.disabled?n=this.imgDisabled||this.imgPressed||this.imgNormal:this.pressed?n=this.imgPressed||this.imgNormal:this.hover&&(n=this.imgHover||this.imgNormal),n&&e.drawImage(n,this.x,this.y),t.prototype.onRedraw.call(this,e)}},e}(lr),fr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),dr=function(t){function e(e){var n=t.call(this)||this;return n.img=null,n.xOut=0,n.yOut=0,n.xIn=0,n.yIn=0,n.animationTimeout=null,n.movedIn=!0,e&&(n.img=_t.getImage(e.filename),n.xOut=e.xOut,n.yOut=e.yOut,n.xIn=e.xIn,n.yIn=e.yIn,n.relX=n.xIn,n.relY=n.yIn),n}return fr(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.animationTimeout=H(this.animationTimeout),this.relX=this.xIn,this.relY=this.yIn,this.movedIn=!0,this.updatePosition()},e.prototype.isInactive=function(){return this.animationTimeout||t.prototype.isInactive.call(this)},e.prototype.setMovedIn=function(t,e){void 0===e&&(e=null),this.movedIn!==t?this.toggleState(e):e&&e()},e.prototype.toggleState=function(t){void 0===t&&(t=null),this.animationTimeout=H(this.animationTimeout),this.movedIn?(this.movedIn=!1,this.updateAnimation(this.xOut,this.yOut,3,t)):(this.movedIn=!0,this.updateAnimation(this.xIn,this.yIn,3,t))},e.prototype.updateAnimation=function(t,e,n,r){var i=t-this.relX,o=e-this.relY;if(Math.abs(i)<=n&&Math.abs(o)<=n)this.relX=t,this.relY=e,this.animationTimeout=null,r&&r();else{this.relX+=Math.round(Math.sign(i)*Math.sqrt(Math.abs(i))*n),this.relY+=Math.round(Math.sign(o)*Math.sqrt(Math.abs(o))*n);var a=this;this.animationTimeout=setTimeout((function(){return a.updateAnimation(t,e,n,r)}),33.333333333333336)}this.updatePosition(),this.notifyRedraw()},e.prototype.onRedraw=function(e){this.hidden||(this.img&&e.drawImage(this.img,this.x,this.y),t.prototype.onRedraw.call(this,e))},e}(lr),yr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),gr=function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o.fill=o.addChild(new dr(n)),o.fill.relX=o.relX-o.fill.relX,o.fill.relY=o.relY-o.fill.relY,o.overlay=o.addChild(new dr(r)),o.btnToggle=o.addChild(new pr(o,i.panelButtonRadarToggle)),o.btnToggle.onClick=function(){return o.toggleState()},o.btnMap=o.addChild(new pr(o,i.panelButtonRadarMapView)),o.btnMap.onClick=function(){},o.btnTagged=o.addChild(new pr(o,i.panelButtonRadarTaggedObjectView)),o.btnTagged.onClick=function(){},o}return yr(e,t),e}(dr),vr=function(t){function e(e){var n=t.call(this)||this;return n.panelButtonRadarToggle=null,n.panelButtonRadarTaggedObjectView=null,n.panelButtonRadarZoomIn=null,n.panelButtonRadarZoomOut=null,n.panelButtonRadarMapView=null,ir.setFromCfg(n,e),n}return yr(e,t),e.prototype.parseValue=function(t,e){return new sr(e)},e}(ir),mr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),wr=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.relX=n.relX,i.relY=n.relY,i.width=n.width,i.height=n.height,i.tooltip=n.tooltip,i.label=r,i.updatePosition(),i}return mr(e,t),e.prototype.onRedraw=function(e){this.hidden||(e.textAlign="center",e.font="bold 10px Arial",e.fillStyle="#fff",e.fillText(this.label,this.x+this.width/2,this.y+this.height-2),t.prototype.onRedraw.call(this,e))},e}(lr),br=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),_r=function(t){function e(e,n){var i=t.call(this,e)||this;return i.labelOre=i.addChild(new wr(i,n.panelButtonCrystalSideBarOre,ie.totalOre.toString())),i.labelCrystal=i.addChild(new wr(i,n.panelButtonCrystalSideBarCrystals,ie.numCrystal.toString())),i.imgNoCrystal=_t.getImage("Interface/RightPanel/NoSmallCrystal.bmp"),i.imgSmallCrystal=_t.getImage("Interface/RightPanel/SmallCrystal.bmp"),i.imgUsedCrystal=_t.getImage("Interface/RightPanel/UsedCrystal.bmp"),i.imgOre=_t.getImage("Interface/RightPanel/CrystalSideBar_Ore.bmp"),s.registerEventListener(r.MATERIAL_AMOUNT_CHANGED,(function(t){i.updateQuantities(t.entityType)})),i}return br(e,t),e.prototype.updateQuantities=function(t){t!==Pt.CRYSTAL&&t!==Pt.ORE&&t!==Pt.BRICK||this.notifyRedraw()},e.prototype.onRedraw=function(e){this.labelOre.label=ie.totalOre.toString(),this.labelCrystal.label=ie.numCrystal.toString(),t.prototype.onRedraw.call(this,e);for(var n=this.x+this.img.width-8,r=this.y+this.img.height-34,i=0;(ie.neededCrystals<1||i<Math.max(ie.neededCrystals,ie.numCrystal))&&r>=Math.max(this.imgNoCrystal.height,this.imgSmallCrystal.height,this.imgUsedCrystal.height);i++){var o=this.imgNoCrystal;ie.usedCrystals>i?o=this.imgUsedCrystal:ie.numCrystal>i&&(o=this.imgSmallCrystal),r-=o.height,e.drawImage(o,n-o.width/2,r)}n=this.x+this.img.width-21,r=this.y+this.img.height-42;for(var a=0;a<ie.numOre&&r>=this.imgOre.height;++a)r-=this.imgOre.height,e.drawImage(this.imgOre,n-this.imgOre.width/2,r)},e}(dr),Or=function(t){function e(e){var n=t.call(this)||this;return n.panelButtonCrystalSideBarOre=null,n.panelButtonCrystalSideBarCrystals=null,ir.setFromCfg(n,e),n}return br(e,t),e.prototype.parseValue=function(t,e){return new sr(e)},e}(ir),Er=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Pr=function(t){function e(e){var n=t.call(this)||this;return n.panelButtonPriorityListDisable=[],n.panelButtonPriorityListUpOne=[],n.panelButtonPriorityListClose=null,n.panelButtonPriorityListReset=null,ir.setFromCfg(n,e),n}return Er(e,t),e.prototype.assignValue=function(e,n,r){return n.match(/panelButtonPriorityListDisable\d+/i)?(this.panelButtonPriorityListDisable.push(this.parseValue(n,r)),!0):n.match(/panelButtonPriorityListUpOne\d+/i)?(this.panelButtonPriorityListUpOne.push(this.parseValue(n,r)),!0):t.prototype.assignValue.call(this,e,n,r)},e.prototype.parseValue=function(t,e){return new sr(e)},e}(ir),Tr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Sr=function(t){function e(e){var n=t.call(this)||this;return n.panelButtonTopPanelCallToArms=null,n.panelButtonTopPanelOptions=null,n.panelButtonTopPanelPriorities=null,ir.setFromCfg(n,e),n}return Tr(e,t),e.prototype.parseValue=function(t,e){return new sr(e)},e}(ir),Ir=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Cr=function(t){function e(e){var n=t.call(this)||this;return n.panelButtonCameraControlZoomIn=null,n.panelButtonCameraControlZoomOut=null,n.panelButtonCameraControlCycleBuildings=null,n.panelButtonCameraControlRotate=null,ir.setFromCfg(n,e),n}return Ir(e,t),e.prototype.parseValue=function(t,e){return new sr(e)},e}(ir),Rr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Lr=function(t){function e(e){var n=t.call(this)||this;return n.panelButtonInformationToggle=null,n.panelButtonInformationFunction=null,ir.setFromCfg(n,e),n}return Rr(e,t),e.prototype.parseValue=function(t,e){return new sr(e)},e}(ir),Ar=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Mr=function(t){function e(e){var n=t.call(this)||this;return n.panelRadar=null,n.panelCrystalSideBar=null,n.panelTopPanel=null,n.panelInformation=null,n.panelPriorityList=null,n.panelCameraControl=null,n.panelInfoDock=null,n.panelEncyclopedia=null,ir.setFromCfg(n,e),n}return Ar(e,t),e.prototype.parseValue=function(t,e){var n={};return e.forEach((function(t){return n[t[0]]=t})),t==="panelRadar".toLowerCase()?new vr(n):t==="panelCrystalSideBar".toLowerCase()?new Or(n):t==="panelTopPanel".toLowerCase()?new Sr(n):t==="panelInformation".toLowerCase()?new Lr(n):t==="panelPriorityList".toLowerCase()?new Pr(n):t==="panelCameraControl".toLowerCase()?new Cr(n):t==="panelInfoDock".toLowerCase()?new cr(n):t==="panelEncyclopedia".toLowerCase()?null:n},e}(ir),xr=function(t){this.filename=t[0],this.xOut=t[1],this.yOut=t[2],this.xIn=t[3],this.yIn=t[4]},Dr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),kr=function(t){function e(e){var n=t.call(this)||this;return n.panelRadar=null,n.panelRadarFill=null,n.panelRadarOverlay=null,n.panelMessages=null,n.panelMessagesSide=null,n.panelCrystalSideBar=null,n.panelTopPanel=null,n.panelInformation=null,n.panelPriorityList=null,n.panelCameraControl=null,n.panelInfoDock=null,n.panelEncyclopedia=null,ir.setFromCfg(n,e),n}return Dr(e,t),e.prototype.parseValue=function(t,e){return new xr(e)},e}(ir),Nr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Br=function(t){function e(e){var n=t.call(this)||this;return n.normalFile=e,n.highlightFile=e,n.pressedFile=e,n.disabledFile=e,n.relX=0,n.relY=0,n}return Nr(e,t),e}(or),jr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Fr=function(t){function e(e,n,r){var i=t.call(this,e,new Br(n.buttonImageFilename))||this;return i.messages=[],i.text=null,i.animationTimeout=null,i.animationSpeedX=.5,i.animationSpeedY=1,i.text=n.message,i.hidden=!0,i.onClick=function(){i.messages.length<1||e.buttonClicked(i)},s.registerEventListener(r,(function(t){for(i.hidden=!1;i.messages.length>=9;)i.messages.pop();i.messages.unshift(t),e.showButton(i)})),i}return jr(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.animationTimeout=H(this.animationTimeout),this.text=null,this.hidden=!0,this.messages=[]},e.prototype.slideToTarget=function(t,e){var n=this;return new Promise((function(r){return n.updateAnimation(t,e,r)}))},e.prototype.updateAnimation=function(t,e,n){var r=t-this.relX,i=e-this.relY;if(Math.abs(r)<=this.animationSpeedX&&Math.abs(i)<=this.animationSpeedY)this.relX=t,this.relY=e,this.animationTimeout=null,n&&n();else{this.relX+=Math.round(Math.sign(r)*Math.sqrt(Math.abs(r))*this.animationSpeedX),this.relY+=Math.round(Math.sign(i)*Math.sqrt(Math.abs(i))*this.animationSpeedY);var o=this;this.animationTimeout=setTimeout((function(){return o.updateAnimation(t,e,n)}),33.333333333333336)}this.updatePosition(),this.notifyRedraw()},e.prototype.onRedraw=function(e){t.prototype.onRedraw.call(this,e),this.hidden||(e.textAlign="left",e.font="bold 10px Arial",e.fillStyle="#fff",e.fillText(this.messages.length.toString(),this.x+2,this.y+this.height/2+2))},e}(pr),Ur=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Wr=function(t){function e(e,n,i,o){var a=t.call(this,e)||this;return a.stackButtons=[],a.informationPanel=null,a.informationPanel=o,a.addChild(new pr(a,n.panelButtonInfoDockGoto)).onClick=function(){return a.gotoLatestMessage()},a.addChild(new pr(a,n.panelButtonInfoDockClose)).onClick=function(){return a.dropLatestMessage()},a.addChild(new Fr(a,i.infoGenericDeath,r.LOCATION_DEATH)),a.addChild(new Fr(a,i.infoGenericMonster,r.LOCATION_MONSTER)),a.addChild(new Fr(a,i.infoCrystalFound,r.LOCATION_CRYSTAL_FOUND)),a.addChild(new Fr(a,i.infoUnderAttack,r.LOCATION_UNDER_ATTACK)),a.addChild(new Fr(a,i.infoLandslide,r.LOCATION_LANDSLIDE)),a.addChild(new Fr(a,i.infoPowerDrain,r.LOCATION_POWER_DRAIN)),a.addChild(new Fr(a,i.infoSlugEmerge,r.LOCATION_SLUG_EMERGE)),a.addChild(new Fr(a,i.infoFoundMinifigure,r.LOCATION_RAIDER_DISCOVERED)),a}return Ur(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.stackButtons=[]},e.prototype.gotoLatestMessage=function(){if(!(this.stackButtons.length<1)){var t=this.stackButtons[0];if(!(t.messages.length<1)){var e=t.messages[0];console.log("TODO force move camera to: "+e.location.toArray())}}},e.prototype.dropLatestMessage=function(){if(!(this.stackButtons.length<1)){var t=this.stackButtons[0];t.messages.length<1||(t.messages.shift(),t.messages.length<1&&(t.hidden=!0,this.informationPanel.setMovedIn(!0),this.stackButtons.splice(this.stackButtons.indexOf(t),1),this.slideStackIntoPosition().then()),t.notifyRedraw())}},e.prototype.showButton=function(t){this.stackButtons.includes(t)?t.notifyRedraw():this.slideInButton(t)},e.prototype.slideInButton=function(t){var e=this;this.stackButtons.forEach((function(t){return t.disabled=!0}));var n=-this.stackButtons.map((function(t){return t.height})).reduce((function(t,e){return t+e}),0);this.stackButtons.push(t),t.relX=-t.width,t.relY=n-t.height,t.updatePosition(),t.slideToTarget(0,n).then((function(){return e.stackButtons.forEach((function(t){return t.disabled=!1}))}))},e.prototype.buttonClicked=function(t){t!==this.stackButtons[0]?this.pushFirst(t):(this.informationPanel.setText(t.text),this.informationPanel.toggleState())},e.prototype.pushFirst=function(t){var e=this;this.stackButtons.splice(this.stackButtons.indexOf(t),1),this.stackButtons.unshift(t),this.slideStackIntoPosition().then((function(){e.informationPanel.setText(t.text),e.informationPanel.setMovedIn(!1)}))},e.prototype.slideStackIntoPosition=function(){var t=this;this.stackButtons.forEach((function(t){return t.disabled=!0}));var e=0,n=this.stackButtons.map((function(t){var n=t.slideToTarget(0,e);return e-=t.height,n}));return new Promise((function(e){Promise.all(n).then((function(){t.stackButtons.forEach((function(t){return t.disabled=!1})),e()}))}))},e}(dr),Hr=function(t){this.message=null,this.buttonImageFilename=null,this.sfx=null,this.timing=null,this.flag=null,this.message=t[0],this.buttonImageFilename=t[1],this.sfx=t[2],this.timing=t[3],this.flag=t[4],this.message=this.message.replace(/_/g," ")},Gr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Jr=function(t){function e(e){var n=t.call(this)||this;return n.infoGenericDeath=null,n.infoGenericMonster=null,n.infoCrystalFound=null,n.infoUnderAttack=null,n.infoLandslide=null,n.infoPowerDrain=null,n.infoSlugEmerge=null,n.infoFoundMinifigure=null,ir.setFromCfg(n,e),n}return Gr(e,t),e.prototype.parseValue=function(t,e){return new Hr(e)},e}(ir),Vr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Yr=function(t){function e(e){var n=t.call(this,e)||this;return n.font=null,n.textImage=null,n.font=_t.getDefaultFont(),n}return Vr(e,t),e.prototype.setText=function(t){this.textImage=t?this.font.createTextImage(t,this.img.width-80):null,this.notifyRedraw()},e.prototype.onRedraw=function(e){t.prototype.onRedraw.call(this,e),this.textImage&&e.drawImage(this.textImage,this.x+(this.img.width-this.textImage.width)/2,this.y+12)},e}(dr),Xr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Kr=function(t){function e(e){var n=t.call(this)||this;return n.width=e[0],n.height=e[1],n.highlightFile=e[2],n.pressedFile=e[3],n.tooltip=e[4],n.relX=4,n.relY=14,n}return Xr(e,t),e}(or),qr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),zr=function(t){function e(e){var n,r,i=t.call(this)||this;if(i.tooltipSfx=null,i.tooltipDisabled=null,i.tooltipDisabledSfx=null,i.hotkey=null,4===e.length)i.normalFile=e[0],i.disabledFile=e[1],i.pressedFile=e[2],i.hotkey=e[3];else if(6===e.length||7===e.length){var o,a;i.normalFile=e[0],i.disabledFile=e[1],i.pressedFile=e[2],o=e[3],a=e[4],i.hotkey=e[5],o&&(Array.isArray(o)?(i.tooltip=o[0],i.tooltipSfx=o[1]):i.tooltip=o),a&&(Array.isArray(a)?(i.tooltipDisabled=a[0],i.tooltipDisabledSfx=a[1]):i.tooltipDisabled=a)}else console.error("Unexpected menu item cfg value length: "+e.length);return null===(n=i.tooltip)||void 0===n||n.replace(/_/g," "),null===(r=i.tooltipDisabled)||void 0===r||r.replace(/_/g," "),i.width=40,i.height=40,i}return qr(e,t),e}(or),Zr=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Qr=function(t){function e(e,n,r,i,o){var a=t.call(this,e,n)||this;return a.tooltipSfx=null,a.tooltipDisabled=null,a.tooltipDisabledSfx=null,a.hotkey=null,a.isDisabled=function(){return a.disabled},a.buttonType=r,a.relX=i-59,a.relY=9+a.height*o,a.tooltipSfx=n.tooltipSfx,a.tooltipDisabled=n.tooltipDisabled,a.tooltipDisabledSfx=n.tooltipDisabledSfx,a.hotkey=n.hotkey,a.disabled=!0,a}return Zr(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.disabled=!0,this.updateState(!1)},e.prototype.onClick=function(){console.log("menu item pressed: "+this.buttonType)},e.prototype.updateState=function(t){void 0===t&&(t=!0);var e=!!this.isDisabled(),n=this.disabled!==e;return this.disabled=e,n&&t&&this.notifyRedraw(),n},e.prototype.drawHover=function(e){t.prototype.drawHover.call(this,e),!this.disabled&&this.hover&&(e.strokeStyle="#0f0",e.lineWidth=2,e.strokeRect(this.x-e.lineWidth/2,this.y-e.lineWidth/2,this.width+e.lineWidth-1,this.height+e.lineWidth-1))},e}(pr),$r=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ti=function(t){function e(e,n){void 0===n&&(n=null);var r=t.call(this)||this;if(r.backBtn=null,r.iconPanelButtons=[],n){var i=new Kr(_t.cfg("InterfaceBackButton"));r.backBtn=r.addChild(new pr(r,i)),r.backBtn.onClick=function(){return r.toggleState((function(){return n.toggleState()}))}}var o=_t.cfg("InterfaceSurroundImages",e.toString()),a=o[0],s=(o[1],o[2],o[3],o[4],o[5]);return o[6],o[7],r.img=n?_t.getImage(a):_t.getImage(s),r.xOut=-r.img.width,r}return $r(e,t),e.prototype.addMenuItem=function(t,e){var n=new zr(_t.cfg(t,e)),r=this.addChild(new Qr(this,n,e,this.img.width,this.iconPanelButtons.length));return this.iconPanelButtons.push(r),r},e.prototype.toggleState=function(e){void 0===e&&(e=null),t.prototype.toggleState.call(this,e),this.movedIn||this.iconPanelButtons.forEach((function(t){return t.updateState()}))},e}(dr),ei=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ni=function(t){function e(e){var n=t.call(this,10,e)||this;return n.backBtn.onClick=function(){s.publishEvent(new m),n.toggleState((function(){return e.toggleState()}))},n.addBuildMenuItem("InterfaceBuildImages","Toolstation",(function(){return new Qe})),n.addBuildMenuItem("InterfaceBuildImages","TeleportPad",(function(){return new ze})),n.addBuildMenuItem("InterfaceBuildImages","Docks",(function(){return new je})),n.addBuildMenuItem("InterfaceBuildImages","Powerstation",(function(){return new Ye})),n.addBuildMenuItem("InterfaceBuildImages","Barracks",(function(){return new Ne})),n.addBuildMenuItem("InterfaceBuildImages","Upgrade",(function(){return new tn})),n.addBuildMenuItem("InterfaceBuildImages","Geo-dome",(function(){return new Ue})),n.addBuildMenuItem("InterfaceBuildImages","OreRefinery",(function(){return new Je})),n.addBuildMenuItem("InterfaceBuildImages","Gunstation",(function(){return new He})),n.addBuildMenuItem("InterfaceBuildImages","TeleportBIG",(function(){return new Ke})),n}return ei(e,t),e.prototype.addBuildMenuItem=function(t,e,n){var r=this.addMenuItem(t,e);return r.isDisabled=function(){return!1},r.onClick=function(){return ie.buildModeSelection=n()},r},e}(ti),ri=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ii=function(t){function e(e){var n=t.call(this,8,e)||this;return n.addGetToolItem("InterfaceImages","Interface_MenuItem_GetDrill",Re.DRILL),n.addGetToolItem("InterfaceImages","Interface_MenuItem_GetSpade",Re.SHOVEL),n.addGetToolItem("InterfaceImages","Interface_MenuItem_GetHammer",Re.HAMMER),n.addGetToolItem("InterfaceImages","Interface_MenuItem_GetSpanner",Re.SPANNER),n.addGetToolItem("InterfaceImages","Interface_MenuItem_GetFreezerGun",Re.FREEZERGUN),n.addGetToolItem("InterfaceImages","Interface_MenuItem_GetLaser",Re.LASER),n.addGetToolItem("InterfaceImages","Interface_MenuItem_GetPusherGun",Re.PUSHERGUN),n.addGetToolItem("InterfaceImages","Interface_MenuItem_GetBirdScarer",Re.BIRDSCARER),n}return ri(e,t),e.prototype.addGetToolItem=function(e,n,r){var i=t.prototype.addMenuItem.call(this,e,n);return i.isDisabled=function(){return!ie.hasOneBuildingOf(Pt.TOOLSTATION)||ie.selectedRaiders.every((function(t){return t.hasTool(r)}))},i.onClick=function(){ie.selectedRaiders.forEach((function(t){if(!t.hasTool(r)){var e=ie.getBuildingsByType(Pt.TOOLSTATION).map((function(e){return t.findPathToTarget(new Vt(e.getPosition2D()))})).sort((function(t,e){return t.lengthSq-e.lengthSq}))[0];e&&t.setJob(new ae(e.targetPosition,r))}})),s.publishEvent(new y)},i},e}(ti),oi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ai=function(t){function e(e){var n=t.call(this,e)||this;return n.relX=4,n.relY=11,s.registerEventListener(r.RAIDER_REQUESTED,(function(){return n.notifyRedraw()})),n}return oi(e,t),e.prototype.onRedraw=function(e){if(!this.hidden){var n=ie.requestedRaiders;n&&(e.textAlign="left",e.font="bold 10px Arial",e.fillStyle=this.disabled||this.parent&&this.parent.disabled?"#444":"#fff",e.fillText(n.toString(),this.x,this.y),t.prototype.onRedraw.call(this,e))}},e}(lr),si=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ui=function(t){function e(e){var n=t.call(this,5,e)||this;return n.addMenuItem("InterfaceBuildImages","BullDozer"),n.addMenuItem("InterfaceBuildImages","WalkerDigger"),n.addMenuItem("InterfaceBuildImages","LargeMLP"),n.addMenuItem("InterfaceBuildImages","LargeDigger"),n.addMenuItem("InterfaceBuildImages","LargeCat"),n}return si(e,t),e}(ti),ci=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),li=function(t){function e(e,n,r,i,o){var a=t.call(this,e,n,null,i,o)||this;return a.toggleState=!1,a.imgOnNormal=_t.getImageOrNull(r.normalFile),a.imgOnHover=_t.getImageOrNull(r.highlightFile),a.imgOnPressed=_t.getImageOrNull(r.pressedFile),a.imgOnDisabled=_t.getImageOrNull(r.disabledFile),a}return ci(e,t),e.prototype.onClick=function(){this.toggleState=!this.toggleState,this.onToggleStateChange()},e.prototype.onToggleStateChange=function(){},e.prototype.onRedraw=function(t){if(!this.hidden){var e=this.toggleState?this.imgOnNormal:this.imgNormal;this.disabled?e=this.toggleState?this.imgOnDisabled||this.imgOnPressed||this.imgOnNormal:this.imgDisabled||this.imgPressed||this.imgNormal:this.pressed?e=this.toggleState?this.imgOnPressed||this.imgOnNormal:this.imgPressed||this.imgNormal:this.hover&&(e=this.toggleState?this.imgOnHover||this.imgOnNormal:this.imgHover||this.imgNormal),e&&t.drawImage(e,this.x,this.y),this.children.forEach((function(e){return e.onRedraw(t)})),this.children.forEach((function(e){return e.drawHover(t)})),this.children.forEach((function(e){return e.drawTooltip(t)}))}},e}(Qr),hi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),pi=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.backBtn.onClick=function(){return s.publishEvent(new y)},r}return hi(e,t),e}(ti),fi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),di=function(t){function e(e){var n=t.call(this,4,e)||this;n.addMenuItem("InterfaceImages","Interface_MenuItem_Repair");var i=new zr(_t.cfg("InterfaceImages","Interface_MenuItem_PowerOff")),o=new zr(_t.cfg("InterfaceImages","Interface_MenuItem_PowerOn")),a=n.addChild(new li(n,i,o,n.img.width,n.iconPanelButtons.length));n.iconPanelButtons.push(a),a.isDisabled=function(){var t,e,n,r;return ie.usedCrystals>=ie.numCrystal||(null===(e=null===(t=ie.selectedBuilding)||void 0===t?void 0:t.stats)||void 0===e?void 0:e.SelfPowered)||(null===(r=null===(n=ie.selectedBuilding)||void 0===n?void 0:n.stats)||void 0===r?void 0:r.PowerBuilding)},a.onToggleStateChange=function(){var t,e;a.toggleState?null===(t=ie.selectedBuilding)||void 0===t||t.turnOffPower():null===(e=ie.selectedBuilding)||void 0===e||e.turnOnPower()};var u=n.addMenuItem("InterfaceImages","Interface_MenuItem_UpgradeBuilding");u.isDisabled=function(){var t;return!(null===(t=ie.selectedBuilding)||void 0===t?void 0:t.canUpgrade())},u.onClick=function(){var t;return null===(t=ie.selectedBuilding)||void 0===t?void 0:t.upgrade()};var c=n.addMenuItem("InterfaceImages","Interface_MenuItem_DeleteBuilding");return c.isDisabled=function(){return!1},c.onClick=function(){var t;return null===(t=ie.selectedBuilding)||void 0===t?void 0:t.beamUp()},s.registerEventListener(r.SELECTED_BUILDING,(function(){a.updateState(),u.updateState()})),s.registerEventListener(r.MATERIAL_AMOUNT_CHANGED,(function(){a.updateState(),u.updateState()})),n}return fi(e,t),e}(pi),yi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),gi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return yi(e,t),e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this),this.item.targetSurface.canPlaceFence()&&(this.item.worldMgr.sceneManager.scene.add(this.item.group),this.item.targetSurface.fence=this.item)},e}(Ht),vi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),mi=function(t){function e(e){var n=t.call(this,Pt.ELECTRIC_FENCE)||this,r=_t.getResource("Buildings/E-Fence/E-Fence4.lwo"),i=ut.registerMesh(new It("Buildings/E-Fence/").parse(r));return n.group.add(i),n.targetSurface=e,n.priorityIdentifier=St.aiPriorityConstruction,n}return vi(e,t),e.prototype.updateTargets=function(){return this.targets.length<1?this.targetSurface.canPlaceFence()?this.targets=[new Xt(this.targetSurface.getCenterWorld2D(),null,null)]:this.targets=ie.getBuildingsByType.apply(ie,this.getTargetBuildingTypes()).map((function(t){return new Xt(t.getDropPosition2D(),null,t)})):this.targetSurface.canPlaceFence()||this.targets[0].building||(this.targets=ie.getBuildingsByType.apply(ie,this.getTargetBuildingTypes()).map((function(t){return new Xt(t.getDropPosition2D(),null,t)}))),this.targets},e.prototype.createCarryJob=function(){return new gi(this)},e}(qt),wi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),bi=function(t){function e(e){var n=t.call(this,3,e)||this,i=n.addMenuItem("InterfaceImages","Interface_MenuItem_LayPath");i.onClick=function(){var t=ie.selectedEntities[0];t.surfaceType=nt.POWER_PATH_SITE,t.updateTexture();var e=ie.getClosestBuildingByType(t.getCenterWorld(),Pt.TOOLSTATION);e&&e.spawnMaterials(ie.dropMaterial(Pt.ORE,2));var n=new $n(t);n.neededByType.set(Pt.ORE,2),ie.buildingSites.push(n),s.publishEvent(new y)},i.isDisabled=function(){var t;return(null===(t=ie.selectedSurface)||void 0===t?void 0:t.surfaceType)!==nt.GROUND};var o=n.addMenuItem("InterfaceImages","Interface_MenuItem_RemovePath");o.onClick=function(){var t;null===(t=ie.selectedSurface)||void 0===t||t.makeRubble(2),s.publishEvent(new y)},o.isDisabled=function(){var t;return(null===(t=ie.selectedSurface)||void 0===t?void 0:t.surfaceType)!==nt.POWER_PATH};var a=n.addMenuItem("InterfaceImages","Interface_MenuItem_PlaceFence");return a.isDisabled=function(){var t;return!ie.hasOneBuildingOf(Pt.POWER_STATION)||!(null===(t=ie.selectedSurface)||void 0===t?void 0:t.canPlaceFence())},a.onClick=function(){var t=ie.selectedSurface;if(t){var e=ie.getClosestBuildingByType(t.getCenterWorld(),Pt.TOOLSTATION);e&&(null==e||e.spawnMaterials([new mi(t)]))}s.publishEvent(new y)},s.registerEventListener(r.SELECTED_SURFACE,(function(){i.updateState(),o.updateState(),a.updateState()})),n}return wi(e,t),e}(pi),_i=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Oi=function(t){function e(){return t.call(this,kt.EAT)||this}return _i(e,t),e.prototype.getWorkplaces=function(){return this.fulfiller.map((function(t){return new Vt(t.getPosition2D())}))},e.prototype.onJobComplete=function(){t.prototype.onJobComplete.call(this)},e.prototype.getWorkActivity=function(){return ce.Eat},e}(Bt),Ei=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Pi=function(t){function e(e){var n=t.call(this,10,e)||this,r=n.addMenuItem("InterfaceImages","Interface_MenuItem_GoFeed");r.isDisabled=function(){return!1},r.onClick=function(){ie.selectedRaiders.forEach((function(t){return!t.isDriving()&&t.setJob(new Oi)})),s.publishEvent(new y)},n.addMenuItem("InterfaceImages","Interface_MenuItem_UnLoadMinifigure"),n.addMenuItem("InterfaceImages","Interface_MenuItem_MinifigurePickUp"),n.getToolItem=n.addMenuItem("InterfaceImages","Interface_MenuItem_GetTool"),n.getToolItem.isDisabled=function(){return!1},n.addMenuItem("InterfaceImages","Interface_MenuItem_DropBirdScarer"),n.addMenuItem("InterfaceImages","Interface_MenuItem_UpgradeMan"),n.trainItem=n.addMenuItem("InterfaceImages","Interface_MenuItem_TrainSkill"),n.trainItem.isDisabled=function(){return!1},n.addMenuItem("InterfaceImages","Interface_MenuItem_GotoFirstPerson"),n.addMenuItem("InterfaceImages","Interface_MenuItem_GotoSecondPerson");var i=n.addMenuItem("InterfaceImages","Interface_MenuItem_DeleteMan");return i.isDisabled=function(){return!1},i.onClick=function(){return ie.selectedRaiders.forEach((function(t){return t.beamUp()}))},n}return Ei(e,t),e}(pi),Ti=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Si=function(t){function e(e){var n=t.call(this,2,e)||this,i=n.addMenuItem("InterfaceImages","Interface_MenuItem_ClearRubble");return i.onClick=function(){var t;null===(t=ie.selectedSurface)||void 0===t||t.createClearRubbleJob(),s.publishEvent(new y)},i.isDisabled=function(){var t;return!(null===(t=ie.selectedSurface)||void 0===t?void 0:t.hasRubble())},n.addMenuItem("InterfaceImages","Interface_MenuItem_PlaceFence"),s.registerEventListener(r.SELECTED_SURFACE,(function(){return i.updateState()})),n}return Ti(e,t),e}(pi),Ii=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ci=function(t){function e(e){return t.call(this,7,e)||this}return Ii(e,t),e}(pi),Ri=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Li=function(t){function e(e){var n=t.call(this,4,e)||this,i=n.addWallMenuItem("Interface_MenuItem_Dig",(function(){var t;return null===(t=ie.selectedSurface)||void 0===t?void 0:t.createDrillJob()}));i.isDisabled=function(){var t,e;return!(null===(t=ie.selectedSurface)||void 0===t?void 0:t.isDrillable())&&!(null===(e=ie.selectedSurface)||void 0===e?void 0:e.isDrillableHard())};var o=n.addWallMenuItem("Interface_MenuItem_Reinforce",(function(){var t;return null===(t=ie.selectedSurface)||void 0===t?void 0:t.createReinforceJob()}));o.isDisabled=function(){var t;return!(null===(t=ie.selectedSurface)||void 0===t?void 0:t.isReinforcable())};var a=n.addWallMenuItem("Interface_MenuItem_Dynamite",(function(){var t;return null===(t=ie.selectedSurface)||void 0===t?void 0:t.createDynamiteJob()}));a.isDisabled=function(){return!ie.hasBuildingWithUpgrades(Pt.TOOLSTATION,2)&&!ie.raiders.some((function(t){return t.hasTraining(ne.DEMOLITION)}))};var u=n.addMenuItem("InterfaceImages","Interface_MenuItem_DeselectDig");return u.isDisabled=function(){return!1},u.onClick=function(){ie.selectedEntities[0].cancelJobs(),s.publishEvent(new y)},s.registerEventListener(r.SELECTED_SURFACE,(function(){i.updateState(!1),o.updateState(!1),a.updateState(!1),n.notifyRedraw()})),n}return Ri(e,t),e.prototype.addWallMenuItem=function(t,e){var n=this.addMenuItem("InterfaceImages",t);return n.onClick=function(){e(),s.publishEvent(new y)},n},e}(pi),Ai=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Mi=function(t){function e(e){var n=t.call(this,6,e)||this;return n.addMenuItem("InterfaceBuildImages","Hoverboard"),n.addMenuItem("InterfaceBuildImages","SmallDigger"),n.addMenuItem("InterfaceBuildImages","SmallTruck"),n.addMenuItem("InterfaceBuildImages","SmallCat"),n.addMenuItem("InterfaceBuildImages","SmallMLP"),n.addMenuItem("InterfaceBuildImages","SmallHeli"),n}return Ai(e,t),e}(ti),xi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Di=function(t){function e(e){var n=t.call(this,6,e)||this;n.addMenuItem("InterfaceImages","Interface_MenuItem_TrainDriver"),n.addMenuItem("InterfaceImages","Interface_MenuItem_TrainEngineer"),n.addMenuItem("InterfaceImages","Interface_MenuItem_TrainGeologist"),n.addMenuItem("InterfaceImages","Interface_MenuItem_TrainPilot"),n.addMenuItem("InterfaceImages","Interface_MenuItem_TrainSailor");var i=n.addMenuItem("InterfaceImages","Interface_MenuItem_TrainDynamite");return i.isDisabled=function(){return!ie.getBuildingsByType(Pt.TOOLSTATION).some((function(t){return t.stats.TrainDynamite[t.level]}))||ie.selectedRaiders.every((function(t){return t.hasTraining(ne.DEMOLITION)}))},i.onClick=function(){ie.getBuildingsByType(Pt.TOOLSTATION).some((function(t){if(t.stats.TrainDynamite[t.level])return ie.selectedRaiders.forEach((function(e){return!e.hasTraining(ne.DEMOLITION)&&e.setJob(new he(t.primarySurface,ne.DEMOLITION))})),s.publishEvent(new y),!0}))},s.registerEventListener(r.BUILDING_UPGRADED,(function(){return i.updateState()})),n}return xi(e,t),e}(ti),ki=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ni=function(t){function e(){var e=t.call(this)||this;e.subPanels=[],e.relX=e.xOut=624,e.xIn=735,e.relY=e.yOut=e.yIn=9,e.movedIn=!1,e.mainPanel=e.addSubPanel(new ti(4)),e.mainPanel.relX=e.mainPanel.xOut,e.mainPanel.relY=e.mainPanel.yOut,e.mainPanel.movedIn=!1;var n=e.addSubPanel(new ni(e.mainPanel)),i=e.addSubPanel(new Mi(e.mainPanel)),o=e.addSubPanel(new ui(e.mainPanel));e.selectWallPanel=e.addSubPanel(new Li(e.mainPanel)),e.selectFloorPanel=e.addSubPanel(new bi(e.mainPanel)),e.selectRubblePanel=e.addSubPanel(new Si(e.mainPanel));var a=e.addSubPanel(new di(e.mainPanel)),u=e.addSubPanel(new Pi(e.mainPanel)),c=e.addSubPanel(new Di(u));u.trainItem.onClick=function(){return u.toggleState((function(){return c.toggleState()}))};var l=e.addSubPanel(new ii(u));u.getToolItem.onClick=function(){return u.toggleState((function(){return l.toggleState()}))};var h=e.addSubPanel(new Ci(e.mainPanel)),p=e.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_TeleportMan");p.isDisabled=function(){return ie.raiders.length>=ie.getMaxRaiders()||ie.requestedRaiders>=9||!ie.hasOneBuildingOf(Pt.TOOLSTATION,Pt.TELEPORT_PAD)},p.updateState(),s.registerEventListener(r.RAIDER_REQUESTED,(function(){return p.updateState()})),s.registerEventListener(r.ENTITY_ADDED,(function(t){t.superType!==Tt.BUILDING&&t.superType!==Tt.RAIDER||p.updateState()})),s.registerEventListener(r.ENTITY_REMOVED,(function(t){t.superType!==Tt.BUILDING&&t.superType!==Tt.RAIDER||p.updateState()})),p.onClick=function(){ie.requestedRaiders++,s.publishEvent(new T)},p.addChild(new ai(p));var f=e.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildBuilding");f.isDisabled=function(){return!1},f.onClick=function(){return e.mainPanel.toggleState((function(){return n.toggleState()}))};var d=e.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildSmallVehicle");d.isDisabled=function(){return!1},d.onClick=function(){return e.mainPanel.toggleState((function(){return i.toggleState()}))};var y=e.mainPanel.addMenuItem("InterfaceImages","Interface_MenuItem_BuildLargeVehicle");return y.isDisabled=function(){return!1},y.onClick=function(){return e.mainPanel.toggleState((function(){return o.toggleState()}))},s.registerEventListener(r.SELECTED_SURFACE,(function(t){e.onSelectedSurfaceChange(t.surface)})),s.registerEventListener(r.SURFACE_CHANGED,(function(t){ie.selectedSurface===t.surface&&e.onSelectedSurfaceChange(t.surface)})),s.registerEventListener(r.DESELECTED_ENTITY,(function(){return e.selectSubPanel(e.mainPanel)})),s.registerEventListener(r.SELECTED_BUILDING,(function(){return e.selectSubPanel(a)})),s.registerEventListener(r.SELECTED_RAIDER,(function(){return e.selectSubPanel(u)})),s.registerEventListener(r.SELECTED_VEHICLE,(function(){return e.selectSubPanel(h)})),e}return ki(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.relX=this.xOut,this.relY=this.yOut,this.movedIn=!1,this.updatePosition(),this.mainPanel.relX=this.mainPanel.xOut,this.mainPanel.relY=this.mainPanel.yOut,this.mainPanel.movedIn=!1,this.mainPanel.updatePosition()},e.prototype.addSubPanel=function(t){return this.addChild(t),this.subPanels.push(t),t},e.prototype.selectSubPanel=function(t){this.subPanels.forEach((function(e){return e!==t&&e.setMovedIn(!0)})),t.setMovedIn(!1)},e.prototype.onSelectedSurfaceChange=function(t){t.surfaceType.floor?t.hasRubble()?this.selectSubPanel(this.selectRubblePanel):this.selectSubPanel(this.selectFloorPanel):this.selectSubPanel(this.selectWallPanel)},e}(dr),Bi=function(t,e,n){this.textImage=t.createTextImage(e.text,n),this.infoImage=_t.getImageOrNull(e.imageFilename)},ji=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Fi=function(t){function e(e,n){var i=t.call(this,e)||this;i.imgAir=null,i.currentMessage=null,i.messageTimeout=null,i.relX=i.xOut=i.xIn=42,i.relY=i.yOut=i.yIn=409,i.imgAir=_t.getImage("Interface/Airmeter/msgpanel_air_juice.bmp");var o=_t.getDefaultFont(),a=new Bi(o,n.textCrystalFound,i.img.width);s.registerEventListener(r.LOCATION_CRYSTAL_FOUND,(function(){return i.setMessage(a)})),i.msgSpaceToContinue=new Bi(o,n.textSpaceToContinue,i.img.width);var u=new Bi(o,n.textCavernDiscovered,i.img.width);s.registerEventListener(r.CAVERN_DISCOVERED,(function(){return i.setMessage(u)}));var c=new Bi(o,n.textOreFound,i.img.width);return s.registerEventListener(r.ORE_FOUND,(function(){return i.setMessage(c)})),i.msgAirSupplyLow=new Bi(o,n.textAirSupplyLow,i.img.width),i.msgAirSupplyRunningOut=new Bi(o,n.textAirSupplyRunningOut,i.img.width),i.msgGameCompleted=new Bi(o,n.textGameCompleted,i.img.width),i.msgManTrained=new Bi(o,n.textManTrained,i.img.width),s.registerEventListener(r.RAIDER_TRAINED,(function(){return i.setMessage(i.msgManTrained)})),i.msgUnitUpgraded=new Bi(o,n.textUnitUpgraded,i.img.width),s.registerEventListener(r.AIR_LEVEL_CHANGED,(function(){return i.notifyRedraw()})),i}return ji(e,t),e.prototype.setMessage=function(t,e){if(void 0===e&&(e=3e3),this.messageTimeout=H(this.messageTimeout),this.currentMessage=t,this.notifyRedraw(),e){var n=this;this.messageTimeout=setTimeout((function(){n.currentMessage=null,n.notifyRedraw()}),e)}},e.prototype.unsetMessage=function(t){this.currentMessage===t&&(this.currentMessage=null,this.notifyRedraw())},e.prototype.onRedraw=function(e){var n,r;if(t.prototype.onRedraw.call(this,e),ie.airLevel>0){var i=Math.round(236*Math.min(1,ie.airLevel));e.drawImage(this.imgAir,this.x+85,this.y+6,i,8)}var o=null===(n=this.currentMessage)||void 0===n?void 0:n.textImage,a=null===(r=this.currentMessage)||void 0===r?void 0:r.infoImage;if(o){var s=this.x+(this.img.width-o.width-(a?a.width:0))/2;e.drawImage(o,s,this.y+26)}if(a){var u=this.x+this.img.width-a.width;e.drawImage(a,u,this.y+16)}},e}(dr),Ui=function(t){this.text=t[0],this.imageFilename=t[1],this.sfxName=t[2]},Wi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Hi=function(t){function e(e){var n=t.call(this)||this;return n.textCrystalFound=null,n.textSpaceToContinue=null,n.textCavernDiscovered=null,n.textOreFound=null,n.textAirSupplyLow=null,n.textAirSupplyRunningOut=null,n.textGameCompleted=null,n.textManTrained=null,n.textUnitUpgraded=null,ir.setFromCfg(n,e),n}return Wi(e,t),e.prototype.parseValue=function(t,e){return new Ui(e)},e}(ir),Gi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ji=function(t){function e(e){var n=t.call(this)||this;return n.aiPriorityTrain=null,n.aiPriorityGetIn=null,n.aiPriorityCrystal=null,n.aiPriorityOre=null,n.aiPriorityRepair=null,n.aiPriorityClearing=null,n.aiPriorityDestruction=null,n.aiPriorityConstruction=null,n.aiPriorityReinforce=null,n.aiPriorityRecharge=null,ir.setFromCfg(n,e),n}return Gi(e,t),e.prototype.parseValue=function(t,e){return{buttonType:e[0],normalFile:e[1],highlightFile:e[1],pressedFile:e[2],disabledFile:e[3]}},e}(ir),Vi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Yi=function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o.prioPositions=[],o.prioByName=new Map,n.panelButtonPriorityListDisable.forEach((function(t,e){o.addChild(new pr(o,t)).onClick=function(){ie.priorityList.toggle(e),o.setList(ie.priorityList.current)}})),n.panelButtonPriorityListUpOne.forEach((function(t,e){o.addChild(new pr(o,t)).onClick=function(){ie.priorityList.upOne(e),o.setList(ie.priorityList.current)}})),o.addChild(new pr(o,n.panelButtonPriorityListReset)).onClick=function(){return o.resetList()},o.prioPositions=r,o.prioByName.set(St.aiPriorityTrain,o.addChild(new pr(o,i.aiPriorityTrain))),o.prioByName.set(St.aiPriorityGetIn,o.addChild(new pr(o,i.aiPriorityGetIn))),o.prioByName.set(St.aiPriorityCrystal,o.addChild(new pr(o,i.aiPriorityCrystal))),o.prioByName.set(St.aiPriorityOre,o.addChild(new pr(o,i.aiPriorityOre))),o.prioByName.set(St.aiPriorityRepair,o.addChild(new pr(o,i.aiPriorityRepair))),o.prioByName.set(St.aiPriorityClearing,o.addChild(new pr(o,i.aiPriorityClearing))),o.prioByName.set(St.aiPriorityDestruction,o.addChild(new pr(o,i.aiPriorityDestruction))),o.prioByName.set(St.aiPriorityConstruction,o.addChild(new pr(o,i.aiPriorityConstruction))),o.prioByName.set(St.aiPriorityReinforce,o.addChild(new pr(o,i.aiPriorityReinforce))),o.prioByName.set(St.aiPriorityRecharge,o.addChild(new pr(o,i.aiPriorityRecharge))),o}return Vi(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.resetList()},e.prototype.resetList=function(){ie.priorityList.reset(),this.setList(ie.priorityList.current)},e.prototype.setList=function(t){var e=this;this.prioByName.forEach((function(t){return t.hidden=!0}));var n=0,r=!1;t.forEach((function(t){var i=e.prioByName.get(t.key);if(i){r=r||i.hidden||i.disabled!==!t.enabled,i.hidden=!1,i.disabled=!t.enabled,i.relX=e.prioPositions[n].x,i.relY=e.prioPositions[n].y,i.updatePosition();var o=n;i.onClick=function(){ie.priorityList.pushToTop(o),e.setList(ie.priorityList.current)},n++}})),r&&this.notifyRedraw()},e}(dr),Xi=function(t){this.x=t[0],this.y=t[1]},Ki=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),qi=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.toggleState=!1,r}return Ki(e,t),e.prototype.checkHover=function(t,e){if(this.isInactive())return!1;var n=this.isInRect(t,e),r=this.hover!==n;return this.hover=n,this.pressed=this.pressed&&this.hover||this.toggleState,this.children.forEach((function(n){return r=n.checkHover(t,e)||r})),r&&this.notifyRedraw(),r},e.prototype.checkClick=function(t,e){if(this.isInactive())return!1;var n=this.isInRect(t,e)||this.toggleState,r=this.pressed!==n;return this.pressed=n,this.children.forEach((function(n){return r=n.checkClick(t,e)||r})),r&&this.notifyRedraw(),r},e.prototype.checkRelease=function(t,e){if(this.isInactive())return!1;var n=this.isInRect(t,e),r=n&&this.pressed;return r&&(this.toggleState=!this.toggleState,this.onClick(),this.pressed=r&&this.toggleState,this.hover=n),this.children.forEach((function(n){return r=n.checkRelease(t,e)||r})),r&&this.notifyRedraw(),r},e.prototype.release=function(){return!1},e}(pr),zi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Zi=function(t){function e(e,n){var r=t.call(this,e)||this;return r.btnCallToArms=r.addChild(new qi(r,n.panelButtonTopPanelCallToArms)),r.btnOptions=r.addChild(new pr(r,n.panelButtonTopPanelOptions)),r.btnPriorities=r.addChild(new qi(r,n.panelButtonTopPanelPriorities)),r}return zi(e,t),e}(dr),Qi=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),$i=function(t){function e(){var e=t.call(this)||this;return e.rootElement=new lr,e.panels=[],e.rootElement.notifyRedraw=function(){return e.redraw()},e.onRedraw=function(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),e.rootElement.onRedraw(t)},e}return Qi(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.panels.forEach((function(t){return t.reset()}))},e.prototype.addPanel=function(t){return this.rootElement.addChild(t),this.panels.push(t),t},e.prototype.handlePointerEvent=function(t){var e=this.toCanvasCoords(t.clientX,t.clientY),n=e[0],r=e[1],i=this.toScaledCoords(t.clientX,t.clientY),o=i[0],a=i[1],s=this.context&&this.context.getImageData(n,r,1,1).data[3]>0;return s?t.eventEnum===kn.MOVE?this.rootElement.checkHover(o,a):t.eventEnum===kn.DOWN?t.button===Dn.MAIN&&this.rootElement.checkClick(o,a):t.eventEnum===kn.UP&&t.button===Dn.MAIN&&this.rootElement.checkRelease(o,a):t.eventEnum===kn.MOVE&&this.rootElement.release(),s},e.prototype.handleWheelEvent=function(t){var e=this.toCanvasCoords(t.clientX,t.clientY),n=e[0],r=e[1];return!this.context||this.context.getImageData(n,r,1,1).data[3]>0},e}(Wn),to=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),eo=function(t){function e(){var e=t.call(this)||this;e.onOptionsShow=function(){return console.log("show options triggered")};var n=new kr(_t.cfg("Panels640x480")),r=new Mr(_t.cfg("Buttons640x480"));e.panelEncyclopedia=e.addPanel(new dr(n.panelEncyclopedia)),e.panelInformation=e.addPanel(new Yr(n.panelInformation)),e.panelInfoDock=e.addPanel(new Wr(n.panelInfoDock,r.panelInfoDock,new Jr(_t.cfg("InfoMessages")),e.panelInformation)),e.panelCameraControl=e.addPanel(new dr(n.panelCameraControl));var i=new Ji(_t.cfg("PriorityImages")),o=Object.values(_t.cfg("PrioritiesImagePositions")).map((function(t){return new Xi(t)}));return e.panelPriorityList=e.addPanel(new Yi(n.panelPriorityList,r.panelPriorityList,o,i)),e.panelTopPanel=e.addPanel(new Zi(n.panelTopPanel,r.panelTopPanel)),e.panelMain=e.addPanel(new Ni),e.panelCrystalSideBar=e.addPanel(new _r(n.panelCrystalSideBar,r.panelCrystalSideBar)),e.panelMessagesSide=e.addPanel(new dr(n.panelMessagesSide)),e.panelMessages=e.addPanel(new Fi(n.panelMessages,new Hi(_t.cfg("TextMessagesWithImages")))),e.panelRadar=e.addPanel(new gr(n.panelRadar,n.panelRadarFill,n.panelRadarOverlay,r.panelRadar)),e.panelTopPanel.btnOptions.onClick=function(){return e.onOptionsShow()},e.panelTopPanel.btnPriorities.onClick=function(){e.panelTopPanel.btnPriorities.toggleState?e.panelMain.setMovedIn(!0,(function(){return e.panelPriorityList.setMovedIn(!1)})):e.panelPriorityList.setMovedIn(!0,(function(){return e.panelMain.setMovedIn(!1)}))},e}return to(e,t),e}($i),no=function(t){this.x=0,this.y=0,this.w=0,this.h=0,this.x=t[0],this.y=t[1],this.w=t[2],this.h=t[3]},ro=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),io=function(t){function e(e){var n=t.call(this)||this;return n.image=null,n.titleWindow=null,n.textWindow=null,n.okWindow=null,n.cancelWindow=null,n.contrastOverlay=null,ir.setFromCfg(n,e),n}return ro(e,t),e.prototype.parseValue=function(e,n){return e.endsWith("window")?new no(n):t.prototype.parseValue.call(this,e,n)},e}(ir),oo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ao=function(t){function e(){var e=t.call(this,[])||this;e.titleFont=_t.getBitmapFont("Interface/Fonts/MbriefFont2.bmp"),e.title=_t.cfg("Main","MissionBriefingText");var n=new io(_t.cfg("Dialog"));return e.titleWindow=n.titleWindow,e.textFont=_t.getBitmapFont("Interface/Fonts/MbriefFont.bmp"),e.textWindow=n.textWindow,e.nextButtonCfg={buttonType:"Next briefing paragraph",relX:394,relY:214,normalFile:_t.cfg("Main","NextButton640x480")},e.backButtonCfg={buttonType:"Previous briefing paragraph",relX:54,relY:214,normalFile:_t.cfg("Main","BackArrow")},e}return oo(e,t),e}(xr),so=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),uo=function(t){function e(){var e=t.call(this)||this;return e.cfg=null,e.imgTitle=null,e.titleRelX=0,e.titleRelY=0,e.btnNext=null,e.btnBack=null,e.imgBack=null,e.imgParagraph=[],e.paragraph=0,e.cfg=new ao,e.imgTitle=e.cfg.titleFont.createTextImage(e.cfg.title),e.titleRelX=e.cfg.titleWindow.x+(e.cfg.titleWindow.w-e.imgTitle.width)/2,e.titleRelY=e.cfg.titleWindow.y,e.btnNext=e.addChild(new pr(e,e.cfg.nextButtonCfg)),e.btnNext.onClick=function(){return e.nextParagraph()},e.btnBack=e.addChild(new pr(e,e.cfg.backButtonCfg)),e.btnBack.onClick=function(){return e.prevParagraph()},e.hidden=!0,e}return so(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.hidden=!0,this.setParagraph(0)},e.prototype.setup=function(t,e){var n=this;this.imgBack=_t.getImageOrNull(e.filename),this.xIn=e.x,this.yIn=e.y,this.width=this.imgBack.width,this.height=this.imgBack.height,this.updatePosition(),this.imgParagraph=t.split("\\a").map((function(t){return n.cfg.textFont.createTextImage(t,n.cfg.textWindow.w,!1)}))},e.prototype.setParagraph=function(t){if(!(t<0)){if(t>this.imgParagraph.length-1)return this.hide(),void this.notifyRedraw();this.paragraph=t,this.btnNext.hidden=this.paragraph>=this.imgParagraph.length-1,this.btnBack.hidden=this.paragraph<1,this.notifyRedraw()}},e.prototype.nextParagraph=function(){this.setParagraph(this.paragraph+1)},e.prototype.prevParagraph=function(){this.setParagraph(this.paragraph-1)},e.prototype.show=function(){var e;t.prototype.show.call(this),this.setParagraph(0),this.btnNext.hidden=this.paragraph>=this.imgParagraph.length-1,this.btnBack.hidden=this.paragraph<1,null===(e=this.messagePanel)||void 0===e||e.setMessage(this.messagePanel.msgSpaceToContinue,0)},e.prototype.hide=function(){var e;t.prototype.hide.call(this),null===(e=this.messagePanel)||void 0===e||e.unsetMessage(this.messagePanel.msgSpaceToContinue)},e.prototype.onRedraw=function(e){this.hidden||(this.imgBack&&e.drawImage(this.imgBack,this.x,this.y),this.imgTitle&&e.drawImage(this.imgTitle,this.x+this.titleRelX,this.y+this.titleRelY),this.imgParagraph&&this.imgParagraph[this.paragraph]&&e.drawImage(this.imgParagraph[this.paragraph],this.x+this.cfg.textWindow.x,this.y+this.cfg.textWindow.y),t.prototype.onRedraw.call(this,e))},e}(dr),co=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),lo=function(t){function e(e,n){var r=t.call(this,e)||this;return r.labelX=0,r.state=!1,r.relX=n.x,r.relY=n.y,r.labelX=n.width,r.imgTextNormal=e.loFont.createTextImage(n.description),r.imgTextHover=e.hiFont.createTextImage(n.description),r.imgLabelOffNormal=e.loFont.createTextImage(n.labelOff),r.imgLabelOffHover=e.hiFont.createTextImage(n.labelOff),r.imgLabelOnNormal=e.loFont.createTextImage(n.labelOn),r.imgLabelOnHover=e.hiFont.createTextImage(n.labelOn),r.width=n.width+Math.max(r.imgLabelOnHover.width,r.imgLabelOffHover.width),r.height=r.imgTextNormal.height,r}return co(e,t),e.prototype.onClick=function(){this.state=!this.state,console.log("TODO: cycle item clicked; state: "+this.state)},e.prototype.checkHover=function(e,n){var r=t.prototype.checkHover.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.checkClick=function(e,n){var r=t.prototype.checkClick.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.checkRelease=function(e,n){var r=t.prototype.checkRelease.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.release=function(){var e=t.prototype.release.call(this);return e&&this.notifyRedraw(),e},e.prototype.onRedraw=function(e){if(!this.hidden){var n=this.imgTextNormal,r=this.state?this.imgLabelOnNormal:this.imgLabelOffNormal;this.hover&&(n=this.imgTextHover,r=this.state?this.imgLabelOnHover:this.imgLabelOffHover),e.drawImage(n,this.x,this.y),e.drawImage(r,this.x+this.labelX,this.y),t.prototype.onRedraw.call(this,e)}},e}(lr),ho=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),po=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.target=n.target,i.loImg=e.loFont.createTextImage(n.label),i.hiImg=e.hiFont.createTextImage(n.label),i.width=i.loImg.width,i.height=i.loImg.height,i.relX=r?-e.relX+(e.menuImage.width-i.width)/2:n.x,i.relY=n.y,i}return ho(e,t),e.prototype.checkHover=function(e,n){var r=t.prototype.checkHover.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.checkClick=function(e,n){var r=t.prototype.checkClick.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.checkRelease=function(e,n){var r=t.prototype.checkRelease.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.release=function(){var e=t.prototype.release.call(this);return e&&this.notifyRedraw(),e},e.prototype.onRedraw=function(e){this.hidden||(this.hover?e.drawImage(this.hiImg,this.x,this.y):e.drawImage(this.loImg,this.x,this.y),t.prototype.onRedraw.call(this,e))},e}(lr),fo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),yo=function(t){function e(e,n){var r=t.call(this,e)||this;r.sliderX=0,r.min=0,r.max=1,r.value=0,r.onValueChanged=function(t){return console.log("value changed to: "+t)},r.relX=n.x,r.relY=n.y,r.sliderX=n.width,r.imgLeft=_t.getImage(n.imgLeft),r.imgNormal=_t.getImage(n.imgOff),r.imgHover=_t.getImage(n.imgOn),r.imgRight=_t.getImage(n.imgRight);var i=r.addChild(new pr(r,new or));i.imgNormal=_t.getImage(n.btnLeftNormal),i.imgHover=_t.getImage(n.btnLeftHover),i.relX=r.sliderX-r.imgLeft.width-i.imgHover.width,i.width=i.imgHover.width,i.height=i.imgHover.height,i.updatePosition(),i.onClick=function(){r.value>r.min&&(r.value--,r.onValueChanged(r.value))};var o=r.addChild(new pr(r,new or));return o.imgNormal=_t.getImage(n.btnRightNormal),o.imgHover=_t.getImage(n.btnRightHover),o.relX=r.sliderX+r.imgNormal.width+2*r.imgRight.width,o.width=o.imgHover.width,o.height=o.imgHover.height,o.updatePosition(),o.onClick=function(){r.value<r.max&&(r.value++,r.onValueChanged(r.value))},r.width=n.width+i.imgHover.width+r.imgLeft.width+r.imgNormal.width+2*r.imgRight.width+o.imgHover.width,r.min=n.min,r.max=n.max||1,r.value=r.min,r.imgTextNormal=e.loFont.createTextImage(n.description),r.imgTextHover=e.hiFont.createTextImage(n.description),r.height=r.imgTextNormal.height,r}return fo(e,t),e.prototype.checkHover=function(e,n){var r=t.prototype.checkHover.call(this,e,n);return r&&this.notifyRedraw(),r},e.prototype.onRedraw=function(e){if(!this.hidden){var n=this.imgTextNormal;this.hover&&(n=this.imgTextHover),e.drawImage(n,this.x,this.y);var r=this.x+this.sliderX;e.drawImage(this.imgLeft,r,this.y),e.drawImage(this.imgNormal,r,this.y);var i=Math.round(this.value/this.max*this.imgHover.width);e.drawImage(this.imgHover,0,0,i,this.imgHover.height,r,this.y,i,this.imgHover.height),r+=this.imgNormal.width,e.drawImage(this.imgRight,r,this.y),t.prototype.onRedraw.call(this,e)}},e}(lr),go=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),vo=function(t){function e(e,n){var r=t.call(this,e)||this;return r.itemsTrigger=[],r.itemsNext=[],r.relX=n.position[0],r.relY=n.position[1],r.menuImage=_t.getImageOrNull(n.menuImage[0]),r.titleImage=_t.getBitmapFont(n.menuFont).createTextImage(n.fullName),r.loFont=_t.getBitmapFont(n.loFont),r.hiFont=_t.getBitmapFont(n.hiFont),n.itemsLabel.forEach((function(t){var e=r.addChild(new po(r,t,n.autoCenter));"trigger"===t.actionName.toLowerCase()?r.itemsTrigger.push(e):r.itemsNext.push(e)})),n.itemsCycle.forEach((function(t){return r.addChild(new lo(r,t))})),n.itemsSlider.forEach((function(t){return r.addChild(new yo(r,t))})),r.hidden=!0,r}return go(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.hidden=!0},e.prototype.onRedraw=function(e){this.hidden||(e.drawImage(this.menuImage,(this.parent.width-this.menuImage.width)/2,(this.parent.height-this.menuImage.height)/2),e.drawImage(this.titleImage,(this.parent.width-this.titleImage.width)/2,this.y),t.prototype.onRedraw.call(this,e))},e}(lr),mo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),wo=function(t){function e(e,n){var r=t.call(this)||this;r.layersByKey=new Map,r.width=e.fixedWidth,r.height=e.fixedHeight,r.hidden=!0,n.menus.forEach((function(t,e){return r.layersByKey.set("menu"+(e+1),r.addChild(new vo(r,t)))}));var i=r;return r.layersByKey.forEach((function(t){return t.itemsNext.forEach((function(t){return t.onClick=function(){return i.selectLayer(t.target)}}))})),r}return mo(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.hidden=!0},e.prototype.show=function(){this.hidden=!1,this.selectLayer("menu1")},e.prototype.hide=function(){t.prototype.hide.call(this),this.notifyRedraw()},e.prototype.selectLayer=function(t){var e=this.layersByKey.get(t.toLowerCase());this.layersByKey.forEach((function(t){return t!==e&&t.hide()})),e.show(),this.notifyRedraw()},e}(dr),bo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),_o=function(t){function e(e,n){var r=t.call(this,e,n)||this;r.onRepeatBriefing=function(){return console.log("repeat mission briefing")};var i=r;return r.layersByKey.get("menu1").itemsTrigger[0].onClick=function(){return i.onRepeatBriefing()},r.layersByKey.get("menu1").itemsTrigger[1].onClick=function(){return i.hide()},r}return bo(e,t),e}(wo),Oo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Eo=function(t){function e(e,n){var r=t.call(this,e,n)||this;r.onRepeatBriefing=function(){return console.log("repeat mission briefing")},r.onAbortGame=function(){return console.log("abort mission")},r.onRestartGame=function(){return console.log("restart mission")};var i=r;return r.layersByKey.get("menu1").itemsTrigger[0].onClick=function(){return i.hide()},r.layersByKey.get("menu2").itemsTrigger[0].onClick=function(){return i.onRepeatBriefing()},r.layersByKey.get("menu3").itemsTrigger[0].onClick=function(){return i.onAbortGame()},r.layersByKey.get("menu4").itemsTrigger[0].onClick=function(){return i.onRestartGame()},r}return Oo(e,t),e}(wo),Po=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),To=function(t){function e(){var e=t.call(this)||this;return e.panelPause=e.addPanel(new Eo(e,_t.getResource("PausedMenu"))),e.panelOptions=e.addPanel(new _o(e,_t.getResource("OptionsMenu"))),e.panelBriefing=e.addPanel(new uo),e.panelPause.onRepeatBriefing=function(){return e.setActivePanel(e.panelBriefing)},e.panelOptions.onRepeatBriefing=function(){return e.setActivePanel(e.panelBriefing)},e}return Po(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.setActivePanel(this.panelBriefing)},e.prototype.setup=function(t,e){this.panelBriefing.setup(t,e)},e.prototype.handlePointerEvent=function(e){return!this.panels.every((function(t){return t.hidden}))&&(t.prototype.handlePointerEvent.call(this,e)||!0)},e.prototype.handleKeyEvent=function(t){var e=!1,n=t.key.toLowerCase();return t.eventEnum===Nn.UP&&("escape"===n?this.panelBriefing.hidden&&this.panelOptions.hidden&&(this.panelPause.hidden?this.setActivePanel(this.panelPause):this.panelPause.hide(),e=!0):" "===n&&(this.panelBriefing.hidden||(this.panelBriefing.nextParagraph(),e=!0))),e},e.prototype.setActivePanel=function(t){s.publishEvent(new w(q.Pointer_Standard)),this.panels.forEach((function(e){return e!==t&&e.hide()})),t.show(),this.redraw()},e}($i),So=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Io=function(t){function e(){var e=t.call(this,!0)||this;return e.selectStart=null,e}return So(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.selectStart=null},e.prototype.setWorldManager=function(t){this.worldManager=t},e.prototype.handlePointerEvent=function(t){if(!ie.buildModeSelection){var e=this.toCanvasCoords(t.clientX,t.clientY),n=e[0],r=e[1];if(t.eventEnum===kn.DOWN){if(t.button===Dn.MAIN)return this.startSelection(n,r)}else{if(t.eventEnum===kn.MOVE)return this.changeSelection(n,r);if(t.eventEnum===kn.UP&&t.button===Dn.MAIN)return this.selectEntities(n,r)}return!1}},e.prototype.startSelection=function(t,e){return this.selectStart={x:t,y:e},!0},e.prototype.changeSelection=function(t,e){return!!this.selectStart&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="rgba(128, 192, 192, 0.5)",this.context.lineWidth=2,this.context.strokeRect(this.selectStart.x,this.selectStart.y,t-this.selectStart.x,e-this.selectStart.y),!0)},e.prototype.selectEntities=function(t,e){if(!this.selectStart)return!1;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var n=this.selectStart.x/this.canvas.width*2-1,r=-this.selectStart.y/this.canvas.height*2+1,i=t/this.canvas.width*2-1,o=-e/this.canvas.height*2+1;if(Math.abs(t-this.selectStart.x)<5&&Math.abs(e-this.selectStart.y)<5){var a=(this.selectStart.x+t)/this.canvas.width-1,s=-(this.selectStart.y+e)/this.canvas.height+1;this.worldManager.sceneManager.selectEntitiesByRay(a,s)}else this.worldManager.sceneManager.selectEntitiesInFrustum(n,r,i,o);return this.selectStart=null,!0},e}(Un),Co=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ro=function(t){function e(){var e=t.call(this)||this;return e.onLevelEnd=function(){return console.log("Level aborted")},e.gameLayer=e.addLayer(new rr,0),e.selectionLayer=e.addLayer(new Io,10),e.guiLayer=e.addLayer(new eo,20),e.overlayLayer=e.addLayer(new To,30),e.worldManager=new jn(e.gameLayer.canvas),e.gameLayer.setWorldManager(e.worldManager),e.selectionLayer.setWorldManager(e.worldManager),e.jobSupervisor=new fe(e.worldManager),e.guiLayer.onOptionsShow=function(){return e.overlayLayer.panelOptions.show()},e.overlayLayer.panelBriefing.messagePanel=e.guiLayer.panelMessages,e.overlayLayer.panelPause.onAbortGame=function(){return e.onLevelEnd()},e.overlayLayer.panelPause.onRestartGame=function(){return e.restartLevel()},e}return Co(e,t),e.prototype.startLevel=function(t){if(this.levelName=t,this.levelConf=_t.getResource("Levels").levelsByName[this.levelName],!this.levelConf)throw'Could not find level configuration for "'+this.levelName+'"';this.setupAndStartLevel()},e.prototype.restartLevel=function(){this.hide(),ie.reset(),this.setupAndStartLevel()},e.prototype.setupAndStartLevel=function(){console.log("Starting level "+this.levelName+" - "+this.levelConf.fullName),this.worldManager.setup(this.levelConf,this);var t=N(_t.getResource(this.levelConf.objectiveText),this.levelName);this.guiLayer.reset(),this.overlayLayer.setup(t.objective,this.levelConf.objectiveImage640x480),this.show()},e.prototype.show=function(){t.prototype.show.call(this),this.worldManager.start(),this.jobSupervisor.start()},e.prototype.hide=function(){this.worldManager.stop(),this.jobSupervisor.stop(),t.prototype.hide.call(this)},e.prototype.resize=function(e,n){t.prototype.resize.call(this,e,n),this.worldManager&&this.worldManager.resize(e,n)},e}(Kn),Lo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ao=function(t){function e(){var e=t.call(this)||this;return e.assetIndex=0,e.layer=e.addLayer(new Wn),e}return Lo(e,t),e.prototype.show=function(){var t=this;this.layers.forEach((function(e){e!==t.cursorLayer&&e.show()})),this.setLoadingMessage("Loading...")},e.prototype.setLoadingMessage=function(t){var e=this;this.layer.onRedraw=function(n){n.fillStyle="black",n.fillRect(0,0,e.layer.fixedWidth,e.layer.fixedHeight),n.font="24px Arial",n.fillStyle="white",n.fillText("Loading Rock Raiders",20,e.layer.fixedHeight-50),n.font="18px Arial",n.fillStyle="white",n.fillText(t,20,e.layer.fixedHeight-20)},this.redraw()},e.prototype.enableGraphicMode=function(t){var e=this,n=_t.getImage(_t.cfg("Main","LoadScreen")),r=_t.getImage(_t.cfg("Main","ProgressBar")),i=_t.getDefaultFont().createTextImage(_t.cfg("Main","LoadingText"));this.layer.onRedraw=function(o){o.drawImage(n,0,0);var a=353*(e.assetIndex<t?Math.round(e.assetIndex/t):1);o.drawImage(r,142,450,a,9),o.drawImage(i,Math.round(320-i.width/2),Math.round(456-i.height/2))},this.cursorLayer.show(),this.redraw()},e.prototype.increaseLoadingState=function(){this.assetIndex++,this.redraw()},e}(Kn),Mo=function(){function t(){this.x=0,this.y=0,this.width=0,this.height=0,this.zIndex=100,this.scrollAffected=!1,this.needsRedraw=!1,this.hover=!1,this.pressed=!1,this.actionName="",this.targetIndex=0}return t.compareZ=function(t,e){return t.zIndex===e.zIndex?0:t.zIndex>e.zIndex?-1:1},t.prototype.checkHover=function(t,e){var n=t>=this.x&&t<this.x+this.width&&e>=this.y&&e<this.y+this.height;return this.hover!==n&&(this.hover=n,this.needsRedraw=!0,this.onHoverChange()),this.hover||(this.pressed=!1),this.hover},t.prototype.onHoverChange=function(){},t.prototype.checkSetPressed=function(){this.hover&&(this.pressed||(this.needsRedraw=!0),this.pressed=!0)},t.prototype.setReleased=function(){this.pressed&&(this.needsRedraw=!0),this.pressed=!1},t.prototype.draw=function(t){this.needsRedraw=!1},t}(),xo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Do=function(t){function e(e,n){var r=t.call(this)||this;return r.imgNormal=null,r.imgHover=null,r.imgPressed=null,r.tooltip="",r.imgNormal=_t.getImage(n.imgNormal),r.imgHover=_t.getImage(n.imgHover),r.imgPressed=_t.getImage(n.imgPressed),r.tooltip=(n.tooltip||"").replace(/_/g," "),r.width=Math.max(r.imgNormal.width,r.imgHover.width,r.imgPressed.width),r.height=Math.max(r.imgNormal.height,r.imgHover.height,r.imgPressed.height),r.x=e.cfg.autoCenter?(e.fixedWidth-r.width)/2:e.cfg.position[0]+n.x,r.y=e.cfg.position[1]+n.y,r.actionName=n.actionName,"Next"===r.actionName&&(r.targetIndex=Number(n.target.substring("menu".length))-1),r}return xo(e,t),e.prototype.draw=function(e){t.prototype.draw.call(this,e);var n=this.imgNormal;this.hover&&(n=this.imgHover),this.pressed&&(n=this.imgPressed),e.drawImage(n,this.x,this.y)},e}(Mo),ko=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),No=function(t){function e(e,n){var r=t.call(this)||this;return r.labelImgLo=null,r.labelImgHi=null,r.labelImgLo=e.loFont.createTextImage(n.label),r.labelImgHi=e.hiFont.createTextImage(n.label),r.width=Math.max(r.labelImgLo.width,r.labelImgHi.width),r.height=Math.max(r.labelImgLo.height,r.labelImgHi.height),r.x=e.cfg.autoCenter?(e.fixedWidth-r.width)/2:e.cfg.position[0]+n.x,r.y=e.cfg.position[1]+n.y,r.actionName=n.actionName,"Next"===r.actionName&&(r.targetIndex=Number(n.target.substring("menu".length))-1),r}return ko(e,t),e.prototype.draw=function(e){t.prototype.draw.call(this,e);var n=this.hover&&!this.pressed?this.labelImgHi:this.labelImgLo;e.drawImage(n,this.x,this.y)},e}(Mo),Bo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),jo=function(t){function e(e,n){var r=t.call(this)||this;return r.items=[],r.scrollY=0,r.scrollSpeedY=0,r.scrollInterval=null,r.screen=e,r.cfg=n,r.loFont=n.loFont?_t.getBitmapFont(n.loFont):null,r.hiFont=n.hiFont?_t.getBitmapFont(n.hiFont):null,r.menuImage=n.menuImage?_t.getImage(n.menuImage):null,r.titleImage=r.loFont.createTextImage(n.fullName),n.itemsLabel.forEach((function(t){t.label?r.items.push(new No(r,t)):r.items.push(new Do(r,t))})),r.items.sort((function(t,e){return Mo.compareZ(t,e)})),r.onRedraw=function(t){t.drawImage(r.menuImage,0,-r.scrollY),n.displayTitle&&t.drawImage(r.titleImage,(r.fixedWidth-r.titleImage.width)/2,r.cfg.position[1]),r.items.forEach((function(e,n){return r.items[r.items.length-1-n].draw(t)}))},r}return Bo(e,t),e.prototype.reset=function(){t.prototype.reset.call(this),this.scrollY=0,this.scrollSpeedY=0},e.prototype.show=function(){t.prototype.show.call(this);var e=this;this.scrollInterval=setInterval((function(){0!==e.scrollSpeedY&&e.setScrollY(e.scrollSpeedY)}),33.333333333333336)},e.prototype.hide=function(){this.scrollInterval=G(this.scrollInterval),t.prototype.hide.call(this)},e.prototype.handlePointerEvent=function(t){var e=this;if(t.eventEnum===kn.MOVE){var n=this.toScaledCoords(t.clientX,t.clientY),r=n[0],i=n[1],o=!1;if(this.items.forEach((function(t){if(o)t.hover&&(t.needsRedraw=!0),t.hover=!1,t.setReleased();else{var n=i+(t.scrollAffected?e.scrollY:0);o=t.checkHover(r,n)}})),this.cfg.canScroll){var a=100;i<a?this.setScrollSpeedY(-(a-i)):i>this.fixedHeight-a?this.setScrollSpeedY(i-(this.fixedHeight-a)):this.setScrollSpeedY(0)}}else t.eventEnum===kn.DOWN?t.button===Dn.MAIN&&this.items.forEach((function(t){return t.checkSetPressed()})):t.eventEnum===kn.UP&&t.button===Dn.MAIN&&this.items.forEach((function(t){t.pressed&&(t.setReleased(),"next"===t.actionName.toLowerCase()?e.screen.showMainMenu(t.targetIndex):"selectlevel"===t.actionName.toLowerCase()?e.screen.selectLevel(t.levelKey):t.actionName&&console.warn("not implemented: "+t.actionName+" - "+t.targetIndex))}));return this.needsRedraw()&&this.redraw(),!1},e.prototype.setScrollSpeedY=function(t){this.scrollSpeedY=Math.sign(t)*Math.pow(Math.round(t/20),2)},e.prototype.handleWheelEvent=function(t){return!!this.cfg.canScroll&&(this.setScrollY(t.deltaY),!0)},e.prototype.setScrollY=function(t){var e=this.scrollY;this.scrollY=Math.min(Math.max(this.scrollY+t,0),this.menuImage.height-this.fixedHeight),e!==this.scrollY&&this.redraw()},e.prototype.needsRedraw=function(){return this.items.some((function(t){return t.needsRedraw}))},e}(Wn),Fo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Uo=function(t){function e(e,n,r){var i=t.call(this)||this;i.imgActive=null,i.imgInactive=null,i.imgCross=null,i.unlocked=!1,i.levelKey="",i.layer=e,i.actionName="selectlevel",i.levelKey=n,i.x=r.frontEndX,i.y=r.frontEndY,i.zIndex=10,i.scrollAffected=!0;var o=r.menuBMP,a=o[0],s=o[1],u=o[2];return i.imgActive=_t.getImage(a),i.imgInactive=_t.getImage(s),i.imgCross=_t.getImage(u),i.width=Math.max(i.imgActive.width,i.imgInactive.width,i.imgCross.width),i.height=Math.max(i.imgActive.height,i.imgInactive.height,i.imgCross.height),i.unlocked=r.frontEndOpen,i.unlocked=!0,i}return Fo(e,t),e.prototype.draw=function(e){t.prototype.draw.call(this,e);var n=this.imgCross;this.unlocked&&(n=this.hover?this.imgActive:this.imgInactive),e.drawImage(n,this.x,this.y-this.layer.scrollY)},e}(Mo),Wo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ho=function(t){function e(e,n){var r=t.call(this)||this;return r.zIndex=50,r.context=V(e.width,e.height),r.context.putImageData(e,0,0),r.x=n.x,r.y=n.y,r.width=n.w,r.height=n.h,r}return Wo(e,t),e.prototype.checkHover=function(t,e){var n=t>=this.x&&t<this.x+this.width&&e>=this.y&&e<this.y+this.height&&this.context.getImageData(t,e,1,1).data[3]>0;return this.hover!==n&&(this.needsRedraw=!0),this.hover=n,this.hover},e.prototype.draw=function(e){t.prototype.draw.call(this,e),e.drawImage(this.context.canvas,this.x,this.y,this.width,this.height)},e}(Mo),Go=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Jo=function(t){function e(e,n){var r=t.call(this)||this;return r.imgFirstLine=null,r.imgSecondLine=null,r.font=e,r.x=n.x,r.y=n.y,r.width=n.w,r.height=n.h,r}return Go(e,t),e.prototype.setFirstLine=function(t){this.imgFirstLine=t?this.font.createTextImage(t):null},e.prototype.setSecondLine=function(t){this.imgSecondLine=t?this.font.createTextImage(t):null},e.prototype.draw=function(e){t.prototype.draw.call(this,e);var n=this.x+this.width/2,r=this.y+this.height/2;this.imgFirstLine&&e.drawImage(this.imgFirstLine,n-this.imgFirstLine.width/2,r-this.imgFirstLine.height),this.imgSecondLine&&e.drawImage(this.imgSecondLine,n-this.imgSecondLine.width/2,r)},e}(Mo),Vo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Yo=function(t){function e(e,n,r){var i=t.call(this,e,n)||this,o=_t.getResource("Levels"),a=new Xo;i.items.push(new Ho(a.panelImgData,a.panelPos));var s=new Jo(_t.getDefaultFont(),a.window);return s.setFirstLine(r?a.level:a.tutorial),i.items.push(s),Object.keys(o.levelsByName).forEach((function(t){var e=o.levelsByName[t],n=new Uo(i,t,e);n.onHoverChange=function(){return s.setSecondLine(n.hover?e.fullName:"")},i.items.push(n)})),i.items.sort((function(t,e){return Mo.compareZ(t,e)})),i}return Vo(e,t),e}(jo),Xo=function(){this.window={x:0,y:0,w:0,h:0},this.panelPos={x:0,y:0,w:0,h:0},this.level="",this.tutorial="";var t=_t.cfg("Menu","LevelText"),e=N(t,"Window");this.window={x:e[0],y:e[1],w:e[2],h:e[3]};var n=N(t,"Panel");this.panelImgData=_t.getImageData(n[0]),this.panelPos={x:n[1],y:n[2],w:n[3],h:n[4]},this.level=N(t,"Level").join(",").replace(/_/g," "),this.tutorial=N(t,"Tutorial").join(",").replace(/_/g," ")},Ko=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),qo=function(t){function e(){var e=t.call(this)||this;return e.onLevelSelected=null,e.menus=[],_t.getResource("MainMenuFull").menus.forEach((function(t){var n;n="Levels"===t.title?new Yo(e,t,!0):"Tutorials"===t.title?new Yo(e,t,!1):new jo(e,t),e.menus.push(n),e.addLayer(n)})),e}return Ko(e,t),e.prototype.showMainMenu=function(t){void 0===t&&(t=0),this.hide(),this.menus[t].show(),this.cursorLayer.show()},e.prototype.showLevelSelection=function(){this.showMainMenu(1)},e.prototype.selectLevel=function(t){this.hide(),this.onLevelSelected(t)},e}(Kn),zo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Zo=function(t){function e(e){var n,r,i,o,a=t.call(this)||this;return a.disabled=!1,a.visible=!0,n=e[0],r=e[1],i=e[2],o=e[3],a.x=e[4],a.y=e[5],a.imgNormal=_t.getImage(n),a.imgHover=_t.getImage(r),a.imgPressed=_t.getImage(i),a.imgDisabled=_t.getImage(o),a.width=a.imgNormal.width,a.height=a.imgNormal.height,a}return zo(e,t),e.prototype.draw=function(e){if(t.prototype.draw.call(this,e),this.visible){var n=this.imgNormal;this.disabled?n=this.imgDisabled:this.pressed?n=this.imgPressed:this.hover&&(n=this.imgHover),e.drawImage(n,this.x,this.y)}},e}(Mo),Qo=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),$o=function(t){function e(){var e=t.call(this)||this;e.cfg=null,e.resultIndex=0,e.resultLastIndex=0,e.images=[],e.boxes=[],e.fonts={},e.texts=[],e.uncoverTimeout=null,e.cfg=_t.getResource("Reward"),e.titleFont=_t.getBitmapFont(e.cfg.titleFont);var n=_t.getImage(e.cfg.wallpaper);return e.addLayer(new Wn).onRedraw=function(t){return t.drawImage(n,0,0)},e.cfg.images.forEach((function(t){e.images.push({img:_t.getImage(t.filePath),x:t.x,y:t.y})})),e.cfg.boxImages.forEach((function(t){e.boxes.push({img:_t.getImage(t.filePath),x:t.x,y:t.y})})),Object.keys(e.cfg.fonts).forEach((function(t,n){var r=_t.getBitmapFont(e.cfg.fonts[t]);e.fonts[t.toLowerCase()]=r;var i=e.cfg.texts[n],o=n<9?r:_t.getBitmapFont(e.cfg.backFont);e.texts.push(o.createTextImage(i.text))})),e.resultsLayer=e.addLayer(new Wn),e.resultsLayer.handlePointerEvent=function(t){return t.eventEnum===kn.UP&&(e.uncoverTimeout=H(e.uncoverTimeout),e.uncoverTimeout=null,e.resultIndex=e.resultLastIndex,e.btnSave.visible=!0,e.btnAdvance.visible=!0,e.redraw(),!0)},e.descriptionTextLayer=e.addLayer(new Wn,20),e.btnLayer=e.addLayer(new Wn,50),e.btnSave=new Zo(e.cfg.saveButton),e.btnSave.disabled=!0,e.btnAdvance=new Zo(e.cfg.advanceButton),e.btnLayer.handlePointerEvent=function(t){if(t.eventEnum===kn.MOVE){var n=e.btnLayer.toScaledCoords(t.clientX,t.clientY),r=n[0],i=n[1];e.btnSave.checkHover(r,i),e.btnAdvance.checkHover(r,i)}else t.eventEnum===kn.DOWN?t.button===Dn.MAIN&&(e.btnSave.checkSetPressed(),e.btnAdvance.checkSetPressed()):t.eventEnum===kn.UP&&t.button===Dn.MAIN&&(e.btnSave.pressed?e.btnSave.setReleased():e.btnAdvance.pressed&&(e.btnAdvance.setReleased(),e.hide(),e.onAdvance()));return(e.btnSave.needsRedraw||e.btnAdvance.needsRedraw)&&e.redraw(),!1},e.btnLayer.onRedraw=function(t){e.btnSave.draw(t),e.btnAdvance.draw(t)},e}return Qo(e,t),e.prototype.show=function(){var e=this;this.resultIndex=0,this.btnSave.visible=!1,this.btnAdvance.visible=!1,this.uncoverResult();var n=this.titleFont.createTextImage(ie.levelFullName),r=this.cfg.quitText;this.resultLastIndex=this.images.length-2,ie.resultState===Ut.COMPLETE?(r=this.cfg.completeText,this.resultLastIndex=this.images.length-1):ie.resultState===Ut.FAILED&&(r=this.cfg.failedText);var i=[];i.push(this.fonts.crystals.createTextImage(this.percentString(ie.numCrystal,ie.neededCrystals))),i.push(this.fonts.ore.createTextImage(this.percentString(ie.numOre,ie.totalOres))),i.push(this.fonts.diggable.createTextImage(this.percentString(ie.remainingDiggables,ie.totalDiggables,!0))),i.push(this.fonts.constructions.createTextImage(ie.buildings.length.toString())),i.push(this.fonts.caverns.createTextImage(this.percentString(ie.discoveredCaverns,ie.totalCaverns))),i.push(this.fonts.figures.createTextImage(this.percentString(ie.raiders.length,ie.getMaxRaiders()))),i.push(this.fonts.rockmonsters.createTextImage(this.percentString(0))),i.push(this.fonts.oxygen.createTextImage(this.percentString(ie.airLevel))),i.push(this.fonts.timer.createTextImage(this.timeString(ie.gameTimeSeconds))),i.push(this.fonts.score.createTextImage(this.percentString(ie.score)));var o=this.titleFont.createTextImage(r);this.resultsLayer.onRedraw=function(t){t.clearRect(0,0,e.resultsLayer.fixedWidth,e.resultsLayer.fixedHeight);for(var r=0;r<=e.resultIndex;r++){var a=e.images[r];a&&t.drawImage(a.img,a.x,a.y)}for(r=0;r<=e.resultIndex;r++){var s=e.boxes[r];s&&t.drawImage(s.img,s.x,s.y)}for(r=0;r<=e.resultIndex;r++){var u=e.cfg.texts[r],c=i[r];c&&t.drawImage(c,u.x-c.width/2,u.y)}t.drawImage(n,e.resultsLayer.fixedWidth/2-n.width/2,e.cfg.vertSpacing-n.height/2),t.drawImage(o,e.resultsLayer.fixedWidth/2-o.width/2,e.cfg.vertSpacing+n.height/2)},this.descriptionTextLayer.onRedraw=function(t){var n=e.texts[e.resultIndex];t.clearRect(0,e.cfg.textPos[1],e.descriptionTextLayer.fixedWidth,e.descriptionTextLayer.fixedHeight-e.cfg.textPos[1]);var r=e.resultIndex!==e.images.length-1?e.cfg.textPos[0]:305,i=e.resultIndex!==e.images.length-1?e.cfg.textPos[1]:195;t.drawImage(n,r-n.width/2,i)},t.prototype.show.call(this)},e.prototype.percentString=function(t,e,n){void 0===e&&(e=1),void 0===n&&(n=!1),0===e&&(e=1);var r=Math.round(100*Math.max(Math.min(t/e,1),0));return n&&(r=100-r),r.toString()+"%"},e.prototype.padLeft=function(t,e,n){for(void 0===e&&(e="0"),void 0===n&&(n=2);t.length<n;)t=e+t;return t},e.prototype.timeString=function(t){var e=this.padLeft((t%60).toString()),n=Math.floor(t/60),r=this.padLeft((n%60).toString());return this.padLeft(Math.floor(n/60).toString())+":"+r+":"+e},e.prototype.uncoverResult=function(){var t=this;this.uncoverTimeout=setTimeout((function(){t.uncoverTimeout=null,t.resultIndex++,t.resultIndex<t.resultLastIndex?t.uncoverResult():(t.btnSave.visible=!0,t.btnAdvance.visible=!0),t.redraw()}),1e3*this.cfg.timer)},e}(Kn),ta=new Ao,ea=new i.WadFileSelectionModal("game-container");ea.onStart=function(t,e){_t.startLoadingFromUrl(t,e)},_t.onMessage=function(t){ta.setLoadingMessage(t)},_t.onCacheMissed=function(){ea.show()},_t.onInitialLoad=function(t){ea.hide(),ta.enableGraphicMode(t)},_t.onAssetLoaded=function(){ta.increaseLoadingState()},_t.onLoadDone=function(){var t=new qo,e=new Ro,n=new $o;t.onLevelSelected=function(n){try{e.startLevel(n)}catch(r){console.error("Could not load level: "+n,r),e.hide(),t.showLevelSelection()}},e.onLevelEnd=function(){e.hide(),n.show()},n.onAdvance=function(){ie.reset(),t.showLevelSelection()},ta.hide(),new URLSearchParams(window.location.search).get("entry"),t.showMainMenu()},ta.show(),_t.startLoadingFromCache()}}]);
//# sourceMappingURL=426.index.js.map