(self.webpackChunkrock_raiders_web=self.webpackChunkrock_raiders_web||[]).push([[274,990,694,372],{662:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var i=s(15),r=s.n(i),n=s(645),a=s.n(n)()(r());a.push([e.id,".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n","",{version:3,sources:["webpack://./site/clearcache/clearCacheButton.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,kBAAkB;IAClB,OAAO;IACP,MAAM;AACV",sourcesContent:[".clear-cache-box {\n    z-index: 2000;\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n"],sourceRoot:""}]);const o=a},27:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var i=s(15),r=s.n(i),n=s(645),a=s.n(n)()(r());a.push([e.id,".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n","",{version:3,sources:["webpack://./site/github/github.css"],names:[],mappings:"AAAA;IACI,aAAa;IACb,aAAa;IACb,kBAAkB;IAClB,MAAM;IACN,QAAQ;IACR,oCAAoC;IACpC,WAAW;AACf;;AAEA;IACI,WAAW;IACX,qBAAqB;IACrB,YAAY;AAChB;;AAEA;IACI,WAAW;IACX,0BAA0B;AAC9B;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iBAAiB;IACjB,sBAAsB;AAC1B",sourcesContent:[".github-box {\n    z-index: 2000;\n    padding: 16px;\n    position: absolute;\n    top: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.6);\n    color: #fff;\n}\n\n.github-box a {\n    color: #fff;\n    text-decoration: none;\n    padding: 8px;\n}\n\n.github-box a:hover {\n    color: #fff;\n    text-decoration: underline;\n}\n\n.github-logo {\n    width: 16px;\n    height: 16px;\n    margin-right: 8px;\n    vertical-align: middle;\n}\n"],sourceRoot:""}]);const o=a},372:(e,t,s)=>{"use strict";s.r(t),s.d(t,{ClearCacheButton:()=>o});var i=s(848),r=s(379),n=s.n(r),a=s(662);n()(a.Z,{insert:"head",singleton:!1}),a.Z.locals;class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("clear-cache-box");const t=this.rootElement.appendChild(document.createElement("button"));t.classList.add("btn","btn-info"),t.innerText="Clear cached wad files and restart",t.onclick=()=>{indexedDB.deleteDatabase(i.UV),location.reload()}}hide(){this.rootElement.style.visibility="hidden"}}},990:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GithubBox:()=>o});var i=s(379),r=s.n(i),n=s(27);r()(n.Z,{insert:"head",singleton:!1}),n.Z.locals;var a=s(351);class o{constructor(e){this.rootElement=document.getElementById(e).appendChild(document.createElement("div")),this.rootElement.classList.add("github-box");const t=this.rootElement.appendChild(document.createElement("a"));t.href="https://github.com/scarabol/rock-raiders-web";const s=t.appendChild(document.createElement("img"));s.src=a,s.classList.add("github-logo"),s.alt="Fork on GitHub",t.appendChild(document.createElement("span")).textContent=s.alt}hide(){this.rootElement.style.visibility="hidden"}}},694:(e,t,s)=>{"use strict";s.r(t),s.d(t,{WadFileSelectionModal:()=>r});var i=s(169);class r{constructor(e){this.onStart=null;const t=document.getElementById(e).appendChild(document.createElement("div"));t.classList.add("modal"),t.tabIndex=-1,t.setAttribute("role","dialog"),t.setAttribute("aria-hidden","true");const s=t.appendChild(document.createElement("div"));s.classList.add("modal-dialog"),t.setAttribute("role","document");const n=s.appendChild(document.createElement("div"));n.classList.add("modal-content");const a=n.appendChild(document.createElement("div"));a.classList.add("modal-header");const o=a.appendChild(document.createElement("h5"));o.classList.add("modal-title"),o.innerText="Load .wad files",o.id="wadfileSelectModalLabel",t.setAttribute("aria-labelledby",o.id);const l=n.appendChild(document.createElement("div"));l.classList.add("modal-body"),l.appendChild(document.createElement("p")).innerText="Assets not included! In order to play the game, please select the game files.";const h=l.appendChild(document.createElement("nav")).appendChild(document.createElement("div"));h.id="nav-tab",h.classList.add("nav","nav-tabs"),h.setAttribute("role","tablist");const c=r.appendNavButton(h,!0,"nav-file-tab","nav-file","Local files (recommended)"),u=r.appendNavButton(h,!1,"nav-url-tab","nav-url","Online from URL"),d=l.appendChild(document.createElement("div"));d.classList.add("tab-content"),this.appendNavFileTab(d,c.id),this.appendNavUrlTab(d,u.id),this.modal=new i.u_(t,{backdrop:"static",keyboard:!1})}static appendNavButton(e,t,s,i,r){const n=e.appendChild(document.createElement("button"));return n.classList.add("nav-link"),t&&n.classList.add("active"),n.id=s,n.setAttribute("data-bs-toggle","tab"),n.setAttribute("data-bs-target","#"+i),n.type="button",n.setAttribute("role","tab"),n.setAttribute("aria-controls",i),n.setAttribute("aria-selected",String(t)),n.innerText=r,n}appendNavFileTab(e,t){const s=r.appendNavTab(e,!0,"nav-file",t),i=r.appendWadFileGroup(s,"wad0-file","LegoRR0.wad"),n=r.appendWadFileGroup(s,"wad1-file","LegoRR1.wad"),a=s.appendChild(document.createElement("button"));a.type="submit",a.classList.add("btn","btn-primary","float-end"),a.id="button-start-file",a.innerText="Start Game",a.addEventListener("click",(()=>{a.disabled=!0;const e=URL.createObjectURL(i.files[0]),t=URL.createObjectURL(n.files[0]);this.onStart(e,t)}))}static appendWadFileGroup(e,t,s){const i=e.appendChild(document.createElement("div"));i.classList.add("my-3");const r=i.appendChild(document.createElement("label"));r.setAttribute("for",t),r.classList.add("form-label"),r.innerHTML='Select <span class="fw-bold">'+s+"</span> here:";const n=i.appendChild(document.createElement("input"));return n.type="file",n.classList.add("form-control"),n.id=t,n.required=!0,n}appendNavUrlTab(e,t){const s=r.appendNavTab(e,!1,"nav-url",t),i=s.appendChild(document.createElement("div"));i.classList.add("my-3"),i.innerText="Direct links with correct Allow-Origin-CORS-Headers required here.";const n=r.appendWadUrlGroup(s,"wad0-url","LegoRR0.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),a=r.appendWadUrlGroup(s,"wad1-url","LegoRR1.wad","https://drive.google.com/uc?export=download&id=11t9AJnGCWnEWlLxSsYQeB_Y4jrKfxVxQ"),o=s.appendChild(document.createElement("button"));o.type="submit",o.classList.add("btn","btn-primary","float-end"),o.id="button-start-url",o.innerText="Start Game",o.addEventListener("click",(()=>{o.disabled=!0,this.onStart(n.value,a.value)}))}static appendNavTab(e,t,s,i){const r=e.appendChild(document.createElement("div"));return r.classList.add("tab-pane","fade"),t&&r.classList.add("show","active"),r.id=s,r.setAttribute("role","tabpanel"),r.setAttribute("aria-labelledby",i),r}static appendWadUrlGroup(e,t,s,i){const r=e.appendChild(document.createElement("div"));r.classList.add("my-3");const n=r.appendChild(document.createElement("label"));n.setAttribute("for",t),n.classList.add("form-label"),n.innerHTML='Enter url for <span class="fw-bold">'+s+"</span> here:";const a=r.appendChild(document.createElement("input"));return a.type="url",a.classList.add("form-control"),a.id=t,a.required=!0,a.value=i,a}show(){this.modal.show()}hide(){this.modal.hide()}}},538:(e,t,s)=>{"use strict";function i(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const s=t.lastIndexOf("/");return t=t.substring(0,s+1),t.startsWith("/")&&(t=t.substring(1)),t}function r(e){if(!e)return e;let t=e.toString().replace(/\\/g,"/");t.startsWith("/")&&(t=t.substring(1));const s=t.lastIndexOf("/");return t.substring(s+1)}function n(e,...t){return t.forEach((t=>{e=(e=Object.keys(e).filter((e=>e.toLowerCase()===t.toLowerCase())).map((t=>e[t])))?e[0]:e})),e}function a(e){return(new TextDecoder).decode(e).replace(/\0/g,"")}function o(e){return a(e).replace(/\\/g,"/")}function l(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function h(e){return l(0,e)}function c(){return 2*l(0,1)-1}function u(e){return e&&clearTimeout(e),null}function d(e){return e&&clearInterval(e),null}s.d(t,{DW:()=>i,vt:()=>r,hh:()=>n,v5:()=>a,jG:()=>o,$u:()=>l,sZ:()=>h,kz:()=>c,L4:()=>u,nJ:()=>d}),Array.prototype.add=function(e){-1===this.indexOf(e)&&this.push(e)},Array.prototype.remove=function(e){const t=this.indexOf(e);-1!==t&&this.splice(t,1)},Array.prototype.last=function(){return this.length>0?this[this.length-1]:void 0},Array.prototype.count=function(e){let t=0;return this.forEach((s=>e(s)&&t++)),t},Array.prototype.partition=function(e){const t=[],s=[];return this.forEach((i=>e(i)?t.push(i):s.push(i))),[t,s]},Array.prototype.random=function(){if(this.length)return this[h(this.length-1)]},Map.prototype.getOrUpdate=function(e,t){let s=this.get(e);return void 0===s&&(s=t(),this.set(e,s)),s},String.prototype.equalsIgnoreCase=function(e){return this.toLowerCase()===(null==e?void 0:e.toLowerCase())}},274:(e,t,s)=>{"use strict";s.r(t);var i=s(372),r=s(990),n=s(694),a=s(538);class o{static reset(){this.numCrystal=0,this.numOre=0,this.numBrick=0,this.usedCrystals=0,this.neededCrystals=0,this.airLevel=1,this.requestedRaiders=0,this.totalCrystals=0,this.totalOres=0,this.totalDiggables=0,this.remainingDiggables=0,this.totalCaverns=0,this.discoveredCaverns=0,this.levelStartTime=0,this.levelStopTime=0}static get gameTimeSeconds(){return Math.round((o.levelStopTime-o.levelStartTime)/1e3)}}o.numCrystal=0,o.numOre=0,o.numBrick=0,o.usedCrystals=0,o.neededCrystals=0,o.airLevel=1,o.requestedRaiders=0,o.totalCrystals=0,o.totalOres=0,o.totalDiggables=0,o.remainingDiggables=0,o.totalCaverns=0,o.discoveredCaverns=0,o.levelStartTime=0,o.levelStopTime=0;var l=s(848),h=s(212),c=s(344),u=s(768);class d{constructor(){this.scale=1,this.carryNullName="",this.carryNullFrames=0,this.depositNullName="",this.toolNullName="",this.wheelMesh=null,this.wheelRadius=1,this.wheelNullName=null,this.drillNullName=null,this.driverNullName=null,this.cameraNullName=null,this.cameraNullFrames=null,this.mediumPolyBodies=new Map,this.highPolyBodies=new Map,this.fPPolyBodies=new Map,this.animations=new Map,this.upgradesByLevel=new Map}}class g{constructor(e,t,s){this.upgradeFilepath=e,this.upgradeNullName=t,this.upgradeNullIndex=s}}var p=s(309);class y{constructor(){this.looping=!1,this.transcoef=1,this.firstFrame=null,this.lastFrame=null,this.framesPerSecond=null,this.bodies=[],this.polyList=[],this.carryJoint=null,this.depositJoint=null,this.getToolJoint=null,this.wheelJoints=[],this.drillJoint=null,this.driverJoint=null,this.nullJoints=new Map,this.polyModel=new h.ZAu,this.animationTimeout=null,this.sfxAudioByFrame=new Map}animate(e,t,s){if(this.polyList.length!==this.bodies.length)throw"Cannot animate poly. Length differs from bodies length";this.bodies.forEach(((t,s)=>{const i=this.polyList[s];if(i.position.copy(t.relPos[e]).sub(t.pivot),i.rotation.copy(t.relRot[e]),i.scale.copy(t.relScale[e]),i.hasOwnProperty("material")){const s=i.material,r=t.opacity[e];s&&void 0!==r&&(Array.isArray(s)?s:[s]).forEach((e=>e.setOpacity(r)))}})),this.playAudio(e),this.animationTimeout=(0,a.L4)(this.animationTimeout);let i=e+1;if(i<=this.lastFrame||!t||null!==s&&s>0){i>this.lastFrame&&(i=this.firstFrame);const e=1e3/this.framesPerSecond*this.transcoef;null!==s&&(s-=e);const r=this,n=null!==s?Math.max(0,Math.min(s,e)):e;this.animationTimeout=setTimeout((()=>r.animate(i,t,s)),n)}else t&&(this.stopAudio(),t())}stop(){this.animationTimeout=(0,a.L4)(this.animationTimeout),this.stopAudio()}playAudio(e){this.sfxAudioByFrame.getOrUpdate(e,(()=>[])).forEach((e=>{e.isPlaying&&e.stop(),e.play()}))}stopAudio(){this.sfxAudioByFrame.forEach((e=>e.forEach((e=>e.isPlaying&&e.stop()))))}}var m=h.M8C.degToRad;class v{constructor(){this.lowerName="",this.filename="",this.pivot=new h.Pa4(0,0,0),this.relPos=[],this.relRot=[],this.relScale=[],this.opacity=[],this.parentObjInd=null,this.model=null,this.isNull=!1,this.sfxName=null,this.sfxFrames=[]}radVec(e,t,s){return new h.USm(m(t),m(e),m(s),"YXZ")}setFrameAndFollowing(e,t,s){this.relPos[e]=new h.Pa4(s[0],s[1],s[2]),this.relRot[e]=this.radVec(s[3],s[4],s[5]),this.relScale[e]=new h.Pa4(s[6],s[7],s[8]);for(let s=e;s<=t;s++)this.relPos[s]=this.relPos[e],this.relRot[s]=this.relRot[e],this.relScale[s]=this.relScale[e]}setOpacityAndFollowing(e,t,s){for(let i=e;i<=t;i++)this.opacity[i]=s}}var f=s(886);const w=s(466);class E{constructor(){this.stats=new w,this.stats.setMode(0),this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement),this.hide()}show(){this.stats.domElement.style.visibility="visible"}hide(){this.stats.domElement.style.visibility="hidden"}renderStart(){this.stats.begin()}renderDone(){this.stats.end()}}var b,S=s(320);class M{static publishEvent(e){this.blockedEvents.includes(e.eventKey)||(e.isLocal||console.log("Event published: "+S.Z[e.eventKey]),this.blockedEvents.push(e.eventKey),this.workerListener.forEach((t=>t(e))),this.getListener(e.eventKey).forEach((t=>t(e))),this.blockedEvents.remove(e.eventKey))}static registerEventListener(e,t){this.getListener(e).push(t)}static getListener(e){return this.eventListener.getOrUpdate(e,(()=>[]))}static registerWorkerListener(e){this.workerListener.push(e)}}M.eventListener=new Map,M.workerListener=[],M.blockedEvents=[],function(e){e[e.PILOT=0]="PILOT",e[e.TOOLSTATION=1]="TOOLSTATION",e[e.TELEPORT_PAD=2]="TELEPORT_PAD",e[e.DOCKS=3]="DOCKS",e[e.POWER_STATION=4]="POWER_STATION",e[e.BARRACKS=5]="BARRACKS",e[e.UPGRADE=6]="UPGRADE",e[e.GEODOME=7]="GEODOME",e[e.ORE_REFINERY=8]="ORE_REFINERY",e[e.GUNSTATION=9]="GUNSTATION",e[e.TELEPORT_BIG=10]="TELEPORT_BIG",e[e.BAT=11]="BAT",e[e.SMALL_SPIDER=12]="SMALL_SPIDER",e[e.ROCK_MONSTER=13]="ROCK_MONSTER",e[e.ICE_MONSTER=14]="ICE_MONSTER",e[e.LAVA_MONSTER=15]="LAVA_MONSTER",e[e.DYNAMITE=16]="DYNAMITE",e[e.ELECTRIC_FENCE=17]="ELECTRIC_FENCE",e[e.CRYSTAL=18]="CRYSTAL",e[e.ORE=19]="ORE",e[e.BRICK=20]="BRICK",e[e.BARRIER=21]="BARRIER",e[e.HOVERBOARD=22]="HOVERBOARD",e[e.SMALL_DIGGER=23]="SMALL_DIGGER",e[e.SMALL_TRUCK=24]="SMALL_TRUCK",e[e.SMALL_CAT=25]="SMALL_CAT",e[e.SMALL_MLP=26]="SMALL_MLP",e[e.SMALL_HELI=27]="SMALL_HELI",e[e.BULLDOZER=28]="BULLDOZER",e[e.WALKER_DIGGER=29]="WALKER_DIGGER",e[e.LARGE_MLP=30]="LARGE_MLP",e[e.LARGE_DIGGER=31]="LARGE_DIGGER",e[e.LARGE_CAT=32]="LARGE_CAT",e[e.TV_CAMERA=33]="TV_CAMERA"}(b||(b={}));var T,L=s(505);class A{constructor(e={}){this.shaping=!1,this.matIndex="00",this.floor=!1,this.selectable=!1,this.digable=!1,this.reinforcable=!1,this.cursor=L.C.Pointer_Standard,this.cursorFulfiller=L.C.Pointer_Standard,this.statsDrillName=null,this.canCarryFence=!1,this.connectsPath=!1,this.mapSurfaceColor="#00FFFF",Object.assign(this,e)}static getByNum(e){switch(e){case 0:return A.POWER_PATH_BUILDING;case 1:return A.SOLID_ROCK;case 2:return A.HARD_ROCK;case 3:return A.LOOSE_ROCK;case 4:case 5:return A.DIRT;case 6:return A.LAVA;case 8:return A.ORE_SEAM;case 9:return A.WATER;case 10:return A.CRYSTAL_SEAM;case 11:return A.RECHARGE_SEAM;case 30:case 40:return A.SLUG_HOLE;case 100:return A.RUBBLE4;case 101:return A.RUBBLE3;case 102:return A.RUBBLE2;case 103:return A.RUBBLE1;default:return console.error("Unexpected surface type num: "+e),A.SOLID_ROCK}}}A.GROUND=new A({name:"ground",floor:!0,selectable:!0,canCarryFence:!0,cursorFulfiller:L.C.Pointer_LegoManGo,mapSurfaceColor:"#280048"}),A.SOLID_ROCK=new A({name:"solid rock",shaping:!0,matIndex:"5",cursor:L.C.Pointer_SurfaceType_Immovable,mapSurfaceColor:"#500090"}),A.HARD_ROCK=new A({name:"hard rock",shaping:!0,matIndex:"4",selectable:!0,digable:!0,reinforcable:!0,cursor:L.C.Pointer_SurfaceType_Hard,statsDrillName:"HardDrillTime",mapSurfaceColor:"#7000B0"}),A.LOOSE_ROCK=new A({name:"loose rock",shaping:!0,matIndex:"3",selectable:!0,digable:!0,reinforcable:!0,cursor:L.C.Pointer_SurfaceType_Medium,statsDrillName:"LooseDrillTime",mapSurfaceColor:"#9000D0"}),A.DIRT=new A({name:"dirt",shaping:!0,matIndex:"2",selectable:!0,digable:!0,reinforcable:!0,cursor:L.C.Pointer_SurfaceType_Loose,statsDrillName:"SoilDrillTime",mapSurfaceColor:"#B000F0"}),A.SLUG_HOLE=new A({name:"slug hole",floor:!0,matIndex:"30",mapSurfaceColor:"#280048"}),A.LAVA=new A({name:"lava",floor:!0,matIndex:"46"}),A.ORE_SEAM=new A({name:"ore seam",matIndex:"40",selectable:!0,digable:!0,reinforcable:!0,cursor:L.C.Pointer_SurfaceType_OreSeam,statsDrillName:"SeamDrillTime"}),A.WATER=new A({name:"water",floor:!0,matIndex:"45",mapSurfaceColor:"#000080"}),A.CRYSTAL_SEAM=new A({name:"energy crystal seam",matIndex:"20",selectable:!0,digable:!0,reinforcable:!0,cursor:L.C.Pointer_SurfaceType_CrystalSeam,statsDrillName:"SeamDrillTime"}),A.RECHARGE_SEAM=new A({name:"recharge seam",matIndex:"67",cursor:L.C.Pointer_SurfaceType_RechargeSeam}),A.POWER_PATH=new A({name:"power path all",floor:!0,matIndex:"60",selectable:!0,canCarryFence:!0,connectsPath:!0,mapSurfaceColor:"#FFFF00"}),A.POWER_PATH_BUILDING_SITE=new A({name:"power path building site",floor:!0,matIndex:"61",selectable:!0,canCarryFence:!0}),A.POWER_PATH_BUILDING=new A({name:"power path building",floor:!0,matIndex:"76",connectsPath:!0,mapSurfaceColor:"#B8BBB8"}),A.POWER_PATH_CONSTRUCTION=new A({name:"power path construction",floor:!0,matIndex:"76",selectable:!0,connectsPath:!0,mapSurfaceColor:"#B8BBB8"}),A.RUBBLE1=new A({name:"rubble 1",floor:!0,matIndex:"13",selectable:!0,canCarryFence:!0,cursorFulfiller:L.C.Pointer_Clear,mapSurfaceColor:"#280048"}),A.RUBBLE2=new A({name:"rubble 2",floor:!0,matIndex:"12",selectable:!0,canCarryFence:!0,cursorFulfiller:L.C.Pointer_Clear,mapSurfaceColor:"#280048"}),A.RUBBLE3=new A({name:"rubble 3",floor:!0,matIndex:"11",selectable:!0,canCarryFence:!0,cursorFulfiller:L.C.Pointer_Clear,mapSurfaceColor:"#280048"}),A.RUBBLE4=new A({name:"rubble 4",floor:!0,matIndex:"10",selectable:!0,canCarryFence:!0,cursorFulfiller:L.C.Pointer_Clear,mapSurfaceColor:"#280048"}),function(e){e[e.NONE=0]="NONE",e[e.DRILL=1]="DRILL",e[e.HAMMER=2]="HAMMER",e[e.SHOVEL=3]="SHOVEL",e[e.SPANNER=4]="SPANNER",e[e.FREEZERGUN=5]="FREEZERGUN",e[e.LASER=6]="LASER",e[e.PUSHERGUN=7]="PUSHERGUN",e[e.BIRDSCARER=8]="BIRDSCARER"}(T||(T={}));const R=[T.DRILL,T.HAMMER,T.SHOVEL,T.SPANNER,T.FREEZERGUN,T.LASER,T.PUSHERGUN,T.BIRDSCARER];var C;!function(e){e[e.NONE=0]="NONE",e[e.DRIVER=1]="DRIVER",e[e.ENGINEER=2]="ENGINEER",e[e.GEOLOGIST=3]="GEOLOGIST",e[e.PILOT=4]="PILOT",e[e.SAILOR=5]="SAILOR",e[e.DEMOLITION=6]="DEMOLITION"}(C||(C={}));const P=[C.DRIVER,C.ENGINEER,C.GEOLOGIST,C.PILOT,C.SAILOR,C.DEMOLITION],I=[];I[C.DRIVER]=b.BARRACKS,I[C.DRIVER]=b.BARRACKS,I[C.ENGINEER]=b.UPGRADE,I[C.GEOLOGIST]=b.GEODOME,I[C.PILOT]=b.TELEPORT_PAD,I[C.SAILOR]=b.DOCKS,I[C.DEMOLITION]=b.TOOLSTATION;const x=[];x[C.DRIVER]="TrainDriver",x[C.ENGINEER]="TrainRepair",x[C.GEOLOGIST]="TrainScanner",x[C.PILOT]="TrainPilot",x[C.SAILOR]="TrainSailor",x[C.DEMOLITION]="TrainDynamite";class O{constructor(e){this.x=e.x,this.y=e.y,this.surfaceColor=e.surfaceType.mapSurfaceColor,this.borderColor=e.reinforced?"#FFFF00":null}}var D,N,_,k=s(722);class B extends k.Z{constructor(e){super(e),this.isLocal=!0}}!function(e){e[e.NONE=0]="NONE",e[e.RAIDER=1]="RAIDER",e[e.VEHICLE=2]="VEHICLE",e[e.BUILDING=3]="BUILDING",e[e.SURFACE=4]="SURFACE"}(D||(D={}));class F extends B{constructor(e){var t,s,i,r,n,a,o,l,h,c,u,d;super(S.Z.SELECTION_CHANGED),this.selectPanelType=D.NONE,this.canDoTraining=new Map,this.everyHasTool=new Map,e&&(this.selectPanelType=e.selection.getSelectPanelType(),this.isGround=(null===(t=e.selection.surface)||void 0===t?void 0:t.surfaceType)===A.GROUND,this.isPowerPath=(null===(s=e.selection.surface)||void 0===s?void 0:s.surfaceType)===A.POWER_PATH,this.isFloor=null===(i=e.selection.surface)||void 0===i?void 0:i.surfaceType.floor,this.isSite=(null===(r=e.selection.surface)||void 0===r?void 0:r.surfaceType)===A.POWER_PATH_CONSTRUCTION||(null===(n=e.selection.surface)||void 0===n?void 0:n.surfaceType)===A.POWER_PATH_BUILDING_SITE,this.hasRubble=null===(a=e.selection.surface)||void 0===a?void 0:a.hasRubble(),this.isDrillable=null===(o=e.selection.surface)||void 0===o?void 0:o.isDigable(),this.isReinforcable=null===(l=e.selection.surface)||void 0===l?void 0:l.isReinforcable(),this.canPlaceFence=(null===(h=e.selection.surface)||void 0===h?void 0:h.canPlaceFence())&&e&&e.buildings.some((e=>e.entityType===b.POWER_STATION&&e.isUsable())),this.someCarries=!!e.selection.raiders.some((e=>!!e.carries)),this.everyHasMaxLevel=!!e.selection.raiders.every((e=>e.level>=e.stats.Levels)),P.forEach((t=>this.canDoTraining.set(t,e&&e.getTrainingSites(t).length>0&&e.selection.raiders.some((e=>!e.hasTraining(t)))))),R.forEach((t=>this.everyHasTool.set(t,!!e.selection.raiders.every((e=>e.hasTool(t)))))),this.buildingCanUpgrade=null===(c=e.selection.building)||void 0===c?void 0:c.canUpgrade(),this.buildingCanSwitchPower=!(null===(u=e.selection.building)||void 0===u?void 0:u.stats.SelfPowered)&&!(null===(d=e.selection.building)||void 0===d?void 0:d.stats.PowerBuilding),this.vehicleHasCallManJob=e.selection.vehicles.every((e=>!!e.callManJob)),this.allVehicleEmpty=e.selection.vehicles.every((e=>!e.driver)))}}class U extends F{constructor(){super(null)}}class W extends B{constructor(e){super(S.Z.AIR_LEVEL_CHANGED),this.airLevel=e}}class G extends B{constructor(e){super(S.Z.SETUP_PRIORITY_LIST),this.priorityList=e}}class H extends B{constructor(e){super(S.Z.BUILDINGS_CHANGED),this.usableBuildingsByTypeAndLevel=new Map,e.buildings.forEach((e=>{if(e.isUsable()){const t=this.usableBuildingsByTypeAndLevel.getOrUpdate(e.entityType,(()=>new Map));t.set(e.level,t.getOrUpdate(e.level,(()=>0))+1)}}))}static countUsable(e,t,s=0){let i=0;return e.usableBuildingsByTypeAndLevel.getOrUpdate(t,(()=>new Map)).forEach(((e,t)=>{t>=s&&(i+=e)})),i}}class J extends B{constructor(e,t=null){super(S.Z.RAIDERS_CHANGED),this.numRaiders=e.raiders.length,this.training=t}}class V extends B{constructor(){super(S.Z.VEHICLES_CHANGED)}}class q extends B{constructor(e,t){super(S.Z.UPDATE_RADAR_TERRAIN),this.surfaces=[],e.forEachSurface((e=>{e.discovered&&this.surfaces.push(new O(e))})),this.tileX=Math.floor(t.x/l.pM),this.tileY=Math.floor(t.z/l.pM)}}class j extends B{constructor(e){super(S.Z.UPDATE_RADAR_SURFACE),this.surfaceRect=new O(e)}}class Z extends B{}class K extends Z{constructor(){super(S.Z.COMMAND_CANCEL_BUILD_MODE)}}class Y{constructor(e,t){this.location=e,this.heading=e.clone().sub(t).angle(),e.y===t.y?this.heading-=Math.PI/2:this.heading+=Math.PI/2}}class z extends k.Z{constructor(e){super(e),this.isLocal=!1}}class X extends z{constructor(e,t){super(e),this.guiForward=!1,this.job=t}}class $ extends X{constructor(e){super(S.Z.JOB_CREATE,e)}}class Q extends X{constructor(e){super(S.Z.JOB_DELETE,e)}}class ee extends z{constructor(e){super(S.Z.REQUESTED_RAIDERS_CHANGED),this.numRequestedRaiders=e}}class te extends z{constructor(){super(S.Z.MATERIAL_AMOUNT_CHANGED),this.numCrystal=o.numCrystal,this.usedCrystal=o.usedCrystals,this.neededCrystal=o.neededCrystals,this.totalOre=o.numOre+5*o.numBrick}}class se extends z{constructor(){super(S.Z.CAVERN_DISCOVERED)}}class ie extends z{constructor(){super(S.Z.ORE_FOUND)}}class re{constructor(e){this.activityKey=e}}class ne extends re{}ne.Stand=new ne("Activity_Stand");class ae extends ne{}ae.Short=new ne("Short"),ae.Expand=new ne("Expand"),ae.Long=new ne("Long"),ae.Teleport=new ne("Teleport");class oe extends ne{}oe.Route=new oe("Activity_Route"),oe.RunPanic=new oe("Activity_RunPanic"),oe.Drill=new oe("Activity_Drill"),oe.Walk=new oe("!Activity_Walk"),oe.Reinforce=new oe("Activity_Reinforce"),oe.Reverse=new oe("!Activity_Reverse"),oe.TurnLeft=new oe("!Activity_TurnLeft"),oe.TurnRight=new oe("!Activity_TurnRight"),oe.CantDo=new oe("!Activity_CantDo"),oe.Collect=new oe("Activity_Collect"),oe.Clear=new oe("Activity_Clear"),oe.Carry=new oe("Activity_Carry"),oe.CarryTurnLeft=new oe("!Activity_CarryTurnLeft"),oe.CarryTurnRight=new oe("!Activity_CarryTurnRight"),oe.CarryStand=new oe("Activity_CarryStand"),oe.Dynamite=new oe("Activity_Dynamite"),oe.Place=new oe("Activity_Place"),oe.Deposit=new oe("!Activity_Deposit"),oe.TeleportIn=new oe("Activity_TeleportIn"),oe.Repair=new oe("Activity_Repair"),oe.rest=new oe("Activity_rest"),oe.routeRubble=new oe("!Activity_routeRubble"),oe.CarryRubble=new oe("!Activity_CarryRubble"),oe.Eat=new oe("Activity_Eat"),oe.FireLaser=new oe("Activity_FireLaser"),oe.GetUp=new oe("!Activity_GetUp"),oe.ThrownByRockMonster=new oe("Activity_ThrownByRockMonster"),oe.Slip=new oe("Activity_Slip"),oe.Train=new oe("Activity_Train"),oe.Recharge=new oe("!Activity_Recharge"),oe.Waiting1=new oe("Activity_Waiting1"),oe.Waiting2=new oe("Activity_Waiting2"),oe.Waiting3=new oe("Activity_Waiting3"),oe.Waiting4=new oe("Activity_Waiting4"),oe.Hoverboard=new oe("Activity_Hoverboard"),oe.Standhoverboard=new oe("Activity_Standhoverboard"),oe.HitLefthoverboard=new oe("!Activity_HitLefthoverboard"),oe.HitRighthoverboard=new oe("!Activity_HitRighthoverboard"),oe.HitFronthoverboard=new oe("!Activity_HitFronthoverboard"),oe.HitBackhoverboard=new oe("!Activity_HitBackhoverboard"),oe.SMALLTRUCK=new oe("Activity_SMALLTRUCK"),oe.StandSMALLTRUCK=new oe("Activity_StandSMALLTRUCK"),oe.HitLeftSMALLTRUCK=new oe("!Activity_HitLeftSMALLTRUCK"),oe.HitRightSMALLTRUCK=new oe("!Activity_HitRightSMALLTRUCK"),oe.HitFrontSMALLTRUCK=new oe("!Activity_HitFrontSMALLTRUCK"),oe.HitBackSMALLTRUCK=new oe("!Activity_HitBackSMALLTRUCK"),oe.SMALLheli=new oe("Activity_SMALLheli"),oe.StandSMALLheli=new oe("Activity_StandSMALLheli"),oe.HitLeftSMALLheli=new oe("!Activity_HitLeftSMALLheli"),oe.HitRightSMALLheli=new oe("!Activity_HitRightSMALLheli"),oe.HitFrontSMALLheli=new oe("!Activity_HitFrontSMALLheli"),oe.HitBackSMALLheli=new oe("!Activity_HitBackSMALLheli"),oe.SMALLCAT=new oe("Activity_SMALLCAT"),oe.StandSMALLCAT=new oe("Activity_StandSMALLCAT"),oe.HitLeftSMALLCAT=new oe("!Activity_HitLeftSMALLCAT"),oe.HitRightSMALLCAT=new oe("!Activity_HitRightSMALLCAT"),oe.HitFrontSMALLCAT=new oe("!Activity_HitFrontSMALLCAT"),oe.HitBackSMALLCAT=new oe("!Activity_HitBackSMALLCAT"),oe.SMALLMLP=new oe("Activity_SMALLMLP"),oe.StandSMALLMLP=new oe("Activity_StandSMALLMLP"),oe.HitLeftSMALLMLP=new oe("!Activity_HitLeftSMALLMLP"),oe.HitRightSMALLMLP=new oe("!Activity_HitRightSMALLMLP"),oe.HitFrontSMALLMLP=new oe("!Activity_HitFrontSMALLMLP"),oe.HitBackSMALLMLP=new oe("!Activity_HitBackSMALLMLP"),oe.LARGECAT=new oe("Activity_LARGECAT"),oe.StandLARGECAT=new oe("Activity_StandLARGECAT"),oe.HitLeftLARGECAT=new oe("!Activity_HitLeftLARGECAT"),oe.HitRightLARGECAT=new oe("!Activity_HitRightLARGECAT"),oe.HitFrontLARGECAT=new oe("!Activity_HitFrontLARGECAT"),oe.HitBackLARGECAT=new oe("!Activity_HitBackLARGECAT"),oe.SMALLDIGGER=new oe("Activity_SMALLDIGGER"),oe.StandSMALLDIGGER=new oe("Activity_StandSMALLDIGGER");class le{constructor(e){this.targetLocation=e}canGatherItem(){return!1}gatherItem(e){e.addToScene(null,null)}getDropAction(){return oe.Place}}!function(e){e[e.aiPriorityTrain=0]="aiPriorityTrain",e[e.aiPriorityGetIn=1]="aiPriorityGetIn",e[e.aiPriorityCrystal=2]="aiPriorityCrystal",e[e.aiPriorityOre=3]="aiPriorityOre",e[e.aiPriorityRepair=4]="aiPriorityRepair",e[e.aiPriorityClearing=5]="aiPriorityClearing",e[e.aiPriorityDestruction=6]="aiPriorityDestruction",e[e.aiPriorityConstruction=7]="aiPriorityConstruction",e[e.aiPriorityReinforce=8]="aiPriorityReinforce",e[e.aiPriorityRecharge=9]="aiPriorityRecharge"}(N||(N={})),function(e){e[e.INCOMPLETE=0]="INCOMPLETE",e[e.COMPLETE=1]="COMPLETE",e[e.CANCELED=2]="CANCELED"}(_||(_={}));class he{constructor(){this.jobState=_.INCOMPLETE}getRequiredTool(){return T.NONE}getRequiredTraining(){return C.NONE}isReadyToComplete(){return!0}onJobComplete(){this.jobState=_.COMPLETE}setActualWorkplace(e){}getCarryItem(){return null}getWorkActivity(){return null}getWorkDuration(e){return null}}class ce extends he{constructor(){super(...arguments),this.fulfiller=[]}assign(e){const t=this.fulfiller.indexOf(e);e&&-1===t&&this.fulfiller.push(e)}unAssign(e){this.fulfiller.remove(e)}cancel(){this.jobState=_.CANCELED;const e=this.fulfiller;this.fulfiller=[],e.forEach((e=>e.stopJob()))}}class ue extends ce{constructor(e,t){super(),this.surface=e,this.placedItems=t,this.workplaces=[new le(e.getRandomPosition())]}onJobComplete(){super.onJobComplete(),this.placedItems.forEach((e=>e.removeFromScene())),this.surface.setSurfaceType(A.POWER_PATH)}getRequiredTool(){return T.SHOVEL}getPriorityIdentifier(){return N.aiPriorityConstruction}getWorkplaces(){return this.workplaces}getWorkActivity(){return oe.Clear}}class de{constructor(e,t,s,i,r,n){this.primarySurface=null,this.secondarySurface=null,this.primaryPathSurface=null,this.surfaces=[],this.heading=0,this.neededByType=new Map,this.assignedByType=new Map,this.onSiteByType=new Map,this.complete=!1,this.canceled=!1,this.entityMgr=e,this.primarySurface=t,this.primarySurface.setSite(this),this.surfaces.push(this.primarySurface),this.secondarySurface=s,this.secondarySurface&&(this.secondarySurface.setSite(this),this.surfaces.push(this.secondarySurface)),this.primaryPathSurface=i,this.primaryPathSurface.setSurfaceType(A.POWER_PATH_BUILDING),this.surfaces.push(this.primaryPathSurface),r&&(r.setSurfaceType(A.POWER_PATH_BUILDING),this.surfaces.push(r)),this.building=n}getRandomDropPosition(){return this.primarySurface.getRandomPosition()}needs(e){return this.neededByType.getOrUpdate(e,(()=>0))>this.assignedByType.getOrUpdate(e,(()=>[])).length}assign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).push(e)}unAssign(e){this.assignedByType.getOrUpdate(e.entityType,(()=>[])).remove(e)}addItem(e){const t=this.neededByType.getOrUpdate(e.entityType,(()=>0));this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).length<t?(e.onAddToSite(),this.onSiteByType.getOrUpdate(e.entityType,(()=>[])).push(e),this.checkComplete()):e.resetTarget()}checkComplete(){if(!this.complete&&!this.canceled&&(this.complete=!0,this.neededByType.forEach(((e,t)=>{this.complete=this.complete&&this.onSiteByType.getOrUpdate(t,(()=>[])).length>=e})),this.complete))if(this.entityMgr.buildingSites.remove(this),this.building){this.onSiteByType.getOrUpdate(b.BARRIER,(()=>[])).forEach((e=>{e.changeActivity(ae.Teleport,(()=>e.removeFromScene()))})),this.onSiteByType.getOrUpdate(b.CRYSTAL,(()=>[])).forEach((e=>{e.removeFromScene()})),this.onSiteByType.getOrUpdate(b.ORE,(()=>[])).forEach((e=>{e.removeFromScene()}));const e=this.primarySurface.getCenterWorld2D();this.building.placeDown(e,-this.heading+Math.PI/2,!1)}else{const e=[];this.onSiteByType.forEach((t=>e.push(...t))),M.publishEvent(new $(new ue(this.primarySurface,e)))}}getDropAction(){return oe.Place}cancelSite(){this.entityMgr.buildingSites.remove(this),this.canceled=!0,this.surfaces.forEach((e=>null==e?void 0:e.setSite(null))),this.onSiteByType.forEach((e=>e.forEach((e=>{this.entityMgr.placeMaterial(e,e.getPosition2D())})))),this.onSiteByType.clear(),this.assignedByType.forEach((e=>e.forEach((e=>{e.resetTarget()})))),this.assignedByType.clear(),M.publishEvent(new U)}getWalkOutSurface(){var e;return this.primaryPathSurface||this.primarySurface.neighbors.find((e=>!e.site&&e.isWalkable()))||(null===(e=this.secondarySurface)||void 0===e?void 0:e.neighbors.find((e=>!e.site&&e.isWalkable())))}}var ge,pe=s(586);!function(e){e[e.CORNER=1]="CORNER",e[e.WALL=2]="WALL",e[e.INVERTED_CORNER=3]="INVERTED_CORNER",e[e.WEIRD_CREVICE=20]="WEIRD_CREVICE"}(ge||(ge={}));class ye{static create(e,t,s,i,r,n,a,o,l){let c=0;!t.y||i.y||e!==ge.INVERTED_CORNER&&(e===ge.WALL||e===ge.WEIRD_CREVICE)!==Boolean(s.y)||(c=0),!s.y||r.y||e!==ge.INVERTED_CORNER&&(e===ge.WALL||e===ge.WEIRD_CREVICE)!==Boolean(i.y)||(c=3),!i.y||t.y||e!==ge.INVERTED_CORNER&&(e===ge.WALL||e===ge.WEIRD_CREVICE)!==Boolean(r.y)||(c=2),!r.y||s.y||e!==ge.INVERTED_CORNER&&(e===ge.WALL||e===ge.WEIRD_CREVICE)!==Boolean(t.y)||(c=1),e!==ge.WALL&&e!==ge.WEIRD_CREVICE||(t.y&&i.y&&(c=0),s.y&&r.y&&(c=3));const u=[new h.FM8(0,1),new h.FM8(1,1),new h.FM8(1,0),new h.FM8(0,0)],d=[],g=[];function p(e,t,s){d.push(e,t,s);const i=(new h.Pa4).subVectors(s,t);i.cross((new h.Pa4).subVectors(e,t)),i.normalize(),g.push(i,i,i)}const y=[];s.y===r.y&&(e!==ge.WALL&&e!==ge.WEIRD_CREVICE||s.y&&r.y)?(y.push(0,3,2),y.push(0,2,1),t.y=n,s.y=a,i.y=o,r.y=l,p(t,r,i),p(t,i,s)):(y.push(1,3,2),y.push(1,0,3),t.y=n,s.y=a,i.y=o,r.y=l,p(s,r,i),p(s,t,r));const m=y.map((e=>u[(e+c)%4])),v=new h.u9r;return v.setAttribute("position",new pe.Tl(new Float32Array(18),3).copyVector3sArray(d)),v.setAttribute("normal",new pe.Tl(new Float32Array(18),3).copyVector3sArray(g)),v.setAttribute("uv",new pe.Tl(new Float32Array(12),2).copyVector2sArray(m)),v}}class me extends h.Kj0{constructor(e,t){super(me.geometry,new h.xoR({shininess:0,transparent:!0,opacity:.4,color:t})),this.sceneMgr=e,this.standardColor=t,this.visible=!1}updateState(e,t,s){this.visible=!!e,e&&this.position.set(e.x,0,e.y).multiplyScalar(l.pM).applyAxisAngle(new h.Pa4(0,1,0),-t+Math.PI/2).add(s)}markAsValid(e){const t=e?this.standardColor:5242880;this.material.color.setHex(t)}get surface(){return this.visible?this.sceneMgr.terrain.getSurfaceFromWorld(this.position):null}}me.geometry=ye.create(ge.WALL,new h.Pa4(0,0,0),new h.Pa4(l.pM,0,0),new h.Pa4(l.pM,0,l.pM),new h.Pa4(0,0,l.pM),1,1,1,1);class ve{constructor(e,t,s){this.group=new h.ZAu,this.markers=[],this.buildingMarkerPrimary=null,this.buildingMarkerSecondary=null,this.powerPathMarkerPrimary=null,this.powerPathMarkerSecondary=null,this.waterPathMarker=null,this.heading=0,this.sdx=0,this.sdz=0,this.lastCheck=!1,this.buildModeSelection=null,this.worldMgr=e,this.sceneMgr=t,this.entityMgr=s,this.buildingMarkerPrimary=new me(this.sceneMgr,ve.buildingMarkerColor),this.buildingMarkerSecondary=new me(this.sceneMgr,ve.buildingMarkerColor),this.powerPathMarkerPrimary=new me(this.sceneMgr,ve.pathMarkerColor),this.powerPathMarkerSecondary=new me(this.sceneMgr,ve.pathMarkerColor),this.waterPathMarker=new me(this.sceneMgr,ve.waterMarkerColor),this.addMarker(this.buildingMarkerPrimary),this.addMarker(this.buildingMarkerSecondary),this.addMarker(this.powerPathMarkerPrimary),this.addMarker(this.powerPathMarkerSecondary),this.addMarker(this.waterPathMarker)}addMarker(e){this.group.add(e),this.markers.push(e)}update(e){if(e&&this.buildModeSelection){const t=this.updateAllMarker(e);this.markers.forEach((e=>e.markAsValid(t)))}else this.hideAllMarker()}updateAllMarker(e=null){this.buildingMarkerPrimary.visible=!0,this.buildingMarkerPrimary.position.copy(this.sceneMgr.getFloorPosition(new h.FM8(Math.floor(e.x/l.pM)*l.pM,Math.floor(e.y/l.pM)*l.pM)));const t=e.x-this.buildingMarkerPrimary.position.x-l.pM/2,s=e.y-this.buildingMarkerPrimary.position.z-l.pM/2,i=Math.abs(t)>Math.abs(s)?Math.sign(t):0,r=Math.abs(s)>Math.abs(t)?Math.sign(s):0;if(this.sdx===i&&this.sdz===r)return this.lastCheck;this.sdx=i,this.sdz=r,this.heading=Math.atan2(r,i),this.buildingMarkerSecondary.updateState(this.buildModeSelection.secondaryBuildingPart,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerPrimary.updateState(this.buildModeSelection.primaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.powerPathMarkerSecondary.updateState(this.buildModeSelection.secondaryPowerPath,this.heading,this.buildingMarkerPrimary.position),this.waterPathMarker.updateState(this.buildModeSelection.waterPathSurface,this.heading,this.buildingMarkerPrimary.position);const n=[this.buildingMarkerPrimary,this.buildingMarkerSecondary,this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].filter((e=>e.visible)).map((e=>this.sceneMgr.terrain.getSurfaceFromWorld(e.position))).every((e=>e.surfaceType===A.GROUND));return this.lastCheck=n&&([this.powerPathMarkerPrimary,this.powerPathMarkerSecondary].some((e=>e.visible&&e.surface.neighbors.some((e=>e.surfaceType===A.POWER_PATH))))||!this.buildModeSelection.primaryPowerPath&&this.buildingMarkerPrimary.surface.neighbors.some((e=>e.surfaceType===A.POWER_PATH||this.buildingMarkerSecondary.visible&&this.buildingMarkerSecondary.surface.neighbors.some((e=>e.surfaceType===A.POWER_PATH)))))&&(!this.waterPathMarker.visible||this.waterPathMarker.surface.surfaceType===A.WATER),this.lastCheck}hideAllMarker(){this.markers.forEach((e=>e.visible=!1)),this.lastCheck=!1}createBuildingSite(){if(!this.buildModeSelection||!this.lastCheck)return;const e=this.getBarrierLocations(),t=this.buildModeSelection.stats,s=(null==t?void 0:t.CostCrystal)||0,i=(null==t?void 0:t.CostOre)||0,r=this.buildingMarkerPrimary.surface,n=new de(this.entityMgr,r,this.buildingMarkerSecondary.surface,this.powerPathMarkerPrimary.surface,this.powerPathMarkerSecondary.surface,this.buildModeSelection);n.heading=this.heading,n.neededByType.set(b.BARRIER,e.length),n.neededByType.set(b.CRYSTAL,s),n.neededByType.set(b.ORE,i),this.entityMgr.buildingSites.push(n);const a=this.entityMgr.getClosestBuildingByType(r.getCenterWorld(),b.TOOLSTATION);a&&(a.spawnBarriers(e,n),a.spawnMaterials(b.CRYSTAL,s),a.spawnMaterials(b.ORE,i)),M.publishEvent(new U),M.publishEvent(new K)}getBarrierLocations(){const e=[],t=this.buildingMarkerPrimary.surface.getCenterWorld2D(),s=9*l.pM/20;if(this.buildingMarkerSecondary.visible){const i=this.buildingMarkerSecondary.surface.getCenterWorld2D(),r=Math.sign(i.x-t.x),n=Math.sign(i.y-t.y);0!==r?(e.push(new Y(new h.FM8(t.x-r*s,t.y),t)),e.push(new Y(new h.FM8(t.x,t.y-s),t)),e.push(new Y(new h.FM8(t.x,t.y+s),t)),e.push(new Y(new h.FM8(i.x+r*s,i.y),i)),e.push(new Y(new h.FM8(i.x,i.y-s),i)),e.push(new Y(new h.FM8(i.x,i.y+s),i))):(e.push(new Y(new h.FM8(t.x,t.y-n*s),t)),e.push(new Y(new h.FM8(t.x-s,t.y),t)),e.push(new Y(new h.FM8(t.x+s,t.y),t)),e.push(new Y(new h.FM8(i.x,i.y+n*s),i)),e.push(new Y(new h.FM8(i.x-s,i.y),i)),e.push(new Y(new h.FM8(i.x+s,i.y),i)))}else e.push(new Y(new h.FM8(t.x-s,t.y),t)),e.push(new Y(new h.FM8(t.x,t.y-s),t)),e.push(new Y(new h.FM8(t.x+s,t.y),t)),e.push(new Y(new h.FM8(t.x,t.y+s),t));return e}}ve.buildingMarkerColor=20480,ve.pathMarkerColor=5263360,ve.waterMarkerColor=80;class fe extends le{constructor(e){super(e.getPosition2D()),this.building=e}}class we extends he{assign(e){if(this.raider!==e){if(this.raider)throw"Job already assigned";this.raider=e}}unAssign(e){this.raider===e&&(this.raider=null)}cancel(){var e;this.jobState=_.CANCELED,null===(e=this.raider)||void 0===e||e.stopJob()}}class Ee extends we{constructor(e,t,s){super(),this.entityMgr=e,this.tool=t,this.workplaces=s?[s.getPathTarget()]:this.entityMgr.getBuildingsByType(b.TOOLSTATION).map((e=>new fe(e)))}getWorkplaces(){return this.workplaces.some((e=>!e.building.isUsable()))&&(this.workplaces=this.entityMgr.getBuildingsByType(b.TOOLSTATION).map((e=>new fe(e)))),this.workplaces}onJobComplete(){super.onJobComplete(),this.raider.addTool(this.tool)}}class be extends we{constructor(e){super(),this.target=[new le(e)]}getWorkplaces(){return this.target}}class Se{constructor(){this.surface=null,this.building=null,this.raiders=[],this.vehicles=[]}isEmpty(){return!this.surface&&!this.building&&this.raiders.length<1&&this.vehicles.length<1}set(e){var t,s,i,r;let n=!1;n=Se.syncSelection(this.raiders,e.raiders)||n,n=Se.syncSelection(this.vehicles,e.vehicles)||n,this.building!==e.building&&(null===(t=this.building)||void 0===t||t.deselect(),(null===(s=e.building)||void 0===s?void 0:s.isInSelection())?(this.building=e.building,this.building.select()&&(n=!0)):this.building=null),this.surface!==e.surface&&(null===(i=this.surface)||void 0===i||i.deselect(),(null===(r=e.surface)||void 0===r?void 0:r.isInSelection())?(this.surface=e.surface,this.surface.select()&&(n=!0)):this.surface=null),n&&u.P.playSample(p.d.SFX_Okay)}static syncSelection(e,t){let s=!1;return e.forEach((s=>{-1===t.indexOf(s)&&(e.remove(s),s.deselect())})),t.forEach((t=>{-1===e.indexOf(t)&&t.select()&&(e.push(t),s=!0)})),s}getSelectPanelType(){return this.raiders.length>0?D.RAIDER:this.vehicles.length>0?D.VEHICLE:this.building?D.BUILDING:this.surface?D.SURFACE:void 0}assignSurfaceJob(e){e&&(this.raiders.forEach((t=>{t.isPrepared(e)?t.setJob(e):t.setJob(new Ee(t.entityMgr,e.getRequiredTool(),t.entityMgr.getClosestBuildingByType(t.getPosition(),b.TOOLSTATION)),e)})),this.vehicles.forEach((t=>{t.isPrepared(e)&&t.setJob(e)})))}assignMoveJob(e){e&&(this.raiders.forEach((t=>t.setJob(new be(e)))),this.vehicles.forEach((t=>t.setJob(new be(e)))))}deselectAll(){var e,t;this.raiders.forEach((e=>e.deselect())),this.raiders=[],this.vehicles.forEach((e=>e.deselect())),this.vehicles=[],null===(e=this.building)||void 0===e||e.deselect(),this.building=null,null===(t=this.surface)||void 0===t||t.deselect(),this.surface=null}}function Me(e){let t=e;const s=[];for(;t.parent;)s.unshift(t),t=t.parent;return s}const Te={search(e,t,s,i=null){e.cleanDirty();const r=(i=i||{}).heuristic||Te.heuristics.manhattan,n=i.closest||!1,a=new Re((function(e){return e.f}));let o=t;for(t.h=r(t,s),e.markDirty(t),a.push(t);a.size()>0;){const t=a.pop();if(t===s)return Me(t);t.closed=!0;const i=e.neighbors(t);let l=0;const h=i.length;for(;l<h;++l){const h=i[l];if(h.closed||h.isWall())continue;const c=t.g+h.getCost(t),u=h.visited;(!u||c<h.g)&&(h.visited=!0,h.parent=t,h.h=h.h||r(h,s),h.g=c,h.f=h.g+h.h,e.markDirty(h),n&&(h.h<o.h||h.h===o.h&&h.g<o.g)&&(o=h),u?a.rescoreElement(h):a.push(h))}}return n?Me(o):[]},heuristics:{manhattan:(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),diagonal(e,t){const s=Math.sqrt(2),i=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return 1*(i+r)+(s-2)*Math.min(i,r)}},cleanNode(e){e.f=0,e.g=0,e.h=0,e.visited=!1,e.closed=!1,e.parent=null}};class Le{constructor(e,t=null){this.nodes=[],this.grid=[],this.dirtyNodes=[],t=t||{},this.diagonal=!!t.diagonal;for(let t=0;t<e.length;t++){this.grid[t]=[];let s=0;const i=e[t];for(;s<i.length;s++){const e=new Ae(t,s,i[s]);this.grid[t][s]=e,this.nodes.push(e)}}this.init()}init(){this.dirtyNodes=[];for(let e=0;e<this.nodes.length;e++)Te.cleanNode(this.nodes[e])}cleanDirty(){for(let e=0;e<this.dirtyNodes.length;e++)Te.cleanNode(this.dirtyNodes[e]);this.dirtyNodes=[]}markDirty(e){this.dirtyNodes.push(e)}neighbors(e){var t,s,i,r,n,a,o,l;const h=[],c=e.x,u=e.y,d=this.grid;return d[c-1]&&d[c-1][u]&&h.push(d[c-1][u]),d[c+1]&&d[c+1][u]&&h.push(d[c+1][u]),d[c]&&d[c][u-1]&&h.push(d[c][u-1]),d[c]&&d[c][u+1]&&h.push(d[c][u+1]),this.diagonal&&(d[c-1]&&d[c-1][u-1]&&d[c]&&(null===(t=d[c][u-1])||void 0===t?void 0:t.weight)&&d[c-1]&&(null===(s=d[c-1][u])||void 0===s?void 0:s.weight)&&h.push(d[c-1][u-1]),d[c+1]&&d[c+1][u-1]&&d[c]&&(null===(i=d[c][u-1])||void 0===i?void 0:i.weight)&&d[c+1]&&(null===(r=d[c+1][u])||void 0===r?void 0:r.weight)&&h.push(d[c+1][u-1]),d[c-1]&&d[c-1][u+1]&&d[c]&&(null===(n=d[c][u+1])||void 0===n?void 0:n.weight)&&d[c-1]&&(null===(a=d[c-1][u])||void 0===a?void 0:a.weight)&&h.push(d[c-1][u+1]),d[c+1]&&d[c+1][u+1]&&d[c]&&(null===(o=d[c][u+1])||void 0===o?void 0:o.weight)&&d[c+1]&&(null===(l=d[c+1][u])||void 0===l?void 0:l.weight)&&h.push(d[c+1][u+1])),h}toString(){const e=[],t=this.grid;for(let s=0;s<t.length;s++){const i=[],r=t[s];for(let e=0;e<r.length;e++)i.push(r[e].weight);e.push(i.join(" "))}return e.join("\n")}}class Ae{constructor(e,t,s){this.x=e,this.y=t,this.weight=s}toString(){return"["+this.x+" "+this.y+"]"}getCost(e){return e&&e.x!=this.x&&e.y!=this.y?1.41421*this.weight:this.weight}isWall(){return 0===this.weight}}class Re{constructor(e){this.content=[],this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.sinkDown(this.content.length-1)}pop(){const e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e}remove(e){const t=this.content.indexOf(e),s=this.content.pop();t!==this.content.length-1&&(this.content[t]=s,this.scoreFunction(s)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))}size(){return this.content.length}rescoreElement(e){this.sinkDown(this.content.indexOf(e))}sinkDown(e){const t=this.content[e];for(;e>0;){const s=(e+1>>1)-1,i=this.content[s];if(!(this.scoreFunction(t)<this.scoreFunction(i)))break;this.content[s]=t,this.content[e]=i,e=s}}bubbleUp(e){const t=this.content.length,s=this.content[e],i=this.scoreFunction(s);for(;;){const r=e+1<<1,n=r-1;let a,o=null;if(n<t){const e=this.content[n];a=this.scoreFunction(e),a<i&&(o=n)}if(r<t){const e=this.content[r];this.scoreFunction(e)<(null===o?i:a)&&(o=r)}if(null===o)break;this.content[e]=this.content[o],this.content[o]=s,e=o}}}class Ce extends z{constructor(e,t){super(e),this.location=t}}class Pe extends Ce{constructor(e){super(S.Z.LOCATION_CRYSTAL_FOUND,e)}}class Ie extends Ce{constructor(e){super(S.Z.LOCATION_LANDSLIDE,e)}}class xe extends Ce{constructor(e){super(S.Z.LOCATION_RAIDER_DISCOVERED,e)}}class Oe extends h.ZAu{constructor(e,t){super();const s=gt.getResource(e);this.animation=new it((0,a.DW)(e),!1).parse(s),this.animation.bodies.forEach((e=>{const s=e.model.clone();if(this.animation.polyList.push(s),e.lowerName&&e.isNull&&this.animation.nullJoints.getOrUpdate(e.lowerName.toLowerCase(),(()=>[])).push(s),e.sfxName){const i=new h.VYz(t);i.setRefDistance(6*l.pM),i.loop=!1,s.add(i),u.P.getSoundBuffer(e.sfxName).then((e=>{i.setBuffer(e)})),e.sfxFrames.forEach((e=>this.animation.sfxAudioByFrame.getOrUpdate(e,(()=>[])).push(i)))}})),this.animation.bodies.forEach(((e,t)=>{const s=this.animation.polyList[t],i=e.parentObjInd;null!=i?this.animation.polyList[i].add(s):this.animation.polyModel.add(s)})),this.add(this.animation.polyModel)}startAnimation(e){this.animation.animate(0,e,null)}}class De extends ce{constructor(e){super(),this.actualTarget=null,this.item=e}getWorkplaces(){return this.item.getCarryTargets()}getPriorityIdentifier(){return this.item.getPriorityIdentifier()}setActualWorkplace(e){var t;this.item.setTargetSite(null===(t=e)||void 0===t?void 0:t.site),this.actualTarget=e}getCarryItem(){return this.item}getWorkActivity(){return this.actualTarget.getDropAction()}isReadyToComplete(){return this.actualTarget.canGatherItem()}onJobComplete(){super.onJobComplete();const e=this.actualTarget.targetLocation;this.fulfiller.forEach((t=>{t.sceneEntity.lookAt(new h.Pa4(e.x,t.sceneEntity.position.y,e.y)),t.dropItem(),this.item.sceneEntity.position.copy(this.item.sceneMgr.getFloorPosition(e))})),this.actualTarget.gatherItem(this.item)}}class Ne extends De{constructor(e){super(e),this.color=10510432}getRequiredTraining(){return C.DEMOLITION}onJobComplete(){super.onJobComplete(),this.item.ignite()}}class _e extends ce{constructor(e){super(),this.surface=e,this.lastRubblePositions=this.surface.rubblePositions.map((e=>new le(e)))}getRequiredTool(){return T.SHOVEL}getWorkplaces(){const e=this.surface.rubblePositions;return this.lastRubblePositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.lastRubblePositions.some((t=>e.equals(t.targetLocation)))))||(this.lastRubblePositions=e.map((e=>new le(e)))),this.lastRubblePositions}onJobComplete(){this.surface.reduceRubble(),this.surface.hasRubble()||(this.surface.clearRubbleJob=null,super.onJobComplete())}getPriorityIdentifier(){return N.aiPriorityClearing}getWorkActivity(){return oe.Clear}}class ke extends ce{constructor(e){super(),this.color=10526880,this.surface=e,this.digPositions=this.surface.getDigPositions().map((e=>new le(e)))}getRequiredTool(){return T.DRILL}getWorkplaces(){const e=this.surface.getDigPositions();return this.digPositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.digPositions.some((t=>e.equals(t.targetLocation)))))||(this.digPositions=e.map((e=>new le(e)))),this.digPositions}onJobComplete(){this.surface.onDrillComplete(this.fulfiller.last().getPosition2D())&&super.onJobComplete()}getPriorityIdentifier(){return N.aiPriorityDestruction}getWorkActivity(){return oe.Drill}getWorkDuration(e){const t=new Map;this.fulfiller.forEach((e=>{t.getOrUpdate(e.entityType,(()=>({drillTime:1e3*e.stats[this.surface.surfaceType.statsDrillName][e.level],count:0}))).count++}));const s=t.get(e.entityType),i=(null==s?void 0:s.drillTime)/((null==s?void 0:s.count)||1)||null;return i||console.warn("According to cfg this entity cannot drill this material"),i}}class Be extends ce{constructor(e){super(),this.color=6332512,this.surface=e,this.digPositions=this.surface.getDigPositions().map((e=>new le(e)))}getWorkplaces(){const e=this.surface.getDigPositions();return this.digPositions.every((t=>e.some((e=>e.equals(t.targetLocation)))))&&e.every((e=>this.digPositions.some((t=>e.equals(t.targetLocation)))))||(this.digPositions=e.map((e=>new le(e)))),this.digPositions}onJobComplete(){super.onJobComplete(),this.surface.reinforce()}getPriorityIdentifier(){return N.aiPriorityReinforce}getWorkActivity(){return oe.Reinforce}getWorkDuration(e){return 2700}getRequiredTool(){return T.HAMMER}}class Fe{constructor(){this.group=new h.ZAu,this.pickSphere=null,this.selectionFrame=null,this.boundingSphere=new h.aLr}set visible(e){this.group.visible=e}get visible(){return this.group.visible}get position(){return this.group.position}set position(e){this.group.position.copy(e)}add(e){this.group.add(e)}remove(e){this.group.remove(e)}getRadiusSquare(){return(new h.ZzF).setFromObject(this.group).getBoundingSphere(this.boundingSphere),this.boundingSphere.radius*this.boundingSphere.radius}getHeading(){return this.group.rotation.y}setHeading(e){this.group.rotation.y=e}lookAt(e){this.group.lookAt(e)}flipXAxis(){this.group.applyMatrix4((new h.yGw).makeScale(-1,1,1))}createPickSphere(e,t,s=this.getBoundingSphereCenter().y-this.position.y){if(this.pickSphere)return;const i=e/2,r=new h.xo$(i,i,i),n=new h.vBJ({color:16776960,visible:!1});this.pickSphere=new h.Kj0(r,n),this.pickSphere.userData={selectable:t},this.pickSphere.position.y=s,this.add(this.pickSphere),this.createSelectionFrame(e,this.pickSphere.position)}getBoundingSphereCenter(){const e=new h.Pa4;return(new h.ZzF).setFromObject(this.group).getCenter(e),e}createSelectionFrame(e,t){const s=128,i=(0,c.kr)(s,s);i.fillStyle="#0f0";const r=Math.round(50/e),n=21.333333333333332;i.fillRect(0,0,n,r),i.fillRect(0,0,r,n),i.fillRect(106.66666666666667,0,n,r),i.fillRect(s-r,0,r,n),i.fillRect(s-r,106.66666666666667,r,n),i.fillRect(106.66666666666667,s-r,n,r),i.fillRect(0,s-r,n,r),i.fillRect(0,106.66666666666667,r,n);const a=new h.ROQ(i.canvas),o=new h.xeV({map:a,depthTest:!1});this.selectionFrame=new h.jyi(o),this.selectionFrame.position.copy(t);const l=3*e/4;this.selectionFrame.scale.set(l,l,l),this.selectionFrame.visible=!1,this.add(this.selectionFrame)}}class Ue{constructor(e,t,s,i){this.sceneEntity=new Fe,this.entityType=null,this.floorOffset=.1,this.animationEntityType=null,this.animation=null,this.activity=null,this.sceneMgr=e,this.entityMgr=t,this.entityType=s,i&&(this.animationEntityType=gt.getAnimationEntityType(i,this.sceneMgr.listener))}getPosition(){return this.sceneEntity.position.clone()}getPosition2D(){return new h.FM8(this.sceneEntity.position.x,this.sceneEntity.position.z)}getHeading(){return this.sceneEntity.getHeading()}onDiscover(){this.sceneEntity.visible=!0}addToScene(e,t){e&&(this.sceneEntity.position.copy(this.sceneMgr.getFloorPosition(e)),this.sceneEntity.position.y+=this.floorOffset),null!=t&&this.sceneEntity.setHeading(t),this.sceneEntity.visible=this.surfaces.some((e=>e.discovered)),this.sceneMgr.scene.add(this.sceneEntity.group)}removeFromScene(){var e;this.sceneMgr.scene.remove(this.sceneEntity.group),null===(e=this.animation)||void 0===e||e.stop()}get surfaces(){return[this.sceneMgr.terrain.getSurfaceFromWorld(this.sceneEntity.position)]}changeActivity(e=this.getDefaultActivity(),t=null,s=null){var i,r;if(this.activity===e||null===this.animationEntityType)return;this.activity=e;const n=e.activityKey.toLowerCase();let a=this.animationEntityType.animations.get(n);if(a||this.animationEntityType.animations.forEach(((e,t)=>{!a&&n.startsWith(t)&&(a=e)})),!a)return console.warn("Activity "+e.activityKey+" unknown or has no animation defined"),void console.log(this.animationEntityType.animations);this.animation&&(this.sceneEntity.remove(this.animation.polyModel),this.animation.stop());const o=null===(r=null===(i=this.animation)||void 0===i?void 0:i.carryJoint)||void 0===r?void 0:r.children;o&&o.length>0&&a.carryJoint&&a.carryJoint.add(...o),this.animation=a,this.sceneEntity.add(this.animation.polyModel),this.animation.animate(0,t,s)}getDefaultActivity(){return ne.Stand}playPositionalAudio(e,t){const s=new h.VYz(this.sceneMgr.listener);return s.setRefDistance(2*l.pM),s.loop=t,this.sceneEntity.add(s),u.P.getSoundBuffer(e).then((e=>{s.setBuffer(e).play(),s.loop||(s.onEnded=()=>this.sceneEntity.remove(s))})).catch((()=>{this.sceneEntity.remove(s)})),s}getSpeed(){var e;return(null===(e=this.animation)||void 0===e?void 0:e.transcoef)||1}}class We extends ne{}We.Teleport=new We("Activity_Teleport"),We.Deposit=new We("Activity_Deposit"),We.Explode=new We("Activity_Explode"),We.Unpowered=new We("Activity_Unpowered");class Ge extends le{constructor(e){super(e)}canGatherItem(){return!0}gatherItem(e){e.addToScene(null,null)}getDropAction(){return oe.Place}isInvalid(){return!1}}class He extends Ge{constructor(e,t){super(e),this.site=t}gatherItem(e){this.site.addItem(e)}getDropAction(){return this.site.getDropAction()}isInvalid(){return this.site.complete||this.site.canceled}}class Je extends Ge{constructor(e){super(e.getDropPosition2D()),this.building=e}canGatherItem(){return this.building.activity.activityKey===this.building.getDefaultActivity().activityKey}gatherItem(e){var t;this.building.entityType===b.POWER_STATION||this.building.entityType===b.ORE_REFINERY?((null===(t=this.building.animation)||void 0===t?void 0:t.carryJoint)&&(this.building.animation.carryJoint.add(e.sceneEntity.group),e.sceneEntity.position.set(0,0,0)),this.building.changeActivity(We.Deposit,(()=>{var t;this.building.changeActivity(),(null===(t=this.building.animation)||void 0===t?void 0:t.carryJoint)&&this.building.animation.carryJoint.remove(e.sceneEntity.group),Je.addItemToStorage(e)}))):(e.removeFromScene(),Je.addItemToStorage(e))}static addItemToStorage(e){switch(e.entityType){case b.CRYSTAL:o.numCrystal++;break;case b.ORE:o.numOre++}M.publishEvent(new te)}getDropAction(){return this.building.getDropAction()}isInvalid(){return!this.building.isUsable()}}class Ve extends Ue{constructor(e,t,s,i=null){super(e,t,s,i),this.targetBuildingTypes=[],this.priorityIdentifier=null,this.targets=[],this.targetSite=null,this.positionPathTarget=null,this.targetBuildingTypes=[b.TOOLSTATION]}getCarryTargets(){return this.updateTargets()}resetTarget(){this.targets=[],this.targetSite=null,this.updateTargets()}updateTargets(){if(this.targets.length<1){const e=this.entityMgr.buildingSites.filter((e=>e.needs(this.entityType)));if(e.length>0)this.targets=e.map((e=>new He(e.getRandomDropPosition(),e)));else{const e=this.entityMgr.getBuildingsByType(...this.getTargetBuildingTypes());e.length>0&&(this.targets=e.map((e=>new Je(e))))}}else this.targets.some((e=>e.isInvalid()))&&this.resetTarget();return this.targets}onDiscover(){super.onDiscover(),this.entityMgr.materialsUndiscovered.remove(this),this.entityMgr.materials.push(this),M.publishEvent(new $(this.createCarryJob()))}setTargetSite(e){var t,s;this.targetSite!==e&&(null===(t=this.targetSite)||void 0===t||t.unAssign(this),this.targetSite=e,null===(s=this.targetSite)||void 0===s||s.assign(this))}getPriorityIdentifier(){return this.priorityIdentifier}getTargetBuildingTypes(){return this.targetBuildingTypes}createCarryJob(){return new De(this)}onAddToSite(){this.addToScene(null,null)}getPositionPathTarget(){const e=this.getPosition2D();return this.positionPathTarget&&this.positionPathTarget[0].targetLocation.equals(e)||(this.positionPathTarget=[new le(e)]),this.positionPathTarget}}class qe extends Ve{constructor(e,t){super(e,t,b.CRYSTAL);const s=gt.getLwoModel("MiscAnims/Crystal/vlp_greencrystal.lwo");s.getMaterials().forEach((e=>{e.blending=h.WMw,e.depthWrite=!1,e.setOpacity(.5)})),s.scale.set(1.75,1.75,1.75),this.sceneEntity.add(s);const i=gt.getLwoModel("World/Shared/Crystal.lwo");i.getMaterials().forEach((e=>{e.emissive=new h.Ilk(0,8,0),e.color=new h.Ilk(0,0,0),e.setOpacity(.9)})),this.sceneEntity.add(i),this.targetBuildingTypes=[b.POWER_STATION,b.TOOLSTATION],this.priorityIdentifier=N.aiPriorityCrystal}get stats(){return gt.stats.PowerCrystal}}class je extends re{}je.Normal=new je("Normal"),je.TickDown=new je("TickDown");class Ze extends Ve{constructor(e,t,s){super(e,t,b.DYNAMITE,"MiscAnims/Dynamite/Dynamite.ae"),this.targetSurface=s,this.priorityIdentifier=N.aiPriorityDestruction,this.changeActivity()}getCarryTargets(){return this.targetSurface&&this.targetSurface.isDigable()?this.targetSurface.getDigPositions().map((e=>new Ge(e))):this.entityMgr.getBuildingsByType(b.TOOLSTATION).map((e=>e.getDropPosition2D())).map((e=>new Ge(e)))}ignite(){const e=this.targetSurface.getCenterWorld();e.y=this.sceneEntity.position.y,this.sceneEntity.lookAt(e),this.changeActivity(je.TickDown,(()=>{this.removeFromScene(),this.targetSurface.collapse()}))}getDefaultActivity(){return je.Normal}createCarryJob(){return new Ne(this)}}class Ke extends Ve{constructor(e,t){super(e,t,b.ORE),this.sceneEntity.add(gt.getLwoModel("MiscAnims/Ore/Ore1st.lwo")),this.targetBuildingTypes=[b.ORE_REFINERY,b.TOOLSTATION],this.priorityIdentifier=N.aiPriorityOre}get stats(){return gt.stats.Ore}}var Ye,ze,Xe=h.M8C.degToRad;class $e{constructor(e,t,s,i,r){this.containedOres=0,this.containedCrystals=0,this.heightOffset=null,this.discovered=!1,this.selected=!1,this.reinforced=!1,this.drillJob=null,this.reinforceJob=null,this.dynamiteJob=null,this.clearRubbleJob=null,this.surfaceRotation=0,this.seamLevel=0,this.fallinTimeout=null,this.fallinGrp=null,this.wallType=null,this.mesh=null,this.needsMeshUpdate=!1,this.topLeftVertex=null,this.topRightVertex=null,this.bottomRightVertex=null,this.bottomLeftVertex=null,this.topLeftHeightOffset=null,this.topRightHeightOffset=null,this.bottomRightHeightOffset=null,this.bottomLeftHeightOffset=null,this.rubblePositions=[],this.building=null,this.site=null,this.fence=null,this.hasPower=!1,this.terrain=e,this.sceneMgr=this.terrain.sceneMgr,this.entityMgr=this.terrain.entityMgr,this.surfaceType=t,t!==A.CRYSTAL_SEAM&&t!==A.ORE_SEAM||(this.seamLevel=4),this.x=s,this.y=i,this.heightOffset=r,t!==A.RUBBLE4&&t!==A.RUBBLE3&&t!==A.RUBBLE2&&t!==A.RUBBLE1||(this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()])}discover(){if(this.setDiscovered(),this.needsMeshUpdate=!0,!this.surfaceType.floor)return!1;const e=[],t=[];for(let s=-1;s<=1;s++)for(let i=-1;i<=1;i++){if(0===s&&0===i)continue;const r=this.terrain.getSurface(this.x+s,this.y+i);0!==s&&0!==i||!r.surfaceType.floor?t.push(r):e.push(r)}let s=!1,i=0;for(;e.length>0;){i++;const r=e.shift();r.setDiscovered();for(let i=-1;i<=1;i++)for(let n=-1;n<=1;n++){if(0===i&&0===n)continue;const a=r.terrain.getSurface(r.x+i,r.y+n);0!==i&&0!==n||!a.surfaceType.floor||a.discovered?t.push(a):(e.push(a),s=!0)}}return t.forEach((e=>{e.setDiscovered(),e.isSupported()||e.collapse()})),console.log("surface discover handled "+i+" floors and "+t.length+" others"),s}setDiscovered(){this.discovered||this.entityMgr.discoverSurface(this),this.discovered=!0,this.needsMeshUpdate=!0,M.publishEvent(new j(this))}onDrillComplete(e){if(this.seamLevel>0){this.seamLevel--;const t=(new h.FM8).copy(e).sub(this.getCenterWorld2D()).multiplyScalar(.3+(0,a.sZ)(3)/10).rotateAround(new h.FM8(0,0),Xe(-10+(0,a.sZ)(20))).add(e);if(this.surfaceType===A.CRYSTAL_SEAM){const e=this.entityMgr.placeMaterial(new qe(this.sceneMgr,this.entityMgr),t);M.publishEvent(new Pe(e.getPosition()))}else this.surfaceType===A.ORE_SEAM&&(this.entityMgr.placeMaterial(new Ke(this.sceneMgr,this.entityMgr),t),M.publishEvent(new ie))}return!(this.seamLevel>0||(this.collapse(),0))}collapse(){this.cancelJobs(),this.fallinTimeout=(0,a.L4)(this.fallinTimeout),this.surfaceType=A.RUBBLE4,M.publishEvent(new j(this)),this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=4,this.needsMeshUpdate=!0,this.discover()&&M.publishEvent(new se),this.dropContainedOre(this.containedOres-4);for(let e=0;e<this.containedCrystals;e++){const e=this.entityMgr.placeMaterial(new qe(this.sceneMgr,this.entityMgr),this.getRandomPosition());M.publishEvent(new Pe(e.getPosition()))}for(let e=this.x-1;e<=this.x+1;e++)for(let t=this.y-1;t<=this.y+1;t++)if(e!==this.x||t!==this.y){const s=this.terrain.getSurface(e,t);s.needsMeshUpdate=!0,s.isSupported()||s.collapse()}this.terrain.updateSurfaceMeshes(),this.terrain.floorGroup.updateWorldMatrix(!0,!0),this.playPositionalSample(p.d.SFX_RockBreak)}dropContainedOre(e){for(let t=0;t<e&&this.containedOres>0;t++)this.containedOres--,this.entityMgr.placeMaterial(new Ke(this.sceneMgr,this.entityMgr),this.getRandomPosition()),M.publishEvent(new ie)}getRandomPosition(){return new h.FM8(this.x*l.pM+l.pM/2+(0,a.kz)()*(0,a.sZ)(l.pM/4),this.y*l.pM+l.pM/2+(0,a.kz)()*(0,a.sZ)(l.pM/4))}cancelJobs(){this.drillJob=$e.safeRemoveJob(this.drillJob),this.reinforceJob=$e.safeRemoveJob(this.reinforceJob),this.dynamiteJob=$e.safeRemoveJob(this.dynamiteJob),this.clearRubbleJob=$e.safeRemoveJob(this.clearRubbleJob),this.updateJobColor()}static safeRemoveJob(e){return e&&M.publishEvent(new Q(e)),null}reduceRubble(){this.rubblePositions.shift(),this.surfaceType===A.RUBBLE4?this.surfaceType=A.RUBBLE3:this.surfaceType===A.RUBBLE3?this.surfaceType=A.RUBBLE2:this.surfaceType===A.RUBBLE2?this.surfaceType=A.RUBBLE1:this.surfaceType===A.RUBBLE1&&(this.surfaceType=A.GROUND),M.publishEvent(new j(this)),this.dropContainedOre(this.containedOres-this.rubblePositions.length),this.updateTexture(),this.selected&&M.publishEvent(new F(this.entityMgr))}isSupported(){if(this.surfaceType.floor)return!0;const e=this.terrain.getSurface(this.x-1,this.y),t=this.terrain.getSurface(this.x-1,this.y-1),s=this.terrain.getSurface(this.x,this.y-1),i=this.terrain.getSurface(this.x+1,this.y-1),r=this.terrain.getSurface(this.x+1,this.y),n=this.terrain.getSurface(this.x+1,this.y+1),a=this.terrain.getSurface(this.x,this.y+1),o=this.terrain.getSurface(this.x-1,this.y+1);function l(e,t,s){return!(e.discovered&&t.discovered&&s.discovered&&(e.surfaceType.floor||t.surfaceType.floor||s.surfaceType.floor))}return l(e,t,s)||l(s,i,r)||l(r,n,a)||l(a,o,e)}updateMesh(e=!0){if(!e&&!this.needsMeshUpdate)return;this.needsMeshUpdate=!1;const t=this.terrain.getSurface(this.x-1,this.y),s=this.terrain.getSurface(this.x-1,this.y-1),i=this.terrain.getSurface(this.x,this.y-1),r=this.terrain.getSurface(this.x+1,this.y-1),n=this.terrain.getSurface(this.x+1,this.y),a=this.terrain.getSurface(this.x+1,this.y+1),o=this.terrain.getSurface(this.x,this.y+1),c=this.terrain.getSurface(this.x-1,this.y+1);function u(e,t,s,i){return!(e.discovered&&(e.surfaceType.floor&&e.neighbors.some((e=>e.surfaceType.floor&&e.discovered))||t.discovered&&s.discovered&&i.discovered&&(t.surfaceType.floor||s.surfaceType.floor||i.surfaceType.floor)))}const d=new h.Pa4(this.x,0,this.y),g=new h.Pa4(this.x+1,0,this.y),p=new h.Pa4(this.x,0,this.y+1),y=new h.Pa4(this.x+1,0,this.y+1);u(this,t,s,i)&&(d.y=1),u(this,i,r,n)&&(g.y=1),u(this,n,a,o)&&(y.y=1),u(this,o,c,t)&&(p.y=1);let m=d.y+g.y+y.y+p.y;if(m===ge.WALL&&d.y===y.y&&(m=ge.WEIRD_CREVICE),this.wallType!==m){function v(...e){return e.map((e=>e.heightOffset)).reduce(((e,t)=>(e||0)+(t||0)),0)/(e.length||1)}this.wallType=m,this.topLeftVertex=d.clone(),this.topRightVertex=g.clone(),this.bottomRightVertex=y.clone(),this.bottomLeftVertex=p.clone(),this.topLeftHeightOffset=v(s,i,this,t)*l.w$,this.topRightHeightOffset=v(i,r,n,this)*l.w$,this.bottomRightHeightOffset=v(this,n,a,o)*l.w$,this.bottomLeftHeightOffset=v(t,this,o,c)*l.w$,this.topLeftVertex.y+=this.topLeftHeightOffset,this.topRightVertex.y+=this.topRightHeightOffset,this.bottomRightVertex.y+=this.bottomRightHeightOffset,this.bottomLeftVertex.y+=this.bottomLeftHeightOffset,this.updateGeometry(d,g,y,p),this.wallType!==ge.WALL&&this.cancelReinforceJobs()}this.updateTexture(),this.updateJobColor(),this.updatePathfinding()}updatePathfinding(){const e=this.getPathfindingWalkWeight();for(let t=0;t<3;t++)for(let s=0;s<3;s++)this.terrain.graphWalk.grid[3*this.x+t][3*this.y+s].weight=e;this.terrain.graphDrive.grid[this.x][this.y].weight=this.getPathfindingDriveWeight(),this.terrain.graphFly.grid[this.x][this.y].weight=this.getPathFindingFlyWeight(),this.terrain.graphSwim.grid[this.x][this.y].weight=this.getPathFindingSwimWeight()}cancelReinforceJobs(){this.reinforceJob=$e.safeRemoveJob(this.reinforceJob),this.updateJobColor()}updateTexture(){let e=this.terrain.textureSet.texturebasename;this.discovered?this.surfaceType===A.POWER_PATH?e+=this.updatePowerPathTexture():!this.surfaceType.shaping&&this.neighbors.some((e=>e.discovered&&e.surfaceType.floor))?this.surfaceType===A.POWER_PATH_BUILDING&&this.hasPower?e+="66":e+=this.surfaceType.matIndex.toString():this.wallType===ge.WEIRD_CREVICE?e+="77":(this.wallType===ge.CORNER?e+="5":this.wallType===ge.INVERTED_CORNER?e+="3":this.reinforced?e+="2":e+="0",e+=this.surfaceType.shaping?this.surfaceType.matIndex:A.SOLID_ROCK.matIndex):e+="70",e+=".bmp",this.forEachMaterial((e=>{var t;return null===(t=e.map)||void 0===t?void 0:t.dispose()}));const t=gt.getTexture(e);t.center.set(.5,.5),t.rotation=this.surfaceRotation,this.forEachMaterial((e=>e.map=t))}updatePowerPathTexture(){this.surfaceRotation=0;const e=this.terrain.getSurface(this.x-1,this.y).isPath(),t=this.terrain.getSurface(this.x,this.y-1).isPath(),s=this.terrain.getSurface(this.x+1,this.y).isPath(),i=this.terrain.getSurface(this.x,this.y+1).isPath(),r=(e?1:0)+(t?1:0)+(s?1:0)+(i?1:0);return 0===r||1===r?(e&&(this.surfaceRotation=-Math.PI/2),t&&(this.surfaceRotation=Math.PI),s&&(this.surfaceRotation=Math.PI/2),this.hasPower?"75":"65"):2===r?e===s?(this.surfaceRotation=e?Math.PI/2:0,this.hasPower?"72":"62"):(e&&i&&(this.surfaceRotation=-Math.PI/2),e&&t&&(this.surfaceRotation=Math.PI),t&&s&&(this.surfaceRotation=Math.PI/2),this.hasPower?"73":"63"):3===r?(t||(this.surfaceRotation=-Math.PI/2),s||(this.surfaceRotation=Math.PI),i||(this.surfaceRotation=Math.PI/2),this.hasPower?"74":"64"):this.hasPower?"71":"60"}forEachMaterial(e){var t;(null===(t=this.mesh)||void 0===t?void 0:t.material)&&(Array.isArray(this.mesh.material)?this.mesh.material:[this.mesh.material]).forEach((t=>e(t)))}updateGeometry(e,t,s,i){var r,n;this.mesh&&this.terrain.floorGroup.remove(this.mesh),null===(n=null===(r=this.mesh)||void 0===r?void 0:r.geometry)||void 0===n||n.dispose(),this.forEachMaterial((e=>e.dispose()));const a=ye.create(this.wallType,e,t,s,i,this.topLeftVertex.y,this.topRightVertex.y,this.bottomRightVertex.y,this.bottomLeftVertex.y);this.mesh=new h.Kj0(a,new h.xoR({shininess:0})),this.mesh.userData={selectable:this,surface:this},this.terrain.floorGroup.add(this.mesh),this.terrain.floorGroup.updateWorldMatrix(!0,!0)}isSelectable(){return this.surfaceType.selectable&&this.wallType!==ge.INVERTED_CORNER&&this.wallType!==ge.WEIRD_CREVICE&&!this.selected&&this.discovered}isInSelection(){return this.isSelectable()||this.selected}select(){return!!this.isSelectable()&&(this.selected=!0,this.forEachMaterial((e=>e.color.setHex(6316192))),this.surfaceType.floor&&u.P.playSample(p.d.SFX_Floor),this.surfaceType.shaping&&u.P.playSample(p.d.SFX_Wall),console.log("Surface selected at "+this.x+"/"+this.y),!0)}deselect(){this.selected&&(this.selected=!1,this.updateJobColor())}updateJobColor(){var e,t,s;const i=(null===(e=this.dynamiteJob)||void 0===e?void 0:e.color)||(null===(t=this.reinforceJob)||void 0===t?void 0:t.color)||(null===(s=this.drillJob)||void 0===s?void 0:s.color)||16777215;this.forEachMaterial((e=>e.color.setHex(i)))}hasRubble(){return this.rubblePositions.length>0}isPath(){return this.surfaceType===A.POWER_PATH||this.surfaceType===A.POWER_PATH_BUILDING}isWalkable(){var e;return this.surfaceType.floor&&this.discovered&&this.surfaceType!==A.LAVA&&this.surfaceType!==A.WATER&&!(null===(e=this.building)||void 0===e?void 0:e.blocksPathSurface)}isDigable(){return this.surfaceType.digable&&this.discovered&&(this.wallType===ge.WALL||this.wallType===ge.CORNER)}isReinforcable(){return this.surfaceType.reinforcable&&this.discovered&&this.wallType===ge.WALL&&!this.reinforced}getDigPositions(){const e=[];return this.terrain.getSurface(this.x-1,this.y).isWalkable()&&e.push(new h.FM8(this.x*l.pM-1,this.y*l.pM+l.pM/2)),this.terrain.getSurface(this.x,this.y-1).isWalkable()&&e.push(new h.FM8(this.x*l.pM+l.pM/2,this.y*l.pM-1)),this.terrain.getSurface(this.x+1,this.y).isWalkable()&&e.push(new h.FM8(this.x*l.pM+l.pM+1,this.y*l.pM+l.pM/2)),this.terrain.getSurface(this.x,this.y+1).isWalkable()&&e.push(new h.FM8(this.x*l.pM+l.pM/2,this.y*l.pM+l.pM+1)),e}reinforce(){this.reinforced=!0,this.cancelReinforceJobs(),this.fallinTimeout=(0,a.L4)(this.fallinTimeout),this.updateTexture(),M.publishEvent(new j(this))}getCenterWorld2D(){return new h.FM8(this.x,this.y).addScalar(.5).multiplyScalar(l.pM)}getCenterWorld(){var e,t;const s=this.getCenterWorld2D(),i=new h.iMs(new h.Pa4(s.x,3*l.pM,s.y),new h.Pa4(0,-1,0)).intersectObject(this.mesh,!0);i.length<1&&console.warn("could not determine terrain height for "+s.x+"/"+s.y);const r=(null===(t=null===(e=i[0])||void 0===e?void 0:e.point)||void 0===t?void 0:t.y)||0;return new h.Pa4(s.x,r,s.y)}setFallinLevel(e){if(e<1)return;let t,s;this.surfaceType.floor?(t=this.terrain.findFallInOrigin(this.x,this.y),s=[this.x,this.y]):(t=[this.x,this.y],s=this.terrain.findFallInTarget(this.x,this.y)),t&&s&&this.terrain.getSurface(t[0],t[1]).scheduleFallin(s[0],s[1])}scheduleFallin(e,t){this.fallinTimeout=setTimeout((()=>{this.createFallin(e,t),this.scheduleFallin(e,t)}),1e3*(30+(0,a.sZ)(60)))}createFallin(e,t){const s=this.terrain.getSurface(e,t).getCenterWorld();M.publishEvent(new Ie(s)),this.fallinGrp=new Oe("MiscAnims/RockFall/Rock3Sides.lws",this.sceneMgr.listener),this.fallinGrp.position.copy(s);const i=this.x-e,r=t-this.y;this.fallinGrp.rotateOnAxis(new h.Pa4(0,1,0),Math.atan2(r,i)+Math.PI/2),this.sceneMgr.scene.add(this.fallinGrp),this.fallinGrp.startAnimation((()=>{this.sceneMgr.scene.remove(this.fallinGrp),this.fallinGrp=null})),this.terrain.getSurface(e,t).makeRubble()}dispose(){var e,t;this.fallinTimeout=(0,a.L4)(this.fallinTimeout),this.forEachMaterial((e=>e.dispose())),null===(t=null===(e=this.mesh)||void 0===e?void 0:e.geometry)||void 0===t||t.dispose()}getFloorHeight(e,t){const s=e/l.pM-this.x,i=t/l.pM-this.y,r=$e.interpolate(this.topLeftHeightOffset,this.topRightHeightOffset,s),n=$e.interpolate(this.bottomLeftHeightOffset,this.bottomRightHeightOffset,s);return $e.interpolate(r,n,i)*l.pM}static interpolate(e,t,s){return e+s*(t-e)}get neighbors(){return[this.terrain.getSurface(this.x-1,this.y),this.terrain.getSurface(this.x,this.y-1),this.terrain.getSurface(this.x+1,this.y),this.terrain.getSurface(this.x,this.y+1)]}makeRubble(e=0){this.rubblePositions=[this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition(),this.getRandomPosition()],this.containedOres+=e,this.setSurfaceType(A.RUBBLE4)}setBuilding(e){this.building=e,this.updatePathfinding(),this.setSurfaceType(this.building?A.POWER_PATH_BUILDING:A.GROUND)}setSurfaceType(e){if(e===this.surfaceType)return;const t=this.surfaceType;this.surfaceType=e,this.updateTexture(),(t.connectsPath||this.surfaceType.connectsPath)&&this.neighbors.forEach((e=>e.updateTexture())),M.publishEvent(new j(this))}getPathfindingWalkWeight(){return this.isWalkable()?this.hasRubble()?4:1:0}getPathfindingDriveWeight(){return this.isWalkable()?1:0}getPathFindingFlyWeight(){var e;return this.surfaceType.floor&&!(null===(e=this.building)||void 0===e?void 0:e.blocksPathSurface)?1:0}getPathFindingSwimWeight(){return this.surfaceType===A.WATER?1:0}setHasPower(e,t){this.hasPower!==e&&(this.hasPower=e,this.updateTexture(),t&&this.neighbors.forEach((s=>s.isPath()&&s.setHasPower(e,t))))}canPlaceFence(){return this.surfaceType.canCarryFence&&!this.building&&!this.fence&&[1,2].some((e=>!!(this.terrain.getSurface(this.x-e,this.y).building||this.terrain.getSurface(this.x,this.y-e).building||this.terrain.getSurface(this.x+e,this.y).building||this.terrain.getSurface(this.x,this.y+e).building||this.terrain.getSurface(this.x-e,this.y).fence||this.terrain.getSurface(this.x,this.y-e).fence||this.terrain.getSurface(this.x+e,this.y).fence||this.terrain.getSurface(this.x,this.y+e).fence)))}createDrillJob(){return this.isDigable()?(this.drillJob||(this.drillJob=new ke(this),this.updateJobColor(),M.publishEvent(new $(this.drillJob))),this.drillJob):null}createReinforceJob(){return this.isReinforcable()?(this.reinforceJob||(this.reinforceJob=new Be(this),this.updateJobColor(),M.publishEvent(new $(this.reinforceJob))),this.reinforceJob):null}createDynamiteJob(){if(!this.isDigable())return null;if(!this.dynamiteJob){const e=this.entityMgr.getClosestBuildingByType(this.getCenterWorld(),b.TOOLSTATION);if(!e)throw"Could not find toolstation to spawn dynamite";const t=new Ze(this.sceneMgr,this.entityMgr,this);t.addToScene(e.getDropPosition2D(),e.getHeading()),this.dynamiteJob=new Ne(t),this.updateJobColor(),M.publishEvent(new $(this.dynamiteJob))}return this.dynamiteJob}createClearRubbleJob(){return this.hasRubble()?(this.clearRubbleJob||(this.clearRubbleJob=new _e(this),this.updateJobColor(),M.publishEvent(new $(this.clearRubbleJob))),this.clearRubbleJob):null}setSite(e){this.site=e,this.setSurfaceType(this.site?A.POWER_PATH_CONSTRUCTION:A.GROUND)}playPositionalSample(e){const t=new h.VYz(this.sceneMgr.listener);return t.setRefDistance(6*l.pM),this.mesh.add(t),u.P.getSoundBuffer(p.d[e]).then((e=>{t.setBuffer(e),t.play()})),t}}class Qe{constructor(e,t){this.target=null,this.locations=[],this.lengthSq=0,this.target=e,this.locations=Array.isArray(t)?t:[t];for(let e=0;e<this.locations.length-1;e++){const t=this.locations[e],s=this.locations[e+1];this.lengthSq+=t.distanceToSquared(s)}}get firstLocation(){return this.locations[0]||null}}class et{constructor(e,t){this.textureSet={},this.width=0,this.height=0,this.surfaces=[],this.floorGroup=new h.ZAu,this.roofGroup=new h.ZAu,this.graphWalk=null,this.graphDrive=null,this.graphFly=null,this.graphSwim=null,this.cachedWalkPaths=new Map,this.cachedDrivePaths=new Map,this.cachedFlyPaths=new Map,this.cachedSwimPaths=new Map,this.sceneMgr=e,this.entityMgr=t,this.floorGroup.scale.setScalar(l.pM),this.roofGroup.scale.setScalar(l.pM),this.roofGroup.visible=!1,l.Sl&&this.floorGroup.add(new h.y8_)}getSurfaceFromWorld(e){return this.getSurfaceFromWorldXZ(e.x,e.z)}getSurfaceFromWorld2D(e){return this.getSurfaceFromWorldXZ(e.x,e.y)}getSurfaceFromWorldXZ(e,t){return this.getSurface(e/l.pM,t/l.pM)}getSurface(e,t){return e=Math.floor(e),t=Math.floor(t),this.getSurfaceOrNull(e,t)||new $e(this,A.SOLID_ROCK,e,t,0)}getSurfaceOrNull(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height?this.surfaces[e][t]:null}updateSurfaceMeshes(e=!1){this.forEachSurface((t=>t.updateMesh(e))),this.floorGroup.updateWorldMatrix(!0,!0),this.resetGraphWalk()}resetGraphWalk(){this.graphWalk.init(),this.graphDrive.init(),this.graphFly.init(),this.graphSwim.init(),this.cachedWalkPaths.clear(),this.cachedDrivePaths.clear(),this.cachedFlyPaths.clear(),this.cachedSwimPaths.clear(),console.log("Cached paths cleared")}findWalkPath(e,t){return et.findPath(e,t,this.cachedWalkPaths,this.graphWalk,3/l.pM,.25)}findDrivePath(e,t){return et.findPath(e,t,this.cachedDrivePaths,this.graphDrive,1/l.pM,0)}findFlyPath(e,t){return et.findPath(e,t,this.cachedFlyPaths,this.graphFly,1/l.pM,0)}findSwimPath(e,t){return et.findPath(e,t,this.cachedSwimPaths,this.graphSwim,1/l.pM,0)}static findPath(e,t,s,i,r,n){const a=e.clone().multiplyScalar(r).floor(),o=t.targetLocation.clone().multiplyScalar(r).floor();if(a.x===o.x&&a.y===o.y)return new Qe(t,t.targetLocation);const l=a.x+"/"+a.y+" -> "+o.x+"/"+o.y,c=s.getOrUpdate(l,(()=>{const e=i.grid[a.x][a.y],t=i.grid[o.x][o.y],s=Te.search(i,e,t).map((e=>new h.FM8(e.x+.5,e.y+.5).add((new h.FM8).random().multiplyScalar(n)).divideScalar(r)));return s.length<1?null:(s.pop(),s)}));return c?new Qe(t,[...c,t.targetLocation]):null}findFallInOrigin(e,t){const s=this.getSurface(e-1,t);if(s.isReinforcable())return[s.x,s.y];const i=this.getSurface(e,t-1);if(i.isReinforcable())return[i.x,i.y];const r=this.getSurface(e+1,t);if(r.isReinforcable())return[r.x,r.y];const n=this.getSurface(e,t+1);if(n.isReinforcable())return[n.x,n.y];const a=this.getSurface(e-1,t);if(a.isDigable())return[a.x,a.y];const o=this.getSurface(e,t-1);if(o.isDigable())return[o.x,o.y];const l=this.getSurface(e+1,t);if(l.isDigable())return[l.x,l.y];const h=this.getSurface(e,t+1);return h.isDigable()?[h.x,h.y]:null}findFallInTarget(e,t){const s=this.getSurface(e-1,t);if(s.isWalkable())return[s.x,s.y];const i=this.getSurface(e,t-1);if(i.isWalkable())return[i.x,i.y];const r=this.getSurface(e+1,t);if(r.isWalkable())return[r.x,r.y];const n=this.getSurface(e,t+1);return n.isWalkable()?[n.x,n.y]:null}dispose(){this.forEachSurface((e=>e.dispose()))}forEachSurface(e){var t;null===(t=this.surfaces)||void 0===t||t.forEach((t=>t.forEach((t=>e(t)))))}countDiggables(){let e=0;return this.forEachSurface((t=>e+=t.isDigable()?1:0)),e}countCrystals(){let e=0;return this.forEachSurface((t=>e+=t.containedCrystals)),e}countOres(){let e=0;return this.forEachSurface((t=>e+=t.containedOres)),e}}!function(e){e[e.NONE=0]="NONE",e[e.RUBBLE=1]="RUBBLE",e[e.POWER_PATH=2]="POWER_PATH"}(Ye||(Ye={})),function(e){e[e.WALL=0]="WALL",e[e.CAVERN_EXPOSED=1]="CAVERN_EXPOSED",e[e.CAVERN_HIDDEN=2]="CAVERN_HIDDEN",e[e.SLUG_HOLE_EXPOSED=3]="SLUG_HOLE_EXPOSED",e[e.SLUG_HOLE_HIDDEN=4]="SLUG_HOLE_HIDDEN"}(ze||(ze={}));class tt{constructor(e){this.maxFps=30,this.debugHelper=new E,this.renderer=new h.CP7({antialias:!0,canvas:e}),this.renderer.setClearColor(0),this.listener=new h.SJI,this.camera=new h.cPb(30,e.width/e.height,.1,5e3),this.camera.add(this.listener),this.controls=new f.o(this.camera,this.renderer.domElement),this.controls.mouseButtons={LEFT:null,MIDDLE:h.RsA.ROTATE,RIGHT:h.RsA.PAN},this.controls.listenToKeyEvents(this.renderer.domElement),this.controls.keyPanSpeed=this.controls.keyPanSpeed*l.m8}getSelectionByRay(e,t){const s=new h.iMs;s.setFromCamera({x:e,y:t},this.camera);const i=new Se;return i.raiders.push(...tt.getSelection(s.intersectObjects(this.entityMgr.raiders.map((e=>e.sceneEntity.pickSphere))))),i.isEmpty()&&i.vehicles.push(...tt.getSelection(s.intersectObjects(this.entityMgr.vehicles.map((e=>e.sceneEntity.pickSphere))))),i.isEmpty()&&(i.building=tt.getSelection(s.intersectObjects(this.entityMgr.buildings.map((e=>e.sceneEntity.pickSphere))))[0]),i.isEmpty()&&this.terrain&&(i.surface=tt.getSelection(s.intersectObjects(this.terrain.floorGroup.children))[0]),i}static getSelection(e){if(e.length<1)return[];const t=[],s=e[0].object.userData;if(s&&s.hasOwnProperty("selectable")){const e=s.selectable;(null==e?void 0:e.isInSelection())&&t.push(e)}return t}getFirstByRay(e,t){const s=new h.iMs;s.setFromCamera({x:e,y:t},this.camera);const i=tt.getEntity(s.intersectObjects(this.entityMgr.vehicles.map((e=>e.sceneEntity.pickSphere))));if(i)return{vehicle:i};if(this.terrain){const e=tt.getEntity(s.intersectObjects(this.terrain.floorGroup.children));if(e)return{surface:e}}return null}static getEntity(e){var t,s,i;return(null===(i=null===(s=null===(t=e[0])||void 0===t?void 0:t.object)||void 0===s?void 0:s.userData)||void 0===i?void 0:i.selectable)||null}getEntitiesInFrustum(e,t,s,i){const r=new h.Pa4(e,t,.5),n=new h.Pa4(s,i,.5);r.x===n.x&&(n.x+=Number.EPSILON),r.y===n.y&&(n.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld();const a=new h.Pa4;a.copy(r),a.x=Math.min(r.x,n.x),a.y=Math.max(r.y,n.y),n.x=Math.max(r.x,n.x),n.y=Math.min(r.y,n.y);const o=new h.Pa4,l=new h.Pa4,c=new h.Pa4,u=new h.Pa4,d=new h.Pa4;o.setFromMatrixPosition(this.camera.matrixWorld),l.copy(a),c.set(n.x,a.y,0),u.copy(n),d.set(a.x,n.y,0),l.unproject(this.camera),c.unproject(this.camera),u.unproject(this.camera),d.unproject(this.camera);const g=new h.Pa4,p=new h.Pa4,y=new h.Pa4;g.copy(l).sub(o),p.copy(c).sub(o),y.copy(u).sub(o),g.normalize(),p.normalize(),y.normalize();const m=Number.MAX_VALUE;g.multiplyScalar(m),p.multiplyScalar(m),y.multiplyScalar(m),g.add(o),p.add(o),y.add(o);const v=new h.iWj,f=v.planes;f[0].setFromCoplanarPoints(o,l,c),f[1].setFromCoplanarPoints(o,c,u),f[2].setFromCoplanarPoints(u,d,o),f[3].setFromCoplanarPoints(d,l,o),f[4].setFromCoplanarPoints(c,u,d),f[5].setFromCoplanarPoints(y,p,g),f[5].normal.multiplyScalar(-1);const w=new Se;return w.raiders.push(...this.entityMgr.raiders.filter((e=>e.isInSelection()&&tt.isInFrustum(e.sceneEntity.pickSphere,v)))),w.vehicles.push(...this.entityMgr.vehicles.filter((e=>e.isInSelection()&&tt.isInFrustum(e.sceneEntity.pickSphere,v)))),w.isEmpty()&&(w.building=this.entityMgr.buildings.find((e=>tt.isInFrustum(e.sceneEntity.pickSphere,v)))),w}static isInFrustum(e,t){if(!e)return!1;const s=new h.Pa4;return e.getWorldPosition(s),t.containsPoint(s)}setupScene(e){this.scene=new h.xsS;const t=gt.cfg("Main","AmbientRGB")||[10,10,10],s=Math.min(255,Math.max(0,...t)),i=t.map((e=>e/(s||1))),r=new h.Ilk(i[0],i[1],i[2]);this.ambientLight=new h.Mig(r,.4),this.scene.add(this.ambientLight),this.cursorTorchlight=new h.cek(16777215,1.5,4,1),this.cursorTorchlight.distance*=l.pM,this.scene.add(this.cursorTorchlight),this.buildMarker=new ve(this.worldMgr,this,this.entityMgr),this.scene.add(this.buildMarker.group),this.setBuildModeSelection(null),this.terrain=class{static loadTerrain(e,t,s){var i,r,n,a,o,h,c;const u=e.blockSize;u!==l.pM&&console.error("Unexpected tile size in level configuration: "+u);const d=new et(t,s),g=e.textureSet[1];d.textureSet=gt.cfg("Textures",g);const p=gt.getResource(e.terrainMap);d.width=p.width,d.height=p.height;const y=null===(i=gt.getResource(e.pathMap))||void 0===i?void 0:i.level,m=null===(r=gt.getResource(e.surfaceMap))||void 0===r?void 0:r.level,v=null===(n=gt.getResource(e.predugMap))||void 0===n?void 0:n.level,f=null===(a=gt.getResource(e.cryOreMap))||void 0===a?void 0:a.level,w=null===(o=gt.getResource(e.fallinMap))||void 0===o?void 0:o.level,E=null===(h=gt.getResource(e.erodeMap))||void 0===h?void 0:h.level;null===(c=gt.getResource(e.blockPointersMap))||void 0===c||c.level;for(let e=0;e<p.level.length;e++)for(let t=0;t<p.level[e].length;t++){d.surfaces[t]=d.surfaces[t]||[];const s=p.level[e][t];let i=A.getByNum(s);const r=v[e][t];r===ze.CAVERN_EXPOSED?i===A.GROUND||i===A.DIRT||i===A.POWER_PATH_BUILDING?i=A.GROUND:i!==A.WATER&&i!==A.LAVA&&console.warn("Unexpected cavern surface type: "+i.name):r===ze.SLUG_HOLE_EXPOSED||r===ze.SLUG_HOLE_HIDDEN?i=A.SLUG_HOLE:r!==ze.WALL&&r!==ze.CAVERN_HIDDEN&&console.warn("Unexpected predug level: "+r);const n=y&&i.floor?y[e][t]:Ye.NONE;n===Ye.RUBBLE?i=A.RUBBLE4:n===Ye.POWER_PATH?i=A.POWER_PATH:n!==Ye.NONE&&console.warn("Unexpected path map level: "+n);const a=new $e(d,i,t,e,m[e][t]);if(f){const s=f[e][t];s%2==1?a.containedCrystals=(s+1)/2:a.containedOres=s/2}d.surfaces[t].push(a)}d.forEachSurface((e=>{if(v[e.y][e.x]===ze.CAVERN_EXPOSED||v[e.y][e.x]===ze.SLUG_HOLE_EXPOSED)for(let t=e.x-1;t<=e.x+1;t++)for(let s=e.y-1;s<=e.y+1;s++)d.getSurfaceOrNull(t,s).discovered=!0})),d.forEachSurface((e=>{const t=d.getSurfaceOrNull(e.x,e.y);v[e.y][e.x]!==ze.CAVERN_HIDDEN||t.discovered||(t.surfaceType=A.GROUND)}));const b=[],S=[],M=[],T=[];for(let e=0;e<d.width;e++){const t=[],s=[],i=[],r=[];for(let n=0;n<d.height;n++){const a=d.getSurfaceOrNull(e,n),o=a.getPathfindingWalkWeight();t.push(o,o,o),s.push(a.getPathfindingDriveWeight()),i.push(a.getPathFindingFlyWeight()),r.push(a.getPathFindingSwimWeight())}b.push(t,t,t),S.push(s),M.push(i),T.push(r)}if(d.graphWalk=new Le(b,{diagonal:!0}),d.graphDrive=new Le(S,{diagonal:!0}),d.graphFly=new Le(M,{diagonal:!0}),d.graphSwim=new Le(T,{diagonal:!0}),d.forEachSurface((e=>{e.isSupported()||e.collapse()})),d.updateSurfaceMeshes(!0),w)for(let e=0;e<d.width;e++)for(let t=0;t<d.height;t++)d.getSurface(e,t).setFallinLevel(w[t][e]);return E&&console.warn("Lucky you! Lava erosion not yet implemented"),d}}.loadTerrain(e,this,this.entityMgr),this.scene.add(this.terrain.floorGroup),o.totalDiggables=this.terrain.countDiggables(),o.totalCrystals=this.terrain.countCrystals(),o.totalOres=this.terrain.countOres()}startScene(){this.debugHelper.show(),this.renderInterval=setInterval((()=>{this.animRequest=requestAnimationFrame((()=>{this.debugHelper.renderStart(),this.renderer.render(this.scene,this.camera),this.debugHelper.renderDone()}))}),1e3/this.maxFps)}disposeScene(){var e,t;this.debugHelper.hide(),this.renderInterval=(0,a.nJ)(this.renderInterval),this.animRequest&&(cancelAnimationFrame(this.animRequest),this.animRequest=null),o.remainingDiggables=(null===(e=this.terrain)||void 0===e?void 0:e.countDiggables())||0,null===(t=this.terrain)||void 0===t||t.dispose(),this.terrain=null,tt.meshRegistry.forEach((e=>e.dispose())),tt.meshRegistry=[]}static registerMesh(e){return this.meshRegistry.push(e),e}resize(e,t){this.renderer.setSize(e,t)}getTerrainIntersectionPoint(e,t){if(!this.terrain)return null;const s=new h.iMs;s.setFromCamera({x:e,y:t},this.camera);const i=s.intersectObjects(this.terrain.floorGroup.children);return i.length>0?new h.FM8(i[0].point.x,i[0].point.z):null}setTorchPosition(e){this.cursorTorchlight.position.copy(this.getFloorPosition(e)),this.cursorTorchlight.position.y+=2*l.pM}getFloorPosition(e){const t=this.terrain.getSurfaceFromWorldXZ(e.x,e.y).getFloorHeight(e.x,e.y);return new h.Pa4(e.x,t,e.y)}hasBuildModeSelection(){var e;return!!(null===(e=this.buildMarker)||void 0===e?void 0:e.buildModeSelection)}setBuildModeSelection(e){var t;null===(t=this.buildMarker.buildModeSelection)||void 0===t||t.removeFromScene(),this.buildMarker.buildModeSelection=e,e||this.buildMarker.hideAllMarker()}}tt.meshRegistry=[];class st extends h.Kj0{constructor(e,t){super(e,t),tt.registerMesh(this)}clone(){const e=super.clone(!0);return e.material=this.getMaterials().map((e=>e.clone())),e}dispose(){var e;null===(e=this.geometry)||void 0===e||e.dispose(),this.getMaterials().forEach((e=>e.dispose())),this.material=null}getMaterials(){const e=this.material;return e?Array.isArray(e)?e:[e]:[]}}class it{constructor(e,t=!1){this.path="",this.verbose=!1,this.animationClip=new y,this.lines=[],this.lineIndex=0,this.path=e,this.verbose=t,this.verbose&&console.log("Using verbose mode")}parse(e){if(!e)throw"Cannot parse LWS, no content given";if(this.lines=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((e=>e.trim())),"LWSC"!==this.lines[0])throw"Invalid start of file! Expected 'LWSC' in first line";const t=parseInt(this.lines[1],10);for(1!==t&&console.warn("Unexpected scene file version: "+t),this.lineIndex=2;this.lineIndex<this.lines.length;this.lineIndex++){let e=this.lines[this.lineIndex];if(!e)continue;const t=e.split(" ")[0];if("FirstFrame"===t)this.parseFrameBlock();else if("AddNullObject"===t||"LoadObject"===t){const e=this.parseObjectBlock();this.verbose&&console.log(e)}else e.startsWith("PreviewFirstFrame ")||e.startsWith("PreviewLastFrame ")||e.startsWith("PreviewFrameStep ")}return this.verbose&&console.log(this.animationClip),this.animationClip}parseLine(e){const t=e.split(" ").filter((e=>""!==e));return[t.shift(),t.join(" ")]}parseFrameBlock(){for(;this.lineIndex<this.lines.length;this.lineIndex++){const e=this.lines[this.lineIndex];if(!e)return;const[t,s]=this.parseLine(e);if("FirstFrame"===t)this.animationClip.firstFrame=parseInt(s);else if("LastFrame"===t)this.animationClip.lastFrame=parseInt(s);else if("FrameStep"===t){const e=parseInt(s);1!==e&&console.error("Animation frameStep has unexpected value: "+e)}else"FramesPerSecond"===t?this.animationClip.framesPerSecond=parseInt(s):"PreviewFirstFrame"===t||"PreviewLastFrame"===t||"PreviewFrameStep"===t||console.warn("Unexpected key in frame block")}console.error("Parsing block reached content end")}parseObjectBlock(){const e=new v;for(this.animationClip.bodies.push(e);this.lineIndex<this.lines.length;this.lineIndex++){let t=this.lines[this.lineIndex];if(!t)return e;const[s,i]=this.parseLine(t);if("AddNullObject"===s||"LoadObject"===s)if("LoadObject"===s){const t=(0,a.vt)(i);e.lowerName=t.slice(0,t.length-".lwo".length).toLowerCase(),e.filename=this.path+t,e.model=gt.getLwoModel(e.filename)}else{if("AddNullObject"!==s)throw"Unexpected line: "+t;{const t=i.split(",");e.lowerName=t[0].toLowerCase(),"sfx"===e.lowerName?(e.sfxName=t[1]||null,e.sfxFrames=t.slice(2).map((e=>Number(e)))):"snd"===e.lowerName&&t[1].equalsIgnoreCase("SFX_LANDSLIDE")&&(e.sfxName=p.d[p.d.SFX_FallIn],e.sfxFrames=t.slice(2).map((e=>Number(e)))),e.model=new st,e.isNull=!0}}else if("ObjectMotion"===s){let t=this.lines[++this.lineIndex];const s=parseInt(t);t=this.lines[++this.lineIndex];const i=parseInt(t);this.lineIndex++;for(let t=0;t<i;t++){let i=this.lines[this.lineIndex+2*t];if(i.startsWith("EndBehavior"))break;const r=i.split(" ").map(Number);r.length!==s&&console.warn("Number of infos ("+r.length+") does not match if specified count ("+s+")"),i=this.lines[this.lineIndex+2*t+1];const n=parseInt(i.split(" ")[0]);e.setFrameAndFollowing(n,this.animationClip.lastFrame,r)}this.lineIndex+=2*i}else if("ParentObject"===s)e.parentObjInd=Number(i)-1,this.verbose&&console.log("parent obj ind is: "+e.parentObjInd);else if("ShowObject"===s||"LockedChannels"===s);else if("ShadowOptions"===s);else if("ObjDissolve"===s)if("(envelope)"==i){let t=this.lines[++this.lineIndex];const s=parseInt(t);1!==s&&console.error("Number of information channels for opacity is not 1, but: "+s),t=this.lines[++this.lineIndex];const i=parseInt(t);this.lineIndex++;for(let t=0;t<i;t++){let s=this.lines[this.lineIndex+2*t];if(s.startsWith("EndBehavior"))break;const i=1-Number(s);s=this.lines[this.lineIndex+2*t+1];const r=Number(s.split(" ")[0]);e.setOpacityAndFollowing(r,this.animationClip.lastFrame,i)}this.lineIndex+=2*i}else{const t=1-Number(i);e.setOpacityAndFollowing(0,this.animationClip.lastFrame,t)}else"PivotPoint"===s?e.pivot=(new h.Pa4).fromArray(i.split(" ").map((e=>Number(e)))):this.verbose&&console.warn("Unhandled line in object block: "+t+"; key: "+s+"; value: "+i)}return console.error("Parsing block reached content end"),e}}class rt extends h.xoR{constructor(e){super({side:h.ehD,alphaToCoverage:!0,shininess:0}),this.textures=[],this.sequenceInterval=null,this.name=e}clone(){const e=super.clone();return e.setTextures(this.textures),e}dispose(){super.dispose(),this.sequenceInterval=(0,a.nJ)(this.sequenceInterval)}setTextures(e){if(this.textures=e,this.sequenceInterval=(0,a.nJ)(this.sequenceInterval),!(e.length<1)){if(e.length>1){let t=0;this.sequenceInterval=setInterval((()=>{this.map=e[t++],t>=e.length&&(t=0)}),1e3/l.a4)}this.map=e[0],this.color.set(16777215)}}setOpacity(e){this.opacity=e,this.transparent=this.transparent||this.opacity<1}}const nt=1448366670;function at(e,t){let s=new h.Pa4;return s.x=e.getFloat32(t),s.y=e.getFloat32(t+4),s.z=e.getFloat32(t+8),s}class ot{constructor(e,t=null,s=!1){this.verbose=!1,this.materials=[],this.geometry=new h.u9r,this.vertices=null,this.indices=null,this.uvs=null,this.verbose=s,this.meshPath=e,this.entityPath=t}parsePoints(e,t,s){if(s%12!=0)return void console.error("LWOLoader.parse: F12 does not evenly divide into chunk size ("+s+"). Possible corruption.");let i=s/4/3;this.vertices=new Float32Array(3*i),this.uvs=new Float32Array(2*i);for(let s=0;s<i;s++){let i=3*s,r=4*i;this.vertices[i]=e.getFloat32(t+r),this.vertices[i+1]=e.getFloat32(t+r+4),this.vertices[i+2]=e.getFloat32(t+r+8)}}parseSurfaceNames(e,t,s){let i=(new TextDecoder).decode(new Uint8Array(e,t,s));this.materials=i.split("\0").filter((e=>!!e)).map((e=>new rt(e))),this.verbose&&console.log("LWO contains "+this.materials.length+" materials with following names: "+this.materials.map((e=>e.name)))}parsePolygons(e,t,s){let i=0,r=0;for(;r<s;){const s=e.getInt16(t+r),n=e.getInt16(t+r+2+2*s);this.geometry.addGroup(i,3*(s-2),n-1),i+=3*(s-2),r+=4+2*s}r=0;let n=0;for(this.indices=new Uint16Array(i);r<s;){let s=e.getInt16(t+r);r+=2;let i=new Int16Array(s);for(let n=0;n<=s;n++)i[n]=e.getInt16(t+r+2*n);for(let e=0;e<s-2;e++)this.COUNTER_CLOCKWISE?(this.indices[n++]=i[0],this.indices[n++]=i[e+2],this.indices[n++]=i[e+1]):(this.indices[n++]=i[0],this.indices[n++]=i[e+1],this.indices[n++]=i[e+2]);r+=2+2*s}}parseSurface(e,t,s,i){var r;let n=0;for(;0!==e.getUint8(s+n);)n++;let o=(0,a.v5)(new Uint8Array(t,s,n));this.verbose&&console.log("Parsing surface: "+o);let l=-1,c=null;for(let e=0;e<this.materials.length;e++)this.materials[e].name===o&&(l=e,c=this.materials[e]);if(!c)return void console.error("LWOLoader.parse: Surface in SURF chunk does not exist in SRFS");let u=0,d=new h.Pa4(0,0,0),g=new h.Pa4(0,0,0);for(;n<i;){const i=s+n;if(0===e.getUint8(i))n++;else{const s=e.getInt32(i),o=e.getInt16(i+4);switch(this.verbose&&console.log("Parsing sub-chunk "+(new TextDecoder).decode(new Uint8Array(t,i,4))+" at "+i+"; length "+o),s){case 1129270354:const n=[e.getUint8(i+6+0)/255,e.getUint8(i+6+1)/255,e.getUint8(i+6+2)/255];c.color=(new h.Ilk).fromArray(n),this.verbose&&console.log("Material color (COLR): "+n.join(" "));break;case 1179402567:const l=e.getUint16(i+6);this.verbose&&console.log("Flags (FLAG): "+l.toString(2)),this.verbose&&2&l&&console.warn("Flag is set but unhandled: outline"),this.verbose&&4&l&&console.warn("Flag is set but unhandled: smoothing"),this.verbose&&8&l&&console.warn("Flag is set but unhandled: colorHighlights"),this.verbose&&16&l&&console.warn("Flag is set but unhandled: colorFilter"),this.verbose&&32&l&&console.warn("Flag is set but unhandled: opaqueEdge"),this.verbose&&64&l&&console.warn("Flag is set but unhandled: transparentEdge"),this.verbose&&128&l&&console.warn("Flag is set but unhandled: sharpTerminator"),256&l&&(c.side=h.ehD),512&l&&(c.blending=h.WMw,c.depthWrite=!1),this.verbose&&1024&l&&console.warn("Flag is set but unhandled: shadowAlpha");break;case 1162102597:const p=e.getFloat32(i+6);this.verbose&&console.warn("Edge transparency threshold (0.0 to 1.0): "+p);break;case 1280658761:const y=e.getInt16(i+6)/256;this.verbose&&console.log("Luminosity (LUMI): "+y),c.emissiveIntensity=y;break;case 1145652806:const m=e.getInt16(i+6)/256;this.verbose&&console.log("Diffuse (DIFF): "+m),m||(c.color=null);break;case 1397769539:const v=e.getInt16(i+6)/256;this.verbose&&console.warn("Specular (SPEC): "+v);break;case 1380271692:let f=0;f=1447449164===f?e.getFloat32(i+6):e.getInt16(i+6)/256,c.reflectivity=f,this.verbose&&console.log("Reflectivity (REFL): "+c.reflectivity);break;case 1414676814:case nt:let w=0;w=s===nt?e.getFloat32(i+6):e.getInt16(i+6)/256,c.setOpacity(1-w),this.verbose&&console.log("Opacity (TRAN/VTRN): "+c.opacity);break;case 1447843149:const E=e.getFloat32(i+6);this.verbose&&console.log("Luminosity (VLUM): "+E),c.emissiveIntensity=E;break;case 1447315782:let b=e.getFloat32(i+6);this.verbose&&console.log("Diffuse (VDIF): "+b);break;case 1448300611:let S=e.getFloat32(i+6);this.verbose&&console.warn("Specular (VSPC): "+S);break;case 1413893191:u=e.getUint16(i+6),this.verbose&&console.log("Flags (TFLG): "+u.toString(2)),this.verbose&&1&u&&console.warn("Flag is set but unhandled: X Axis"),this.verbose&&2&u&&console.warn("Flag is set but unhandled: Y Axis"),this.verbose&&4&u&&console.warn("Flag is set but unhandled: Z Axis"),this.verbose&&8&u&&console.warn("Flag is set but unhandled: World Coords"),this.verbose&&16&u&&console.warn("Flag is set but unhandled: Negative Image"),this.verbose&&32&u&&console.warn("Flag is set but unhandled: Pixel Blending"),this.verbose&&64&u&&console.log("Flag is set: Antialiasing");break;case 1414744410:d=at(e,i+6),this.verbose&&console.warn("Texture size (TSIZ): "+d.toArray().join(" "));break;case 1413698642:g=at(e,i+6),this.verbose&&console.warn("Texture center (TCTR): "+g.toArray().join(" "));break;case 1129596248:case 1146373464:case 1398031704:case 1381254488:case 1414808920:case 1112819032:const M=(0,a.jG)(new Uint8Array(t,i+6,o));this.verbose&&console.log("Texture typename: "+M);break;case 1413696594:const T=e.getUint16(i+6)/256;this.verbose&&console.warn("Texture value (TVAL): "+T);break;case 1413696594:const L=[e.getUint8(i+6+0)/255,e.getUint8(i+6+1)/255,e.getUint8(i+6+2)/255,e.getUint8(i+6+3)/255];this.verbose&&console.log("Texture color (TCLR): "+L.join(" "));break;case 1414090055:const A=(0,a.jG)(new Uint8Array(t,i+6,o));this.verbose&&console.log("Texture filepath (TIMG): "+A);const R=null===(r=(0,a.vt)(A))||void 0===r?void 0:r.toLowerCase();if(!R||"(none)"===R)break;c.transparent=c.transparent||!!R.match(/a\d\d\d\D.*bmp/i);const C=R.endsWith("(sequence)"),P=R.substring(0,R.length-"(sequence)".length).trim();let I=[];if(C){const e=P.match(/(.+\D)0+(\d+)\..+/i);I=gt.getTexturesBySequenceName(this.meshPath+e[1])}else{const e=gt.getMeshTexture(R,this.meshPath,this.entityPath);I=e?[e]:[]}c.setTextures(I);break;default:this.verbose&&console.warn("Found unrecognised SURF sub-chunk type "+(new TextDecoder).decode(new Uint8Array(t,i,4))+" at "+i+"; length "+o)}n+=6+o}}!function(e,t,s,i,r,n,a,o){if(7&o)for(let l of e.groups)if(l.materialIndex===r)for(let e=l.start;e<l.start+l.count;e++){let r=3*i[e],l=t[r]-a.x,h=t[r+1]-a.y,c=t[r+2]-a.z,u=2*i[e],d=0,g=0;1&o?(d=c/n.z+.5,g=h/n.y+.5):2&o?(d=l/n.x+.5,g=c/n.z+.5):4&o&&(d=l/n.x+.5,g=h/n.y+.5),s[u]=d,s[u+1]=g}}(this.geometry,this.vertices,this.uvs,this.indices,l,d,g,u)}parse(e){const t=new DataView(e);if(1179603533!==t.getUint32(0))return void console.error("LWOLoader.parse: Cannot find header.");const s=t.getUint32(4);if(s+8!==t.byteLength&&console.warn("LWOLoader.parse: Discrepancy between size in header ("+(s+8)+" bytes) and actual size ("+t.byteLength+" bytes)."),1280790338!==t.getUint32(8)){const t=(0,a.v5)(new Uint8Array(e,8,4));return void console.error("LWOLoader.parse: Invalid magic ID ("+t+") in LWO header.")}let i=12;for(;i<t.byteLength;)if(0===t.getUint8(i))i++;else{const s=t.getInt32(i),r=t.getInt32(i+4);switch(i+=8,s){case 1347310675:this.parsePoints(t,i,r);break;case 1397900883:this.parseSurfaceNames(e,i,r);break;case 1347374163:this.parsePolygons(t,i,r);break;case 1398100550:this.parseSurface(t,e,i,r);break;default:console.warn("Found unrecognised chunk type "+(0,a.v5)(new Uint8Array(e,i-8,4))+" at "+i)}i+=r}return this.geometry.setAttribute("position",new h.TlE(this.vertices,3)),this.geometry.setAttribute("uv",new h.TlE(this.uvs,2)),this.geometry.setIndex(new h.TlE(this.indices,1)),this.geometry.computeVertexNormals(),new st(this.geometry,this.materials)}}var lt=s(332);class ht{constructor(e,t){this.wad0FileUrl=e,this.wad1FileUrl=t}}var ct,ut,dt=s(346);class gt extends lt.E{static startLoadingFromCache(){return this.startLoading(null)}static startLoadingFromUrl(e,t){return this.startLoading(new ht(e,t))}static startLoading(e){this.worker.onmessage=e=>{var t;const s=e.data;s.type===dt.n.ASSET?(s.assetNames.forEach((e=>this.resourceByName.set(e.toLowerCase(),s.assetObj))),null===(t=s.sfxKeys)||void 0===t||t.forEach((e=>this.sfxByKey.set(e,s.assetObj))),this.onAssetLoaded()):s.type===dt.n.MSG?this.onMessage(s.text):s.type===dt.n.CFG?(this.configuration=s.cfg,this.stats=s.stats,this.loadDefaultCursor(),this.onInitialLoad(s.totalResources)):s.type===dt.n.CACHE_MISS?this.onCacheMissed():s.type===dt.n.DONE&&(this.loadAllCursor(),console.log("Loading of about "+s.totalResources+" assets complete! Total load time: "+s.loadingTimeSeconds+" seconds."),this.onLoadDone())},this.worker.postMessage(e)}static getTexturesBySequenceName(e){const t=null==e?void 0:e.toLowerCase(),s=[];return this.resourceByName.forEach(((e,i)=>{i.startsWith(t)&&s.push(i)})),s.length>0?s.map((e=>this.getTexture(e))):t.startsWith("world/shared/")?(console.warn("Texture sequence not found: "+t),[]):this.getTexturesBySequenceName("world/shared/"+(0,a.vt)(t))}static getMeshTexture(e,t,s){const i=null==e?void 0:e.toLowerCase(),r=(null==t?void 0:t.toLowerCase())+i,n=this.resourceByName.getOrUpdate(r,(()=>{const t=s?s.toLowerCase()+i:null;return s?this.resourceByName.getOrUpdate(t,(()=>this.getImgDataFromSharedPaths(i,e,r,t))):this.getImgDataFromSharedPaths(i,e,r,t)}));if(!n)return null;const a=new h.xEZ(n,h.xEZ.DEFAULT_MAPPING,h.rpg,h.rpg);return a.needsUpdate=!0,a}static getImgDataFromSharedPaths(e,t,s,i){const r="vehicles/sharedug/"+e;return this.resourceByName.getOrUpdate(r,(()=>{const r="world/shared/"+e;return this.resourceByName.getOrUpdate(r,(()=>"teofoilreflections.jpg"!==e&&"wingbase3.bmp"!==e&&"a_side.bmp"!==e&&"a_top.bmp"!==e?(console.warn("Texture '"+t+"' ("+s+", "+i+", "+r+") unknown! Using placeholder texture instead"),(0,c.BT)(64,64)):null))}))}static getTexture(e){if(!e)throw"textureFilepath must not be undefined, null or empty - was "+e;const t=this.resourceByName.get(e.toLowerCase());if(!t)return null;const s=new h.xEZ(t,h.xEZ.DEFAULT_MAPPING,h.rpg,h.rpg);return s.needsUpdate=!0,s}static getAnimationEntityType(e,t){let s=this.getResource(e);if(!s)throw"Could not get animation entity type for: "+e;return class{static loadModels(e,t,s,i=!1){const r=(0,a.DW)(e),n=new d;return Object.keys(t).forEach((e=>{const s=t[e];if(e.equalsIgnoreCase("Scale"))n.scale=Number(s);else if(e.equalsIgnoreCase("CarryNullName"))n.carryNullName=s;else if(e.equalsIgnoreCase("CarryNullFrames"))n.carryNullFrames=Number(s);else if(e.equalsIgnoreCase("Shape"))i&&console.warn("TODO Derive buildings shape from this value");else if(e.equalsIgnoreCase("DepositNullName"))n.depositNullName=s;else if(e.equalsIgnoreCase("ToolNullName"))n.toolNullName=s;else if(e.equalsIgnoreCase("WheelMesh")){if(!"NULL_OBJECT".equalsIgnoreCase(s)){const e=r+s+".lwo";n.wheelMesh=gt.getLwoModel(e),n.wheelMesh||console.error("Could not load wheel mesh from: "+e)}}else e.equalsIgnoreCase("WheelRadius")?n.wheelRadius=Number(s):e.equalsIgnoreCase("WheelNullName")?n.wheelNullName=s:e.equalsIgnoreCase("DrillNullName")?n.drillNullName=s:e.equalsIgnoreCase("DriverNullName")?n.driverNullName=s:e.equalsIgnoreCase("CameraNullName")?n.cameraNullName=s:e.equalsIgnoreCase("CameraNullFrames")?n.cameraNullFrames=Number(s):e.equalsIgnoreCase("CameraFlipDir")||(e.equalsIgnoreCase("HighPoly")?Object.keys(s).forEach((e=>{const t=e.startsWith("!")?e.slice(1):e,i=gt.getLwoModel(r+s[e]+".lwo");n.highPolyBodies.set(t.toLowerCase(),i)})):e.equalsIgnoreCase("MediumPoly")||e.equalsIgnoreCase("LowPoly")||e.equalsIgnoreCase("FPPoly")||(e.equalsIgnoreCase("Activities")?n.animations=this.parseAnimations(s,t,r,i):e.equalsIgnoreCase("Upgrades")?n.upgradesByLevel=this.parseUpgrades(s):e.match(/level\d\d\d\d/i)||i&&!s.lwsfile&&console.warn("Unhandled animated entity key found: "+e,s)))})),n.animations.forEach((e=>{e.bodies.forEach((t=>{let i=n.highPolyBodies.get(t.lowerName);i||(i=n.mediumPolyBodies.get(t.lowerName)),i||(i=t.model);const r=i.clone();if(e.polyList.push(r),t.lowerName&&(t.lowerName.equalsIgnoreCase(n.carryNullName)?e.carryJoint=r:t.lowerName.equalsIgnoreCase(n.depositNullName)?e.depositJoint=r:t.lowerName.equalsIgnoreCase(n.toolNullName)?e.getToolJoint=r:t.lowerName.equalsIgnoreCase(n.wheelNullName)?e.wheelJoints.push(r):t.lowerName.equalsIgnoreCase(n.drillNullName)?e.drillJoint=r:t.lowerName.equalsIgnoreCase(n.driverNullName)?e.driverJoint=r:t.isNull&&e.nullJoints.getOrUpdate(t.lowerName.toLowerCase(),(()=>[])).push(r)),t.sfxName){const i=new h.VYz(s);i.setRefDistance(6*l.pM),i.loop=!1,r.add(i),u.P.getSoundBuffer(t.sfxName).then((e=>{i.setBuffer(e)})),t.sfxFrames.forEach((t=>e.sfxAudioByFrame.getOrUpdate(t,(()=>[])).push(i)))}})),n.wheelMesh&&e.wheelJoints.forEach((e=>{e.add(n.wheelMesh.clone(!0))}));const t=n.upgradesByLevel.get("0000");t&&t.forEach((t=>{var i,r;const n=null===(i=e.nullJoints.get(t.upgradeNullName.toLowerCase()))||void 0===i?void 0:i[t.upgradeNullIndex];if(n){const e=gt.getLwoModel(t.upgradeFilepath+".lwo");e?n.add(e):null===(r=gt.getAnimationEntityType(t.upgradeFilepath+"/"+t.upgradeFilepath.split("/").last()+".ae",s).animations.get("activity_stand"))||void 0===r||r.bodies.forEach((e=>n.add(e.model.clone())))}})),e.polyModel.scale.setScalar(n.scale),e.bodies.forEach(((t,s)=>{const i=e.polyList[s],r=t.parentObjInd;null!=r?e.polyList[r].add(i):e.polyModel.add(i)}))})),n}static parseAnimations(e,t,s,i){const r=new Map;return Object.keys(e).forEach((n=>{try{let o=(0,a.hh)(e,n);const l=(0,a.hh)(t,o),h=(0,a.hh)(l,"FILE"),c=!0===(0,a.hh)(l,"LWSFILE"),u=(0,a.hh)(l,"TRANSCOEF"),d=!0===(0,a.hh)(l,"LOOPING");if(c){const e=gt.getResource(s+h+".lws"),t=new it(s,i).parse(e);t.looping=d,t.transcoef=u?Number(u):1,r.set(n.toLowerCase(),t)}else console.error("Found activity which is not an LWS file")}catch(s){console.error(s),console.log(t),console.log(e),console.log(n)}})),r}static parseUpgrades(e){const t=new Map;return Object.keys(e).forEach((s=>{const i=s.match(/level(\d\d\d\d)/i);if(i){const r=e[s];t.set(i[1],Object.keys(r).map((e=>{const t=gt.cfg("UpgradeTypes",e),s=r[e][0][0],i=Number(r[e][1][0])-1;return new g(t,s,i)})))}else console.warn("Unexpected upgrade level key: "+s)})),t}}.loadModels(e,s,t)}static getLwoModel(e,t=null){var s;return null===(s=this.lwoCache.getOrUpdate(e.toLowerCase(),(()=>{const s=gt.getResource(e);return s?new ot((0,a.DW)(e),t).parse(s):null})))||void 0===s?void 0:s.clone()}}gt.worker=new Worker(new URL(s.p+s.u(25),s.b)),gt.lwoCache=new Map,gt.onMessage=e=>{console.log(e)},gt.onCacheMissed=()=>{console.log("Worker missed cache")},gt.onInitialLoad=()=>{console.log("Initial loading done.")},gt.onAssetLoaded=()=>{},gt.onLoadDone=()=>{};class pt{constructor(){this.selection=new Se,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.materials=[],this.materialsUndiscovered=[],this.buildingSites=[],this.spiders=[],this.bats=[],this.rockMonsters=[],this.vehicles=[],this.vehiclesUndiscovered=[],M.registerEventListener(S.Z.SELECTION_CHANGED,(e=>{e.selectPanelType===D.NONE&&this.selection.deselectAll()}))}reset(){this.selection=new Se,this.buildings=[],this.buildingsUndiscovered=[],this.raiders=[],this.raidersUndiscovered=[],this.materials=[],this.materialsUndiscovered=[],this.buildingSites=[],this.spiders=[],this.bats=[],this.rockMonsters=[],this.vehicles=[],this.vehiclesUndiscovered=[]}start(){}stop(){this.buildings.forEach((e=>e.removeFromScene())),this.buildingsUndiscovered.forEach((e=>e.removeFromScene())),this.raiders.forEach((e=>e.removeFromScene())),this.raidersUndiscovered.forEach((e=>e.removeFromScene())),this.materials.forEach((e=>e.removeFromScene())),this.materialsUndiscovered.forEach((e=>e.removeFromScene())),this.spiders.forEach((e=>e.removeFromScene())),this.bats.forEach((e=>e.removeFromScene()))}getBuildingsByType(...e){return this.buildings.filter((t=>t.isUsable()&&e.some((e=>t.entityType===e))))}getClosestBuildingByType(e,...t){return pt.getClosestBuilding(this.getBuildingsByType(...t),e)}getTrainingSites(e){return this.buildings.filter((t=>t.isTrainingSite(e)))}getClosestTrainingSite(e,t){return pt.getClosestBuilding(this.getTrainingSites(t),e)}static getClosestBuilding(e,t){let s=null,i=null;return e.forEach((e=>{const r=e.getPosition(),n=t.distanceToSquared(r);(null===s||n<i)&&(s=e,i=n)})),s}getMaxRaiders(){return l.d+this.buildings.count((e=>e.isUsable()&&e.entityType===b.BARRACKS))*l.oq}discoverSurface(e){const t=e.x*l.pM,s=e.y*l.pM,i=t+l.pM,r=s+l.pM;this.discoverEntities(this.raidersUndiscovered,t,i,s,r),this.discoverEntities(this.buildingsUndiscovered,t,i,s,r),this.discoverEntities(this.materialsUndiscovered,t,i,s,r)}discoverEntities(e,t,s,i,r){const n=[];e.forEach((e=>{const a=e.getPosition();a.x>=t&&a.x<s&&a.z>=i&&a.z<r&&(e.onDiscover(),n.push(e))})),n.forEach((t=>e.remove(t)))}placeMaterial(e,t){return e.addToScene(t,0),e.sceneEntity.visible?(this.materials.push(e),M.publishEvent(new $(e.createCarryJob()))):this.materialsUndiscovered.push(e),e}getOxygenSum(){return this.raiders.map((e=>e.stats.OxygenCoef)).reduce(((e,t)=>e+t),0)+this.buildings.map((e=>e.isUsable()?e.stats.OxygenCoef:0)).reduce(((e,t)=>e+t),0)}hasMaxRaiders(){return this.raiders.length>=this.getMaxRaiders()}}class yt{constructor(e){this.entity=e,this.counter=6*l.pM,M.publishEvent(new U);const t=new Oe("Mini-Figures/Pilot/VLP_TelepUp.lws",this.entity.sceneMgr.listener);t.position.copy(this.entity.getPosition()),t.rotateOnAxis(new h.Pa4(0,1,0),this.entity.getHeading()),this.entity.sceneMgr.scene.add(t),t.startAnimation((()=>{this.entity.removeFromScene(),this.entity.sceneMgr.scene.remove(t)})),setInterval((()=>this.update(l.l3)),l.l3)}update(e){this.counter>0&&(this.counter--,this.entity.sceneEntity.position.y+=l.pM/l.OK/2*(e/l.l3))}}class mt extends Ve{constructor(e,t,s,i){super(e,t,b.BARRIER,"MiscAnims/Barrier/Barrier.ae"),this.site=i,this.heading=s.heading,this.priorityIdentifier=N.aiPriorityConstruction,this.changeActivity(),this.targets=[new He(s.location,this.site)]}updateTargets(){var e;if(null===(e=this.site)||void 0===e?void 0:e.canceled){this.site=null;const e=this.entityMgr.getClosestBuildingByType(this.getPosition(),b.TOOLSTATION);this.targets=[new Je(e)]}return this.targets}getDefaultActivity(){return ae.Short}onAddToSite(){super.onAddToSite(),this.sceneEntity.setHeading(this.heading),this.changeActivity(ae.Expand,(()=>this.changeActivity(ae.Long)))}}class vt extends De{onJobComplete(){super.onJobComplete(),this.item.targetSurface.canPlaceFence()&&(this.item.addToScene(null,null),this.item.targetSurface.fence=this.item)}}class ft extends Ve{constructor(e,t,s){super(e,t,b.ELECTRIC_FENCE);const i=gt.getLwoModel("Buildings/E-Fence/E-Fence4.lwo");this.sceneEntity.add(i),this.targetSurface=s,this.priorityIdentifier=N.aiPriorityConstruction}updateTargets(){return this.targets.length<1?this.targetSurface.canPlaceFence()?this.targets=[new Ge(this.targetSurface.getCenterWorld2D())]:this.targets=this.entityMgr.getBuildingsByType(...this.getTargetBuildingTypes()).map((e=>new Je(e))):this.targetSurface.canPlaceFence()||this.targets[0].building||(this.targets=this.entityMgr.getBuildingsByType(...this.getTargetBuildingTypes()).map((e=>new Je(e)))),this.targets}createCarryJob(){return new vt(this)}}class wt extends Ue{constructor(e,t,s,i){super(e,t,s,i),this.blocksPathSurface=!0,this.secondaryBuildingPart=null,this.primaryPowerPath=new h.FM8(0,1),this.secondaryPowerPath=null,this.waterPathSurface=null,this.level=0,this.powerSwitch=!0,this.spawning=!1,this.primarySurface=null,this.secondarySurface=null,this.primaryPathSurface=null,this.secondaryPathSurface=null,this.upgradeCostOre=0,this.upgradeCostBrick=0,this.crystalsInUse=0,this.inBeam=!1,this.beamUpAnimator=null,this.pathTarget=null,this.sceneEntity.flipXAxis(),this.upgradeCostOre=gt.cfg("Main","BuildingUpgradeCostOre"),this.upgradeCostBrick=gt.cfg("Main","BuildingUpgradeCostStuds"),M.registerEventListener(S.Z.MATERIAL_AMOUNT_CHANGED,(()=>{this.updatePowerState()}))}isSelectable(){return!this.selected&&!this.inBeam}isInSelection(){return this.isSelectable()||this.selected}select(){return!!this.isSelectable()&&(this.sceneEntity.selectionFrame.visible=!0,this.selected=!0,!0)}deselect(){this.sceneEntity.selectionFrame.visible=!1,this.selected=!1}getDropPosition2D(){var e,t;if(null===(e=this.animation)||void 0===e?void 0:e.getToolJoint){const e=new h.Pa4;return this.animation.getToolJoint.getWorldPosition(e),new h.FM8(e.x,e.z)}if(null===(t=this.animation)||void 0===t?void 0:t.depositJoint){const e=new h.Pa4;return this.animation.depositJoint.getWorldPosition(e),new h.FM8(e.x,e.z)}return this.getPosition2D()}isUsable(){return!this.inBeam&&this.powerSwitch&&(this.isPowered()||this.stats.PowerBuilding)&&this.sceneEntity.visible}isPowered(){return this.stats.SelfPowered||this.crystalsInUse>0}onDiscover(){super.onDiscover(),this.entityMgr.buildingsUndiscovered.remove(this),this.entityMgr.buildings.push(this),M.publishEvent(new H(this.entityMgr))}hasMaxLevel(){return this.level>=this.stats.Levels-1}upgrade(){this.canUpgrade()&&(o.numBrick>=this.upgradeCostBrick?o.numBrick-=this.upgradeCostBrick:o.numOre-=this.upgradeCostOre,M.publishEvent(new te),this.level++,M.publishEvent(new U),M.publishEvent(new H(this.entityMgr)))}setLevel(e){this.level=e,M.publishEvent(new H(this.entityMgr))}getDefaultActivity(){return this.isPowered()?ne.Stand:We.Unpowered}beamUp(){o.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.inBeam=!0;for(let e=0;e<this.stats.CostOre;e++)this.entityMgr.placeMaterial(new Ke(this.sceneMgr,this.entityMgr),this.primarySurface.getRandomPosition());for(let e=0;e<this.stats.CostCrystal;e++)this.entityMgr.placeMaterial(new qe(this.sceneMgr,this.entityMgr),this.primarySurface.getRandomPosition());this.surfaces.forEach((e=>e.setBuilding(null))),this.pathTarget=null,this.beamUpAnimator=new yt(this),M.publishEvent(new H(this.entityMgr))}removeFromScene(){super.removeFromScene(),this.entityMgr.buildings.remove(this)}canUpgrade(){return!this.hasMaxLevel()&&(o.numOre>=this.upgradeCostOre||o.numBrick>=this.upgradeCostBrick)}spawnMaterials(e,t){const s=[];if(e===b.CRYSTAL)for(;o.numCrystal>0&&s.length<t;)o.numCrystal--,s.push(new qe(this.sceneMgr,this.entityMgr));else if(e===b.ORE)for(;o.numOre>0&&s.length<t;)o.numOre--,s.push(new Ke(this.sceneMgr,this.entityMgr));else console.error("Material drop not implemented for: "+e);s.length>0&&M.publishEvent(new te),s.forEach((e=>this.entityMgr.placeMaterial(e,this.getDropPosition2D())))}spawnBarriers(e,t){e.map((e=>new mt(this.sceneMgr,this.entityMgr,e,t))).forEach((e=>this.entityMgr.placeMaterial(e,this.getDropPosition2D())))}spawnFence(e){this.entityMgr.placeMaterial(new ft(this.sceneMgr,this.entityMgr,e),this.getDropPosition2D())}setPowerSwitch(e){this.powerSwitch=e,this.updatePowerState()}updatePowerState(){this.powerSwitch?this.turnPowerOn():this.turnPowerOff()}turnPowerOn(){this.crystalsInUse>0||this.stats.SelfPowered||o.usedCrystals>=o.numCrystal||this.entityType!==b.POWER_STATION&&!this.surfaces.some((e=>e.neighbors.some((e=>e.hasPower))))||(this.crystalsInUse=1,o.usedCrystals+=this.crystalsInUse,this.surfaces.forEach((e=>e.setHasPower(!0,!0))),this.changeActivity(),M.publishEvent(new H(this.entityMgr)),this.stats.EngineSound&&(this.engineSound=this.playPositionalAudio(this.stats.EngineSound,!0)))}turnPowerOff(){var e;this.crystalsInUse<1||(o.usedCrystals-=this.crystalsInUse,this.crystalsInUse=0,this.surfaces.forEach((e=>e.setHasPower(!1,!1))),this.changeActivity(),M.publishEvent(new H(this.entityMgr)),null===(e=this.engineSound)||void 0===e||e.stop(),this.engineSound=null)}get surfaces(){const e=[];return this.primarySurface&&e.push(this.primarySurface),this.secondarySurface&&e.push(this.secondarySurface),this.primaryPathSurface&&e.push(this.primaryPathSurface),this.secondaryPathSurface&&e.push(this.secondaryPathSurface),e}placeDown(e,t,s){if(this.primarySurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(e),this.primarySurface.setBuilding(this),this.secondaryBuildingPart){const s=new h.FM8(l.pM*this.secondaryBuildingPart.x,l.pM*this.secondaryBuildingPart.y).rotateAround(new h.FM8(0,0),-t).add(e);this.secondarySurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(s),this.secondarySurface.setBuilding(this)}if(this.primaryPowerPath){const s=new h.FM8(this.primaryPowerPath.x,this.primaryPowerPath.y).multiplyScalar(l.pM).rotateAround(new h.FM8(0,0),-t).add(e);this.primaryPathSurface=this.sceneMgr.terrain.getSurfaceFromWorld2D(s),this.primaryPathSurface.setSurfaceType(A.POWER_PATH_BUILDING)}this.addToScene(e,t),this.sceneEntity.createPickSphere(this.stats.PickSphere,this,this.stats.PickSphere/4),this.sceneEntity.visible?this.entityMgr.buildings.push(this):this.entityMgr.buildingsUndiscovered.push(this),this.sceneEntity.visible&&!s?(this.inBeam=!0,this.changeActivity(We.Teleport,(()=>{this.inBeam=!1,this.onPlaceDown()}))):this.onPlaceDown(),this.sceneMgr.terrain.resetGraphWalk()}onPlaceDown(){this.changeActivity(),this.updatePowerState(),M.publishEvent(new H(this.entityMgr))}getDropAction(){return oe.Place}getTrainingTargets(){return[new h.FM8(-1,0),new h.FM8(0,1),new h.FM8(1,0),new h.FM8(0,-1)].map((e=>new le(e.multiplyScalar(l.pM/2).add(this.primarySurface.getCenterWorld2D()))))}addToScene(e,t){super.addToScene(e,t),this.pathTarget=new fe(this)}getPathTarget(){return this.pathTarget}isTrainingSite(e){return this.entityType===I[e]&&this.isUsable()&&this.stats[x[e]][this.level]}}class Et extends wt{constructor(e,t){super(e,t,b.BARRACKS,"Buildings/Barracks/Barracks.ae")}get stats(){return gt.stats.Barracks}}class bt extends wt{constructor(e,t){super(e,t,b.DOCKS,"Buildings/Docks/Docks.ae"),this.primaryPowerPath=new h.FM8(0,-1),this.waterPathSurface=new h.FM8(0,1)}get stats(){return gt.stats.Docks}}class St extends wt{constructor(e,t){super(e,t,b.GEODOME,"Buildings/Geo-dome/Geo-dome.ae"),this.primaryPowerPath=null,this.secondaryBuildingPart=new h.FM8(0,1)}get stats(){return gt.stats.Geodome}}class Mt extends wt{constructor(e,t){super(e,t,b.GUNSTATION,"Buildings/gunstation/gunstation.ae"),this.primaryPowerPath=null}getDefaultActivity(){return We.Stand}get stats(){return gt.stats.GunStation}}class Tt extends wt{constructor(e,t){super(e,t,b.ORE_REFINERY,"Buildings/OreRefinery/OreRefinery.ae"),this.primaryPowerPath=new h.FM8(0,2),this.secondaryBuildingPart=new h.FM8(0,1)}get stats(){return gt.stats.OreRefinery}getDropAction(){return oe.Deposit}}class Lt extends wt{constructor(e,t){super(e,t,b.POWER_STATION,"Buildings/Powerstation/Powerstation.ae"),this.secondaryBuildingPart=new h.FM8(-1,0)}get stats(){return gt.stats.Powerstation}getDropAction(){return oe.Deposit}}class At extends wt{constructor(e,t){super(e,t,b.TELEPORT_BIG,"Buildings/BIGTeleport/BIGTeleport.ae"),this.secondaryBuildingPart=new h.FM8(1,0),this.secondaryPowerPath=new h.FM8(1,1)}get stats(){return gt.stats.TeleportBIG}}class Rt extends wt{constructor(e,t){super(e,t,b.TELEPORT_PAD,"Buildings/Teleports/Teleports.ae")}get stats(){return gt.stats.TeleportPad}}class Ct extends wt{constructor(e,t){super(e,t,b.TOOLSTATION,"Buildings/Toolstation/Toolstation.ae"),this.blocksPathSurface=!1}get stats(){return gt.stats.Toolstation}}class Pt extends wt{constructor(e,t){super(e,t,b.UPGRADE,null)}get stats(){return gt.stats.Upgrade}}class It extends de{constructor(e,t){var s;super(e,t,null,t,null,null),t.setSurfaceType(A.POWER_PATH_BUILDING_SITE),null===(s=e.getClosestBuildingByType(t.getCenterWorld(),b.TOOLSTATION))||void 0===s||s.spawnMaterials(b.ORE,2),this.neededByType.set(b.ORE,2),e.buildingSites.push(this),M.publishEvent(new U)}}class xt extends we{constructor(){super(...arguments),this.target=[]}getWorkplaces(){return this.target.length<1&&(this.target=[new le(this.raider.getPosition2D())]),this.target}onJobComplete(){this.raider.hungerLevel=1,super.onJobComplete()}getWorkActivity(){return oe.Eat}}class Ot extends we{constructor(e,t,s){super(),this.entityMgr=e,this.training=t,this.building=s,this.workplaces=this.getWorkplaces()}getWorkplaces(){var e;return(null===(e=this.building)||void 0===e?void 0:e.isUsable())||(this.workplaces=[],this.entityMgr.getTrainingSites(this.training).map((e=>e.getTrainingTargets().forEach((e=>this.workplaces.push(e)))))),this.workplaces}onJobComplete(){super.onJobComplete(),this.raider.addTraining(this.training),M.publishEvent(new J(this.entityMgr,this.training))}getWorkActivity(){return oe.Train}getWorkDuration(e){return 1e4}}class Dt extends we{constructor(e){super(),this.building=e,this.workplaces=e.getTrainingTargets()}getWorkplaces(){return this.building.isUsable()?this.workplaces:[]}onJobComplete(){super.onJobComplete(),this.raider.level<this.raider.stats.Levels&&this.raider.level++}getWorkActivity(){return oe.Train}getWorkDuration(e){return 3e4}}class Nt extends ce{constructor(e){super(),this.vehicle=e,this.vehicle.callManJob=this,this.workplaces=[new le(this.vehicle.getPosition2D())]}getWorkplaces(){return this.vehicle.inBeam?(this.jobState=_.INCOMPLETE,[]):this.vehicle.driver?(this.jobState=_.COMPLETE,[]):this.workplaces}onJobComplete(){this.vehicle.addDriver(this.fulfiller[0]),this.vehicle.callManJob=null,super.onJobComplete()}getRequiredTraining(){return this.vehicle.getRequiredTraining()}getPriorityIdentifier(){return N.aiPriorityGetIn}}class _t{constructor(e){this.vec=null,this.targetReached=!1,this.vec=e}}!function(e){e[e.MOVED=0]="MOVED",e[e.TARGET_REACHED=1]="TARGET_REACHED",e[e.TARGET_UNREACHABLE=2]="TARGET_UNREACHABLE"}(ct||(ct={}));class kt extends Ue{constructor(e,t,s,i){super(e,t,s,i),this.currentPath=null}moveToClosestTarget(e){if((null==e?void 0:e.length)||console.warn("No targets given"),!this.currentPath||!e.some((e=>e.targetLocation.equals(this.currentPath.target.targetLocation)))){const t=e.map((e=>this.findPathToTarget(e))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq));if(this.currentPath=t.length>0?t[0]:null,!this.currentPath)return ct.TARGET_UNREACHABLE}const t=this.currentPath.firstLocation;this.sceneEntity.lookAt(new h.Pa4(t.x,this.sceneEntity.position.y,t.y));const s=this.determineStep();return s.targetReached?ct.TARGET_REACHED:(this.sceneEntity.position.add(s.vec),this.changeActivity(this.getRouteActivity()),ct.MOVED)}findPathToTarget(e){return new Qe(e,e.targetLocation)}determineStep(){const e=this.sceneMgr.getFloorPosition(this.currentPath.firstLocation);e.y+=this.floorOffset;const t=new _t(e.sub(this.sceneEntity.position)),s=t.vec.lengthSq(),i=this.getSpeed(),r=i*i;if(this.currentPath.locations.length>1){if(s<=r)return this.currentPath.locations.shift(),this.determineStep()}else s<=r&&(t.targetReached=!0);return t.vec.clampLength(0,i),t}}class Bt extends kt{constructor(e,t,s,i){super(e,t,s,i),this.level=0,this.workInterval=null,this.job=null,this.followUpJob=null,this.carries=null,this.inBeam=!1,this.beamUpAnimator=null,this.workInterval=setInterval(this.work.bind(this),1e3/l.OK)}dropItem(){var e;if(!this.carries)return;const t=this.getPosition();(null===(e=this.animation)||void 0===e?void 0:e.carryJoint)&&(this.animation.carryJoint.remove(this.carries.sceneEntity.group),this.animation.carryJoint.getWorldPosition(t)),this.carries.addToScene(new h.FM8(t.x,t.z),null),this.carries=null}pickupItem(e){var t;this.carries=e,(null===(t=this.animation)||void 0===t?void 0:t.carryJoint)&&this.animation.carryJoint.add(this.carries.sceneEntity.group),this.carries.sceneEntity.position.set(0,0,0)}setJob(e,t=null){this.job!==e&&this.stopJob(),this.job=e,this.job&&this.job.assign(this),this.followUpJob=t,this.followUpJob&&this.followUpJob.assign(this)}stopJob(){var e;null===(e=this.workAudio)||void 0===e||e.stop(),this.workAudio=null,this.dropItem(),this.job&&(this.job.unAssign(this),this.followUpJob&&this.followUpJob.unAssign(this),this.job=null,this.followUpJob=null,this.changeActivity())}deselect(){this.sceneEntity.selectionFrame.visible=!1,this.selected=!1}isSelectable(){return!this.selected&&!this.inBeam}isInSelection(){return this.isSelectable()||this.selected}select(){return!!this.isSelectable()&&(this.sceneEntity.selectionFrame.visible=!0,this.selected=!0,this.changeActivity(),!0)}removeFromScene(){super.removeFromScene(),this.workInterval=(0,a.nJ)(this.workInterval)}beamUp(){this.stopJob(),this.inBeam=!0,this.beamUpAnimator=new yt(this)}moveToClosestTarget(e){var t;const s=super.moveToClosestTarget(e);return this.job.setActualWorkplace(null===(t=this.currentPath)||void 0===t?void 0:t.target),s===ct.TARGET_UNREACHABLE&&(console.log("Entity could not move to job target, stopping job"),this.stopJob()),s}work(){if(this.job&&!this.selected&&!this.inBeam)if(this.job.jobState!==_.INCOMPLETE)this.stopJob();else{const e=this.job.getCarryItem();if(e&&this.carries!==e)this.dropItem(),this.moveToClosestTarget(e.getPositionPathTarget())&&this.changeActivity(oe.Collect,(()=>{this.pickupItem(e)}));else if(this.moveToClosestTarget(this.job.getWorkplaces())===ct.TARGET_REACHED)if(this.job.isReadyToComplete()){const e=this.job.getWorkActivity()||this.getDefaultActivity();this.workAudio||e!==oe.Drill||(this.workAudio=this.playPositionalAudio(p.d[p.d.SFX_Drill],!0)),this.changeActivity(e,(()=>{this.completeJob()}),this.job.getWorkDuration(this))}else this.changeActivity()}}completeJob(){var e,t,s;null===(e=this.workAudio)||void 0===e||e.stop(),this.workAudio=null,this.changeActivity(),null===(t=this.job)||void 0===t||t.onJobComplete(),(null===(s=this.job)||void 0===s?void 0:s.jobState)!==_.INCOMPLETE&&(this.job&&this.job.unAssign(this),this.job=this.followUpJob,this.followUpJob=null)}canDrill(e){var t;return((null===(t=this.stats[e.surfaceType.statsDrillName])||void 0===t?void 0:t[this.level])||0)>0}}class Ft extends Bt{constructor(e,t,s,i){super(e,t,s,i),this.driver=null,this.callManJob=null,this.sceneEntity.flipXAxis()}findPathToTarget(e){return this.sceneMgr.terrain.findDrivePath(this.getPosition2D(),e)}beamUp(){this.dropDriver(),super.beamUp();const e=this.surfaces[0];for(let t=0;t<this.stats.CostOre;t++)this.entityMgr.placeMaterial(new Ke(this.sceneMgr,this.entityMgr),e.getRandomPosition());for(let t=0;t<this.stats.CostCrystal;t++)this.entityMgr.placeMaterial(new qe(this.sceneMgr,this.entityMgr),e.getRandomPosition());M.publishEvent(new V)}setJob(e,t=null){this.driver&&super.setJob(e,t)}addDriver(e){this.driver=e,this.driver.vehicle=this,this.driver.sceneEntity.position.set(0,0,0),this.driver.sceneEntity.setHeading(0),this.driver.changeActivity(this.getDriverActivity()),(this.animation.driverJoint||this.sceneEntity.group).add(this.driver.sceneEntity.group),this.stats.EngineSound&&!this.engineSound&&(this.engineSound=this.playPositionalAudio(this.stats.EngineSound,!0)),this.selected&&M.publishEvent(new F(this.entityMgr))}dropDriver(){var e;this.stopJob(),this.driver&&((this.animation.driverJoint||this.sceneEntity.group).remove(this.driver.sceneEntity.group),this.driver.vehicle=null,this.driver.sceneEntity.position.copy(this.sceneEntity.position),this.driver.sceneEntity.setHeading(this.sceneEntity.getHeading()),this.driver.sceneMgr.scene.add(this.driver.sceneEntity.group),this.driver.changeActivity(),this.driver=null,null===(e=this.engineSound)||void 0===e||e.stop(),this.engineSound=null,this.selected&&M.publishEvent(new F(this.entityMgr)))}getRequiredTraining(){return C.DRIVER}getDriverActivity(){return oe.Stand}addToScene(e,t){super.addToScene(e,t)}getRouteActivity(){return ne.Stand}isPrepared(e){return!1}}class Ut extends Ft{constructor(e,t){super(e,t,b.BULLDOZER,"Vehicles/Bulldozer/Bulldozer.ae")}get stats(){return gt.stats.Bulldozer}}class Wt extends Ft{constructor(e,t){super(e,t,b.HOVERBOARD,"Vehicles/Hoverboard/Hoverboard.ae")}get stats(){return gt.stats.Hoverboard}getDriverActivity(){return oe.Hoverboard}}class Gt extends Ft{constructor(e,t){super(e,t,b.LARGE_CAT,"Vehicles/LargeCat/LargeCat.ae")}get stats(){return gt.stats.LargeCat}getRequiredTraining(){return C.SAILOR}findPathToTarget(e){return this.sceneMgr.terrain.findSwimPath(this.getPosition2D(),e)}}class Ht extends Ft{constructor(e,t){super(e,t,b.LARGE_DIGGER,"Vehicles/LargeDigger/LargeDigger.ae")}get stats(){return gt.stats.LargeDigger}}class Jt extends Ft{constructor(e,t){super(e,t,b.LARGE_MLP,"Vehicles/LMLP/LMLP.ae")}get stats(){return gt.stats.LargeMLP}}class Vt extends Ft{constructor(e,t){super(e,t,b.SMALL_CAT,"Vehicles/SmallCat/SmallCat.ae")}get stats(){return gt.stats.SmallCat}getRequiredTraining(){return C.SAILOR}findPathToTarget(e){return this.sceneMgr.terrain.findSwimPath(this.getPosition2D(),e)}}class qt extends Ft{constructor(e,t){super(e,t,b.SMALL_DIGGER,"Vehicles/SmallDigger/SmallDigger.ae")}get stats(){return gt.stats.SmallDigger}}class jt extends Ft{constructor(e,t){super(e,t,b.SMALL_HELI,"Vehicles/SmallHeli/SmallHeli.ae")}get stats(){return gt.stats.SmallHeli}getRequiredTraining(){return C.PILOT}getDriverActivity(){return oe.SMALLheli}findPathToTarget(e){return this.sceneMgr.terrain.findFlyPath(this.getPosition2D(),e)}}class Zt extends Ft{constructor(e,t){super(e,t,b.SMALL_MLP,"Vehicles/SMLP/SMLP.ae")}get stats(){return gt.stats.Smallmlp}}class Kt extends Ft{constructor(e,t){super(e,t,b.SMALL_TRUCK,"Vehicles/SmallTruck/SmallTruck.ae")}get stats(){return gt.stats.SmallTruck}getDriverActivity(){return oe.SMALLTRUCK}}class Yt extends ne{}Yt.Route=new ne("Activity_Route"),Yt.TeleportIn=new ne("Activity_TeleportIN");class zt extends Ft{constructor(e,t){super(e,t,b.WALKER_DIGGER,"Vehicles/WalkerBody/WalkerBody.ae"),this.walkerLegs=gt.getAnimationEntityType("Vehicles/WalkerLegs/WalkerLegs.ae",e.listener)}get stats(){return gt.stats.WalkerDigger}changeActivity(e=this.getDefaultActivity(),t=null,s=null){super.changeActivity(e,t,s)}getDefaultActivity(){return Yt.Route}}class Xt{constructor(e,t,s,i,r){this.buildingCycleIndex=0,M.registerEventListener(S.Z.COMMAND_PICK_TOOL,(e=>{s.selection.raiders.forEach((t=>{t.hasTool(e.tool)||t.setJob(new Ee(s,e.tool,null))})),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_CREATE_POWER_PATH,(()=>{new It(s,s.selection.surface)})),M.registerEventListener(S.Z.COMMAND_MAKE_RUBBLE,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.makeRubble(2),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_PLACE_FENCE,(()=>{var e;const t=s.selection.surface;t&&(null===(e=s.getClosestBuildingByType(t.getCenterWorld(),b.TOOLSTATION))||void 0===e||e.spawnFence(t)),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_CHANGE_RAIDER_SPAWN_REQUEST,(e=>{e.increase?o.requestedRaiders++:o.requestedRaiders--,M.publishEvent(new ee(o.requestedRaiders))})),M.registerEventListener(S.Z.COMMAND_CREATE_DRILL_JOB,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.createDrillJob(),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_CREATE_REINFORCE_JOB,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.createReinforceJob(),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_CREATE_DYNAMITE_JOB,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.createDynamiteJob(),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_CANCEL_SURFACE_JOBS,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.cancelJobs(),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_CREATE_CLEAR_RUBBLE_JOB,(()=>{var e;null===(e=s.selection.surface)||void 0===e||e.createClearRubbleJob(),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_UPGRADE_BUILDING,(()=>{var e;null===(e=s.selection.building)||void 0===e||e.upgrade()})),M.registerEventListener(S.Z.COMMAND_BUILDING_BEAMUP,(()=>{var e;null===(e=s.selection.building)||void 0===e||e.beamUp()})),M.registerEventListener(S.Z.COMMAND_CHANGE_BUILDING_POWER_STATE,(e=>{var t;null===(t=s.selection.building)||void 0===t||t.setPowerSwitch(e.state)})),M.registerEventListener(S.Z.COMMAND_RAIDER_EAT,(()=>{s.selection.raiders.forEach((e=>!e.isDriving()&&e.setJob(new xt))),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_RAIDER_UPGRADE,(()=>{s.selection.raiders.forEach((e=>{const t=s.getClosestBuildingByType(e.getPosition(),b.TOOLSTATION);t&&e.level<e.stats.Levels&&e.setJob(new Dt(t))})),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_RAIDER_BEAMUP,(()=>{s.selection.raiders.forEach((e=>e.beamUp()))})),M.registerEventListener(S.Z.COMMAND_TRAIN_RAIDER,(e=>(s.selection.raiders.forEach((t=>!t.hasTraining(e.training)&&t.setJob(new Ot(s,e.training,null)))),M.publishEvent(new U),!0))),M.registerEventListener(S.Z.COMMAND_RAIDER_DROP,(()=>{s.selection.raiders.forEach((e=>e.dropItem()))})),M.registerEventListener(S.Z.COMMAND_SELECT_BUILD_MODE,(e=>{t.setBuildModeSelection(Xt.createBuildingFromType(e.entityType,t,s))})),M.registerEventListener(S.Z.COMMAND_CANCEL_BUILD_MODE,(()=>{t.setBuildModeSelection(null)})),M.registerEventListener(S.Z.COMMAND_CANCEL_CONSTRUCTION,(()=>{var e;null===(e=s.selection.surface.site)||void 0===e||e.cancelSite()})),M.registerEventListener(S.Z.COMMAND_REQUEST_VEHICLE_SPAWN,(e=>{console.log("Vehicle spawn requested for: "+b[e.vehicle]);const i=s.getBuildingsByType(b.TELEPORT_PAD).filter((e=>!e.spawning));if(i.length>0){const r=i.random(),n=Xt.createVehicleFromType(e.vehicle,t,s);n.addToScene(r.primaryPathSurface.getCenterWorld2D(),r.getHeading()),n.changeActivity(Yt.TeleportIn,(()=>{n.changeActivity(),n.sceneEntity.createPickSphere(n.stats.PickSphere,n),s.vehicles.push(n)}))}M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_VEHICLE_GET_MAN,(()=>{s.selection.vehicles.forEach((e=>{e.callManJob||e.driver||M.publishEvent(new $(new Nt(e)))})),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_VEHICLE_BEAMUP,(()=>{s.selection.vehicles.forEach((e=>e.beamUp())),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_VEHICLE_DRIVER_GET_OUT,(()=>{s.selection.vehicles.forEach((e=>e.dropDriver())),M.publishEvent(new U)})),M.registerEventListener(S.Z.COMMAND_CHANGE_PRIORITY_LIST,(e=>{i.updatePriorities(e.priorityList)})),M.registerEventListener(S.Z.COMMAND_CAMERA_CONTROL,(e=>{if(e.zoom){const t=new WheelEvent("wheel",{deltaY:5*e.zoom});r.dispatchEvent(t),r.ownerDocument.dispatchEvent(t)}if(e.cycleBuilding){this.buildingCycleIndex=(this.buildingCycleIndex+1)%s.buildings.length;const e=s.buildings[this.buildingCycleIndex].primarySurface.getCenterWorld(),i=t.camera.position.clone().sub(t.controls.target);t.camera.position.copy(e.clone().add(i)),t.controls.target.copy(e),t.controls.update()}e.rotationIndex>=0&&console.log("TODO implement rotate camera: "+["left","up","right","down"][e.rotationIndex])}))}static createBuildingFromType(e,t,s){switch(e){case b.TOOLSTATION:return new Ct(t,s);case b.TELEPORT_PAD:return new Rt(t,s);case b.DOCKS:return new bt(t,s);case b.POWER_STATION:return new Lt(t,s);case b.BARRACKS:return new Et(t,s);case b.UPGRADE:return new Pt(t,s);case b.GEODOME:return new St(t,s);case b.ORE_REFINERY:return new Tt(t,s);case b.GUNSTATION:return new Mt(t,s);case b.TELEPORT_BIG:return new At(t,s);default:throw"Unexpected building type: "+b[e]}}static createVehicleFromType(e,t,s){switch(e){case b.HOVERBOARD:return new Wt(t,s);case b.SMALL_DIGGER:return new qt(t,s);case b.SMALL_TRUCK:return new Kt(t,s);case b.SMALL_CAT:return new Vt(t,s);case b.SMALL_MLP:return new Zt(t,s);case b.SMALL_HELI:return new jt(t,s);case b.BULLDOZER:return new Ut(t,s);case b.WALKER_DIGGER:return new zt(t,s);case b.LARGE_MLP:return new Jt(t,s);case b.LARGE_DIGGER:return new Ht(t,s);case b.LARGE_CAT:return new Gt(t,s);default:throw"Unexpected vehicle type: "+b[e]}}}!function(e){e[e.QUIT=0]="QUIT",e[e.COMPLETE=1]="COMPLETE",e[e.FAILED=2]="FAILED"}(ut||(ut={}));class $t{constructor(e,t){this.state=e,this.numBuildings=t.buildings.length,this.numRaiders=t.raiders.length,this.numMaxRaiders=t.getMaxRaiders()}}class Qt extends ne{}Qt.Route=new Qt("Activity_Route");class es extends Qt{}es.TurnLeft=new es("Activity_TurnLeft"),es.TurnRight=new es("Activity_TurnRight"),es.Emerge=new es("Activity_Emerge"),es.Enter=new es("Activity_Enter"),es.Gather=new es("Activity_Gather"),es.Carry=new es("Activity_Carry"),es.Throw=new es("Activity_Throw"),es.CarryTurnLeft=new es("Activity_CarryTurnLeft"),es.CarryTurnRight=new es("Activity_CarryTurnRight"),es.CarryStand=new es("Activity_CarryStand"),es.Repair=new es("Activity_Repair"),es.Crumble=new es("Activity_Crumble"),es.Stamp=new es("Activity_Stamp"),es.Rest=new es("Activity_Rest"),es.ThrowMan=new es("Activity_ThrowMan"),es.Eat=new es("Activity_Eat"),es.HitHard=new es("Activity_HitHard"),es.Unpowered=new es("Activity_Unpowered"),es.WakeUp=new es("Activity_WakeUp");class ts extends kt{constructor(e,t,s,i){super(e,t,s,i),this.target=[]}removeFromScene(){super.removeFromScene(),this.moveTimeout=(0,a.L4)(this.moveTimeout)}getRouteActivity(){return Qt.Route}}class ss extends ts{constructor(e,t){super(e,t,b.BAT,"Creatures/bat/bat.ae"),this.floorOffset=l.pM/2}get stats(){return gt.stats.Bat}startRandomMove(){ss.onMove(this)}static onMove(e){(e.target.length<1||e.moveToClosestTarget(e.target)===ct.TARGET_REACHED)&&(e.target=[e.findTarget()]),e.moveTimeout=setTimeout((()=>ss.onMove(e)),1e3/l.OK)}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.getPosition()).getCenterWorld();for(let s=0;s<20;s++){const s=(0,a.$u)(t.x-(l.pM+l.pM/2),t.x+l.pM+l.pM/2),i=(0,a.$u)(t.z-l.pM/2,t.z+l.pM/2);if(e.getSurfaceFromWorldXZ(s,i).surfaceType.floor)return new le(new h.FM8(s,i))}return console.warn("Could not find a target"),null}onDeath(){this.removeFromScene(),this.entityMgr.bats.remove(this)}}class is extends ts{constructor(e,t){super(e,t,b.ICE_MONSTER,"Creatures/IceMonster/IceMonster.ae")}}class rs extends ts{constructor(e,t){super(e,t,b.LAVA_MONSTER,"Creatures/LavaMonster/LavaMonster.ae")}}class ns extends ts{constructor(e,t){super(e,t,b.ROCK_MONSTER,"Creatures/RMonster/RMonster.ae")}}class as extends ts{constructor(e,t){super(e,t,b.SMALL_SPIDER,"Creatures/SpiderSB/SpiderSB.ae"),this.radiusSq=0,this.floorOffset=1}get stats(){return gt.stats.SmallSpider}startMoving(){as.onMove(this)}static onMove(e){e.target.length>0&&e.moveToClosestTarget(e.target)===ct.MOVED?e.sceneMgr.terrain.getSurfaceFromWorld(e.getPosition()).surfaceType.floor?e.moveTimeout=setTimeout((()=>as.onMove(e)),1e3/l.OK):e.onDeath():(e.changeActivity(),e.moveTimeout=setTimeout((()=>{e.target=[e.findTarget()],as.onMove(e)}),1e3+(0,a.sZ)(9e3)))}findTarget(){const e=this.sceneMgr.terrain,t=e.getSurfaceFromWorld(this.getPosition()).getCenterWorld();for(let s=0;s<20;s++){const s=(0,a.$u)(t.x-(l.pM+l.pM/2),t.x+l.pM+l.pM/2),i=(0,a.$u)(t.z-l.pM/2,t.z+l.pM/2),r=e.getSurfaceFromWorldXZ(s,i).surfaceType;if(r!==A.WATER&&r!==A.LAVA)return new le(new h.FM8(s,i))}return console.warn("Could not find a target"),null}onDeath(){this.removeFromScene(),this.entityMgr.spiders.remove(this)}changeActivity(e=this.getDefaultActivity(),t=null,s=null){super.changeActivity(e,t,s),this.radiusSq=this.sceneEntity.getRadiusSquare()}}class os extends Bt{constructor(e,t){super(e,t,b.PILOT,"mini-figures/pilot/pilot.ae"),this.tools=new Map,this.trainings=new Map,this.slipped=!1,this.radiusSq=0,this.hungerLevel=1,this.vehicle=null,this.tools.set(T.DRILL,!0)}get stats(){return gt.stats.Pilot}findPathToTarget(e){return this.sceneMgr.terrain.findWalkPath(this.getPosition2D(),e)}onDiscover(){super.onDiscover(),this.entityMgr.raidersUndiscovered.remove(this),this.entityMgr.raiders.push(this),M.publishEvent(new J(this.entityMgr)),M.publishEvent(new xe(this.getPosition()))}isSelectable(){return super.isSelectable()&&!this.slipped&&!this.vehicle}isDriving(){return!!this.vehicle}getSpeed(){return super.getSpeed()*this.stats.RouteSpeed[this.level]*(this.isOnPath()?this.stats.PathCoef:1)}isOnPath(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.sceneEntity.position).isPath()}isOnRubble(){return this.sceneMgr.terrain.getSurfaceFromWorld(this.sceneEntity.position).hasRubble()}getRouteActivity(){return this.isOnRubble()?this.carries?oe.CarryRubble:oe.routeRubble:this.carries?oe.Carry:oe.Route}moveToClosestTarget(e){const t=super.moveToClosestTarget(e);return t===ct.MOVED&&this.entityMgr.spiders.some((e=>{if(this.sceneEntity.position.distanceToSquared(e.sceneEntity.position)<this.radiusSq+e.radiusSq)return this.slip(),e.onDeath(),!0})),t}slip(){(0,a.$u)(0,100)<10&&this.stopJob(),this.dropItem(),this.slipped=!0,this.changeActivity(oe.Slip,(()=>{this.slipped=!1}))}work(){this.slipped||super.work()}getDefaultActivity(){return this.carries?oe.CarryStand:super.getDefaultActivity()}beamUp(){super.beamUp(),M.publishEvent(new J(this.entityMgr))}removeFromScene(){super.removeFromScene(),this.entityMgr.raiders.remove(this)}hasTool(e){return!e||this.tools.has(e)}hasTraining(e){return!e||this.trainings.has(e)}addTool(e){this.tools.set(e,!0)}addTraining(e){this.trainings.set(e,!0)}isPrepared(e){return this.hasTool(e.getRequiredTool())&&this.hasTraining(e.getRequiredTraining())}changeActivity(e=this.getDefaultActivity(),t=null,s=null){super.changeActivity(e,t,s),this.radiusSq=this.sceneEntity.getRadiusSquare()}canDrill(e){return super.canDrill(e)&&this.hasTool(T.DRILL)}}var ls,hs,cs,us=h.M8C.degToRad;class ds{constructor(e,t){this.jobs=[],this.assignInterval=null,this.checkRubbleInterval=null,this.priorityIndexList=[],this.priorityList=[],this.sceneMgr=e,this.entityMgr=t,M.registerEventListener(S.Z.JOB_CREATE,(e=>{this.jobs.push(e.job)})),M.registerEventListener(S.Z.JOB_DELETE,(e=>{e.job.cancel()}))}start(){stop(),this.assignInterval=setInterval(this.assignJobs.bind(this),l.$I),this.checkRubbleInterval=setInterval(this.checkUnclearedRubble.bind(this),l.p$)}stop(){this.assignInterval=(0,a.nJ)(this.assignInterval),this.checkRubbleInterval=(0,a.nJ)(this.checkRubbleInterval)}assignJobs(){const e=[];this.jobs=this.jobs.filter((t=>{const s=t.jobState===_.INCOMPLETE;return s&&t.fulfiller.length<1&&this.isEnabled(t.getPriorityIdentifier())&&e.push(t),s})),e.sort(((e,t)=>Math.sign(this.getPriority(e)-this.getPriority(t))));const t=this.entityMgr.raiders.filter((e=>!e.job&&!e.inBeam));e.forEach((e=>{let s=null,i=null,r=null,n=null,a=null,o=null,l=null;const h=e.getRequiredTool();let c=null,u=null,d=null,g=null;const p=e.getRequiredTraining();t.forEach(((t,y)=>{const m=t.hasTool(h),v=t.hasTraining(p);if(m&&v){const n=e.getWorkplaces().map((e=>t.findPathToTarget(e))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(n){const e=n.lengthSq;(null===r||e<r)&&(s=t,i=y,r=e)}}else if(m){const e=this.entityMgr.getTrainingSites(p).map((e=>t.findPathToTarget(e.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const s=e.lengthSq;(null===d||s<d)&&(c=t,u=y,d=s,g=e.target.building)}}else{const e=this.entityMgr.getBuildingsByType(b.TOOLSTATION).map((e=>t.findPathToTarget(e.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(e){const s=e.lengthSq;(null===o||s<o)&&(n=t,a=y,o=s,l=e.target.building)}}})),s?(s.setJob(e),t.splice(i,1)):n?(n.setJob(new Ee(this.entityMgr,h,l),e),t.splice(a,1)):c&&(c.setJob(new Ot(this.entityMgr,p,g),e),t.splice(u,1))})),t.forEach((e=>{const t=e.surfaces.map((e=>e.site)).filter((e=>!!e));t.length>0&&e.setJob(new be(t[0].getWalkOutSurface().getRandomPosition()))}))}checkUnclearedRubble(){this.isEnabled(N.aiPriorityClearing)&&this.entityMgr.raiders.forEach((e=>{if(e.job)return;const t=e.surfaces[0];for(let s=0;s<10;s++)for(let i=t.x-s;i<=t.x+s;i++)for(let r=t.y-s;r<=t.y+s;r++){const t=this.sceneMgr.terrain.getSurfaceOrNull(i,r);if(!(null==t?void 0:t.hasRubble())||!(null==t?void 0:t.discovered))continue;const s=t.createClearRubbleJob();if(!s||s.fulfiller.length>0)continue;const n=s.getRequiredTool();if(e.hasTool(n))return void e.setJob(s);{const t=this.entityMgr.getBuildingsByType(b.TOOLSTATION).map((t=>e.findPathToTarget(t.getPathTarget()))).filter((e=>!!e)).sort(((e,t)=>e.lengthSq-t.lengthSq))[0];if(t)return void e.setJob(new Ee(this.entityMgr,n,t.target.building),s)}}}))}getPriority(e){return this.priorityIndexList.indexOf(e.getPriorityIdentifier())}isEnabled(e){var t;return!!(null===(t=this.priorityList.find((t=>t.key===e)))||void 0===t?void 0:t.enabled)}updatePriorities(e){this.priorityList=[...e],this.priorityIndexList=this.priorityList.map((e=>e.key))}}class gs{constructor(e,t=!1){this.debug=!1,this.onLevelEnd=null,this.nerpInterval=null,this.registers=new Array(8).fill(0),this.timers=new Array(4).fill(0),this.scriptLines=[],this.statements=[],this.macrosByName={},this.labelsByName={},this.halted=!1,this.programCounter=0,this.messages=[],this.messagePermit=null,this.entityMgr=e,this.debug=t}startExecution(){const e=this;this.nerpInterval=setInterval((()=>{e.execute()}),2e3)}pauseExecution(){this.nerpInterval=(0,a.nJ)(this.nerpInterval)}checkRegister(e){const t=parseInt(e);if(isNaN(t)||t<0||t>this.registers.length)throw new Error("Invalid register ("+e+") provided");return t}checkRegisterValue(e){const t=parseInt(e);if(isNaN(t))throw new Error("Invalid register value ("+e+") provided");return t}getR(e){return e=this.checkRegister(e),this.registers[e]}setR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]=t}addR(e,t){e=this.checkRegister(e),t=this.checkRegisterValue(t),this.registers[e]+=t}setTimer(e,t){const s=parseInt(t);if(isNaN(s))throw new Error("Can't set timer to NaN value: "+t);this.timers[e]=(new Date).getTime()+s}getTimer(e){return(new Date).getTime()-this.timers[e]}setLevelCompleted(){console.log("Nerp runner marks level as complete"),this.halted=!0,this.onLevelEnd(ut.COMPLETE)}setLevelFail(){console.log("NerpRunner marks level as failed; at line: "+this.scriptLines[this.programCounter]),this.halted=!0,this.onLevelEnd(ut.FAILED)}setTutorialFlags(e){0!==e&&console.warn("NERP: setTutorialFlags not yet implemented",e)}setMessagePermit(e){this.messagePermit=!e}setBuildingsUpgradeLevel(e,t){this.entityMgr.buildings.forEach((s=>{s.entityType===e&&s.setLevel(t)}))}setToolStoreLevel(e){this.setBuildingsUpgradeLevel(b.TOOLSTATION,e)}setTeleportPadLevel(e){this.setBuildingsUpgradeLevel(b.TELEPORT_PAD,e)}setPowerStationLevel(e){this.setBuildingsUpgradeLevel(b.POWER_STATION,e)}setBarracksLevel(e){this.setBuildingsUpgradeLevel(b.BARRACKS,e)}getToolStoresBuilt(){return this.entityMgr.buildings.count((e=>e.entityType===b.TOOLSTATION))}getMinifiguresOnLevel(){return this.entityMgr.raiders.length}getCrystalsCurrentlyStored(){return o.numCrystal}getObjectiveSwitch(){return!1}setMessageTimerValues(e,t,s){}getMessageTimer(){return 0}cameraUnlock(){}setMessage(e,t){if(!this.messagePermit)return;if(0===e)return;const s=this.messages[e];console.log(s.txt)}setCameraGotoTutorial(e){}getTutorialBlockIsGround(e){return 0}getTutorialBlockIsPath(e){return 0}getUnitAtBlock(e){return 0}getOxygenLevel(){return 100*o.airLevel}getObjectiveShowing(){return!1}addPoweredCrystals(){}disallowAll(){}getPoweredPowerStationsBuilt(){return this.entityMgr.buildings.count((e=>e.isUsable()&&e.entityType===b.POWER_STATION))}getPoweredBarracksBuilt(){return this.entityMgr.buildings.count((e=>e.isUsable()&&e.entityType===b.BARRACKS))}getRecordObjectAtTutorial(){}getHiddenObjectsFound(){return 0}getLevel1PowerStationsBuilt(){return this.entityMgr.buildings.count((e=>e.entityType===b.POWER_STATION&&e.level>=1))}getRandom100(){return(0,a.sZ)(100)}getSlugsOnLevel(){return 0}generateSlug(){console.warn("Slugs not yet implemented")}callMethod(e,t){if("Stop"===e)throw"Stop";if("TRUE"===e)return!0;if("FALSE"===e)return!1;const s=e.match(/^SetR([0-7])$/);if(s)return this.setR(s[1],t[0]);const i=e.match(/^AddR([0-7])$/);if(i)return this.addR(i[1],t[0]);const r=e.match(/^GetR([0-7])$/);if(r)return this.getR(r[1]);const n=e.match(/^SetTimer([0-3])$/);if(n)return this.setTimer(n[1],t[0]);const a=e.match(/^GetTimer([0-3])$/);if(a)return this.getTimer(a[1]);const o=e.toLowerCase(),l=Object.getOwnPropertyNames(gs.prototype).find((e=>e.toLowerCase()===o));if(l)return this[l].apply(this,t);throw new Error("Undefined method: "+e)}conditional(e,t){const s=this.executeStatement(e);this.debug&&console.log("Condition evaluated to "+s),s&&this.executeStatement(t)}executeStatement(e){if(e.invoke){const t="conditional"!==e.invoke?e.args.map((e=>this.executeStatement(e))):e.args,s=this.callMethod(e.invoke,t);return void 0!==s&&this.debug&&console.log("Method returned: "+s),s}if(e.comparator){const t=this.executeStatement(e.left),s=this.executeStatement(e.right);if("="===e.comparator)return t===s;if("!="===e.comparator)return t!==s;if("<"===e.comparator)return t<s;if(">"===e.comparator)return t>s;throw console.log(e),new Error("Unknown comparator: "+e.comparator)}if(!isNaN(e))return e;if(!e.jump)throw console.log(e),new Error("Unknown expression in line "+this.programCounter+": "+e);if(this.programCounter=this.labelsByName[e.jump],void 0===this.programCounter)throw new Error("Label '"+e.jump+"' is unknown!");this.debug&&console.log("Jumping to label '"+e.jump+"' in line "+this.programCounter)}execute(e=!1){if(this.debug=e,!this.halted)try{for(this.debug&&(console.log("Executing following script\n"+this.scriptLines.join("\n")),console.log("Registers: "+this.registers)),this.programCounter=0;this.programCounter<this.statements.length;this.programCounter++){const e=this.statements[this.programCounter];this.debug&&(console.log(this.programCounter+": "+this.scriptLines[this.programCounter]),console.log(e)),e.label||this.executeStatement(e)}}catch(e){if("Stop"===e)return;console.error(e),console.error("FATAL ERROR! Script execution failed! You can NOT win anymore!"),this.halted=!0}}}class ps{static parse(e,t){const s=new gs(e),i=t.split("\n").map((e=>e.split("//")[0].trim().split(";")[0].trim().replace(/_/g,"").replace(/\bTRUE \? /,"").replace(/[{}]/g,"")));for(let t=0;t<i.length;t++){const r=i[t];if(!(r.length<1))if(r.startsWith("#include ")){const t=r.replace(/^#include /,"").trim().slice(1,-1);if("nerpdef.h"===t)continue;const i=ps.parse(e,gt.getResource("Levels/"+t));if(!i||!i.scriptLines||i.scriptLines.length<1)throw"Can't include unknown nerp script: "+r;s.scriptLines=s.scriptLines.concat(i.scriptLines),s.macrosByName=Object.assign({},s.macrosByName,i.macrosByName)}else if(r.startsWith("#define ")){const e=r.replace(/^#define /,"").split(" "),n=[e.splice(1).join(" ").replace(/\\$/,"").trim()];let a=r,o=!1;for(;a.endsWith("\\")&&t<i.length-1;){t++,a=i[t].trim();const e=a.replace(/\\$/,"").trim();e.length>0&&(o?(o=!1,n[n.length-1]+=e):n.push(e)),a.match(/:\\$/)&&(o=!0)}const l=e[0].split("(");s.macrosByName[l[0]]={args:l[1].replace(/\)$/,"").split(","),lines:n}}else s.scriptLines=s.scriptLines.concat(this.replaceMacros(s.macrosByName,r))}for(let e=0;e<s.scriptLines.length;e++){const t=s.scriptLines[e];s.statements[e]=t.replace(/\(\)/g,"").split(" ? ");const i=t.match(/(\S+):/);if(2===s.statements[e].length)s.statements[e]={invoke:"conditional",args:[this.preProcess(s.statements[e][0]),this.preProcess(s.statements[e][1])]};else if(i){const t=i[1].toLowerCase();s.labelsByName[t]=e,s.statements[e]={label:t}}else{if(1!==s.statements[e].length)throw"Can't deal with line: "+t;s.statements[e]=this.preProcess(s.statements[e][0])}}return s}static replaceMacros(e,t){const s=t.split("("),i=e[s[0]];if(i){const r=s.splice(1).join("(").slice(0,-1).split(",");if(r.length!==i.args.length)throw"Invalid number of args provided for macro in line "+t;const n=[];return i.lines.forEach((t=>{for(let e=0;e<r.length;e++)t=t.replace(new RegExp("\\b"+i.args[e]+"\\b"),r[e]);n.push(...this.replaceMacros(e,t))})),n}return[t]}static preProcess(e){e=e.trim().replace(/^_/,"");const t=parseInt(e);if(!isNaN(t))return t;const s=e.split(/ (=) | (!=) | (>) | (<) /).filter((e=>void 0!==e)),i=e.match(/^(.+)\((.+)\)$/),r=e.split(" "),n=e.match(/([^:]+):$/),a=e.match(/^:([^:]+)$/);if(3===s.length)return{left:this.preProcess(s[0]),comparator:s[1],right:this.preProcess(s[2])};if(i){const e=i[2].split(",").map((e=>this.preProcess(e)));return{invoke:i[1],args:e}}if(r.length>1){const e=2===r.length?[this.preProcess(r[1])]:r.splice(1).map((e=>this.preProcess(e)));return{invoke:r[0],args:e}}if(n)return{label:n[1]};if(a)return{jump:a[1].toLowerCase()};if(e.match(/[ =?><!]/))throw"Invalid expression given, parsing must have failed before somewhere";return{invoke:e,args:[]}}}class ys{constructor(){this.nerpRunner=null,this.oxygenUpdateInterval=null,this.spawnRaiderInterval=null,this.oxygenRate=0,M.registerEventListener(S.Z.CAVERN_DISCOVERED,(()=>{o.discoveredCaverns++})),M.registerEventListener(S.Z.REQUESTED_RAIDERS_CHANGED,(()=>{o.requestedRaiders>0&&!this.spawnRaiderInterval&&(this.spawnRaiderInterval=setInterval(this.checkSpawnRaiders.bind(this),l.Wc))}))}setup(e,t){var s,i;o.totalCaverns=(null===(i=null===(s=e.reward)||void 0===s?void 0:s.quota)||void 0===i?void 0:i.caverns)||0,this.oxygenRate=e.oxygenRate,this.nerpRunner=ps.parse(this.entityMgr,gt.getResource(e.nerpFile)),this.nerpRunner.messages.push(...gt.getResource(e.nerpMessageFile)),this.nerpRunner.onLevelEnd=t}start(){var e;null===(e=this.nerpRunner)||void 0===e||e.startExecution(),this.oxygenUpdateInterval=setInterval(this.updateOxygen.bind(this),l.SO),o.levelStartTime=Date.now()}stop(){var e;o.levelStopTime=Date.now(),this.spawnRaiderInterval=(0,a.nJ)(this.spawnRaiderInterval),this.oxygenUpdateInterval=(0,a.nJ)(this.oxygenUpdateInterval),null===(e=this.nerpRunner)||void 0===e||e.pauseExecution()}updateOxygen(){const e=this.entityMgr.getOxygenSum()*this.oxygenRate*.001*.04*l.SO*.001/10,t=Math.min(1,Math.max(0,o.airLevel+e));o.airLevel!==t&&(o.airLevel=t,M.publishEvent(new W(o.airLevel)))}checkSpawnRaiders(){if(o.requestedRaiders<1)return void(this.spawnRaiderInterval=(0,a.nJ)(this.spawnRaiderInterval));if(this.entityMgr.hasMaxRaiders())return;const e=this.entityMgr.getBuildingsByType(b.TOOLSTATION,b.TELEPORT_PAD);for(let t=0;t<e.length&&o.requestedRaiders>0;t++){const s=e[t];if(s.spawning)continue;o.requestedRaiders--,M.publishEvent(new ee(o.requestedRaiders)),s.spawning=!0;const i=new os(this.sceneMgr,this.entityMgr),r=s.getHeading();i.addToScene(new h.FM8(0,l.pM/2).rotateAround(new h.FM8(0,0),-r).add(s.getPosition2D()),r),i.playPositionalAudio(p.d[p.d.SND_teleport],!1),i.changeActivity(oe.TeleportIn,(()=>{s.spawning=!1,i.changeActivity(),i.sceneEntity.createPickSphere(i.stats.PickSphere,i);const e=s.primaryPathSurface.getRandomPosition();i.setJob(new be(e)),this.entityMgr.raiders.push(i),M.publishEvent(new J(this.entityMgr))}))}}}class ms{constructor(e,t){this.active=!0,this.canvas=document.createElement("canvas"),e||(this.canvas.style.background="#f0f"),t&&(this.context=this.canvas.getContext("2d",{alpha:e})),this.hide()}reset(){}setZIndex(e){this.canvas.style.zIndex=String(e)}static compareZ(e,t){var s,i,r,n;let a=(null===(i=null===(s=null==e?void 0:e.canvas)||void 0===s?void 0:s.style)||void 0===i?void 0:i.zIndex)||0;const o=(null===(n=null===(r=null==t?void 0:t.canvas)||void 0===r?void 0:r.style)||void 0===n?void 0:n.zIndex)||0;return a===o?0:a>o?-1:1}resize(e,t){this.canvas.width=e,this.canvas.height=t}redraw(){this.onRedraw&&this.isActive()&&requestAnimationFrame(this.onRedraw.bind(this,this.context))}show(){this.reset(),this.active=!0,this.canvas.style.visibility="visible",this.redraw()}hide(){this.active=!1,this.canvas.style.visibility="hidden"}isActive(){return this.active}toCanvasCoords(e,t){const s=this.canvas.getBoundingClientRect();return[e-s.left,t-s.top]}handlePointerEvent(e){return new Promise((e=>e(!1)))}handleKeyEvent(e){return new Promise((e=>e(!1)))}handleWheelEvent(e){return new Promise((e=>e(!1)))}}class vs extends ms{constructor(e=!0,t=!0){super(e,t),this.fixedWidth=l.Du,this.fixedHeight=l.DG,this.updateScale()}updateScale(){this.scaleX=this.canvas.width/this.fixedWidth,this.scaleY=this.canvas.height/this.fixedHeight}toScaledCoords(e,t){const[s,i]=this.toCanvasCoords(e,t);return[s/this.scaleX,i/this.scaleY].map((e=>Math.round(e)))}resize(e,t){super.resize(e,t),this.updateScale(),this.context.scale(this.scaleX,this.scaleY)}}!function(e){e[e.MAIN=0]="MAIN",e[e.MIDDLE=1]="MIDDLE",e[e.SECONDARY=2]="SECONDARY"}(ls||(ls={})),function(e){e[e.MOVE=0]="MOVE",e[e.DOWN=1]="DOWN",e[e.UP=2]="UP"}(hs||(hs={})),function(e){e[e.DOWN=0]="DOWN",e[e.UP=1]="UP"}(cs||(cs={}));class fs{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.key=t.key,this.code=t.code}}class ws{constructor(e,t){this.eventEnum=e,this.type=t.type,this.bubbles=!1,this.clientX=t.clientX,this.clientY=t.clientY,this.pointerType=t.pointerType,this.button=t.button,this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.shiftKey=t.shiftKey}}class Es{constructor(e){this.type=e.type,this.bubbles=!1,this.clientX=e.clientX,this.clientY=e.clientY,this.deltaX=e.deltaX,this.deltaY=e.deltaY,this.deltaZ=e.deltaZ,this.button=e.button,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey}}class bs{constructor(e){e.gameCanvasContainer.addEventListener("contextmenu",(t=>{e.isInRect(t)&&t.preventDefault()})),new Map([["pointermove",hs.MOVE],["pointerdown",hs.DOWN],["pointerup",hs.UP]]).forEach(((t,s)=>{e.gameCanvasContainer.addEventListener(s,(s=>{if(!e.isInRect(s))return;s.preventDefault();const i=new ws(t,s),r=e.layers.filter((e=>e.isActive())).sort(((e,t)=>ms.compareZ(e,t)));bs.publishPointerEvent(r,i)}))})),new Map([["keydown",cs.DOWN],["keyup",cs.UP]]).forEach(((t,s)=>{e.gameCanvasContainer.addEventListener(s,(s=>{l.Sl||s.preventDefault();const i=new fs(t,s),r=e.layers.filter((e=>e.isActive())).sort(((e,t)=>ms.compareZ(e,t)));bs.publishKeyEvent(r,i)}))})),e.gameCanvasContainer.addEventListener("wheel",(t=>{if(!e.isInRect(t))return;const s=new Es(t),i=e.layers.filter((e=>e.isActive())).sort(((e,t)=>ms.compareZ(e,t)));bs.publishWheelEvent(i,s)}))}static publishPointerEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handlePointerEvent(t).then((s=>{s||this.publishPointerEvent(e,t)}))}static publishKeyEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handleKeyEvent(t).then((s=>{s||this.publishKeyEvent(e,t)}))}static publishWheelEvent(e,t){var s;null===(s=e.shift())||void 0===s||s.handleWheelEvent(t).then((s=>{s||this.publishWheelEvent(e,t)}))}}class Ss extends ms{constructor(e){super(!0,!1),this.currentCursor=null,this.timedCursor=null,this.cursorTimeout=null,this.activeCursor=null,e.registerEventListener(S.Z.CHANGE_CURSOR,(e=>{this.active&&this.changeCursor(e.cursor,e.timeout)}))}reset(){this.changeCursor(L.C.Pointer_Standard)}hide(){var e;super.hide(),this.canvas.style.cursor=null,this.currentCursor=null,this.timedCursor=null,this.cursorTimeout=(0,a.L4)(this.cursorTimeout),null===(e=this.activeCursor)||void 0===e||e.disableAnimation(),this.activeCursor=null}handlePointerEvent(e){if(e.eventEnum===hs.MOVE&&this.sceneMgr){const[t,s]=this.toCanvasCoords(e.clientX,e.clientY),i=t/this.canvas.width*2-1,r=-s/this.canvas.height*2+1,n=new h.iMs;n.setFromCamera({x:i,y:r},this.sceneMgr.camera),this.changeCursor(this.determineCursor(n))}return super.handlePointerEvent(e)}determineCursor(e){if(this.sceneMgr.hasBuildModeSelection())return this.sceneMgr.buildMarker.lastCheck?L.C.Pointer_CanBuild:L.C.Pointer_CannotBuild;let t=e.intersectObjects(this.entityMgr.raiders.map((e=>e.sceneEntity.pickSphere)));if(t.length>0)return L.C.Pointer_Selected;if(t=e.intersectObjects(this.entityMgr.vehicles.map((e=>e.sceneEntity.pickSphere))),t.length>0){const e=t[0].object.userData;if(e&&e.hasOwnProperty("selectable")){const t=e.selectable;if(!(null==t?void 0:t.driver)&&this.entityMgr.selection.raiders.length>0)return L.C.Pointer_GetIn}return L.C.Pointer_Selected}if(t=e.intersectObjects(this.entityMgr.buildings.map((e=>e.sceneEntity.pickSphere))),t.length>0)return L.C.Pointer_Selected;if(t=e.intersectObjects(this.sceneMgr.terrain.floorGroup.children),t.length>0){const e=t[0].object.userData;if(e&&e.hasOwnProperty("surface")){const t=e.surface;if(t)return this.entityMgr.selection.raiders.some((e=>e.canDrill(t)))||this.entityMgr.selection.vehicles.some((e=>e.canDrill(t)))?t.surfaceType.cursorFulfiller:t.surfaceType.cursor}}return L.C.Pointer_Standard}changeCursor(e,t=null){if(t){this.cursorTimeout=(0,a.L4)(this.cursorTimeout),this.timedCursor!==e&&this.setCursor(e);const s=this;this.cursorTimeout=setTimeout((()=>{s.cursorTimeout=null,s.setCursor(s.currentCursor)}),t)}else if(this.currentCursor!==e){if(this.currentCursor=e,this.cursorTimeout)return;this.setCursor(e)}}setCursor(e){var t;null===(t=this.activeCursor)||void 0===t||t.disableAnimation(),this.activeCursor=gt.getCursor(e),this.activeCursor.enableAnimation(this.canvas.style)}}class Ms{constructor(){if(this.layers=[],this.width=l.Du,this.height=l.DG,this.ratio=l.Du/l.DG,this.gameCanvasContainer=document.getElementById("game-canvas-container"),this.gameCanvasContainer.focus(),this.eventMgr=new bs(this),!this.gameCanvasContainer)throw"Fatal error: game canvas container not found!";window.addEventListener("resize",(()=>this.onWindowResize())),this.onWindowResize(),this.cursorLayer=this.addLayer(new Ss(this),1e3)}addLayer(e,t=0){return e.resize(this.width,this.height),e.setZIndex(t),this.layers.push(e),this.gameCanvasContainer.appendChild(e.canvas),e}redraw(){this.layers.forEach((e=>e.redraw()))}show(){this.layers.forEach((e=>e.show())),this.redraw()}hide(){this.layers.forEach((e=>e.hide()))}onWindowResize(){const e=this.gameCanvasContainer.offsetWidth,t=this.gameCanvasContainer.offsetHeight,s=Math.round(e/this.ratio);s>t?this.resize(Math.round(t*this.ratio),t):this.resize(e,s)}resize(e,t){this.width=e,this.height=t,this.layers.forEach((s=>{const i=s.canvas;s.resize(e,t),i!==s.canvas&&(this.gameCanvasContainer.removeChild(i),this.gameCanvasContainer.appendChild(s.canvas))})),this.redraw()}isInRect(e){if(this.layers.length<1)return!1;const t=this.layers[0];if(!t.isActive()||!t.canvas)return!1;const s=t.canvas.getBoundingClientRect(),i=e.clientX,r=e.clientY;return i>=s.left&&i<s.right&&r>=s.top&&r<s.bottom}publishEvent(e){M.publishEvent(e)}registerEventListener(e,t){M.registerEventListener(e,t)}}class Ts extends ms{constructor(e){super(!1,!1),this.rightDown={x:0,y:0},this.parent=e}reset(){super.reset(),this.rightDown={x:0,y:0}}handlePointerEvent(e){const[t,s]=this.toCanvasCoords(e.clientX,e.clientY),i=t/this.canvas.width*2-1,r=-s/this.canvas.height*2+1,n=this.sceneMgr.getTerrainIntersectionPoint(i,r),a=this.sceneMgr.buildMarker;return e.eventEnum===hs.MOVE?(n&&this.sceneMgr.setTorchPosition(n),a.update(n)):e.eventEnum===hs.UP?e.button===ls.MAIN?a.createBuildingSite():e.button===ls.SECONDARY&&Math.abs(e.clientX-this.rightDown.x)+Math.abs(e.clientY-this.rightDown.y)<3&&(this.sceneMgr.hasBuildModeSelection()?this.sceneMgr.setBuildModeSelection(null):(this.entityMgr.selection.raiders.length>0||this.entityMgr.selection.vehicles.length>0)&&this.handleSecondaryClickForSelection(i,r,n)):e.eventEnum===hs.DOWN&&e.button===ls.SECONDARY&&(this.rightDown.x=e.clientX,this.rightDown.y=e.clientY),this.canvas.dispatchEvent(new PointerEvent(e.type,e)),this.canvas.ownerDocument.dispatchEvent(new PointerEvent(e.type,e)),new Promise((e=>e(!0)))}handleSecondaryClickForSelection(e,t,s){const i=this.sceneMgr.getFirstByRay(e,t);if(i.vehicle){const e=this.entityMgr.selection.raiders;if(e.length>0){const t=new Nt(i.vehicle);e.some((e=>{if(e.isPrepared(t))e.setJob(t);else{const s=t.getRequiredTraining(),i=e.entityMgr.getClosestTrainingSite(e.getPosition(),s);if(!i)return!1;e.setJob(new Ot(e.entityMgr,s,i),t)}return M.publishEvent(new U),!0})),M.publishEvent(new $(t))}}else if(i.material);else if(i.surface){const e=i.surface.createDrillJob();this.entityMgr.selection.assignSurfaceJob(e);const t=i.surface.createClearRubbleJob();this.entityMgr.selection.assignSurfaceJob(t),e||t||!i.surface.isWalkable()||this.entityMgr.selection.assignMoveJob(s),this.entityMgr.selection.isEmpty()||this.publishEvent(new U)}}handleKeyEvent(e){if(l.Sl&&e.eventEnum===cs.UP&&this.entityMgr.selection.surface)if("KeyC"===e.code)this.entityMgr.selection.surface.collapse(),this.publishEvent(new U);else if("KeyF"===e.code){const e=this.entityMgr.selection.surface,t=e.terrain.findFallInTarget(e.x,e.y);e.surfaceType.floor||e.createFallin(t[0],t[1]),this.publishEvent(new U)}return this.canvas.dispatchEvent(new KeyboardEvent(e.type,e)),new Promise((e=>e(!0)))}handleWheelEvent(e){return this.canvas.dispatchEvent(new WheelEvent(e.type,e)),new Promise((e=>e(!0)))}publishEvent(e){var t;null===(t=this.parent)||void 0===t||t.publishEvent(e)}registerEventListener(e,t){this.parent.registerEventListener(e,t)}}var Ls=h.M8C.generateUUID;class As extends ms{constructor(e){super(!0,!1),this.resolveCallbackByEventId=new Map,this.worker=e,this.sendMessage({type:dt.n.INIT,resourceByName:gt.resourceByName,cfg:gt.configuration,stats:gt.stats}),this.worker.onmessage=e=>{const t=e.data;if(t.type===dt.n.RESPONSE_EVENT){const e=t;this.resolveCallbackByEventId.get(e.eventId)(e.eventConsumed),this.resolveCallbackByEventId.delete(e.eventId)}else if(t.type===dt.n.GAME_EVENT){const e=t.gameEvent;e.eventKey===S.Z.PLAY_SOUND&&u.P.playSample(e.sample),M.publishEvent(e)}else this.onMessage(t)||console.warn("Offscreen layer ignored message: "+dt.n[t.type])},M.registerWorkerListener((e=>{if(e.guiForward)try{this.sendMessage({type:dt.n.GAME_EVENT,gameEvent:e})}catch(t){console.warn("Could not send event to GUI worker: ",t,e)}}))}sendMessage(e,t){this.worker.postMessage(e,t)}reset(){this.sendMessage({type:dt.n.RESET}),this.sendMessage({type:dt.n.GAME_EVENT,gameEvent:new H(this.entityMgr)}),this.sendMessage({type:dt.n.GAME_EVENT,gameEvent:new J(this.entityMgr)}),this.sendMessage({type:dt.n.GAME_EVENT,gameEvent:new te})}resize(e,t){const s=Number(this.canvas.style.zIndex)||0;this.canvas=document.createElement("canvas"),this.active||(this.canvas.style.visibility="hidden"),super.resize(e,t),this.setZIndex(s);const i=this.canvas.transferControlToOffscreen();this.sendMessage({type:dt.n.CANVAS,canvas:i},[i])}redraw(){this.isActive()&&this.sendMessage({type:dt.n.REDRAW})}handlePointerEvent(e){return[e.canvasX,e.canvasY]=this.toCanvasCoords(e.clientX,e.clientY),this.sendEventMessage(dt.n.EVENT_POINTER,e)}handleKeyEvent(e){return this.sendEventMessage(dt.n.EVENT_KEY,e)}handleWheelEvent(e){return[e.canvasX,e.canvasY]=this.toCanvasCoords(e.clientX,e.clientY),this.sendEventMessage(dt.n.EVENT_POINTER,e)}sendEventMessage(e,t){const s=Ls();return this.sendMessage({type:e,eventId:s,inputEvent:t}),new Promise((e=>this.resolveCallbackByEventId.set(s,e)))}}class Rs extends As{constructor(){super(new Worker(new URL(s.p+s.u(87),s.b))),this.onOptionsShow=()=>console.log("Show options triggered")}onMessage(e){return e.type===dt.n.SHOW_OPTIONS&&(this.onOptionsShow(),!0)}setSpaceToContinue(e){this.sendMessage({type:dt.n.SPACE_TO_CONINUE,messageState:e})}}class Cs extends As{constructor(){super(new Worker(new URL(s.p+s.u(137),s.b))),this.onSetSpaceToContinue=e=>console.log("set space to continue: "+e),this.onAbortGame=()=>console.log("abort the game"),this.onRestartGame=()=>console.log("restart the game")}onMessage(e){if(e.type===dt.n.SPACE_TO_CONINUE)this.onSetSpaceToContinue(e.messageState);else if(e.type===dt.n.GAME_ABORT)this.onAbortGame();else{if(e.type!==dt.n.GAME_RESTART)return!1;this.onRestartGame()}return!0}setup(e,t){this.sendMessage({type:dt.n.OVERLAY_SETUP,objectiveText:e,objectiveBackImgCfg:t})}sendMessage(e,t){super.sendMessage(e,t)}showOptions(){this.sendMessage({type:dt.n.SHOW_OPTIONS})}}class Ps extends ms{constructor(){super(!0,!0),this.selectStart=null}reset(){super.reset(),this.selectStart=null}handlePointerEvent(e){if(this.sceneMgr.hasBuildModeSelection())return new Promise((e=>e(!1)));const[t,s]=this.toCanvasCoords(e.clientX,e.clientY);if(e.eventEnum===hs.DOWN){if(e.button===ls.MAIN)return new Promise((e=>e(this.startSelection(t,s))))}else{if(e.eventEnum===hs.MOVE)return new Promise((e=>e(this.changeSelection(t,s))));if(e.eventEnum===hs.UP&&e.button===ls.MAIN)return new Promise((e=>e(this.selectEntities(t,s))))}return new Promise((e=>e(!1)))}startSelection(e,t){return this.selectStart={x:e,y:t},!0}changeSelection(e,t){return!!this.selectStart&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="rgba(128, 192, 192, 0.5)",this.context.lineWidth=2,this.context.strokeRect(this.selectStart.x,this.selectStart.y,e-this.selectStart.x,t-this.selectStart.y),!0)}selectEntities(e,t){if(!this.selectStart)return!1;let s;if(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),Math.abs(e-this.selectStart.x)<5&&Math.abs(t-this.selectStart.y)<5){const i=(this.selectStart.x+e)/this.canvas.width-1,r=-(this.selectStart.y+t)/this.canvas.height+1;s=this.sceneMgr.getSelectionByRay(i,r)}else{const i=this.selectStart.x/this.canvas.width*2-1,r=-this.selectStart.y/this.canvas.height*2+1,n=e/this.canvas.width*2-1,a=-t/this.canvas.height*2+1;s=this.sceneMgr.getEntitiesInFrustum(i,r,n,a)}return this.entityMgr.selection.set(s),M.publishEvent(this.entityMgr.selection.isEmpty()?new U:new F(this.entityMgr)),this.selectStart=null,!0}}class Is extends Ms{constructor(){super(),this.onLevelEnd=()=>console.log("Level aborted"),this.gameLayer=this.addLayer(new Ts(this),0),this.selectionLayer=this.addLayer(new Ps,10),this.guiLayer=this.addLayer(new Rs,20),this.overlayLayer=this.addLayer(new Cs,30),this.entityMgr=new pt,this.worldMgr=new ys,this.sceneMgr=new tt(this.gameLayer.canvas),this.sceneMgr.worldMgr=this.worldMgr,this.sceneMgr.entityMgr=this.entityMgr,this.worldMgr.sceneMgr=this.sceneMgr,this.worldMgr.entityMgr=this.entityMgr,this.cursorLayer.worldMgr=this.worldMgr,this.cursorLayer.sceneMgr=this.sceneMgr,this.cursorLayer.entityMgr=this.entityMgr,this.gameLayer.worldMgr=this.worldMgr,this.gameLayer.sceneMgr=this.sceneMgr,this.gameLayer.entityMgr=this.entityMgr,this.selectionLayer.worldMgr=this.worldMgr,this.selectionLayer.sceneMgr=this.sceneMgr,this.selectionLayer.entityMgr=this.entityMgr,this.guiLayer.entityMgr=this.entityMgr,this.overlayLayer.entityMgr=this.entityMgr,this.jobSupervisor=new ds(this.sceneMgr,this.entityMgr),this.guiMgr=new Xt(this.worldMgr,this.sceneMgr,this.entityMgr,this.jobSupervisor,this.gameLayer.canvas),this.guiLayer.onOptionsShow=()=>this.overlayLayer.showOptions(),this.overlayLayer.onSetSpaceToContinue=e=>this.guiLayer.setSpaceToContinue(e),this.overlayLayer.onAbortGame=()=>this.onLevelEnd(new $t(ut.QUIT,this.entityMgr)),this.overlayLayer.onRestartGame=()=>this.restartLevel()}startLevel(e,t){this.levelName=e,this.levelConf=t,this.setupAndStartLevel()}restartLevel(){this.hide(),o.reset(),this.setupAndStartLevel()}setupAndStartLevel(){console.log("Starting level "+this.levelName+" - "+this.levelConf.fullName),this.worldMgr.setup(this.levelConf,(e=>this.onLevelEnd(new $t(e,this.entityMgr)))),this.sceneMgr.setupScene(this.levelConf),this.guiMgr.buildingCycleIndex=0;const e=(0,a.hh)(gt.getResource(this.levelConf.objectiveText),this.levelName);this.guiLayer.reset(),this.overlayLayer.setup(e.objective,this.levelConf.objectiveImage640x480),M.publishEvent(new G(this.levelConf.priorities)),class{static loadObjectList(e,t,s,i){const r=gt.getResource(e.oListFile);Object.values(r).forEach((t=>{const r=(n=t.type?t.type.toLowerCase():t.type,"Pilot".equalsIgnoreCase(n)?b.PILOT:"Toolstation".equalsIgnoreCase(n)?b.TOOLSTATION:"TeleportPad".equalsIgnoreCase(n)?b.TELEPORT_PAD:"Docks".equalsIgnoreCase(n)?b.DOCKS:"PowerStation".equalsIgnoreCase(n)?b.POWER_STATION:"Barracks".equalsIgnoreCase(n)?b.BARRACKS:"Upgrade".equalsIgnoreCase(n)?b.UPGRADE:"GEO-Dome".equalsIgnoreCase(n)?b.GEODOME:"OreRefinery".equalsIgnoreCase(n)?b.ORE_REFINERY:"GunStation".equalsIgnoreCase(n)?b.GUNSTATION:"TeleportBIG".equalsIgnoreCase(n)?b.TELEPORT_BIG:"Bat".equalsIgnoreCase(n)?b.BAT:"SmallSpider".equalsIgnoreCase(n)?b.SMALL_SPIDER:"RockMonster".equalsIgnoreCase(n)?b.ROCK_MONSTER:"IceMonster".equalsIgnoreCase(n)?b.ICE_MONSTER:"LavaMonster".equalsIgnoreCase(n)?b.LAVA_MONSTER:"Dynamite".equalsIgnoreCase(n)?b.DYNAMITE:"EletricFence".equalsIgnoreCase(n)?b.ELECTRIC_FENCE:"PowerCrystal".equalsIgnoreCase(n)?b.CRYSTAL:"Ore".equalsIgnoreCase(n)?b.ORE:"Brick".equalsIgnoreCase(n)?b.BRICK:"Barrier".equalsIgnoreCase(n)?b.BARRIER:"Hoverboard".equalsIgnoreCase(n)?b.HOVERBOARD:"SmallDigger".equalsIgnoreCase(n)?b.SMALL_DIGGER:"SamllTruck".equalsIgnoreCase(n)?b.SMALL_TRUCK:"SmallCat".equalsIgnoreCase(n)?b.SMALL_CAT:"SmallMLP".equalsIgnoreCase(n)?b.SMALL_MLP:"SmallHeli".equalsIgnoreCase(n)?b.SMALL_HELI:"Bulldozer".equalsIgnoreCase(n)?b.BULLDOZER:"WalkerDigger".equalsIgnoreCase(n)?b.WALKER_DIGGER:"LargeMLP".equalsIgnoreCase(n)?b.LARGE_MLP:"LargeDigger".equalsIgnoreCase(n)?b.LARGE_DIGGER:"LargeCat".equalsIgnoreCase(n)?b.LARGE_CAT:"TVCamera".equalsIgnoreCase(n)?b.TV_CAMERA:(console.error("Could not identify entity type from string: "+n),null));var n;const a=new h.FM8(t.xPos,t.yPos).addScalar(-1).multiplyScalar(l.pM),o=gt.cfg("BuildingTypes",t.type),c=us(t.heading);if(r===b.TV_CAMERA){const e=new h.FM8(6,0).rotateAround(new h.FM8(0,0),c+Math.PI/2),t=s.getFloorPosition(e.multiplyScalar(l.pM).add(a));t.y+=4*l.pM,s.camera.position.copy(t),s.controls.target.copy(s.getFloorPosition(a)),s.controls.update(),s.setTorchPosition(new h.FM8(a.x,a.y-l.pM/2))}else if(r===b.PILOT){const e=new os(s,i);e.changeActivity(),e.sceneEntity.createPickSphere(e.stats.PickSphere,e),e.addToScene(a,c-Math.PI/2),e.sceneEntity.visible?(i.raiders.push(e),M.publishEvent(new J(i))):i.raidersUndiscovered.push(e)}else if(o)console.log(t.type+" heading: "+Math.round(t.heading%360)),this.createBuildingByName(o,s,i).placeDown(a,-c-Math.PI,e.disableStartTeleport);else if(r===b.CRYSTAL)i.placeMaterial(new qe(s,i),a);else if(r===b.SMALL_SPIDER){const e=new as(s,i);e.changeActivity(),e.addToScene(a,c),i.spiders.push(e),e.startMoving()}else if(r===b.BAT){const e=new ss(s,i);e.changeActivity(),e.addToScene(a,c),i.bats.push(e),e.startRandomMove()}else if(r===b.SMALL_DIGGER){const e=new qt(s,i);e.changeActivity(),e.sceneEntity.createPickSphere(e.stats.PickSphere,e),e.addToScene(a,c+Math.PI),e.sceneEntity.visible?i.vehicles.push(e):i.vehiclesUndiscovered.push(e)}else if(r===b.ICE_MONSTER){const e=new is(s,i);e.changeActivity(es.Unpowered),e.addToScene(a,c-Math.PI/2),i.rockMonsters.push(e)}else if(r===b.LAVA_MONSTER){const e=new rs(s,i);e.changeActivity(es.Unpowered),e.addToScene(a,c-Math.PI/2),i.rockMonsters.push(e)}else if(r===b.ROCK_MONSTER){const e=new ns(s,i);e.changeActivity(es.Unpowered),e.addToScene(a,c-Math.PI/2),i.rockMonsters.push(e)}else console.warn("Object type "+t.type+" not yet implemented")}))}static createBuildingByName(e,t,s){const i=e.slice(e.lastIndexOf("/")+1).toLowerCase();if("toolstation"===i)return new Ct(t,s);if("teleports"===i)return new Rt(t,s);if("docks"===i)return new bt(t,s);if("powerstation"===i)return new Lt(t,s);if("barracks"===i)return new Et(t,s);if("upgrade"===i)return new Pt(t,s);if("geo-dome"===i)return new St(t,s);if("orerefinery"===i)return new Tt(t,s);if("gunstation"===i)return new Mt(t,s);if("teleportbig"===i)return new At(t,s);throw"Unknown building type: "+i}}.loadObjectList(this.levelConf,this.worldMgr,this.sceneMgr,this.entityMgr),M.publishEvent(new q(this.sceneMgr.terrain,this.sceneMgr.controls.target.clone())),this.show()}show(){super.show(),this.sceneMgr.startScene(),this.worldMgr.start(),this.entityMgr.start(),this.jobSupervisor.start()}hide(){this.jobSupervisor.stop(),this.entityMgr.stop(),this.worldMgr.stop(),this.sceneMgr.disposeScene(),super.hide()}resize(e,t){var s;super.resize(e,t),null===(s=this.sceneMgr)||void 0===s||s.resize(e,t)}}function xs(e){const t=Array.isArray(e)?e.join(","):e;return null==t?void 0:t.replace(/_/g," ")}class Os{constructor(){this.x=0,this.y=0,this.width=0,this.height=0,this.zIndex=100,this.scrollAffected=!1,this.needsRedraw=!1,this.hover=!1,this.pressed=!1,this.actionName="",this.targetIndex=0}static compareZ(e,t){return e.zIndex===t.zIndex?0:e.zIndex>t.zIndex?-1:1}checkHover(e,t){const s=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height;return this.hover!==s&&(this.hover=s,this.needsRedraw=!0,this.onHoverChange()),this.hover||(this.pressed=!1),this.hover}onHoverChange(){}checkSetPressed(){this.hover&&(this.pressed||(this.needsRedraw=!0),this.pressed=!0)}setReleased(){this.pressed&&(this.needsRedraw=!0),this.pressed=!1}draw(e){this.needsRedraw=!1}}class Ds extends Os{constructor(e,t){super(),this.imgNormal=null,this.imgHover=null,this.imgPressed=null,this.tooltip="",this.imgNormal=gt.getImage(t.imgNormal),this.imgHover=gt.getImage(t.imgHover),this.imgPressed=gt.getImage(t.imgPressed),this.tooltip=(t.tooltip||"").replace(/_/g," "),this.width=Math.max(this.imgNormal.width,this.imgHover.width,this.imgPressed.width),this.height=Math.max(this.imgNormal.height,this.imgHover.height,this.imgPressed.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);let t=this.imgNormal;this.hover&&(t=this.imgHover),this.pressed&&(t=this.imgPressed),e.drawImage(t,this.x,this.y)}}class Ns extends Os{constructor(e,t){super(),this.labelImgLo=null,this.labelImgHi=null,this.labelImgLo=e.loFont.createTextImage(t.label),this.labelImgHi=e.hiFont.createTextImage(t.label),this.width=Math.max(this.labelImgLo.width,this.labelImgHi.width),this.height=Math.max(this.labelImgLo.height,this.labelImgHi.height),this.x=e.cfg.autoCenter?(e.fixedWidth-this.width)/2:e.cfg.position[0]+t.x,this.y=e.cfg.position[1]+t.y,this.actionName=t.actionName,"Next"===this.actionName&&(this.targetIndex=Number(t.target.substring("menu".length))-1)}draw(e){super.draw(e);const t=this.hover&&!this.pressed?this.labelImgHi:this.labelImgLo;e.drawImage(t,this.x,this.y)}}class _s extends vs{constructor(e,t){super(),this.items=[],this.scrollY=0,this.scrollSpeedY=0,this.scrollInterval=null,this.screen=e,this.cfg=t,this.loFont=t.loFont?gt.getBitmapFont(t.loFont):null,this.hiFont=t.hiFont?gt.getBitmapFont(t.hiFont):null,this.menuImage=t.menuImage?gt.getImage(t.menuImage):null,this.titleImage=this.loFont.createTextImage(t.fullName),t.itemsLabel.forEach((e=>{e.label?this.items.push(new Ns(this,e)):this.items.push(new Ds(this,e))})),this.items.sort(((e,t)=>Os.compareZ(e,t))),this.onRedraw=e=>{e.drawImage(this.menuImage,0,-this.scrollY),t.displayTitle&&e.drawImage(this.titleImage,(this.fixedWidth-this.titleImage.width)/2,this.cfg.position[1]),this.items.forEach(((t,s)=>this.items[this.items.length-1-s].draw(e)))}}reset(){super.reset(),this.scrollY=0,this.scrollSpeedY=0}show(){super.show();const e=this;this.scrollInterval=setInterval((()=>{0!==e.scrollSpeedY&&e.setScrollY(e.scrollSpeedY)}),1e3/l.OK)}hide(){this.scrollInterval=(0,a.nJ)(this.scrollInterval),super.hide()}handlePointerEvent(e){if(e.eventEnum===hs.MOVE){const[t,s]=this.toScaledCoords(e.clientX,e.clientY);let i=!1;if(this.items.forEach((e=>{if(i)e.hover&&(e.needsRedraw=!0),e.hover=!1,e.setReleased();else{const r=s+(e.scrollAffected?this.scrollY:0);i=e.checkHover(t,r)}})),this.cfg.canScroll){const e=100;s<e?this.setScrollSpeedY(-(e-s)):s>this.fixedHeight-e?this.setScrollSpeedY(s-(this.fixedHeight-e)):this.setScrollSpeedY(0)}}else e.eventEnum===hs.DOWN?e.button===ls.MAIN&&this.items.forEach((e=>e.checkSetPressed())):e.eventEnum===hs.UP&&e.button===ls.MAIN&&this.items.forEach((e=>{e.pressed&&(e.setReleased(),"next"===e.actionName.toLowerCase()?this.screen.showMainMenu(e.targetIndex):"selectlevel"===e.actionName.toLowerCase()?this.screen.selectLevel(e.levelKey):e.actionName&&console.warn("not implemented: "+e.actionName+" - "+e.targetIndex))}));return this.needsRedraw()&&this.redraw(),new Promise((e=>e(!1)))}setScrollSpeedY(e){this.scrollSpeedY=Math.sign(e)*Math.pow(Math.round(e/20),2)}handleWheelEvent(e){return this.cfg.canScroll?(this.setScrollY(e.deltaY),new Promise((e=>e(!0)))):new Promise((e=>e(!1)))}setScrollY(e){const t=this.scrollY;this.scrollY=Math.min(Math.max(this.scrollY+e,0),this.menuImage.height-this.fixedHeight),t!==this.scrollY&&this.redraw()}needsRedraw(){return this.items.some((e=>e.needsRedraw))}}class ks extends Os{constructor(e,t,s){super(),this.imgActive=null,this.imgInactive=null,this.imgCross=null,this.unlocked=!1,this.levelKey="",this.layer=e,this.actionName="selectlevel",this.levelKey=t,this.x=s.frontEndX,this.y=s.frontEndY,this.zIndex=10,this.scrollAffected=!0;const[i,r,n]=s.menuBMP;this.imgActive=gt.getImage(i),this.imgInactive=gt.getImage(r),this.imgCross=gt.getImage(n),this.width=Math.max(this.imgActive.width,this.imgInactive.width,this.imgCross.width),this.height=Math.max(this.imgActive.height,this.imgInactive.height,this.imgCross.height),this.unlocked=s.frontEndOpen,this.unlocked=!0}draw(e){super.draw(e);let t=this.imgCross;this.unlocked&&(t=this.hover?this.imgActive:this.imgInactive),e.drawImage(t,this.x,this.y-this.layer.scrollY)}}class Bs extends Os{constructor(e,t){super(),this.zIndex=50,this.context=(0,c.kr)(e.width,e.height),this.context.putImageData(e,0,0),this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}checkHover(e,t){const s=e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height&&this.context.getImageData(e,t,1,1).data[3]>0;return this.hover!==s&&(this.needsRedraw=!0),this.hover=s,this.hover}draw(e){super.draw(e),e.drawImage(this.context.canvas,this.x,this.y,this.width,this.height)}}class Fs extends Os{constructor(e,t){super(),this.imgFirstLine=null,this.imgSecondLine=null,this.font=e,this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}setFirstLine(e){this.imgFirstLine=e?this.font.createTextImage(e):null}setSecondLine(e){this.imgSecondLine=e?this.font.createTextImage(e):null}draw(e){super.draw(e);const t=this.x+this.width/2,s=this.y+this.height/2;this.imgFirstLine&&e.drawImage(this.imgFirstLine,t-this.imgFirstLine.width/2,s-this.imgFirstLine.height),this.imgSecondLine&&e.drawImage(this.imgSecondLine,t-this.imgSecondLine.width/2,s)}}class Us extends _s{constructor(e,t,s){super(e,t);const i=gt.getResource("Levels"),r=new Ws;this.items.push(new Bs(r.panelImgData,r.panelPos));const n=new Fs(gt.getDefaultFont(),r.window);n.setFirstLine(s?r.level:r.tutorial),this.items.push(n),Object.keys(i.levelsByName).forEach((e=>{const t=i.levelsByName[e],s=new ks(this,e,t);s.onHoverChange=()=>n.setSecondLine(s.hover?t.fullName:""),this.items.push(s)})),this.items.sort(((e,t)=>Os.compareZ(e,t)))}}class Ws{constructor(){this.window={x:0,y:0,w:0,h:0},this.panelPos={x:0,y:0,w:0,h:0},this.level="",this.tutorial="";const e=gt.cfg("Menu","LevelText"),t=(0,a.hh)(e,"Window");this.window={x:t[0],y:t[1],w:t[2],h:t[3]};const s=(0,a.hh)(e,"Panel");this.panelImgData=gt.getImageData(s[0]),this.panelPos={x:s[1],y:s[2],w:s[3],h:s[4]},this.level=xs((0,a.hh)(e,"Level")),this.tutorial=xs((0,a.hh)(e,"Tutorial"))}}class Gs extends Ms{constructor(){super(),this.onLevelSelected=null,this.menus=[],gt.getResource("MainMenuFull").menus.forEach((e=>{let t;t="Levels"===e.title?new Us(this,e,!0):"Tutorials"===e.title?new Us(this,e,!1):new _s(this,e),this.menus.push(t),this.addLayer(t)}))}showMainMenu(e=0){this.menus.forEach(((t,s)=>s===e?t.show():t.hide())),this.cursorLayer.show()}showLevelSelection(){this.showMainMenu(1)}selectLevel(e){this.hide(),this.onLevelSelected(e)}}class Hs extends Os{constructor(e){let t,s,i,r;super(),this.disabled=!1,this.visible=!0,[t,s,i,r,this.x,this.y]=e,this.imgNormal=gt.getImage(t),this.imgHover=gt.getImage(s),this.imgPressed=gt.getImage(i),this.imgDisabled=gt.getImage(r),this.width=this.imgNormal.width,this.height=this.imgNormal.height}draw(e){if(super.draw(e),!this.visible)return;let t=this.imgNormal;this.disabled?t=this.imgDisabled:this.pressed?t=this.imgPressed:this.hover&&(t=this.imgHover),e.drawImage(t,this.x,this.y)}}class Js extends Ms{constructor(){super(),this.cfg=null,this.resultIndex=0,this.resultLastIndex=0,this.images=[],this.boxes=[],this.fonts={},this.texts=[],this.uncoverTimeout=null,this.resultValues=[],this.cfg=gt.getResource("Reward"),this.titleFont=gt.getBitmapFont(this.cfg.titleFont);const e=gt.getImage(this.cfg.wallpaper);this.addLayer(new vs).onRedraw=t=>t.drawImage(e,0,0),this.cfg.images.forEach((e=>{this.images.push({img:gt.getImage(e.filePath),x:e.x,y:e.y})})),this.cfg.boxImages.forEach((e=>{this.boxes.push({img:gt.getImage(e.filePath),x:e.x,y:e.y})})),Object.keys(this.cfg.fonts).forEach(((e,t)=>{const s=gt.getBitmapFont(this.cfg.fonts[e]);this.fonts[e.toLowerCase()]=s;const i=this.cfg.texts[t],r=t<9?s:gt.getBitmapFont(this.cfg.backFont);this.texts.push(r.createTextImage(i.text))})),this.resultsLayer=this.addLayer(new vs),this.resultsLayer.handlePointerEvent=e=>e.eventEnum===hs.UP?(this.uncoverTimeout=(0,a.L4)(this.uncoverTimeout),this.uncoverTimeout=null,this.resultIndex=this.resultLastIndex,this.btnSave.visible=!0,this.btnAdvance.visible=!0,this.redraw(),new Promise((e=>e(!0)))):new Promise((e=>e(!1))),this.descriptionTextLayer=this.addLayer(new vs,20),this.btnLayer=this.addLayer(new vs,50),this.btnSave=new Hs(this.cfg.saveButton),this.btnSave.disabled=!0,this.btnAdvance=new Hs(this.cfg.advanceButton),this.btnLayer.handlePointerEvent=e=>{if(e.eventEnum===hs.MOVE){const[t,s]=this.btnLayer.toScaledCoords(e.clientX,e.clientY);this.btnSave.checkHover(t,s),this.btnAdvance.checkHover(t,s)}else e.eventEnum===hs.DOWN?e.button===ls.MAIN&&(this.btnSave.checkSetPressed(),this.btnAdvance.checkSetPressed()):e.eventEnum===hs.UP&&e.button===ls.MAIN&&(this.btnSave.pressed?this.btnSave.setReleased():this.btnAdvance.pressed&&(this.btnAdvance.setReleased(),this.hide(),this.onAdvance()));return(this.btnSave.needsRedraw||this.btnAdvance.needsRedraw)&&this.redraw(),new Promise((e=>e(!1)))},this.btnLayer.onRedraw=e=>{this.btnSave.draw(e),this.btnAdvance.draw(e)}}setGameResult(e){this.resultText=this.cfg.quitText,this.resultLastIndex=this.images.length-2,e.state===ut.COMPLETE?(this.resultText=this.cfg.completeText,this.resultLastIndex=this.images.length-1):e.state===ut.FAILED&&(this.resultText=this.cfg.failedText),this.resultValues=[],this.resultValues.push(this.fonts.crystals.createTextImage(this.percentString(o.numCrystal,o.neededCrystals))),this.resultValues.push(this.fonts.ore.createTextImage(this.percentString(o.numOre,o.totalOres))),this.resultValues.push(this.fonts.diggable.createTextImage(this.percentString(o.remainingDiggables,o.totalDiggables,!0))),this.resultValues.push(this.fonts.constructions.createTextImage(e.numBuildings.toString())),this.resultValues.push(this.fonts.caverns.createTextImage(this.percentString(o.discoveredCaverns,o.totalCaverns))),this.resultValues.push(this.fonts.figures.createTextImage(this.percentString(e.numRaiders,e.numMaxRaiders))),this.resultValues.push(this.fonts.rockmonsters.createTextImage(this.percentString(0))),this.resultValues.push(this.fonts.oxygen.createTextImage(this.percentString(o.airLevel))),this.resultValues.push(this.fonts.timer.createTextImage(this.timeString(o.gameTimeSeconds))),this.resultValues.push(this.fonts.score.createTextImage(this.percentString(this.calcScore(e))))}calcScore(e){if(!this.rewardConfig)return 0;let t=this.rewardConfig.quota,s=this.rewardConfig.importance;const i=o.numCrystal>=(t.crystals||1/0)?s.crystals:0,r=o.gameTimeSeconds<=(t.timer||0)?s.timer:0,n=t.caverns?Math.min(1,o.discoveredCaverns/t.caverns)*s.caverns:0,a=t.constructions?Math.min(1,e.numBuildings/t.constructions*s.constructions):0,h=o.airLevel*s.oxygen,c=e.numRaiders>=l.d?s.figures:0;return Math.max(0,Math.min(100,Math.round(i+r+n+a+h+c)/100))}show(){this.resultIndex=0,this.btnSave.visible=!1,this.btnAdvance.visible=!1,this.uncoverResult();const e=this.titleFont.createTextImage(this.resultText);this.resultsLayer.onRedraw=t=>{t.clearRect(0,0,this.resultsLayer.fixedWidth,this.resultsLayer.fixedHeight);for(let e=0;e<=this.resultIndex;e++){const s=this.images[e];s&&t.drawImage(s.img,s.x,s.y)}for(let e=0;e<=this.resultIndex;e++){const s=this.boxes[e];s&&t.drawImage(s.img,s.x,s.y)}for(let e=0;e<=this.resultIndex;e++){const s=this.cfg.texts[e],i=this.resultValues[e];i&&t.drawImage(i,s.x-i.width/2,s.y)}t.drawImage(this.levelFullNameImg,this.resultsLayer.fixedWidth/2-this.levelFullNameImg.width/2,this.cfg.vertSpacing-this.levelFullNameImg.height/2),t.drawImage(e,this.resultsLayer.fixedWidth/2-e.width/2,this.cfg.vertSpacing+this.levelFullNameImg.height/2)},this.descriptionTextLayer.onRedraw=e=>{const t=this.texts[this.resultIndex];e.clearRect(0,this.cfg.textPos[1],this.descriptionTextLayer.fixedWidth,this.descriptionTextLayer.fixedHeight-this.cfg.textPos[1]);const s=this.resultIndex!==this.images.length-1?this.cfg.textPos[0]:305,i=this.resultIndex!==this.images.length-1?this.cfg.textPos[1]:195;e.drawImage(t,s-t.width/2,i)},super.show()}percentString(e,t=1,s=!1){0===t&&(t=1);let i=Math.round(100*Math.max(Math.min(e/t,1),0));return s&&(i=100-i),i.toString()+"%"}padLeft(e,t="0",s=2){for(;e.length<s;)e=t+e;return e}timeString(e){const t=this.padLeft((e%60).toString()),s=Math.floor(e/60),i=this.padLeft((s%60).toString());return this.padLeft(Math.floor(s/60).toString())+":"+i+":"+t}uncoverResult(){this.uncoverTimeout=setTimeout((()=>{this.uncoverTimeout=null,this.resultIndex++,this.resultIndex<this.resultLastIndex?this.uncoverResult():(this.btnSave.visible=!0,this.btnAdvance.visible=!0),this.redraw()}),1e3*this.cfg.timer)}setup(e,t){this.levelFullNameImg=this.titleFont.createTextImage(e),this.rewardConfig=t}}l.Sl&&console.warn("DEV MODE ACTIVE");const Vs=new class extends Ms{constructor(){super(),this.assetIndex=0,this.layer=this.addLayer(new vs)}show(){this.layers.forEach((e=>{e!==this.cursorLayer&&e.show()})),this.setLoadingMessage("Loading...")}setLoadingMessage(e){this.layer.onRedraw=t=>{t.fillStyle="black",t.fillRect(0,0,this.layer.fixedWidth,this.layer.fixedHeight),t.font="24px Arial",t.fillStyle="white",t.fillText("Loading Rock Raiders",20,this.layer.fixedHeight-50),t.font="18px Arial",t.fillStyle="white",t.fillText(e,20,this.layer.fixedHeight-20)},this.redraw()}enableGraphicMode(e){const t=gt.getImage(gt.cfg("Main","LoadScreen")),s=gt.getImage(gt.cfg("Main","ProgressBar")),i=gt.getDefaultFont().createTextImage(gt.cfg("Main","LoadingText"));this.layer.onRedraw=r=>{r.drawImage(t,0,0);const n=353*(this.assetIndex<e?Math.round(this.assetIndex/e):1);r.drawImage(s,142,450,n,9),r.drawImage(i,Math.round(320-i.width/2),Math.round(456-i.height/2))},this.cursorLayer.show(),this.redraw()}increaseLoadingState(){this.assetIndex++,this.redraw()}},qs=new n.WadFileSelectionModal("game-container"),js=new r.GithubBox("game-container"),Zs=new i.ClearCacheButton("game-container");qs.onStart=(e,t)=>{gt.startLoadingFromUrl(e,t)},gt.onMessage=e=>{Vs.setLoadingMessage(e)},gt.onCacheMissed=()=>{qs.show()},gt.onInitialLoad=e=>{qs.hide(),Vs.enableGraphicMode(e)},gt.onAssetLoaded=()=>{Vs.increaseLoadingState()},gt.onLoadDone=()=>{const e=new Gs,t=new Is,s=new Js;e.onLevelSelected=i=>{let r=null;try{r=gt.getResource("Levels").levelsByName[i],r&&(s.setup(r.fullName,r.reward),t.startLevel(i,r))}catch(e){console.error("Could not load level: "+i,e)}finally{r||(console.error('Could not find level configuration for "'+i+'"'),t.hide(),e.showLevelSelection())}},t.onLevelEnd=e=>{t.hide(),s.setGameResult(e),s.show()},s.onAdvance=()=>{o.reset(),e.showLevelSelection()},Vs.hide(),js.hide(),Zs.hide();const i=new URLSearchParams(window.location.search),r=i.get("entry");l.Sl&&r?(o.numOre=Number(i.get("numOre"))||0,o.numCrystal=Number(i.get("numCrystal"))||0,"level"===r?e.showLevelSelection():"reward"===r?s.show():"random"===r?e.selectLevel("Level"+("00"+(0,a.$u)(1,25)).substr(-2)):r&&e.selectLevel(r)):e.showMainMenu()},Vs.show(),gt.startLoadingFromCache()},848:(e,t,s)=>{"use strict";s.d(t,{Sl:()=>i,UV:()=>r,$I:()=>n,p$:()=>a,Wc:()=>o,d:()=>l,oq:()=>h,SO:()=>c,w$:()=>u,a4:()=>d,m8:()=>g,Du:()=>p,DG:()=>y,pM:()=>m,OK:()=>v,l3:()=>f});const i=!1,r="RockRaidersWeb",n=1e3,a=5e3,o=1e3,l=12,h=10,c=5e3,u=.1,d=5,g=20,p=640,y=480,m=40,v=30,f=1e3/v},351:(e,t,s)=>{"use strict";e.exports=s.p+"266ca63177bca6f330a7.png"}}]);
//# sourceMappingURL=274.index.js.map