(()=>{"use strict";function t(t){return 130===t?"ä".charCodeAt(0):142===t?"Ä".charCodeAt(0):162===t?"ö".charCodeAt(0):167===t?"Ü".charCodeAt(0):171===t?"ü".charCodeAt(0):195===t?"ß".charCodeAt(0):t}var e=function(){function e(){}return e.parse=function(s){for(var i={},a=[],r=i,o=!1,n=0,h="",l="",d=0;d<s.length;d++){var f=s[d];123===f&&"FullName"===h&&(f=142);var c=String.fromCharCode(t(f));if(";"===c||"/"===c?o=!0:10!==f&&13!==f||(o=!1),!o)if(f>32)0===n?"}"===c?r=a.pop():(n++,h=c):1===n?h+=c:2===n?"{"===c?(a.push(r),r={},a[a.length-1][h]=r,n=0):(n++,l=c):3===n&&(l+=c);else if(1===n)n++;else if(3===n){n=0;var u=e.parseValue(l);r.hasOwnProperty(h)?r[h].push(u):r[h]=[u]}}for(var p=[i],g=function(){var t=p.pop();Object.keys(t).forEach((function(e){var s=t[e];Array.isArray(s)?1===s.length?t[e]=s[0]:s.forEach((function(t){return p.push(t)})):Object.keys(s).length>1&&p.push(s)}))};p.length>0;)g();return Object.values(i["Lego*"].Levels).forEach((function(t){t.CryoreMap&&(t.CryOreMap=t.CryoreMap,delete t.CryoreMap),t.CryOreMap&&(t.CryOreMap=t.CryOreMap.replace("Cryo_","Cror_")),t.PredugMap&&(t.PreDugMap=t.PredugMap,delete t.PredugMap)})),i["Lego*"]},e.parseValue=function(t){var s=Number(t);function i(s){0===(t=t.split(s).filter((function(t){return""!==t})).map((function(t){return e.parseValue(t)}))).length?t="":1===t.length&&(t=t[0])}if(isNaN(s)){var a=(t=t.toString().replace(/\\/g,"/")).toLowerCase();return"true"===a||"false"!==a&&("null"===a?"":(t.includes(",")?i.call(this,","):t.includes(":")?i.call(this,":"):t.includes("|")&&i.call(this,"|"),t))}return s},e}(),s=function(){function e(){this.buffer=null,this.entries=[],this.fLength=[],this.fStart=[]}return e.prototype.parseWadFile=function(t,e){void 0===e&&(e=!1);var s=new DataView(t);this.buffer=new Int8Array(t);var i=0;if("WWAD"!==String.fromCharCode.apply(null,this.buffer.slice(i,4)))throw"Invalid WAD0 file provided";e&&console.log("WAD0 file seems legit"),i=4;var a=s.getInt32(i,!0);e&&console.log(a);for(var r=i=8,o=0;o<a;i++)0===this.buffer[i]&&(this.entries[o]=String.fromCharCode.apply(null,this.buffer.slice(r,i)).replace(/\\/g,"/").toLowerCase(),r=i+1,o++);for(e&&console.log(this.entries),o=0;o<a;i++)0===this.buffer[i]&&(r=i+1,o++);for(e&&console.log("Offset after absolute original names is "+i),o=0;o<a;o++)this.fLength[o]=s.getInt32(i+8,!0),this.fStart[o]=s.getInt32(i+12,!0),i+=16;e&&(console.log(this.fLength),console.log(this.fStart))},e.prototype.getEntryData=function(t){return new Uint8Array(this.getEntryBuffer(t))},e.prototype.getEntryText=function(e){return(new TextDecoder).decode(this.getEntryBuffer(e).map((function(e){return t(e)})))},e.prototype.getEntryBuffer=function(t){for(var e=t.toLowerCase(),s=0;s<this.entries.length;s++)if(this.entries[s]===e)return this.buffer.slice(this.fStart[s],this.fStart[s]+this.fLength[s]);throw"Entry '"+t+"' not found in WAD file"},e.prototype.filterEntryNames=function(t){for(var e=new RegExp(t.toLowerCase()),s=[],i=0;i<this.entries.length;i++){var a=this.entries[i];a.toLowerCase().match(e)&&s.push(a)}return s},e}();function i(t){if(!t)return t;var e=t.toString().replace(/\\/g,"/");e.startsWith("/")&&(e=e.substring(1));var s=e.lastIndexOf("/");return(e=e.substring(0,s+1)).startsWith("/")&&(e=e.substring(1)),e}function a(t){if(!t)return t;var e=t.toString().replace(/\\/g,"/");e.startsWith("/")&&(e=e.substring(1));var s=e.lastIndexOf("/");return e.substring(s+1)}function r(t){for(var e=[],s=1;s<arguments.length;s++)e[s-1]=arguments[s];return e.forEach((function(e){t=(t=Object.keys(t).filter((function(t){return t.toLowerCase()===e.toLowerCase()})).map((function(e){return t[e]})))?t[0]:t})),t}var o,n=function(){function t(){}return t.prototype.parse=function(t){var e=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((function(t){var e=t.indexOf("//");e>-1&&(t=t.substring(0,e));var s=t.indexOf(";");return s>-1&&(t=t.substring(0,s)),t})).map((function(t){return t.trim()})).filter((function(t){return""!==t})).map((function(t){return t.split(" ").filter((function(t){return""!==t}))})),s={};return this.parseObj(s,e,0),s},t.prototype.parseObj=function(t,e,s){for(var i=this,a=s;a<e.length;a++){var r=e[a],o=r[0],n=r[1],h=o.toLowerCase();if("{"===n)t[h]={},a=this.parseObj(t[h],e,a+1);else{if("}"===h)return a;for(var l=n.split(":").filter((function(t){return""!==t})).map((function(t){return t.split(",").map((function(t){return t.split("|").map((function(t){return i.parseValue(t)}))}))}));1===l.length;)l=l[0];t[h]=l}}return e.length},t.prototype.parseValue=function(t){var e=Number(t),s=t.toLowerCase();return isNaN(e)?"false"!==s&&("true"===s||t):e},t}();!function(t){t[t.BITMAP_INFO_HEADER=40]="BITMAP_INFO_HEADER",t[t.BITMAP_V2_INFO_HEADER=52]="BITMAP_V2_INFO_HEADER",t[t.BITMAP_V3_INFO_HEADER=56]="BITMAP_V3_INFO_HEADER",t[t.BITMAP_V4_HEADER=108]="BITMAP_V4_HEADER",t[t.BITMAP_V5_HEADER=124]="BITMAP_V5_HEADER"}(o||(o={}));var h=function(){function t(t,e){var s=(void 0===e?{toRGBA:!1}:e).toRGBA;if(this.buffer=t,this.bufferView=new DataView(t.buffer,t.byteOffset,t.byteLength),this.toRGBA=!!s,this.bottomUp=!0,this.flag=String.fromCharCode(this.buffer[0])+String.fromCharCode(this.buffer[1]),this.pos=2,"BM"!==this.flag)throw new Error("Invalid BMP File");this.locRed=this.toRGBA?0:3,this.locGreen=this.toRGBA?1:2,this.locBlue=this.toRGBA?2:1,this.locAlpha=this.toRGBA?3:0,this.parseHeader(),this.parseRGBA()}return t.prototype.parseHeader=function(){if(this.fileSize=this.readUInt32LE(),this.reserved1=this.bufferView.getUint16(this.pos,!0),this.pos+=2,this.reserved2=this.bufferView.getUint16(this.pos,!0),this.pos+=2,this.offset=this.readUInt32LE(),this.headerSize=this.readUInt32LE(),!(this.headerSize in o))throw new Error("Unsupported BMP header size "+this.headerSize);if(this.width=this.readUInt32LE(),this.height=this.readUInt32LE(),this.planes=this.bufferView.getUint16(this.pos,!0),this.pos+=2,this.bitPP=this.bufferView.getUint16(this.pos,!0),this.pos+=2,this.compression=this.readUInt32LE(),this.rawSize=this.readUInt32LE(),this.hr=this.readUInt32LE(),this.vr=this.readUInt32LE(),this.colors=this.readUInt32LE(),this.importantColors=this.readUInt32LE(),32===this.bitPP?(this.maskAlpha=0,this.maskRed=16711680,this.maskGreen=65280,this.maskBlue=255):16===this.bitPP&&(this.maskAlpha=0,this.maskRed=31744,this.maskGreen=992,this.maskBlue=31),(this.headerSize>o.BITMAP_INFO_HEADER||3===this.compression||6===this.compression)&&(this.maskRed=this.readUInt32LE(),this.maskGreen=this.readUInt32LE(),this.maskBlue=this.readUInt32LE()),(this.headerSize>o.BITMAP_V2_INFO_HEADER||6===this.compression)&&(this.maskAlpha=this.readUInt32LE()),this.headerSize>o.BITMAP_V3_INFO_HEADER&&(this.pos+=o.BITMAP_V4_HEADER-o.BITMAP_V3_INFO_HEADER),this.headerSize>o.BITMAP_V4_HEADER&&(this.pos+=o.BITMAP_V5_HEADER-o.BITMAP_V4_HEADER),this.bitPP<=8||this.colors>0){var t=0===this.colors?1<<this.bitPP:this.colors;this.palette=new Array(t);for(var e=0;e<t;e++){var s=this.buffer[this.pos++],i=this.buffer[this.pos++],a=this.buffer[this.pos++],r=this.buffer[this.pos++];this.palette[e]={red:a,green:i,blue:s,quad:r}}}this.height<0&&(this.height*=-1,this.bottomUp=!1);var n,h,l,d,f,c,u,p,g,m,A,v,w=(n=this.maskRed,h=this.maskGreen,l=this.maskBlue,d=this.maskAlpha,g=n/(f=1+~n&n)+1,m=h/(c=1+~h&h)+1,A=l/(u=1+~l&l)+1,v=d/(p=1+~d&d)+1,{shiftRed:function(t){return(t&n)/f*256/g},shiftGreen:function(t){return(t&h)/c*256/m},shiftBlue:function(t){return(t&l)/u*256/A},shiftAlpha:0!==d?function(t){return(t&d)/p*256/v}:function(){return 255}});this.shiftRed=w.shiftRed,this.shiftGreen=w.shiftGreen,this.shiftBlue=w.shiftBlue,this.shiftAlpha=w.shiftAlpha},t.prototype.parseRGBA=function(){switch(this.data=new Uint8Array(this.width*this.height*4),this.bitPP){case 1:this.bit1();break;case 4:this.bit4();break;case 8:this.bit8();break;case 16:this.bit16();break;case 24:this.bit24();break;default:this.bit32()}},t.prototype.bit1=function(){var t,e=this,s=Math.ceil(this.width/8),i=s%4,a=0!==i?4-i:0;this.scanImage(a,s,(function(s,i){i!==t&&(t=i);for(var a=e.buffer[e.pos++],r=i*e.width*4+8*s*4,o=0;o<8&&8*s+o<e.width;o++){var n=e.palette[a>>7-o&1];e.data[r+o*e.locAlpha]=0,e.data[r+4*o+e.locBlue]=n.blue,e.data[r+4*o+e.locGreen]=n.green,e.data[r+4*o+e.locRed]=n.red}}))},t.prototype.bit4=function(){var t=this;if(2===this.compression){this.data.fill(0);for(var e=!1,s=this.bottomUp?this.height-1:0,i=0;i<this.data.length;){var a=this.buffer[this.pos++],r=this.buffer[this.pos++];if(0===a){if(0===r){i=(s+=this.bottomUp?-1:1)*this.width*4,e=!1;continue}if(1===r)break;if(2===r){var o=this.buffer[this.pos++],n=this.buffer[this.pos++];s+=this.bottomUp?-n:n,i+=n*this.width*4+4*o}else{for(var h=this.buffer[this.pos++],l=0;l<r;l++)i=this.setPixelData(i,e?15&h:(240&h)>>4),1&l&&l+1<r&&(h=this.buffer[this.pos++]),e=!e;1==(r+1>>1&1)&&this.pos++}}else for(l=0;l<a;l++)i=this.setPixelData(i,e?15&r:(240&r)>>4),e=!e}}else{var d=Math.ceil(this.width/2),f=d%4,c=0!==f?4-f:0;this.scanImage(c,d,(function(e,s){var i=t.buffer[t.pos++],a=s*t.width*4+2*e*4,r=i>>4,o=t.palette[r];if(t.data[a]=0,t.data[a+1]=o.blue,t.data[a+2]=o.green,t.data[a+3]=o.red,2*e+1>=t.width)return!1;var n=15&i;o=t.palette[n],t.data[a+4]=0,t.data[a+4+1]=o.blue,t.data[a+4+2]=o.green,t.data[a+4+3]=o.red}))}},t.prototype.bit8=function(){var t=this;if(1===this.compression){this.data.fill(0);for(var e=this.bottomUp?this.height-1:0,s=0;s<this.data.length;){var i=this.buffer[this.pos++],a=this.buffer[this.pos++];if(0===i){if(0===a){s=(e+=this.bottomUp?-1:1)*this.width*4;continue}if(1===a)break;if(2===a){var r=this.buffer[this.pos++],o=this.buffer[this.pos++];e+=this.bottomUp?-o:o,s+=o*this.width*4+4*r}else{for(var n=0;n<a;n++){var h=this.buffer[this.pos++];s=this.setPixelData(s,h)}!0&a&&this.pos++}}else for(n=0;n<i;n++)s=this.setPixelData(s,a)}}else{var l=this.width%4,d=0!==l?4-l:0;this.scanImage(d,this.width,(function(e,s){var i=t.buffer[t.pos++],a=s*t.width*4+4*e;if(i<t.palette.length){var r=t.palette[i];t.data[a]=0,t.data[a+1]=r.blue,t.data[a+2]=r.green,t.data[a+3]=r.red}else t.data[a]=0,t.data[a+1]=255,t.data[a+2]=255,t.data[a+3]=255}))}},t.prototype.bit16=function(){var t=this,e=this.width%2*2;this.scanImage(e,this.width,(function(e,s){var i=s*t.width*4+4*e,a=t.bufferView.getUint16(t.pos,!0);t.pos+=2,t.data[i+t.locRed]=t.shiftRed(a),t.data[i+t.locGreen]=t.shiftGreen(a),t.data[i+t.locBlue]=t.shiftBlue(a),t.data[i+t.locAlpha]=t.shiftAlpha(a)}))},t.prototype.bit24=function(){var t=this,e=this.width%4;this.scanImage(e,this.width,(function(e,s){var i=s*t.width*4+4*e,a=t.buffer[t.pos++],r=t.buffer[t.pos++],o=t.buffer[t.pos++];t.data[i+t.locRed]=o,t.data[i+t.locGreen]=r,t.data[i+t.locBlue]=a,t.data[i+t.locAlpha]=0}))},t.prototype.bit32=function(){var t=this;this.scanImage(0,this.width,(function(e,s){var i=s*t.width*4+4*e,a=t.readUInt32LE();t.data[i+t.locRed]=t.shiftRed(a),t.data[i+t.locGreen]=t.shiftGreen(a),t.data[i+t.locBlue]=t.shiftBlue(a),t.data[i+t.locAlpha]=t.shiftAlpha(a)}))},t.prototype.scanImage=function(t,e,s){void 0===t&&(t=0),void 0===e&&(e=this.width);for(var i=this.height-1;i>=0;i--){for(var a=this.bottomUp?i:this.height-1-i,r=0;r<e;r++)s.call(this,r,a);this.pos+=t}},t.prototype.readUInt32LE=function(){var t=this.bufferView.getUint32(this.pos,!0);return this.pos+=4,t},t.prototype.setPixelData=function(t,e){var s=this.palette[e],i=s.blue,a=s.green,r=s.red;return this.data[t+this.locAlpha]=0,this.data[t+1+this.locBlue]=i,this.data[t+2+this.locGreen]=a,this.data[t+3+this.locRed]=r,t+4},t}(),l=function(){function t(){}return t.parse=function(t){for(var e=new h(t),s=new Uint8ClampedArray(e.data.length),i=0;i<e.data.length;i+=4)s[i]=e.data[i+3],s[i+1]=e.data[i+2],s[i+2]=e.data[i+1],s[i+3]=255-e.data[i];return new ImageData(s,e.width,e.height)},t}(),d=function(t){this.actionName=t[0],this.x=Number(t[1]),this.y=Number(t[2]),5===t.length?this.label=t[3].replace(/_/g," "):8===t.length?(this.imgNormal=t[3],this.imgHover=t[4],this.imgPressed=t[5],this.tooltip=t[6]):console.warn("Unexpected cfg object length: "+t.length),this.target=t[t.length-1]},f=function(t){var e=this;this.fullName="",this.title="",this.position=[0,0],this.menuFont="",this.loFont="",this.hiFont="",this.itemCount=0,this.menuImage="",this.autoCenter=!1,this.displayTitle=!1,this.overlays=[],this.playRandom=!1,this.items=[],this.anchored=!1,this.canScroll=!1,Object.keys(t).forEach((function(s){var i=(s.startsWith("!")?s.substring(1):s).toLowerCase();Object.keys(e).some((function(a){return a.toLowerCase()===i?(e[a]=t[s],!0):i.match(/item\d+/i)?(e.items.push(new d(t[s])),!0):i.match(/overlay\d+/i)?(e.overlays.push(t[s]),!0):void 0}))||console.warn("cfg key does not exist on menu config: "+s)}))},c=function(t){var e=this;this.menuCount=0,this.menus=[],Object.keys(t).forEach((function(s){var i=(s.startsWith("!")?s.substring(1):s).toLowerCase();Object.keys(e).some((function(a){return a.toLowerCase()===i?(e[a]=t[s],!0):i.startsWith("menu")?(e.menus.push(new f(t[s])),!0):void 0}))||console.warn("cfg key does not exist on menu full config: "+s)}))},u=function(t){var e=this;this.levelsByName=[],Object.keys(t).forEach((function(s){(s.startsWith("Tutorial")||s.startsWith("Level"))&&(e.levelsByName[s]=new p(t[s]))}))},p=function(t){var e=this;this.fullName="",this.endGameAvi1="",this.endGameAvi2="",this.allowRename=!1,this.recallOLObjects=!1,this.generateSpiders=!1,this.video="",this.disableEndTeleport="",this.disableStartTeleport="",this.emergeTimeOut="",this.boulderAnimation="",this.noMultiSelect="",this.noAutoEat="",this.disableToolTipSound="",this.blockSize="",this.digDepth="",this.roughLevel="",this.roofHeight="",this.useRoof="",this.selBoxHeight="",this.fpRotLightRGB="",this.fogColourRGB="",this.highFogColourRGB="",this.fogRate=0,this.fallinMultiplier=0,this.numberOfLandSlidesTillCaveIn=0,this.noFallins=!1,this.oxygenRate=0,this.surfaceMap="",this.predugMap="",this.terrainMap="",this.emergeMap="",this.erodeMap="",this.fallinMap="",this.blockPointersMap="",this.cryOreMap="",this.pathMap="",this.noGather=!1,this.textureSet="",this.rockFallStyle="",this.emergeCreature="",this.safeCaverns="",this.seeThroughWalls="",this.oListFile="",this.ptlFile="",this.nerpFile="",this.nerpMessageFile="",this.objectiveText="",this.objectiveImage640x480="",this.erodeTriggerTime=0,this.erodeErodeTime=0,this.erodeLockTime=0,this.nextLevel="",this.levelLinks="",this.frontEndX=0,this.frontEndY=0,this.frontEndOpen=!1,this.menuBMP=[],Object.keys(t).forEach((function(s){var i=(s.startsWith("!")?s.substring(1):s).toLowerCase();Object.keys(e).some((function(a){return a.toLowerCase()===i?(e[a]=t[s],!0):"priorities"===i||"reward"===i||void 0}))||console.warn("cfg key does not exist on menu full config: "+s)}))},g=function(t){var e=this;this.display=!0,this.wallpaper="",this.images=[],this.texts=[],this.boxImages=[],this.fonts=null,this.flics=null,this.scrollSpeed=0,this.centreText=!1,this.vertSpacing=0,this.backFont="",this.font="",this.titleFont="",this.timer=0,this.saveButton="",this.advanceButton="",this.completeText="",this.failedText="",this.quitText="",this.textPos=[0,0],Object.keys(t).forEach((function(s){var i=(s.startsWith("!")?s.substring(1):s).toLowerCase();Object.keys(e).some((function(a){return"images"===i?(Object.values(t[s]).forEach((function(t){return e.images.push(new m(t))})),!0):"text"===i?(Object.values(t[s]).forEach((function(t){return e.texts.push(new A(t))})),!0):"boximages"===i?(Object.values(t[s]).forEach((function(t){return e.boxImages.push(new m(t))})),!0):"fonts"===i?(e.fonts=new v(t[s]),!0):a.toLowerCase()===i?(e[a]=t[s],!0):void 0}))||console.warn("cfg key does not exist on menu full config: "+s)}))},m=function(t){this.filePath="",this.x=0,this.y=0,this.filePath=t[0],this.x=t[1],this.y=t[2]},A=function(t){this.text="",this.x=0,this.y=0,this.text=t[0],this.x=t[1],this.y=t[2]},v=function(t){var e=this;this.crystals="",this.ore="",this.diggable="",this.constructions="",this.caverns="",this.figures="",this.rockMonsters="",this.oxygen="",this.timer="",this.score="",Object.keys(t).forEach((function(s){var i=(s.startsWith("!")?s.substring(1):s).toLowerCase();Object.keys(e).some((function(a){if(a.toLowerCase()===i)return e[a]=t[s],!0}))||console.warn("cfg key does not exist on menu full config: "+s)}))},w=function(){function t(){this.wad0File=null,this.wad1File=null,this.assetIndex=0,this.totalResources=0,this.onMessage=function(t){console.log(t)},this.onInitialLoad=function(){console.log("Initial loading done.")},this.onAssetLoaded=function(){},this.onLoadDone=function(t,e){console.log("Loading of about "+t+" assets complete! Total load time: "+e+" seconds.")}}return t.prototype.loadWadImageAsset=function(t,e){var s=this.wad0File.getEntryData(t);e(l.parse(s))},t.prototype.loadWadTexture=function(t,e){for(var s=this.wad0File.getEntryData(t),i=l.parse(s),r=function(t){var e=a(t);return!!(e.match(/\d\d\d\..+$/i)||e.match(/^trans/i)||e.match(/telepulse/i)||e.match(/^t_/i)||e.includes("crystalglow"))}(t),o=function(t){return!!a(t).match(/^a.+/i)}(t),n=i.data[i.data.length-4],h=i.data[i.data.length-3],d=i.data[i.data.length-2],f=0;f<i.data.length;f+=4)r?255===i.data[f]&&255===i.data[f+1]&&255===i.data[f+2]?i.data[f+3]=0:i.data[f+3]=Math.max(i.data[f],i.data[f+1],i.data[f+2]):(o&&i.data[f]===n&&i.data[f+1]===h&&i.data[f+2]===d||i.data[f]<=2&&i.data[f+1]<=2&&i.data[f+2]<=2)&&(i.data[f+3]=0);e(i)},t.prototype.loadAlphaImageAsset=function(t,e){for(var s=this.wad0File.getEntryData(t),i=l.parse(s),a=0;a<i.data.length;a+=4)i.data[a]<=2&&i.data[a+1]<=2&&i.data[a+2]<=2&&(i.data[a+3]=0);e(i)},t.prototype.loadFontImageAsset=function(t,e){var s=this.wad0File.getEntryData(t);e(l.parse(s))},t.prototype.loadNerpAsset=function(t,e){t=t.replace(/.npl$/,".nrn"),e(this.wad0File.getEntryText(t))},t.prototype.parseNerpMsgFile=function(t,e){for(var s=[],i=t.getEntryText(e).split("\n"),a=0;a<i.length;a++){var r=i[a].trim();if(!(r.length<1||"-"===r)){var o=r.match(/\\\[([^\\]+)\\](\s*#([^#]+)#)?/),n=r.match(/^([^$][^#]+)(\s*#([^#]+)#)?/),h=r.match(/\$([^\s]+)\s*([^\s]+)/);if(t===this.wad0File&&o)s[l=void 0!==o[3]?this.numericNameToNumber(o[3]):a]=s[l]||{},s[l].txt=o[1];else if(t===this.wad1File&&n)s[l=void 0!==n[3]?this.numericNameToNumber(n[3]):a]=s[l]||{},s[l].txt=n[1].replace(/_/g," ").trim();else{if(!h||3!==h.length)throw"Line in nerps message file did not match anything";var l;s[l=this.numericNameToNumber(h[1])]=s[l]||{},s[l].snd=h[2].replace(/\\/g,"/")}}}return s},t.prototype.numericNameToNumber=function(t){if(void 0===t)throw"Numeric name must not be undefined";var e={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9},s={twenty:20,thirty:30,forty:40},i={ten:10,eleven:11,twelve:12,thirteen:13,fourteen:14,fifteen:15,sixteen:16,seventeen:17,eighteen:18,nineteen:19}[t]||e[t];if(void 0===i&&Object.keys(s).forEach((function(a){if(t.startsWith(a)){var r=t.replace(a,"");i=s[a]+(r?e[r]:0)}})),void 0===i)throw"Found unexpected numeric name "+t;return i},t.prototype.loadNerpMsg=function(t,e){for(var s=this.parseNerpMsgFile(this.wad0File,t),i=this.parseNerpMsgFile(this.wad1File,t),a=0;a<i.length;a++){var r=i[a];r&&(r.txt&&(s[a].txt=r.txt),r.snd&&(s[a].snd=r.snd))}e(s)},t.prototype.loadMapAsset=function(t,e){var s=this.wad0File.getEntryData(t);if(s.length<13||"MAP"!==String.fromCharCode.apply(String,s.slice(0,3)))console.log("Invalid map data provided");else{for(var i={width:s[8],height:s[12],level:[]},a=[],r=16;r<s.length;r+=2)a.push(s[r]),a.length>=i.width&&(i.level.push(a),a=[]);e(i)}},t.prototype.loadObjectListAsset=function(t,e){for(var s=this.wad0File.getEntryText(t).split("\n"),i=[],a=null,r=0;r<s.length;r++){var o=s[r].trim(),n=o.match(/(.+)\s+{/),h=o.match(/driving\s+(.+)/);if(o.length<1||o.startsWith(";")||o.startsWith("Lego*"));else if(n)a={},i[n[1]]=a;else if("}"===o)a=null;else if(h)a.driving=h[1];else{var l=o.split(/\s+/);if(2!==l.length||null===a)throw"Unexpected key value entry: "+o;var d=l[0],f=l[1];if("xPos"===d||"yPos"===d||"heading"===d)f=parseFloat(f);else if("type"!==d)throw"Unexpected key value entry: "+o;a[d]=f}}e(i)},t.prototype.loadWavAsset=function(t,e,s){console.error("wav asset loading not yet implemented")},t.prototype.loadLWOFile=function(t,e){var s;try{s=this.wad0File.getEntryBuffer(t)}catch(e){try{s=this.wad0File.getEntryBuffer("world/shared/"+a(t))}catch(e){return void console.error("Could not load LWO file "+t+"; Error: "+e)}}e(s.buffer)},t.prototype.registerAllAssets=function(t){var e=this;this.addAssetFolder(this.loadFontImageAsset,"Interface/Fonts/"),this.addAssetFolder(this.loadAlphaImageAsset,"Interface/Pointers/");var s=new c(r(t,"Menu","MainMenuFull"));this.onAssetLoaded(0,"MainMenuFull",s),s.menus.forEach((function(t){e.addAsset(e.loadWadImageAsset,t.menuImage),e.addAsset(e.loadFontImageAsset,t.menuFont),e.addAsset(e.loadFontImageAsset,t.loFont),e.addAsset(e.loadFontImageAsset,t.hiFont)})),this.addAlphaImageFolder("Interface/TopPanel/"),this.addAlphaImageFolder("Interface/RightPanel/"),this.addAlphaImageFolder("Interface/RadarPanel/"),this.addAlphaImageFolder("Interface/MessagePanel/"),this.addAsset(this.loadWadImageAsset,"Interface/Airmeter/msgpanel_air_juice.bmp"),this.addAlphaImageFolder("Interface/InfoPanel/"),this.addAlphaImageFolder("Interface/PriorityPanel/"),this.addAlphaImageFolder("Interface/Priorities"),this.addAlphaImageFolder("Interface/CameraControl/"),this.addAlphaImageFolder("Interface/MessageTabs/"),this.addAlphaImageFolder("Interface/IconPanel/"),this.addAlphaImageFolder("Interface/Icons/"),this.addAlphaImageFolder("Interface/Menus/"),this.addAssetFolder(this.loadWadImageAsset,"Interface/FrontEnd/lp_"),this.addAsset(this.loadAlphaImageAsset,"Interface/FrontEnd/LowerPanel.bmp"),this.addAsset(this.loadNerpAsset,"Levels/nerpnrn.h");var i=new u(r(t,"Levels"));this.onAssetLoaded(0,"Levels",i),Object.values(i.levelsByName).forEach((function(t){t.menuBMP.forEach((function(t){e.addAsset(e.loadAlphaImageAsset,t)})),e.addAsset(e.loadMapAsset,t.surfaceMap),e.addAsset(e.loadMapAsset,t.predugMap),e.addAsset(e.loadMapAsset,t.terrainMap),e.addAsset(e.loadMapAsset,t.blockPointersMap,!0),e.addAsset(e.loadMapAsset,t.cryOreMap),e.addAsset(e.loadMapAsset,t.pathMap,!0),t.fallinMap&&e.addAsset(e.loadMapAsset,t.fallinMap),t.erodeMap&&e.addAsset(e.loadMapAsset,t.erodeMap),e.addAsset(e.loadObjectListAsset,t.oListFile),e.addAsset(e.loadNerpAsset,t.nerpFile),e.addAsset(e.loadNerpMsg,t.nerpMessageFile)})),this.addTextureFolder("World/Shared/");var a=t.BuildingTypes;Object.values(a).forEach((function(t){var s=t.split("/")[1],i=t+"/"+s+".ae";e.addAnimatedEntity(i)})),this.addAnimatedEntity("mini-figures/pilot/pilot.ae"),this.addAnimatedEntity(r(t,"MiscObjects","Dynamite")+"/Dynamite.ae"),this.addAsset(this.loadLWOFile,"World/Shared/Crystal.lwo"),this.addAsset(this.loadLWOFile,r(t,"MiscObjects","Crystal")+".lwo"),this.addTextureFolder("MiscAnims/Crystal/");var o=r(t,"MiscObjects","Ore");this.addAsset(this.loadLWOFile,o+".lwo"),this.addAsset(this.loadWadTexture,"MiscAnims/Ore/Ore.bmp"),this.addAsset(this.loadLWOFile,"World/Shared/Brick.lwo"),this.addAsset(this.loadLWOFile,r(t,"MiscObjects","ProcessedOre")+".lwo"),this.addAnimatedEntity(r(t,"MiscObjects","Barrier")+"/Barrier.ae"),this.addAnimatedEntity("MiscAnims/Dynamite/Dynamite.ae"),this.addLWSFile("MiscAnims/RockFall/Rock3Sides.lws"),this.addTextureFolder("MiscAnims/RockFall/"),this.addTextureFolder("World/WorldTextures/IceSplit/Ice"),this.addTextureFolder("World/WorldTextures/LavaSplit/Lava"),this.addTextureFolder("World/WorldTextures/RockSplit/Rock");var n=new g(r(t,"Reward"));this.onAssetLoaded(0,"Reward",n),this.addAsset(this.loadWadImageAsset,n.wallpaper),this.addAsset(this.loadFontImageAsset,n.backFont),Object.values(n.fonts).forEach((function(t){return e.addAsset(e.loadFontImageAsset,t)})),n.images.forEach((function(t){return e.addAsset(e.loadAlphaImageAsset,t.filePath)})),n.boxImages.forEach((function(t){return e.addAsset(e.loadWadImageAsset,t.filePath)})),n.saveButton.splice(0,4).forEach((function(t){return e.addAsset(e.loadWadImageAsset,t)})),n.advanceButton.splice(0,4).forEach((function(t){return e.addAsset(e.loadWadImageAsset,t)}))},t.prototype.addAnimatedEntity=function(t){var e=this,s=this.wad0File.getEntryText(t),a=r((new n).parse(s),"Lego*");this.onAssetLoaded(0,t,a);var o=i(t);["HighPoly","MediumPoly","LowPoly"].forEach((function(t){var s=r(a,t);s&&Object.keys(s).forEach((function(t){e.addAsset(e.loadLWOFile,o+s[t]+".lwo")}))}));var h=r(a,"Activities");h&&Object.keys(h).forEach((function(t){try{var s=r(h,t),i=r(a,s),n=r(i,"FILE");!0===r(i,"LWSFILE")?e.addLWSFile(o+n+".lws"):console.error("Found activity which is not an LWS file")}catch(e){console.error(e),console.log(a),console.log(h),console.log(t)}})),this.addTextureFolder(i(t))},t.prototype.addLWSFile=function(t){var e=this,s=this.wad0File.getEntryText(t);this.onAssetLoaded(0,t,s),this.extractLwoFiles(i(t),s).forEach((function(t){return e.addAsset(e.loadLWOFile,t)}))},t.prototype.extractLwoFiles=function(t,e){var s=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((function(t){return t.trim()}));if("LWSC"!==s[0])throw"Invalid start of file! Expected 'LWSC' in first line";return s.filter((function(t){return t.toLowerCase().startsWith("LoadObject ".toLowerCase())})).map((function(e){return t+a(e.substring("LoadObject ".length)).toLowerCase()}))},t.prototype.addAlphaImageFolder=function(t){this.addAssetFolder(this.loadAlphaImageAsset,t)},t.prototype.addTextureFolder=function(t){this.addAssetFolder(this.loadWadTexture,t)},t.prototype.addAssetFolder=function(t,e){var s=this;this.wad0File.filterEntryNames(e+".+\\.bmp").forEach((function(e){s.addAsset(t,e)}))},t.prototype.addAsset=function(t,e,s){void 0===s&&(s=!1),e&&!this.assetsFromCfgByName.hasOwnProperty(e.toLowerCase())&&"NULL"!==e&&(this.assetsFromCfgByName[e]={method:t.bind(this),assetPath:e,optional:s})},t.prototype.loadAssetsParallel=function(){var t=this,e=[],s=this;this.assetsFromCfg.forEach((function(i){e.push(new Promise((function(e){try{i.method(i.assetPath,(function(a){t.assetIndex++,s.onAssetLoaded(t.assetIndex,i.assetPath,a),e()}),i.assetKey)}catch(a){if(!i.optional)throw a;t.assetIndex++,s.onAssetLoaded(t.assetIndex,i.assetPath,null),e()}})))})),Promise.all(e).then((function(){var e=(((new Date).getTime()-t.startTime.getTime())/1e3).toFixed(3).toString();t.onLoadDone(t.totalResources,e)}))},t.prototype.startWithCachedFiles=function(t){var e=this;this.startTime=new Date;var i=function(){e.onMessage("WAD files not found in cache"),t()};this.onMessage("Loading WAD files from cache...");var a=this;this.openLocalCache((function(t){var e=t.get("wad0");e.onerror=i,e.onsuccess=function(){if(void 0!==e.result){for(var r in a.wad0File=new s,e.result)e.result.hasOwnProperty(r)&&(a.wad0File[r]=e.result[r]);var o=t.get("wad1");o.onerror=i,o.onsuccess=function(){if(void 0!==o.result){for(var t in a.wad1File=new s,o.result)o.result.hasOwnProperty(t)&&(a.wad1File[t]=o.result[t]);console.log("WAD files loaded from cache after "+((new Date).getTime()-a.startTime.getTime())/1e3),a.startLoadingProcess()}else i()}}else i()}}))},t.prototype.loadWadFiles=function(t,e){var s=this,i=this;Promise.all([this.loadWadFile(t),this.loadWadFile(e)]).then((function(t){i.wad0File=t[0],i.wad1File=t[1],s.openLocalCache((function(t){t.put(i.wad0File,"wad0"),t.put(i.wad1File,"wad1")})),s.startLoadingProcess()}))},t.prototype.loadWadFile=function(t){return new Promise((function(e){console.log("Loading WAD file from "+t),fetch(t,{mode:"no-cors"}).then((function(t){t.ok&&t.arrayBuffer().then((function(t){var i=new s;i.parseWadFile(t),e(i)}))}))}))},t.prototype.openLocalCache=function(t){var e=indexedDB.open("RockRaidersWeb");e.onupgradeneeded=function(){var t=e.result;t.objectStoreNames.contains("wadfiles")&&t.deleteObjectStore("wadfiles"),t.createObjectStore("wadfiles")},e.onsuccess=function(){var s=e.result.transaction(["wadfiles"],"readwrite").objectStore("wadfiles");t(s)}},t.prototype.startLoadingProcess=function(){var t=this;this.startTime=new Date,this.assetsFromCfgByName={},this.onMessage("Loading configuration...");var s=e.parse(this.wad1File.getEntryData("Lego.cfg"));this.registerAllAssets(s),this.onMessage("Loading initial assets..."),Promise.all([new Promise((function(e){var i=r(s,"Main","LoadScreen");t.loadWadImageAsset(i,(function(s){t.onAssetLoaded(0,i,s),e()}))})),new Promise((function(e){var i=r(s,"Main","ProgressBar");t.loadWadImageAsset(i,(function(s){t.onAssetLoaded(0,i,s),e()}))})),new Promise((function(e){var i=r(s,"Pointers","Pointer_Standard");t.loadAlphaImageAsset(i,(function(s){t.onAssetLoaded(0,i,s),e()}))}))]).then((function(){t.onMessage("Start loading assets..."),t.assetsFromCfg=Object.values(t.assetsFromCfgByName),t.totalResources=t.assetsFromCfg.length,t.onInitialLoad(t.totalResources,s),t.assetIndex=0,t.loadAssetsParallel()}))},t}(),b=self;b.addEventListener("message",(function(t){var e=new w;e.onMessage=function(t){b.postMessage({msg:t})},e.onInitialLoad=function(t,e){b.postMessage({totalResources:t,cfg:e})},e.onAssetLoaded=function(t,e,s){b.postMessage({assetIndex:t,assetName:e,assetObj:s})},e.onLoadDone=function(t,e){b.postMessage({done:!0,totalResources:t,loadingTimeSeconds:e})};var s=t.data;s?e.loadWadFiles(s.wad0FileUrl,s.wad1FileUrl):e.startWithCachedFiles((function(){b.postMessage({cacheMissed:!0})}))}))})();
//# sourceMappingURL=index.worker.js.map