(()=>{"use strict";function t(t){return 130===t?"ä".charCodeAt(0):142===t?"Ä".charCodeAt(0):162===t?"ö".charCodeAt(0):167===t?"Ü".charCodeAt(0):171===t?"ü".charCodeAt(0):195===t?"ß".charCodeAt(0):t}var e=function(){function e(){}return e.parse=function(s){for(var a={},r=[],i=a,o=!1,n=0,l="",h="",d=0;d<s.length;d++){var u=s[d];123===u&&"FullName"===l&&(u=142);var c=String.fromCharCode(t(u));if(";"===c||"/"===c?o=!0:10!==u&&13!==u||(o=!1),!o)if(u>32)0===n?"}"===c?i=r.pop():(n++,l=c):1===n?l+=c:2===n?"{"===c?(r.push(i),i={},r[r.length-1][l]=i,n=0):(n++,h=c):3===n&&(h+=c);else if(1===n)n++;else if(3===n){n=0;var f=e.parseValue(h);i.hasOwnProperty(l)?i[l].push(f):i[l]=[f]}}for(var p=[a],g=function(){var t=p.pop();Object.keys(t).forEach((function(e){var s=t[e];Array.isArray(s)?1===s.length?t[e]=s[0]:s.forEach((function(t){return p.push(t)})):Object.keys(s).length>1&&p.push(s)}))};p.length>0;)g();return Object.values(a["Lego*"].Levels).forEach((function(t){t.CryoreMap&&(t.CryOreMap=t.CryoreMap,delete t.CryoreMap),t.CryOreMap&&(t.CryOreMap=t.CryOreMap.replace("Cryo_","Cror_")),t.PredugMap&&(t.PreDugMap=t.PredugMap,delete t.PredugMap)})),a["Lego*"]},e.parseValue=function(t){var s=Number(t);function a(s){0===(t=t.split(s).filter((function(t){return""!==t})).map((function(t){return e.parseValue(t)}))).length?t="":1===t.length&&(t=t[0])}if(isNaN(s)){var r=(t=t.toString().replace(/\\/g,"/")).toLowerCase();return"true"===r||"false"!==r&&("null"===r?"":(t.includes(",")?a.call(this,","):t.includes(":")?a.call(this,":"):t.includes("|")&&a.call(this,"|"),t))}return s},e}(),s=function(){function e(){this.buffer=null,this.entries=[],this.fLength=[],this.fStart=[]}return e.prototype.parseWadFile=function(t,e){void 0===e&&(e=!1);var s=new DataView(t);this.buffer=new Int8Array(t);var a=0;if("WWAD"!==String.fromCharCode.apply(null,this.buffer.slice(a,4)))throw"Invalid WAD0 file provided";e&&console.log("WAD0 file seems legit"),a=4;var r=s.getInt32(a,!0);e&&console.log(r);for(var i=a=8,o=0;o<r;a++)0===this.buffer[a]&&(this.entries[o]=String.fromCharCode.apply(null,this.buffer.slice(i,a)).replace(/\\/g,"/").toLowerCase(),i=a+1,o++);for(e&&console.log(this.entries),o=0;o<r;a++)0===this.buffer[a]&&(i=a+1,o++);for(e&&console.log("Offset after absolute original names is "+a),o=0;o<r;o++)this.fLength[o]=s.getInt32(a+8,!0),this.fStart[o]=s.getInt32(a+12,!0),a+=16;e&&(console.log(this.fLength),console.log(this.fStart))},e.prototype.getEntryData=function(t){return new Uint8Array(this.getEntryBuffer(t))},e.prototype.getEntryText=function(e){return(new TextDecoder).decode(this.getEntryBuffer(e).map((function(e){return t(e)})))},e.prototype.getEntryBuffer=function(t){for(var e=t.toLowerCase(),s=0;s<this.entries.length;s++)if(this.entries[s]===e)return this.buffer.slice(this.fStart[s],this.fStart[s]+this.fLength[s]);throw"Entry '"+t+"' not found in WAD file"},e.prototype.filterEntryNames=function(t){for(var e=new RegExp(t.toLowerCase()),s=[],a=0;a<this.entries.length;a++){var r=this.entries[a];r.toLowerCase().match(e)&&s.push(r)}return s},e}();function a(t){if(!t)return t;var e=t.toString().replace(/\\/g,"/");e.startsWith("/")&&(e=e.substring(1));var s=e.lastIndexOf("/");return(e=e.substring(0,s+1)).startsWith("/")&&(e=e.substring(1)),e}function r(t){if(!t)return t;var e=t.toString().replace(/\\/g,"/");e.startsWith("/")&&(e=e.substring(1));var s=e.lastIndexOf("/");return e.substring(s+1)}function i(t){for(var e=[],s=1;s<arguments.length;s++)e[s-1]=arguments[s];return e.forEach((function(e){t=(t=Object.keys(t).filter((function(t){return t.toLowerCase()===e.toLowerCase()})).map((function(e){return t[e]})))?t[0]:t})),t}var o,n=function(){function t(){}return t.prototype.parse=function(t){var e=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((function(t){var e=t.indexOf("//");e>-1&&(t=t.substring(0,e));var s=t.indexOf(";");return s>-1&&(t=t.substring(0,s)),t})).map((function(t){return t.trim()})).filter((function(t){return""!==t})).map((function(t){return t.split(" ").filter((function(t){return""!==t}))})),s={};return this.parseObj(s,e,0),s},t.prototype.parseObj=function(t,e,s){for(var a=this,r=s;r<e.length;r++){var i=e[r],o=i[0],n=i[1],l=o.toLowerCase();if("{"===n)t[l]={},r=this.parseObj(t[l],e,r+1);else{if("}"===l)return r;for(var h=n.split(":").filter((function(t){return""!==t})).map((function(t){return t.split(",").map((function(t){return t.split("|").map((function(t){return a.parseValue(t)}))}))}));1===h.length;)h=h[0];t[l]=h}}return e.length},t.prototype.parseValue=function(t){var e=Number(t),s=t.toLowerCase();return isNaN(e)?"false"!==s&&("true"===s||t):e},t}();!function(t){t[t.BITMAP_INFO_HEADER=40]="BITMAP_INFO_HEADER",t[t.BITMAP_V2_INFO_HEADER=52]="BITMAP_V2_INFO_HEADER",t[t.BITMAP_V3_INFO_HEADER=56]="BITMAP_V3_INFO_HEADER",t[t.BITMAP_V4_HEADER=108]="BITMAP_V4_HEADER",t[t.BITMAP_V5_HEADER=124]="BITMAP_V5_HEADER"}(o||(o={}));var l,h=function(){function t(t,e){var s=(void 0===e?{toRGBA:!1}:e).toRGBA;if(this.buffer=t,this.bufferView=new DataView(t.buffer,t.byteOffset,t.byteLength),this.toRGBA=!!s,this.bottomUp=!0,this.flag=String.fromCharCode(this.buffer[0])+String.fromCharCode(this.buffer[1]),this.pos=2,"BM"!==this.flag)throw new Error("Invalid BMP File");this.locRed=this.toRGBA?0:3,this.locGreen=this.toRGBA?1:2,this.locBlue=this.toRGBA?2:1,this.locAlpha=this.toRGBA?3:0,this.parseHeader(),this.parseRGBA()}return t.prototype.parseHeader=function(){if(this.fileSize=this.readUInt32LE(),this.reserved1=this.bufferView.getUint16(this.pos,!0),this.pos+=2,this.reserved2=this.bufferView.getUint16(this.pos,!0),this.pos+=2,this.offset=this.readUInt32LE(),this.headerSize=this.readUInt32LE(),!(this.headerSize in o))throw new Error("Unsupported BMP header size "+this.headerSize);if(this.width=this.readUInt32LE(),this.height=this.readUInt32LE(),this.planes=this.bufferView.getUint16(this.pos,!0),this.pos+=2,this.bitPP=this.bufferView.getUint16(this.pos,!0),this.pos+=2,this.compression=this.readUInt32LE(),this.rawSize=this.readUInt32LE(),this.hr=this.readUInt32LE(),this.vr=this.readUInt32LE(),this.colors=this.readUInt32LE(),this.importantColors=this.readUInt32LE(),32===this.bitPP?(this.maskAlpha=0,this.maskRed=16711680,this.maskGreen=65280,this.maskBlue=255):16===this.bitPP&&(this.maskAlpha=0,this.maskRed=31744,this.maskGreen=992,this.maskBlue=31),(this.headerSize>o.BITMAP_INFO_HEADER||3===this.compression||6===this.compression)&&(this.maskRed=this.readUInt32LE(),this.maskGreen=this.readUInt32LE(),this.maskBlue=this.readUInt32LE()),(this.headerSize>o.BITMAP_V2_INFO_HEADER||6===this.compression)&&(this.maskAlpha=this.readUInt32LE()),this.headerSize>o.BITMAP_V3_INFO_HEADER&&(this.pos+=o.BITMAP_V4_HEADER-o.BITMAP_V3_INFO_HEADER),this.headerSize>o.BITMAP_V4_HEADER&&(this.pos+=o.BITMAP_V5_HEADER-o.BITMAP_V4_HEADER),this.bitPP<=8||this.colors>0){var t=0===this.colors?1<<this.bitPP:this.colors;this.palette=new Array(t);for(var e=0;e<t;e++){var s=this.buffer[this.pos++],a=this.buffer[this.pos++],r=this.buffer[this.pos++],i=this.buffer[this.pos++];this.palette[e]={red:r,green:a,blue:s,quad:i}}}this.height<0&&(this.height*=-1,this.bottomUp=!1);var n,l,h,d,u,c,f,p,g,m,A,y,v=(n=this.maskRed,l=this.maskGreen,h=this.maskBlue,d=this.maskAlpha,g=n/(u=1+~n&n)+1,m=l/(c=1+~l&l)+1,A=h/(f=1+~h&h)+1,y=d/(p=1+~d&d)+1,{shiftRed:function(t){return(t&n)/u*256/g},shiftGreen:function(t){return(t&l)/c*256/m},shiftBlue:function(t){return(t&h)/f*256/A},shiftAlpha:0!==d?function(t){return(t&d)/p*256/y}:function(){return 255}});this.shiftRed=v.shiftRed,this.shiftGreen=v.shiftGreen,this.shiftBlue=v.shiftBlue,this.shiftAlpha=v.shiftAlpha},t.prototype.parseRGBA=function(){switch(this.data=new Uint8Array(this.width*this.height*4),this.bitPP){case 1:this.bit1();break;case 4:this.bit4();break;case 8:this.bit8();break;case 16:this.bit16();break;case 24:this.bit24();break;default:this.bit32()}},t.prototype.bit1=function(){var t,e=this,s=Math.ceil(this.width/8),a=s%4,r=0!==a?4-a:0;this.scanImage(r,s,(function(s,a){a!==t&&(t=a);for(var r=e.buffer[e.pos++],i=a*e.width*4+8*s*4,o=0;o<8&&8*s+o<e.width;o++){var n=e.palette[r>>7-o&1];e.data[i+o*e.locAlpha]=0,e.data[i+4*o+e.locBlue]=n.blue,e.data[i+4*o+e.locGreen]=n.green,e.data[i+4*o+e.locRed]=n.red}}))},t.prototype.bit4=function(){var t=this;if(2===this.compression){this.data.fill(0);for(var e=!1,s=this.bottomUp?this.height-1:0,a=0;a<this.data.length;){var r=this.buffer[this.pos++],i=this.buffer[this.pos++];if(0===r){if(0===i){a=(s+=this.bottomUp?-1:1)*this.width*4,e=!1;continue}if(1===i)break;if(2===i){var o=this.buffer[this.pos++],n=this.buffer[this.pos++];s+=this.bottomUp?-n:n,a+=n*this.width*4+4*o}else{for(var l=this.buffer[this.pos++],h=0;h<i;h++)a=this.setPixelData(a,e?15&l:(240&l)>>4),1&h&&h+1<i&&(l=this.buffer[this.pos++]),e=!e;1==(i+1>>1&1)&&this.pos++}}else for(h=0;h<r;h++)a=this.setPixelData(a,e?15&i:(240&i)>>4),e=!e}}else{var d=Math.ceil(this.width/2),u=d%4,c=0!==u?4-u:0;this.scanImage(c,d,(function(e,s){var a=t.buffer[t.pos++],r=s*t.width*4+2*e*4,i=a>>4,o=t.palette[i];if(t.data[r]=0,t.data[r+1]=o.blue,t.data[r+2]=o.green,t.data[r+3]=o.red,2*e+1>=t.width)return!1;var n=15&a;o=t.palette[n],t.data[r+4]=0,t.data[r+4+1]=o.blue,t.data[r+4+2]=o.green,t.data[r+4+3]=o.red}))}},t.prototype.bit8=function(){var t=this;if(1===this.compression){this.data.fill(0);for(var e=this.bottomUp?this.height-1:0,s=0;s<this.data.length;){var a=this.buffer[this.pos++],r=this.buffer[this.pos++];if(0===a){if(0===r){s=(e+=this.bottomUp?-1:1)*this.width*4;continue}if(1===r)break;if(2===r){var i=this.buffer[this.pos++],o=this.buffer[this.pos++];e+=this.bottomUp?-o:o,s+=o*this.width*4+4*i}else{for(var n=0;n<r;n++){var l=this.buffer[this.pos++];s=this.setPixelData(s,l)}!0&r&&this.pos++}}else for(n=0;n<a;n++)s=this.setPixelData(s,r)}}else{var h=this.width%4,d=0!==h?4-h:0;this.scanImage(d,this.width,(function(e,s){var a=t.buffer[t.pos++],r=s*t.width*4+4*e;if(a<t.palette.length){var i=t.palette[a];t.data[r]=0,t.data[r+1]=i.blue,t.data[r+2]=i.green,t.data[r+3]=i.red}else t.data[r]=0,t.data[r+1]=255,t.data[r+2]=255,t.data[r+3]=255}))}},t.prototype.bit16=function(){var t=this,e=this.width%2*2;this.scanImage(e,this.width,(function(e,s){var a=s*t.width*4+4*e,r=t.bufferView.getUint16(t.pos,!0);t.pos+=2,t.data[a+t.locRed]=t.shiftRed(r),t.data[a+t.locGreen]=t.shiftGreen(r),t.data[a+t.locBlue]=t.shiftBlue(r),t.data[a+t.locAlpha]=t.shiftAlpha(r)}))},t.prototype.bit24=function(){var t=this,e=this.width%4;this.scanImage(e,this.width,(function(e,s){var a=s*t.width*4+4*e,r=t.buffer[t.pos++],i=t.buffer[t.pos++],o=t.buffer[t.pos++];t.data[a+t.locRed]=o,t.data[a+t.locGreen]=i,t.data[a+t.locBlue]=r,t.data[a+t.locAlpha]=0}))},t.prototype.bit32=function(){var t=this;this.scanImage(0,this.width,(function(e,s){var a=s*t.width*4+4*e,r=t.readUInt32LE();t.data[a+t.locRed]=t.shiftRed(r),t.data[a+t.locGreen]=t.shiftGreen(r),t.data[a+t.locBlue]=t.shiftBlue(r),t.data[a+t.locAlpha]=t.shiftAlpha(r)}))},t.prototype.scanImage=function(t,e,s){void 0===t&&(t=0),void 0===e&&(e=this.width);for(var a=this.height-1;a>=0;a--){for(var r=this.bottomUp?a:this.height-1-a,i=0;i<e;i++)s.call(this,i,r);this.pos+=t}},t.prototype.readUInt32LE=function(){var t=this.bufferView.getUint32(this.pos,!0);return this.pos+=4,t},t.prototype.setPixelData=function(t,e){var s=this.palette[e],a=s.blue,r=s.green,i=s.red;return this.data[t+this.locAlpha]=0,this.data[t+1+this.locBlue]=a,this.data[t+2+this.locGreen]=r,this.data[t+3+this.locRed]=i,t+4},t}(),d=function(){function t(){}return t.parse=function(t){for(var e=new h(t),s=new Uint8ClampedArray(e.data.length),a=0;a<e.data.length;a+=4)s[a]=e.data[a+3],s[a+1]=e.data[a+2],s[a+2]=e.data[a+1],s[a+3]=255-e.data[a];return new ImageData(s,e.width,e.height)},t}(),u=function(t){this.actionName=t[0],this.x=Number(t[1]),this.y=Number(t[2]),5===t.length?this.label=t[3].replace(/_/g," "):8===t.length?(this.imgNormal=t[3],this.imgHover=t[4],this.imgPressed=t[5],this.tooltip=t[6]):console.warn("Unexpected cfg object length: "+t.length),this.target=t[t.length-1]},c=function(){function t(){}return t.setFromCfg=function(t,e){return Object.keys(e).forEach((function(s){var a=(s.startsWith("!")?s.substring(1):s).toLowerCase();Object.keys(t).some((function(r){return t.assignValue(r,a,e[s])}))||console.warn("cfg key does not exist: "+s)})),t},t.prototype.assignValue=function(t,e,s){if(t.toLowerCase()===e)return this[t]=this.parseValue(e,s),!0},t.prototype.parseValue=function(t,e){return e},t.prototype.parseLabel=function(t){return t.replace(/_/g," ")},t}(),f=(l=function(t,e){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function s(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)}),p=function(t){function e(e){var s=t.call(this)||this;return s.fullName="",s.title="",s.position=[0,0],s.menuFont="",s.loFont="",s.hiFont="",s.itemCount=0,s.menuImage="",s.autoCenter=!1,s.displayTitle=!1,s.overlays=[],s.playRandom=!1,s.items=[],s.anchored=!1,s.canScroll=!1,c.setFromCfg(s,e),s}return f(e,t),e.prototype.assignValue=function(e,s,a){return s.match(/item\d+/i)?(this.items.push(new u(a)),!0):s.match(/overlay\d+/i)?(this.overlays.push(a),!0):t.prototype.assignValue.call(this,e,s,a)},e}(c),g=function(){var t=function(e,s){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])})(e,s)};return function(e,s){if("function"!=typeof s&&null!==s)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");function a(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(a.prototype=s.prototype,new a)}}(),m=function(t){function e(e){var s=t.call(this)||this;return s.menuCount=0,s.menus=[],c.setFromCfg(s,e),s}return g(e,t),e.prototype.assignValue=function(e,s,a){return s.match(/menu\d+/i)?(this.menus.push(new p(a)),!0):t.prototype.assignValue.call(this,e,s,a)},e}(c),A=function(t){this.r=t[0],this.g=t[1],this.b=t[2]},y=function(){var t=function(e,s){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])})(e,s)};return function(e,s){if("function"!=typeof s&&null!==s)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");function a(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(a.prototype=s.prototype,new a)}}(),v=function(t){var e=this;this.levelsByName=[],Object.keys(t).forEach((function(s){(s.startsWith("Tutorial")||s.startsWith("Level"))&&(e.levelsByName[s]=new w(t[s]))}))},w=function(t){function e(e){var s=t.call(this)||this;return s.fullName="",s.endGameAvi1="",s.endGameAvi2="",s.allowRename=!1,s.recallOLObjects=!1,s.generateSpiders=!1,s.video="",s.disableEndTeleport="",s.disableStartTeleport="",s.emergeTimeOut="",s.boulderAnimation="",s.noMultiSelect="",s.noAutoEat="",s.disableToolTipSound="",s.blockSize="",s.digDepth="",s.roughLevel="",s.roofHeight="",s.useRoof="",s.selBoxHeight="",s.fpRotLightRGB="",s.fogColourRGB="",s.highFogColourRGB="",s.fogRate=0,s.fallinMultiplier=0,s.numberOfLandSlidesTillCaveIn=0,s.noFallins=!1,s.oxygenRate=0,s.surfaceMap="",s.predugMap="",s.terrainMap="",s.emergeMap="",s.erodeMap="",s.fallinMap="",s.blockPointersMap="",s.cryOreMap="",s.pathMap="",s.noGather=!1,s.textureSet="",s.rockFallStyle="",s.emergeCreature="",s.safeCaverns="",s.seeThroughWalls="",s.oListFile="",s.ptlFile="",s.nerpFile="",s.nerpMessageFile="",s.objectiveText="",s.objectiveImage640x480="",s.erodeTriggerTime=0,s.erodeErodeTime=0,s.erodeLockTime=0,s.nextLevel="",s.levelLinks="",s.frontEndX=0,s.frontEndY=0,s.frontEndOpen=!1,s.priorities=null,s.reward=null,s.menuBMP=[],c.setFromCfg(s,e),s}return y(e,t),e.prototype.assignValue=function(e,s,a){return t.prototype.assignValue.call(this,e,s,a)},e.prototype.parseValue=function(e,s){return e==="fullName".toLowerCase()?this.parseLabel(s):e.endsWith("rgb")?new A(s):"priorities"===e?new b(s):"reward"===e?new I(s):t.prototype.parseValue.call(this,e,s)},e}(c),b=function(t){function e(e){var s=t.call(this)||this;return s.AI_Priority_Crystal=!0,s.AI_Priority_Destruction=!0,s.AI_Priority_Clearing=!0,s.AI_Priority_Ore=!0,s.AI_Priority_Repair=!0,s.AI_Priority_GetIn=!0,s.AI_Priority_Construction=!0,s.AI_Priority_Reinforce=!0,s.AI_Priority_GetTool=!0,s.AI_Priority_Train=!0,s.AI_Priority_Recharge=!0,c.setFromCfg(s,e),s}return y(e,t),e}(c),I=function(t){function e(e){var s=t.call(this)||this;return s.enable=!0,s.modifier=null,s.importance=null,s.quota=null,c.setFromCfg(s,e),s}return y(e,t),e.prototype.parseValue=function(e,s){return"importance"===e?new F(s):"quota"===e?new E(s):t.prototype.parseValue.call(this,e,s)},e}(c),F=function(t){function e(e){var s=t.call(this)||this;return s.crystals=0,s.timer=0,s.caverns=0,s.constructions=0,s.oxygen=0,s.figures=0,c.setFromCfg(s,e),s}return y(e,t),e}(c),E=function(t){function e(e){var s=t.call(this)||this;return s.crystals=null,s.timer=null,s.caverns=null,s.constructions=null,c.setFromCfg(s,e),s}return y(e,t),e}(c),L=function(){var t=function(e,s){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])})(e,s)};return function(e,s){if("function"!=typeof s&&null!==s)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");function a(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(a.prototype=s.prototype,new a)}}(),P=function(t){function e(e){var s=t.call(this)||this;return s.display=!0,s.wallpaper="",s.images=[],s.texts=[],s.boxImages=[],s.fonts=null,s.flics=null,s.scrollSpeed=0,s.centreText=!1,s.vertSpacing=0,s.backFont="",s.font="",s.titleFont="",s.timer=0,s.saveButton="",s.advanceButton="",s.completeText="",s.failedText="",s.quitText="",s.textPos=[0,0],c.setFromCfg(s,e),s}return L(e,t),e.prototype.assignValue=function(e,s,a){var r=this;return"images"===s?(Object.values(a).forEach((function(t){return r.images.push(new M(t))})),!0):"text"===s?(Object.values(a).forEach((function(t){return r.texts.push(new _(t))})),!0):"boximages"===s?(Object.values(a).forEach((function(t){return r.boxImages.push(new M(t))})),!0):"fonts"===s?(this.fonts=new O(a),!0):t.prototype.assignValue.call(this,e,s,a)},e}(c),M=function(t){this.filePath="",this.x=0,this.y=0,this.filePath=t[0],this.x=t[1],this.y=t[2]},_=function(t){this.text="",this.x=0,this.y=0,this.text=t[0],this.x=t[1],this.y=t[2]},O=function(t){function e(e){var s=t.call(this)||this;return s.crystals="",s.ore="",s.diggable="",s.constructions="",s.caverns="",s.figures="",s.rockMonsters="",s.oxygen="",s.timer="",s.score="",c.setFromCfg(s,e),s}return L(e,t),e}(c),C=function(){function t(){this.wad0File=null,this.wad1File=null,this.assetIndex=0,this.totalResources=0,this.onMessage=function(t){console.log(t)},this.onInitialLoad=function(){console.log("Initial loading done.")},this.onAssetLoaded=function(){},this.onLoadDone=function(t,e){console.log("Loading of about "+t+" assets complete! Total load time: "+e+" seconds.")}}return t.prototype.loadWadImageAsset=function(t,e){var s=this.wad0File.getEntryData(t);e(d.parse(s))},t.prototype.loadWadTexture=function(t,e){var s=this.wad0File.getEntryData(t),a=d.parse(s);if(function(t){var e=r(t);return!!(e.match(/\d\d\d\..+$/i)||e.match(/^trans/i)||e.match(/telepulse/i)||e.match(/^t_/i)||e.includes("crystalglow")||e.match(/^glin/i)||e.match(/glow.bmp/i)||e.match(/spankle/i))}(t))for(var i=0;i<a.data.length;i+=4)255===a.data[i]&&255===a.data[i+1]&&255===a.data[i+2]?a.data[i+3]=0:a.data[i+3]=Math.max(a.data[i],a.data[i+1],a.data[i+2]);else if(function(t){return!!r(t).match(/^a.+/i)}(t)){var o={r:a.data[a.data.length-4],g:a.data[a.data.length-3],b:a.data[a.data.length-2]};for(i=0;i<a.data.length;i+=4)a.data[i]===o.r&&a.data[i+1]===o.g&&a.data[i+2]===o.b&&(a.data[i+3]=0)}e(a)},t.prototype.loadAlphaImageAsset=function(t,e){for(var s=this.wad0File.getEntryData(t),a=d.parse(s),r=0;r<a.data.length;r+=4)a.data[r]<=2&&a.data[r+1]<=2&&a.data[r+2]<=2&&(a.data[r+3]=0);e(a)},t.prototype.loadFontImageAsset=function(t,e){var s=this.wad0File.getEntryData(t);e(d.parse(s))},t.prototype.loadNerpAsset=function(t,e){t=t.replace(/.npl$/,".nrn"),e(this.wad0File.getEntryText(t))},t.prototype.parseNerpMsgFile=function(t,e){for(var s=[],a=t.getEntryText(e).split("\n"),r=0;r<a.length;r++){var i=a[r].trim();if(!(i.length<1||"-"===i)){var o=i.match(/\\\[([^\\]+)\\](\s*#([^#]+)#)?/),n=i.match(/^([^$][^#]+)(\s*#([^#]+)#)?/),l=i.match(/\$([^\s]+)\s*([^\s]+)/);if(t===this.wad0File&&o)s[h=void 0!==o[3]?this.numericNameToNumber(o[3]):r]=s[h]||{},s[h].txt=o[1];else if(t===this.wad1File&&n)s[h=void 0!==n[3]?this.numericNameToNumber(n[3]):r]=s[h]||{},s[h].txt=n[1].replace(/_/g," ").trim();else{if(!l||3!==l.length)throw"Line in nerps message file did not match anything";var h;s[h=this.numericNameToNumber(l[1])]=s[h]||{},s[h].snd=l[2].replace(/\\/g,"/")}}}return s},t.prototype.numericNameToNumber=function(t){if(void 0===t)throw"Numeric name must not be undefined";var e={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9},s={twenty:20,thirty:30,forty:40},a={ten:10,eleven:11,twelve:12,thirteen:13,fourteen:14,fifteen:15,sixteen:16,seventeen:17,eighteen:18,nineteen:19}[t]||e[t];if(void 0===a&&Object.keys(s).forEach((function(r){if(t.startsWith(r)){var i=t.replace(r,"");a=s[r]+(i?e[i]:0)}})),void 0===a)throw"Found unexpected numeric name "+t;return a},t.prototype.loadNerpMsg=function(t,e){for(var s=this.parseNerpMsgFile(this.wad0File,t),a=this.parseNerpMsgFile(this.wad1File,t),r=0;r<a.length;r++){var i=a[r];i&&(i.txt&&(s[r].txt=i.txt),i.snd&&(s[r].snd=i.snd))}e(s)},t.prototype.loadMapAsset=function(t,e){var s=this.wad0File.getEntryData(t);if(s.length<13||"MAP"!==String.fromCharCode.apply(String,s.slice(0,3)))console.log("Invalid map data provided");else{for(var a={width:s[8],height:s[12],level:[]},r=[],i=16;i<s.length;i+=2)r.push(s[i]),r.length>=a.width&&(a.level.push(r),r=[]);e(a)}},t.prototype.loadObjectListAsset=function(t,e){for(var s=this.wad0File.getEntryText(t).split("\n"),a=[],r=null,i=0;i<s.length;i++){var o=s[i].trim(),n=o.match(/(.+)\s+{/),l=o.match(/driving\s+(.+)/);if(o.length<1||o.startsWith(";")||o.startsWith("Lego*"));else if(n)r={},a[n[1]]=r;else if("}"===o)r=null;else if(l)r.driving=l[1];else{var h=o.split(/\s+/);if(2!==h.length||null===r)throw"Unexpected key value entry: "+o;var d=h[0],u=h[1];if("xPos"===d||"yPos"===d||"heading"===d)u=parseFloat(u);else if("type"!==d)throw"Unexpected key value entry: "+o;r[d]=u}}e(a)},t.prototype.loadWavAsset=function(t,e,s){console.error("wav asset loading not yet implemented")},t.prototype.loadLWOFile=function(t,e){var s;try{s=this.wad0File.getEntryBuffer(t)}catch(e){try{s=this.wad0File.getEntryBuffer("world/shared/"+r(t))}catch(e){return void console.error("Could not load LWO file "+t+"; Error: "+e)}}e(s.buffer)},t.prototype.registerAllAssets=function(t){var e=this;this.addAssetFolder(this.loadFontImageAsset,"Interface/Fonts/"),this.addAssetFolder(this.loadAlphaImageAsset,"Interface/Pointers/");var s=new m(i(t,"Menu","MainMenuFull"));this.onAssetLoaded(0,"MainMenuFull",s),s.menus.forEach((function(t){e.addAsset(e.loadWadImageAsset,t.menuImage),e.addAsset(e.loadFontImageAsset,t.menuFont),e.addAsset(e.loadFontImageAsset,t.loFont),e.addAsset(e.loadFontImageAsset,t.hiFont)})),this.addAlphaImageFolder("Interface/TopPanel/"),this.addAlphaImageFolder("Interface/RightPanel/"),this.addAlphaImageFolder("Interface/RadarPanel/"),this.addAlphaImageFolder("Interface/MessagePanel/"),this.addAsset(this.loadWadImageAsset,"Interface/Airmeter/msgpanel_air_juice.bmp"),this.addAlphaImageFolder("Interface/InfoPanel/"),this.addAlphaImageFolder("Interface/PriorityPanel/"),this.addAlphaImageFolder("Interface/Priorities"),this.addAlphaImageFolder("Interface/CameraControl/"),this.addAlphaImageFolder("Interface/MessageTabs/"),this.addAlphaImageFolder("Interface/IconPanel/"),this.addAlphaImageFolder("Interface/Icons/"),this.addAlphaImageFolder("Interface/Menus/"),this.addAssetFolder(this.loadWadImageAsset,"Interface/FrontEnd/lp_"),this.addAsset(this.loadAlphaImageAsset,"Interface/FrontEnd/LowerPanel.bmp"),this.addAsset(this.loadNerpAsset,"Levels/nerpnrn.h");var a=new v(i(t,"Levels"));this.onAssetLoaded(0,"Levels",a),Object.values(a.levelsByName).forEach((function(t){t.menuBMP.forEach((function(t){e.addAsset(e.loadAlphaImageAsset,t)})),e.addAsset(e.loadMapAsset,t.surfaceMap),e.addAsset(e.loadMapAsset,t.predugMap),e.addAsset(e.loadMapAsset,t.terrainMap),e.addAsset(e.loadMapAsset,t.blockPointersMap,!0),e.addAsset(e.loadMapAsset,t.cryOreMap),e.addAsset(e.loadMapAsset,t.pathMap,!0),t.fallinMap&&e.addAsset(e.loadMapAsset,t.fallinMap),t.erodeMap&&e.addAsset(e.loadMapAsset,t.erodeMap),e.addAsset(e.loadObjectListAsset,t.oListFile),e.addAsset(e.loadNerpAsset,t.nerpFile),e.addAsset(e.loadNerpMsg,t.nerpMessageFile)})),this.addTextureFolder("World/Shared/");var r=t.BuildingTypes;Object.values(r).forEach((function(t){var s=t.split("/")[1],a=t+"/"+s+".ae";e.addAnimatedEntity(a)})),this.addAnimatedEntity("mini-figures/pilot/pilot.ae"),this.addAnimatedEntity(i(t,"MiscObjects","Dynamite")+"/Dynamite.ae"),this.addAsset(this.loadLWOFile,"World/Shared/Crystal.lwo"),this.addAsset(this.loadLWOFile,i(t,"MiscObjects","Crystal")+".lwo"),this.addTextureFolder("MiscAnims/Crystal/");var o=i(t,"MiscObjects","Ore");this.addAsset(this.loadLWOFile,o+".lwo"),this.addAsset(this.loadWadTexture,"MiscAnims/Ore/Ore.bmp"),this.addAsset(this.loadLWOFile,"World/Shared/Brick.lwo"),this.addAsset(this.loadLWOFile,i(t,"MiscObjects","ProcessedOre")+".lwo"),this.addAnimatedEntity(i(t,"MiscObjects","Barrier")+"/Barrier.ae"),this.addAnimatedEntity("MiscAnims/Dynamite/Dynamite.ae"),this.addLWSFile("MiscAnims/RockFall/Rock3Sides.lws"),this.addTextureFolder("MiscAnims/RockFall/"),this.addTextureFolder("World/WorldTextures/IceSplit/Ice"),this.addTextureFolder("World/WorldTextures/LavaSplit/Lava"),this.addTextureFolder("World/WorldTextures/RockSplit/Rock");var n=new P(i(t,"Reward"));this.onAssetLoaded(0,"Reward",n),this.addAsset(this.loadWadImageAsset,n.wallpaper),this.addAsset(this.loadFontImageAsset,n.backFont),Object.values(n.fonts).forEach((function(t){return e.addAsset(e.loadFontImageAsset,t)})),n.images.forEach((function(t){return e.addAsset(e.loadAlphaImageAsset,t.filePath)})),n.boxImages.forEach((function(t){return e.addAsset(e.loadWadImageAsset,t.filePath)})),n.saveButton.splice(0,4).forEach((function(t){return e.addAsset(e.loadWadImageAsset,t)})),n.advanceButton.splice(0,4).forEach((function(t){return e.addAsset(e.loadWadImageAsset,t)}))},t.prototype.addAnimatedEntity=function(t){var e=this,s=this.wad0File.getEntryText(t),r=i((new n).parse(s),"Lego*");this.onAssetLoaded(0,t,r);var o=a(t);["HighPoly","MediumPoly","LowPoly"].forEach((function(t){var s=i(r,t);s&&Object.keys(s).forEach((function(t){e.addAsset(e.loadLWOFile,o+s[t]+".lwo")}))}));var l=i(r,"Activities");l&&Object.keys(l).forEach((function(t){try{var s=i(l,t),a=i(r,s),n=i(a,"FILE");!0===i(a,"LWSFILE")?e.addLWSFile(o+n+".lws"):console.error("Found activity which is not an LWS file")}catch(e){console.error(e),console.log(r),console.log(l),console.log(t)}})),this.addTextureFolder(a(t))},t.prototype.addLWSFile=function(t){var e=this,s=this.wad0File.getEntryText(t);this.onAssetLoaded(0,t,s),this.extractLwoFiles(a(t),s).forEach((function(t){return e.addAsset(e.loadLWOFile,t)}))},t.prototype.extractLwoFiles=function(t,e){var s=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\t/g," ").split("\n").map((function(t){return t.trim()}));if("LWSC"!==s[0])throw"Invalid start of file! Expected 'LWSC' in first line";return s.filter((function(t){return t.toLowerCase().startsWith("LoadObject ".toLowerCase())})).map((function(e){return t+r(e.substring("LoadObject ".length)).toLowerCase()}))},t.prototype.addAlphaImageFolder=function(t){this.addAssetFolder(this.loadAlphaImageAsset,t)},t.prototype.addTextureFolder=function(t){this.addAssetFolder(this.loadWadTexture,t)},t.prototype.addAssetFolder=function(t,e){var s=this;this.wad0File.filterEntryNames(e+".+\\.bmp").forEach((function(e){s.addAsset(t,e)}))},t.prototype.addAsset=function(t,e,s){void 0===s&&(s=!1),e&&!this.assetsFromCfgByName.hasOwnProperty(e.toLowerCase())&&"NULL"!==e&&(this.assetsFromCfgByName[e]={method:t.bind(this),assetPath:e,optional:s})},t.prototype.loadAssetsParallel=function(){var t=this,e=[],s=this;this.assetsFromCfg.forEach((function(a){e.push(new Promise((function(e){try{a.method(a.assetPath,(function(r){t.assetIndex++,s.onAssetLoaded(t.assetIndex,a.assetPath,r),e()}),a.assetKey)}catch(r){if(!a.optional)throw r;t.assetIndex++,s.onAssetLoaded(t.assetIndex,a.assetPath,null),e()}})))})),Promise.all(e).then((function(){var e=(((new Date).getTime()-t.startTime.getTime())/1e3).toFixed(3).toString();t.onLoadDone(t.totalResources,e)}))},t.prototype.startWithCachedFiles=function(t){var e=this;this.startTime=new Date;var a=function(){e.onMessage("WAD files not found in cache"),t()};this.onMessage("Loading WAD files from cache...");var r=this;this.openLocalCache((function(t){var e=t.get("wad0");e.onerror=a,e.onsuccess=function(){if(void 0!==e.result){for(var i in r.wad0File=new s,e.result)e.result.hasOwnProperty(i)&&(r.wad0File[i]=e.result[i]);var o=t.get("wad1");o.onerror=a,o.onsuccess=function(){if(void 0!==o.result){for(var t in r.wad1File=new s,o.result)o.result.hasOwnProperty(t)&&(r.wad1File[t]=o.result[t]);console.log("WAD files loaded from cache after "+((new Date).getTime()-r.startTime.getTime())/1e3),r.startLoadingProcess()}else a()}}else a()}}))},t.prototype.loadWadFiles=function(t,e){var s=this,a=this;Promise.all([this.loadWadFile(t),this.loadWadFile(e)]).then((function(t){a.wad0File=t[0],a.wad1File=t[1],s.openLocalCache((function(t){t.put(a.wad0File,"wad0"),t.put(a.wad1File,"wad1")})),s.startLoadingProcess()}))},t.prototype.loadWadFile=function(t){return new Promise((function(e){console.log("Loading WAD file from "+t),fetch(t).then((function(t){t.ok&&t.arrayBuffer().then((function(t){var a=new s;a.parseWadFile(t),e(a)}))}))}))},t.prototype.openLocalCache=function(t){var e=indexedDB.open("RockRaidersWeb");e.onupgradeneeded=function(){var t=e.result;t.objectStoreNames.contains("wadfiles")&&t.deleteObjectStore("wadfiles"),t.createObjectStore("wadfiles")},e.onsuccess=function(){var s=e.result.transaction(["wadfiles"],"readwrite").objectStore("wadfiles");t(s)}},t.prototype.startLoadingProcess=function(){var t=this;this.startTime=new Date,this.assetsFromCfgByName={},this.onMessage("Loading configuration...");var s=e.parse(this.wad1File.getEntryData("Lego.cfg"));this.registerAllAssets(s),this.onMessage("Loading initial assets..."),Promise.all([new Promise((function(e){var a=i(s,"Main","LoadScreen");t.loadWadImageAsset(a,(function(s){t.onAssetLoaded(0,a,s),e()}))})),new Promise((function(e){var a=i(s,"Main","ProgressBar");t.loadWadImageAsset(a,(function(s){t.onAssetLoaded(0,a,s),e()}))})),new Promise((function(e){var a=i(s,"Pointers","Pointer_Standard");t.loadAlphaImageAsset(a,(function(s){t.onAssetLoaded(0,a,s),e()}))}))]).then((function(){t.onMessage("Start loading assets..."),t.assetsFromCfg=Object.values(t.assetsFromCfgByName),t.totalResources=t.assetsFromCfg.length,t.onInitialLoad(t.totalResources,s),t.assetIndex=0,t.loadAssetsParallel()}))},t}(),x=self;x.addEventListener("message",(function(t){var e=new C;e.onMessage=function(t){x.postMessage({msg:t})},e.onInitialLoad=function(t,e){x.postMessage({totalResources:t,cfg:e})},e.onAssetLoaded=function(t,e,s){x.postMessage({assetIndex:t,assetName:e,assetObj:s})},e.onLoadDone=function(t,e){x.postMessage({done:!0,totalResources:t,loadingTimeSeconds:e})};var s=t.data;s?e.loadWadFiles(s.wad0FileUrl,s.wad1FileUrl):e.startWithCachedFiles((function(){x.postMessage({cacheMissed:!0})}))}))})();
//# sourceMappingURL=index.worker.js.map